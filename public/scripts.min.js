"use strict";function compileStyleForBlock(block){var elements=[],el="";if(block.blockStyle)for(var i=0;i<lengthStyleBlock;i++){var n;block.blockStyle[i]&&(n=getNamePropertyCSS(i,block.blockStyle[i]))&&(el+="\n"+n[0]+":"+n[1]+";")}if(el&&(el&&(el="{"+el+"}\n"),elements.push(el)),block.elements&&"object"==typeof block.elements)for(var key in block.elements){el="";for(var i=0;i<lengthStyleBlock;i++)if("a"!=key||1!=i){var n;block.elements[key][i]&&(n=getNamePropertyCSS(i,block.elements[key][i]))&&(el+="\n"+n[0]+":"+n[1]+";")}el&&(el=key.replace("@",".")+"{"+el+"}\n"),"a"==key&&block.elements.a[1]&&(el+="a:hover {color:"+block.elements.a[1]+"}"),el&&elements.push(el)}return elements}function validateEmail(email){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)}function md5www(str){var k,AA,BB,CC,DD,a,b,c,d,RotateLeft=function(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits},AddUnsigned=function(lX,lY){var lX4,lY4,lX8,lY8,lResult;return lX8=2147483648&lX,lY8=2147483648&lY,lX4=1073741824&lX,lY4=1073741824&lY,lResult=(1073741823&lX)+(1073741823&lY),lX4&lY4?2147483648^lResult^lX8^lY8:lX4|lY4?1073741824&lResult?3221225472^lResult^lX8^lY8:1073741824^lResult^lX8^lY8:lResult^lX8^lY8},F=function(x,y,z){return x&y|~x&z},G=function(x,y,z){return x&z|y&~z},H=function(x,y,z){return x^y^z},I=function(x,y,z){return y^(x|~z)},FF=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},GG=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},HH=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},II=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},WordToHex=function(lValue){var lByte,lCount,WordToHexValue="",WordToHexValue_temp="";for(lCount=0;lCount<=3;lCount++)lByte=lValue>>>8*lCount&255,WordToHexValue_temp="0"+lByte.toString(16),WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);return WordToHexValue},x=Array();for(str=unescape(encodeURIComponent(str)),x=function(str){for(var lWordCount,lMessageLength=str.length,lNumberOfWords_temp1=lMessageLength+8,lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64,lNumberOfWords=16*(lNumberOfWords_temp2+1),lWordArray=Array(lNumberOfWords-1),lBytePosition=0,lByteCount=0;lByteCount<lMessageLength;)lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|str.charCodeAt(lByteCount)<<lBytePosition,lByteCount++;return lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition,lWordArray[lNumberOfWords-2]=lMessageLength<<3,lWordArray[lNumberOfWords-1]=lMessageLength>>>29,lWordArray}(str),a=1732584193,b=4023233417,c=2562383102,d=271733878,k=0;k<x.length;k+=16)AA=a,BB=b,CC=c,DD=d,a=FF(a,b,c,d,x[k+0],7,3614090360),d=FF(d,a,b,c,x[k+1],12,3905402710),c=FF(c,d,a,b,x[k+2],17,606105819),b=FF(b,c,d,a,x[k+3],22,3250441966),a=FF(a,b,c,d,x[k+4],7,4118548399),d=FF(d,a,b,c,x[k+5],12,1200080426),c=FF(c,d,a,b,x[k+6],17,2821735955),b=FF(b,c,d,a,x[k+7],22,4249261313),a=FF(a,b,c,d,x[k+8],7,1770035416),d=FF(d,a,b,c,x[k+9],12,2336552879),c=FF(c,d,a,b,x[k+10],17,4294925233),b=FF(b,c,d,a,x[k+11],22,2304563134),a=FF(a,b,c,d,x[k+12],7,1804603682),d=FF(d,a,b,c,x[k+13],12,4254626195),c=FF(c,d,a,b,x[k+14],17,2792965006),b=FF(b,c,d,a,x[k+15],22,1236535329),a=GG(a,b,c,d,x[k+1],5,4129170786),d=GG(d,a,b,c,x[k+6],9,3225465664),c=GG(c,d,a,b,x[k+11],14,643717713),b=GG(b,c,d,a,x[k+0],20,3921069994),a=GG(a,b,c,d,x[k+5],5,3593408605),d=GG(d,a,b,c,x[k+10],9,38016083),c=GG(c,d,a,b,x[k+15],14,3634488961),b=GG(b,c,d,a,x[k+4],20,3889429448),a=GG(a,b,c,d,x[k+9],5,568446438),d=GG(d,a,b,c,x[k+14],9,3275163606),c=GG(c,d,a,b,x[k+3],14,4107603335),b=GG(b,c,d,a,x[k+8],20,1163531501),a=GG(a,b,c,d,x[k+13],5,2850285829),d=GG(d,a,b,c,x[k+2],9,4243563512),c=GG(c,d,a,b,x[k+7],14,1735328473),b=GG(b,c,d,a,x[k+12],20,2368359562),a=HH(a,b,c,d,x[k+5],4,4294588738),d=HH(d,a,b,c,x[k+8],11,2272392833),c=HH(c,d,a,b,x[k+11],16,1839030562),b=HH(b,c,d,a,x[k+14],23,4259657740),a=HH(a,b,c,d,x[k+1],4,2763975236),d=HH(d,a,b,c,x[k+4],11,1272893353),c=HH(c,d,a,b,x[k+7],16,4139469664),b=HH(b,c,d,a,x[k+10],23,3200236656),a=HH(a,b,c,d,x[k+13],4,681279174),d=HH(d,a,b,c,x[k+0],11,3936430074),c=HH(c,d,a,b,x[k+3],16,3572445317),b=HH(b,c,d,a,x[k+6],23,76029189),a=HH(a,b,c,d,x[k+9],4,3654602809),d=HH(d,a,b,c,x[k+12],11,3873151461),c=HH(c,d,a,b,x[k+15],16,530742520),b=HH(b,c,d,a,x[k+2],23,3299628645),a=II(a,b,c,d,x[k+0],6,4096336452),d=II(d,a,b,c,x[k+7],10,1126891415),c=II(c,d,a,b,x[k+14],15,2878612391),b=II(b,c,d,a,x[k+5],21,4237533241),a=II(a,b,c,d,x[k+12],6,1700485571),d=II(d,a,b,c,x[k+3],10,2399980690),c=II(c,d,a,b,x[k+10],15,4293915773),b=II(b,c,d,a,x[k+1],21,2240044497),a=II(a,b,c,d,x[k+8],6,1873313359),d=II(d,a,b,c,x[k+15],10,4264355552),c=II(c,d,a,b,x[k+6],15,2734768916),b=II(b,c,d,a,x[k+13],21,1309151649),a=II(a,b,c,d,x[k+4],6,4149444226),d=II(d,a,b,c,x[k+11],10,3174756917),c=II(c,d,a,b,x[k+2],15,718787259),b=II(b,c,d,a,x[k+9],21,3951481745),a=AddUnsigned(a,AA),b=AddUnsigned(b,BB),c=AddUnsigned(c,CC),d=AddUnsigned(d,DD);return(WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d)).toLowerCase()}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function getMobileOperatingSystem(){var userAgent=navigator.userAgent||navigator.vendor||window.opera;if(!userAgent.match(/iPhone/i))return userAgent.match(/iPad/i)?"iOS":userAgent.match(/Android/i)?"Android":"unknown";iPhone=!0}function setMetaOG(){templateContentHTML=$("#tempContent").html();var o={};o.keywords=$("meta[name='keywords']").attr("content"),o.description=$("meta[name='description']").attr("content"),o.title=$("meta[property='og\\:title']").attr("content"),o.canonical=$("meta[property='og\\:url']").attr("content"),o.image=$("meta[property='og\\:image']").attr("content"),tempTitles=o,$("meta[name='keywords']").attr("content","{{global.get('titles').val.keywords}}"),$("meta[name='description']").attr("content","{{global.get('titles').val.description}}"),$("meta[property='og\\:title']").attr("content","{{global.get('titles').val.title}}"),$("meta[property='og\\:url']").attr("content","{{global.get('titles').val.url}}"),$("meta[property='og\\:description']").attr("content","{{global.get('titles').val.description}}"),$("meta[property='og\\:image']").attr("content","{{global.get('titles').val.image}}"),$("link[rel='canonical']").attr("href","{{global.get('titles').val.canonical}}")}function getCookie(name){var matches=document.cookie.match(new RegExp("(?:^|; )"+name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return matches?decodeURIComponent(matches[1]):void 0}function setCookie(name,value,options){options=options||{};var expires=options.expires;if("number"==typeof expires&&expires){var d=new Date;d.setTime(d.getTime()+1e3*expires),expires=options.expires=d}expires&&expires.toUTCString&&(options.expires=expires.toUTCString()),value=encodeURIComponent(value);var updatedCookie=name+"="+value;for(var propName in options){updatedCookie+="; "+propName;var propValue=options[propName];propValue!==!0&&(updatedCookie+="="+propValue)}document.cookie=updatedCookie}function exception(toaster){function catcher(header){return function(err){err?"object"==typeof err&&(err.data&&(err=err.data),err.message?err=err.message:err.error&&(err=err.error)):err="ошибка",toaster.pop("error",header,err)}}function showToaster(type,title,content){"object"==typeof content&&(content.message?content=content.message:content.error&&(content=content.error)),toaster.pop({type:type,title:title,body:content,bodyOutputType:"trustedHtml",showCloseButton:!0,delay:15e3,closeHtml:"<button>Close</button>"})}return{catcher:catcher,showToaster:showToaster}}function confirmFactory($q,$uibModal){function service(question,html){return $q(function(resolve,reject){var options={animation:!0,template:['<div class="modal-header">','<h3 class="modal-title text-center" ng-bind="$ctrl.question"></h3>','<span class="cancel-confirm" ng-click="$ctrl.cancel()"><span class="icon-cancel-img" ></span></span>',"</div>",'<div class="modal-body confirm">','<div class="modal-html" ng-bind-html="$ctrl.html|unsafe"></div>','<form ng-submit="$ctrl.ok()"><button autofocus class="btn btn-project btn-border  btn-modal pull-right" type="reset" ng-click="$ctrl.cancel()">{{global.get("langOrder").val.noo}}</button>','<button class="btn btn-project btn-modal pull-left" type="submit">{{global.get("langOrder").val.yes}}</button>','</form><div class="clearfix"></div>',"</div>"].join(""),controller:function($uibModalInstance,$rootScope,question,html){var self=this;self.question=question,html&&(self.html=html),self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()},$rootScope.$on("$stateChangeStart",function(){$uibModalInstance.dismiss()})},controllerAs:"$ctrl",size:"sm",resolve:{question:function(){return question},html:function(){return html}}};html&&(options.size="md"),$uibModal.open(options).result.then(function(){resolve()},function(){reject()})})}return service}function photoFactory($http){return{deleteFolder:function(model,folder){return $http.post("/api/collections/Photo/deleteFolder",{folder:folder})},deleteFolders:function(model,folders){return $http.post("/api/collections/Photo/deleteFolders",{folders:folders})},deleteFiles:function(model,files){return $http.post("/api/collections/Photo/deleteFiles",{files:files})}}}function enterPhoneNumderCtrl($scope,global){function changePhone(){self.phone?self.enterPhoneNumder=self.phoneCode.substring(1)+self.phone.substring(0,10):self.enterPhoneNumder="",self.changeFoo&&"function"==typeof self.changeFoo&&self.changeFoo({phone:self.enterPhoneNumder})}function changeCode(){}var self=this;self.global=global,self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",$scope.$watch(function(){return self.enterPhoneNumder},function(enterPhoneNumder,old){if(enterPhoneNumder){var phoneCode="+"+enterPhoneNumder.substring(0,enterPhoneNumder.length-10);self.phoneCodes.getOFA("code",phoneCode)&&(self.phoneCode=phoneCode),self.phone=enterPhoneNumder.substring(enterPhoneNumder.length-10)}}),self.changePhone=changePhone,self.changeCode=changeCode}function sectionServiceFunction($resource,$q,global,$uibModal,$timeout){function init(){Items.query(function(res){res.shift(),sections=res,setCategoriesFromSections(sections),pending=!1})}function reloadItems(){pending=!0,init()}function save(){return Items.save.apply(this,arguments).$promise.then(function(){})}function _getParentSection(sections,sectionUrl,id){if(!sections)return null;for(var i=0,l=sections.length;i<l;i++){if(id){if(sections[i]._id==sectionUrl)return sections[i]}else if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length){var categories;if(categories=_getParentSection(sections[i].child,sectionUrl,id))return categories}}return null}function _getEmbededCategories(section,arr){return section.categories&&section.categories.length&&arr.push.apply(arr,section.categories),section.child&&section.child.length&&section.child.forEach(function(section){getEmbededCategories(section,arr)}),arr}function returnSections(resolve){pending?setTimeout(function(){returnSections(resolve)},100):resolve(sections)}function getSections(){return $q(function(resolve,reject){global.get("sections")&&global.get("sections").val?(sections||(sections=global.get("sections").val),resolve(global.get("sections").val)):pending?setTimeout(function(){returnSections(resolve)},100):sections?resolve(sections):(pending=!0,Items.query(function(res){res.shift(),sections=res,pending=!1,setCategoriesFromSections(sections),resolve(sections)},function(err){pending=!1,reject(err)}))})}function setSections(newSections){sections=newSections,setCategoriesFromSections(sections?sections:[])}function getSection(sections,sectionUrl){sections||(sections=getSections());for(var i=0,l=sections.length;i<l;i++){if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length)for(var j=0,ll=sections[i].child.length;j<ll;j++)if(sections[i].child[j].url&&sections[i].child[j].url==sectionUrl)return sections[i].child[j]}return null}function getParentSection(sectionUrl,id){return _getParentSection(sections,sectionUrl,id)}function getEmbededCategories(section,arr){return _getEmbededCategories(section,arr)}function setCategoriesFromSections(sections){var categories=[],categoriesO={};sections.forEach(function(section){section.categories&&section.categories.length&&(section.categories.forEach(function(c){c.section={url:section.url},c.linkData={groupUrl:section.url,categoryUrl:c.url},categoriesO[c._id]=c}),categories.push.apply(categories,section.categories)),section.child&&section.child.length&&section.child.forEach(function(subSection){subSection.categories&&subSection.categories.length&&(subSection.categories.forEach(function(c){c.section={url:section.url},c.linkData={groupUrl:section.url,categoryUrl:c.url,parentGroup:subSection.url},categoriesO[c._id]=c}),categories.push.apply(categories,subSection.categories))})}),global.set("categories",categories),global.set("categoriesO",categoriesO)}function select(){var that=this;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectSubsectionModal.html",controller:selectSubsectionCtrl,size:"lg",resolve:{sections:function(){return that.getSections()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectSubsectionCtrl($q,$uibModalInstance,sections){var self=this;self.sections=sections,console.log(sections),self.ok=function(section){$uibModalInstance.close(section)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Group/:id",{id:"@_id"}),sections=null,pending=!0;return function(){$timeout(function(){global.get("sections")&&global.get("sections").val||init()})}(),{query:Items.query,get:Items.get,delete:Items.delete,save:save,savePure:Items.save,getSections:getSections,getSection:getSection,getParentSection:getParentSection,getEmbededCategories:getEmbededCategories,setCategoriesFromSections:setCategoriesFromSections,select:select,setSections:setSections,reloadItems:reloadItems}}function filterTagsService($resource,$uibModal,$q,global,$timeout,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function getFilterTags(){return $q(function(resolve,reject){return global.get("filterTags")&&global.get("filterTags").val?(filterTags||(filterTags=global.get("filterTags").val),resolve(global.get("filterTags").val)):pending?$timeout(function(){return resolve(filterTags)},400):void(filterTags?resolve(filterTags):(pending=!0,Items.query(function(res){res.shift(),filterTags=res?res:[],pending=!1,resolve(filterTags)},function(err){pending=!1,reject(err)})))})}function getTagsByUrl(queryTags,cb){$q.when().then(function(){return getFilterTags()}).then(function(){queryTags=queryTags.map(function(url){return filterTags.getOFA("url",url)}),cb(queryTags)})}function selectFilterTag(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/bindFilterTagToModel.html",controller:selectFilterTagCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectFilterTagCtrl(Filters,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),$uibModalInstance.close(filterTag)}}function init(){Items.query(qu,function(res){res.shift(),filterTags=res,filterTags.forEach(function(t){_filterTagsO[t._id]=t}),pending=!1})}function reloadItems(){pending=!0,init()}function getSticker(tags){if(tags&&tags.length&&filterTags&&filterTags.length)for(var i=0;i<tags.length;i++)if(__filterTagsO[tags[i]]&&__filterTagsO[tags[i]].sticker)return __filterTagsO[tags[i]].sticker}var qu,Items=$resource("/api/collections/FilterTags/:_id",{_id:"@_id"}),filterTags=null,pending=!0;return filterTags=__filterTags,$timeout(function(){qu={query:JSON.stringify({store:global.get("store").val._id})},global.get("filterTags")&&global.get("filterTags").val?filterTags=global.get("filterTags").val:init()},50),{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,getFilterTags:getFilterTags,getTagsByUrl:getTagsByUrl,selectFilterTag:selectFilterTag,select:selectFilterTag,reloadItems:reloadItems,getSticker:getSticker,reloadItems:reloadItems}}function HPtransform(HP,template){function setData(e){var o={type:e.name};return e.templ&&(o.templ=e.templ),e.style&&(o.style=e.style),"stuffs"==e.name?(HP.stuffs&&HP.stuffs.length&&(o.stuffs=HP.stuffs),e.namebox&&(o.name=e.namebox)):"brands"==e.name?(HP.brands&&HP.brands.length&&(o.brands=HP.brands),e.namebox&&(o.name=e.namebox)):"brandTags"==e.name?(HP.brandTags&&HP.brandTags.length&&(o.brandTags=HP.brandTags),e.namebox&&(o.name=e.namebox)):"filterTags"==e.name?(HP.filterTags&&HP.filterTags.length&&(o.filterTags=HP.filterTags),e.namebox&&(o.name=e.namebox)):"filters"==e.name?(HP.filters&&HP.filters.length&&(o.filters=HP.filters),e.namebox&&(o.name=e.namebox)):"categories"==e.name?(HP.categories&&HP.categories.length&&(o.categories=HP.categories),e.namebox&&(o.name=e.namebox)):"campaign"==e.name?(HP.campaign&&HP.campaign.length&&(o.campaign=HP.campaign),e.namebox&&(o.name=e.namebox)):"news"==e.name?(HP.news&&HP.news.length&&(o.news=HP.news),e.namebox&&(o.name=e.namebox)):"text"==e.name?(o.name=HP.textName,o.desc=HP.textDesc,HP.textButton&&(o.button={is:HP.textButton.button,link:HP.textButton.link,text:HP.textButton.text})):"mission"==e.name?(o.name=HP.name,o.desc=HP.desc,HP.descButton&&(o.button={is:HP.descButton.button,link:HP.descButton.link,text:HP.descButton.text})):"banner"==e.name?(o.img=HP.bannerSrc,HP.banner&&(o.desc=HP.banner.desc,o.button={is:HP.banner.button,link:HP.banner.link,text:HP.banner.text})):"video"==e.name?(o.video=HP.videoSrc,HP.video&&(o.audio=HP.video.audio,o.desc=HP.video.desc,o.button={is:HP.video.button,link:HP.video.link,text:HP.video.text})):"slider"==e.name?HP.imgs&&(o.imgs=HP.imgs):"info"==e.name&&(o.img=HP.infoImg,HP.info&&(o.name=HP.info.name,o.button={link:HP.info.link})),o}if(HP.url)var hp=HP;else{var hp={header:[],left:[],right:[]};template.left.forEach(function(e){hp.left.push(setData(e))}),template.right.forEach(function(e){hp.right.push(setData(e))})}return hp}function googlePlaceReviews(global){return{restrict:"C",scope:!0,link:function(scope,element){global.get("store").val.glPlaceId&&(console.log("global.get('store').val.glPlaceId",global.get("store").val.glPlaceId),$(element).googlePlaces({placeId:global.get("store").val.glPlaceId,render:["reviews"],min_rating:1,max_rows:4}))}}}function undefinedhpBlock(){return{templateUrl:"components/homePage/blocks/undefinedBlock.html"}}function styleBlock(){return{templateUrl:"components/homePage/blocks/styleBlock.html"}}function bannerHPBlock(){return{templateUrl:"components/homePage/blocks/bannerBlock.html"}}function banneroneHPBlock(){return{templateUrl:"components/homePage/blocks/banneroneBlock.html"}}function infohpBlock(){return{templateUrl:"components/homePage/blocks/infoBlock.html"}}function sliderhpBlock(){return{templateUrl:"components/homePage/blocks/sliderBlock.html"}}function texthpBlock(){return{templateUrl:"components/homePage/blocks/textBlock.html"}}function texttwohpBlock(){return{templateUrl:"components/homePage/blocks/texttwoBlock.html"}}function videohpBlock(){return{templateUrl:"components/homePage/blocks/videoBlock.html"}}function missionhpBlock(){return{templateUrl:"components/homePage/blocks/missionBlock.html"}}function brandshpBlock(){return{templateUrl:"components/homePage/blocks/brandsBlock.html"}}function stuffshpBlock(){return{templateUrl:"components/homePage/blocks/stuffsBlock.html"}}function newshpBlock(){return{templateUrl:"components/homePage/blocks/newsBlock.html"}}function campaignhpBlock(){return{templateUrl:"components/homePage/blocks/campaignBlock.html"}}function maphpBlock(){return{templateUrl:"components/homePage/blocks/mapBlock.html"}}function reviewhpBlock(){return{templateUrl:"components/homePage/blocks/reviewBlock.html"}}function subscriptionhpBlock(){return{templateUrl:"components/homePage/blocks/subscriptionBlock.html"}}function callhpBlock(){return{templateUrl:"components/homePage/blocks/callBlock.html"}}function feedbackhpBlock(){return{templateUrl:"components/homePage/blocks/feedbackBlock.html"}}function brandTagshpBlock(){return{templateUrl:"components/homePage/blocks/brandTagsBlock.html"}}function subscriptionAddhpBlock(){return{templateUrl:"components/homePage/blocks/subscriptionAddBlock.html"}}function filterTagshpBlock(){return{templateUrl:"components/homePage/blocks/filterTagsBlock.html"}}function filtershpBlock(){return{templateUrl:"components/homePage/blocks/filtersBlock.html"}}function categorieshpBlock(){return{templateUrl:"components/homePage/blocks/categoriesBlock.html"}}function calendarhpBlock(){return{templateUrl:"components/homePage/blocks/calendarBlock.html"}}function videolinkhpBlock(){return{templateUrl:"components/homePage/blocks/videolinkhpBlock.html"}}function pricegoodshpBlock(){return{templateUrl:"components/homePage/blocks/pricegoodsBlock.html"}}function priceserviceshpBlock(){return{templateUrl:"components/homePage/blocks/priceservicesBlock.html"}}function scheduleplacehpBlock(){return{templateUrl:"components/homePage/blocks/scheduleplaceBlock.html"}}angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. HH:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"HH:mm:ss",short:"dd.MM.yy HH:mm",shortDate:"dd.MM.yy",shortTime:"HH:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"грн.",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru-ua",localeID:"ru_UA",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]);for(var minTimePart=15,timeRemindArrLang=[{ru:"за 1 час",uk:"",en:"",de:"",part:4},{ru:"за 2 часа",uk:"",en:"",de:"",part:8},{ru:"за 3 часа",uk:"",en:"",de:"",part:12},{ru:"за 4 часа",uk:"",en:"",de:"",part:16},{ru:"за 5 часов",uk:"",en:"",de:"",part:20},{ru:"за 6 часов",uk:"",en:"",de:"",part:24},{ru:"за 12 часов",uk:"",en:"",de:"",part:48},{ru:"за 1 день",uk:"",en:"",de:"",part:96}],timeDurationArrLang=[{ru:"15 мин",uk:"",en:"",de:"",part:1},{ru:"30 мин",uk:"",en:"",de:"",part:2},{ru:"45 мин",uk:"",en:"",de:"",part:3},{ru:"1 час",uk:"",en:"",de:"",part:4},{ru:"1 час 15 мин",uk:"",en:"",de:"",part:5},{ru:"1 час 30 мин",uk:"",en:"",de:"",part:6},{ru:"1 час 45 мин",uk:"",en:"",de:"",part:7},{ru:"2 часа",uk:"",en:"",de:"",part:8},{ru:"2 часа 15 мин",uk:"",en:"",de:"",part:9},{ru:"2 часа 30 мин",uk:"",en:"",de:"",part:10},{ru:"3 часа",uk:"",en:"",de:"",part:12},{ru:"3 часа 30 мин",uk:"",en:"",de:"",part:14},{ru:"4 часа",uk:"",en:"",de:"",part:16}],weekDays=[{ru:"Воскресенье",uk:"Неділя",en:"Sunday",de:"gdsdfsdf"},{ru:"Понедельник",uk:"Понеділок",en:"Monday",de:"gdsdfsdf"},{ru:"Вторник",uk:"Вівторок",en:"Tuesday",de:"gdsdfsdf"},{ru:"Среда",uk:"Середа",en:"Wednesday",de:"gdsdfsdf"},{ru:"Четверг",uk:"Четвер",en:"Thursday",de:"gdsdfsdf"},{ru:"Пятница",uk:"П*ятниця",en:"Friday",de:"gdsdfsdf"},{ru:"Суббота",uk:"Субота",en:"Saturday",de:"gdsdfsdf"}],reservedFirstParamsForAdmin=["manage","promo","seo","setting","content","translate","admin123","bookkeep"],reservedFirstParams=["manage","promo","seo","setting","content","translate","news","lookbook","stat","master","campaign","info","additional","workplace","cabinet","pricegoods","priceservices","home","search","cart","cabinet","bookkeep","likes"],languagesOfPlatform=["ru","uk","en","de","es"],propertiesOfConfigData=[{key:"unitOfMeasure",name:"единицы измерения"}],phoneCodes=[{code:"+38",country:"Ukraine"},{code:"+7",country:"Russia"},{code:"+501",country:"Moldova"},{code:"+44",country:"United Kingdom"},{code:"+93",country:"Afghanistan"},{code:"+355",country:"Albania"},{code:"+213",country:"Algeria"},{code:"+1-684",country:"American Samoa"},{code:"+376",country:"Andorra"},{code:"+244",country:"Angola"},{code:"+1-264",country:"Anguilla"},{code:"+672",country:"Antarctica"},{code:"+1-268",country:"Antigua and Barbuda"},{code:"+54",country:"Argentina"},{code:"+374",country:"Armenia"},{code:"+297",country:"Aruba"},{code:"+61",country:"Australia"},{code:"+43",country:"Austria"},{code:"+994",country:"Azerbaijan"},{code:"+1-242",country:"Bahamas"},{code:"+973",country:"Bahrain"},{code:"+880",country:"Bangladesh"},{code:"+1-246",country:"Barbados"},{code:"+375",country:"Belarus"},{code:"+32",country:"Belgium"},{code:"+1-246",country:"Belize"},{code:"+229",country:"Benin"},{code:"+1-441",country:"Bermuda"},{code:"+975",country:"Bhutan"},{code:"+591",country:"Bolivia"},{code:"+246",country:"British Indian Ocean Territory"},{code:"+267",country:"Botswana"},{code:"+55",country:"Brazil"},{code:"+387",country:"Bosnia and Herzegovina"},{code:"+1-284",country:"British Virgin Islands"},{code:"+673",country:"Brunei"},{code:"+359",country:"Bulgaria"},{code:"+226",country:"Burkina Faso"},{code:"+257",country:"Burundi"},{code:"+855",country:"Cambodia"},{code:"+237",country:"Cameroon"},{code:"+1",country:"Canada"},{code:"+238",country:"Cape Verde"},{code:"+1-345",country:"Cayman Islands"},{code:"+236",country:"Central African Republic"},{code:"+235",country:"Chad"},{code:"+56",country:"Chile"},{code:"+86",country:"China"},{code:"+57",country:"Colombia"},{code:"+269",country:"Comoros"},{code:"+506",country:"Costa Rica"},{code:"+385",country:"Croatia"},{code:"+53",country:"Cuba"},{code:"+599",country:"Curacao"},{code:"+357",country:"Cyprus"},{code:"+420",country:"Czech Republic"},{code:"+45",country:"Denmark"},{code:"+1-767",country:"Dominica"},{code:"+593",country:"Ecuador"},{code:"+995",country:"Georgia"},{code:"+49",country:"Germany"},{code:"+30",country:"Greece"},{code:"+852",country:"Hong Kong"},{code:"+36",country:"Hungary"},{code:"+354",country:"Iceland"},{code:"+852",country:"Hong Kong"},{code:"+36",country:"Hungary"},{code:"+30",country:"Greece"},{code:"+91",country:"India"},{code:"+62",country:"Indonesia"},{code:"+98",country:"Iran"},{code:"+964",country:"Iraq"},{code:"+353",country:"Ireland"},{code:"+972",country:"Israel"},{code:"+39",country:"Italy"},{code:"+81",country:"Japan"},{code:"+962",country:"Jordan"},{code:"+7",country:"Kazakhstan"},{code:"+383",country:"Kosovo"},{code:"+965",country:"Kuwait"},{code:"+996",country:"Kyrgyzstan"},{code:"+856",country:"Laos"},{code:"+371",country:"Latvia"},{code:"+961",country:"Lebanon"},{code:"+218",country:"Libya"},{code:"+423",country:"Liechtenstein"},{code:"+370",country:"Lithuania"},{code:"+352",country:"Luxembourg"},{code:"+853",country:"Macau"},{code:"+389",country:"Macedonia"},{code:"+261",country:"Madagascar"},{code:"+60",country:"Malaysia"},{code:"+356",country:"Malta"},{code:"+222",country:"Mauritania"},{code:"+230",country:"Mauritius"},{code:"+52",country:"Mexico"},{code:"+373",country:"Moldova"},{code:"+377",country:"Monaco"},{code:"+976",country:"Mongolia"},{code:"+382",country:"Montenegro"},{code:"+212",country:"Morocco"},{code:"+977",country:"Nepal"},{code:"+31",country:"Netherlands"},{code:"+507",country:"Panama"},{code:"+595",country:"Paraguay"},{code:"+382",country:"Montenegro"},{code:"+377",country:"Monaco"},{code:"+51",country:"Peru"},{code:"+63",country:"Philippines"},{code:"+48",country:"Poland"},{code:"+351",country:"Portugal"},{code:"+974",country:"Qatar"},{code:"+40",country:"Romania"},{code:"+378",country:"San Marino"},{code:"+966",country:"Saudi Arabia"},{code:"+381",country:"Serbia"},{code:"+65",country:"Singapore"},{code:"+421",country:"Slovakia"},{code:"+386",country:"Slovenia"},{code:"+27",country:"South Africa"},{code:"+82",country:"South Korea"},{code:"+34",country:"Spain"},{code:"+94",country:"Sri Lanka"},{code:"+46",country:"Sweden"},{code:"+41",country:"Switzerland"},{code:"+886",country:"Taiwan"},{code:"+992",country:"Tajikistan"},{code:"+66",country:"Thailand"},{code:"+216",country:"Tunisia"},{code:"+90",country:"Turkey"},{code:"+993",country:"Turkmenistan"},{code:"+971",country:"United Arab Emirates"},{code:"+44",country:"United Kingdom"},{code:"+1",country:"United States"},{code:"+598",country:"Uruguay"},{code:"+998",country:"Uzbekistan"},{code:"+379",country:"Vatican"},{code:"+58",country:"Venezuela"},{code:"+84",country:"Vietnam"},{code:"+967",country:"Yemen"}],modelsName={stat:{ru:"страницы",uk:"сторінки",en:"pages",de:"pages"},stuff:{ru:"товары и услуги",uk:"товари та послуги",en:"goods and services",de:"goods and services"},news:{ru:"новости",uk:"новини",en:"news",de:"news"},info:{ru:"информация",uk:"інформація",en:"information",de:"information"},workplace:{
ru:"локации",uk:"локации",en:"locations",de:"locations"}},lengthStyleBlock=65,arrEmptyForProperties=[],i=0;i<lengthStyleBlock;i++)arrEmptyForProperties.push("");var listOfBlocksForMainPage={slider:"слайдер",video:"видео",videoLink:"внешнее видео",banner:"баннер",bannerOne:"баннер в два потока",mission:"миссия",text:"текстовый блок",textTwo:"текстовый блок 2 потока",campaign:"акции",filterTags:"тематические группы (признаки из хар-тик)",filters:"характеристики",brandTags:"коллекции",brands:"бренды",categories:"категории",stuffs:"товары",news:"новости",info:"информационный раздел",pricegoods:"прайс товаров",priceservices:"прайс услуг",map:"карта",review:"отзывы гугл",subscription:"подписка",subscriptionAdd:"подписка с доп полями",call:"заказ звонка",feedback:"форма обратной связи",calendar:"гугл календарь",scheduleplace:"расписание для рабочего места"},animationTypes=[{type:null,name:"отсутстует"},{type:"animated1",name:"fadeInLeftBig"},{type:"animated2",name:"fadeInLeft"},{type:"animated3",name:"fadeInLeftMiddle"},{type:"animated4",name:"fadeInRight"},{type:"animated5",name:"fadeInRightMiddle"},{type:"animated6",name:"fadeInRightBig"},{type:"animated7",name:"bounce"},{type:"animated8",name:"fadeInDown"},{type:"animated9",name:"fadeOut"},{type:"animated10",name:"bounceIn"},{type:"animated11",name:"при наведении контур1"},{type:"animated12",name:"при наведении контур2"},{type:"animated13",name:"SweepToTop"},{type:"animated14",name:"SweepToBottom"},{type:"animated15",name:"LineCenterBottom"},{type:"animated16",name:"scale-block"},{type:"animated17",name:"SweepToRight"},{type:"animated18",name:"SweepToLeft"},{type:"animated19",name:"underlineLRL"},{type:"animated20",name:"underline RLR"},{type:"animated21",name:"line-through LRL"},{type:"animated22",name:"underline RLR 5px"},{type:"animated23",name:"test"},{type:"animated24",name:"test"},{type:"animated25",name:"test"},{type:"animated26",name:"test"},{type:"animated27",name:"test"},{type:"animated28",name:"test"},{type:"animated29",name:"test"},{type:"animated30",name:"shake"},{type:"animated31",name:"fadeInUpBig"}],listOfListName=["news","master","stat","info","campaign","lookbook","additional","workplace"],listOfStuffDetailKind=["good","service","info","media"],listOfBlocksForAll={banner:"баннер",bannerOne:"баннер в два потока",brands:"бренды",brandTags:"коллекции",button:"кнопка",calendar:"гугл календарь",call:"заказ звонка",campaign:"акции",categories:"категории",date:"дата",feedback:"форма обратной связи",filterTags:"тематические группы (признаки из хар-тик)",filters:"характеристики",info:"информационный раздел",map:"карта",name:"название",news:"новости",position:"должность",pricegoods:"прайс товаров",priceservices:"прайс услуг",review:"отзывы гугл",schedule:"расписание для специалиста",scheduleplace:"расписание для рабочего места",slider:"слайдер",sn:"кнопки социальных сетей",stuffs:"товары",groupStuffs:"группы товаров",subscription:"подписка",subscriptionAdd:"подписка с доп полями",text:"текстовый блок",textTwo:"текстовый блок 2 потока",video:"видео",videoLink:"внешнее видео",fbpage:"страница фейсбука",comment:"комментарии дискус"},listOfBlocksForStaticPage={name:"название",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",videoLink:"внешнее видео",video:"видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",masters:"сотрудники",feedback:"обратная связь",feedback1:"обратная связь + фото",feedback2:"фото + обратная связь",stuffs:"товары",filterTags:"группы(признаки из хар-тик)",brandTags:"коллекции",brands:"бренды",categories:"категории",campaign:"акции",call:"заказ звонка",button:"кнопка"},listOfBlocksForNewsDetailPage={name:"название",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",videoLink:"внешнее видео",video:"видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",campaign:"акции",filterTags:"группы(признаки из хар-тик)",brandTags:"коллекции",brands:"бренды",categories:"категории",date:"дата",sn:"социальные сети"},listOfBlocksForMasterPage={name:"имя",position:"должность",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",schedule:"расписание"},listOfBlocksForWorkplacePage={name:"имя",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",schedule:"расписание"},listOfBlocksForAddPage={name:"имя",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",news:"новости"},listOfBlocksForHeader={logo:"логотип",name:"название",cart:"корзина",enter:"вход",info:"инфо",currency:"валюта",news:"новости",lookbook:"галлерея",search:"поиск",catalog:"каталог",new:"новинки",additional:"дополнительный список",schedule:"расписание",sale:"распродажа",campaign:"акции",master:"мастера",brands:"бренды",collection:"коллекции",phone:"телефон",sn:"социальные сети",lang:"языки",humburger:"humburger",pricegoods:"pricegoods",priceservices:"priceservices",text:"текст",icon:"иконка",likes:"избранное"},listBlocksForFooter={text:"текст",textOne:"текст 1",sn:"соц.сети",subscription:"подписка",feedback:"обратная связь",stat:"статические страницы",catalog:"каталог",infoline:"ииформационная строка",copyright:"правообладание",news:"новости",campaign:"акции",lang:"языки"},listOfBlocksForStats={name:"название",banner:"баннер",gallery:"галлерея",desc:"описание1",desc1:"описание2",desc2:"описание3",map:"карта",video:"видео",masters:"мастера"},listOfBlocksForStuffDetail={name:"название",gallery:"галлерея",desc:"описание",comments:"комментарии",lastViewed:"последние просмотренные",sort:"разновидности",group:"группа товаров",addInfo:"доп.информация",addToCart:"в корзину(действие)",price:"цены",qty:"количество",sn:"соц.сети",feedback:"обратная связь",params:"параметры",tags:"характеристики",blocks:"медиа блоки",back:"кнопка назад в список",master:"блок специалистов",stuffs:"блок товаров",video:"первое видео",videoOne:"второе видео",media:"внешнее видео",mediaOne:"второе внешнее видео"},listOfBlocksForStuffDetailBlocks={banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",calendar:"календарь",date:"дата",feedback:"обратная связь",feedbackOne:"текст + обратная связь",feedbackTwo:"обратная связь + текст",imgs:"фото",map:"карта",mapOne:"карта + текстовый блок",mapTwo:"текстовый блок + карта",masters:"блок специалистов",name:"имя",position:"должность",slider:"слайдер",sn:"соцсети",text:"текстовый блок",text2:"текстовый блок в две колонки",video:"видео",videoOne:"видео + текстовый блок",videoTwo:"текстовый блок + видео",videoLink:"внешнее видео",file:"file"},listOfBlocksForStuffList={list:"список",filters:"фильтры",categories:"категории",paginate:"пагинация",search:"поиск",call:"звонок",subscription:"подписка",desc:"описание",seoDesc:"seo описание",blocks:"медиа блоки"},tableOfColorsForButton={0:"black-white",1:"pink-white",2:"turquoise-white",3:"yellow-white",4:"bordo-white",5:"braun-white",6:"powder-white",7:"pinklight-white",8:"white-black",9:"black-white"},tableOfButtonsFile={0:"standart",1:"border-radius",2:"no border",3:"inverse",4:"border",5:"transparent"},listOfIcons=["addcart","back","cart","cartin","cartplus","cancelmenu","cancel","cancelzoom","call","caret","categories","change","dialog","down","dot","delete","downslide","gif","envelope","envelopewhite","edit","eur","fb","fbwhite","filters","header","google","googlewhite","humbmobile","chat","inst","instwhite","left","liqpay","likes","lock","lockwhite","mastercard","menu","minus","messageme","messagehe","next","nextgallery","ok","okwhite","pin","pinwhite","plus","privat","prev","prevgallery","right","rub","search","send","setting","spinner","subscription","time","tw","twwhite","uah","up","upslide","user","userhe","userme","usd","videoplay","visa","vk","vkwhite","see","enter","zoom","yt","ytwhite"],notificationsTypeLang={invoice:{ru:"счет",ua:"рахунок",en:"invoice",de:""},dateTime:{ru:"запись онлайн",ua:"запис онлайн",en:"booking",de:""},accepted:{ru:"заказ принят",ua:"замовлення прийнято",en:"accepted",de:""},shipOrder:{ru:"данные о доставке",ua:"дані про доставку",en:"shipOrder",de:""},order:{ru:"поступил заказ",ua:"поступило замовлення",en:"order",de:""},pay:{ru:"оплата",ua:"оплата",en:"pay",de:""},feedBack:{ru:"обратная связь",ua:"зворотній зв*язок",en:"feedback",de:""},comment:{ru:"комментарий",ua:"коментар",en:"comments",de:""},call:{ru:"заказ звонка",ua:"замовлення дзвінка",en:"call",de:""},subscription:{ru:"подписка",ua:"підписка",en:"subscription",de:""}},updateExternalCatalogList={everyMon10:{ru:"каждый понедельник в 10.00",ua:"",en:"",de:""},everyMon12:{ru:"каждый понедельник в 12.00",ua:"",en:"",de:""},everyFri10:{ru:"каждую пятницу в 10.00",ua:"",en:"",de:""},everyFri12:{ru:"каждую пятницу в 12.00",ua:"",en:"",de:""},everyDay10:{ru:"каждый день в 10.00",ua:"",en:"",de:""},everyDay12:{ru:"каждый день в 12.00",ua:"",en:"",de:""},everyDay101418:{ru:"каждый день в 10.00,14.00,18.00",ua:"",en:"",de:""}},ratioClassStuffDetail={0:{left:"left-block col-lg-6 col-md-6 col-sm-12 col-xs-12",right:"right-block col-lg-6 col-md-6 col-sm-12 col-xs-12"},1:{left:"left-block vertical-left3 col-lg-5 col-md-5 col-sm-12 col-xs-12",right:"right-block horizontal-right2 col-lg-7 col-md-7 col-sm-12 col-xs-12"},2:{left:"left-block vertical-left2 col-lg-4 col-md-4 col-sm-12 col-xs-12",right:"right-block horizontal-right1 col-lg-8 col-md-8 col-sm-12 col-xs-12"},3:{left:"left-block horizontal-left1 col-lg-7 col-md-7 col-sm-12 col-xs-12",right:"right-block vertical-right1  col-lg-5 col-md-5 col-sm-12 col-xs-12"},4:{left:"left-block horizontal-left2 col-lg-8 col-md-8 col-sm-12 col-xs-12",right:"right-block vertical-right2 col-lg-4 col-md-4 col-sm-12 col-xs-12"},5:{left:"left-block col-lg-12 col-md-12 col-sm-12 col-xs-12",right:"right-block col-lg-12 col-md-12 col-sm-12 col-xs-12"}},elementsList=["a","p","div","h1","h2","h3","h4","h5","ol","ul","li","span","img","input","hr","iframe","table","tr","th","td","video"],getNamePropertyCSS=function(i,item,k){if(item)switch(i){case 0:return["color",item];case 1:return["background-color",item];case 2:return["margin-top",item];case 3:return["margin-right",item];case 4:return["margin-bottom",item];case 5:return["margin-left",item];case 6:return["padding-top",item];case 7:return["padding-right",item];case 8:return["padding-bottom",item];case 9:return["padding-left",item];case 10:return["display",item];case 11:return["font-family",item];case 12:return["font-size",item];case 13:return["font-weight",item];case 14:return["letter-spacing",item];case 15:return["text-transform",item];case 16:return["width",item];case 17:return["height",item];case 18:return["float",item];case 19:return["top",item];case 20:return["left",item];case 21:return["right",item];case 22:return["bottom",item];case 23:return["text-decoration",item];case 24:return["text-align",item];case 25:return["position",item];case 26:return["border",item];case 27:return["border-left",item];case 28:return["border-right",item];case 29:return["border-top",item];case 30:return["border-bottom",item];case 31:return["border-radius",item];case 32:return["z-index",item];case 33:return["opacity",item];case 34:return["border-width",item];case 35:return["list-style",item];case 36:return["vertical-align",item];case 37:return["background-size",item];case 38:return["background-position",item];case 39:return["text-shadow",item];case 40:return["cursor",item];case 41:return["transition",item];case 42:return["box-shadow",item];case 43:return["transform",item];case 44:return["background",item];case 45:return["clear",item];case 46:return["max-width",item];case 47:return["min-width",item];case 48:return["max-height",item];case 49:return["min-height",item];case 50:return["line-height",item];case 51:return["object-fit",item];case 52:return["object-position",item];case 53:return["overflow",item];case 54:return["background-attachment",item];case 55:return["background-repeat",item];case 56:return["padding",item];case 57:return["margin",item];case 58:return["word-break",item];case 59:return["word-wrap",item];case 60:return["word-spacing",item];case 61:return["background-image",item];case 62:return["white-space",item];case 63:return["text-overflow",item];case 64:return["text-indent",item]}else switch(i){case 0:return"color";case 1:return"background-color";case 2:return"margin-top";case 3:return"margin-right";case 4:return"margin-bottom";case 5:return"margin-left";case 6:return"padding-top";case 7:return"padding-right";case 8:return"padding-bottom";case 9:return"padding-left";case 10:return"display";case 11:return"font-family";case 12:return"font-size";case 13:return"font-weight";case 14:return"letter-spacing";case 15:return"text-transform";case 16:return"width";case 17:return"height";case 18:return"float";case 19:return"top";case 20:return"left";case 21:return"right";case 22:return"bottom";case 23:return"text-decoration";case 24:return"text-align";case 25:return"position";case 26:return"border";case 27:return"border-left";case 28:return"border-right";case 29:return"border-top";case 30:return"border-bottom";case 31:return"border-radius";case 32:return"z-index";case 33:return"opacity";case 34:return"border-width";case 35:return"list-style";case 36:return"vertical-align";case 37:return"background-size";case 38:return"background-position";case 39:return"text-shadow";case 40:return"cursor";case 41:return"transition";case 42:return"box-shadow";case 43:return"transform";case 44:return"background";case 45:return"clear";case 46:return"max-width";case 47:return"min-width";case 48:return"max-height";case 49:return"min-height";case 50:return"line-height";case 51:return"object-fit";case 52:return"object-position";case 53:return"overflow";case 54:return"background-attachment";case 55:return"background-repeat";case 56:return"padding";case 57:return"margin";case 58:return"word-break";case 59:return"word-wrap";case 60:return"word-spacing";case 61:return"background-image";case 62:return"white-space";case 63:return"text-overflow";case 64:return"text-indent"}};"undefined"==typeof window&&(exports.listOfBlocksForMainPage=listOfBlocksForMainPage,exports.listOfBlocksForHeader=listOfBlocksForHeader,exports.listBlocksForFooter=listBlocksForFooter,exports.listOfBlocksForStats=listOfBlocksForStats,exports.listOfBlocksForStuffDetail=listOfBlocksForStuffDetail,exports.listOfBlocksForStuffList=listOfBlocksForStuffList,exports.lengthStyleBlock=lengthStyleBlock,exports.arrEmptyForProperties=arrEmptyForProperties,exports.listOfBlocksForNewsDetailPage=listOfBlocksForNewsDetailPage,exports.listOfBlocksForStaticPage=listOfBlocksForStaticPage,exports.modelsName=modelsName,exports.getNamePropertyCSS=getNamePropertyCSS,exports.listOfListName=listOfListName,exports.ratioClassStuffDetail=ratioClassStuffDetail,exports.elementsList=elementsList,exports.reservedFirstParams=reservedFirstParams,exports.reservedFirstParamsForAdmin=reservedFirstParamsForAdmin,exports.minTimePart=minTimePart,exports.listOfBlocksForStuffDetailBlocks=listOfBlocksForStuffDetailBlocks);var listOfStuffFields=[{name:"название",value:"name"},{name:"артикул",value:"artikul"},{name:"описание",value:"desc"},{name:"количество",value:"quantity"},{name:"бренд",value:"brand"},{name:"коллекция",value:"brandTag"},{name:"категория",value:"category"},{name:"цена",value:"price"},{name:"цена sale",value:"priceSale"},{name:"цена розница",value:"retail"},{name:"фото",value:"imgs"},{name:"архив фото",value:"zipImg"},{name:"валюта",value:"currency"},{name:"id валюты",value:"currencyId"},{name:"разновидность",value:"sort"},{name:"url",value:"url"},{name:"id категории",value:"categoryId"},{name:"характеристики",value:"tags"}];!function(){function url_slug(s,opt){s=String(s),opt=Object(opt);var defaults={delimiter:"-",limit:void 0,lowercase:!0,replacements:{},transliterate:"undefined"==typeof XRegExp};for(var k in defaults)opt.hasOwnProperty(k)||(opt[k]=defaults[k]);var char_map={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ő":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ű":"U","Ý":"Y","Þ":"TH","ß":"ss","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ð":"d","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ő":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ű":"u","ý":"y","þ":"th","ÿ":"y","©":"(c)","Α":"A","Β":"B","Γ":"G","Δ":"D","Ε":"E","Ζ":"Z","Η":"H","Θ":"8","Ι":"I","Κ":"K","Λ":"L","Μ":"M","Ν":"N","Ξ":"3","Ο":"O","Π":"P","Ρ":"R","Σ":"S","Τ":"T","Υ":"Y","Φ":"F","Χ":"X","Ψ":"PS","Ω":"W","Ά":"A","Έ":"E","Ί":"I","Ό":"O","Ύ":"Y","Ή":"H","Ώ":"W","Ϊ":"I","Ϋ":"Y","α":"a","β":"b","γ":"g","δ":"d","ε":"e","ζ":"z","η":"h","θ":"8","ι":"i","κ":"k","λ":"l","μ":"m","ν":"n","ξ":"3","ο":"o","π":"p","ρ":"r","σ":"s","τ":"t","υ":"y","φ":"f","χ":"x","ψ":"ps","ω":"w","ά":"a","έ":"e","ί":"i","ό":"o","ύ":"y","ή":"h","ώ":"w","ς":"s","ϊ":"i","ΰ":"y","ϋ":"y","ΐ":"i","А":"A","Б":"B","В":"V","Г":"G","Д":"D","Е":"E","Ё":"Yo","Ж":"Zh","З":"Z","И":"I","Й":"J","К":"K","Л":"L","М":"M","Н":"N","О":"O","П":"P","Р":"R","С":"S","Т":"T","У":"U","Ф":"F","Х":"H","Ц":"C","Ч":"Ch","Ш":"Sh","Щ":"Sh","Ъ":"","Ы":"Y","Ь":"","Э":"E","Ю":"Yu","Я":"Ya","а":"a","б":"b","в":"v","г":"g","д":"d","е":"e","ё":"yo","ж":"zh","з":"z","и":"i","й":"j","к":"k","л":"l","м":"m","н":"n","о":"o","п":"p","р":"r","с":"s","т":"t","у":"u","ф":"f","х":"h","ц":"c","ч":"ch","ш":"sh","щ":"sh","ъ":"","ы":"y","ь":"","э":"e","ю":"yu","я":"ya","Є":"Ye","І":"I","Ї":"Yi","Ґ":"G","є":"ye","і":"i","ї":"yi","ґ":"g","Č":"C","Ď":"D","Ě":"E","Ň":"N","Ř":"R","Š":"S","Ť":"T","Ů":"U","Ž":"Z","č":"c","ď":"d","ě":"e","ň":"n","ř":"r","š":"s","ť":"t","ů":"u","ž":"z"};for(var k in opt.replacements)s=s.replace(RegExp(k,"g"),opt.replacements[k]);if(opt.transliterate)for(var k in char_map)s=s.replace(RegExp(k,"g"),char_map[k]);var alnum="undefined"==typeof XRegExp?RegExp("[^a-z0-9]+","ig"):XRegExp("[^\\p{L}\\p{N}]+","ig");return s=s.replace(alnum,opt.delimiter),s=s.replace(RegExp("["+opt.delimiter+"]{2,}","g"),opt.delimiter),s=s.substring(0,opt.limit),s=s.replace(RegExp("(^"+opt.delimiter+"|"+opt.delimiter+"$)","g"),""),opt.lowercase?s.toLowerCase():s}function decimalAdjust(type,value,exp){return void 0===exp||0==+exp?Math[type](value):(value=+value,exp=+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp))),value=value.toString().split("e"),+(value[0]+"e"+(value[1]?+value[1]+exp:exp))))}Math.round10||(Math.round10=function(value,exp){return decimalAdjust("round",value,exp)}),Math.floor10||(Math.floor10=function(value,exp){return decimalAdjust("floor",value,exp)}),Math.ceil10||(Math.ceil10=function(value,exp){return decimalAdjust("ceil",value,exp)}),Array.prototype.getObjectFromArray=function(prop,value,a,filter){for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].toString&&"function"==typeof this[i][prop].toString&&(this[i][prop]=this[i][prop].toString()),this[i][prop]&&this[i][prop]==value){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.getOFA=function(prop,value,a,filter){prop=prop.split("."),1==prop.length&&(prop=prop[0]);for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i]&&(this[i][prop]&&this[i][prop].toString&&"function"==typeof this[i][prop].toString&&(this[i][prop]=this[i][prop].toString()),this[i][prop]&&this[i][prop]==value||prop.length&&this[i][prop[0]]&&this[i][prop[0]][prop[1]]&&this[i][prop[0]][prop[1]]==value)){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.removeOFA=function(prop,value){for(var i=this.length;i--;)this[i]&&this[i].hasOwnProperty(prop)&&arguments.length>1&&this[i][prop]===value&&this.splice(i,1);return this},Array.prototype.getArrayObjects=function(prop,value){for(var arr=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].length){var _arr=this[i][prop].map(function(item){return"object"==typeof item?item._id:item});_arr.indexOf(value)>-1&&arr.push(this[i])}return arr},Array.prototype.diff=function(a){return this.filter(function(i){return a.indexOf(i)<0})},Array.prototype.divideArrayWithChunk=function(chunk,fillArrayToEquil){if(!chunk)return[[],[],[],[],[]];if((chunk=Number(chunk))<2)return this;for(var data=this,arr=[],j=0;j<chunk;j++){arr[j]=[];for(var i=j,l=data.length;i<l;i+=chunk)arr[j].push(data[i])}if(fillArrayToEquil)for(var i=1,l=arr.length;i<l;i++)arr[i].length<arr[0].length&&arr[i].push({});return arr},Array.prototype.extend=function(other_array){other_array.forEach(function(v){this.push(v)},this)},String.prototype.clearTag=function(num){if(num)var ss=this.replace(/<\/?[^>]+(>|$)/g,"").substring(0,num);else var ss=this.replace(/<\/?[^>]+(>|$)/g,"");return ss.replace(/\./g,". ")},String.prototype.myTrim=function(){return this.trim().split("\n").filter(function(str){return str}).map(function(str){return str.replace(/&nbsp;/g," ").trim()}).filter(function(str){return str}).join("")},String.prototype.clearFirstTag=function(tag){var i=tag.length;return this.substring(2+i,this.length-(3+i))},String.prototype.replaceBlanks=function(){if(this)return this.replace(/(["',.\/\s])/g,"-")},String.prototype.getFormatedDate=function(){var d=new Date(this);return d.getDate()+"-"+(d.getMonth()+1)+"-"+d.getFullYear()},String.prototype.splice||(String.prototype.splice=function(start,delCount,newSubStr){return this.slice(0,start)+newSubStr+this.slice(start+Math.abs(delCount))});new Array("Я","я","Ю","ю","Ч","ч","Ш","ш","Щ","щ","Ж","ж","А","а","Б","б","В","в","Г","г","Д","д","Е","е","Ё","ё","З","з","И","и","Й","й","К","к","Л","л","М","м","Н","н","О","о","П","п","Р","р","С","с","Т","т","У","у","Ф","ф","Х","х","Ц","ц","Ы","ы","Ь","ь","Ъ","ъ","Э","э","/","&"),new Array("Ya","ya","Yu","yu","Ch","ch","Sh","sh","Sh","sh","Zh","zh","A","a","B","b","V","v","G","g","D","d","E","e","E","e","Z","z","I","i","J","j","K","k","L","l","M","m","N","n","O","o","P","p","R","r","S","s","T","t","U","u","F","f","H","h","C","c","Y","y","","","'","'","E","e","-","-");String.prototype.getUrl=function(){return url_slug(this)},String.prototype.shuffle=function(len){len||(len=this.length);for(var parts=this.split(""),i=parts.length;i>0;){var random=parseInt(Math.random()*i),temp=parts[--i];parts[i]=parts[random],parts[random]=temp}return parts.join("").substring(0,len)}}(),function(){function checkMaxDiscount(stuff,price){stuff.maxDiscount&&100*(1-price/stuff.price)>stuff.maxDiscount&&(stuff.maxDiscountOver=!0)}function getOrder(){return new order}var order=function(){function _checkInCondition(__campaign,stuff){var stuffBrand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,stuffCategory="object"==typeof stuff.category&&stuff.category.length?stuff.category[0]:stuff.category;return!!(__campaign.conditionStuffs&&__campaign.conditionStuffs.length&&__campaign.conditionStuffs.indexOf(stuff._id)>-1)||(!!(__campaign.conditionTags&&__campaign.conditionTags.length&&__campaign.conditionTags.some(function(tag){return stuff.tags.indexOf(tag)>-1}))||(!!(__campaign.conditionBrandTags&&__campaign.conditionBrandTags.length&&__campaign.conditionBrandTags.indexOf(stuff.brandTag)>-1)||(!!(__campaign.conditionBrands&&__campaign.conditionBrands.length&&__campaign.conditionBrands.indexOf(stuffBrand)>-1)||(!!(__campaign.conditionCategories&&__campaign.conditionCategories.length&&__campaign.conditionCategories.indexOf(stuffCategory)>-1)||void 0))))}var self=this;this.cart={stuffs:[]},this.seller=null,this.cascade=[],this.opt={},this.campaign=[],this.coupon={},this.totalCount=0,this.sum=0,this.price,this.priceSale,this.retail,this.discount=null,this.currency,this.mainCurrency,this.currencyStore,this.messageForCampaign={},this.type,this.user,this.paySum,this._cartCount=function(campaign,cam){var i=0;return this.cart.stuffs.forEach(function(item){campaign?"withoutcampaign"==campaign?item.campaignId||(cam?_checkInCondition(cam,item)&&(i+=Number(item.quantity)):i+=Number(item.quantity)):item.campaignId==campaign&&(i+=Number(item.quantity)):item.quantity&&(i+=Number(item.quantity))}),i},this._checkDiscount=function(){var dis=this.discount;if(dis)return dis.value||(dis.value=0),1==dis.type||3==dis.type?self.price:2==dis.type||4==dis.type||5==dis.type?self.priceSale?self.priceSale:self.price:void 0},this._getDiscountPrice=function(dis,s){if(dis){if(dis.value||(dis.value=0),1==dis.type)return s.price;if(2==dis.type)return s.priceSale?s.priceSale:s.price;if(3==dis.type)return Math.ceil10(s.price-s.price/100*dis.value,-5);if(4==dis.type)return s.priceSale?s.priceSale:Math.ceil10(s.price-s.price/100*dis.value,-5);if(5==dis.type){var cena;return cena=s.priceSale?s.priceSale:s.price,Math.ceil10(cena-cena/100*dis.value,-5)}}},this._checkDiscount2302=function(){var dis=this.discount;if(dis){if(dis.value||(dis.value=0),1==dis.type)return self.price;if(2==dis.type)return self.priceSale?self.priceSale:self.price;if(3==dis.type)return Math.ceil10(self.price-self.price/100*dis.value,-5);if(4==dis.type)return self.priceSale?self.priceSale:Math.ceil10(self.price-self.price/100*dis.value,-5);if(5==dis.type){var cena;return cena=self.priceSale?self.priceSale:self.price,Math.ceil10(cena-cena/100*dis.value,-5)}}},this._isStuffInCampaign=function(stuff,campaign){function check(__campaign){return!!(__campaign.stuffs&&__campaign.stuffs.length&&__campaign.stuffs.indexOf(stuff._id)>-1)||(!!(__campaign.tags&&__campaign.tags.length&&stuff.tags&&__campaign.tags.some(function(tag){return stuff.tags.indexOf(tag)>-1}))||(!!(__campaign.brandTags&&__campaign.brandTags.length&&__campaign.brandTags.indexOf(stuffBrandTag)>-1)||(!!(__campaign.brands&&__campaign.brands.length&&__campaign.brands.indexOf(stuffBrand)>-1)||(!!(__campaign.categories&&__campaign.categories.length&&__campaign.categories.indexOf(stuffCategory)>-1)||void 0))))}function setCampaignPrice(__campaign){stuff.sticker=__campaign.sticker,stuff.campaignUrl=__campaign.url,stuff.campaignId=__campaign._id;var i=0;for(var key in stuff.stock){var price=Number(stuff.stock[key].price);stuff.stock[key].priceCampaign="percent"==__campaign.condition?Math.ceil10(price-Number(__campaign.percent)/100*price,-2):Math.ceil10(price-Number(__campaign.sum),-2),i||(i++,stuff.priceCampaign=stuff.stock[key].priceCampaign)}}var stuffCategory="object"==typeof stuff.category&&stuff.category.length?stuff.category[0]:stuff.category,stuffBrand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,stuffBrandTag=stuff.brandTag&&stuff.brandTag._id?stuff.brandTag._id:stuff.brandTag;if(!self.campaign||!self.campaign.length)return!1;if(campaign){var __campaign=self.campaign.getObjectFromArray("_id",campaign);if(__campaign){var is=check(__campaign);if(is&&!__campaign.revers||!is&&__campaign.revers)return setCampaignPrice(__campaign),__campaign}}else for(var j=0,ll=self.campaign.length;j<ll;j++){var is=check(self.campaign[j]);if(is&&!self.campaign[j].revers||!is&&self.campaign[j].revers)return setCampaignPrice(self.campaign[j]),self.campaign[j]}return!1},this._getCountForBaseStuffs=function(campaign){var q=0;return this.cart.stuffs.forEach(function(item){campaign.forGroupBase?campaign.groupBaseTag&&item.tags&&item.tags.indexOf(campaign.groupBaseTag)>-1?q+=Number(item.quantity):campaign.groupBaseCollection&&campaign.groupBaseCollection==stuff.brandTag&&(q+=Number(item.quantity)):campaign.baseStuffs.indexOf(item._id)>-1&&(q+=Number(item.quantity))}),q},this._checkCompaignCondition=function(id){if(self.campaign){var __campaign=self.campaign.getOFA("_id",id);if(!__campaign||__campaign.forAll||__campaign.revers)return!0;var countConditionStuffs=self._cartCount("withoutcampaign",__campaign);if(!__campaign.ratio)return!0;var countStuff=self._cartCount(__campaign._id);return parseInt(countConditionStuffs/__campaign.ratio)>=countStuff||void 0}},this._checkCompaignConditionForBase=function(id){var campaign=self.campaign.getObjectFromArray("_id",id);if(campaign.useBase&&self._getCountForBaseStuffs(campaign)>=campaign.condition&&!self._cartCount(campaign._id))return!0},this._getUnitOfMeasure=function(){var a=this.cart.stuffs.reduce(function(arr,i){return i.unitOfMeasure&&arr.indexOf(i.unitOfMeasure)<0&&arr.push(i.unitOfMeasure),arr},[]);return 1==a.length?a[0]:null}},_getCascadePrice=function(self){var newPrice=self.price,cascade=self.cascade;if(cascade&&cascade.length){for(var i=0,l=cascade.length;i<l;i++)self.totalCount>=cascade[i][0]&&(newPrice=Math.ceil10(self.price-self.price/100*cascade[i][1],-2));return newPrice}return self.price};order.prototype.init=function(campaign,mainCurrency,currencyStore){this.campaign=campaign,this.mainCurrency=mainCurrency,this.currencyStore=currencyStore},order.prototype.setCamapign=function(campaign){this.campaign=campaign;for(var i=0,l=campaign.length;i<l;i++)this.messageForCampaign[campaign[i].url]={base:null,stuff:null}},order.prototype.setCart=function(stuffs){this.cart.stuffs=stuffs,this.sortCart()},order.prototype.setSellerData=function(seller,cascade,opt){this.seller=seller,this.cascade=cascade,this.opt=opt},order.prototype.setCoupon=function(coupon){this.coupon=coupon},order.prototype.setDiscount=function(discount){this.discount=discount},order.prototype.setCurrency=function(currency){this.currency=currency},order.prototype.changeCurrency=function(currency){this.currency=currency,this.kurs=this.currencyStore[this.currency][0]},order.prototype.getPrice=function(i){var stuff=this.cart.stuffs[i];this.totalCount=this._cartCount(),this.price=stuff.price,this.priceSale=stuff.priceSale,this.retail=stuff.retail,this.priceCampaign=stuff.priceCampaign,stuff.maxDiscountOver=!1;var optIs=!1;(!this.opt||!this.opt.quantity||this.totalCount>=this.opt.quantity)&&(optIs=!0);var cena;return(cena=this._checkDiscount())?(this.discount&&this.discount.value&&stuff.maxDiscount&&this.discount.value>stuff.maxDiscount?stuff.maxDiscountOver=!0:checkMaxDiscount(stuff,cena),cena):stuff.priceCampaign&&optIs&&this._checkCompaignCondition(stuff.campaignId)?stuff.priceCampaign:optIs?this.priceSale?(checkMaxDiscount(stuff,this.priceSale),this.priceSale):_getCascadePrice(this):this.retail||this.price},order.prototype.getTotalSum=function(discount){var sum=0,self=this;if(this.cart.stuffs.forEach(function(c){var s=c.sum?c.sum:c.price;if(discount){var p=self._getDiscountPrice(self.discount,c);p&&(s=p*c.quantity)}sum+=s}),discount){var dis=this.discount;dis&&(6==dis.type?sum=Math.ceil10(sum-sum/100*dis.value,-5):7==dis.type&&(sum-=dis.value))}return sum},order.prototype.getTotalQuantity=function(){var q=0;return this.cart.stuffs.forEach(function(c){q+=Number(c.quantity)}),q},order.prototype.getCampaignQuantity=function(){return this._cartCount("campaign")},
order.prototype.getConditionForDisplayMsg=function(){return this.messageForCampaign},order.prototype.getCouponSum=function(){if(this.couponSum=this.sum,this.coupon&&Object.keys(this.coupon).length)if(this.coupon.condition){if(this.coupon.condition){var val=this.coupon.val;this.coupon.currency&&this.currencyStore[this.coupon.currency]&&this.currencyStore[this.coupon.currency][0]&&(val=Math.round(val/this.currencyStore[this.coupon.currency][0])),this.couponSum=this.sum-Number(val)}}else this.couponSum=Math.ceil10(this.sum-this.sum/100*Number(this.coupon.val),-5);return this.couponSum},order.prototype.clearOrder=function(){this.cart.stuffs.length=0,this.coupon={},this.totalCount=0,this.sum=0},order.prototype.checkInCart=function(itemTo){return this.cart.stuffs.some(function(c){return itemTo._id==c._id&&itemTo.sort==c.sort})},order.prototype.addStuffToOrder=function(itemTo){if(this.cart.stuffs.length>=150)return!1;if(this.cart.stuffs.some(function(c){return itemTo._id==c._id&&itemTo.sort==c.sort}))return!1;var itemToCart=angular.copy(itemTo);for(var key in itemToCart)"function"==typeof itemToCart[key]&&delete itemToCart[key];return delete itemToCart.comments,delete itemToCart.desc,delete itemToCart.gallery,delete itemToCart.imgs,delete itemToCart.nameL,delete itemToCart.checkInCart,delete itemToCart.addItemToOrder,delete itemToCart.addInfo,delete itemToCart.getDataForBooking,delete itemToCart.FullTags,delete itemToCart.changeSortOfStuff,delete itemToCart.checkInCart,delete itemToCart.driveRetailPrice,delete itemToCart.getBonus,delete itemToCart.zoomImg,delete itemToCart.stockKeysArray,delete itemToCart.sortsOfStuff,delete itemToCart.setPrice,this.cart.stuffs.push(itemToCart),this.sortCart(),!0},order.prototype.getShipCost=function(){return this.shipDetail.reduce(function(s,c){return isNaN(c.sum)?s:s+Number(c.sum)},0)},order.prototype.getTotalPay=function(){return this.pay||(this.pay=[]),this.pay.reduce(function(s,c){return isNaN(c.sum)?s:s+Number(c.sum)},0)},order.prototype.getTotalDiscount=function(){if(this.sum&&this.sum0)return this.sum>this.sum0?0:100-Math.round(100*this.sum/this.sum0)},order.prototype.checkCampaign=function(stuff){return this._isStuffInCampaign(stuff)},order.prototype.sortCart=function(){this.cart.stuffs.sort(function(a,b){if(!a.extCatalog&&!b.extCatalog)return a.category<b.category?-1:a.category>b.category?1:0;if(a.extCatalog&&!b.extCatalog)return 1;if(!a.extCatalog&&b.extCatalog)return-1;if(a.extCatalog&&b.extCatalog&&a.extCatalog!=b.extCatalog){if(a.category<b.category)return-1;if(a.category>b.category)return 1}else if(a.extCatalog&&b.extCatalog&&a.extCatalog==b.extCatalog)return a.category<b.category?-1:a.category>b.category?1:0})};var myShareData={getOrder:getOrder};"undefined"!=typeof window?(window.myShareData=myShareData,window.OrderModel=order):module.exports=myShareData}();var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();!function(){function _prepareQueryForRequest(queryStart){var arr_id,query=[];for(var key in queryStart)if(queryStart[key])if("tags"==key){var qu=[];for(var key2 in queryStart[key]){var obj=queryStart[key][key2],q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else if("brandTag"==key){if(queryStart[key].length){var obj={};obj[key]={$in:queryStart[key]},query.push(obj)}}else if("_id"==key)queryStart[key].length&&(arr_id={},arr_id[key]={$in:queryStart[key]});else{var obj={};obj[key]=queryStart[key],query.push(obj)}return query=1==query.length?arr_id?JSON.stringify({$or:[query[0],arr_id]}):JSON.stringify(query[0]):query.length>1?arr_id?JSON.stringify({$or:[{$and:query},arr_id]}):JSON.stringify({$and:query}):arr_id?JSON.stringify(arr_id):{}}function _setQueryForTags(query,filters){if(query.queryTags&&"object"==_typeof(query.queryTags)){var keys=Object.keys(query.queryTags);1==keys.length?query.tags={$in:query.queryTags[keys[0]]}:keys.length>1&&(query.$and=[],keys.forEach(function(k){query.$and.push({tags:{$in:query.queryTags[k]}})}))}delete query.queryTags;var keys=Object.keys(query.filters);if(1==keys.length){var filter;filters&&(filter=filters.getOFA("_id",keys[0])),filter&&filter.price?(query.priceForFilter=query.filters[keys[0]],console.log(query.filters[keys[0]])):query["filters."+keys[0]]=query.filters[keys[0]]}else if(keys.length>1&&(query.$and||(query.$and=[]),keys.forEach(function(k){var filter;if(filters&&(filter=filters.getOFA("_id",k)),filter&&filter.price)query.priceForFilter=query.filters[k];else{var o={};o["filters."+k]=query.filters[k],query.$and.push(o)}}),1==query.$and.length)){for(var k in query.$and[0])query[k]=query.$and[0][k];delete query.$and}delete query.filters}var designQuery=function(){function designQuery(brands,brandTags,filters,sectionClass,categories){_classCallCheck(this,designQuery),this.brands=brands,this.brandTags=brandTags,this.filters=filters,this.filterTags=filters.reduce(function(a,item){return a.concat(item.tags)},[]),this.sections=sectionClass.getSections(),this.categories=sectionClass.getCategories(),this.sectionClass=sectionClass}return _createClass(designQuery,[{key:"getQuery",value:function(stateParams,queryParams){if(queryParams)for(var k in queryParams)stateParams[k]=queryParams[k];stateParams.groupUrl=stateParams.group,stateParams.categoryUrl=stateParams.category;var parentSection,sectionCategories,categoryBrands=[],categoryFilters=[],query={},brands=(this.sections,this.brands),filters=this.filters;this.categories;if(!(parentSection=this.sectionClass.getSection(stateParams.groupUrl)))throw 404;if("category"!=stateParams.categoryUrl){var category=parentSection.categoriesO[stateParams.categoryUrl];if(!category)throw 404;query.category=category._id,categoryBrands=category.brands,categoryFilters=category.filters}else{var sectionCategoriesFull=this.sectionClass.getEmbededCategories(parentSection,[]);sectionCategories=sectionCategoriesFull.map(function(el){return el._id}),sectionCategories.length?(query.category={$in:sectionCategories},sectionCategoriesFull.forEach(function(c){c.filters.forEach(function(f){categoryFilters.indexOf(f)<0&&categoryFilters.push(f)}),c.brands.forEach(function(b){categoryBrands.indexOf(b)<0&&categoryBrands.push(b)})})):query.category=null}var brandsArr,brandTagsArr;stateParams.brand&&(brandsArr=stateParams.brand.split("__"),stateParams.brand=stateParams.brand.split("__")),stateParams.brandTag&&(brandTagsArr=stateParams.brandTag.split("__"),stateParams.brandTag=stateParams.brandTag.split("__")),query.brand=[],query.brandTag=[],brands.forEach(function(b){brandsArr&&brandsArr.indexOf(b.url)>-1&&query.brand.push(b._id),b.tags.forEach(function(t){brandTagsArr&&brandTagsArr.indexOf(t.url)>-1&&query.brandTag.push(t._id)})}),query.brand.length?1==query.brand.length?query.brand=query.brand[0]:query.brand={$in:query.brand}:query.brand=null,query.brandTag.length?1==query.brandTag.length?query.brandTag=query.brandTag[0]:query.brandTag={$in:query.brandTag}:query.brandTag=null,query.brandTag||delete query.brandTag,query.brand||delete query.brand;var queryTags;stateParams.queryTag&&(queryTags=stateParams.queryTag.split("__"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos})),query.filters={};var filterTags;if(stateParams.filterTag&&(filterTags=stateParams.filterTag.split("__"),filterTags=filterTags.filter(function(item,pos){return filterTags.indexOf(item)==pos}),filterTags=filterTags.map(function(f){return f.split("_")}).filter(function(f){return 3==f.length}).forEach(function(f){query.filters[f[0]]={$gte:Number(f[1]),$lte:Number(f[2])}})),query.queryTags={},filters.forEach(function(f){f.count?query.filters[f._id]?(f.minValue=query.filters[f._id].$gte,f.maxValue=query.filters[f._id].$lte):(f.minValue=f.min,f.maxValue=f.max):f.tags.forEach(function(t){queryTags&&queryTags.indexOf(t.url)>-1&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})}),_setQueryForTags(query,filters),query.actived=!0,stateParams.searchStr){var search=stateParams.searchStr.substring(0,20);query.$or=[{name:search},{artikul:search}]}return query}},{key:"getQueryString",value:function(params,query,queryCategory){this.queryCategory=queryCategory;var brand=(params.group,params.category,query.brand),brandTag=query.brandTag,queryTag=query.queryTag,q={},b=this.brands.getOFA("url",brand);if(brand&&b&&(q.brand=b._id),brandTag){var bt=void 0;if(b){var _bt=b.tags.getOFA("url",brandTag);_bt&&(q.brandTag=_bt._id)}else for(var i=0;i<this.brands.length;i++)if(bt=this.brands[i].tags.getOFA("url",brandTag)){q.brandTag=bt._id;break}}if(queryTag){q.tags={};var filterTags=this.filterTags;queryTag.split("+").map(function(url){return filterTags.getOFA("url",url)}).filter(function(t){return t}).forEach(function(t){q.tags[t.filter]||(q.tags[t.filter]=[]),q.tags[t.filter].push(t._id)})}return this.queryCategory&&this.queryCategory.category&&(q.category=this.queryCategory.category),_prepareQueryForRequest(q)}}]),designQuery}();"undefined"!=typeof window?window.DesignQuery=designQuery:exports.init=designQuery}();var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();!function(){var Section=function(){function Section(sections){_classCallCheck(this,Section),this.sections=sections,this.categories=sections.reduce(function(a,s){return s.categoriesO={},s.categories&&s.categories.forEach(function(cat){a[cat.url]=cat,s.categoriesO[cat.url]=cat}),s.child&&s.child.forEach(function(c){c.categoriesO={},c.categories&&c.categories.forEach(function(cat){a[cat.url]=cat,c.categoriesO[cat.url]=cat})}),a},{})}return _createClass(Section,[{key:"getSections",value:function(){return this.sections}},{key:"getCategories",value:function(){return this.categories}},{key:"getSection",value:function(sectionUrl){if(!this.sections)return null;for(var sections=this.sections,i=0,l=sections.length;i<l;i++){if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length)for(var j=0,ll=sections[i].child.length;j<ll;j++)if(sections[i].child[j].url&&sections[i].child[j].url==sectionUrl)return sections[i].child[j]}return null}},{key:"getParentSection",value:function(sectionUrl,id){if(!this.sections)return null;for(var sections=this.sections,i=0,l=sections.length;i<l;i++){if(id){if(sections[i]._id==sectionUrl)return sections[i]}else if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length){var categories;if(categories=_getParentSection(sections[i].child,sectionUrl,id))return categories}}return null}},{key:"getEmbededCategories",value:function(section,arr){return section.categories&&section.categories.length&&arr.push.apply(arr,section.categories),section.child&&section.child.length&&section.child.forEach(function(child,i){arr.push.apply(arr,section.child[i].categories)}),arr}},{key:"getListType",value:function(params){if(!params.group)return"good";for(var i=0;i<this.sections.length;i++){if(this.sections[i].url==params.group&&this.sections[i].type)return this.sections[i].type;if(this.sections[i].child&&this.sections[i].child.length)for(var j=0;j<this.sections[i].child.length;j++)if(this.sections[i].child[j].url==params.group&&this.sections[i].type)return this.sections[i].type}return"good"}}]),Section}();"undefined"!=typeof window?window.SectionClass=Section:exports.init=Section}(),Number.isInteger=Number.isInteger||function(value){return"number"==typeof value&&isFinite(value)&&Math.floor(value)===value},setMetaOG();var preloadPade=document.getElementById("preloadPage"),durationTemp=2;try{preloadDuration&&(preloadDuration=Number(preloadDuration),preloadDuration>1&&preloadDuration<10&&(durationTemp=preloadDuration))}catch(err){}var preloadAnimateClass="hidden-preload-page";$(preloadPade).data("preloadAnimateClass")&&(preloadAnimateClass=$(preloadPade).data("preloadAnimateClass"));var k=getCookie("preload");if(k)$(preloadPade).remove();else{setTimeout(function(){$(preloadPade).addClass(preloadAnimateClass),setTimeout(function(){$(preloadPade).remove()},1e3)},1e3*durationTemp);var options={path:"/",expires:3600};setCookie("preload","true",options)}$("#hidePreloadPage").click(function(){$(preloadPade).addClass(preloadAnimateClass),setTimeout(function(){$(preloadPade).remove()},1e3)});var iPhone=!1;getMobileOperatingSystem();var sectionClass,dQ,_filterTags=[],_filterTagsO={},_filtersO={};filtersFromServer.forEach(function(filter){_filtersO[filter._id]=filter,filter.tags&&filter.tags.length&&(filter.tags.forEach(function(t,i){t.index=i,_filterTagsO[t._id]=t}),_filterTags.push.apply(_filterTags,filter.tags))}),angular.module("gmall",["ngRoute","ui.router","ui.router.state.events","ngResource","gmall.controllers","gmall.services","gmall.directives","gmall.filters","ui.bootstrap","ngTouch","lazyImg","ngSocial","ngAnimate","gmall.exception","toaster","ui.select","pageslide-directive","satellizer","ngMessages","angular-click-outside","ui.mask","vcRecaptcha","rzModule"]).run(["$rootScope","$state","$stateParams","global","globalSrv","$window","$location","$anchorScroll","$timeout","seoContent","$order","Campaign","$user","Witget","$auth","Account","Sections","$q","Seopage","$uibModal","Stuff","$injector","$route","$document","$transitions","$sce","$email","exception","$http","$notification","CreateContent","localStorage","Confirm",function($rootScope,$state,$stateParams,global,globalSrv,$window,$location,$anchorScroll,$timeout,seoContent,$order,Campaign,$user,Witget,$auth,Account,Sections,$q,Seopage,$uibModal,Stuff,$injector,$route,$document,$transitions,$sce,$email,exception,$http,$notification,CreateContent,localStorage,Confirm){function _logged(){global.get("user").val&&global.get("user").val._id;$rootScope.$broadcast("logged")}function _openChatWitget(field){clickForOpenChat||(clickForOpenChat=!0,$rootScope.checkedMenuChange(field,!$rootScope.checkedMenu[field]),setTimeout(function(){clickForOpenChat=!1},200))}$rootScope.getDataFromIp=function(data){console.log(data)},global.set("filterTags",_filterTags),global.set("filterTagsO",_filterTagsO),$(this).scrollTop(0),$rootScope.checkedMenu={m:!1,slideMenu:!1},$rootScope.stuffHost=stuffHost,$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.global=global,$rootScope.soundChat=document.getElementById("soundChat"),$rootScope.globalProperty={entryStuff:null,displaySearch:!1},$rootScope.ignoreClick=function($event){$event&&($event.stopPropagation(),$event.preventDefault())},$rootScope.$watch(function(){return $location.url()},function(newLocation,oldLocation){if($rootScope.actualLocation===newLocation){var back,historyState=$window.history.state;back=!!(historyState&&historyState.position<=$rootScope.stackPosition),back?$rootScope.stackPosition--:$rootScope.stackPosition++}else $route.current&&($window.history.replaceState({position:$rootScope.stackPosition}),$rootScope.stackPosition++)}),$transitions.onBefore({to:"*",from:"*"},function(trans){});var firstStateChenged;$rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){if($rootScope.globalProperty.displaySearch=!1,"master.item"!=fromState.name||"master.item"!=to.name){if(firstStateChenged||(firstStateChenged=!0,global.set("tempContent",templateContentHTML)),"cart"==to.name&&global.get("store").val.cartSetting&&global.get("store").val.cartSetting.slide&&(_openChatWitget("cart"),$rootScope.$emit("cartslide",{event:"init"}),event.preventDefault()),"stuffs"==to.name||"stuffs.stuff"==to.name){var groups=global.get("sections").val,sec={type:"good"};loop1:for(var i=0;i<groups.length;i++){if(groups[i].url==toParams.groupUrl){sec=groups[i];break}if(groups[i].child&&groups[i].child.length)for(var j=0;j<groups[i].child.length;j++)if(groups[i].child[j].url==toParams.groupUrl){sec=groups[i].child[j];break loop1}}global.set("sectionType",sec.type),global.set("section",sec),"stuffs.stuff"==fromState.name||global.get("tempContent").val||$rootScope.$emit("$stateChangeStartToStuff")}"likes"==to.name&&global.set("sectionType","good"),$rootScope.checkedMenu.slideMenu&&$rootScope.checkedMenuChange("slideMenu",!1),$rootScope.checkedMenu.m=!1,global.get("tempContent").val||("news.item"!=to.name&&"master.item"!=to.name&&"campaign.detail"!=to.name||$rootScope.$emit("$stateChangeStartToStuff"),"news"==to.name&&"news.item"!=fromState.name&&$rootScope.$emit("$stateChangeStartToStuff"),"master"==to.name&&"master.item"!=fromState.name&&$rootScope.$emit("$stateChangeStartToStuff"),"info"==to.name&&"info.item"!=fromState.name&&$rootScope.$emit("$stateChangeStartToStuff")),"news"==fromState.name&&"news.item"==to.name?scrollPositionNewsList=$(window).scrollTop():"news.item"!=fromState.name&&"news"!=to.name&&(scrollPositionNewsList=0)}});var scrollPositionNewsList=0;$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){"news.item"==from.name&&"news"==to.name&&scrollPositionNewsList&&$timeout(function(){window.scrollTo(0,scrollPositionNewsList)}),$rootScope.actualLocation=$location.url();var url=$location.url(),titles=angular.copy(global.get("store").val.seo);titles.image=global.get("store").val.logo,global.get("store").val.fbPhoto&&(titles.image=global.get("store").val.fbPhoto),titles.image&&(titles.image=photoHost+"/"+titles.image),titles.url=$location.url(),titles.desc=null,global.set("titles",titles),$location.search()&&1==Object.keys($location.search()).length&&$location.search().subDomain&&(url=url.substring(0,url.indexOf("?"))),url=url.replace("?_escaped_fragment_","");var seopage=global.get("seopages").val.getOFA("link",url);if(seopage)if(seopage.data)global.set("currentSeopage",seopage.data);else{var q=$q.when().then(function(){return Seopage.getItem(seopage._id)});global.set("currentSeopage",q)}else global.set("currentSeopage",null);window.dataLayer&&window.dataLayer.push&&window.dataLayer.push({event:"pageview",action:$location.path()}),$window.ga&&$window.ga("send","pageview",$location.path()),"undefined"!=typeof gtag&&setTimeout(function(){gtag("config",googleAnalytics,{page_title:global.get("titles").val.title,page_location:$location.url(),page_path:$location.path()})},300),$window.fbq&&fbq("track","PageView"),window.yaCounter&&"thanksPage"==to.name&&(window.yaCounter.reachGoal(toParams.id),window.yaCounter.hit($location.path())),"home"==to.name&&seoContent.setDataHomePage(),$rootScope.endLoadStuffs=!0}),$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){console.log(error)}),$rootScope.$on("$allDataLoaded",function(e,data){$rootScope.endLoadStuffs=!0}),$rootScope.$on("InitiateCheckout",function(){$window.fbq&&fbq("track","InitiateCheckout")}),$rootScope.$on("AddToCart",function(){$window.fbq&&fbq("track","AddToCart"),"undefined"!=typeof dataLayer&&setTimeout(function(){dataLayer.push({event:"AddToCart"})},300)}),$rootScope.$on("Purchase",function(event,data){$window.fbq&&fbq("track","Purchase",data)}),$rootScope.$on("CompleteRegistration",function(event,data){$window.fbq&&fbq("track","CompleteRegistration")});var ng_pageslide_body_closed,scrollbarWidth=0,padding_right=angular.element($document[0].body).css("padding-right").split("px"),padding_rightM=[],nav=angular.element($document.find(".navbar-fixed-top"));$timeout(function(){scrollbarWidth=window.innerWidth-$(document).width(),padding_right=padding_right&&padding_right[0]&&Number.isInteger(Number(padding_right[0]))?Number(padding_right[0]):0,nav.each(function(i,n){n&&(padding_rightM[i]=angular.element(n).css("padding-right").split("px"),padding_rightM[i]&&padding_rightM[i][0]&&Number.isInteger(Number(padding_rightM[i][0]))?padding_rightM[i]=Number(padding_rightM[i][0]):padding_rightM[i]=0)});try{if(document.styleSheets&&document.styleSheets.length)for(var i=0;i<document.styleSheets.length;i++)if(document.styleSheets[i].cssRules&&document.styleSheets[i].cssRules.length)for(var j=0;j<document.styleSheets[i].cssRules.length;j++)document.styleSheets[i].cssRules[j].selectorText&&document.styleSheets[i].cssRules[j].selectorText.indexOf("body.ng-pageslide-body-closed::before")>-1&&(ng_pageslide_body_closed=document.styleSheets[i].cssRules[j])}catch(err){}},500),$rootScope.$on("modalOpened",function(e,data){var height=$($document[0].body).height();nav&&nav.each&&nav.each(function(i,n){n&&$(n).css("padding-right",scrollbarWidth+padding_rightM[i])}),angular.element($document[0].body).css("overflow-y","hidden"),angular.element($document[0].body).css("padding-right",scrollbarWidth+padding_right),ng_pageslide_body_closed&&ng_pageslide_body_closed.style&&(ng_pageslide_body_closed.style.height=height+"px")}),$rootScope.$on("modalClosed",function(e,data){angular.element($document[0].body).css("overflow-y","auto"),angular.element($document[0].body).css("padding-right",padding_right),nav&&nav.each&&nav.each(function(i,n){n&&$(n).css("padding-right",padding_rightM[i])}),$timeout(function(){ng_pageslide_body_closed&&ng_pageslide_body_closed.style&&(ng_pageslide_body_closed.style.height="auto")},800)});var openMenuDelay;$rootScope.checkedMenuChange=function(field,val){openMenuDelay||(openMenuDelay=!0,console.log(field,val),val?($rootScope.$emit("modalOpened"),$rootScope.$broadcast("openMenu")):($rootScope.$emit("modalClosed"),$rootScope.$broadcast("closeMenu")),$rootScope.checkedMenu[field]=val,$timeout(function(){openMenuDelay=!1},500))},global.set("iPadVerticalWidth",770),global.set("iPadHorizontalWidth",1024);var clickForOpenChat;!function(dataFromServer){function _getActiveClassForGroupUrl(groupUrl){if($stateParams.groupUrl){var s=global.get("sections").val.getOFA("url",groupUrl);if(s&&s.child&&s.child.length)for(var i=0;i<s.child.length;i++)if(s.child[i].url===$stateParams.groupUrl)return!0}}function bookingFromSchedule(entry){console.log(entry);var hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10),entryDate=new Date(year,month,day,hour,minutes);return $q.when().then(function(){return global.get("user").val&&global.get("user").val._id?void 0:$user.loginOnlyPhone()}).then(function(){if(!global.get("user").val||!global.get("user").val._id)throw"not auth";if(entry.users||(entry.users=[]),entry.users.some(function(u){return u._id==global.get("user").val._id}))throw global.get("error").val.alreadyInDeal;var o={_id:global.get("user").val._id,name:global.get("user").val.name,phone:global.get("user").val.profile.phone,email:global.get("user").val.email};entry.users.push(o);var data={users:entry.users,_id:entry._id};return $http.post("/api/collections/Booking/"+entry._id+"?update=users",data)}).then(function(res){if($http.get("/api/newRecordOnSite/"+global.get("store").val._id+"/"+global.get("store").val.seller._id),console.log("global.get('store').val.submitDateTime",global.get("store").val.submitDateTime),global.get("store").val.seller.phone){var dataForSend={phone:global.get("store").val.seller.phone};return dataForSend.userId=global.get("user").val._id,dataForSend.text=global.get("langOrder").val.recordedOn+" "+entry.stuffName.toUpperCase()+" "+global.get("langOrder").val.onn+" "+entryDate,$http.post("/api/users/sendMessageAboutDeal",dataForSend)}}).then(function(res){try{entry.dateForNote=moment(entryDate).format("lll");var entryT=angular.copy(entry),content=CreateContent.dateTimeNote(entryT),o={addressee:"seller",type:"dateTime",content:content,seller:global.get("store").val.seller._id}}catch(err){console.log(err)}return $q(function(resolve,reject){$notification.save(o,function(res){exception.showToaster("note",global.get("langNote").val.sent,""),resolve()},function(err){exception.catcher("error")(err),resolve()})})}).then(function(res){var pap=global.get("paps").val.getOFA("action","booking");pap&&pap.url&&$state.go("thanksPage",{id:pap.url})}).catch(function(err){console.log(err),err&&exception.catcher("booking")(err)})}function _action(link,argsObj){delay||(delay=!0,$timeout(function(){delay=!1},1e3),link&&("subscription"==link?_witget("subscription"):"feedback"==link?_witget("feedback"):"call"==link?_witget("call"):"dateTime"==link?_witget("dateTime",argsObj):"subscriptionAdd"==link?_witget("subscriptionAdd"):"allBonus"==link?Stuff.getAllBonus():$location.path(link)))}function _orderStuffFromHP(url){$q.when().then(function(){return Stuff.getItem(url)}).then(function(stuff){1==stuff.orderType?stuff.order():2==stuff.orderType?($rootScope.$broadcast("dateTime",{stuff:stuff}),$rootScope.checkedMenu.entryTime||_openChatWitget("entryTime")):4==stuff.orderType?stuff.getBonus():$state.go("stuffs.stuff",{groupUrl:"group",categoryUrl:"category",stuffUrl:stuff.url})})}function _orderGroupStuffs(groupStuffs){return $order.clearCart(),groupStuffs.stuffs.forEach(function(stuff){stuff.quantity=1,stuff.cena=stuff.price,stuff.sum=stuff.cena*stuff.quantity,$order.addItemToCart(stuff)}),$q.when().then(function(){return global.get("user").val&&global.get("user").val._id?void 0:$user.login()}).then(function(){return $order.getShipInfo()}).then(function(){return $rootScope.$emit("$stateChangeStartToStuff"),$order.sendOrder()}).then(function(){$rootScope.$emit("Purchase",{value:$order.paySum,currency:$order.currency}),$rootScope.$emit("$stateChangeEndToStuff"),$order.reinitCart(),$rootScope.order=$order.getOrder(),$order.clearCart(),$rootScope.checkedMenu.cart=!1}).then(function(){return $user.saveProfile(global.get("user").val)}).catch(function(err){if($rootScope.$emit("$stateChangeEndToStuff"),err){if(console.log("errerrerr ",err),err.data)var content=JSON.stringify(err.data);else var content=JSON.stringify(err,["message","arguments","type","name"]);global.get("user").val&&(content+="\r"+global.get("user").val.email),$order.getOrder()&&(content+="\r"+JSON.stringify($order.getOrder(),null,4));var domain=global.get("store").val.domain,o={email:["igorchugurov@gmail.com","vikachugurova@gmail.com"],content:content,subject:"error in order ✔",from:global.get("store").val.name+"<"+global.get("store").val.subDomain+"@"+domain+">"};$q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){resolve()})}),err&&exception.catcher(global.get("langNote").val.error)(err)}})}function _orderStuffDirect(stuff,cabinet){$order.clearCart(),stuff.quantity=1,stuff.cena=stuff.price,stuff.sum=stuff.cena*stuff.quantity,$order.addItemToCart(stuff);var stuffInOrder;return $q.when().then(function(){return global.get("user").val&&global.get("user").val._id?void 0:(console.log(1),$user.login())}).then(function(){return stuffInOrder=$order.getOrder().cart.stuffs[0],$order.checkStuff(stuffInOrder,global.get("user").val._id)}).then(function(res){if(res&&res.data&&res.data.status)return Confirm("У вас уже есть неоплаченый "+stuffInOrder.name+".",'<div class="confirm-box">Оплатите заказ в <a class="confirm-link" href="/cabinet">кабинете.</a> <br>Хотите оформить еще один заказ?</div>')}).then(function(){}).then(function(){return $rootScope.$emit("$stateChangeStartToStuff"),console.log(2),$order.sendOrder(null,{status:2},cabinet)}).then(function(){console.log("???????????????"),$rootScope.$emit("Purchase",{value:$order.paySum,currency:$order.currency}),$rootScope.$emit("$stateChangeEndToStuff"),$order.reinitCart(),$rootScope.order=$order.getOrder(),$order.clearCart(),$rootScope.checkedMenu.cart=!1}).then(function(){return $user.saveProfile(global.get("user").val)}).catch(function(err){if($rootScope.$emit("$stateChangeEndToStuff"),err){if(console.log("errerrerr ",err),err.data)var content=JSON.stringify(err.data);else var content=JSON.stringify(err,["message","arguments","type","name"]);global.get("user").val&&(content+="\r"+global.get("user").val.email),$order.getOrder()&&(content+="\r"+JSON.stringify($order.getOrder(),null,4));var domain=global.get("store").val.domain,o={email:["igorchugurov@gmail.com","vikachugurova@gmail.com"],content:content,subject:"error in order ✔",from:global.get("store").val.name+"<"+global.get("store").val.subDomain+"@"+domain+">"};$q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){resolve()})}),err&&exception.catcher(global.get("langNote").val.error)(err)}})}function _changeCurrency(lan){global.get("config").val&&global.get("config").val.currency&&global.get("config").val.currency[lan]&&(global.set("currency",lan),global.set("rate",global.get("config").val.currency[lan][0]),$order.changeCurrency(lan)),$rootScope.checkedMenu.slideMenu&&$rootScope.checkedMenuChange("slideMenu",!1),$rootScope.$emit("changeCurrency")}function _searchStuff(searchStr){if(searchStr&&!(searchStr.length<3)){var o={searchStr:searchStr.substring(0,20)};$state.go("search",o,{reload:!0,inherit:!1,notify:!0})}}function _searchData(searchStr){if(searchStr&&!(searchStr.length<3)){var o={searchStr:searchStr.substring(0,20)};$state.go("search",o,{reload:!0,inherit:!1,notify:!0})}}function _searchStuffList(searchStr){if(!searchStr||searchStr.length<3)return void($rootScope.globalProperty.stuffSearchList=[{name:global.get("lang").val.enterChar}]);$rootScope.globalProperty.searchList||($rootScope.globalProperty.searchList=!0),$q.when().then(function(){return Stuff.search(searchStr)}).then(function(res){console.log(res),res.length?(res.forEach(function(s){!s.link&&s.category&&s.category[0]&&s.category[0].group&&(s.link="/"+s.category[0].group.url+"/"+s.category[0].url+"/"+s.url,Stuff.save({update:"link"},{_id:s._id,link:s.link}))}),$rootScope.globalProperty.stuffSearchList=res):$rootScope.globalProperty.stuffSearchList=[{name:global.get("lang").val.noResults}]}).catch(function(){$rootScope.globalProperty.stuffSearchList=[{name:global.get("lang").val.noResults}]})}function _searchLostFocus(){$timeout(function(){$rootScope.globalProperty.searchList=!1,$rootScope.globalProperty.stuffSearchList=[]},2e3)}function _zoomImg(i,images,home){home?Stuff.zoomImg(i,images,home):Stuff.zoomImg(i,images)}function _cloneStore(subDomain){$injector.get("cloneStore").clone(subDomain)}function _searchModal(){$uibModal.open({animation:!0,templateUrl:"views/template/modal/search.html",windowClass:"modalProject",controller:function($uibModalInstance,$rootScope,global){var self=this;self.item="",self.focus=!0,self.globalProperty=$rootScope.globalProperty,self.global=global,self.ok=function(){$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")},$rootScope.$on("closeSearchModal",function(){$uibModalInstance.dismiss()})},controllerAs:"$ctrl"}).result.then(function(item){_searchStuff(item)})}function _changeLocation(url){if("/manage"==url&&!global.get("store").val.cabinetFull&&!global.get("store").val.owner.some(function(o){return o==global.get("user").val._id}))return void $state.go("cabinet");$window.location.href=url}function _changeLang(lang){global.get("store").lang!=lang&&($location.search("lang",lang),_changeLocation($location.url()))}
function _enter(){$rootScope.checkedMenu.slideMenu&&$rootScope.checkedMenuChange("slideMenu",!1),$user.login()}function _logout(){$rootScope.$broadcast("logout"),$rootScope.checkedMenu.slideMenu&&$rootScope.checkedMenuChange("slideMenu",!1),$auth.logout(),$state.go("home"),global.set("user",null)}function _witget(type,argsObj){var data={type:type};return argsObj&&argsObj.stuff&&(data.stuff=argsObj.stuff),"subscription"==type?(data.name=store.texts.subscriptionName?store.texts.subscriptionName[store.lang]:"",data.desc=store.texts.subscriptionText?store.texts.subscriptionText[store.lang]:"",Witget.show(data)):"subscriptionAdd"==type?(data.name=store.texts.subscriptionAddName?store.texts.subscriptionAddName[store.lang]:"",data.desc=store.texts.subscriptionAddText?store.texts.subscriptionAddText[store.lang]:"",Witget.show(data)):"call"==type?(data.name=store.texts.callName?store.texts.callName[store.lang]:"",data.desc=store.texts.callText?store.texts.callText[store.lang]:"",Witget.show(data)):"feedback"==type?(data.name=store.texts.feedbackName?store.texts.feedbackName[store.lang]:"",data.desc=store.texts.feedbackText?store.texts.feedbackText[store.lang]:"",Witget.show(data)):"dateTime"==type?($timeout(function(){$rootScope.$broadcast("dateTime",argsObj)},500),void($rootScope.checkedMenu.entryTime||_openChatWitget("entryTime"))):void 0}function _closeChatWitget(field){$rootScope.checkedMenu[field]&&!clickForOpenChat&&$rootScope.checkedMenuChange(field,!1)}function _setRows(){var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),type=global.get("sectionType").val?global.get("sectionType").val:"good",r=global.get("store").val.template.stuffListType[type].rows?global.get("store").val.template.stuffListType[type].rows:4;return w>1350?r:w>global.get("iPadHorizontalWidth").val?r-1<2?2:r-1:w>global.get("iPadVerticalWidth").val?2:1}function _getSection(sectionUrl,id){var sections=global.get("sections").val;if(!sections)return null;for(var field=id?"_id":"url",i=0,l=sections.length;i<l;i++){if(sections[i][field]&&sections[i][field]==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length)for(var j=0,ll=sections[i].child.length;j<ll;j++)if(sections[i].child[j][field]&&sections[i].child[j][field]==sectionUrl)return sections[i].child[j]}return null}function _closeMenu(event){$rootScope.checkedMenu.slideMenu&&!clickForOpen&&$rootScope.checkedMenuChange("slideMenu",!1)}function _openSlideMenu(){if(!clickForOpen){clickForOpen=!0;var v=!$rootScope.checkedMenu.slideMenu;$rootScope.checkedMenuChange("slideMenu",v),setTimeout(function(){clickForOpen=!1},200)}}var store=dataFromServer[0],crawler=dataFromServer[1],local=dataFromServer[2],mobile=dataFromServer[3],tablet=dataFromServer[4],sections=dataFromServer[5],brands=brandsFromServer,filters=(dataFromServer[6],filtersFromServer),paps=dataFromServer[9],seopages=dataFromServer[10],coupons=dataFromServer[11],witget=dataFromServer[12],labels=dataFromServer[13],lang=dataFromServer[14],campaign=dataFromServer[15],masters=dataFromServer[16].filter(function(m){return m.actived}),widthAbs=$(document.body).width(),addChar="?";window.location.href.indexOf("?")>-1&&(addChar="&"),widthAbs<1200&&widthAbs>750&&!tablet?window.location.href=window.location.href+addChar+"tablet=true":widthAbs<=750&&!mobile&&(window.location.href=window.location.href+addChar+"mobile=true");var droch;if($(window).resize(function(){if(!droch)if(droch=!0,$timeout(function(){droch=!1},50),(widthAbs=$(document.body).width())>=1024&&(tablet||mobile)){var k=window.location.href.indexOf("tablet=true"),l=window.location.href.indexOf("mobile=true");k>-1?window.location.href=window.location.href.substring(0,k-1):l>-1?window.location.href=window.location.href.substring(0,l-1):window.location.reload(!0)}else if(widthAbs<1024&&widthAbs>750&&!tablet){var k=window.location.href.indexOf("mobile=true");if(k>-1)window.location.href=window.location.href.substring(0,k)+"tablet=true";else{var addChar="?";window.location.href.indexOf("?")>-1&&(addChar="&"),window.location.href=window.location.href+addChar+"tablet=true"}}else if(widthAbs<=750&&!mobile){var k=window.location.href.indexOf("tablet=true");if(k>-1)window.location.href=window.location.href.substring(0,k)+"mobile=true";else{var addChar="?";window.location.href.indexOf("?")>-1&&(addChar="&"),window.location.href=window.location.href+addChar+"mobile=true"}}}),labels&&labels.length&&global.set("labels",labels),brands.forEach(function(b){b.tags=b.tags.filter(function(t){return t.actived})}),sectionClass=new SectionClass(sections),dQ=new DesignQuery(brands,null,filters,sectionClass),moment.locale(store.lang),store.seller||(store.seller={}),(!store.seller.opt||store.seller.opt&&store.seller.opt.quantity<2)&&(store.seller.retail=null),global.set("country",{country_code:"UA"}),store.seo||(store.seo={}),store.seo.domain=store.domain?store.domain:store.subDomain,store.seo.name=store.name,global.set("store",store),global.set("seller",store.seller._id),global.set("titles",store.seo),global.set("config",{currency:store.currency}),global.set("currency",store.mainCurrency),store.mainCurrency||(store.mainCurrency="UAH"),global.set("rate",store.currency[store.mainCurrency][0]),masters&&masters.length&&masters.forEach(function(m){m.timeTable&&m.timeTable.length&&m.timeTable.forEach(function(p){p.is&&("false"==p.is?p.is=!1:"true"==p.is&&(p.is=!0))})}),global.set("masters",masters),masters&&masters.length&&global.set("mastersO",masters.reduce(function(o,m){return o[m._id]=m,o},{})),!crawler)if($auth.isAuthenticated())new Date((new Date).getTime()+36e5),Account.getProfile().then(function(response){global.set("user",response.data),_logged(),global.get("user").val&&coupons&&coupons[0]&&!coupons[0].hide&&(global.get("user").val.coupons.indexOf(coupons[0]._id)<0?Witget.show(coupons[0],!0):coupons[1]&&!coupons[1].hide&&global.get("user").val.coupons.indexOf(coupons[1]._id)<0&&Witget.show(coupons[1],!0));for(var i=0,l=witget.length;i<l;i++)"call"!=witget[i].type&&Witget.show(witget[i],!0)}).catch(function(response){response&&response.data&&exception.catcher(response.status)(response.data.message)});else for(var i=0,l=witget.length;i<l;i++)"call"!=witget[i].type&&Witget.show(witget[i],!0);global.set("crawler",crawler),global.set("local",local),global.set("mobile",mobile),global.set("tablet",tablet),global.set("lang",lang),$rootScope.slideMenuSpeed=global.get("store").val.template.menu2&&(global.get("store").val.template.menu2.slideMenuSpeed||"0"==global.get("store").val.template.menu2.slideMenuSpeed)?global.get("store").val.template.menu2.slideMenuSpeed:"0.3",mobile?($rootScope.slideMenuWidth=global.get("store").val.template.menu2.slideMenuWidth?global.get("store").val.template.menu2.slideMenuWidth:"90%",$rootScope.checkedMenu.sizeEntryTime="100%",$rootScope.checkedMenu.sizeCartSlide="100%"):tablet?($rootScope.slideMenuWidth=global.get("store").val.template.menu2.slideMenuWidth?global.get("store").val.template.menu2.slideMenuWidth:"60%",$rootScope.checkedMenu.sizeEntryTime="80%",$rootScope.checkedMenu.sizeCartSlide="80%"):($rootScope.slideMenuWidth=global.get("store").val.template.menu2.slideMenuWidth,$rootScope.checkedMenu.sizeEntryTime="40%",$rootScope.checkedMenu.sizeCartSlide="50%"),global.set("sections",sections);var categories=[];sections.forEach(function(section){section.type||(section.type="good"),section.categories&&section.categories.length&&(section.categories.forEach(function(c){c.section={url:section.url,name:section.name},c.linkData={groupUrl:section.url,categoryUrl:c.url,searchStr:null,brand:null,brandTag:null,queryTag:null}}),categories.push.apply(categories,section.categories)),section.child&&section.child.length&&section.child.forEach(function(subSection){subSection.type=section.type,subSection.categories&&subSection.categories.length&&(subSection.categories.forEach(function(c){c.section={url:section.url,name:section.name,subSectionName:subSection.name,subSectionUrl:subSection.url},c.linkData={groupUrl:subSection.url,categoryUrl:c.url,searchStr:null,brand:null,brandTag:null,queryTag:null}}),categories.push.apply(categories,subSection.categories))})}),global.set("categories",categories);var categoriesO={};categories.forEach(function(c){categoriesO[c._id]=c}),global.set("categoriesO",categoriesO),global.set("brands",brands),global.set("filters",filters);var filtersO={};filters.forEach(function(f){filtersO[f._id]=f}),global.set("filtersO",filtersO);var brandsO={};brands.forEach(function(b){brandsO[b._id]=b}),global.set("brandsO",brandsO),global.set("paps",paps),global.set("coupons",coupons),global.set("seopages",seopages),global.set("campaign",campaign),$order.init("cart"),$rootScope.order=$order.getOrder(),$rootScope.likes={totalCount:0};var likes=localStorage.get(store.subDomain+"-likes");likes&&likes.length&&($rootScope.likes.totalCount=likes.length);var listener1=$rootScope.$watch(function(){return $rootScope.checkedMenu.chatMenu},function(n){n&&($rootScope.globalProperty.chatMenuFist=!0,listener1())}),listener2=$rootScope.$watch(function(){return $rootScope.checkedMenu.entryTime},function(n){n&&($rootScope.globalProperty.entryTimeFist=!0,listener2())});global.set("models",{Campaign:Campaign}),global.set("cache",{});var delay,functions={changeCurrency:_changeCurrency,searchStuff:_searchStuff,searchStuffList:_searchStuffList,searchLostFocus:_searchLostFocus,searchData:_searchData,searchModal:_searchModal,changeLocation:_changeLocation,changeLang:_changeLang,enter:_enter,logout:_logout,logged:_logged,witget:_witget,closeMenu:_closeMenu,openSlideMenu:_openSlideMenu,closeChatWitget:_closeChatWitget,openChatWitget:_openChatWitget,setRows:_setRows,getSection:_getSection,orderStuffFromHP:_orderStuffFromHP,action:_action,zoomImg:_zoomImg,cloneStore:_cloneStore,orderGroupStuffs:_orderGroupStuffs,bookingFromSchedule:bookingFromSchedule,orderStuffDirect:_orderStuffDirect,getActiveClassForGroupUrl:_getActiveClassForGroupUrl};global.set("functions",functions);var clickForOpen;$timeout(function(){$stateParams.action&&(_witget($stateParams.action),$location.search("action",null))},1e3),$rootScope.contentLoaded=!0}(ngInitData);var langError,langOrder,langForm,langNote;if(global.get("store").val.langError?global.set("langError",global.get("store").val.langError):globalSrv.getData("langError").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langError=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langError",d)}),global.get("store").val.langNote?global.set("langNote",global.get("store").val.langNote):globalSrv.getData("langNote").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langNote=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langNote",d)}),global.get("store").val.langOrder?global.set("langOrder",global.get("store").val.langOrder):globalSrv.getData("langOrder").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langOrder=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langOrder",d)}),global.get("store").val.langForm?global.set("langForm",global.get("store").val.langForm):globalSrv.getData("langForm").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langForm=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langForm",d)}),global.get("store").val.ipstack){var urlForgetIp="http://api.ipstack.com/check?access_key="+global.get("store").val.ipstack;$.get(urlForgetIp).then(function(result){var currencyForCountry={};for(var key in global.get("store").val.currency)$rootScope.detectCurrency=!1,global.get("store").val.currency[key]&&global.get("store").val.currency[key][3]&&global.get("store").val.currency[key][3].forEach&&($rootScope.detectCurrency=!0,global.get("store").val.currency[key][3].forEach(function(country){currencyForCountry[country]=global.get("store").val.currency[key][1]})),$rootScope.detectCurrency&&(currencyForCountry[result.country_code]?global.get("functions").val.changeCurrency(currencyForCountry[result.country_code]):currencyForCountry.ALLOTHER?global.get("functions").val.changeCurrency(currencyForCountry.ALLOTHER):$rootScope.detectCurrency=!1)},function(err){console.log(err)})}}]).config(["$stateProvider","$urlRouterProvider","$locationProvider","globalProvider","$authProvider","$httpProvider","$animateProvider",function($stateProvider,$urlRouterProvider,$locationProvider,globalProvider,$authProvider,$httpProvider,$animateProvider){$animateProvider.classNameFilter(/^((?!(repeat-modify)).)*$/),$httpProvider.interceptors.push("myInterceptorService"),facebookAppID&&$authProvider.facebook({clientId:facebookAppID}),googleAppID&&$authProvider.google({clientId:googleAppID}),vkAppID&&$authProvider.oauth2({name:"vkontakte",url:"/auth/vkontakte",redirectUri:window.location.origin||window.location.protocol+"//"+window.location.host,clientId:vkAppID,authorizationEndpoint:"http://oauth.vk.com/authorize",scope:"friends, photos, email, photo_big",display:"popup",responseType:"code",requiredUrlParams:["response_type","client_id","redirect_uri","display","scope","v"],scopeDelimiter:",",v:"5.37"}),globalProvider.setUrl({campaign:'/api/collections/Campaign?query={"actived":"true","dateEnd":{"$gte":'+Date.now()+"}}",masters:'/api/collections/Master?query={"actived":true}',langError:'/api/collections/Lang?query={"name":"index.error"}',langNote:'/api/collections/Lang?query={"name":"index.note"}',langOrder:'/api/collections/Lang?query={"name":"index.order"}',langForm:'/api/collections/Lang?query={"name":"index.form"}',keywords:"/api/collections/Keywords",filters:"/api/collections/Filter"}),globalProvider.set("store"),globalProvider.set("seller"),globalProvider.set("titles"),globalProvider.set("config"),globalProvider.set("currency"),globalProvider.set("rate"),globalProvider.set("country"),globalProvider.set("crawler"),globalProvider.set("user"),globalProvider.set("local"),globalProvider.set("mobile"),globalProvider.set("tablet"),globalProvider.set("sections","penging"),globalProvider.set("section"),globalProvider.set("categories","penging"),globalProvider.set("categoriesO"),globalProvider.set("category"),globalProvider.set("brands","penging"),globalProvider.set("brandsO"),globalProvider.set("filters","penging"),globalProvider.set("filtersO"),globalProvider.set("filterTags","penging"),globalProvider.set("filterTagsO"),globalProvider.set("parentSection"),globalProvider.set("breadcrumbs"),globalProvider.set("stats"),globalProvider.set("paps"),globalProvider.set("homePage"),globalProvider.set("newTag"),globalProvider.set("coupon"),globalProvider.set("campaign"),globalProvider.set("seopages"),globalProvider.set("currentSeopage"),globalProvider.set("info"),globalProvider.set("labels"),globalProvider.set("lang"),globalProvider.set("models"),globalProvider.set("functions"),globalProvider.set("masters"),globalProvider.set("mastersO"),globalProvider.set("iPadVerticalWidth"),globalProvider.set("iPadHorizontalWidth"),globalProvider.set("sectionType"),globalProvider.set("tempContent"),globalProvider.set("cache"),globalProvider.set("langError"),globalProvider.set("langNote"),globalProvider.set("langOrder"),globalProvider.set("langForm"),globalProvider.set("services"),globalProvider.set("stuffsInList"),globalProvider.set("campaignStuffCart"),globalProvider.set("workplaces"),$locationProvider.html5Mode(!0),$locationProvider.hashPrefix("!"),$urlRouterProvider.when("/home","/").otherwise("/404"),$stateProvider.state("404",{url:"/404",templateUrl:"views/template/partials/404.html",controller:"404Ctrl"}).state("home",{url:"/?token&action",controller:"homeCtrl"}).state("cart",{url:"/cart",template:"<cart-item></cart-item>"}).state("likes",{url:"/likes",template:"<stuff-list-template-campaign-list></stuff-list-template-campaign-list>"}).state("cabinet",{url:"/cabinet?sec",template:"<cabinet-item></cabinet-item>"}).state("search",{url:"/search?searchStr",template:"<search-list></search-list>"}).state("pricegoods",{url:"/pricegoods",template:"<price-goods></price-goods>"}).state("priceservices",{url:"/priceservices",template:"<price-services></price-services>"}).state("unsubscription",{url:"/unsubscribe-done",templateUrl:"views/template/partials/unsubscription.html",controller:"unsubscriptionCtrl"}).state("thanksPage",{url:"/thanks/:id",template:"<paps-item-template></paps-item-template>"}).state("lookbook",{url:"/lookbook?labels",template:"<items-list></items-list>"}).state("stat",{url:"/stat?labels",template:"<items-list></items-list>"}).state("stat.item",{url:"/:id",template:"<items-detail></items-detail>"}).state("additional",{url:"/additional?labels",template:"<items-list></items-list>"}).state("additional.item",{url:"/:id",template:"<items-detail></items-detail>"}).state("news",{url:"/news?labels",template:"<items-list></items-list>"}).state("news.item",{url:"/:id",template:"<items-detail></items-detail>"}).state("master",{url:"/master?labels",template:"<items-list></items-list>"}).state("master.item",{url:"/:id",template:"<items-detail></items-detail>"}).state("workplace",{url:"/workplace?labels",template:"<items-list></items-list>"}).state("workplace.item",{url:"/:id",template:"<items-detail></items-detail>"}).state("info",{url:"/info?labels",template:"<items-list></items-list>"}).state("info.item",{url:"/:id?block",reloadOnSearch:!1,template:"<items-detail></items-detail>"}).state("campaign",{url:"/campaign?labels",template:"<items-list></items-list>"}).state("campaign.detail",{url:"/:id",template:"<items-detail></items-detail>"}).state("stuffs",{templateUrl:function(){return"views/template/partials/stuffs/stuffsNew.html"},url:"/:groupUrl/:categoryUrl?searchStr&queryTag&brand&brandTag&filterTag",reloadOnSearch:!0}).state("stuffs.stuff",{url:"/:stuffUrl?param1&param2&store&sort",templateUrl:"views/template/partials/stuffs/stuffDetail.html"})}]).config(function($provide){function getExpressions(str){for(var left,right,offset=0,parts=[];(left=str.indexOf("{{",offset))>-1&&(right=str.indexOf("}}",offset))>-1;)parts.push(str.substr(left+2,right-left-2)),offset=right+1;return parts}$provide.decorator("ngSrcDirective",function($delegate,$parse){var ngSrc=$delegate[0];return ngSrc.compile=function(element,attrs){var expressions=getExpressions(attrs.ngSrc),getters=expressions.map($parse);return function(scope,element,attr){attr.$observe("ngSrc",function(value){getters.every(function(getter){return getter(scope)})?value&&value.indexOf("images/")>-1&&value.indexOf("http")<0&&photoHost?attr.$set("src",photoHost+"/"+value):attr.$set("src",value):value&&(value.indexOf("images/")>-1&&value.indexOf("http")<0&&photoHost?attr.$set("src",photoHost+"/"+value):attr.$set("src",value))})}},delete ngSrc.link,$delegate})});var tempTitles,templateContentHTML;angular.module("gmall.directives",[]).directive("spy",function(){function link(scope,element,attrs){$("#menu1-section").height(),$("#menu2-section").height();$(function(){"affix"===attrs.spy&&$(element).affix({offset:{top:0,bottom:function(){return this.bottom=$(".footer").outerHeight(!0)}}})})}return{restrict:"A",link:link}}).directive("imageLoadWatcher",function($rootScope,$timeout){return{restrict:"A",link:function(scope,element,attrs){void 0===$rootScope.loadCounter&&($rootScope.loadCounter=0),$timeout(function(){element.find("img").bind("load",function(){scope.$emit("$imageLoaded",$rootScope.loadCounter++)})},10)},controller:function($scope){console.log($scope.$last),$scope.$parent.$on("$imageLoaded",function(event,data){$scope.$last&&$scope.$index===$rootScope.loadCounter-1&&($scope.$emit("$allImagesLoaded"),delete $rootScope.loadCounter)})}}}).directive("imageLoadWatcherHomePage",function($rootScope,$timeout){return{restrict:"AC",link:function(scope,element,attrs){var loadCounter=0,imagesQty=0;void 0===$rootScope.loadCounter&&($rootScope.loadCounter=0),$timeout(function(){var images=element.find("img");imagesQty=images.length;var send;images.each(function(img){this.complete?imagesQty--:$(this).bind("load",function(){++loadCounter==imagesQty&&(send=!0,$rootScope.$broadcast("$allImagesLoadedInHomePage"),$rootScope.$emit("$allImagesLoadedInHomePage"))})}),imagesQty||send||($rootScope.$broadcast("$allImagesLoadedInHomePage"),$rootScope.$emit("$allImagesLoadedInHomePage"))})}}}).directive("owlCarousel",function(global,$timeout){return{restrict:"A",link:function(scope,element,attrs){console.log("$allImagesLoaded"),scope.$on("$allImagesLoaded",function(){$(element).owlCarousel({items:2,itemsDesktop:[1e3,2],itemsDesktopSmall:[900,1],itemsTablet:[600,1],itemsMobile:!1}),setTimeout(function(){$("#owl-carousel-next").click(function(){$(element).trigger("owl.prev")}),$("#owl-carousel-prev").click(function(){$(element).trigger("owl.prev")})},500)})}}}).directive("owlCarouselWithAttr",function(global,$timeout){return{restrict:"A",scope:{},link:function(scope,element,attrs){var items=attrs.items?attrs.items:1,items3=3,items2=2;2==items?items3=2:1==items&&(items3=1,items2=1);var loop=!!attrs.loop&&attrs.loop,nav=!!attrs.nav&&attrs.nav,autoplay=!!attrs.autoplay&&attrs.autoplay;if(attrs.duration&&Number(attrs.duration)&&attrs.duration>1&&attrs.duration<10)var autoplaytimeout=1e3*Number(attrs.duration);else var autoplaytimeout=3e3;setTimeout(function(){$(element).owlCarousel({items:items,itemsDesktop:[1e3,items],itemsDesktopSmall:[900,items],itemsTablet:[600,1],itemsMobile:!1,responsive:{0:{items:1,nav:!1,dots:!0},380:{items:items2,nav:!1,dots:!0},1068:{items:items3,nav:!1,dots:!0},1400:{items:items,nav:!1,dots:!0}},loop:loop,nav:nav,autoplay:autoplay,autoplayTimeout:autoplaytimeout,dots:!0}),element.find(".owl-dots").click(function(){console.log("stop"),$timeout(function(){$(element).trigger("stop.owl.autoplay");var carousel=$(element).data("owl.carousel");carousel.settings.autoplay=!1,carousel.options.autoplay=!1,$(".owl-carousel").trigger("refresh.owl.carousel")},900)}),element.find("#owl-carousel-next").click(function(){console.log("next"),$(element).trigger("owl.prev"),$(element).trigger("stop.owl.autoplay")}),element.find("#owl-carousel-prev").click(function(){console.log("next"),$(element).trigger("owl.prev"),$(element).trigger("stop.owl.autoplay")}),$(element).on("mouseenter",function(e){$(element).trigger("stop.owl.autoplay")}),$(element).on("mouseleave",function(e){$(element).trigger("play.owl.autoplay")})},500)}}}).directive("arrowDown",["global",function(global){return{template:"<a class='nav-down animate-style' ng-click='scrollUp()'><span class='icon-down-img'></span></a>",link:function(scope,element){function scrollFoo(){var arrowDown=$("#arrowDownDiv"),scrolled=window.pageYOffset||document.documentElement.scrollTop;if(scrolled>0&&visible)visible=!1,$(element).hide();else if(scrolled<=0&&!visible&&(visible=!0,arrowDown&&arrowDown.offset())){var offset=arrowDown.offset().top+arrowDown.height();offset>$(window).height()-10&&$(element).show()}}var m1=global.get("store").val.template.menu1,m2=global.get("store").val.template.menu2,visible=!1;$(element).hide(),scope.scrollUp=function(){var arrowDown=$("#arrowDownDiv"),menu1Section1=$("#menu1-section"),menu1Section2=$("#menu2-section"),delta=0;m1&&m1.is&&m1.fixed&&"top"==m1.position&&!m1.scrollSlide&&(delta+=menu1Section1.height()),m2&&m2.is&&m2.fixed&&"top"==m1.position&&(delta+=menu1Section2.height());var target=arrowDown.offset().top+arrowDown.height()-delta;$("html, body").animate({scrollTop:target},1e3)},$(window).scroll(scrollFoo),setTimeout(scrollFoo,1e3)}}}]).directive("removeClassByScroll",[function(){return{restrict:"EA",scope:{className:"@removeClassByScroll"},link:function(scope,element){function scrollHandler(){console.log("scroll"),done?$(window).off("scroll",scrollHandler):(element.removeClass(scope.className),done=!0)}$(window).scroll(scrollHandler);var done=!1}}}]).directive("playVideoByHover",[function(){return{restrict:"A",scope:{},link:function(scope,element){function handlerIn(){$(element).get(0).play()}function handlerOut(){$(element).get(0).pause()}$(element).mouseenter(handlerIn).mouseleave(handlerOut)}}}]).directive("addRemoveClassByScroll",["$rootScope",function($rootScope){return{restrict:"A",scope:{className:"@addRemoveClassByScroll"},link:function(scope,element){function scrollHandler(event){try{var st=$(this).scrollTop();st>lastScrollTop?!hasClass&&$(element).isOnScreen()&&(element.addClass(scope.className),hasClass=!0):hasClass&&$(element).isOnScreen()&&(element.removeClass(scope.className),hasClass=!1),lastScrollTop=st}catch(err){console.log(err)}}var hasClass=!1,lastScrollTop=0;$rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){"home"==to.name?$(window).scroll(scrollHandler):$(window).off("scroll",scrollHandler)})}}}]).directive("addRemoveClassByFirstMenu",["$rootScope",function($rootScope){return{restrict:"A",scope:{className:"@addRemoveClassByFirstMenu"},link:function(scope,element){console.log("addRemoveClassByFirstMenu",scope.className),$rootScope.$on("hideMenu1AfterScroll",function(event,to,toParams,fromState,fromParams){element.addClass(scope.className)}),$rootScope.$on("showMenu1AfterScroll",function(event,to,toParams,fromState,fromParams){element.removeClass(scope.className)})}}}]).directive("addClassByScroll",[function(){return{restrict:"EA",scope:{className:"@addClassByScroll"},link:function(scope,element){function scrollHandler(){done?$(window).off("scroll",scrollHandler):(element.addClass(scope.className),done=!0)}$(window).scroll(scrollHandler);var done=!1}}}]).directive("addClassByScrollForBlock",[function(){return{restrict:"EA",scope:{className:"@addClassByScrollForBlock"},link:function(scope,element){function scrollHandler(){!done&&$(element).isOnScreen()&&(element.addClass(scope.className),done=!0,$(window).off("scroll",scrollHandler))}$(window).scroll(scrollHandler);var done=!1}}}]).directive("bgVideo",function($rootScope,$timeout,global,$compile){return{restrict:"A",link:function(scope,element,attrs){new BackgroundVideo(".bv-video",{src:[attrs.bgVideo]})}}}).directive("homePageTwoRowsContainer",function($rootScope,$timeout,global,$compile){return{restrict:"E",link:function(scope,element){function initBlock(){if((window.innerWidth>0?window.innerWidth:screen.width)<992)return void $(d).remove();h1=$(row1).height(),h2=$(row2).height();var w=$(row2).width()+30,diff=Math.abs(h1-h2);diff>100?($(d).addClass("catalog-block"),$(d).append(hc)):$(d).addClass("catalog-block-mini"),$(d).height(diff),$(d).width(w),h1>h2?$(row2).append(d):$(row1).append(d),$(d).wrap("<div></div>")}function init_scroll(event,delta){deltaOfInterest=delta;var timeNow=(new Date).getTime();if(timeNow-lastAnimation<quietPeriod+animationTime)return void event.preventDefault();for(var i=0;i<arr.length;i++){if($("#"+arr[i]).offset().top-$(window).scrollTop()>=0){iii=i;break}}var delta=0;if(m1&&m1.is&&m1.fixed&&"top"==m1.position&&!m1.scrollSlide&&(delta+=menu1Section1.height()),m2&&m2.is&&m2.fixed&&"top"==m1.position&&(delta+=menu1Section2.height()),deltaOfInterest<0){if(iii<arr.length-1&&iii++,iii==arr.length-1)try{delta=-$("#"+arr[iii]).height()}catch(err){console.log(err)}$("html, body").animate({scrollTop:$("#"+arr[iii]).offset().top-delta},700)}else iii>0&&iii--,$("html, body").animate({scrollTop:$("#"+arr[iii]).offset().top-delta},700);lastAnimation=timeNow}scope.$ctrl={},scope.$ctrl.global=global;var h1,h2,resize,m1=global.get("store").val.template.menu1,m2=global.get("store").val.template.menu2,menu1Section1=$("#menu1-section"),menu1Section2=$("#menu2-section"),row1=element[0].firstChild,row2=element[0].lastChild,s=["<div></div>"].join(""),d=angular.element(s),sec=global.get("sections").val[0].url,katalog=global.get("lang").val.catalog,h=angular.element('<div class="inner"><h1><a href="/'+sec+'/category">'+katalog+"</a></h1></div>"),linkFn=$compile(h),hc=linkFn(scope);$rootScope.homePageTwoRowsContainer?$timeout(function(){initBlock()},100):scope.$on("$allImagesLoadedInHomePage",function(){$timeout(function(){initBlock(),$rootScope.homePageTwoRowsContainer=!0},300)}),$(window).resize(function(){resize||(resize=!0,$timeout(function(){resize=!1},50),$(d).remove(),$timeout(function(){initBlock()}))}),scope.initActiveClass=function(i){console.log(i),scope.activeClass=new Array(i)},scope.setActiveClass=function(idx){console.log(scope.activeClass);for(var i=0;i<scope.activeClass.length;i++)scope.activeClass[i]=i===idx||null};var deltaOfInterest,lastAnimation=0,quietPeriod=400,animationTime=500,arr=[],iii=0;$(document).ready(function(){function hoverVideo(e){$("video",this).get(0).play()}function hideVideo(e){$("video",this).get(0).pause()}if(global.get("store").val.scrollblock){$(document).bind("mousewheel DOMMouseScroll MozMousePixelScroll",function(event){if("home"===$rootScope.$state.current.name){event.preventDefault();init_scroll(event,event.originalEvent.wheelDelta||-event.originalEvent.detail)}});$(".verticalSlider").children().each(function(i,d){if($(d).hasClass("clearfix"))$(d).remove();else if(!$(d).attr("dontScrollBlock")){var id=$(d).attr("class");arr.push(id),$(d).attr("id",id)}})}$(".videoStuff").each(function(i,v){$(v).hover(hoverVideo,hideVideo)})})}}}).directive("freewall",function($timeout,global){return{restrict:"C",link:function(scope,element){if(!global.get("crawler").val){$timeout(function(){wall.container.find(".brick").find("img").load(function(){wall.fitWidth()})},200);var wall=new Freewall("#freewall");wall.reset({selector:".brick",animate:!0,cellW:200,cellH:"auto",onResize:function(){wall.fitWidth()}})}}}}).directive("stuffCartMinHeight",function($timeout,global){return{restrict:"AC",link:function(scope,element){onsole.log("link stuffCartMinHeight"),global.get("crawler").val||$timeout(function(){var el=$(".stuff-list-wrapper #td-inner0");if(el){var h=$(el).height();element.height(h)}},1550)}}}).directive("mosaicflowItem",function($timeout){return{restrict:"C",link:function(scope,element){$timeout(function(){$(element)},2e3)}}}).directive("appVersion",function(version){return function(scope,elm,attrs){elm.text(version)}}).directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){element.on("keydown",function(){return ngModel.$setValidity("mongoose",!0)})}}}).directive("autoFillableField",function(){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){setInterval(function(){var prev_val="";angular.isUndefined(attrs.xAutoFillPrevVal)||(prev_val=attrs.xAutoFillPrevVal),element.val()!=prev_val&&(angular.isUndefined(ngModel)?(element.trigger("input"),element.trigger("change"),element.trigger("keyup"),attrs.xAutoFillPrevVal=element.val()):""==element.val()&&ngModel.$pristine||(attrs.xAutoFillPrevVal=element.val(),scope.$apply(function(){ngModel.$setViewValue(element.val())})))},300)}}}).directive("hideSpinner",function(){return{restrict:"A",scope:{hideSpinner:"="},link:function(scope,elem,attrs){scope.$watch("hideSpinner",function(n,o){n&&$(elem).hide()})}}}).directive("orderFromFilter",function(){function filterCtrl($attrs,exception,$q,Stuff){function increaseQty(){self.stuff&&self.stuff.quantity<1e3&&self.stuff.quantity++,self.stuff.amazonAddToCartLink="https://www.amazon.com/gp/aws/cart/add.html?ASIN.1="+self.stuff.asin+"&Quantity.1="+self.stuff.quantity}function decreaseQty(){self.stuff&&self.stuff.quantity>1&&self.stuff.quantity--}function getStuff(){$q.when().then(function(){return Stuff.query({query:query}).$promise}).then(function(res){res&&res.length&&(res.shift(),self.stuff=res[0],console.log(self.stuff),self.stuff.quantity=1,
self.stuff.amazonAddToCartLink="https://www.amazon.com/gp/aws/cart/add.html?ASIN.1="+self.stuff.asin+"&Quantity.1="+self.stuff.quantity,!self.stuff.img&&self.stuff.gallery&&self.stuff.gallery[0]&&(self.stuff.img=self.stuff.gallery[0].img))})}function setActiveClass(fId,tId){query={$and:[]};for(var k in self.filters)if(k===fId)for(var k2 in self.filters[k].tagsO)k2===tId?(self.filters[k].tagsO[k2].activeClass=!0,query.$and.push({tags:k2})):self.filters[k].tagsO[k2].activeClass=!1;else for(var k2 in self.filters[k].tagsO)self.filters[k].tagsO[k2].activeClass&&query.$and.push({tags:k2});getStuff()}function order(){console.log("order");for(var k in self.filters)if(console.log(self.filters[k].tags.some(function(t){return t.activeClass})),!self.filters[k].tags.some(function(t){return t.activeClass}))return console.log(self.filters[k].name),void exception.showToaster("info","order","select the "+self.filters[k].name)}var self=this,filters=JSON.parse($attrs.orderFromFilter),query={$and:[]};self.filters=filters.reduce(function(fs,item){var i=0;return item.tagsO=item.tags.reduce(function(ts,it){return i++,1===i&&(query.$and.push({tags:it._id}),it.activeClass=!0),ts[it._id]=it,ts},{}),fs[item._id]=item,fs},{}),getStuff(),self.setActiveClass=setActiveClass,self.decreaseQty=decreaseQty,self.increaseQty=increaseQty,self.order=order}return{restrict:"A",scope:{},transclude:!0,bindToController:!0,controller:filterCtrl,controllerAs:"$ctrl",link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}).directive("toTop",[function(){return{restrict:"C",scope:{go:"&"},link:function(scope,element,iAttrs){var scrolled=window.pageYOffset||document.documentElement.scrollTop;scrolled>200?element.addClass("toTopDispalay"):element.addClass("toTopDispalayNone"),window.onscroll=function(){scrolled=window.pageYOffset||document.documentElement.scrollTop,scrolled>200?(element.addClass("toTopDispalay"),element.removeClass("toTopDispalayNone")):(element.removeClass("toTopDispalay"),element.addClass("toTopDispalayNone"))}}}}]).directive("pswdCheck",["$timeout",function($timeout){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword="#"+attrs.pswdCheck;$timeout(function(){elem.on("keyup",function(){scope.$apply(function(){var v=elem.val()===$(firstPassword).val();ctrl.$setValidity("pswdmatch",v)})})},100)}}}]).directive("profileData",["global","User",function(global,User){return{restrict:"E",scope:{confirmFunction:"&",bottomName:"@"},templateUrl:"mobile/views/template/profile.html",link:function(scope,elem,attrs){console.log("link"),scope.profileSave=function(formProfile){scope.submittedProfile=!0,formProfile.$valid&&(scope.errors={},User.update(global.get("user").val,function(res){"OK"&&(scope.submittedProfile=!1,scope.confirmFunction())}))}}}}]).directive("sliderToggle",function($timeout,$rootScope){return{scope:{sliderToggle:"="},restrict:"AE",link:function(scope,element,attrs){var target=element.parent()[0].querySelector("[slider]");attrs.expanded=!1,$rootScope.$on("$includeContentLoaded",function(event){$timeout(function(){scope.$watch("sliderToggle",function(n){var content=target.querySelector(".slideable_content");if(n)target.style.height="0px";else{content.style.border="1px solid rgba(0,0,0,0)";var y=content.clientHeight;content.style.border=0,target.style.height=y+"px"}})},10)}),element.bind("click",function(){if(!scope.sliderToggle){var content=target.querySelector(".slideable_content");if(attrs.expanded)target.style.height="0px";else{var y=content.clientHeight;console.log(),content.style.border=0,target.style.height=y+"px"}attrs.expanded=!attrs.expanded}})}}}).directive("slider",function(){return{restrict:"A",compile:function(element,attr){var contents=element.html();return element.html('<div class="slideable_content" style="margin:0 !important; padding:0 !important" >'+contents+"</div>"),function(scope,element,attrs){element.parent()[0].querySelector(".slideable_content");attrs.duration=attrs.duration?attrs.duration:"1s",attrs.easing=attrs.easing?attrs.easing:"ease-in-out",element.css({height:"0px",transitionProperty:"height",transitionDuration:attrs.duration,transitionTimingFunction:attrs.easing})}}}}).directive("slideToggle11",function($timeout){return{restrict:"A",scope:{slideToggle:"="},link:function(scope,elem,attrs){var querySelector="aaa"+guidGenerator();elem.addClass(querySelector);var div;$timeout(function(){div=document.querySelector("."+querySelector),console.log(div)},50),scope.slideToggle||elem.hide(),scope.$watch("slideToggle",function(n,o){console.log(n,o),n!=o&&toggleSlide(div)})}}}).directive("inline",function(){return{template:'<span ><span ng-show="!edit" ng-class="{\'redColor\':!value}">{{value||empty}}</span><span ng-show="!edit" ng-transclude></span><input ng-show="edit" style="width:{{width}}" class="input-inline" type="{{type}}" ng-model="value"/></span>',restrict:"C",scope:{value:"=",empty:"@",type:"@",width:"@"},transclude:!0,link:function(scope,element,attribs){scope.type||(scope.type="text"),scope.width||(scope.width="80%"),scope.$watch("inline",function(val){scope.value=val});var enablingEditing=function(){scope.edit=!0,setTimeout(function(){element.children().children("input")[2].focus(),element.children().children("input").bind("blur",function(e){scope.$apply(function(){disablingEditing()})})},100)},disablingEditing=function(){scope.edit=!1,scope.inline=scope.value};disablingEditing(),element.bind("click",function(e){"span"!==e.target.nodeName.toLowerCase()&&"img"!==e.target.nodeName.toLowerCase()||scope.$apply(function(){enablingEditing()})}),element.bind("keypress",function(e){if("input"==e.target.nodeName.toLowerCase()){13===(window.event?e.keyCode:e.which)&&scope.$apply(function(){disablingEditing()})}})}}}).directive("inlineTextarea",function(){return{template:'<span ><span ng-show="!edit" ng-class="{\'redColor\':!value}">{{value||empty}}</span><span ng-show="!edit" ng-transclude></span><textarea ng-show="edit" style="width:{{width}}" class="textarea-inline" rows="{{rows}}" cols1="{{cols}}" ng-model="value"></textarea></span>',restrict:"C",scope:{value:"=",empty:"@",rows:"@",cols:"@"},transclude:!0,link:function(scope,element,attribs){scope.rows||(scope.rows=5),scope.$watch("inline",function(val){scope.value=val});var enablingEditing=function(){scope.edit=!0,setTimeout(function(){console.log(element.children().children("input")[2]),element.children().children("input")[2].focus(),element.children().children("input").bind("blur",function(e){scope.$apply(function(){disablingEditing()})})},100)},disablingEditing=function(){scope.edit=!1,scope.inline=scope.value};disablingEditing(),element.bind("click",function(e){"span"!==e.target.nodeName.toLowerCase()&&"img"!==e.target.nodeName.toLowerCase()||scope.$apply(function(){enablingEditing()})}),element.bind("keypress",function(e){if("input"==e.target.nodeName.toLowerCase()){13===(window.event?e.keyCode:e.which)&&scope.$apply(function(){disablingEditing()})}})}}}).directive("ngPageslideWrapper",function($document,$timeout,$rootScope){return{restrict:"A",link:function(scope,element,attribs){console.log(element);var wrappedID,wrappedClass;$timeout(function(){var queryResult=document.getElementsByTagName("body")[0];wrappedID=angular.element(queryResult);var queryResult1=document.getElementsByClassName("navbar-nav")[0];wrappedClass=angular.element(queryResult1)},200),$timeout(function(){element.bind("mouseenter",function(event){console.log("mouseenter"),wrappedID.css("overflow-y","hidden"),wrappedID.css("margin-right","20px"),wrappedClass.css("margin-right","20px")}),element.bind("mouseleave",function(event){console.log("mouseleave"),$rootScope.checkedMenu.m=!1,console.log($rootScope.checkedMenu),wrappedID.css("overflow-y","scroll"),wrappedID.css("margin-right","0"),wrappedClass.css("margin-right","0")})},300)}}}).directive("halfMenu",function($rootScope){return{link:function(scope,element,attrs){$&&setTimeout(function(){var height=$(element).height();$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){"home"==to.name||$(element).hasClass("hafhMenuHeight")?"home"==to.name&&$(element).hasClass("hafhMenuHeight")&&$(element).height(height):$(element).height(height/2)})},50)}}});var guidGenerator=function(){var S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return console.log(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()),S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},getHeight=function(el){console.log(el);var el_style=window.getComputedStyle(el),el_display=el_style.display,el_position=el_style.position,el_visibility=el_style.visibility,el_max_height=el_style.maxHeight.replace("px","").replace("%",""),wanted_height=0;return"none"!==el_display&&"0"!==el_max_height?el.offsetHeight:(el.style.position="absolute",el.style.visibility="hidden",el.style.display="block",wanted_height=el.offsetHeight,el.style.display=el_display,el.style.position=el_position,el.style.visibility=el_visibility,wanted_height)},toggleSlide=function(el){var el_max_height=0;el_max_height=getHeight(el)+"px",el.style.transition="max-height 0.5s ease-in-out",el.style.overflowY="hidden",el.style.maxHeight="0",el.setAttribute("data-max-height",el_max_height),el.style.display="block",setTimeout(function(){el.style.maxHeight=el_max_height},10)};angular.module("gmall.controllers",[]).controller("404Ctrl",["$scope","seoContent",function($scope,seoContent){seoContent.setData404()}]).controller("mainFrameCtrl",["$scope","global","$witgets","$http","anchorSmoothScroll","$state","$timeout","$sce","$order","toaster","$rootScope","User","$window",function($scope,global,$witgets,$http,anchorSmoothScroll,$state,$timeout,$sce,$order,toaster,$rootScope,User,$window){$scope.mainFrameCtrl=this,$scope.mainFrameCtrl.sizeMenu="350px",$scope.mainFrameCtrl.scrollTo=function(id,top){anchorSmoothScroll.scrollTo(id,top)}}]).controller("homeCtrl",["$scope","$q","$resource","global","seoContent","anchorSmoothScroll","$anchorScroll","News","exception","$auth","$stateParams","$location","Account","HomePage",function($scope,$q,$resource,global,seoContent,anchorSmoothScroll,$anchorScroll,News,exception,$auth,$stateParams,$location,Account,HomePage){$stateParams.token&&($auth.setToken({data:{token:$stateParams.token}}),$location.search("token",null),$auth.isAuthenticated()&&Account.getProfile().then(function(response){global.set("user",response.data),global.get("functions").val.logged()}).catch(function(response){response&&response.data&&exception.catcher(response.status)(response.data.message)})),$anchorScroll()}]).controller("unsubscriptionCtrl",["$scope","global","Account","$q","$state","exception","toaster",function($scope,global,Account,$q,$state,exception,toaster){}]),angular.module("gmall.filters",[]).filter("interpolate",function(version){return function(text){return String(text).replace(/\%VERSION\%/gm,version)}}).filter("trustUrl",["$sce",function($sce){return function(recordingUrl){return $sce.trustAsResourceUrl(recordingUrl)}}]).filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}}).filter("cut",function(){return function(value,wordwise,max,tail){if(!value)return"";if(!(max=parseInt(max,10)))return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");lastspace!=-1&&(value=value.substr(0,lastspace))}return value+(tail||"")}}).filter("filterSection",function(version){return function(input,sectionId){if(0==sectionId)return input;var temp=[];return angular.forEach(input,function(item){item.category==sectionId&&temp.push(item)}),temp}}).filter("filterSizeIs",function(){return function(items,tags){return items?items.filter(function(item){var is;return tags.length?tags.forEach(function(el){is=!el||!el.length||!el.some(function(tag){return!(!item.store[tag]||item.store[tag].quantity)})}):is=!0,is}):[]}}).filter("filterSorts",function(){return function(sorts){if(!sorts)return[];for(var key in sorts)sorts[key].quantity&&0!=sorts[key].quantity||delete sorts[key];return sorts}}),angular.module("gmall.services",[]).value("version","0.1").factory("$witgets",["$resource",function($resource){return{set:function(witgets){console.log(witgets),witgets.forEach(function(el){callWitget(el)})}}}]).service("anchorSmoothScroll",function(){this.scrollTo=function(eID,top){var startY=function(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}(),stopY=function(eID){var i=0;if(top){var e=$("#menu1-section");e.hasClass("navbar-fixed-top")&&(i=e.outerHeight())}var elm=document.getElementById(eID);if(!elm)return 0;for(var y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return top&&(y-=i),y}(eID),distance=stopY>startY?stopY-startY:startY-stopY;if(distance<100)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20),speed=7;var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(var i=startY;i<stopY;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(var i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,leapY<stopY&&(leapY=stopY),timer++}}),angular.module("lazyImg",[]).service("scrollAndResizeListener",function($window,$document,$timeout){function invokeListeners(){var clientHeight=$document[0].documentElement.clientHeight,clientWidth=$document[0].documentElement.clientWidth;for(var key in listeners)listeners.hasOwnProperty(key)&&listeners[key](clientHeight,clientWidth)}var scrollTimeoutId,resizeTimeoutId,id=0,listeners={};return $window.addEventListener("scroll",function(){$timeout.cancel(scrollTimeoutId),scrollTimeoutId=$timeout(invokeListeners,100)}),$window.addEventListener("resize",function(){$timeout.cancel(resizeTimeoutId),resizeTimeoutId=$timeout(invokeListeners,100)}),{bindListener:function(listener){var index=++id;return listeners[id]=listener,function(){delete listeners[index]}}}}),angular.module("lazyImg").directive("imageLazySrc",function($document,scrollAndResizeListener,$timeout){return{restrict:"A",link:function($scope,$element,$attributes){function isInView(clientHeight,clientWidth){if(targetElement&&targetElement[0]){var imageRect=targetElement[0].getBoundingClientRect();imageRect.top>=0&&imageRect.bottom<=clientHeight+800&&!$element[0].src&&(targetElement[0].src=$attributes.imageLazySrc,listenerRemover())}}var targetElement,listenerRemover=scrollAndResizeListener.bindListener(isInView);angular.element($element).ready(function(){$timeout(function(){targetElement=$("[image-lazy-src='"+$attributes.imageLazySrc+"']"),isInView($document[0].documentElement.clientHeight,$document[0].documentElement.clientWidth)},300)}),$element.on("$destroy",function(){listenerRemover()})}}}),function(){function userSign(){return{scope:{closeModal:"&",toaster:"@",social:"="},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/sign.html",restrict:"AE"}}function subscriptionAdd(){return{scope:{closeModal:"&",toaster:"@"},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/subscriptionAdd.html",restrict:"AE"}}function userSignShort(){return{scope:{toaster:"@",buttonName:"@"},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/sign-short.html",restrict:"AE"}}function userLogin(){return{scope:{closeModal:"&",modalClose:"&",toaster:"@",social:"=",successFoo:"&"},bindings:{toaster:"<",social:"=",successFoo:"&"},bindToController:!0,controller:loginCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/login.html",restrict:"AE"}}function userLoginPhone(){return{scope:{closeModal:"&",modalClose:"&",toaster:"@",social:"=",successFoo:"&"},bindings:{toaster:"<",social:"=",successFoo:"&"},bindToController:!0,controller:loginPhoneCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/loginPhone.html",restrict:"AE"}}function enterButton(){return{scope:{toaster:"@"},bindToController:!0,controller:enterButtonCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/enter-button.html",restrict:"AE"}}function signupCtrl($scope,$auth,toaster,$q,global,Account,$state,Stuff,CreateContent,$email,exception,$user,$http,$timeout,sendPhoneFactory){function checkUserEntry(phone){return $q.when().then(function(){return $user.getItem(phone,"profile.phone")}).then(function(res){return res?res:null})}function createUser(name,phone){var email=phone+"@gmall.io",user={email:email,name:name,profile:{phone:phone,fio:name}};return $auth.signup(user).then(function(response){if(console.log(response),response&&response.data&&response.data.token){if("update"==response.data.token)throw null;return $auth.setToken(response),Account.getProfile()}throw response}).then(function(response){console.log(response),response&&(global.set("user",response.data),global.get("functions").val.logged())}).catch(function(err){err&&exception.catcher("new client")(err)})}function sendCodeToPhone(phone){var o={phone:phone};self.sendCodeDisable=!0,$q.when().then(function(){if("381112223334"!=phone)return $http.post("/api/users/sendSMS",o)}).then(function(){exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)})}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.user.profile.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){$scope.$emit("closeWitget"),toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}function regitration(phone){$q.when().then(function(){return checkUserEntry(phone)}).then(function(res){return res&&res._id?(self.phoneExist=!0,sendCodeToPhone(),null):createUser(self.user.name,phone)}).catch(function(err){exception.catcher(global.get("lang").val.error)(err)})}function signup(form){if(console.log(form),form.$valid){if("phone"==self.typeOfReg&&self.user.profile.phone)return regitration(self.user.profile.phone);self.user.store=global.get("store").val._id,$auth.signup(self.user).then(function(response){if(response&&response.data&&response.data.token){if("update"==response.data.token)throw $scope.$emit("closeWitget"),toaster.info(response.data.message),null;$auth.setToken(response);var msg=global.get("langNote").val.subscriptionSuccess;return toaster.info(msg),Account.getProfile()}throw response}).then(function(response){if($scope.$emit("closeWitget"),response){if(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}),"cart"==$state.current.name||"stuffs.stuff"==$state.current.name)return;var states=$state.get();if(global.get("paps")&&global.get("paps").val&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","subscription");pap&&pap.url&&$state.go("thanksPage",{id:pap.url})}}}).then(function(){if("subscription"==self.user.type){if(global.get("coupons")&&global.get("coupons").val&&global.get("coupons").val.length)return[{imgs:global.get("coupons").val}]}else if("subscriptionAdd"==self.user.type){var p={page:0,rows:100},query={$and:[{orderType:4},{actived:!0}]};return Stuff.getList(p,query)}}).then(function(stuffs){if(stuffs&&stuffs.length){if(!self.user||!self.user.email)throw"нет email";var content=CreateContent.emailBonus(stuffs),bonus=global.get("langNote").val.getBonus,domain=global.get("store").val.domain,o={email:self.user.email,content:content,subject:bonus+" ✔",from:"<promo@"+domain+">"};return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note","",global.get("langNote").val.emailSent),resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).catch(function(err){err&&exception.catcher("signup")(err)})}}function authenticate(provider){$auth.authenticate(provider).then(function(response){$scope.$emit("closeWitget"),$auth.setToken(response);var msg=global.get("langNote").val.subscriptionSuccess;toaster.info(msg)}).then(function(){return Account.getProfile()}).then(function(response){console.log(response),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(error){self.toaster&&(error.error?toaster.error(error.error):error.data?toaster.error(error.data.message,error.status):toaster.error(error))})}var self=this;self.global=global,self.formData=global.get("store").val.bonusForm?global.get("store").val.bonusForm:{phone:!0,fields:[]},self.user={email:"",profile:{},addInfo:{},subscription:!0},self.buttonName||self.buttonName,self.block="email",console.log(global.get("store").val.typeOfReg),global.get("store").val.typeOfReg&&(global.get("store").val.typeOfReg.phone?(self.typeOfReg="phone",self.block="phone"):global.get("store").val.typeOfReg.email&&(self.typeOfReg="email")),self.signup=signup,self.authenticate=authenticate,self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,$scope.$watch(function(){return self.user.profile.phone},function(n,o){console.log(n,o),self.phoneExist=!1})}function loginCtrl($scope,$auth,toaster,$q,global,Account,exception,sendPhoneFactory,$timeout){function login(form){form.$valid||retrun,self.user.store=global.get("store").val._id,$auth.login(self.user).then(function(data){console.log(data),self.successFoo?self.successFoo():$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite)}).then(function(){return Account.getProfile()}).then(function(response){response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"})),$timeout(function(){$scope.$emit("closeWitget")},50)}).catch(function(err){global.set("user",null),self.toaster&&exception.catcher("login")(err)})}function authenticate(provider){$auth.authenticate(provider).then(function(response){$scope.$emit("closeWitget"),self.successFoo&&"function"==typeof self.successFoo?self.successFoo():$scope.$emit("closeWitget");var msg=global.get("langNote").val.authComplite;toaster.info(msg)}).then(function(){return Account.getProfile()}).then(function(response){response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(error){self.toaster&&(error.error?toaster.error(error.error):error.data?toaster.error(error.data.message,error.status):toaster.error(error))})}function sendCodeToPhone(){self.sendCodeDisable||(self.sendCodeDisable=!0,console.log(self.phone),self.phone&&$q.when().then(function(){return sendPhoneFactory.sendCodeToPhone(self.phone)}).then(function(){self.codeSent=!0,exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)}))}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){self.successFoo?self.successFoo():$scope.$emit("closeWitget"),$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}var self=this;self.$onInit=function(){},self.block="email",global.get("store").val.typeOfReg&&(global.get("store").val.typeOfReg.phone?(self.typeOfReg="phone",self.block="online"):global.get("store").val.typeOfReg.email&&(self.typeOfReg="email")),self.login=login,self.authenticate=authenticate,self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.global=global,self.phone=null,self.codeSent,self.sendCodeDisable,self.sendVerifyCodeDisable}function enterButtonCtrl(toaster,$q,Account,global,exception){function getEnterButton(form){form.$invalid||$q.when().then(function(){return self.blockButton=!0,setTimeout(function(){self.blockButton=!1},1e3),Account.getEnterButton(self.user)}).then(function(response){self.toaster&&toaster.info(response.data.message)}).catch(function(err){err&&exception.catcher(global.get("langNote").val.error)(err)})}var self=this;self.global=global,self.getEnterButton=getEnterButton}function loginPhoneCtrl($scope,$auth,toaster,$q,global,Account,exception,sendPhoneFactory,$timeout,$user){function sendCodeToPhone(form){form.$invalid||self.sendCodeDisable||(self.sendCodeDisable=!0,self.phone&&$q.when().then(function(){return sendPhoneFactory.checkPhone(self.phone)}).then(function(res){if(!res||!res._id)return $user.newUserByPhone(self.name,self.phone,self.confirmCondition)}).then(function(){if("381112223334"!==self.phone)return sendPhoneFactory.sendCodeToPhone(self.phone)}).then(function(){self.codeSent&&exception.showToaster("info","отправка SMS","код отправлен на номер "+self.phone),self.codeSent=!0,$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)}))}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){self.successFoo?self.successFoo():$scope.$emit("closeWitget"),$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}var self=this;self.$onInit=function(){$scope.$parent.$watch("codeSent",function(value){self.codeSent=value})},global.get("store").val.typeOfReg&&global.get("store").val.typeOfReg.oferta&&(self.oferta=!0),global.get("store").val.texts&&global.get("store").val.texts.oferta&&(self.ofertaText=global.get("store").val.texts.oferta[global.get("store").val.lang]),self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.global=global,self.phone=null,self.name="",self.codeSent,self.sendCodeDisable,self.sendVerifyCodeDisable}angular.module("gmall.directives").directive("userSign",userSign).directive("subscriptionAdd",subscriptionAdd).directive("userSignShort",userSignShort).directive("userLogin",userLogin).directive("userLoginPhone",userLoginPhone).directive("enterButton",enterButton),signupCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","$state","Stuff","CreateContent","$email","exception","$user","$http","$timeout","sendPhoneFactory"],loginCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","exception","sendPhoneFactory","$timeout"],loginPhoneCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","exception","sendPhoneFactory","$timeout","$user"]}(),function(){angular.module("gmall.directives").directive("pswdCheck",["$timeout",function($timeout){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword="#"+attrs.pswdCheck;$timeout(function(){elem.on("keyup",function(){scope.$apply(function(){var v=elem.val()===$(firstPassword).val();console.log(v),ctrl.$setValidity("pswdmatch",v)})})},100)}}}]).directive("passwordMatch",function(){return{require:"ngModel",scope:{otherModelValue:"=passwordMatch"},link:function(scope,element,attributes,ngModel){ngModel.$validators.compareTo=function(modelValue){return!("undefined"!==modelValue&&""!==modelValue&&modelValue||"undefined"!==scope.otherModelValue&&""!==scope.otherModelValue&&scope.otherModelValue)||modelValue===scope.otherModelValue},scope.$watch("otherModelValue",function(){ngModel.$validate()})}}}).directive("passwordStrength",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var indicator=element.children(),dots=Array.prototype.slice.call(indicator.children()),weakest=dots.slice(-1)[0],weak=dots.slice(-2),strong=dots.slice(-3),strongest=dots.slice(-4);element.after(indicator),element.bind("keyup",function(){var tmp,matches={positive:{},negative:{}},counts={positive:{},negative:{}},strength=0;angular.forEach(dots,function(el){el.style.backgroundColor="#ebeef1"}),ngModel.$viewValue&&(matches.positive.lower=ngModel.$viewValue.match(/[a-z]/g),matches.positive.upper=ngModel.$viewValue.match(/[A-Z]/g),matches.positive.numbers=ngModel.$viewValue.match(/\d/g),matches.positive.symbols=ngModel.$viewValue.match(/[$-\/:-?{-~!^_`\[\]]/g),matches.positive.middleNumber=ngModel.$viewValue.slice(1,-1).match(/\d/g),matches.positive.middleSymbol=ngModel.$viewValue.slice(1,-1).match(/[$-\/:-?{-~!^_`\[\]]/g),counts.positive.lower=matches.positive.lower?matches.positive.lower.length:0,counts.positive.upper=matches.positive.upper?matches.positive.upper.length:0,counts.positive.numbers=matches.positive.numbers?matches.positive.numbers.length:0,counts.positive.symbols=matches.positive.symbols?matches.positive.symbols.length:0,counts.positive.numChars=ngModel.$viewValue.length,tmp+=counts.positive.numChars>=8?1:0,counts.positive.requirements=tmp>=3?tmp:0,counts.positive.middleNumber=matches.positive.middleNumber?matches.positive.middleNumber.length:0,counts.positive.middleSymbol=matches.positive.middleSymbol?matches.positive.middleSymbol.length:0,matches.negative.consecLower=ngModel.$viewValue.match(/(?=([a-z]{2}))/g),matches.negative.consecUpper=ngModel.$viewValue.match(/(?=([A-Z]{2}))/g),matches.negative.consecNumbers=ngModel.$viewValue.match(/(?=(\d{2}))/g),matches.negative.onlyNumbers=ngModel.$viewValue.match(/^[0-9]*$/g),matches.negative.onlyLetters=ngModel.$viewValue.match(/^([a-z]|[A-Z])*$/g),counts.negative.consecLower=matches.negative.consecLower?matches.negative.consecLower.length:0,counts.negative.consecUpper=matches.negative.consecUpper?matches.negative.consecUpper.length:0,counts.negative.consecNumbers=matches.negative.consecNumbers?matches.negative.consecNumbers.length:0,strength+=4*counts.positive.numChars,counts.positive.upper&&(strength+=2*(counts.positive.numChars-counts.positive.upper)),
counts.positive.lower&&(strength+=2*(counts.positive.numChars-counts.positive.lower)),(counts.positive.upper||counts.positive.lower)&&(strength+=4*counts.positive.numbers),strength+=6*counts.positive.symbols,strength+=2*(counts.positive.middleSymbol+counts.positive.middleNumber),strength+=2*counts.positive.requirements,strength-=2*counts.negative.consecLower,strength-=2*counts.negative.consecUpper,strength-=2*counts.negative.consecNumbers,matches.negative.onlyNumbers&&(strength-=counts.positive.numChars),matches.negative.onlyLetters&&(strength-=counts.positive.numChars),strength=Math.max(0,Math.min(100,Math.round(strength))),strength>85?angular.forEach(strongest,function(el){el.style.backgroundColor="#008cdd"}):strength>65?angular.forEach(strong,function(el){el.style.backgroundColor="#6ead09"}):strength>30?angular.forEach(weak,function(el){el.style.backgroundColor="#e09115"}):weakest.style.backgroundColor="#e01414")})},template:'<span class="password-strength-indicator"><span></span><span></span><span></span><span></span></span>'}})}(),angular.module("gmall.services").factory("myInterceptorService",function($q,$rootScope,$templateCache){var keys=$templateCache.getKeys(),store=globalStoreId;try{globalCrawler&&globalCrawler}catch(err){}return{request:function(config){return keys.indexOf(config.url)>-1?config:(config.params=config.params||{},config.params.store||(config.params.store=store),$rootScope.global&&$rootScope.global.get("store")&&$rootScope.global.get("store").val&&$rootScope.global.get("store").val.lang&&(config.params.lang=$rootScope.global.get("store").val.lang),config)},response:function(response){return response.status,response}}}),angular.module("gmall").config(["$provide",function($provide){$provide.decorator("$templateCache",["$delegate",function($delegate){var keys=[],origPut=$delegate.put;return $delegate.put=function(key,value){origPut(key,value),keys.push(key)},$delegate.getKeys=function(){return keys},$delegate}])}]),angular.module("gmall.exception",[]).factory("exception",exception),exception.$inject=["toaster"],angular.module("gmall.services").factory("Confirm",confirmFactory),confirmFactory.$inject=["$q","$uibModal"],angular.module("gmall.services").factory("seoContent",["global","$stateParams","$resource","$state","$q","$sce",function(global,$stateParams,$resource,$state,$q,$sce){function setTitles(titles,res,noFooter){res.seo?(res.seo.title?titles.title=res.seo.title:titles.title=res.name,res.seo.description?titles.description=res.seo.description:titles.description=res.desc.replace(regex,"").substring(0,200),res.seo.keywords&&(titles.keywords=res.seo.keywords)):(titles.title=res.name,res.desc?titles.description=res.desc.replace(regex,"").substring(0,200):titles.description=""),noFooter||(res.desc?titles.pageDescFooter=res.desc.replace(regex,""):titles.pageDescFooter="",titles.namePageFooter=res.name)}function getSeoPageInfo(titles){if(!global.get("seopage")||!global.get("seopage").val||!global.get("seopage").val.length)return!1;titles.pageDescFooter||(titles.pageDescFooter=""),titles.namePageFooter||(titles.namePageFooter="");for(var i=0,l=global.get("seopage").val.length;i<l;i++){var a=global.get("seopage").val[i];console.log(a.url);var href=titles.canonical?titles.canonical:$location.path();if("http://"+global.get("store").val.domain+a.url==href)return a._id}return!1}function setSeopageData(){return $q.when().then(function(){return global.get("currentSeopage")?global.get("currentSeopage").val:null}).then(function(seopage){if(seopage)var sp=global.get("seopages").val.getOFA("link",seopage.link);if(sp&&!sp.data&&(seopage.seo||(seopage.seo={}),seopage.seo.keywords=seopage.keywords.map(function(w){return w.word}).filter(function(w){return w}).join(","),sp.data=seopage),seopage){var titlesTemp=global.get("titles").val,titles=seopage.seo;return titlesTemp&&titlesTemp.image&&!titles.image&&(titles.image=titlesTemp.image),titles.title=seopage.title||titles.title,titles.domain=global.get("store").val.link,titles.author=titles.author||global.get("store").val.name,titles.canonical=$sce.trustAsResourceUrl(global.get("store").val.link+seopage.link),seopage.desc&&(titles.desc=seopage.desc),global.set("titles",titles),!0}})}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}var regex=/<\/?[^>]+(>|$)/g;return{setSeopageData:setSeopageData,setDataCatalog:function(){setSeopageData().then(function(seopageIs){if("stuffs.stuff"!=$state.current.name&&!seopageIs){var s=global.get("store").val,titles={};if(global.get("category")&&global.get("category").val){var c=global.get("category").val;global.get("langForm").val&&(titles.title=c.section.name+" "+c.name+" "+global.get("lang").val.inn+" "+s.name+".",titles.description=capitalizeFirstLetter(global.get("langForm").val.toorder)+" "+global.get("lang").val.onLine+" "+c.section.name+" "+c.name+" "+global.get("lang").val.inn+" "+s.name+","+s.location),titles.keywords=s.name+","+c.name+","+c.section.name+","+s.location,c.section.subSectionName&&(titles.keywords+=","+c.section.subSectionName),titles.canonical=$sce.trustAsResourceUrl(global.get("store").val.link+"/"+c.linkData.groupUrl+"/"+c.linkData.categoryUrl)}else if($stateParams.groupUrl&&"group"!=$stateParams.groupUrl){var sectionUrl=$stateParams.groupUrl,sec=global.get("functions").val.getSection(sectionUrl);if(sec){global.get("langForm").val&&(titles.title=capitalizeFirstLetter(global.get("langForm").val.toorder)+" "+sec.name+" "+global.get("lang").val.inn+" "+s.name+" "+global.get("lang").val.onLine+".");var categories="";sec.categories.length&&sec.categories.forEach(function(c,i){i&&(categories+=","),categories+=c.name}),titles.keywords=s.name+","+sec.name+","+s.location+","+categories,global.get("langForm").val&&(titles.description=capitalizeFirstLetter(global.get("langForm").val.toorder)+" "+global.get("lang").val.onLine+" "+sec.name+categories+" "+global.get("lang").val.inn+" "+s.name+" "+s.name+","+s.location),titles.canonical=global.get("store").val.link+"/"+sec.url+"/category"}else console.log("???"),titles.canonical="",titles.title="Заказать из каталога "+s.name+" онлайн.",titles.keywords=s.name+",каталог,"+s.location,titles.description="Заказ онлайн из каталога в "+s.name+","+s.location;titles.canonical=$sce.trustAsResourceUrl(titles.canonical)}else titles.title="Заказать из каталога "+s.name+" онлайн.",titles.keywords=s.name+",каталог,"+s.location,titles.description="Заказ онлайн из каталога в "+s.name+","+s.location,titles.canonical=global.get("store").val.link+"/group/category",titles.canonical=$sce.trustAsResourceUrl(titles.canonical);titles.domain=s.link,titles.author=s.name,global.set("titles",titles)}})},setDataHomePage:function(){setSeopageData()},setDataItem:function(item,news){var domain=global.get("store").val.link,titles=angular.copy(global.get("store").val.seo);if(titles||(titles={}),news){var img=item.img?item.img:"";titles.url=domain+"/news/"+item.url,titles.type="article"}else{var img=item.gallery&&item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:"";titles.url=domain+"/"+item.link,titles.type="product"}img&&(img=photoHost+"/"+img),titles.image=img;try{titles.canonical=$sce.trustAsResourceUrl(titles.url)}catch(err){console.log(err)}return titles.title=item.name,news||(item.artikul&&(titles.title+=" "+item.artikul),titles.title=item.categoryName+" "+titles.title),global.set("titles",titles),!0},setDataList:function(type,name){setSeopageData().then(function(seopageIs){if(console.log("seopageIs",seopageIs),!seopageIs){var domain=global.get("store").val.link,titles=angular.copy(global.get("store").val.seo);titles||(titles={}),titles.url=domain+"/"+type,titles.type="";try{titles.canonical=$sce.trustAsResourceUrl(titles.url)}catch(err){console.log(err)}return global.set("titles",titles),!0}})},setData404:function(res){var seoPageId,titles={pageTitle:"",pageDescription:"",pageKeyWords:""},titles=angular.copy(global.get("store").val.seo);titles.canonical=$sce.trustAsResourceUrl("http://"+global.get("store").val.domain+"/404"),titles.url=titles.canonical,(seoPageId=getSeoPageInfo(titles))?$resource("/api/collections/Seopage/:id",{id:"@_id"}).get({id:seoPageId},function(res){setTitles(titles,res,!0),global.set("titles",titles)}):global.set("titles",titles)}}}]),angular.module("gmall.services").factory("CreateContent",["global","$timeout",function(global,$timeout){function getHeader(user){var s='<table width="600px" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 20px 0 0 0" border="0"><tr width="100%" style="max-width:600px;min-width:240px;"><td width="50%" style=" padding:5px 20px"><a href="'+global.get("store").val.link+'">';return global.get("store").val.logo&&(s+='<img  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'" alt="logo '+global.get("store").val.name+'"></br>'),global.get("store").val.name&&(s+='<span  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.name+'"></span>'),s+="</a></td>",s+='<td width="50%"  style="text-align: right; padding:5px 20px">',global.get("store").val.seller.phone&&(s+="<p><span>"+global.get("langOrder").val.phone+'</span>: <a style="color:#666666" href="tel:+'+global.get("store").val.seller.phone+'"><span>+'+global.get("store").val.seller.phone+"</span></a></p>"),global.get("store").val.feedbackEmail&&(s+='<p><span>e-mail</span>: <a style="color:#666666" href="mailto:'+global.get("store").val.feedbackEmail+'"><span>'+global.get("store").val.feedbackEmail+"</span></a></p>"),s+="</td></tr></table>",global.get("sections")&&global.get("sections").val&&global.get("sections").val[0]&&(s+='<table width="600px" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;border-collapse:collapse; table-layout: fixed; padding: 0;margin: 0px 20px"><tr width="100%" style="max-width:600px;min-width:240px;"><td  width="50%" style="max-width:300px;min-width:150px;background-color: #333333;text-align: center; padding: 20px;border:1px solid #ffffff;"><a style="color: #ffffff; text-transform: uppercase" href="'+global.get("store").val.link+'/cabinet"><span>'+global.get("langOrder").val.mainCabinet+"</span></a></td>",s+='<td  width="50%" style="max-width:300px;min-width:150px; background-color: #333333;text-align: center; padding: 20px;border:1px solid #ffffff;"><a style="color: #ffffff; text-transform: uppercase" href="'+global.get("store").val.link+"/"+global.get("sections").val[0].url+'/category"><span>'+global.get("lang").val.catalog+"</span></a></td>",s+="</tr></table>"),s}function getFooter(){var s='<style>@media (max-width: 420px) {.name {font-size:12px !important; line-height: 14px!important;} .footer td {font-size: 12px!important; padding: 5px!important}}</style><table class="footer-letter"  width="100%" cellpadding="0" cellspacing="0" style="max-width:600px; min-width:240px; color: #000000; border-collapse:collapse; border:none;table-layout: fixed; padding: 0 20px; margin: 20px" border="0"><tr><td><table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px; min-width:240px;color: #000000;border-collapse:collapse; border:none;table-layout: fixed; " border="0"><tr style="vertical-align: top; background-color:#333333"><td  style=" padding: 10px 20px"><span style="font-family:Tahoma; font-size:12px; color:#e8e8e8;">';if(global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&global.get("store").val.template.index&&global.get("store").val.template.index.icons&&global.get("store").val.template.index.icons[key+"white"]&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 0 10px" src="'+global.get("store").val.link+global.get("store").val.template.index.icons[key+"white"].img+'"></a>');return s+='</span></td></tr></table></td></tr><tr><td><table width="50%" cellpadding="0" cellspacing="0"  style="max-width:300px; min-width:150px; color: #000000; border-collapse:collapse; border:none; table-layout: fixed; float: left;" border="0""><tr><td align="left" style="vertical-align: top; padding: 20px 20px 20px 0"><span style="font-size:14px; ">',global.get("store").val.texts.mailTextFooter&&global.get("store").val.texts.mailTextFooter[global.get("store").val.lang]&&(s+=global.get("store").val.texts.mailTextFooter[global.get("store").val.lang]),s+="</span></td></tr></table>",s+='<table width="50%" cellpadding="0" cellspacing="0"  style="max-width:300px; min-width:150px;color: #000000;border-collapse:collapse; border:none;table-layout: fixed; float: left;" border="0"><tr><td align="right" style="vertical-align: top; padding: 20px 0 20px 20px"><span style="font-size:14px;">',global.get("store").val.texts.mailTextFooter1&&global.get("store").val.texts.mailTextFooter1[global.get("store").val.lang]&&(s+=global.get("store").val.texts.mailTextFooter1[global.get("store").val.lang]),s+="</span></td></tr></table></td></tr></table>"}function empty(){return'<!DOCTYPE html><html><head><meta charset=utf-8/><style type="text/css">@media only screen and (max-device-width:660px){.table-mobile{display:none !important;}}</style></head><body onload="window.print()"><div style="max-width: 800px"><h1>информация  отсутствует</h1></div><body></html>'}function getLink(t,u){if(!t||!u)return null;var d=global.get("store").val.domain;switch(console.log("global.get('store').val.domain",global.get("store").val.domain),t){case"stuffs":return d+"/group/category/"+u;case"categories":return d+"/group/"+u;case"brandTags":return d+"/group/category?brandTag="+u;case"brands":return d+"/group/category?brand="+u;case"filterTags":return d+"/group/category?queryTag="+u;case"campaign":return d+"/camapign/"+u}}function emailFromNews(item){var s='<style>@media (max-width: 420px) {h2 {font-size: 20px}}</style><table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0 auto" border="0"><tr width="100%" style="max-width:600px;min-width:240px;"><td style="text-align: center; padding: 5px"><a href="'+global.get("store").val.link+'"><img  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'" alt="logo '+global.get("store").val.name+'"></a></td></tr><tr width="100%" style="max-width:600px;min-width:240px;"><td style="text-align: center; padding: 5px; font-size: 20px;"><h3>usernameforreplace</h3></td></tr><tr width="100%"><td><h2 style="font-weight: 500; letter-spacing: 2px; text-transform: uppercase; text-align: center; color: #333333; font-family:  Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.name+"</h2></td></tr>";if(s+="</table>",s+='<table class="table-mobile" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333; border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0 auto " border="0">',item.blocks&&item.blocks.length&&item.blocks.forEach(function(block){if(block.name&&(s+="text2"==block.type?'<tr width="100%" style="max-width:600px;min-width:240px;"><td style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+(block.name?block.name:"")+'</h3></td><td style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+(block.name1?block.name1:"")+"</h3></td></tr>":'<tr width="100%" style="max-width:600px;min-width:240px;"><td colspan="2" style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.name+"</h3></td></tr>"),block.img&&(s+='<tr width="100%" style="max-width:600px;min-width:240px;"><td  colspan="2" width="100%" style=" padding: 5px" >',block.link&&(s+='<a href="'+global.get("store").val.link+block.link+'" style="cursor: pointer;">'),s+='<img alt="'+(block.name?block.name:"")+'" style="width: 100%;margin-bottom: 10px; display: block" src="'+photoHostForFactory+"/"+block.img+'">',block.link&&(s+="</a>"),s+="</td></tr>"),block.desc&&(s+="text2"==block.type?'<tr width="100%" style="max-width:600px;min-width:240px;"><td style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+(block.desc?block.desc:"")+'</span></td><td style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+(block.desc1?block.desc1:"")+"</span></td></tr>":'<tr width="100%" style="max-width:600px;min-width:240px;"><td colspan="2" style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.desc+"</span></td></tr>"),block.imgs&&block.imgs.length)for(var i=0,l=block.imgs.length;i<l;i+=2){s+="<tr>";var link1;if(block.imgs[i].link?link1=block.imgs[i].link.indexOf("http")<0?global.get("store").val.link+block.imgs[i].link:block.imgs[i].link:block.imgs[i].url&&(link1=getLink(block.type,block.imgs[i].url)),s+='<td style="padding: 5px; text-align: center;vertical-align: top">',link1&&(s+='<a href="'+link1+'">'),s+='<img alt="'+(block.imgs[i].name?block.imgs[i].name:"")+'" style="width: 100%; display: block" src="'+photoHostForFactory+"/"+block.imgs[i].img+'">',block.imgs[i].name&&(s+='<span class="name" style="font-weight: 700; color: #666666; font: 14px Arial, line-height:20px; sans-serif;  -webkit-text-size-adjust:none;">'+block.imgs[i].name+"</span>"),link1&&(s+="</a>"),s+="</td>",block.imgs[i+1]){var link2;block.imgs[i+1].link?block.imgs[i].link.indexOf("http")<0?link2=global.get("store").val.link+block.imgs[i+1].link:block.imgs[i+1].link&&(link2=block.imgs[i+1].link):link1=getLink(block.type,block.imgs[i+1].url),s+='<td style="padding: 5px; text-align: center;vertical-align: top">',link2&&(s+='<a href="'+link2+'">'),s+='<img alt="'+(block.imgs[i+1].name?block.imgs[i+1].name:"")+'" style="width: 100%; display: block" src="'+photoHostForFactory+"/"+block.imgs[i+1].img+'">',block.imgs[i+1].name&&(s+='<span class="name" style="font-weight: 700; color: #666666; font: 14px Arial, line-height:20px; sans-serif; -webkit-text-size-adjust:none;">'+block.imgs[i+1].name+"</span>"),link2&&(s+="</a>"),s+="</td>"}else s+='<td style="padding: 5px; text-align: center;vertical-align: top"></td>';s+="</tr>"}}),s+="</table>",s+='<style>@media (max-width: 420px) {.name {font-size:12px !important; line-height: 14px!important;}.footer td {font-size: 12px!important; padding: 5px!important}}</style><table class="footer" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px; min-width:240px; color: #000000; border-collapse:collapse; border:none;table-layout: fixed; padding: 0 20px; margin: 20px auto" border="0"><tr><td><table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px; min-width:240px;color: #000000;border-collapse:collapse; border:none;table-layout: fixed; " border="0"><tr style="vertical-align: top; background-color:#333333"><td style="padding: 10px 20px;" align="center"><span style="font-family:Tahoma; font-size:12px; color:#e8e8e8;">',global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&global.get("store").val.template.index&&global.get("store").val.template.index.icons&&global.get("store").val.template.index.icons[key+"white"]&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 0 10px" src="'+global.get("store").val.link+global.get("store").val.template.index.icons[key+"white"].img+'"></a>');return s+='</span></td></tr></table></td></tr><tr><td><table width="50%" cellpadding="0" cellspacing="0"   style="max-width:300px; min-width:150px; color: #000000; border-collapse:collapse; border:none; table-layout: fixed; float: left;" border="0""><tr ><td align="left" style="vertical-align: top; padding: 20px 20px 20px 0"><span style="font-size:14px; ">',global.get("store").val.texts.mailTextFooter&&global.get("store").val.texts.mailTextFooter[global.get("store").val.lang]&&(s+=global.get("store").val.texts.mailTextFooter[global.get("store").val.lang]),s+="</span></td></tr></table>",s+='<table width="50%" cellpadding="0" cellspacing="0"  style="max-width:300px; min-width:150px;color: #000000;border-collapse:collapse; border:none;table-layout: fixed; float: left;" border="0"><tr><td align="right" style="vertical-align: top; padding:  20px 0px 20px 20px"><span style="font-size:14px;">',global.get("store").val.texts.mailTextFooter1&&global.get("store").val.texts.mailTextFooter1[global.get("store").val.lang]&&(s+=global.get("store").val.texts.mailTextFooter1[global.get("store").val.lang]),s+="</span></td></tr></table></td></tr></table>"}function emailBonus(stuffs){var item,s='<table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr width="100%" style="max-width:600px;min-width:240px;"><td style="text-align: center; padding: 5px"><img alt="посмотреть на сайте" style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></td></tr><tr width="100%"><td><h2 style="font-weight: 500; letter-spacing: 2px; text-transform: uppercase; text-align: center; color: #333333; font-family:  Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">бонусы</h2></td></tr>';if(s+="</table>",stuffs.forEach(function(stuff){if(item=stuff,item.imgs&&item.imgs.length){s+='<table class="table-mobile" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333; border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0">';for(var i=0,l=item.imgs.length;i<l;i++)item.imgs[i].name&&(s+='<tr width="100%" style="max-width:600px;min-width:240px;"><td style=" padding: 5px"><p style="color: #333333; font: 16px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.imgs[i].name+"</p></td></tr>"),s+='<tr><td style="padding: 5px;"><img alt="бонусный купон"  style="width: 100%; display: block"   src="'+photoHostForFactory+"/"+item.imgs[i].img+'"></td>',s+="</tr>",item.imgs[i].desc&&(s+='<tr width="100%" style="max-width:600px;min-width:240px;"><td style=" padding: 5px"><p style="color: #333333; font: 16px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.imgs[i].desc+"</p></td></tr>");s+="</table>"}}),s+='<table width="600px;" cellpadding="0" cellspacing="0" style="max-width600px;min-width:240px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr><td border="0" colspan="2" style="border:none; border-top:5px solid #cccccc ;"></td></tr><tr><td align="left" style="vertical-align: top"><span style="font-family:Tahoma; font-size:12px; color:#404040;">',global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 15px 5px" src="'+global.get("store").val.link+"/views/template/img/icon/sn_natur/"+key+'.png"></a>');return s+='</span><td align="right"><span style="font-family:Tahoma; font-size:16px; color:#404040;">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),'<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><div>'+(s+="</span></td></tr></table>")+"</div></html>"}function orderNote(order){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.order+" № "+order.num+"</h3> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),s+="<p>"+global.get("langOrder").val.sum+" "+order.paySum.toFixed(2)+" "+order.currency+"</p>"}function dateTimeNote(entry,user){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.dateTime+"</h3> "+global.get("langOrder").val.onn+" "+entry.dateForNote,s+="<p>"+global.get("store").val.texts.masterName[global.get("store").val.lang]+" - "+entry.masterName+"</p>",s+="<p>"+entry.service.name+"</p>",user&&(s+="<p>"+user.name+" "+user.phone+"</p>"),s}function dateTimeCancelNote(entry){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.dateTime+'<span style="color:red"> '+global.get("langOrder").val.removed+"</span></h3> "+global.get("langOrder").val.onn+" "+entry.dateForNote,s+="<p>"+global.get("store").val.texts.masterName[global.get("store").val.lang]+" - "+entry.masterName+"</p>",s+="<p>"+entry.service.name+"</p>",s+="<p>"+entry.user.name+"- "+entry.user.phone+"</p>"}function order(order,invoice,commentPrint){var lang=global.get("store").val.lang,texts=global.get("store").val.texts,user=order.profile&&order.profile.admin?order.profile.admin:order.profile.fio;user||(user=order.user.name);var orderMailText=texts.orderMailText&&texts.orderMailText[lang]?texts.orderMailText[lang]:"";order.profile&&order.profile.admin&&(orderMailText="");var name=global.get("langOrder").val.order+" № "+order.num+"<small> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</small>",status=global.get("langOrder").val.entered.toUpperCase();2==order.status?status=global.get("langOrder").val.accepted.toUpperCase():3==order.status?status=global.get("langOrder").val.statuspaid.toUpperCase():4==order.status?status=global.get("langOrder").val.statussent.toUpperCase():5==order.status&&(status=global.get("langOrder").val.statusdelivered.toUpperCase()),user=global.get("langOrder").val.hello+", "+user+"!";var s=getHeader(name);s+='<table width="600px" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr  width="100%"><td colspan="2" style="padding: 0 20px;"><h3 style="font-size: 24px">'+user+"</h3></td></tr>",1==order.status&&(s+='<tr  width="100%"><td colspan="2" style="padding: 0 20px"><p>'+orderMailText+"</p></td></tr>"),s+='<tr style="max-width:600px;min-width:240px;"><td width="50%" style="max-width:600px;min-width:240px;padding: 10px 20px;font-size: 16px;vertical-align: top"><h4 style="font-weight: bold">'+status+'</h4><h4 style="font-weight: bold">'+global.get("langOrder").val.order.toUpperCase()+" № "+order.num+'</h4><p style="margin-bottom: 30px">'+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</p>",commentPrint&&order.comment&&(s+='<div><h4 style="font-weight: bold">'+global.get("langOrder").val.comments+"</h4><p>"+order.comment+"</p></div>"),invoice&&order.payInfo&&(s+='<h4 style="font-weight: bold">'+global.get("langOrder").val.forpayment+"</h4>",s+="<p>"+order.payInfo+"</p>"),invoice&&order.checkOutLiqpayHtmlIs&&(s+="<p>"+order.checkOutLiqpayHtml+"</p>"),s+="</td>",s+='<td style=" padding: 10px 20px; font-size: 16px;vertical-align: top;">',s+='<h4 style="font-weight: bold">'+global.get("langOrder").val.customerdata+"</h4>",s+="<p> e-mail - "+order.user.email+"</p>",order.profile.fio&&(s+="<p> "+global.get("langOrder").val.name+"  - "+order.profile.fio+"</p>"),order.profile.phone&&(s+="<p> "+global.get("langOrder").val.phone+" - "+order.profile.phone+"</p>"),order.profile.city&&(s+="<p> "+global.get("langOrder").val.city+"  - "+order.profile.city+"</p></div>"),s+="</td></tr></table>",s+='<table style="margin: 20px" width="600px" cellspacing="0" cellpadding="5" border="1px">',s+='<thead><tr><th style="padding: 10px">#</th><th style="padding: 10px">'+global.get("langOrder").val.title+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.species+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.price+"</th>",s+='<th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.quantity+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.sum+"</th></tr></thead>",s+="<tbody>";for(var cart=order.cart.stuffs,j=0,lj=cart.length;j<lj;j++){var good=cart[j];s+='<tr><td style="padding: 10px">'+(j+1)+'</td><td style="padding: 10px"> '+good.name+" "+(good.artikul?good.artikul:"")+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(good.sortName?good.sortName:"")+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(order.kurs*good.cena).toFixed(2)+" "+order.currency+'</td><td class="text-center" style="padding: 10px; text-align: center">'+good.quantity+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(order.kurs*good.sum).toFixed(2)+" "+order.currency+"</td></tr>"}s+="</tbody>",s+='<tbody class="cart-item-total">',s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.sum+'</th><th class="text-center" style="padding: 10px; text-align: center">'+order.getTotalQuantity()+'</th><th style="padding: 10px; text-align: center" class="text-center">'+(order.kurs*(order.sum0?order.sum0:order.sum)).toFixed(2)+" "+order.currency+"</th></tr>",order.discount&&(s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.withdiscount+"</th>",s+=order.sum<order.sum0?'<th class="text-center"  style="padding: 10px; text-align: center">'+Math.round(100*(1-order.sum/order.sum0))+"%</th>":'<th class="text-center" style="padding: 10px; text-align: center"></th>',s+='<th class="text-center"  style="padding: 10px; text-align: center">'+(order.kurs*order.sum).toFixed(2)+" "+order.currency+"</th></tr>"),order.coupon&&order.coupon._id&&(s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.basedcoupon+'</th><th></th><th class="text-center"  style="padding: 10px; text-align: center">'+(order.kurs*order.getCouponSum()).toFixed(2)+" "+order.currency+"</th></tr>");order.getTotalDiscount();return order.shipCost&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.delivery+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.shipCost.toFixed(2)+" "+order.currency+"</th></tr>"),order.totalPay&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.paid+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.totalPay.toFixed(2)+" "+order.currency+"</th></tr>"),order.paySum!=order.getCouponSum()&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.totaltopay+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.paySum.toFixed(2)+" "+order.currency+"</th></tr>"),s+="</tbody></table></div></div></div>",'<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://gmall.io/bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+(s+=getFooter())+"</div></html>"}function orderShipInfo(order){var shipDetail=order.shipDetail,name=(global.get("store").val.lang,global.get("store").val.texts,global.get("langOrder").val.order+" № "+order.num+"<small> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</small>"),user=global.get("user").val.profile.fio||global.get("user").val.name,status=global.get("langOrder").val.entered.toUpperCase();2==order.status?status=global.get("langOrder").val.accepted.toUpperCase():3==order.status?status=global.get("langOrder").val.statuspaid.toUpperCase():4==order.status?status=global.get("langOrder").val.statussent.toUpperCase():5==order.status&&(status=global.get("langOrder").val.statusdelivered.toUpperCase()),
user=global.get("langOrder").val.hello+", "+user+"!";var s=getHeader(name);return s+='<table width="600px" cellpadding="0" cellspacing="0" style="max-width:600px;min-width:240px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr  width="100%"><td colspan="2" style="padding: 20px;"><h3 style="font-size: 24px">'+user+"</h3></td></tr></table>",s+='<table width="600px" cellpadding="0" cellspacing="0" style="max-width:600px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr style="max-width:600px;min-width:240px;"><td width="50%" style="max-width:600px;min-width:240px;padding: 10px 20px;font-size: 16px;vertical-align: top"><h4 style="font-weight: bold">'+global.get("langOrder").val.order.toUpperCase()+" № "+order.num+"</h4><p>"+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+'</p><h4 style="font-weight: bold;margin-bottom: 30px">'+status+'</h4><h4 style="font-weight: bold">'+global.get("langOrder").val.aboutdelivery+"</h4></td></tr></table>",shipDetail&&shipDetail.length?(s+='<table style="margin: 20px" width="860px" cellspacing="0" cellpadding="5" border="1px solid #000000">',s+='<thead><tr><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.title+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.where+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.waybill+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.date+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.sum+"</th>",shipDetail.forEach(function(ship){s+='<tr><td style="padding: 10px">',ship.stuffs.forEach(function(stuff){s+='<div style="width:80%;float:left">'+stuff.name+'</div><div style="float:left">'+stuff.qty+(stuff.unitOfMeasure?" "+stuff.unitOfMeasure:"")+'</div><div style="clear: both"></div><hr/>'}),s+=ship.qty,s+='</td><td style="padding: 10px; vertical-align: top">'+(ship.info||"")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+(ship.ttn||"")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+moment(ship.date).format("LLL")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+(ship.sum||0).toFixed(2)+"&nbsp;"+order.currency+"</td></tr>"}),s+="</table></br></br>"):s+="<h1>"+global.get("langOrder").val.infisnot+"</h1>",'<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://gmall.io/bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+(s+=getFooter())+"</div></html>"}function shipInfoNote(order){var s="";return s+="<h3>"+global.get("langOrder").val.order+" № "+order.num+"</h3><br/> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p>"+global.get("langOrder").val.totaltopay+" <strong>"+order.paySum.toFixed(2)+" </strong>"+order.currency+"</p>",s+="<p>"+global.get("langOrder").val.sentshipinfo+"</p>"}function shipInfo(order,ship){if(ship.ttn&&ship.info){var s="<h3>"+global.get("langOrder").val.aboutdelivery+" </h3>";return global.get("langOrder").val.onawarrant,order.num,global.get("langOrder").val.from,moment(order.date).format("lll"),s+="<strong>"+global.get("langOrder").val.waybill+" - "+ship.ttn||"</strong> "+global.get("langOrder").val.from+" "+moment(ship.date).format("LL")+"</p>",ship.info&&(s+="<p>"+ship.info.substring(0,250)+"</p>"),ship.sum&&(s+="<strong>"+ship.sum.toFixed(2)+" "+order.currency+"</strong>"),ship.stuffs&&ship.stuffs.length&&(s+="<strong>  "+ship.stuffs.length+" ед.</strong>"),s}}function payInfo(order,pay){if(pay.sum){var s="<h3>"+global.get("langOrder").val.makepayment+" </h3>";return s+="<p>"+global.get("langOrder").val.onawarrant+" №"+order.num+"<br> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</p>",s+="<p><strong>"+pay.sum.toFixed(2)+" "+order.currency+"</strong></p> "+moment(pay.date).format("LL"),pay.info&&(s+="<p>"+pay.info.substring(0,150)+"</p>"),s}}function acceptedInfo(order){var s="<h3>"+global.get("langOrder").val.byorders+" №"+order.num+"</h3>";return s+=" "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+".",order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p><strong>"+global.get("langOrder").val.accepted+" </strong></p>"}function invoiceInfo(order){var s="";return s+="<h3>"+global.get("langOrder").val.order+" № "+order.num+"</h3><br/> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p>"+global.get("langOrder").val.totaltopay+" <strong>"+order.paySum.toFixed(2)+" </strong>"+order.currency+"</p>",s+="<p>"+global.get("langOrder").val.sentthepost+"</p>"}function call(number,name){var s="";return s+="<h3>"+global.get("langOrder").val.requestacallback+"</h3>",s+="<p>"+number+(name?" "+name:"")+"</p>",s+="<p>"+moment().format("LLLL")+"</p>",console.log(s),s}if(void 0===photoHost)var photoHost;var photoHostForFactory;return $timeout(function(){photoHostForFactory=photoHost?photoHost:global.get("store").val.link},1e3),{empty:empty,order:order,orderNote:orderNote,dateTimeNote:dateTimeNote,shipInfo:shipInfo,payInfo:payInfo,invoiceInfo:invoiceInfo,acceptedInfo:acceptedInfo,orderShipInfo:orderShipInfo,call:call,emailFromNews:emailFromNews,emailBonus:emailBonus,shipInfoNote:shipInfoNote,dateTimeCancelNote:dateTimeCancelNote}}]),function(){function papsService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getPaps."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Paps/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get}}angular.module("gmall.services").service("Paps",papsService),papsService.$inject=["$resource","$uibModal","$q"]}(),angular.module("gmall.services").service("$fileUpload",["$http","$uibModal","$q",function($http,$uibModal,$q){this.uploadFileToUrl=function(file,uploadUrl,id,params,type){var fd=new FormData;if(fd.append("file",file),fd.append("id",id),params&&"object"==typeof params)for(var key in params)fd.append(key,params[key]);var preffix=photoUpload;switch(type){case"user":preffix=userHost}return $http.post(preffix+uploadUrl,fd,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})},this.showFile=function(block,field){return $uibModal.open({animation:!0,templateUrl:"components/loadImage/showImgInModal.html",controllerAs:"$ctrl",controller:function($uibModalInstance,block,field){function ok(item){$uibModalInstance.close()}function cancel(){$uibModalInstance.dismiss()}var self=this;self.item=block,console.log(self.item),self.ok=ok,self.cancel=cancel},resolve:{block:function(){return block},field:function(){return field}}}).result},this.fileUpload=function(uploadUrl,field,itemUrl,itemId,index){return $uibModal.open({animation:!0,templateUrl:function(){return field&&"video"==field||"video.link"==field||"video1.link"==field?"components/loadImage/loadVideoModal.html":"components/loadImage/loadImageModal.html"},controller:function(uploadUrl,field,itemUrl,itemId,index,$uibModalInstance,$scope,$timeout,exception){function handleImage(files){function closureI(picReader,file){picReader.addEventListener("load",function(event){var picFile=event.target;file.imgSrc=picFile.result;for(var is,j=0;j<self.files.length;j++)if(self.files[j].name==file.name){is=!0;break}is||$timeout(function(){self.files.push(file)},100)})}$scope.$apply(function(){files.length?self.hasFiles=!0:self.hasFiles=!1;for(var i=0;i<files.length;i++){var file=files[i],picReader=new FileReader;closureI(picReader,file),picReader.readAsDataURL(files[i])}})}function uploadFiles(){function handlePhoto(file){console.log(uploadUrl,self.fileDimension);var url=self.urlArr[0]+self.fileDimension,fd=new FormData;fd.append("file",file),itemUrl&&fd.append("url",itemUrl),field&&fd.append("nameImg",field),itemId&&fd.append("id",itemId),index&&fd.append("index",index);var preffix=photoUpload;return console.log(preffix+url+"?"+self.suffix),$http.post(preffix+url+"?"+self.suffix,fd,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}if(!self.isUploading){self.isUploading=!0;var acts=[];return self.files.forEach(function(file,i){"imgs"!=field&&"gallery"!=field&&i||i>20||acts.push(handlePhoto(file))}),$q.all(acts).then(function(res){$uibModalInstance.close(res)}).catch(function(err){exception.catcher("load file")(err),console.log(err)})}}var self=this;self.files=[],self.hasFiles=!1,self.urlArr=uploadUrl.split("?"),self.suffix=self.urlArr[1]?self.urlArr[1]:"",self.dimen=self.urlArr[0].split("/"),self.fileDimension="","video"!=field&&"video.link"==field&&"video1.link"==field&&(self.fileDimension=self.dimen[self.dimen.length-1].slice(10)),self.uploadFiles=uploadFiles;var $form,$input;$timeout(function(){($form=$("#uploadImgForm"),$input=$form.find("#inputFilesUpload"),$input.bind("change",changedHandler),$form.bind("reset",resetHandler),function(){var div=document.createElement("div");return("draggable"in div||"ondragstart"in div&&"ondrop"in div)&&"FormData"in window&&"FileReader"in window}())&&($form.addClass("has-advanced-upload"),$form.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}).on("dragover dragenter",function(){$form.addClass("is-dragover")}).on("dragleave dragend drop",function(){$form.removeClass("is-dragover")}).on("drop",function(e){handleImage(e.originalEvent.dataTransfer.files)}))},300);var changedHandler=function(event){window.File&&window.FileList&&window.FileReader?handleImage(event.target.files):console.log("Your browser does not support File API")},resetHandler=function(){$scope.$apply(function(){self.files.length=0,self.hasFiles=!1,self.isUploading=!1})};$scope.$watchCollection("files",function(){0===self.files.length&&$input&&$input.val(null)}),$scope.$on("$destroy",function(){$input.unbind("change",changedHandler),$form.unbind("reset",resetHandler)}),$scope.$watch("fileSrc",function(n,o){n&&n.indexOf("base64")<0&&(oldImg=n)}),$scope.$watch("myFile",function(n,o){$scope.noLoad=!n}),$scope.clickFile=function(){var id="#imagefile"+$scope.now;angular.element(id).trigger("click")},$scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0;var params={index:scope.index,nameImg:scope.nameImg};scope.itemUrl&&"undefined"!=scope.itemUrl&&(params.url=scope.itemUrl),scope.dimen[scope.dimen.length-1]=scope.dimen[scope.dimen.length-1].slice(0,10);var url=scope.dimen.join("/");url+=scope.$ctrl.fileDimension,$fileUpload.uploadFileToUrl(file,url,scope.itemId,params).then(function(res){scope.myFile=null,scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=null;var o={_id:scope.itemId};$timeout(function(){if("imgs"==scope.nameImg)scope.replaceIndex?(scope.gallery[scope.replaceIndex].img=res.data.imgs[0].img,oldImg&&(console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg]))):scope.gallery.push(res.data.imgs[0]),scope.nameImgForSave?o[scope.nameImgForSave]=scope.gallery:o[scope.nameImg]=scope.gallery;else if("gallery"==scope.nameImg)scope.gallery.push(res.data.gallery[0]),o[scope.nameImg]=scope.gallery;else{if(oldImg){var small=oldImg.split("/");small[small.length-1]=small[small.length-1].replace("img","small"),small=small.join("/"),console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg,small])}oldImg=res.data.img?res.data.img:res.data[scope.nameImg],scope.fileSrc=res.data.img?res.data.img:res.data[scope.nameImg],o[scope.nameImg]=res.data.img?res.data.img:res.data[scope.nameImg]}var field=scope.nameImgForSave?scope.nameImgForSave:scope.nameImg;res.data["small"+scope.nameImg]&&(field+=" small"+scope.nameImg,o["small"+scope.nameImg]=res.data["small"+scope.nameImg]),scope.Item.save({update:field},o)},10)}).catch(function(err){err&&exception.catcher("upload video")(err)})}},self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg",resolve:{uploadUrl:function(){return uploadUrl},field:function(){return field},itemUrl:function(){return itemUrl},itemId:function(){return itemId},index:function(){return index}}}).result}}]).factory("Photo",photoFactory),photoFactory.$inject=["$http"],function(){function menuSectionHorizontal(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenu,controllerAs:"$ctrl",templateUrl:"components/menu/menuSectionHorizontel.html"}}function menuSectionHorizontalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenu,controllerAs:"$ctrl"}}function menuBrandsHorizontalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuBrands,controllerAs:"$ctrl"}}function menuSectionVirtical(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuV,controllerAs:"$ctrl",templateUrl:"components/menu/menuSectionVertical.html"}}function menuSectionVirticalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuV,controllerAs:"$ctrl"}}function menuBrandsVirticalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuVBrands,controllerAs:"$ctrl"}}function dropdownOnHover(){return{scope:{},restrict:"AE",bindToController:!0,link:directiveDropdownOnHover,controllerAs:"$ctrl"}}function directiveMenu(Sections,$state,$q,global,$rootScope,$timeout){function closeRest(){for(var i=0,l=innerDivsBrand.length;i<l;i++)innerDivsBrand[i].hide()}function bindHoverLi(li,ii){self.clickMenu?li.click(function(e){if($(e.target).hasClass("sibsection"))li.find(".section-in-section").each(function(i,li2){$(li2).hover(function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("slow"):2==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("fast"):$(li2).find(".sub-menu").stop(!0,!1,!0).show()},function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).hide():(self.dropDownCatalog,$(li2).find(".sub-menu").stop(!0,!1,!0).hide())})});else{closeRest();for(var i=0,l=sectionElements.length;i<l;i++)sectionElements[i][0].id==li[0].id?1==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideToggle("slow"):2==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideToggle("fast"):li.innerDiv.stop(!0,!1,!0).toggle():1==self.dropDownCatalog?sectionElements[i].innerDiv.slideUp("slow"):2==self.dropDownCatalog?sectionElements[i].innerDiv.slideUp("fast"):sectionElements[i].innerDiv.hide()}}):(li.hover(function(){1==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideDown("slow"):2==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideDown("fast"):li.innerDiv.stop(!0,!1,!0).show()},function(){1==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideUp("slow"):2==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideUp("fast"):li.innerDiv.stop(!0,!1,!0).hide()}),li.find(".section-in-section").each(function(i,li2){$(li2).hover(function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("slow"):2==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("fast"):$(li2).find(".sub-menu").stop(!0,!1,!0).show()},function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).hide():(self.dropDownCatalog,$(li2).find(".sub-menu").stop(!0,!1,!0).hide())})}))}function getActiveClassForGroupUrl(groupUrl){if(console.log(groupUrl),$stateParams.groupUrl){var s=global.get("sections").val.getOFA("url",groupUrl);console.log(s)}}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.dropDownCatalog=global.get("store").val.template.dropDownCatalog,self.global=global,self.getActiveClassForGroupUrl=getActiveClassForGroupUrl;var sectionElements=[],innerDivs=[],innerDivsBrand=[];!function(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){global.get("brands").val.forEach(function(sec,i){var el=$("#s"+sec._id),innerDiv=$(el).find("#innerDivBrand"+sec._id);innerDivsBrand.push(innerDiv)}),self.sections=sections.filter(function(el){return!el.parent&&0===el.level}),setTimeout(function(){var w=$(window).width();self.sections.forEach(function(sec,i){var el=$("#s"+sec._id),elJS=document.getElementById("s"+sec._id);document.getElementById;var sec_element_offset=el.offset();if(sec_element_offset){var offsetLeft;elJS&&elJS.getBoundingClientRect&&(offsetLeft=pageXOffset+elJS.getBoundingClientRect().x),!offsetLeft&&elJS&&elJS.DOMRect&&(offsetLeft=pageXOffset+elJS.DOMRect.left,console.log("offsetLeft DOMRect",offsetLeft,sec_element_offset.left)),offsetLeft||(offsetLeft=sec_element_offset.left);var innerDiv=$("#innerDiv"+sec._id),container=innerDiv.find("div");container.find(".sub-menu"),el.innerDiv=innerDiv,innerDiv.css("left","-"+offsetLeft+"px"),bindHoverLi(el,i),sectionElements.push(el)}}),$(".innerDiv").width(w)},300)}).catch(function(err){console.log(err)})}(),$rootScope.$on("$stateChangeStart",function(ev){for(var i=0,l=innerDivs.length;i<l;i++)if(innerDivs[i][0]&&innerDivs[i].is(":hover")){sectionElements[i].unbind(),innerDivs[i].slideUp(function(){$timeout(function(){bindHoverLi(sectionElements[i],i)},700)});break}})}function directiveMenuV(Sections,$state,$q,global,$rootScope,$element){function bindHoverLi(li,ii){self.sections[ii]&&self.sections[ii].openCatalog||$(innerDivs[ii]).slideToggle(),self.clickMenu?li.click(function(e){for(var i=0,l=innerDivs.length;i<l;i++)i==ii&&$(innerDivs[i]).stop(!0,!1,!0).slideToggle(300)}):li.hover(function(){$(innerDivs[ii]).stop(!0,!1,!0).slideToggle(300)})}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.global=global;var sectionElements=[],innerDivs=[];!function(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){self.sections=sections.filter(function(el){return!el.parent&&0===el.level&&!el.hideSection}),setTimeout(function(){self.sections.forEach(function(sec,i){var el=$("#s"+sec._id),innerDiv=el.children("div");innerDivs.push(innerDiv),bindHoverLi(el,i),sectionElements.push(el)});var innerUl=$element.find(".category-in-section");$(innerUl).each(function(i,section){var ul=$(section).find("ul");$(ul).slideToggle(),$(section).click(function(e){$(section).hasClass("brand-name")&&e.stopPropagation(),$(ul).stop(!0,!1,!0).slideToggle(300)})})},100)}).catch(function(err){console.log(err)})}()}function directiveMenuBrands(Sections,$state,$q,global,$rootScope,$timeout,$element){function closeRest(){for(var i=0,l=innerDivsSection.length;i<l;i++)innerDivsSection[i].hide()}function bindHoverLi(li,ii){self.clickMenu?li.click(function(e){closeRest();for(var i=0,l=sectionElements.length;i<l;i++)sectionElements[i][0].id==li[0].id?li.innerDiv.stop(!0,!1,!0).toggle():sectionElements[i].innerDiv.hide()}):li.hover(function(){li.innerDiv.stop(!0,!1,!0).show()},function(){li.innerDiv.stop(!0,!1,!0).hide()})}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.global=global;var sectionElements=[],innerDivs=[],innerDivsSection=[];!function(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){sections.forEach(function(sec,i){var el=$("#s"+sec._id),innerDiv=$(el).find("#innerDiv"+sec._id);innerDivsSection.push(innerDiv)}),self.brands=global.get("brands").val?global.get("brands").val:[],setTimeout(function(){var w=$(window).width(),index=0;self.brands.forEach(function(sec,i){if(sec.display){var el=$("#s"+sec._id),sec_element_offset=el.offset();if(sec_element_offset){var offsetLeft=sec_element_offset.left,innerDiv=$element.find("#innerDivBrand"+sec._id);el.innerDiv=innerDiv,innerDiv.css("left","-"+offsetLeft+"px"),bindHoverLi(el,index),sectionElements.push(el),index++}}}),$(".innerDiv").width(w)},100)}).catch(function(err){console.log(err)})}(),$rootScope.$on("$stateChangeStart",function(ev){for(var i=0,l=innerDivs.length;i<l;i++)if(innerDivs[i][0]&&innerDivs[i].is(":hover")){sectionElements[i].unbind(),innerDivs[i].slideUp(function(){$timeout(function(){bindHoverLi(sectionElements[i],i)},700)});break}})}function directiveMenuVBrands(Sections,$state,$q,global,$rootScope){function bindHoverLi(li,ii){$(innerDivs[ii]).slideToggle(),self.clickMenu?li.click(function(e){for(var i=0,l=innerDivs.length;i<l;i++)i==ii&&innerDivs[i].stop(!0,!1,!0).slideToggle(300)}):li.hover(function(){innerDivs[ii].stop(!0,!1,!0).slideToggle(300)})}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.global=global;var sectionElements=[],innerDivs=[];!function(){self.brands=global.get("brands").val?global.get("brands").val:[],setTimeout(function(){var index=0;self.brands.forEach(function(sec,i){if(sec.display){var el=$("#s"+sec._id),innerDiv=el.children("div");innerDivs.push(innerDiv),bindHoverLi(el,index),sectionElements.push(el),index++}})},100)}()}function directiveDropdownOnHover(scope,element,arrts){function bindHover(){$(element).hover(function(){$(this).children("ul").stop(!0,!1,!0).slideToggle(200)})}!function(){$(element).children("ul").hide(),bindHover()}()}function slideMenuAfterScroll(global,$timeout,$rootScope){return{restrict:"A",link:function(scope,element,attrs){function scrollHandlerMenu1(){if(!menuHide||"home"==$rootScope.$state.current.name){var scrolled=window.pageYOffset||document.documentElement.scrollTop;scrolled>offset&&!done?(done=!0,$rootScope.$emit("hideMenu1AfterScroll"),$(element).css("top","-"+h+"px")):scrolled<offset&&done&&(done=!1,$rootScope.$emit("showMenu1AfterScroll"),$(element).css("top",0))}}function scrollHandlerMenu2(){if(!menuHide||"home"==$rootScope.$state.current.name){var scrolled=window.pageYOffset||document.documentElement.scrollTop;scrolled>offset&&!done?(done=!0,$(element).css("top",0)):scrolled<offset&&done&&(done=!1,$(element).css("top",h+"px"))}}function inverseNone(){logoInverse.css("display","none"),logo.css("display","block"),likesInverse.css("display","none"),likes.css("display","block"),cartInverse.css("display","none"),cart.css("display","block"),humbInverse.css("display","none"),humb.css("display","block")}function inverseBlock(){logo.css("display","none"),logoInverse.css("display","block"),likes.css("display","none"),likesInverse.css("display","block"),cart.css("display","none"),cartInverse.css("display","block"),humb.css("display","none"),humbInverse.css("display","block")}function listenScroll(){$(window).scroll(function(){if("home"==$rootScope.$state.current.name&&(!template.inverseColor.homePage||"home"==$rootScope.$state.current.name)){(window.pageYOffset||document.documentElement.scrollTop)>10?(element.addClass("inverseColor"),inverseBlock()):(element.removeClass("inverseColor"),inverseNone())}})}function listenBanner(){var el=document.getElementById("arrowDownDiv");if(el){var elOffsetY=$(el).offset().top;$(window).scroll(function(){if("home"==$rootScope.$state.current.name){var scrolled=window.pageYOffset||document.documentElement.scrollTop;$(el).height()+elOffsetY-10>scrolled?(element.removeClass("inverseColor"),inverseNone()):(element.addClass("inverseColor"),inverseBlock())}})}}var done,firstLook=!0,menu=attrs.slideMenuAfterScroll,menuHide=attrs.hideMenu,template=global.get("store").val.template,offset=199,h=$("#menu1-section").height();"menu2"==menu&&template.menu2.fixed&&template.menu2.is&&template.menu2.position,"menu1"==menu&&template.menu1.fixed&&"top"==template.menu1.position&&template.menu1.scrollSlide?$(window).scroll(scrollHandlerMenu1):"menu2"==menu&&template.menu1.fixed&&"top"==template.menu1.position&&"top"==template.menu2.position&&template.menu1.scrollSlide&&$(window).scroll(scrollHandlerMenu2);var logo,logoInverse,cart,cartInverse,humb,humbInverse,likes,likesInverse;template.inverseColor&&template.inverseColor.use&&(template.inverseColor.homePage&&function(){$rootScope.$on("$stateChangeSuccess",function(event,to,toParams,fromState,fromParams){var delay=0;firstLook&&(delay=500,firstLook=!1),$timeout(function(){"home"==to.name?(element.removeClass("inverseColor"),inverseNone()):(element.addClass("inverseColor"),inverseBlock())},delay)})}(),$timeout(function(){logo=$("#mainLogo"),logoInverse=$("#inverseLogo"),cart=$("#mainCart"),cartInverse=$("#inverseCart"),humb=$("#mainHumb"),humbInverse=$("#inverseHumb"),likes=$("#mainLikes"),likesInverse=$("#inverseLikes"),template.inverseColor.startScroll?listenScroll():template.inverseColor.firstBanner&&listenBanner()},300)),$rootScope.$on("$stateChangeSuccess",function(event,to,toParams,fromState,fromParams){menuHide&&("home"==to.name?($rootScope.$emit("showMenu1AfterScroll"),"menu1"==menu?$(element).css("top",0):$(element).css("top",h+"px")):($rootScope.$emit("hideMenu1AfterScroll"),"menu1"==menu?$(element).css("top","-"+h+"px"):$(element).css("top",0)))})}}}angular.module("gmall.directives").directive("menuSections",menuSectionHorizontal).directive("menuSectionsPug",menuSectionHorizontalPug).directive("menuBrandsPug",menuBrandsHorizontalPug).directive("menuSectionsVirtical",menuSectionVirtical).directive("menuSectionsVirticalPug",menuSectionVirticalPug).directive("menuBrandsVirticalPug",menuBrandsVirticalPug).directive("dropdownOnHover",dropdownOnHover).directive("slideMenuAfterScroll",slideMenuAfterScroll).directive("setFonAfterStartScroll",["$timeout","$state","$rootScope","global",function($timeout,$state,$rootScope,global){return{restrict:"A",link:function(scope,element,attr){var h1,h2,mainContentDiv=$("#mainContentDiv"),templ=global.get("store").val.template;$timeout(function(){h1=$("#menu1-section").outerHeight(),h2=$("#menu2-section").outerHeight(),h2&&(h1+=h2),global.get("store").val.template.menu1.hideMenuIfNotHome&&(h1=h2),h2=h1}),$(element).hover(function(){$rootScope.$emit("menuHoverIn")},function(){$rootScope.$emit("menuHoverOut")}),$rootScope.$on("menuHoverIn",function(){global.get("store").val.template.menu1.BGColorOnHover&&$(element).addClass("menuColor")}),$rootScope.$on("menuHoverOut",function(){global.get("store").val.template.menu1.BGColorOnHover&&!global.get("store").val.template.menu1.background&&window.pageYOffset<5&&"home"==$rootScope.$state.current.name&&$(element).removeClass("menuColor")}),$rootScope.$on("$stateChangeStart",function(event,to){"home"!=to.name?(templ.menu1.marginOther||$(element).addClass("menuColor"),templ.margin||$timeout(function(){"left"!=templ.menu1.position&&"right"!=templ.menu1.position&&!templ.menu1.marginOther&&templ.menu1.fixed&&mainContentDiv.css("margin-top",h1)})):(global.get("store").val.template.menu1.background||(global.get("store").val.template.menu1.BGColorOnHover?window.pageYOffset<5&&$(element).removeClass("menuColor"):$(element).removeClass("menuColor")),templ.margin||"left"!=templ.menu1.position&&"right"!=templ.menu1.position&&mainContentDiv.css("margin-top",0))});var is=!1;attr.setFonAfterStartScroll?$(element).addClass("menuColor"):global.get("store").val.template.menu1.BGColorOnHover&&$(window).scroll(function(){window.pageYOffset>5?is||(is=!0,$(element).addClass("menuColor")):"home"==$rootScope.$state.current.name&&(is=!1,$(element).removeClass("menuColor"))})}}}]).directive("setMenuColorClass",["$rootScope",function($rootScope){return{restrict:"A",link:function(scope,element,attr){console.log(element),$rootScope.$on("$stateChangeStart",function(event,to){"home"!=to.name?$(element).addClass("menuColor"):window.pageYOffset<5&&$(element).removeClass("menuColor")}),$rootScope.$on("menuHoverIn",function(){console.log("menuHoverIn",console.log(element)),$(element).addClass("menuColor")}),$rootScope.$on("menuHoverOut",function(){"home"==$rootScope.$state.current.name&&window.pageYOffset<5&&$(element).removeClass("menuColor")}),$(window).scroll(function(){"home"==$rootScope.$state.current.name&&(window.pageYOffset>5?$(element).addClass("menuColor"):$(element).removeClass("menuColor"))})}}}]).directive("marginMainContent22",function(global,$timeout){return{restrict:"A",link:function(scope,element,attrs){var mainContentDiv=$("#mainContentDiv"),templ=global.get("store").val.template;$timeout(function(){templ.margin&&"left"!=templ.menu1.position&&"right"!=templ.menu1.position&&$timeout(function(){var m1=$("#menu1-section"),h1=m1.height(),m2=$("#menu2-section");if(m2)var h2=m2.height();h2&&(h1+=h2),mainContentDiv.css("margin-top",h1)})},100)}}}).directive("marginMainContent",function($rootScope,$timeout,global){return{restrict:"A",link:function(scope,element,attrs){$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){$timeout(function(){if(global.get("store").val.template.menu1.fixed){var h=$(document.body).find("#firstDiv").height(),vh=Math.max(document.documentElement.clientHeight,window.innerHeight||0),delta=vh-h;if(delta>30){var mt=$(element[0].querySelector("#mainContentDiv")).css("margin-top");mt=mt?parseInt(mt,10):0;var elH=element.height();element.css("min-height",elH+delta)}}},200)})}}}).directive("footer22",function($timeout,$rootScope){return{restrict:"E",link:function(scope,element){$rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){element.css("position","static")}),$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){$timeout(function(){})})}}}),directiveMenu.$inject=["Sections","$state","$q","global","$rootScope","$timeout"],directiveMenuV.$inject=["Sections","$state","$q","global","$rootScope","$element"],directiveMenuBrands.$inject=["Sections","$state","$q","global","$rootScope","$timeout","$element"],directiveMenuVBrands.$inject=["Sections","$state","$q","global","$rootScope"]}(),function(){function userService($resource,$uibModal,$q,Session,User,global,exception,$state,$window,$rootScope,$http,$auth,Account){function newUser(name,email,password){return name||(name=email.split("@")[0]),User.save({name:name,email:email,password:password,action:"subscribtion"}).$promise.then(function(user){if($rootScope.emit("CompleteRegistration"),global&&global.get("user")&&global.set("user",user),global.get("local")&&!global.get("local").val&&$window.ga&&$window.ga("send","event","registration","complete"),"cart"!=$state.current.name&&"couponDetail"!=$state.current.name){var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","subscribtion");pap&&pap.url&&$state.go("thanksPage",{url:pap.url})}}return user})}function newUserByPhone(name,phone,confirmCondition){var email=phone+"@gmall.io",user={email:email,name:name,profile:{phone:phone,fio:name}};return confirmCondition&&(user.confirmCondition=confirmCondition),$auth.signup(user).then(function(response){if(console.log(response),!(response&&response.data&&response.data.token))throw response;if("update"==response.data.token)throw null}).then(function(response){}).catch(function(err){err&&exception.catcher("new client")(err)})}function getList(paginate,query){function getListComplete(response){
return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}function selectItem(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/selectUser.html",controller:function($user,$uibModalInstance,query){var self=(angular.copy(query),this);self.items=[],self.name="";var paginate={page:0,rows:30,items:0};self.search=function(name){var q=angular.copy(query);name.length<3||(q?(q.$and||(q={$and:[query]}),q.$and.push({$or:[{name:name},{email:name},{"profile.fio":name}]})):q={$or:[{name:name},{email:name},{"profile.fio":name}]},$user.getList(paginate,q).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(item){resolve(item)},function(){reject()})})}function selectOrCreat(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/selectOrCreate.html",controller:function($user,UserEntry,$http,global,$uibModalInstance){function refreshUsers(str){str.length<3||searchUser(str)}function searchUser(str){isNumeric(str)?(str.length>10&&(self.oldPhone=str.substring(0,10)),self.userName=""):(self.oldPhone=null,self.userName=str),self.users=[];var users=[],q={$or:[{name:str},{email:str},{"profile.fio":str},{"profile.phone":str}]},acts=[];q={search:str},acts.push(get$user(q)),$q.all(acts).then(function(res){res[0]&&res[0].length&&res[0].forEach(function(item){item.type="user",users.push(item)}),self.users=users})}function get$user(q){return $user.query(q).$promise}function addUser(){console.log("add user");var user={name:self.userName,email:self.userEmail,profile:{fio:self.userName,phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10)}};return self.userEmail||(user.email=user.profile.phone+"@gmall.io"),$q.when().then(function(){return $user.checkEmailForExist(user.email)}).then(function(res){if(res&&res.exist)throw"email exist"}).then(function(){return $http.post(userHost+"/api/createUser",user)}).then(function(res){user._id=res.data&&res.data._id?res.data._id:res.data.id,self.addingUser=!1,self.userName="",self.user=user,self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function clearUser(){self.user=null}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}var self=this;self.items=[],self.user="",self.oldPhone=null,self.userName="name",self.userEmail="",self.global=global,self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38";self.refreshUsers=refreshUsers,self.addUser=addUser,self.clearUser=clearUser;new RegExp(/^\d+$/);self.ok=function(){$uibModalInstance.close(self.user)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg"}).result.then(function(item){resolve(item)},function(){reject()})})}function saveProfile(user){return Items.save({update:"profile"},{_id:user._id,profile:user.profile}).$promise}function login(bookeep){return $q(function(resolve,reject){if(global.get("user")&&global.get("user").val&&global.get("user").val._id)return resolve();var modalInstance=$uibModal.open({animation:!0,templateUrl:function(){return bookeep?"components/user/modal/login-only.html":"components/user/modal/login-sign.html"},controller:loginCtrl2,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function loginOnlyPhone(){return $q(function(resolve,reject){if(global.get("user")&&global.get("user").val&&global.get("user").val._id)return resolve();var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/login-sign.onlyPhone.html",controller:loginOnlyPhoneCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfo(service){return service=!1,service=service?"Service":"Good",$q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/getInfo.html",controller:getInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass",resolve:{service:function(){return service}}});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfoCtrl($uibModalInstance,exception,global,User,$q,$http,service,Account){function closeModal(){$q.when().then(function(){return self.user._id?Items.save({update:"profile"},{_id:self.user._id,profile:self.user.profile}).$promise:$http.post("/auth/signupOrder",self.user)}).then(function(response){if(response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();response&&response.data&&response.data._id&&(self.user._id=response.data._id)}).then(function(){global.get("user").val&&(self.user=global.get("user").val),$uibModalInstance.close(self.user)})}var self=this;self.service=service,self.global=global,self.user=global.get("user").val,self.user||(self.user={email:"",profile:{}}),self.ok=closeModal,self.cancel=function(){$uibModalInstance.dismiss()}}function getInfoBonus(){return $q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/getInfoBonus.html",controller:getInfoBonusCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfoBonusCtrl($uibModalInstance,exception,global,User,$q,$http,Account,$auth){function closeModal(){$q.when().then(function(){return self.user._id?Items.save({update:"profile"},{_id:self.user._id,profile:self.user.profile}).$promise:$http.post("/auth/signupOrder",self.user)}).then(function(response){if(response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();response&&response.data&&response.data._id&&(self.user._id=response.data._id)}).then(function(){global.get("user").val&&(self.user=global.get("user").val),$uibModalInstance.close(self.user)})}var self=this;self.global=global,self.user=global.get("user").val,self.formData=global.get("store").val.bonusForm?global.get("store").val.bonusForm:null,self.user||(self.user={email:"",profile:{},addInfo:{}}),self.ok=closeModal,self.cancel=function(){$uibModalInstance.dismiss()}}function createUser(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/createUser.html",controller:function($user,$uibModalInstance,$http,$q,exception){var self=this;self.user={profile:{}},self.ok=function(form){form.$invalid||(self.blockButton=!0,$q.when().then(function(){if(self.user.profile&&self.user.profile.phone){var phone=self.user.profile.phone;return $user.getItem(phone,"profile.phone")}return null}).then(function(res){if(res&&res._id)throw"phone exist"}).then(function(){return $user.checkEmailForExist(self.user.email)}).then(function(res){if(res&&res.exist)throw"email exist"}).then(function(){return $http.post(userHost+"/api/createUser",self.user)}).then(function(res){$uibModalInstance.close(res)}).catch(function(err){err&&exception.catcher("error")(err),self.blockButton=!1}))},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){resolve(item)},function(){reject()})})}function changeEmail(userId){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changeEmail.html",controller:function($user,global,$uibModalInstance,$http,$q,exception){function checkEmail(email,valid){if(!valid)return void(self.cheched=!1);$q.when().then(function(){return $user.checkEmailForExist(email)}).then(function(res){if(!res||res.exist)throw"email exist";self.cheched=!0}).catch(function(err){err&&exception.catcher("change email")(err),self.cheched=!1})}var self=this;self.global=global,self.checkEmail=checkEmail,self.email="",self.ok=function(){if(!self.cheched)return void exception.catcher("change email")("email используется");self.blockButton=!0,$q.when().then(function(){return Items.save({update:"email"},{_id:userId,email:self.email})}).then(function(res){$uibModalInstance.close(self.email)}).catch(function(err){self.blockButton=!1})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",windowClass:"modalProject"}).result.then(function(item){resolve(item)},function(){reject()})})}function checkEmailForExist(email,_id){return $q(function(rs,rj){var o={email:email};_id&&(o._id=_id),User.checkEmail(o,function(res){rs(res)},function(err){rj(err)})})}function checkPhoneForExist(phone,_id){return $q(function(rs,rj){var o={email:phone};_id&&(o._id=_id),User.checkPhone(o,function(res){rs(res)},function(err){rj(err)})})}function changePhone(userId){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changePhone.html",controller:function($user,global,$uibModalInstance,$http,$q,exception){function checkPhone(phone){return $q.when().then(function(){return $user.checkPhoneForExist(phone)}).then(function(res){if(!res||res.exist)throw"phone exist"})}var self=this;self.global=global,self.checkPhone=checkPhone,self.email="",self.ok=function(){if(!self.phone)return void exception.catcher("change phone")("phone???");self.blockButton=!0,$q.when().then(function(){return checkPhone(self.phone)}).then(function(){var o={_id:userId};return o["profile.phone"]=self.phone,Items.save({update:"profile.phone"},o)}).then(function(res){$uibModalInstance.close(self.phone)}).catch(function(err){exception.catcher("change phone")(err),self.blockButton=!1})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){resolve(item)},function(){reject()})})}function changePswd(_id){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changePswd.html",controller:function($user,global,$uibModalInstance,$http,$q,_id){var self=this;self.global=global,self.user={_id:_id,password:""},self.ok=function(){$q.when().then(function(){return $http.post(userHost+"/api/changePswd",self.user)}).then(function(res){$uibModalInstance.close(res)}).catch(function(err){$uibModalInstance.dismiss(err)})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{_id:function(){return _id}},windowClass:"modalProject"}).result.then(function(item){resolve(item)},function(){reject()})})}function logout(callback){var cb=callback||angular.noop;return Session.delete(function(){return global.set("user",null),cb()},function(err){return cb(err)}).$promise}function loginCtrl2($scope,$uibModalInstance,exception,global,User,$state){var self=this;self.global=global,global.get("store").val.typeOfReg&&global.get("store").val.typeOfReg.phone&&(self.phone=!0),$scope.$on("closeWitget",function(){$uibModalInstance.close()}),self.cancel=function(){$uibModalInstance.dismiss()}}function loginOnlyPhoneCtrl($scope,$uibModalInstance,exception,global,User,$state){var self=this;self.global=global,$scope.$on("closeWitget",function(){$uibModalInstance.close()}),self.cancel=function(){$uibModalInstance.dismiss()}}var Items=$resource("/api/collections/User/:_id",{_id:"@_id"});return this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,selectItem:selectItem,selectOrCreat:selectOrCreat,login:login,loginOnlyPhone:loginOnlyPhone,logout:logout,saveProfile:saveProfile,newUser:newUser,newUserByPhone:newUserByPhone,query:Items.query,getInfo:getInfo,createUser:createUser,changePswd:changePswd,getInfoBonus:getInfoBonus,changeEmail:changeEmail,changePhone:changePhone,checkEmailForExist:checkEmailForExist,checkPhoneForExist:checkPhoneForExist}}function accountFactory($http,$state,global){return{getProfile:function(){var store=global.get("store").val._id;return $http.get("/api/me/"+store)},getPermission:function(){var store=global.get("store").val._id;return $http.get("/api/permission/"+store)},getPermissionTranslator:function(){var store=global.get("store").val._id;return $http.get("/api/permissionTranslator/"+store)},getPermissionOrder:function(){var store=global.get("store").val._id;return $http.get("/api/permissionOrder/"+store)},getPermissionMaster:function(master){var store=global.get("store").val._id;return $http.get("/api/permissionMaster/"+store+"/"+master)},getEnterButton:function(user){var store=global.get("store").val._id;return user.frame=$state.get("frame")?$state.get("frame").url:null,user.store=store,$http.post("/api/getEnterButton",user)},updateProfile:function(profileData){var store=global.get("store").val._id;return profileData.store=store,$http.put(userHost+"/api/me",profileData)},unsubscription:function(){global.get("store").val._id;return $http.get("/api/unsubscription/"+global.get("user").val._id)}}}function subscibtionListService($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return error}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/SubscribtionList/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get}}function userEntryService($resource,$q){function getList(paginate,query){function getListComplete(response){return paginate.page||(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/UserEntry/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query}}function sendPhoneFactory($http,$q,$user){function sendCodeToPhone(phone){if(phone){var o={phone:phone};return $q.when().then(function(){return $http.post("/api/users/sendSMS",o)})}}function verifyCode(code,phone){var o={code:code,phone:phone};return $q.when().then(function(){return $http.post("/api/users/verifySMScode",o)})}function checkPhone(phone){return $q.when().then(function(){return $user.getItem(phone,"profile.phone")}).then(function(res){return res?res:null})}return{sendCodeToPhone:sendCodeToPhone,verifyCode:verifyCode,checkPhone:checkPhone}}angular.module("gmall.services").factory("Session",["$resource",function($resource){return $resource("/api/session/")}]).factory("User",function($resource){return $resource("/api/users/:id/:email",{id:"@id"},{update:{method:"PUT",params:{id:"profile",email:""}},updateCoupon:{method:"PUT",params:{id:"coupon",email:""}},updatePswd:{method:"PUT",params:{id:"changepswd",email:""}},resetPswd:{method:"POST",params:{id:"resetpswd",email:"@email"}},get:{method:"GET",params:{id:"me",email:""}},checkEmail:{method:"GET",params:{id:"checkemail"}},checkPhone:{method:"GET",params:{id:"checkphone"}},useCoupon:{method:"GET",params:{id:"useCoupon"}},cancelCoupon:{method:"GET",params:{id:"cancelCoupon"}},repeatMailForConfirm:{method:"GET",params:{id:"repeatMailForConfirm"}}})}).service("$user",userService).service("UserEntry",userEntryService).factory("Account",accountFactory).factory("sendPhoneFactory",sendPhoneFactory).service("SubscibtionList",subscibtionListService),userService.$inject=["$resource","$uibModal","$q","Session","User","global","exception","$state","$window","$rootScope","$http","$auth","Account"],accountFactory.$inject=["$http","$state","global"],subscibtionListService.$inject=["$resource"],userEntryService.$inject=["$resource","$q"],sendPhoneFactory.$inject=["$http","$q","$user"]}(),function(){function userShipInfo(){return{scope:{short:"@"},bindToController:!0,controller:shipInfoCtrl,controllerAs:"$ctrl",templateUrl:"/components/user/shipInfo.html",restrict:"AE"}}function userShipInfoShort(){return{scope:{short:"@"},bindToController:!0,controller:shipInfoCtrl,controllerAs:"$ctrl",templateUrl:"/components/user/shipInfoShort.html",restrict:"AE"}}function shipInfoCtrl(global,$order,exception,$window,$rootScope,$q,$user,$timeout,$attrs){function changeEmail(){$q.when().then(function(){return $user.changeEmail(global.get("user").val._id)}).then(function(res){console.log(res),global.get("user").val.email=res}).catch(function(err){err&&exception.catcher("change email")(err)})}function ok(formProfile){formProfile.$valid?$q.when().then(function(){return self.user.val.profile.phone?$user.getItem(self.user.val.profile.phone,"profile.phone"):null}).then(function(res){!res||res&&!res._id||res&&res._id&&res._id==self.user.val._id?global.get("store").val.cartSetting&&global.get("store").val.cartSetting.slide?$rootScope.$emit("cartslide",{event:"shipInfoDone"}):$rootScope.$emit("closeShipModal"):(self.phoneExist=!0,$timeout(function(){self.phoneExist=!1},5e3))}):formProfile.$error&&(formProfile.$error.required&&formProfile.$error.required.forEach(function(el){var error=global.get("langNote").val.formError+" "+el.$name+"\n";exception.catcher(global.get("langNote").val.error)(error)}),formProfile.$error.pattern,formProfile.$error.maxlenth)}var self=this;self.order=$order.getOrder(),self.global=global,self.user=global.get("user"),self.ok=ok,$rootScope.$on("logged",function(){self.user=global.get("user")}),$rootScope.$on("loggout",function(){self.user.val={email:"",profile:{}}}),self.changeEmail=changeEmail}angular.module("gmall.directives").directive("userShipInfo",userShipInfo).directive("userShipInfoShort",userShipInfoShort),shipInfoCtrl.$inject=["global","$order","exception","$window","$rootScope","$q","$user","$timeout","$attrs"]}(),function(){function campaignService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/PROMO/campaign/createCampaign.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){!self.name||self.name.length<3||$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject()})})}function selectItem(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/PROMO/campaign/selectItem.html",controller:function(Campaign,$uibModalInstance){var self=this;self.stuffs=[],self.name="";var query,paginate={page:0,rows:30,items:0};self.search=function(name){name.length<3||(query={name:name},Campaign.getList(paginate,query).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg"}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}var Items=$resource("/api/collections/Campaign/:_id",{_id:"@_id"});return{get:Items.get,getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,create:create,select:selectItem}}angular.module("gmall.services").service("Campaign",campaignService),campaignService.$inject=["$resource","$uibModal","$q"]}(),function(){function helperService($resource,$uibModal,$q,exception){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return _items[id]=response,response}function getItemFailed(error){return _items[id]=null,$q.reject(error)}return _items[id]?$q.when(_items[id]):Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function getHelp(state){$q.when().then(function(){return getItem(state)}).then(function(helper){$uibModal.open({animation:!0,templateUrl:"components/helper/helperModal.html",controller:function($uibModalInstance,$sce,desc){var self=this;self.desc=desc,self.cancel=function(){$uibModalInstance.dismiss("cancel")}},resolve:{desc:function(){return helper.desc}},controllerAs:"$ctrl"})}).catch(function(err){var msg="ошибка";err&&("object"==typeof err?err.data?msg=err.data:err.message&&(msg=err.message):msg=err),err=err.data||err,exception.catcher("получение справки")(msg)})}var Items=$resource("/api/collections/Helper/:_id",{_id:"@_id"}),_items={};return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,getHelp:getHelp}}angular.module("gmall.services").service("Helper",helperService),helperService.$inject=["$resource","$uibModal","$q","exception"]}(),angular.module("gmall.services").factory("$email",function($resource){return $resource("/api/sendEmail")}).factory("Email",function($resource){return $resource("/api/sendEmails")}),angular.module("gmall.services").factory("$notification",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}var Items=$resource("/api/collections/Notification/:id",{id:"@_id"},{deleteArray:{method:"DELETE"},updateNote:{method:"POST",params:{update:"note"}}});return{getList:getList,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}),angular.module("gmall.controllers").controller("callCtrl",["$scope","global","$notification","toaster","CreateContent","$rootScope","$http","exception","$q","$email","$attrs",function($scope,global,$notification,toaster,CreateContent,$rootScope,$http,exception,$q,$email,$attrs){function sendMessage(textForSend){return self.dataForSend={},self.dataForSend.phone=global.get("store").val.seller.phone,self.dataForSend.text=textForSend,self.dataForSend.userId=md5www(global.get("store").val.subDomain),self.dataForSend.onlyText=!0,$q.when().then(function(){return $http.post("/api/users/sendMessageAboutDealFromServer",self.dataForSend)}).catch(function(err){sendEmail(self.dataForSend)})}function sendEmail(data){if(global.get("store").val.feedbackEmail){var domain=global.get("store").val.domain,o={email:[global.get("store").val.feedbackEmail],content:data.text,subject:global.get("lang").val.callorder+" ✔",from:global.get("store").val.name+"<"+global.get("store").val.subDomain+"@"+domain+">"};$q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){resolve()})})}}self=this,self.global=global,$scope.callCtrl=this,self.user=global.get("user").val?global.get("user"):{val:{profile:{phone:"",fio:""}}},$scope.phoneNumberPattern=function(){var regexp=/^([0-9\(\)\/\+ \-]*)$/;return{test:function(value){return $scope.requireTel===!1||regexp.test(value)}}}();var o={addressee:"seller",type:"call",content:""};o.seller=global.get("store").val.seller._id,$scope.callCtrl.pushNotification=function(form){if(!$scope.callCtrl.blockButton&&form.$valid){$scope.callCtrl.blockButton=!0,o.content=global.get("langOrder").val.requestacallback+" "+self.user.val.profile.phone+(self.user.val.fio?" "+self.user.val.fio:"")+" "+moment().format("LLLL"),o.content=CreateContent.call(self.user.val.profile.phone,self.user.val.fio?" "+self.user.val.fio:""),self.stuff&&(o.content+=","+self.stuff),sendMessage(o.content),$scope.$emit("closeWitget"),$rootScope.checkedMenuChange("chatMenu",!1),$notification.save(o,function(res){toaster.pop({type:"note",title:global.get("langNote").val.sent,body:"",delay:3e3,showCloseButton:!0}),$scope.callCtrl.blockButton=!1},function(err){toaster.pop({type:"error",title:global.get("langNote").val.error,body:"",delay:3e3,showCloseButton:!0})});var pap;global.get("paps")&&global.get("paps").val&&(pap=global.get("paps").val.getOFA("action","call"))&&$rootScope.$state.go("thanksPage",{id:pap.url})}}}]),angular.module("gmall.directives").directive("callFromStore",[function(){return{scope:{modalClose:"&",stuff:"@"},restrict:"E",bindToController:!0,controllerAs:"$ctrl",controller:"callCtrl",templateUrl:"components/call/call.html"}}]).directive("enterPhoneNumder",[function(){return{scope:{enterPhoneNumder:"=",changeFoo:"&",submitted:"="},restrict:"A",bindToController:!0,controllerAs:"$ctrl",controller:enterPhoneNumderCtrl,templateUrl:"components/call/phoneNumber.html"}}]),enterPhoneNumderCtrl.$inject=["$scope","global"],angular.module("gmall.controllers").controller("feedbackCtrl",["$scope","global","$notification","toaster","CreateContent","$email","$rootScope","exception","$attrs","$timeout",function($scope,global,$notification,toaster,CreateContent,$email,$rootScope,exception,$attrs,$timeout){self=this,$scope.feedbackCtrl=this,self.global=global,$attrs&&$attrs.text&&$timeout(function(){$scope.feedbackCtrl.message=$attrs.text},1e3);var note={addressee:"seller",type:"feedback",content:""};note.seller=global.get("store").val.seller._id,$scope.feedbackCtrl.sendMessage=function(form){if(!$scope.feedbackCtrl.blockButton&&form.$valid){$scope.feedbackCtrl.blockButton=!0,note.content=$scope.feedbackCtrl.message;var content=$scope.feedbackCtrl.message+"<br />"+$scope.mainFrameCtrl.feedback.name+"<br />"+$scope.mainFrameCtrl.feedback.email,domain=global.get("store").val.domain||global.get("store").val.subDomain,o={email:global.get("store").val.feedbackEmail,content:content,subject:"обратная связь ✔",from:domain+"<feedback@"+domain+">"};$email.save(o,function(res){$scope.$emit("closeWitget"),$rootScope.checkedMenuChange("chatMenu",!1);var pap;global.get("paps")&&global.get("paps").val&&(pap=global.get("paps").val.getOFA("action","feedback"))&&$rootScope.$state.go("thanksPage",{id:pap.url}),toaster.pop({type:"note",title:global.get("langNote").val.sent,body:"",delay:4e3,showCloseButton:!0})},function(err){console.log(err),exception.catcher(global.get("langNote").val.error)(err)})}}}]),angular.module("gmall.directives").directive("feedbackMessage",[function(){return{restrict:"E",scope:{modalClose:"&"},bindToController:!0,controllerAs:"$ctrl",controller:"feedbackCtrl",templateUrl:"components/feedback/feedback.html",link:function(){}}}]),angular.module("gmall.services").provider("global",[function(){var _data={},_urls={};this.setUrl=function(urls){_urls=urls};var _set=function(what,val){val=val||null,angular.isDefined(what)&&(_data[what]?_data[what].val=angular.isDefined(val)?val:null:_data[what]={val:val})},_getSticker=function(stuff){stuff._id?stuff._id:stuff.stuff;if(stuff.tags&&stuff.tags.length&&_data.filterTagsSticker.val){for(var i=0,l=_data.filterTagsSticker.val.length;i<l;i++){var tag=_data.filterTagsSticker.val[i]._id;if(stuff.tags.indexOf(tag)>-1)return!!_data.filterTagsSticker.val[i].sticker&&_data.filterTagsSticker.val[i].sticker}return!1}},_getDataForCart=function(stuff){return void console.log("не используется!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")};this.set=_set,this.$get=["$http",function($http){return{request:function(url,vars){return angular.isDefined(vars)?$http.post(url,$.param(vars),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}):$http.get(url)},url:function(which){return _urls[which]},set:_set,get:function(what){return angular.isDefined(what)&&what in _data?_data[what]:void 0},del:function(what){if(angular.isDefined(what)){var i=_data.indexOf(what);if(i>=0)return _data.splice(i,1)}return!1},clear:function(){_data=[]},getAll:function(){return _data},getSticker:_getSticker,getDataForCart:_getDataForCart}}]}]).factory("globalSrv",["global",function(global){var _send=global.request;return{getData:function(name,param,abbr){var url=global.url(name);if(!angular.isDefined(param)||angular.equals(param,null)||angular.equals(param,"")||(url+="/"+param),angular.isDefined(abbr)&&!angular.equals(abbr,null)&&!angular.equals(abbr,"")&&"object"==typeof abbr){url+="?";for(var key in abbr)"?"!=url[url.length-1]&&(url+="&"),url+=key+"="+abbr[key]}return _send(url)}}}]),angular.module("gmall.services").service("Sections",sectionServiceFunction).service("selectCategoryFromModal",function($q,$uibModal){this.bind=function(categoryId){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/selectCategoryModal/selectCategoryModal.html",controller:"selectCategoryModalCtrl",size:"lg",resolve:{categoryId:function(){return categoryId}}};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}}),sectionServiceFunction.$inject=["$resource","$q","global","$uibModal","$timeout"],angular.module("gmall.services").service("Filters",function($resource,$q,global,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}
function returnFilters(resolve){pending?setTimeout(function(){returnFilters(resolve)},300):resolve(filters)}function reloadItems(){pending=!0,Items.query(function(res){res.shift(),filters=res,global.set("filters",filters),pending=!1})}function selectFilter(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/selectFilter.html",controller:selectFilterCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectFilterCtrl(Filters,$uibModalInstance,$q,global){var self=this;self.lang=global.get("lang").val,$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filter){$uibModalInstance.close(filter)}}var Items=$resource("/api/collections/Filter/:_id",{_id:"@_id"}),filters=null,pending=!0;this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.select=selectFilter,this.reloadItems=reloadItems,this.getItem=getItem,this.getList=getList,this.getFilters=function(){return $q(function(resolve,reject){if(global.get("filters")&&global.get("filters").val)return filters||(filters=global.get("filters").val),resolve(global.get("filters").val);pending?setTimeout(function(){returnFilters(resolve)},300):filters?resolve(filters):(pending=!0,Items.query(function(res){res.shift(),filters=res,pending=!1,resolve(filters)},function(err){pending=!1,reject(err)}))})},global.get("filters")&&global.get("filters").val||Items.query(function(res){res.shift(),filters=res,global.get("filters")&&!global.get("filters").val&&global.set("filters",filters),pending=!1}),selectFilterCtrl.$inject=["Filters","$uibModalInstance","$q","global"]});var __filterTagsO=_filterTagsO,__filterTags=_filterTags;angular.module("gmall.services").service("FilterTags",filterTagsService),filterTagsService.$inject=["$resource","$uibModal","$q","global","$timeout","Sections"],angular.module("gmall.services").service("SelectFilterTags",["$q","$uibModal",function($q,$uibModal){function bindFilterTagToModelCtrl(Filters,$uibModalInstance){var self=this;$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){$uibModalInstance.close(filterTag)}}this.bindFiterTagToModel=function(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/bindFilterTagToModel.html",controller:bindFilterTagToModelCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}}]),function(){function itemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/cart.html"}}function previewCartDirective(){return{scope:{},restrict:"EA",bindToController:!0,controller:previewCartCtrl,controllerAs:"$ctrl",transclude:!0,templateUrl:"views/template/partials/cart/previewCart.html"}}function addedCartDirective(){return{scope:{},bindToController:!0,controller:function($scope,$element,$timeout,global){$($element).fadeOut();var self=this;self.global=global,self.addItem=null;var timer=null;$scope.$on("$updateOrder",function(event,itemTo){self.addItem=angular.copy(itemTo),timer?$timeout.cancel(timer):$($element).fadeIn(),timer=$timeout(function(){self.addItem=null,timer=null,$($element).fadeOut()},2500)}),$($element).hover(function(){timer&&($timeout.cancel(timer),timer=null)},function(){$($element).fadeOut()}),$($element).click(function(){$($element).fadeOut()})},controllerAs:"$ctrl",templateUrl:"views/template/partials/cart/addedCart.html"}}function itemCtrl($scope,$anchorScroll,$order,global,exception,Confirm,$user,$q,CreateContent,$email,$notification,$state,$rootScope,$timeout){function _setCoupons(){self.coupons=null,global.get("coupons")&&global.get("coupons").val&&global.get("coupons").val.length&&global.get("coupons").val.forEach(function(c){global.get("user").val?global.get("user").val.coupons.indexOf(c._id)<0&&(self.coupons||(self.coupons=[]),self.coupons.push(c)):(self.coupons||(self.coupons=[]),self.coupons.push(c))}),self.coupon=null,global.get("coupons")&&global.get("coupons").val&&global.get("user").val?global.get("coupons").val[0]&&global.get("user").val.coupons.indexOf(global.get("coupons").val[0]._id)<0?self.coupon=global.get("coupons").val[0]:global.get("coupons").val[1]&&global.get("user").val.coupons.indexOf(global.get("coupons").val[1]._id)<0&&(self.coupon=global.get("coupons").val[1]):!global.get("user").val&&global.get("coupons")&&global.get("coupons").val&&(self.coupon=global.get("coupons").val[0])}function clearCart(){Confirm(global.get("langNote").val.clean+"?").then(function(){$order.clearCart()}).catch(function(err){(err=err&&err.data||err)&&exception.catcher(global.get("langNote").val.error)(err)})}function removeItem(i){Confirm(global.get("lang").val.delete+"?").then(function(){$order.removeItem(i)})}function saveCart(stuff){stuff?stuff.quantity&&(stuff.quantity>stuff.maxQty?(stuff.quantity=stuff.maxQty,exception.catcher(global.get("langNote").val.error)("слишком много")):stuff.quantity<stuff.minQty?(stuff.quantity=stuff.minQty,exception.catcher(global.get("langNote").val.error)("слишком мало")):$order.updateOrder()):$order.updateOrder()}function decreaseQty(i){$order.decreaseQty(i)}function increaseQty(i){$order.increaseQty(i)}function checkOut(){self.textCheckWarehouse=null,$rootScope.$emit("InitiateCheckout"),self.order.cart.stuffs.length&&(global.get("store").val.cartSetting&&global.get("store").val.cartSetting.slide?global.get("user").val&&global.get("user").val._id?forward(2):forward():(self.order=$order.getOrder(),$q.when().then(function(){return global.get("user").val&&global.get("user").val._id?void 0:$user.login()}).then(function(){if(global.get("store").val.bookkeep)return $order.checkWarehouse()}).then(function(){return $order.getShipInfo()}).then(function(){return sendOrder()}).catch(function(err){err&&("checkWarehouse"==err.status&&(self.textCheckWarehouse=err.message),exception.catcher("заказ")(err))})))}function sendOrder(){return $q.when().then(function(){return $rootScope.$emit("$stateChangeStartToStuff"),$order.sendOrder()}).then(function(){}).then(function(){$rootScope.$emit("$stateChangeEndToStuff"),$rootScope.$emit("Purchase",{value:$order.paySum,currency:$order.currency}),$order.reinitCart(),$rootScope.order=$order.getOrder(),self.order.setCoupon(null),_setCoupons(),$order.clearCart(),$rootScope.checkedMenu.cart=!1}).then(function(){return $user.saveProfile(global.get("user").val)}).catch(function(err){if($rootScope.$emit("$stateChangeEndToStuff"),err){if(console.log("errerrerr ",err),err.data)var content=JSON.stringify(err.data);else var content=JSON.stringify(err,["message","arguments","type","name"]);global.get("user").val&&(content+="\r"+global.get("user").val.email),$order.getOrder()&&(content+="\r"+JSON.stringify($order.getOrder(),null,4));var domain=global.get("store").val.domain,o={email:["igorchugurov@gmail.com","vikachugurova@gmail.com"],content:content,subject:"error in order ✔",from:global.get("store").val.name+"<"+global.get("store").val.subDomain+"@"+domain+">"};$q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){resolve()})}),err&&exception.catcher(global.get("langNote").val.error)(err)}})}function enableCheckOut(){return!(!self.order.totalCount||!self.order.cart.stuffs.length)&&!(self.opt>1&&!retail&&self.order.totalCount<self.opt)}function goToStuff(o){var states=$state.get();states.some(function(state){return"frame.stuffs.stuff"==state.name})?$state.go("frame.stuffs.stuff",o):states.some(function(state){return"stuffs.stuff"==state.name})&&$state.go("stuffs.stuff",o)}function backToShop(){var o={groupUrl:"null",categoryUrl:"category"};global.get("sections").val&&global.get("sections").val[0]&&(o.groupUrl=global.get("sections").val[0].url),$state.go("stuffs",o)}function disabledCheckOut(){if(!self.order.cart.stuffs.length)return!0}function back(){2==self.currentBlock&&global.get("user").val&&(self.currentBlock=1),self.currentBlock&&self.currentBlock--}function forward(num){num?self.currentBlock+=num:self.currentBlock++,console.log(self.currentBlock)}function setSlide(s){self.currentBlock=s}function getFilterName(tag){var t=global.get("filterTags").val.getOFA("_id",tag);if(t&&t.filter){var f=global.get("filters").val.getOFA("_id",t.filter);return f?f.name:""}return""}function setCouponForOrder(c,e){e.stopPropagation(),self.order.setCoupon(c)}var self=this;$scope.myInterval=2e3,$scope.noWrapSlides=!0,$scope.active33=2;var slides=$scope.slides=[],currIndex=0;$scope.addSlide=function(){var newWidth=600+slides.length+1;slides.push({image:"//unsplash.it/"+newWidth+"/300",text:["Nice image","Awesome photograph","That is so cool","I love that"][slides.length%4],id:currIndex++})},$scope.randomize=function(){var indexes=generateIndexesArray();assignNewIndexesToSlides(indexes)};for(var i=0;i<4;i++)$scope.addSlide();self.currentBlock=0;self.global=global,self.mobile=global.get("mobile").val,self.opt=global.get("store").val.seller.opt&&global.get("store").val.seller.opt.quantity?global.get("store").val.seller.opt.quantity:0;var retail=global.get("store").val.seller.retail;self.disabledMessage=self.opt>1&&!retail,self.countryCode=global.get("country"),self.clearCart=clearCart,self.removeItem=removeItem,self.saveCart=saveCart,self.checkOut=checkOut,self.enableCheckOut=enableCheckOut,self.goToStuff=goToStuff,self.disabledCheckOut=disabledCheckOut,self.back=back,self.backToShop=backToShop,self.getFilterName=getFilterName,self.decreaseQty=decreaseQty,self.increaseQty=increaseQty,self.setCouponForOrder=setCouponForOrder,function(){$order.type&&"cart"==$order.type?self.order=$order.getOrder():$order.init("cart").then(function(order){self.order=order}),$anchorScroll(),_setCoupons(),$scope.$on("logged",function(){_setCoupons()}),global.get("store").val.cartSetting&&global.get("store").val.cartSetting.slide&&setSlide(0)}(),$rootScope.$on("cartslide",function(event,data){console.log(data),data&&("shipInfoDone"==data.event?sendOrder():"shipInfoDone"==data.event?setSlide(0):"signLogin"==data.event?forward():"init"==data.event&&setSlide(0))})}function previewCartCtrl($scope,$anchorScroll,global,exception,$q,$state,$order,$element,$timeout,$rootScope){function activate(){$order.type&&"cart"==$order.type?self.order=$order.getOrder():$order.init("cart").then(function(order){self.order=order}),$anchorScroll(),self.loaded=!0}function removeItem(i){$order.removeItem(i)}function saveCart(){$order.updateOrder()}function goToStuff(o){var states=$state.get();states.some(function(state){return"frame.stuffs.stuff"==state.name})?$state.go("frame.stuffs.stuff",o):states.some(function(state){return"stuffs.stuff"==state.name})&&$state.go("stuffs.stuff",o)}var self=this;self.global=global;var listDiv=$element.find(".cartItems")[0];$(listDiv).fadeOut();var hoverIn;$($element).hover(function(){hoverIn=!0,$timeout(function(){hoverIn&&$(listDiv).fadeIn(150)},50),$(listDiv).fadeIn(100)},function(){hoverIn=!1,$timeout(function(){hoverIn||$(listDiv).fadeOut(100)},100)}),self.global=global,self.mobile=global.get("mobile").val,self.opt=global.get("store").val.seller.opt&&global.get("store").val.seller.opt.quantity?global.get("store").val.seller.opt.quantity:0;var retail=global.get("store").val.seller.retail;self.disabledMessage=self.opt>1&&!retail,self.countryCode=global.get("country"),self.removeItem=removeItem,self.saveCart=saveCart,self.goToStuff=goToStuff,$timeout(function(){activate()},400),$rootScope.$on("Purchase",function(){self.order=$order.getOrder()})}angular.module("gmall.services").directive("cartItem",itemDirective).directive("previewCart",previewCartDirective).directive("addedCart",addedCartDirective),itemCtrl.$inject=["$scope","$anchorScroll","$order","global","exception","Confirm","$user","$q","CreateContent","$email","$notification","$state","$rootScope","$timeout"],previewCartCtrl.$inject=["$scope","$anchorScroll","global","exception","$q","$state","$order","$element","$timeout","$rootScope"]}(),function(){function brandTagsService($resource,$uibModal,$q,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function selectBrandTag(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/brand/selectBrandTag.html",controller:selectBrandTagCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectBrandTagCtrl(Brands,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Brands.getBrands()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){filterTag&&(self.section&&(filterTag.section=self.section),filterTag.brand=self.filters.find(function(b){return b._id==filterTag.brand})),$uibModalInstance.close(filterTag)}}var Items=$resource("/api/collections/BrandTags/:id",{id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,selectBrandTag:selectBrandTag,select:selectBrandTag}}angular.module("gmall.services").service("Brands",function($resource,$q,global,$uibModal,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function returnBrands(resolve){pending?setTimeout(function(){returnBrands(resolve)},300):resolve(brands)}function reloadItems(){pending=!0,Items.query(function(res){res.shift(),brands=res,global.set("brands",brands),pending=!1})}function selectBrand(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/brand/selectBrand.html",controller:selectBrandCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectBrandCtrl(Brands,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Brands.getBrands()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),$uibModalInstance.close(filterTag)}}var Items=$resource("/api/collections/Brand/:id",{id:"@_id"}),brands=null,pending=!0;this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.reloadItems=reloadItems,this.select=selectBrand,this.getList=getList,this.getItem=getItem,this.getBrands=function(){return $q(function(resolve,reject){if(global.get("brands")&&global.get("brands").val)return brands||(brands=global.get("brands").val),resolve(global.get("brands").val);pending?setTimeout(function(){returnBrands(resolve)},300):brands?resolve(brands):(pending=!0,Items.query(function(res){res.shift(),brands=res?res:[],pending=!1,resolve(brands)},function(err){pending=!1,reject(err)}))})},global.get("brands")&&global.get("brands").val||Items.query(function(res){res.shift(),brands=res,global.get("brands")&&!global.get("brands").val&&global.set("brands",brands),pending=!1}),selectBrandCtrl.$inject=["Brands","$uibModalInstance","$q","global","sections"]}).service("BrandTags",brandTagsService),brandTagsService.$inject=["$resource","$uibModal","$q","Sections"]}(),angular.module("gmall.controllers").controller("stuffsFilterCtrl",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll","$timeout",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll,$timeout){function _getCollections(){var query={brand:$scope.stuffsFilterCtrl.query.brand,group:$scope.stuffsFilterCtrl.query.section};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffsFilterCtrl.brandCollections=res,$scope.stuffsFilterCtrl.brandCollections&&$stateParams.brandTag){var brandTag=$scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffsFilterCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}})}function _getQueryTag(){var arr=[];return $scope.stuffsFilterCtrl.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr.length?arr.map(function(tag){return global.get("filterTags").val.getObjectFromArray("_id",tag).url}).join("+"):void 0}function _getBrand(){if($scope.stuffsFilterCtrl.query.brand)return global.get("brands").val.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.brand).url}function _getBrandTag(){if($scope.stuffsFilterCtrl.query.brandTag)return $scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.brandTag).url}var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.stuffsFilterCtrl=this,$scope.stuffsFilterCtrl.paginate={page:0,rows:50,totalItems:0},$scope.stuffsFilterCtrl.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$scope.stuffsFilterCtrl.categories=[];var queryTags,category;$scope.stuffsFilterCtrl.brands=[],$scope.stuffsFilterCtrl.brandCollections=[],$scope.stuffsFilterCtrl.filters=[],function(){var q=$q.defer();return q.resolve(),q.promise}().then(function(){var q=$q.defer();if("brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl){var group=global.get("groups").val.getObjectFromArray("url",$stateParams.groupUrl);if(group){if($scope.stuffsFilterCtrl.query.section=group._id,$stateParams.parentGroup){var categories=$section.getCategories($stateParams.parentGroup).map(function(i){return i._id?i._id:i});categories&&($scope.stuffsFilterCtrl.categories=global.get("categories").val.filter(function(item){return categories.indexOf(item._id)>-1}))}q.resolve($scope.stuffsFilterCtrl.categories)}else $state.go("404")}else q.resolve(1);return q.promise}).then(function(r){var q=$q.defer();return $scope.stuffsFilterCtrl.categories.length&&$stateParams.categoryUrl?"id"!=$stateParams.categoryUrl&&(category=$scope.stuffsFilterCtrl.categories.getObjectFromArray("url",$stateParams.categoryUrl),category?$scope.stuffsFilterCtrl.query.category=category._id:$state.go("404")):"id"!=$stateParams.categoryUrl&&(category=global.get("categories").val.getObjectFromArray("url",$stateParams.categoryUrl))&&($scope.stuffsFilterCtrl.query.category=category._id,$scope.stuffsFilterCtrl.categories=$section.getCategories(category.group.url)),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.category&&($scope.stuffsFilterCtrl.brands=global.get("brands").val.getArrayObjects("categories",$scope.stuffsFilterCtrl.query.category)),1===$scope.stuffsFilterCtrl.brands.length)$scope.stuffsFilterCtrl.query.brand=$scope.stuffsFilterCtrl.brands[0]._id;else if($stateParams.brand){var brand=$scope.stuffsFilterCtrl.brands.getObjectFromArray("url",$stateParams.brand);brand&&($scope.stuffsFilterCtrl.query.brand=brand._id,$location.search("brand",brand.url))}return $scope.stuffsFilterCtrl.query.brand||$location.search("brand",null),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.brand){var query={brand:$scope.stuffsFilterCtrl.query.brand,group:$scope.stuffsFilterCtrl.query.section};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffsFilterCtrl.brandCollections=res,$stateParams.brandTag){var brandTag=$scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffsFilterCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}q.resolve(1)},function(){q.resolve(3)})}else q.resolve(2);return q.promise}).then(function(){var q=$q.defer();return $stateParams.queryTag&&(queryTags=$stateParams.queryTag.split("+"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),queryTags=queryTags.reduce(function(tags,tag){var t;return(t=global.get("filterTags").val.getObjectFromArray("url",tag))&&tags.push(t),tags},[])),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.category){var filters=global.get("filters").val.filter(function(item){return!item.dontshow&&category.filters.indexOf(item._id)>-1});filters.forEach(function(item,i){item.tags=[],global.get("filterTags").val.forEach(function(tag){tag.filter==item._id&&item.tags.push(tag)}),queryTags&&queryTags.length&&queryTags.forEach(function(tag){tag.filter==item._id&&($scope.stuffsFilterCtrl.query.tags[i]||($scope.stuffsFilterCtrl.query.tags[i]=[]),$scope.stuffsFilterCtrl.query.tags[i].push(tag._id))})}),$scope.stuffsFilterCtrl.filters=filters}else queryTags&&queryTags.length&&($scope.stuffsFilterCtrl.query.tags[0]=[queryTags[0]._id],$location.search("queryTag",queryTags[0].url));return q.resolve("finsh"),q.promise}).then(function(r){$scope.stuffsFilterCtrl.getList($scope.stuffsFilterCtrl.paginate.page,$scope.stuffsFilterCtrl.paginate.rows)});var prevBrand;$scope.stuffsFilterCtrl.getList=function(page,rows){prevBrand=$scope.stuffsFilterCtrl.query.brand;var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});var queryTag=[];for(var key in $scope.stuffsFilterCtrl.query)if($scope.stuffsFilterCtrl.query[key])if("tags"==key){var qu=[];$scope.stuffsFilterCtrl.query[key].filter(function(){return!0});$scope.stuffsFilterCtrl.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.stuffsFilterCtrl.query[key],query.push(obj)}query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):"";var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand(),queryTagsForSEO="";queryTag&&(queryTagsForSEO+="queryTag="+queryTag),brand&&(queryTagsForSEO&&(queryTagsForSEO+="&"),queryTagsForSEO+="brand="+brand),brandTag&&(queryTagsForSEO&&(queryTagsForSEO+="&"),queryTagsForSEO+="brandTag="+brandTag),console.log(queryTagsForSEO),$rootScope.$broadcast("$allDataLoaded",{state:$state.current.name,data:queryTagsForSEO}),$scope.stuffsFilterCtrl.queryForDirective=query},$scope.stuffsFilterCtrl.changeFilter=function(c){$anchorScroll();var category=$scope.stuffsFilterCtrl.query.category?$scope.stuffsFilterCtrl.categories.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.category):{name:"category",url:"id"};if(c){$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:category.url,categoryName:category.name,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else{$location.search(""),$scope.stuffsFilterCtrl.query.artikul="",!$scope.stuffsFilterCtrl.query.brand||$scope.stuffsFilterCtrl.brandCollections&&prevBrand==$scope.stuffsFilterCtrl.query.brand?$scope.stuffsFilterCtrl.query.brand||($scope.stuffsFilterCtrl.brandCollections=null,$scope.stuffsFilterCtrl.query.brandTag=""):(_getCollections($scope.stuffsFilterCtrl.query.brand),$scope.stuffsFilterCtrl.query.brandTag=""),$scope.stuffsFilterCtrl.paginate.page=0,$scope.stuffsFilterCtrl.getList($scope.stuffsFilterCtrl.paginate.page,$scope.stuffsFilterCtrl.paginate.rows);var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand();queryTag&&$location.search("queryTag",queryTag),brandTag&&$location.search("brandTag",brandTag),brand&&$location.search("brand",brand),$stateParams.brandTag&&$location.search("brandTag",$stateParams.brandTag)}},$scope.stuffsFilterCtrl.clearFilter=function(){console.log("clear filetrs"),$scope.stuffsFilterCtrl.query.tags=[],$scope.stuffsFilterCtrl.changeFilter()}}]).controller("stuffsLWPCtrl",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll","$timeout",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll,$timeout){var $state=$rootScope.$state;$rootScope.$stateParams;$scope.stuffsLWPCtrl=this,$scope.stuffsLWPCtrl.query=null,$scope.stuffsLWPCtrl.paginate={page:0,rows:20,totalItems:0},$scope.stuffsLWPCtrl.query=null,$scope.stuffsLWPCtrl.getList=function(page,rows){Stuff.getList($scope.stuffsLWPCtrl.query,null,page,rows,$scope.stuffsLWPCtrl.paginate).then(function(res){$scope.stuffsLWPCtrl.items=res,$scope.stuffsLWPCtrl.query=null},function(err){$state.go("404")})},$scope.$watch(function(){return $scope.stuffsLWPCtrl.query},function(n){n&&($scope.stuffsLWPCtrl.paginate.page=0,$scope.stuffsLWPCtrl.getList($scope.stuffsLWPCtrl.paginate.page,$scope.stuffsLWPCtrl.paginate.rows))}),$timeout(function(){$scope.stuffsLWPCtrl.getList($scope.stuffsLWPCtrl.paginate.page,$scope.stuffsLWPCtrl.paginate.rows)}),$scope.getUrlParams=Stuff.getUrlParams,$scope.getCategoryName=Stuff.getCategoryName,$scope.getBrandName=Stuff.getBrandName}]),function(){function stuffService($resource,$uibModal,$q,Sections,$stateParams,$state,$location,Brands,FilterTags,global,$order,exception,$user,$email,CreateContent,$rootScope,Filters,$timeout){function _salePrice(doc,sale){if(doc.driveSalePrice&&doc.driveSalePrice.maxDiscount&&(doc.maxDiscount=doc.driveSalePrice.maxDiscount),doc.driveSalePrice&&0!=doc.driveSalePrice.type){if(2==doc.driveSalePrice.type){doc.priceSale=Math.ceil10(Number(doc.price)-sale*doc.price,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale*doc.stock[key].price,-2)}else if(1==doc.driveSalePrice.type)if(doc.driveSalePrice.condition){sale=doc.driveSalePrice.percent/100,doc.priceSale=Math.ceil10(Number(doc.price)-sale*doc.price,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale*doc.stock[key].price,-2)}else{sale=Number(doc.driveSalePrice.sum),doc.priceSale=Math.ceil10(Number(doc.price)-sale,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale,-2)}}else{doc.priceSale=0;for(var key in doc.stock)doc.stock[key].priceSale=0}}function _retailPrice(doc,retail){if(doc.driveRetailPrice||(global.get("store").val.seller.retail?doc.driveRetailPrice={type:2}:doc.driveRetailPrice={type:0}),0==doc.driveRetailPrice.type){doc.retail=0;for(var key in doc.stock)doc.stock[key].retail=0}else if(2==doc.driveRetailPrice.type){doc.retail=Math.ceil10(Number(doc.price)+retail*Number(doc.price),-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail*doc.stock[key].price,-2)}else if(1==doc.driveRetailPrice.type)if(doc.driveRetailPrice.condition){retail=doc.driveRetailPrice.percent/100,doc.retail=Math.ceil10(Number(doc.price)+retail*doc.price,-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail*doc.stock[key].price,-2)}else{retail=Number(doc.driveRetailPrice.sum),doc.retail=Math.ceil10(Number(doc.price)+retail,-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail,-2)}}function _setPrice(doc){doc||(doc=this),doc.price<0&&(doc.price=0),doc.sort=null;var sale=(global.get("store").val.seller.sale||0)/100,retail=(global.get("store").val.seller.retail||0)/100,el=doc?doc:this;if(el.stock&&"object"==typeof el.stock?el.stock.notag&&(el.stock.notag.price=el.price):(el.stock={notag:{quantity:1,price:el.price}},el.sort="notag"),global.get("currency")&&el.currency&&global.get("store").val.mainCurrency!=el.currency){el.price=Math.ceil10(Number(el.price)/Number(global.get("store").val.currency[el.currency][0]),-2);for(var tag in el.stock)el.stock[tag].price=Math.ceil10(Number(el.stock[tag].price)/Number(global.get("store").val.currency[el.currency][0]),-2)}return _salePrice(el,sale),_retailPrice(el,retail),el}function _changeSortOfStuff(sort){if(this.stock[sort]?this.filterActiveTagName=this.stock[sort].name:this.filterActiveTagName="",!(this.stock&&sort&&this.stock[sort])||this.stock[sort].quantity)if(sort&&(this.sort=sort),this.sort){var sort=this.stock[this.sort];this.sortName=sort.name,this.price=sort.price,this.priceSale=sort.priceSale,this.retail=sort.retail,this.priceCampaign=sort.priceCampaign}else this.sortName=null,this.stock&&this.stock.notag||(this.price=0,this.priceSale=0,this.retail=0)}function _addItemToOrder(){var self=this;if(!this.sort)return this.unableToOrder=!0,$timeout(function(){self.unableToOrder=!1},2500),"nosort";this.sortsOfStuff&&this.sortsOfStuff.filter&&!this.sort?exception.catcher("ошибка")("выберите разновидность"):(this.stock[this.sort].name&&(this.sortName=this.stock[this.sort].name),$order.addItemToCart(this)),$rootScope.$emit("AddToCart")}function _dateTime(){var self=this;if(!this.sort)return this.unableToOrder=!0,$timeout(function(){self.unableToOrder=!1},2500),"nosort";global.get("functions").val.witget("dateTime",{stuff:this})}function _setSticker(stuff){return FilterTags.getSticker(stuff.tags)}function _checkInCart(){return $order.checkInCart(this)}function zoomImgGlobal(i,images,home){var img,horizontalOrient,squareH,squareV,w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),h=Math.max(document.documentElement.clientHeight,window.innerHeight||0),imgs=$("img[src$='"+images[i].img+"']");if(imgs&&imgs[0]?(img=$(imgs[0]),img.width()&&img.height()&&(img.width()>img.height()&&(horizontalOrient=!0),(img.width()===img.height()||img.width()-img.height()<5)&&(w>h?squareH=!0:squareV=!0,horizontalOrient=!1))):(imgs=$("img[src$='"+images[i].thumb+"']"),imgs&&imgs[0]?(img=$(imgs[0]),img.width()&&img.height()&&(img.width()>img.height()&&(horizontalOrient=!0),(img.width()===img.height()||img.width()-img.height()<5)&&(horizontalOrient=!1,
w>h?squareH=!0:squareV=!0))):images[i].el&&images[i].el.width&&images[i].el.height&&(images[i].el.width>images[i].el.height&&(horizontalOrient=!0),(images[i].el.width===images[i].el.height||images[i].el.width-images[i].el.height<5)&&(horizontalOrient=!1,w>h?squareH=!0:squareV=!0))),!delay){delay=!0,$timeout(function(){delay=!1},1e3);var content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no",viewPort=document.getElementById("viewport"),templ=global.get("store").val.template.addcomponents&&global.get("store").val.template.addcomponents.zoom&&global.get("store").val.template.addcomponents.zoom.templ?global.get("store").val.template.addcomponents.zoom.templ:"",templateUrl="views/template/partials/stuffDetail/modal/zoom"+templ+".html";viewPort.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=3"),$rootScope.$emit("modalOpened");var options={animation:!0,bindToController:!0,controllerAs:"$ctrl",windowClass:function(){return squareH?"zoom zoom-modal-squareH":squareV?"zoom zoom-modal-squareV":horizontalOrient?"zoom zoom-modal-horizontal":"zoom zoom-modal-vertical"},templateUrl:templateUrl,controller:function($uibModalInstance,global,gallery,i,home,horizontalOrient){function next(i){delay||(delay=!0,i+1==self.gallery.length?(self.gallery[0].active=!0,self.idx=0):(self.gallery[i+1].active=!0,self.idx=i+1),$timeout(function(){delay=!1},500))}function prev(i){delay||(delay=!0,0==i?(self.gallery[self.gallery.length-1].active=!0,self.idx=self.gallery.length-1):(self.gallery[i-1].active=!0,self.idx=i-1),$timeout(function(){delay=!1},500))}function chancheActiveSlide(i){self.gallery[i].active=!0,self.idx=i}var self=this;self.style=home?horizontalOrient?"width:98vw;height:auto":"height:93vh;width:auto":"width:100%",self.modal=global.get("mobile").val,self.idx=i,self.gallery=angular.copy(gallery),self.gallery[i].active=!0,self.next=next,self.prev=prev,self.chancheActiveSlide=chancheActiveSlide;var delay=!1;self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{gallery:function(){return images},i:function(){return i},home:function(){return home},horizontalOrient:horizontalOrient}};home||(options.size="lg"),$q.when().then(function(){return $uibModal.open(options).result}).then(function(res){viewPort.setAttribute("content",content),$rootScope.$emit("modalClosed")}).catch(function(err){viewPort.setAttribute("content",content),$rootScope.$emit("modalClosed"),err&&"backdrop click"!=err&&(err=err.data||err,exception.catcher("zoom")(err))})}}function _zoomImg(i){zoomImgGlobal(i,this.gallery)}function _setCategoryName(item){if(item.category&&item.category._id&&(item.category=[item.category]),item.category&&item.category.length)for(var i=0,c=null;i<item.category.length&&!c;)"object"==typeof item.category[i]&&(item.category[i]=item.category[i]._id),global.get("categoriesO").val[item.category[i]]&&(c=global.get("categoriesO").val[item.category[i]]),i++;if(global.get("categories").val&&(c||(c=categoriesLink[item.category]?categoriesLink[item.category]:global.get("categories").val.getOFA("_id",item.category)),c?(item.categoryUrl=c.url,item.categoryName=c.name,c.linkData?(item.groupUrl=c.linkData.groupUrl,item.parentGroup=c.linkData.parentGroup||null):(item.groupUrl="group",item.categoryUrl="category",item.parentGroup=null)):(item.groupUrl="group",item.categoryUrl="category")),item.brand&&global.get("brands")&&global.get("brands").val){"object"==typeof item.brand&&(item.brand=item.brand._id);var b=global.get("brands").val.getOFA("_id",item.brand);if(b)if(item.brandUrl=b.url,item.brandName=b.name,item.brandTag&&!item.brandTag._id){var bt=b.tags.getOFA("_id",item.brandTag);bt&&(item.brandTagUrl=bt.url,item.brandTagName=bt.name)}else item.brandTag&&item.brandTag._id&&(item.brandTagUrl=item.brandTag.url,item.brandTagName=item.brandTag.name)}}function _setDataForStuff(stuff,filterTags,stuffsState){if(stuff.changeSortOfStuff=_changeSortOfStuff,stuff.addItemToOrder=_addItemToOrder,stuff.dateTime=_dateTime,stuff.onSelected=_onSelectedSort,stuff.order=_orderStuff,stuff.getBonus=_getBonus,stuff.zoomImg=_zoomImg,stuff.checkInCart=_checkInCart,stuff.getDataForBooking=_getDataForBooking,_setCategoryName(stuff),_setPrice(stuff),stuff.setPrice=_setPrice,stuff.multiple&&stuff.minQty?stuff.quantity=Number(stuff.minQty):(stuff.quantity=1,stuff.minQty=1),stuff.single||(stuff.maxQty=150),stuff.sale||_checkCamapign(stuff),stuff.expected=!0,stuff.stock&&"object"==typeof stuff.stock&&!stuff.stock.notag){if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filterGroup&&global.get("filtersO")&&global.get("filtersO").val&&global.get("filtersO").val[stuff.sortsOfStuff.filterGroup]){var filterGroupTags,filterGroup=global.get("filtersO").val[stuff.sortsOfStuff.filterGroup];if(filterGroup){stuff.sortsOfStuff.name=filterGroup.name.charAt(0).toUpperCase()+filterGroup.name.slice(1).toLowerCase(),stuff.groupName=stuff.sortsOfStuff.name,filterGroupTags=filterGroup.tags.map(function(t){return t._id});for(var ii=0;ii<stuff.tags.length;ii++){var idx=filterGroupTags.indexOf(stuff.tags[ii]);if(idx>-1){stuff.groupTagName=filterGroup.tags[idx].name.charAt(0).toUpperCase()+filterGroup.tags[idx].name.slice(1).toLowerCase();break}}}}if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&global.get("filtersO")&&global.get("filtersO").val&&global.get("filtersO").val[stuff.sortsOfStuff.filter]&&(stuff.filterName=global.get("filtersO").val[stuff.sortsOfStuff.filter].name.toLowerCase(),stuff.filterName=stuff.filterName.charAt(0).toUpperCase()+stuff.filterName.slice(1).toLowerCase()),stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs)for(var i21=0;i21<stuff.sortsOfStuff.stuffs.length;i21++)if(stuff.sortsOfStuff.stuffs[i21]._id!=stuff._id&&stuff.sortsOfStuff.stuffs[i21].archived)stuff.sortsOfStuff.stuffs.splice(i21,1),i21--;else if(stuff.sortsOfStuff.stuffs[i21].stock&&"object"==typeof stuff.sortsOfStuff.stuffs[i21].stock)for(var k in stuff.sortsOfStuff.stuffs[i21].stock)stuff.sortsOfStuff.stuffs[i21].stock[k].quantity&&(stuff.sortsOfStuff.stuffs[i21].stock[k].quantity=Number(stuff.sortsOfStuff.stuffs[i21].stock[k].quantity));var keys=Object.keys(stuff.stock);stuff.stockKeysArray=keys.map(function(k){if(stuff.stock[k].quantity=Number(stuff.stock[k].quantity),global.get("filterTagsO")&&global.get("filterTagsO").val&&global.get("filterTagsO").val[k])var tag=global.get("filterTagsO").val[k];else var tag=filterTags.getOFA("_id",k);return tag?{_id:k,index:tag.index,name:tag.name,quantity:Number(stuff.stock[k].quantity)}:null}).filter(function(key){return key}).sort(function(a,b){return a&&b?a.index-b.index:1});var sort_Id=null;"stuffs.stuff"===$state.current.name&&$stateParams.sort&&$stateParams.stuffUrl===stuff.url&&!stuff.stuffFromList&&keys.indexOf($stateParams.sort)>-1&&(stuff.sort=$stateParams.sort),stuff.stockKeysArray.forEach(function(key){stuff.minPrice||(stuff.minPrice=Number(stuff.stock[key._id].price)),stuff.maxPrice||(stuff.maxPrice=Number(stuff.stock[key._id].price)),Number(stuff.stock[key._id].price)<stuff.minPrice&&(stuff.minPrice=Number(stuff.stock[key._id].price)),Number(stuff.stock[key._id].price)>stuff.maxPrice&&(stuff.maxPrice=Number(stuff.stock[key._id].price)),stuff.stock[key._id].priceSale&&(stuff.minPriceSale||(stuff.minPriceSale=Number(stuff.stock[key._id].priceSale)),stuff.maxPriceSale||(stuff.maxPriceSale=Number(stuff.stock[key._id].priceSale)),Number(stuff.stock[key._id].priceSale)<stuff.minPriceSale&&(stuff.minPriceSale=Number(stuff.stock[key._id].priceSale)),Number(stuff.stock[key._id].priceSale)>stuff.maxPriceSale&&(stuff.maxPriceSale=Number(stuff.stock[key._id].priceSale))),stuff.sort||global.get("sectionType")&&global.get("sectionType").val&&global.get("store").val.template.stuffListType[global.get("sectionType").val].unsetSort&&"stuffs.stuff"==$state.current.name&&!stuffsState||("stuffs"===$state.current.name||"likes"===$state.current.name?global.get("sectionType")&&global.get("sectionType").val&&global.get("store").val.template.stuffListType[global.get("sectionType").val].unsetSortList||!sort_Id&&stuff.stock[key._id].quantity&&(sort_Id=key._id,stuff.sort=sort_Id):!sort_Id&&stuff.stock[key._id].quantity&&(sort_Id=key._id,stuff.sort=sort_Id)),key.quantity=Number(stuff.stock[key._id].quantity),key.quantity&&stuff.expected&&(stuff.expected=!1),key.quantity&&(stuff.multiple&&stuff.minQty?key.quantity=Number(stuff.minQty):("frame.stuffs.stuff"!=$state.current.name&&"frame.stuffs"!=$state.current.name&&(key.quantity=1),stuff.minQty=1)),stuff.stock[key._id].name=key.name,key._id==stuff.sort&&(stuff.filterActiveTagName=stuff.stock[key._id].name)}),stuff.stockKeysArray.length&&sort_Id&&_changeSortOfStuff.call(stuff,sort_Id)}else stuff.stock&&"object"==typeof stuff.stock&&stuff.stock.notag&&(stuff.stock.notag.quantity&&(stuff.sort="notag",stuff.expected=!1),stuff.stockKeysArray=[{name:"notag",_id:"notag",quantity:stuff.stock.notag.quantity}]);if(stuff.campaignId||(stuff.sticker=_setSticker(stuff)),stuff.gallery&&stuff.gallery.length&&stuff.gallery.sort(function(a,b){return a.index-b.index}),!stuffsState&&void 0!==_filtersO&&stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs&&stuff.sortsOfStuff.stuffs.length){var filterGroup,filterGroupTags=[];stuff.sortsOfStuff.filterGroup&&(filterGroup=_filtersO[stuff.sortsOfStuff.filterGroup])&&(filterGroupTags=filterGroup.tags.map(function(t){return t._id})),stuff.sortsOfStuff.stuffs.forEach(function(itemS,i){itemS.gallery.forEach(function(s,ii){s.active=!ii});for(var ii=0;ii<itemS.tags.length;ii++){var idx=filterGroupTags.indexOf(itemS.tags[ii]);if(idx>-1){itemS._id===stuff._id&&(stuff.sortsOfStuff.filterActiveTagName=filterGroup.tags[idx].name),filterGroup.tags[idx].img&&(stuff.sortsOfStuff.stuffs[i].gallery[0].thumbSmallTag=filterGroup.tags[idx].img);break}}})}return stuff}function _onSelectedSort(){setTimeout(function(){$(":focus").blur()},50)}function _orderStuff(){var stuff=this;$order.clearCart(),stuff.cena=stuff.price,stuff.sum=stuff.cena*stuff.quantity,"nosort"!=stuff.addItemToOrder()&&$q.when().then(function(){return $user.getInfo(stuff.service)}).then(function(user){return $order.checkOutFromList(user)}).then(function(){$order.clearCart()}).catch(function(err){$order.clearCart(),err&&exception.catcher("заказ")(err)})}function getAllBonus(){return _getBonus(!0)}function _getBonus(all){var stuffs,stuff=this;return $q.when().then(function(){if(all){return getList({page:0,rows:100},{$and:[{orderType:4},{actived:!0}]})}return[stuff]}).then(function(sts){stuffs=sts}).then(function(){return $user.getInfoBonus()}).then(function(user){if(!user||!user.email)throw"нет email";var content=CreateContent.emailBonus(stuffs),bonus=stuffs&&stuffs[0]&&stuffs[0].imgs&&stuffs[0].imgs[0]&&stuffs[0].imgs[0].name?stuffs[0].imgs[0].name:"получение контента",domain=global.get("store").val.domain,o={email:user.email,content:content,subject:bonus+" ✔",from:"<promo@"+domain+">"};return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note","Сообщение","На Ваш email отправлено письмо"),resolve()},function(err){exception.showToaster("warning","отправка уведомления",err.data),resolve()})})}).then(function(){var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","bonus");pap&&pap.url?$state.go("thanksPage",{id:pap.url}):exception.showToaster("note","Заказ","Все прошло успешно.")}else exception.showToaster("note","Заказ","Все прошло успешно.")}).catch(function(err){err&&exception.catcher("получение бонуса")(err)})}function _checkCamapign(stuff){return $order.checkCampaign(stuff)}function _getDataForBooking(){var el=this,stuff={_id:this._id,artikul:this.artikul,name:this.name,nameL:this.nameL,link:this.link,backgroundcolor:this.backgroundcolor,timePart:el.timePart?el.timePart:4,price:this.price,priceSale:this.priceSale,currency:this.currency};return el.sort&&(stuff.price=el.stock[el.sort].price,stuff.priceSale=el.stock[el.sort].priceSale,stuff.timePart=el.stock[el.sort].timePart?el.stock[el.sort].timePart:4),el.sortName&&(stuff.name=el.name+" "+el.sortName),stuff}function getList(paginate,query,search){function getListComplete(response){0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0);var maxIndex;return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){response.forEach(function(el){99999==el.index&&maxIndex&&el.index--,99999==el.index&&(maxIndex=!0),_setDataForStuff(el,ft)})}).then(function(){return response})}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query,search:search};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function search(search,setData,allStuffs){function getListComplete(response){return setData?$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){response.forEach(function(el){99999==el.index&&maxIndex&&el.index--,99999==el.index&&(maxIndex=!0),_setDataForStuff(el,ft)})}).then(function(){return response}):response}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}var data={search:search,setData:setData,allStuffs:allStuffs};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,o){function getItemComplete(res){return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){return _setDataForStuff(res,ft),res})}function getItemFailed(error){return $q.reject(error)}var query={_id:id};if(o)for(var k in o)query[k]=o[k];return Items.get(query).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/createStuff.html",controller:function($uibModalInstance){var self=this;self.item="",self.ok=function(){$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){item.name?resolve(item):reject()},function(err){reject(err)})})}function getQueryFromUrl(campaignCondition){function setQueryForCampaign(campaign,campaignCondition){var query={};return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){campaignCondition?(campaign.conditionTags&&campaign.conditionTags.length&&(query.queryTags={},campaign.conditionTags.forEach(function(tag){var t=filterTags.getOFA("_id",tag);t&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})),campaign.conditionBrandTags&&campaign.conditionBrandTags.length&&(query.brandTag={$in:campaign.conditionBrandTags}),campaign.conditionBrands&&campaign.conditionBrands.length&&(query.brand={$in:campaign.conditionBrands}),campaign.conditionCategories&&campaign.conditionCategories.length&&(query.category={$in:campaign.conditionCategories}),campaign.conditionStuffs&&campaign.conditionStuffs.length&&(query._id={$in:campaign.conditionStuffs})):(campaign.tags&&campaign.tags.length&&(query.queryTags={},campaign.conditionTags.forEach(function(tag){var t=filterTags.getOFA("_id",tag);t&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})),campaign.brandTags&&campaign.brandTags.length&&(query.brandTag={$in:campaign.brandTags}),campaign.brands&&campaign.brands.length&&(query.brand={$in:campaign.brands}),campaign.categories&&campaign.categories.length&&(query.category={$in:campaign.categories}),campaign.stuffs&&campaign.stuffs.length&&(query._id={$in:campaign.stuffs})),_setQueryForTags(query);var keys=Object.keys(query),q={};if(1==keys.length)q=query;else if(keys.length>1){q.$or=[];for(var k in query){var o={};o[k]=query[k],q.$or.push(o)}}return q.actived=!0,q})}return"campaign.detail"==$state.current.name?$q.when().then(function(){return global.get("campaign").val}).then(function(campaigns){var campaign=campaigns.getOFA("url",$stateParams.id);if(campaign)return setQueryForCampaign(campaign,campaignCondition)}):queryData}function getQuery(stateParams,to){return _setQuery(stateParams,to)}function _setQueryForTags(query,filters){if(query.queryTags&&"object"==typeof query.queryTags){try{var keys=Object.keys(query.queryTags)}catch(err){keys=[]}1==keys.length?query.tags={$in:query.queryTags[keys[0]]}:keys.length>1&&(query.$and=[],keys.forEach(function(k){query.$and.push({tags:{$in:query.queryTags[k]}})}))}if(delete query.queryTags,query.filters&&"object"==typeof query.filters){try{var keys=Object.keys(query.filters)}catch(err){keys=[]}if(1==keys.length){var filter;filters&&(filter=filters.getOFA("_id",keys[0])),filter&&filter.price?(query.priceForFilter=query.filters[keys[0]],console.log("query.filters[keys[0]]",query.filters[keys[0]])):query["filters."+keys[0]]=query.filters[keys[0]]}else if(keys.length>1&&(query.$and||(query.$and=[]),keys.forEach(function(k){var filter;if(filters&&(filter=filters.getOFA("_id",k)),filter&&filter.price)query.priceForFilter=query.filters[k];else{var o={};o["filters."+k]=query.filters[k],query.$and.push(o)}}),1==query.$and.length)){for(var k in query.$and[0])query[k]=query.$and[0][k];delete query.$and}}delete query.filters}function _setQuery(stateParams,to){global.set("category",null);var parentSection,sectionCategories,categoryBrands=[],categoryFilters=[],query={},breadcrumbs=[];return $q(function(resolve,reject){$q.when().then(function(){return $q.all([Sections.getSections(),Brands.getBrands(),Filters.getFilters()])}).then(function(data){var sections=data[0],brands=data[1],filters=data[2];if(parentSection=Sections.getSection(sections,stateParams.groupUrl),global.set("parentSection",parentSection),parentSection)if("category"!=stateParams.categoryUrl){if(!parentSection.categories||!parentSection.categories.length)throw 404;var categorySet;if(parentSection.categories.forEach(function(c){c.url==stateParams.categoryUrl?(global.set("category",c),categorySet=!0,c.set=!0,query.category=c._id,categoryBrands=c.brands,categoryFilters=c.filters):c.set=!1}),!query.category)throw 404}else sectionCategories=Sections.getEmbededCategories(parentSection,[]).map(function(el){return el._id}),sectionCategories.length?(query.category={$in:sectionCategories},sectionCategories.forEach(function(cat){var c=global.get("categoriesO").val[cat];parentSection&&parentSection.filters&&(categoryFilters=parentSection.filters),c.brands.forEach(function(b){categoryBrands.indexOf(b)<0&&categoryBrands.push(b)})})):query.category=null;var brandSet,brandTagSet,brandsArr,brandTagsArr;stateParams.brand&&(brandsArr=stateParams.brand.split("__")),stateParams.brandTag&&(brandTagsArr=stateParams.brandTag.split("__")),query.brand=[],query.brandTag=[],brands.forEach(function(b){b.inList=!1,b.showCollections=!1,"stuffs"==to.name||"stuffs.stuff"==to.name?categoryBrands&&categoryBrands.length&&categoryBrands.indexOf(b._id)>-1&&(b.inList=!0):b.inList=!0,brandsArr&&brandsArr.indexOf(b.url)>-1?(query.brand.push(b._id),b.set=!0,breadcrumbs.push({type:"brand",name:b.name,url:b.url}),brandSet=!0):b.set=!1,b.tags.forEach(function(t){brandTagsArr&&brandTagsArr.indexOf(t.url)>-1?(query.brandTag.push(t._id),t.set=!0,breadcrumbs.push({type:"brandTag",name:t.name,url:t.url}),b.showCollections=!0,brandTagSet=!0):t.set=!1})}),query.brand.length?1==query.brand.length?query.brand=query.brand[0]:query.brand={$in:query.brand}:query.brand=null,query.brandTag.length?1==query.brandTag.length?query.brandTag=query.brandTag[0]:query.brandTag={$in:query.brandTag}:query.brandTag=null,query.brandTag||delete query.brandTag,query.brand||delete query.brand,brandSet||$location.search("brand",null),brandTagSet||$location.search("brandTag",null);var queryTags;stateParams.queryTag&&(queryTags=stateParams.queryTag.split("__"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos})),query.filters={};var filterTags;if(stateParams.filterTag&&(filterTags=stateParams.filterTag.split("__"),filterTags=filterTags.filter(function(item,pos){return filterTags.indexOf(item)==pos}),filterTags=filterTags.map(function(f){return f.split("_")}).filter(function(f){return 3==f.length}).forEach(function(f){query.filters[f[0]]={$gte:Number(f[1]),$lte:Number(f[2])}})),query.queryTags={},filters.forEach(function(f){f.inList=!1,"stuffs"==to.name||"stuffs.stuff"==to.name?categoryFilters.indexOf(f._id)>-1&&(f.inList=!0,f.open=!1):f.inList=!0,categoryFilters&&categoryFilters.length&&categoryFilters.indexOf(f._id)>-1&&(f.inList=!0,f.open=!1),f.count?query.filters[f._id]?(f.open=!0,f.set=!0,f.minValue=query.filters[f._id].$gte,f.maxValue=query.filters[f._id].$lte):(f.minValue=f.min,f.maxValue=f.max):f.tags.forEach(function(t){queryTags&&queryTags.indexOf(t.url)>-1?(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id),f.open=!0,t.set=!0,breadcrumbs.push({type:"queryTag",name:t.name,url:t.url})):t.set=!1})}),_setQueryForTags(query,filters),global.set("breadcrumbs",breadcrumbs),"stuffs"!=to.name&&"stuffs.stuff"!=to.name||(query.actived=!0),stateParams.searchStr){var search=stateParams.searchStr.substring(0,20);query["keywords."+global.get("store").val.lang]=search}resolve(query)}).catch(function(err){reject(err)})})}function setFilters(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/filterStuffsList.html",controller:setFiltersCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"}).result.then(function(){resolve()},function(){reject()})})}function cloneStuff(stuff,clone){if(global.get("seller").val)return $q.when().then(function(){if(stuff&&stuff._id)return Items.get({_id:stuff._id,clone:"clone"}).$promise;if($stateParams&&"category"!=$stateParams.categoryUrl){var category=global.get("categories").val.getOFA("url",$stateParams.categoryUrl);category&&category._id&&(stuff.category=category)}return stuff}).then(function(st){return console.log(st),stuff=angular.copy(st),stuff.category&&!stuff.category.length&&(stuff.category=[stuff.category]),stuff.index||(stuff.index=0),stuff.index++,delete stuff._id,delete stuff.url,delete stuff.link,delete stuff.__v,delete stuff.nameL,delete stuff.artikulL,delete stuff.gallery,delete stuff.sort,delete stuff.sortsOfStuff,delete stuff.keywords,delete stuff.groupStuffs,stuff.blocks&&stuff.blocks.length&&stuff.blocks.forEach(function(b){delete b._id,b.template=null,b.templateName=null,b.img&&(b.img=null),b.video&&(b.video=null),b.imgs&&(b.imgs=[])}),stuff.stock={notag:{price:stuff.price}},stuff.actived=!1,$q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/cloneStuffModal.html",controller:cloneStuffCtrl,controllerAs:"$ctrl",size:"lg",resolve:{stuff:function(){return stuff},clone:function(){return clone}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})})}function saveField(stuff,field){var f=field.split(" "),o={_id:stuff._id};return f.forEach(function(el){o[el]=stuff[el]}),Items.save({update:field},o).$promise}function selectItem(query){return console.log("внимание - сделать так же как и  selectItemWithSort"),$q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffModal.html",controller:selectStuffCtrl,controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}function selectItemWithSort(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffWithSortModal.html",controller:selectItemWithSortCtrl,controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}function selectItems(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffsWithSortModal.html",controller:selectItemsCtrl,controllerAs:"$ctrl",size:"lg"}).result.then(function(stuffs){resolve(stuffs)},function(){reject()})})}function getServicesForOnlineEntry(){function getListComplete(data){data.shift();var items=[];return data.forEach(function(el){_setPrice(el),el.sort=null;var category=el.category&&el.category.length?el.category[0]:el.category;if(global.get("categoriesO")&&global.get("categoriesO").val)var c=global.get("categoriesO").val[category];else var c=global.get("categories").val.getOFA("_id",category);c||(c={name:"Категория"}),el.category=c.name,el.timePart||(el.timePart=4);try{if(el.sortsOfStuff&&el.sortsOfStuff.differentPrice)for(var sort in el.stock){var s={_id:el._id,name:el.name+" "+_getTagName(sort),nameL:el.nameL,link:el.link,artikul:el.artikul,price:el.stock[sort].price,category:el.category,timePart:el.timePart};items.push(s)}else{if(el.stock.notag)el.price=el.stock.notag.price;else try{el.price=el.stock[Object.keys(el.stock)[0]].price}catch(err){console.log(err)}items.push(el)}}catch(err){console.log(err)}}),stuffsService=items,items}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}function _getTagName(_id){return _id&&filterTags&&"notag"!=_id&&_filterTagsO[_id]?_filterTagsO[_id].name:""}if(stuffsService&&stuffsService.length)return stuffsService;var data={query:{orderType:{$in:[2,7]},actived:!0}},filterTags=[];return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(fts){filterTags=fts}).then(function(){return Items.query(data).$promise}).then(getListComplete).catch(getListFailed)}var Items=$resource("/api/collections/Stuff/:_id",{_id:"@_id"}),categoriesLink={},queryData={},stuffsService=[];return $rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){"stuffs"!=to.name&&"stuffs.stuff"!=to.name&&"frame.stuffs"!=to.name&&"frame.stuffs.stuff"!=to.name||$q.when().then(function(){return getQuery(toParams,to)}).then(function(query){queryData=query})}),{Items:Items,query:Items.query,get:Items.get,getList:getList,search:search,getItem:getItem,save:Items.save,delete:Items.delete,create:create,getQuery:getQuery,getQueryFromUrl:getQueryFromUrl,setFilters:setFilters,cloneStuff:cloneStuff,saveField:saveField,selectItem:selectItem,select:selectItem,selectStuffs:selectItems,selectItemWithSort:selectItemWithSort,getServicesForOnlineEntry:getServicesForOnlineEntry,getAllBonus:getAllBonus,zoomImg:zoomImgGlobal,setDataForStuff:_setDataForStuff,getDataForBooking:_getDataForBooking};var delay}function setFiltersCtrl(global,$uibModalInstance){var self=this;self.global=global,self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(){$uibModalInstance.close()}}function cloneStuffCtrl($q,global,Stuff,stuff,$uibModalInstance,Category,clone){var self=this;self.Items=Stuff;self.stuff=stuff,self.clone=clone,self.categoryDisabled=!0,self.selectCategory=function(){$q.when().then(function(){return Category.select()}).then(function(selectedCategory){self.stuff.category||(self.categoryDisabled=!1,setTimeout(function(){$("#createStuffCategory").trigger("change"),self.categoryDisabled=!0},100)),self.stuff.category=selectedCategory}).catch(function(err){console.log(err)})},self.createNewStuff=function(){return self.stuff.category?self.stuff.name?(self.stuff.name=self.stuff.name.substring(0,100),self.stuff.artikul&&(self.stuff.artikul=self.stuff.artikul.substring(0,100)),!self.clone&&self.stuff.category&&self.stuff.category._id&&(self.stuff.category=self.stuff.category._id),stuff.stock&&stuff.stock.notag&&stuff.stock.notag.price!=stuff.price&&(stuff.stock.notag.price=stuff.price),void $q.when().then(function(){self.stuff.keywords={};var k=self.stuff.name;if(self.stuff.artikul&&(k+=" "+self.stuff.artikul),self.stuff.category){var c;if("object"==typeof self.stuff.category){var cc="object"==typeof self.stuff.category[0]?self.stuff.category[0]._id:self.stuff.category[0];c=global.get("categories").val.getOFA("_id",cc)}else c=global.get("categories").val.getOFA("_id",self.stuff.category);k+=" "+(c.nameL&&c.nameL[global.get("store").val.lang]?c.nameL[global.get("store").val.lang]:c.name)}if(self.stuff.brand){var bb="object"==typeof self.stuff.brand?self.stuff.brand._id:self.stuff.brand,b=global.get("brands").val.getOFA("_id",bb);if(k+=" "+(b.nameL&&b.nameL[global.get("store").val.lang]?b.nameL[global.get("store").val.lang]:b.name),self.stuff.brandTag){var bt=b.tags.getOFA("_id",self.stuff.brandTag);bt&&bt.nameL&&bt.nameL[global.get("store").val.lang]&&(k+=" "+bt.nameL[global.get("store").val.lang])}}return stuff.keywords[global.get("store").val.lang]=k,self.Items.save(self.stuff).$promise}).then(function(res){self.stuff._id=res.id,self.stuff.url=res.url;var c;if("object"==typeof self.stuff.category){var cc="object"==typeof self.stuff.category[0]?self.stuff.category[0]._id:self.stuff.category[0];c=global.get("categories").val.getOFA("_id",cc)}else c=global.get("categories").val.getOFA("_id",self.stuff.category);self.stuff.link="/"+c.linkData.groupUrl+"/"+c.linkData.categoryUrl+"/"+res.url,self.Items.save({update:"link"},{_id:self.stuff._id,link:self.stuff.link}),$uibModalInstance.close(self.stuff)}).catch(function(err){return $q.reject(err)})):(self.alertMessage2=!0,void setTimeout(function(){self.alertMessage2=!1},3e3)):(self.alertMessage2=!0,void setTimeout(function(){console.log("))))"),self.alertMessage2=!1},3e3))},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}function selectStuffCtrl($q,Stuff,$uibModalInstance,query){var self=(angular.copy(query),this);self.stuffs=[],self.name="";self.search=function(name){name.length<3||(query?(query.$and||(query={$and:[query]}),query.$and.push({$or:[{name:name},{artikul:name}]})):query={$or:[{name:name},{artikul:name}]},$q.when().then(function(){return Stuff.search(name,!0)}).then(function(res){self.stuffs=res}))},self.selectStuff=function(stuff){stuff.imgThumb&&(stuff.img=stuff.imgThumb),stuff.link="/"+stuff.groupUrl+"/"+stuff.categoryUrl+"/"+stuff.url,$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss()}}function selectItemWithSortCtrl($q,Stuff,$uibModalInstance,Filters,FilterTags,exception,query,global){function getFilterName(_id){return self.filters.getOFA("_id",_id).name||null}var self=(angular.copy(query),this);self.global=global,self.stuffs=[],self.name="";self.getFilterName=getFilterName,self.search=function(name){name.length<3||$q.when().then(function(){return Stuff.search(name,!0)}).then(function(res){global.get("seller")&&global.get("seller").val?self.stuffs=res:self.stuffs=res.map(function(s){for(var i=0;i<s.stockKeysArray.length;i++)s.stockKeysArray[i].quantity||(s.stockKeysArray.splice(i,1),i--);return s}).filter(function(s){return s.actived&&s.stockKeysArray.length})})},self.selectStuff=function(stuff){stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&!stuff.sort?exception.catcher("ошибка")("выберите разновидность"):$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss()},function(){$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){self.filterTags=filterTags}).catch(function(err){console.log(err)})}()}function selectItemsCtrl($q,Stuff,$uibModalInstance,Filters,FilterTags,exception,global){function getFilterName(_id){var o=self.filters.getOFA("_id",_id);return o&&o.name?o.name:""}function deleteStuff(i){self.selectedStuffs.splice(i,1)}var self=this;self.global=global,self.stuffs=[],self.name="";self.selectedStuffs=[],self.deleteStuff=deleteStuff,self.getFilterName=getFilterName,self.search=function(name){name.length<3||$q.when().then(function(){
return Stuff.search(name,!0,!0)}).then(function(res){global.get("seller")&&global.get("seller").val?self.stuffs=res:self.stuffs=res.map(function(s){for(var i=0;i<s.stockKeysArray.length;i++)s.stockKeysArray[i].quantity||(s.stockKeysArray.splice(i,1),i--);return s}).filter(function(s){return s.actived&&s.stockKeysArray.length})})},self.addStuff=function(stuff){if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&!stuff.sort)exception.catcher("ошибка")("выберите разновидность");else{for(var i=0;i<self.selectedStuffs.length;i++)if(self.selectedStuffs[i]._id===stuff._id&&self.selectedStuffs[i].sort===stuff.sort)return exception.catcher("ошибка")("уже добавлен");var o={_id:stuff._id,name:stuff.name,artikul:stuff.artikul,sort:stuff.sort,sortName:stuff.sortName};self.selectedStuffs.push(o)}},self.done=function(){$uibModalInstance.close(self.selectedStuffs)},self.cancel=function(){$uibModalInstance.dismiss()},function(){$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){self.filterTags=filterTags}).catch(function(err){console.log(err)})}()}function commentService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/createComment.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Comment/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Stuff",stuffService).service("Comments",commentService),stuffService.$inject=["$resource","$uibModal","$q","Sections","$stateParams","$state","$location","Brands","FilterTags","global","$order","exception","$user","$email","CreateContent","$rootScope","Filters","$timeout"],setFiltersCtrl.$inject=["global","$uibModalInstance"],cloneStuffCtrl.$inject=["$q","global","Stuff","stuff","$uibModalInstance","Category","clone"],selectStuffCtrl.$inject=["$q","Stuff","$uibModalInstance","query"],selectItemWithSortCtrl.$inject=["$q","Stuff","$uibModalInstance","Filters","FilterTags","exception","query","global"],selectItemsCtrl.$inject=["$q","Stuff","$uibModalInstance","Filters","FilterTags","exception","global"],commentService.$inject=["$resource","$uibModal","$q"]}(),function(){function likesItem(){return{scope:{},bindToController:!0,controller:likesItemCtrl,controllerAs:"$ctrl",templateUrl:"",restrict:"E"}}function likesItemCtrl($compile,$timeout,localStorage,Stuff,global){return{restrict:"EA",scope:{current:"=",header:"@",mobile:"@",blockElement:"@"},template:'<h3 class="text-center" ng-bind="header"></h3><div id="lastViewedWrapper" class="owl-carousel owl-theme"><div ng-repeat="s in stuffs track by $index" class="item"><a ui-sref="stuffs.stuff(s.linkData)"><img style="max-width: 200px; border-color: transparent" ng-src="{{s.img}}" ></a></div></div>',link:function(scope,element,attrs){function activate(){scope.position=JSON.parse(scope.blockElement).position,scope.mobile?scope.itemsInList=3:scope.position&&"bottom"==scope.position&&(scope.itemsInList=6),setViewed(angular.copy(scope.current)),viewedStuffs.length>2?(scope.stuffs=viewedStuffs,scope.stuffs.forEach(function(el){el.getUrlParams=Stuff.getUrlParams}),$timeout(function(){$("#lastViewedWrapper").owlCarousel({items:scope.itemsInList,itemsMobile:[479,3],itemsTablet:[768,scope.itemsInList],itemsDesktop:[1199,scope.itemsInList],itemsDesktopSmall:[979,scope.itemsInList]})},150)):scope.stuffs=[],scope.header||(scope.header="Последние просмотренные.")}function setViewed(stuff){for(var posItem=-1,i=0,l=viewedStuffs.length;i<l;i++)if(viewedStuffs[i]._id==stuff._id){posItem=i;break}if(posItem>-1&&viewedStuffs.splice(posItem,1),stuff.gallery[0])var img=stuff.gallery[0].thumbSmall?stuff.gallery[0].thumbSmall:stuff.gallery[0].thumb;else var img=null;var linkData=global.get("categories").val.getOFA("_id",stuff.category).linkData;linkData.stuffUrl=stuff.url,viewedStuffs.unshift({_id:stuff._id,linkData:linkData,url:stuff.url,img:img}),viewedStuffs.length>15&&viewedStuffs.splice(15,1),localStorage.set(subDomain+"-viewed",viewedStuffs)}var subDomain=global.get("store").val.subDomain;scope.localId=Date.now();var viewedStuffs=localStorage.get(subDomain+"-viewed");viewedStuffs||(viewedStuffs=[]),scope.itemsInList=4,scope.$watch("current",function(n){n&&activate()}),scope.$on("$destroy",function(){$("#carouse"+scope.localId).remove()})}}}function homePageHtmlCtrl($scope,$rootScope,$timeout,$element,$compile,global,$q,$http){function getHomePageHtml(){console.log("getHomePageHtml"),$q.when().then(function(){return $http.get("homepageHTML.html")}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content),loaded=!0}).catch(function(err){})}var loaded=null;$rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){"home"!=to.name||loaded||getHomePageHtml()})}function homePageStuffOwlCtrl($scope,$timeout,$element,$compile,global){function prev(){self.$owl.trigger("prev.owl.carousel",[self.selectedDay-3,300])}function next(){self.$owl.trigger("next.owl.carousel",[self.selectedDay+3,300])}function zoomSliderImg(i){$rootScope.zoomSliderImg(i,imgs)}var self=this;self.prev=prev,self.next=next,self.moment=moment,self.global=global;var imgs;self.zoomSliderImg=zoomSliderImg;var items=4,items3=3,items2=2,autoplay=!1,autoplayTimeout=4e3;this.$onInit=function(){$timeout(function(){if(self.items&&(items=self.items),2==items?items3=2:1==items&&(items3=1,items2=1),self.autoplay&&(autoplay=!0),self.duration)try{var duration=Number(self.duration);duration>0&&duration<10&&(autoplayTimeout=1e3*duration)}catch(err){console.log(err)}self.$owl=$("body").find("#"+self.homePageStuffOwl),self.$owl.on("initialized.owl.carousel",function(event){});var navLeft=$element.find(".nav-left");$(navLeft).click(function(){prev()});var navRight=$element.find(".nav-right");$(navRight).click(function(){next()}),activate()},100)},$scope.$watch(function(){return self.gallery},function(n,o){if(n&&n.length){var html="";imgs=[],n.forEach(function(item,i){photoHost?item.src=photoHost+"/"+item.img:item.src=item.img,html+='<a><span class="zoom-plus" data-i="'+i+'"><span class="icon-zoom-img"></span><span class="icon-zoom-inverse"></span></span><img class="img-responsive2" src="'+item.src+'"></a>'+imgs.push({index:i,img:item.src})}),self.$owl.trigger("replace.owl.carousel",html).trigger("to.owl.carousel",0).trigger("refresh.owl.carousel"),$timeout(function(){self.$owl.trigger("refresh.owl.carousel")},10),$timeout(function(){if(self.zoomImg){self.$owl.find("span.zoom-plus").each(function(i,img){$(img).click(function(event){var ii=$(img).data("i")>=0?$(img).data("i"):0;global.get("functions").val.zoomImg(ii,imgs,"home")})})}},400)}});var items=self.items?self.items:4,activate=function(){$timeout(function(){var carousel_Settings={loop:!0,margin:10,responsiveClass:!0,autoplay:autoplay,autoplayHoverPause:!0,autoplayTimeout:autoplayTimeout,responsive:{0:{items:1,nav:!1,dots:!0},380:{items:items2,nav:!1,dots:!0},1068:{items:items3,nav:!1,dots:!0},1400:{items:items,nav:!1,dots:!0}}};self.$owl.owlCarousel(carousel_Settings);var imgsEl=self.$owl.find("img");if(imgsEl&&imgsEl.each&&(imgs=[],imgsEl.each(function(i,img){imgs.push({index:i,img:img.src,el:imgsEl[i]})})),self.zoomImg){self.$owl.find("span.zoom-plus").each(function(i,img){$(img).click(function(event){for(var imgTemp=imgs[i].img,imgsTemp=imgs.reduce(function(o,item){return o.getOFA("img",item.img)||o.push(item),o},[]),ii=0,j=0;j<imgsTemp.length;j++)if(imgsTemp[j].img==imgTemp){ii=j;break}global.get("functions").val.zoomImg(ii,imgsTemp,"home")})})}},200)}}function emptyList(){return{templateUrl:"views/template/partials/stuffs/emptyList.html",restrict:"E"}}function stuffListDirective(){return{scope:{},bindToController:!0,controller:stuffListCtrl,controllerAs:"$ctrl",templateUrl:"components/stuff/stuffsAdminList.html",restrict:"E"}}function stuffListTemplateDirective(global){return{scope:{filtersBlock:"@"},bindToController:!0,controller:stuffListCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/stuffs/stuffs-block.html",restrict:"E"}}function stuffListTemplateDirectiveList(global){return{scope:{},bindToController:!0,controller:stuffListCtrl,controllerAs:"$ctrl",templateUrl:function(){return"views/template/partials/stuffs/stuffs-list/"+global.get("sectionType").val},restrict:"E"}}function stuffInList(global,$timeout){return{scope:{stuffInList:"@"},bindToController:!0,controllerAs:"$ctrl",restrict:"A",controller:function($scope,Stuff,global,$attrs,$stateParams,$rootScope,localStorage){function getAveragePrice(price){if(price){var p=price*global.get("rate").val;return p=Math.round(100*p)/100,formatAverage&&(4==formatAverage?p=100*Math.round(p/100):3==formatAverage?p=10*Math.round(p/10):2==formatAverage?p=Math.round(p):1==formatAverage&&(p=Math.round(10*p)/10)),p}}function getMastersName(){self.stuff.masters=[],global.get("masters").val.forEach(function(m){if(m.stuffs&&m.stuffs.length&&m.stuffs.indexOf(self.stuff._id)>-1){var o={name:m.name,url:m.url};self.stuff.masters.push(o)}})}function addToLikes($event){$event.stopPropagation(),console.log("addToLikes"),(likes=localStorage.get(subDomain+"-likes"))||(likes=[]);var i=likes.indexOf($scope.stuff._id);i>-1?($scope.stuff.inLikes=!1,likes.splice(i,1)):($scope.stuff.inLikes=!0,likes.push($scope.stuff._id)),localStorage.set(subDomain+"-likes",likes),$rootScope.likes.totalCount=likes.length}var self=this;self.global=global,$scope.global=global;var subDomain=global.get("store").val.subDomain;if($scope.stuff=JSON.parse($attrs.stuffInList),$scope.stuff=Stuff.setDataForStuff($scope.stuff,global.get("filterTags").val,"stuffs"),$scope.stuff.sortsOfStuff&&$scope.stuff.sortsOfStuff.filterGroup&&global.get("filtersO").val[$scope.stuff.sortsOfStuff.filterGroup])for(var ttt,i=0;i<$scope.stuff.tags.length;i++)if(ttt=global.get("filtersO").val[$scope.stuff.sortsOfStuff.filterGroup].tags.getOFA("_id",$scope.stuff.tags[i])){$scope.stuff.tagFromFilterFromSortOfStuffs=ttt;break}$scope.stuff.stateObj=angular.copy($stateParams),$scope.stuff.stateObj.stuffUrl=$scope.stuff.url,self.stuff=$scope.stuff,self.getMastersName=getMastersName,self.getAveragePrice=getAveragePrice,self.addToLikes=addToLikes;var currency=global.get("currency").val,formatAverage=global.get("store").val.currency[currency][4],del=-1;1==formatAverage?del=-1:2==formatAverage?del=0:3==formatAverage?del=1:4==formatAverage&&(del=2),self.formatPrice=global.get("store").val.currency[currency][5],void 0===self.formatPrice&&(self.formatPrice=2),self.stuff.currencySymbol=global.get("store").val.currency[global.get("currency").val]&&global.get("store").val.currency[global.get("currency").val][2]?global.get("store").val.currency[global.get("currency").val][2]:"",$rootScope.$on("changeCurrency",function(){currency=global.get("currency").val,formatAverage=global.get("store").val.currency[currency][4],self.formatPrice=global.get("store").val.currency[currency][5],void 0===self.formatPrice&&(self.formatPrice=2),del=-1,1==formatAverage?del=-1:2==formatAverage?del=0:3==formatAverage?del=1:4==formatAverage&&(del=2),self.stuff.currencySymbol=global.get("store").val.currency[global.get("currency").val]&&global.get("store").val.currency[global.get("currency").val][2]?global.get("store").val.currency[global.get("currency").val][2]:global.get("currency").val}),getMastersName();var likes=localStorage.get(subDomain+"-likes");likes&&likes.length&&likes.some(function(s){return s===$scope.stuff._id})&&($scope.stuff.inLikes=!0)},transclude:!0,link:function(scope,element,attrs,ctrl,transclude){$timeout(function(){global.get("stuffsInList").val&&element[0].parentElement&&element[0].parentElement.parentElement&&element[0].parentElement.parentElement.id&&global.get("stuffsInList").val[element[0].parentElement.parentElement.id]&&global.get("stuffsInList").val[element[0].parentElement.parentElement.id].push(scope.stuff)},200),transclude(scope,function(clone){element.append(clone)})}}}function stuffListTemplateServer(){return{scope:{},bindToController:!0,controllerAs:"$ctrl",template:"<div></div>",controller:stuffListFromServerCtrl,restrict:"E"}}function stuffListFromServerCtrl($scope,$state,$compile,$element,$window,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,Helper,anchorSmoothScroll,Photo,$timeout,$anchorScroll,Category,Brands,BrandTags,seoContent,AddInfo,$http,$location,$sce){function filterList(){console.log("filterList22"),$q.when().then(function(){return self.Items.setFilters()}).catch(function(err){})}function setDataForStuff(stuff){return stuff=Stuff.setDataForStuff(stuff,global.get("filterTags").val),stuff=angular.copy(stuff),console.log(stuff.name+" "+stuff.artikul,stuff.sticker),stuff}function getList(){$q.when().then(function(){return $http.get(url.trim()+".html",{params:{pages:[self.paginate.page],perPage:perPage,rows:rows,query:self.query,url:$location.url()}})}).then(function(response){if(response){$anchorScroll(),lastElement=null;var addHtml=angular.element(response.data.html);if(addHtml.find("#td-list-1").html()){var atd1=$compile(addHtml.find("#td-list-1").html())($scope);td1.html(atd1)}if(addHtml.find("#td-list-2").html()){var atd2=$compile(addHtml.find("#td-list-2").html())($scope);td2.html(atd2)}if(addHtml.find("#td-list-3").html()){var atd3=$compile(addHtml.find("#td-list-3").html())($scope);td3.html(atd3)}if(addHtml.find("#td-list-4").html()){var atd4=$compile(addHtml.find("#td-list-4").html())($scope);td4.html(atd4)}self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null},200)}})}var stuffsInList={"td-list-1":[],"td-list-2":[],"td-list-3":[],"td-list-4":[],"td-list-5":[],"td-list-6":[]};global.set("stuffsInList",stuffsInList);var self=this;$scope.global=global,global.get("category").val&&global.get("category").val.filters&&global.get("category").val.filters.length?self.displayableFilters=!0:global.get("section").val&&global.get("section").val.filters&&global.get("section").val.filters.length&&(self.displayableFilters=!0),self.stuffs={},self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.globalProperty=$rootScope.globalProperty,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.paginate={page:0,rows:20,items:0},self.filterList=filterList,self.initStuff=setDataForStuff,self.getList=getList,$scope.$on("addBlockAfterScroll",function(){$scope.addBlockAfterScroll()});var pages=[0],perPage=20,rows=global.get("functions").val.setRows();global.get("store").val.template.stuffListType[global.get("sectionType").val]&&global.get("store").val.template.stuffListType[global.get("sectionType").val].perPage&&(perPage=global.get("store").val.template.stuffListType[global.get("sectionType").val].perPage,self.paginate.rows=perPage);var waiting,lastElement,waitingDiv,td1,td2,td3,td4,td5,url="views/template/partials/stuffs/stuffs-list/"+global.get("sectionType").val+"/"+$rootScope.$stateParams.groupUrl+"/"+$rootScope.$stateParams.categoryUrl,page=0,innerWaitingDiv=['<div class="spinner-box clearfix text-center" style="width:100%;height:100px;">','<span class="icon-spinner-img"></span>',"</div>"].join("");$q.when().then(function(){var params={group:self.$stateParams.groupUrl,category:self.$stateParams.categoryUrl};self.$stateParams.brand,self.$stateParams.brandTag;for(var k in self.$stateParams)params[k]=self.$stateParams[k];if(self.query=dQ.getQuery(params),self.query&&self.query.priceForFilter&&1!=global.get("rate").val&&(self.query.priceForFilter.$gte=Math.ceil10(self.query.priceForFilter.$gte/global.get("rate").val,0),self.query.priceForFilter.$lte=Math.ceil10(self.query.priceForFilter.$lte/global.get("rate").val,0)),global.get("tempContent").val){if($state.current.name.indexOf(".stuff")<0){var html=$("#tempContent").detach().html(),o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}return null}return $q.when(self.query).then(function(query){return $http.get(url.trim()+".html",{params:{pages:pages,perPage:perPage,rows:rows,query:query,url:$location.url()}})})}).then(function(response){if(!response)return void $rootScope.$emit("$stateChangeEndToStuff");if(global.get("tempContent").val){global.set("tempContent",null);var linkFn=$compile(response.data.html),content=linkFn($scope)}else var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content);var style=$element.find("style");style&&style[0];var titles={};if(response.data.titles&&response.data.titles.title){for(var k in response.data.titles)response.data.titles[k]&&("canonical"==k?titles[k]=$sce.trustAsResourceUrl(response.data.titles[k]):"desc"!=k&&(titles[k]=response.data.titles[k]));global.set("titles",titles)}else seoContent.setSeopageData();waitingDiv=$("#paginateData"+page),self.totalQty=waitingDiv.data("total"),self.paginate.items=self.totalQty,self.currentQty=waitingDiv.data("qty"),self.page=waitingDiv.data("page"),self.lastItemId=waitingDiv.data("lastItemId"),td1=$("#td-list-1 .td-wrapper"),td2=$("#td-list-2 .td-wrapper"),td3=$("#td-list-3 .td-wrapper"),td4=$("#td-list-4 .td-wrapper"),td5=$("#td-list-5 .td-wrapper"),$timeout(function(){$anchorScroll(),lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null}),$timeout(function(){$scope.$broadcast("rzSliderForceRender")},500);var addBlockAfterScroll=function(){"stuffs"==$state.current.name&&!waiting&&lastElement&&$(lastElement).isOnScreen()&&self.currentQty<self.totalQty&&(waiting=!0,page++,$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url.trim()+".html",{params:{pages:[page],perPage:perPage,rows:rows,query:self.query,url:$location.url()}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200)}}))};global.get("store").val.template.stuffListType[global.get("sectionType").val]&&global.get("store").val.template.stuffListType[global.get("sectionType").val].paginate||angular.element($window).on("scroll",addBlockAfterScroll),$scope.$on("$destroy",function(){angular.element($window).off("scroll",addBlockAfterScroll)}),$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")})}),$scope.addBlockAfterScroll=function(){!waiting&&lastElement&&self.currentQty<self.totalQty?(waiting=!0,page++,$rootScope.$emit("$stateChangeStartToStuff"),$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url.trim()+".html",{params:{pages:[page],perPage:perPage,rows:rows,query:self.query,url:$location.url()}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200),$timeout(function(){$rootScope.$broadcast("addBlockAfterScrollDone"),$rootScope.$emit("$stateChangeEndToStuff")},300)}}).catch(function(){$rootScope.$emit("$stateChangeEndToStuff")})):$timeout(function(){$rootScope.$broadcast("addBlockAfterScrollDone")},200)}}function stuffListTemplateDirectiveCampaignList($state,global){return{scope:{campaignCondition:"@"},bindToController:!0,controller:campaignStuffListCtrl,controllerAs:"$ctrl",template:function(){if("likes"===$state.current.name)var s="<div><h1 class='wishlist-header'>"+global.get("lang").val.wishlist+"</h1></div>";else var s="<div></div>";return s},restrict:"E"}}function campaignStuffListCtrl($scope,$state,$compile,$element,$window,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,Helper,anchorSmoothScroll,Photo,$timeout,$anchorScroll,Category,Brands,BrandTags,seoContent,AddInfo,$http,$location,localStorage){function filterList(){$q.when().then(function(){return self.Items.setFilters()}).catch(function(err){})}function setDataForStuff(stuff){return console.log(stuff.name),stuff=Stuff.setDataForStuff(stuff,global.get("filterTags").val),stuff=angular.copy(stuff),console.log(stuff.name+" "+stuff.artikul,stuff.sticker),stuff}function getList(){$q.when().then(function(){return $http.get(url,{params:{pages:[self.paginate.page],perPage:self.paginate.rows,rows:rows}})}).then(function(response){if(response){$anchorScroll(),lastElement=null;var addHtml=angular.element(response.data.html);if(addHtml.find("#td-list-1").html()){var atd1=$compile(addHtml.find("#td-list-1").html())($scope);td1.html(atd1)}if(addHtml.find("#td-list-2").html()){var atd2=$compile(addHtml.find("#td-list-2").html())($scope);td2.html(atd2)}if(addHtml.find("#td-list-3").html()){var atd3=$compile(addHtml.find("#td-list-3").html())($scope);td3.html(atd3)}if(addHtml.find("#td-list-4").html()){var atd4=$compile(addHtml.find("#td-list-4").html())($scope);td4.html(atd4)}self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null},200)}})}anchorSmoothScroll.scrollTo("topPage");var stuffsInList={"td-list-1":[],"td-list-2":[],"td-list-3":[],"td-list-4":[],"td-list-5":[],"td-list-6":[]};global.set("stuffsInList",stuffsInList);var self=this;self.stuffs={},self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.globalProperty=$rootScope.globalProperty,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.paginate={page:0,rows:20,items:0};var cartType=$element.data("cart")?$element.data("cart"):"good",campaignCondition=$element.data("condition")?$element.data("condition"):"stuffs";self.filterList=filterList,self.initStuff=setDataForStuff,self.getList=getList,$scope.$on("addBlockAfterScroll",function(){$scope.addBlockAfterScroll()});var pages=[0],perPage=20,rows=global.get("functions").val.setRows();global.get("store").val.template.stuffListType[cartType]&&global.get("store").val.template.stuffListType[cartType].perPage&&(perPage=global.get("store").val.template.stuffListType[cartType].perPage,self.paginate.rows=perPage);var waiting,lastElement,waitingDiv,td1,td2,td3,td4,td5,page=0,innerWaitingDiv=['<div class="spinner-box clearfix text-center" style="width:100%;height:200px;">','<span class="icon-spinner-img"></span>',"</div>"].join(""),campaign=$element.data("campaign");if("likes"===$rootScope.$state.current.name){campaign="likes";var likes=localStorage.get(global.get("store").val.subDomain+"-likes");campaignCondition=likes&&likes.length?likes.join("_"):"_"}var url="views/template/partials/"+campaign+"/"+campaignCondition;console.log(url),$q.when().then(function(){return $http.get(url,{params:{pages:pages,perPage:perPage,rows:rows}})}).then(function(response){if(!response)return void $rootScope.$emit("$stateChangeEndToStuff");var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content);var style=$element.find("style");style&&style[0],waitingDiv=$("#paginateData"+page),self.totalQty=waitingDiv.data("total"),self.paginate.items=self.totalQty,self.currentQty=waitingDiv.data("qty"),self.page=waitingDiv.data("page"),self.lastItemId=waitingDiv.data("lastItemId"),td1=$("#td-list-1 .td-wrapper"),td2=$("#td-list-2 .td-wrapper"),td3=$("#td-list-3 .td-wrapper"),td4=$("#td-list-4 .td-wrapper"),td5=$("#td-list-5 .td-wrapper"),$timeout(function(){$anchorScroll(),lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null});var addBlockAfterScroll=function(){!waiting&&lastElement&&$(lastElement).isOnScreen()&&self.currentQty<self.totalQty&&(waiting=!0,page++,$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url,{params:{pages:[page],perPage:perPage,rows:rows}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200)}}))};global.get("store").val.template.stuffListType[cartType]&&global.get("store").val.template.stuffListType[cartType].paginate||angular.element($window).on("scroll",addBlockAfterScroll),$scope.$on("$destroy",function(){angular.element($window).off("scroll",addBlockAfterScroll)}),$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")})}),$scope.addBlockAfterScroll=function(){!waiting&&lastElement&&self.currentQty<self.totalQty&&(waiting=!0,page++,$rootScope.$emit("$stateChangeStartToStuff"),$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url,{params:{pages:[page],perPage:perPage,rows:rows}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200),$timeout(function(){$rootScope.$broadcast("addBlockAfterScrollDone"),$rootScope.$emit("$stateChangeEndToStuff")},300)}}).catch(function(){$rootScope.$emit("$stateChangeEndToStuff")}))}}function stuffListCtrl($scope,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,Helper,anchorSmoothScroll,Photo,$timeout,$anchorScroll,Category,Brands,BrandTags,seoContent,AddInfo,$http,$location,$element){function getList(reload){if(reload&&$rootScope.$emit("$stateChangeStartToStuff"),self.listCriteria&&!$rootScope.$stateParams.searchStr)for(var k in self.listCriteria)null!==self.listCriteria[k]?self.query[k]=self.listCriteria[k]:delete self.query[k];return self.Items.getList(self.paginate,self.query).then(function(data){return $anchorScroll(),self.items=data,data.length&&(self.maxIndex=data[0].index,data.forEach(function(el,i){el.index>self.maxIndex&&(self.maxIndex=el.index)})),"stuffs.stuff"==self.$state.current.name&&self.paginate.page&&(console.log(":::::"),self.$state.go("stuffs",self.$stateParams)),self.items}).then(function(items){items&&items.length?$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")},100):(self.stateComplite=!0,$rootScope.$emit("$stateChangeEndToStuff"))}).catch(function(err){err=err.data||err,exception.catcher("получение списка")(err)})}function setRows(){return global.get("functions").val.setRows?global.get("functions").val.setRows():2}function filteringList(item){return!self.filterStr||item.name.toLowerCase().indexOf(self.filterStr.toLowerCase())!=-1||item.artikul.toLowerCase().indexOf(self.filterStr.toLowerCase())!=-1}function searchItem(artikul){if(artikul&&!(artikul.length<3)){artikul=artikul.substring(0,20),self.$state.current.reloadOnSearch=!0;var o={groupUrl:"group",categoryUrl:"category",searchStr:artikul.substring(0,20),queryTag:null,brand:null,brandTag:null,categoryList:null};self.$state.go(self.$state.current.name,o,{reload:!0})}}function saveField(item,field,defer){var o={_id:item._id};if(o[field]=item[field],"name"==field||"artikul"==field){var lang=global.get("store").val.lang,k=item.name;if(item.artikul&&(k+=" "+item.artikul),item.category&&item.category[0]&&global.get("categoriesO").val&&global.get("categoriesO").val[item.category[0]]&&global.get("categoriesO").val[item.category[0]].nameL&&(k+=" "+global.get("categoriesO").val[item.category[0]].nameL[lang]),item.brand&&global.get("brands").val){var id=item.brand._id?item.brand._id:item.brand,b=global.get("brands").val.getOFA("_id",id);if(k+=" "+(b.nameL&&b.nameL[lang]?b.nameL[lang]:b.name),item.brandTag){
var bt=b.tags.getOFA("_id",item.brandTag);bt&&bt.nameL&&bt.nameL[lang]&&(k+=" "+bt.nameL[lang])}}item.keywords||(item.keywords={}),item.keywords[lang]=k,field+=" keywords."+lang,o["keywords."+lang]=k}return"archived"==field&&item[field]&&(field+=" actived",o.actived=!1,item.actived=!1),self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}function createItem(stuff,clone){stuff||(stuff={name:""},stuff.index=self.items&&self.items[0]&&self.items[0].index?self.items[0].index:0),$q.when().then(function(){return self.Items.cloneStuff(stuff,clone)}).then(function(stuff){self.newStuff=stuff}).then(function(){var url=self.newStuff.url;global.get("categoriesO").val[self.newStuff.category];self.$state.go("frame.stuffs.stuff",{groupUrl:self.$stateParams.groupUrl,categoryUrl:self.$stateParams.categoryUrl,stuffUrl:url})}).catch(function(err){err&&(err=err.data||err,exception.catcher("создание товара")(err),console.log(err))})}function filterList(){$q.when().then(function(){return self.Items.setFilters()}).catch(function(err){})}function getTagName(_id){if(_id&&self.filterTags&&"notag"!=_id&&self.filterTags.length)return self.filterTags.getOFA("_id",_id).name||null}function getFilterName(_id){if(_id&&self.filters){var filter=self.filters.getOFA("_id",_id);return filter?filter.name:""}}function deleteItem(stuff){var folder="images/"+global.get("store").val.subDomain+"/Stuff/"+stuff.url;Confirm("Удалить?").then(function(){return self.whileActions=!0,Stuff.delete({_id:stuff._id}).$promise}).then(function(){return self.getList(!0)}).then(function(){return self.whileActions=null,Photo.deleteFolder("Stuff",folder)}).catch(function(err){self.whileActions=null,(err=err&&err.data||err)&&exception.catcher("удаление товара")(err)})}function zoomImg(stuff){if(stuff.gallery&&stuff.gallery.length){var options={animation:!0,bindToController:!0,controllerAs:"$ctrl",templateUrl:"views/template/partials/stuffDetail/modal/zoom.html",controller:function($uibModalInstance,gallery,i){var self=this;self.gallery=gallery,self.idx=i,self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{gallery:function(){return stuff.gallery},i:function(){return 0}}};$uibModal.open(options)}}function markAllStuffs(m){self.items.forEach(function(el){el.select=m})}function selectCategory(){var acts=[];return $q.when().then(function(){return Category.select()}).then(function(item){return self.items.forEach(function(el){el.select&&("object"==typeof el.category?el.category[0]=item._id:el.category=[item._id],acts.push(saveField(el,"category")))}),$q.all(acts)}).then(function(){getList(0)})}function selectBrand(){return $q.when().then(function(){return Brands.select()}).then(function(item){var o={};o.brand=item?item._id:null,o.brandTag=null,massSaveField(o)})}function selectBrandTag(){return $q.when().then(function(){return BrandTags.select()}).then(function(item){var o={};item?(o.brand=item.brand._id,o.brandTag=item._id):o.brandTag=null,massSaveField(o)})}function selectFilterTag(){var acts=[];return $q.when().then(function(){return FilterTags.select()}).then(function(item){var tag=item._id;self.items.forEach(function(el){if(el.select){el.select=!1;el.tags.indexOf(tag)<0&&(el.tags.push(tag),acts.push(saveField(el,"tags")))}})}).then(function(){return $q.all(acts)})}function unSelectFilterTag(){var acts=[];return $q.when().then(function(){return FilterTags.select()}).then(function(item){var tag=item._id;self.items.forEach(function(el){if(el.select){el.select=!1;var k=el.tags.indexOf(tag);k>-1&&(el.tags.splice(k,1),acts.push(saveField(el,"tags")))}})}).then(function(){return $q.all(acts)})}function selectAddInfo(){return $q.when().then(function(){return AddInfo.select()}).then(function(item){massSaveField({addInfo:item._id})})}function selectActived(){var options={animation:!0,templateUrl:"components/stuff/modal/selectActivedModal.html",bindToController:!0,controller:selectActivedCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(actived){massSaveField({actived:actived}).then(function(){getList(0)})})}function selectActivedCtrl($uibModalInstance){var self=this;self.actived=!1,self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.actived)}}function selectPosition(){if(self.items.length){var options={animation:!0,templateUrl:"components/stuff/modal/selectPositionModal.html",bindToController:!0,controller:selectPositionCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(position){if("down"==position){var minIndex=Number(self.items[self.items.length-1].index)-1;self.items.forEach(function(el){if(el.select){var i=minIndex--;el.index=i,saveField(el,"index")}})}else if("up"==position){var minIndex=Number(self.items[0].index)+1;self.items.forEach(function(el){if(el.select){var i=minIndex++;el.index=i,saveField(el,"index")}})}self.items.sort(function(a,b){return b.index-a.index})})}}function selectPositionCtrl($uibModalInstance){var self=this;self.position="up",self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.position)}}function changeOrderType(){var options={animation:!0,templateUrl:"components/stuff/modal/orderTypeModal.html",bindToController:!0,controller:orderTypeCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(orderType){massSaveField({orderType:orderType})})}function orderTypeCtrl($uibModalInstance){var self=this;self.orderType=0,self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.orderType)}}function changeMinMax(){var options={animation:!0,templateUrl:"components/stuff/modal/changeMinMaxModal.html",bindToController:!0,controller:changeMinMaxCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(item){massSaveField(item)})}function changeMinMaxCtrl($uibModalInstance){var self=this;self.item={minQty:1,maxQty:1,single:!1,multiple:!1},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.item)}}function changePrice(){var options={animation:!0,templateUrl:"components/stuff/modal/changePriceModal.html",bindToController:!0,controller:changePriceCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(item){item.ids=self.items.filter(function(el){return el.select}).map(function(el){return el._id}),item.price=Number(item.value),delete item.value;try{if(item.price)if(item.sum)item.$inc=!0,item.price<0&&self.items.forEach(function(el){if(el.select&&el.price+item.price<0)throw el.name+" price below 0"});else{if(item.$mul=!0,item.price<-99)throw"percent value -99 - ~";item.price+=100,item.price>0&&(item.price=item.price/100)}return delete item.sum,self.Items.save({update:"price"},item).$promise.then(function(){global.set("saving",!0),getList(!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}catch(err){exception.catcher("error")(err)}})}function changePriceCtrl($uibModalInstance){var self=this;self.item={value:0,sum:!1},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.item)}}function deleteStuffs(){Confirm("потверждаете?").then(function(){var ids=self.items.filter(function(el){return el.select}).map(function(el){return el._id}).join("_"),folders=self.items.filter(function(el){return el.select}).map(function(el){return"images/"+global.get("store").val.subDomain+"/Stuff/"+el.url});$q.when().then(function(){return self.Items.delete({ids:ids}).$promise.then(function(){global.set("saving",!0),getList(!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}).then(function(){Photo.deleteFolders("Stuff",folders)})})}function massSaveField(item){var fields=Object.keys(item).join(" ");return item.ids=self.items.filter(function(el){return el.select}).map(function(el){return el._id}),self.Items.save({update:fields},item).$promise.then(function(){global.set("saving",!0),(item.actived||item.category)&&getList(!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}function changeAction(){if(self.action){var a=angular.copy(self.action);switch(self.action=null,self.mark=!1,a){case"category":return selectCategory();case"brand":return selectBrand();case"brandTag":return selectBrandTag();case"filterTag":return selectFilterTag();case"unfilterTag":return unSelectFilterTag();case"addInfo":return selectAddInfo();case"actived":return selectActived();case"index":return selectPosition();case"order":return changeOrderType();case"changePrice":return changePrice();case"changeMinMax":return changeMinMax();case"deleteStuffs":return deleteStuffs()}}}function dropCallback(item){return item}function alignmentIndex(){Confirm("Подтверждаете?").then(function(){self.alignmentIndexDisable=!0;var data={};return $http({method:"post",url:"/api/alignmentIndex",data:data})}).then(function(){}).catch(function(err){console.log(err)})}function fixData(){Confirm("Подтверждаете?").then(function(){self.fixDesable=!0;var data={};return $http({method:"post",url:"/api/fixedDB/stuff",data:data})}).then(function(){self.fixDesable=!1,exception.showToaster("info","fix stucture","Ok")}).catch(function(err){exception.catcher("fix stucture")(err)})}function reNewKeyWords(){Confirm("Подтверждаете?").then(function(){self.reNewKeyWordsDisable=!0;var data={};return $http({method:"GET",url:"/api/reNewKeyWords",data:data})}).then(function(){self.reNewKeyWordsDisable=!1,exception.showToaster("info","reNewKeyWords","Ok")}).catch(function(err){exception.catcher("reNewKeyWords")(err)})}function changeRows(rows){if(self.paginate.rows!=rows){self.paginate.rows=rows,self.paginate.page=0,self.paginate.items=0;getList(!0)}}function clearSearch(){$location.search("searchStr",null)}function changeListCriteria(field,val){self.listCriteria&&(self.listCriteria.actived=null,self.listCriteria.archived=null),field&&(self.listCriteria[field]=val),"actived"!=field||val||(self.listCriteria.archived=!1),self.paginate.page=0,getList(!0)}function changeStock(stuff,tag){stuff.stock&&stuff.stock[tag._id]&&(global.get("store").val.bookkeep?0==tag.quantity?(stuff.stock[tag._id].quantity=tag.quantity,saveField(stuff,"stock")):exception.catcher("изменение количесва")("изменить количество можно только на ноль"):(stuff.stock[tag._id].quantity=tag.quantity,saveField(stuff,"stock")))}function deleteIndexPageHtml(){Confirm("перезаписать страницу?").then(function(){return $http.get("/api/deleteIndexPageHtml?catalog="+$rootScope.$stateParams.groupUrl+"_"+$rootScope.$stateParams.categoryUrl)}).then(function(res){exception.showToaster("info","все OK")}).catch(function(err){exception.catcher("сброс страницы")(err)})}function bookkeepSynchronize(){$scope.$emit("$stateChangeStartToStuff"),console.log("bookkeepSynchronize"),Confirm("Подтверждаете?").then(function(){return $http({method:"get",url:"/api/stuffs/synchronizeWithBookkeep"})}).then(function(){$scope.$emit("$stateChangeEndToStuff"),self.fixDesable=!1,exception.showToaster("info","synchronized","Ok")}).catch(function(err){$scope.$emit("$stateChangeEndToStuff"),exception.catcher("synchronize")(err)})}anchorSmoothScroll.scrollTo("topPage"),$element.on("$destroy",function(){});var stamp=Date.now();console.log("stuffListCtrl from admin ",stamp);var self=this;self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.bookkeep=global.get("store").val.bookkeep,self.globalProperty=$rootScope.globalProperty,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.data={rows:2},self.itemsArr2=[[],[]],self.itemsArr3=[[],[],[]],self.itemsArr4=[[],[],[],[]],self.itemsArr5=[[],[],[],[],[]];self.paginate={page:0,rows:100,items:0},setTimeout(function(){$rootScope.displaySlideMenu=!0},400),self.newStuff={name:"",actived:!1},self.listOfActions={filterTag:"добавить характеристику",unfilterTag:"снять характеристику",addInfo:"таблица доп. параметров",category:"смена категории",brand:"смена бренда",order:"способ заказа",brandTag:"смена коллекции",changePrice:"смена цены",changeMinMax:"смена min max кол-ва для заказа",deleteStuffs:"удаление товаров",actived:"смена видимости",index:"смена позиции"},self.maxIndex=0,self.listCriteria={actived:!0},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.createItem=createItem,self.filterList=filterList,self.getTagName=getTagName,self.getFilterName=getFilterName,self.deleteItem=deleteItem,self.zoomImg=zoomImg,self.markAllStuffs=markAllStuffs,self.changeAction=changeAction,self.dropCallback=dropCallback,self.filteringList=filteringList,self.alignmentIndex=alignmentIndex,self.fixData=fixData,self.reNewKeyWords=reNewKeyWords,self.changeRows=changeRows,self.clearSearch=clearSearch,self.changeListCriteria=changeListCriteria,self.changeStock=changeStock,self.deleteIndexPageHtml=deleteIndexPageHtml,self.bookkeepSynchronize=bookkeepSynchronize,function(){global.get("tempContent")&&global.get("tempContent").val&&($("#tempContent").empty(),global.set("tempContent",null)),self.data.rows=setRows(),global.get("crawler")&&global.get("crawler").val&&"stuffs.stuff"==self.$state.current.name||$q.when().then(function(){return self.Items.getQueryFromUrl(self.campaignCondition)}).then(function(query){return self.query=query,getList()}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){self.filterTags=filterTags}).then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){$rootScope.reloadStuffId&&$timeout(function(){anchorSmoothScroll.scrollTo("stuff"+$rootScope.reloadStuffId,-150),$rootScope.reloadStuffId=null},1300)}).then(function(helper){helper&&(self.helper=helper,global.get("store").val.helper||(self.helper.popover=null))}).then(function(){seoContent.setDataCatalog()}).catch(function(err){console.log(err)})}(),$scope.$on("fromStuffToStuffs",function(){console.log("$rootScope.$on('fromStuffToStuffs'",stamp),getList(!0)}),$(window).resize(function(){$timeout(function(){self.data.rows=setRows()})}),selectActivedCtrl.$inject=["$uibModalInstance"],selectPositionCtrl.$inject=["$uibModalInstance"],orderTypeCtrl.$inject=["$uibModalInstance"],changeMinMaxCtrl.$inject=["$uibModalInstance"],changePriceCtrl.$inject=["$uibModalInstance"],console.log($rootScope.$stateParams)}function filtersWrapDirective(global){return{scope:{},restrict:"C",bindToController:!0,controller:filtersWrapCtrl,controllerAs:"$ctrl",templateUrl:function(){var s="";if(global.get("store").val){var type=global.get("sectionType")&&global.get("sectionType").val?global.get("sectionType").val:"good",sec=global.get("store").val.template.stuffListType[type];if(sec.filters)for(var i=0;i<sec.parts.length;i++)if("filters"==sec.parts[i].name){sec.parts[i].templ&&(s=sec.parts[i].templ);break}}return"views/template/partials/stuffs/filters/filtersWrap"+s+".html"}}}function filtersWrapCtrl($element,$timeout,$q,$stateParams,Sections,$location,Filters,global,Brands,Stuff,$scope,$rootScope,$state){function showReset(filter){return filter.tags.some(function(t){return t.set})}function AllshowReset(){return self.filters.some(function(f){return f.tags.some(function(t){return t.set})})}function showResetAllBrand(){return self.brands.some(function(f){return f.tags.some(function(t){return t.set})})}function changeTag(_filter,_tag,type){var queryTag="",brandTag="",brand="",filterTag="";self.filters.forEach(function(filter){filter.count?filter.set&&(filterTag&&(filterTag+="__"),filterTag+=filter._id+"_"+filter.minValue+"_"+filter.maxValue):filter.tags.forEach(function(tag){_filter&&_tag&&_filter._id===filter._id&&(_tag._id===tag._id||(tag.set=!1)),tag.set&&(queryTag&&(queryTag+="__"),queryTag+=tag.url)})}),self.brands.forEach(function(b){"brand"==type?b.set&&(brand&&(brand+="__"),brand+=b.url):"brandTag"==type?b.tags.forEach(function(tag){tag.set&&(brandTag&&(brandTag+="__"),brandTag+=tag.url)}):(b.set&&(brand&&(brand+="__"),brand+=b.url),b.tags.forEach(function(tag){tag.set&&(brandTag&&(brandTag+="__"),brandTag+=tag.url)}))}),brand.split("__").length>1&&(brandTag=null),queryTag?$location.search("queryTag",queryTag):$location.search("queryTag",null),brandTag?$location.search("brandTag",brandTag):$location.search("brandTag",null),brand?$location.search("brand",brand):$location.search("brand",null),filterTag?$location.search("filterTag",filterTag):$location.search("filterTag",null);$stateParams.groupUrl,$stateParams.categoryUrl,self.brand}function clearAllBrands(){self.brands.forEach(function(b){b.set=!1,b.tags&&b.tags.length&&b.tags.forEach(function(t){t.set=!1})})}function changeAllBrands(){clearAllBrands(),changeTag()}function clearFilter(filter){filter.set=null,filter.tags&&filter.tags.length&&filter.tags.forEach(function(t){t.set=!1})}function changeAllTags(filter){clearFilter(filter),changeTag()}function clearAll(){clearAllBrands(),self.filters.forEach(function(filter){clearFilter(filter)}),changeTag()}function setCountFilter(filter){filter.set=!0,changeTag()}function clearCountFilter(filter){filter.set=null,filter.minValue=filter.min,filter.maxValue=filter.max,changeTag()}function openFilterForBrands(){if(self.brands&&self.brands.length)return self.brands.some(function(b){return b.open})}function setCharForBrands(char){self.char=char}function filterBrands(item){return item.name.toUpperCase()[0]==self.char}function changeCategory(category,section){var o={groupUrl:category?category.linkData.groupUrl:$stateParams.groupUrl,categoryUrl:category?category.linkData.categoryUrl:"category",queryTag:null,brand:null,brandTag:null,categoryList:null};category&&category.set||(o.categoryUrl="category"),section&&section.categories&&section.categories.forEach(function(c){c.set=!1}),$state.go("stuffs",o)}function changeAllCategories(s){self.sections.forEach(function(s){s.categories.forEach(function(c){c.set=!1}),s.child.forEach(function(child){child.categories&&child.categories.length&&child.categories.forEach(function(c){c.set=!1})})});var o={groupUrl:s.url,categoryUrl:"category",queryTag:null,brand:null,brandTag:null,categoryList:null};$state.go("stuffs",o)}function deleteCrumb(index){!function(type){var query=self.breadcrumbs.reduce(function(q,item){return item.type==type&&(q&&(q+="__"),q+=item.url),q},"");query||(query=null),$location.search(type,query)}(self.breadcrumbs.splice(index,1)[0].type)}var self=this;self.global=global,"category"!=$stateParams.categoryUrl?self.sectionName=global.get("category").val.name:self.sectionName=global.get("section")&&global.get("section").val?global.get("section").val.name:"раздел",self.breadcrumbs=global.get("breadcrumbs").val,self.chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],self.char=self.chars[0];var sT=global.get("sectionType")&&global.get("sectionType").val?global.get("sectionType").val:"good";global.get("store").val.template.stuffListType[sT].filtersCategories?global.get("sections")&&global.get("sections").val&&(self.sections=global.get("sections").val.filter(function(s){return s.viewsFilters})):self.sections=[],self.allCategoriesSet="category"==$stateParams.categoryUrl,self.changeAllBrands=changeAllBrands,self.changeAllTags=changeAllTags,self.clearAll=clearAll,self.setCountFilter=setCountFilter,self.clearCountFilter=clearCountFilter,self.openFilterForBrands=openFilterForBrands,self.filterBrands=filterBrands,self.setCharForBrands=setCharForBrands,self.changeCategory=changeCategory,self.changeAllCategories=changeAllCategories,self.deleteCrumb=deleteCrumb,self.showReset=showReset,self.showResetAll=AllshowReset,self.showResetAllBrand=showResetAllBrand,$rootScope.$on("changeCurrency",function(){console.log("changeCurrency",global.get("rate").val),self.filters.forEach(function(f){f.count&&f.price&&(console.log(f.mixSave,global.get("rate").val),f.min=Math.ceil10(f.mixSave*global.get("rate").val,0),console.log(f.min),f.max=Math.ceil10(f.maxSave*global.get("rate").val,0),f.maxValue=f.max,f.minValue=f.min,console.log(f))}),$timeout(function(){$scope.$broadcast("rzSliderForceRender")},500)}),function(){global.get("category").val&&global.get("category").val.filters&&global.get("category").val.filters.length?self.displayable=!0:global.get("section")&&global.get("section").val&&global.get("section").val.filters&&global.get("section").val.filters.length&&(self.displayable=!0),$q.when().then(function(){return Brands.getBrands()}).then(function(brands){self.brands=brands,self.checkedBrand=0,self.brands&&self.brands.forEach(function(b){b.set&&self.checkedBrand++})}).then(function(){return Filters.getFilters()}).then(function(filters){filters.forEach(function(f){var rate=global.get("rate")&&global.get("rate").val?global.get("rate").val:1;f.count&&(f.maxSave||(f.maxSave=f.max),f.mixSave||(f.mixSave=f.min),f.price&&(f.min=Math.ceil10(f.mixSave*rate,0),f.max=Math.ceil10(f.maxSave*rate,0)),f.set||(f.minValue=f.min,f.maxValue=f.max),$scope.$watch(function(){return f.open},function(n,o){n&&$timeout(function(){$scope.$broadcast("reCalcViewDimensions")},300)}))}),self.filters=filters.filter(function(f){if(self.displayable)return global.get("category").val?global.get("category").val.filters.indexOf(f._id)>-1:global.get("section").val.filters.indexOf(f._id)>-1})})}(),self.changeTag=changeTag;$element.offsetParent(),$element.find("div")[0];$timeout(function(){function filtersForScroll(event){if(list&&"stuffs"==$state.current.name){var docViewTop=win.scrollTop(),docViewBottom=docViewTop+win.height(),elemTop=$(filtersBox).offset().top,elemBottom=elemTop+$(filtersBox).height(),elemWidth=$(filtersBox).width(),listTop=$(list).offset().top,listBottom=listTop+$(list).height(),st=$(this).scrollTop();st>lastScrollTop?function(){if(elemBottom)if("fixed"==$(filtersBox).css("position"))if($(filtersBox).css("top")==sdvig+"px")if(elemBottom<docViewBottom);else{var t=elemTop-$(filtersFirstBox).offset().top;$(filtersFirstBox).css("height",t+"px"),$(filtersBox).css("position","absolute"),$(filtersBox).css("top",t+"px"),$(filtersBox).css("bottom","auto")}else"0px"==$(filtersBox).css("bottom")&&listBottom<=elemBottom&&($(filtersFirstBox).css("height",$(list).height()),$(filtersBox).css("position","absolute"),$(filtersBox).css("bottom","0px"),$(filtersBox).css("top","auto"));else"absolute"==$(filtersBox).css("position")&&(docViewTop-sdvig>=elemTop&&elemBottom<docViewBottom&&$(filtersBox).height()<docViewBottom-docViewTop-sdvig?($(filtersBox).css("position","fixed"),$(filtersBox).css("bottom","auto"),$(filtersBox).css("top",sdvig+"px"),$(filtersBox).css("width",elemWidth+"px")):elemBottom<=docViewBottom&&elemBottom<listBottom&&!($(filtersBox).height()<docViewBottom-docViewTop-sdvig)&&($(filtersBox).css("position","fixed"),$(filtersBox).css("bottom","0px"),$(filtersBox).css("top","auto"),$(filtersBox).css("width",elemWidth+"px")))}():function(){elemBottom&&("fixed"==$(filtersBox).css("position")?"0px"==$(filtersBox).css("bottom")?($(filtersFirstBox).css("height",docViewBottom-$(filtersFirstBox).offset().top),$(filtersBox).css("position","absolute"),$(filtersBox).css("bottom","0px"),$(filtersBox).css("top","auto"),$(filtersBox).css("width",elemWidth+"px"),$(filtersFirstBox).height()<$(filtersBox).height()&&$(filtersFirstBox).height($(filtersBox).height())):$(filtersBox).css("top")==sdvig+"px"?docViewTop+sdvig<=listTop&&($(filtersBox).css("position","absolute"),$(filtersBox).css("bottom","auto"),$(filtersBox).css("top","0px"),$(filtersBox).css("width",elemWidth+"px")):console.log("?????????????"):"absolute"==$(filtersBox).css("position")&&elemTop>docViewTop+sdvig&&elemTop>listTop&&($(filtersBox).css("position","fixed"),$(filtersBox).css("top",sdvig+"px"),$(filtersBox).css("bottom","auto"),$(filtersBox).css("width",elemWidth+"px")))}(),lastScrollTop=st}}var w=$element.parent().width(),list=(Math.round(w/5),$element.parent().children()[1]),nav=$(".navbar-fixed-top"),sdvig=0;nav.each(function(i,n){sdvig+=$(n).outerHeight()});var filtersFirstBox=$element.find(".filters-first-box")[0],filtersBox=$element.find(".filter-box")[0],win=$(window);win.scroll(filtersForScroll);var lastScrollTop=0;$(filtersFirstBox).height($(filtersBox).height()),$scope.$watch(function(){return $(filtersBox).height()},function(n,o){$(filtersFirstBox).height(n+"px")}),$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){"stuffs"==to.name&&filtersForScroll()}),$scope.$on("$destroy",function(){angular.element(window).off("scroll",filtersForScroll)})},150)}angular.module("gmall.controllers").controller("stuffListFromServerCtrl",stuffListFromServerCtrl),angular.module("gmall.services").directive("stuffList",stuffListDirective).directive("stuffListTemplate",stuffListTemplateDirective).directive("stuffListTemplateList",stuffListTemplateDirectiveList).directive("stuffListTemplateServer",stuffListTemplateServer).directive("stuffListTemplateCampaignList",stuffListTemplateDirectiveCampaignList).directive("emptyList",emptyList).directive("stuffInList",stuffInList).directive("homePageStuffOwl",function(){return{scope:{homePageStuffOwl:"@",zoomImg:"@",stuffs:"@",items:"@",autoplay:"@",duration:"@",gallery:"="},bindToController:!0,controllerAs:"$ctrl",controller:homePageStuffOwlCtrl}}).directive("homePageHtml",function(){return{restrict:"C",scope:!0,bindToController:!0,controllerAs:"$ctrl",controller:homePageHtmlCtrl}}).directive("likesItem",likesItem),likesItemCtrl.$inject=["$compile","$timeout","localStorage","Stuff","global"],homePageHtmlCtrl.$inject=["$scope","$rootScope","$timeout","$element","$compile","global","$q","$http"],homePageStuffOwlCtrl.$inject=["$scope","$timeout","$element","$compile","global"],stuffListFromServerCtrl.$inject=["$scope","$state","$compile","$element","$window","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","Helper","anchorSmoothScroll","Photo","$timeout","$anchorScroll","Category","Brands","BrandTags","seoContent","AddInfo","$http","$location","$sce"],campaignStuffListCtrl.$inject=["$scope","$state","$compile","$element","$window","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","Helper","anchorSmoothScroll","Photo","$timeout","$anchorScroll","Category","Brands","BrandTags","seoContent","AddInfo","$http","$location","localStorage"],stuffListCtrl.$inject=["$scope","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","Helper","anchorSmoothScroll","Photo","$timeout","$anchorScroll","Category","Brands","BrandTags","seoContent","AddInfo","$http","$location","$element"],angular.module("gmall.directives").directive("filtersWrap",filtersWrapDirective),filtersWrapCtrl.$inject=["$element","$timeout","$q","$stateParams","Sections","$location","Filters","global","Brands","Stuff","$scope","$rootScope","$state"]}(),function(){function galleryСarouselControls(){return console.log("galleryСarouselgalleryСarousel "),{restrict:"AC",scope:{},bindToController:!0,controllerAs:"$ctrl",controller:galleryСarouselCtrl}}function gallerySmallDirective(){return{restrict:"C",controller:gallerySmallCtrl}}function stuffCartDirective(global){return{templateUrl:function(){var s=global.get("campaignStuffCart").val&&0!=global.get("campaignStuffCart").val?global.get("campaignStuffCart").val:"";return"/views/template/partials/stuffs/list/stuff-cart/stuff-cart"+s+".html"},restrict:"A"}}function homePageStuffDirective(global){return{restrict:"A",scope:{homePageStuff:"@"},bindToController:!0,controllerAs:"$ctrl",controller:homePageStuffCtrl}}function itemCtrl($scope,$anchorScroll,global,Stuff,$stateParams,$window,$q,BrandTags,FilterTags,Filters,AddInfo,Comments,exception,seoContent,$location,Sections,$uibModal,$notification,$rootScope,$timeout,$element){function getStuff(url,reload){reload&&self.item.stockKeysArray&&(self.item.stockKeysArray=[]),console.log(JSON.stringify(self.item.stockKeysArray));var leftRow=$("#stuffDetailLeftClass"),rightRow=$("#stuffDetailRightClass");return $q.when().then(function(){var o;return $stateParams.store&&(o={},o.store=$stateParams.store),Stuff.getItem(url,o)}).then(function(item){if(null!=item.grid&&void 0!=item.grid?(item.leftClass=ratioClassStuffDetail[item.grid].left,item.rightClass=ratioClassStuffDetail[item.grid].right):(item.leftClass=ratioClassStuffDetail[global.get("store").val.template.stuffDetailType[global.get("sectionType").val].ratio].left,item.rightClass=ratioClassStuffDetail[global.get("store").val.template.stuffDetailType[global.get("sectionType").val].ratio].right),self.item?self.item.leftClass!=item.leftClass?leftRow.removeAttr("class"):self.item.rightClass!=item.rightClass&&rightRow.removeAttr("class"):(leftRow.removeAttr("class"),rightRow.removeAttr("class")),self.objShare=seoContent.setDataItem(item),item.blocks&&item.blocks.length){item.blocks.sort(function(a,b){return a.index-b.index});document.getElementById("style"+item.url)}if(reload){$rootScope.$broadcast("reloadGallery");for(var key in self.item)"gallery"!=key&&"sortsOfStuff"!=key&&(item[key]&&"function"!=typeof item[key]?"stockKeysArray"==key?$timeout(function(){self.item.stockKeysArray=item.stockKeysArray},700):self.item[key]=item[key]:delete self.item[key]);for(var key in item)"gallery"==key||"sortsOfStuff"==key||self.item[key]||(self.item[key]=item[key]);self.activeSlide=0}else self.item=item;return $anchorScroll(),item}).then(function(item){if(console.dir(item),item.sortsOfStuff&&item.sortsOfStuff.stuffs&&item.sortsOfStuff.stuffs.length){var filterGroup,filterGroupTags=[];item.sortsOfStuff.filterGroup&&(filterGroup=_filtersO[item.sortsOfStuff.filterGroup])&&(filterGroupTags=filterGroup.tags.map(function(t){return t._id})),item.sortsOfStuff.stuffs.forEach(function(stuff,i){stuff.gallery.forEach(function(s,ii){s.active=!ii});for(var ii=0;ii<stuff.tags.length;ii++){var idx=filterGroupTags.indexOf(stuff.tags[ii]);if(idx>-1){filterGroup.tags[idx].img&&(item.sortsOfStuff.stuffs[i].gallery[0].thumbSmallTag=filterGroup.tags[idx].img);break}}}),self.item.sortsOfStuff=item.sortsOfStuff}}).then(function(){if(self.disqusConfig={disqus_shortname:global.get("store").val.disqus,disqus_identifier:self.item._id,disqus_url:$location.absUrl(),disqus_title:self.item.name,disqus_config_language:global.get("store").val.lang},reload){var u=self.disqusConfig.disqus_url.split("/");u[u.length-1]=self.item.url,self.disqusConfig.disqus_url=u.join("/")}if(self.getComments(0),self.commentName=global.get("user").val?global.get("user").val.name||global.get("user").val.profile.fio:"",self.item.addInfo)return getAddInfos()}).then(function(){$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff"),carousel=$($element).find(".gallery-carousel")},300)}).then(function(){self.item.FullTags=self.item.tags.map(function(t){return t&&(t=angular.copy(global.get("filterTags").val.getOFA("_id",t)))?(t.filter&&!t.filter._id&&(t.filter=global.get("filters").val.getOFA("_id",t.filter)),t):null})}).then(function(){prepareStuffList()}).catch(function(err){console.log(err),err=err.data||err,exception.catcher("получение товара")(err)})}function getTagName(tag){if(tag)return self.filterTags.getOFA("_id",tag).name}function getFilterName(filter){if(filter&&_filterO[filter])return _filterO[filter].name}function decreaseQty(){var stuff=self.item;stuff&&stuff.quantity>1&&(stuff.multiple&&stuff.minQty?stuff.quantity-1>=stuff.minQty&&stuff.quantity--:stuff.quantity--)}function increaseQty(){var stuff=self.item;stuff&&(stuff.single&&stuff.maxQty?stuff.quantity+1<=stuff.maxQty&&stuff.quantity++:stuff.quantity++)}function chancheStuff(item){console.log(item),self.item.gallery=item.gallery,self.activeSlide=0,getStuff(item.url,"reload")}function getAddInfos(){return $q(function(resolve,reject){self.item.addInfo?AddInfo.get({id:self.item.addInfo,
store:self.item.store},function(res){self.item.addInfo=res,resolve()},function(err){reject(err)}):resolve()})}function createNewComment(text){if(text){if(!global.get("user").val)return self.commentAccess=!0,void $timeout(function(){self.commentAccess=!1},6e3);var newComment={text:text.substring(0,500),stuff:self.item._id,user:global.get("user").val.name};$q.when().then(function(){return Comments.save(newComment).$promise}).then(function(){var o={addressee:"seller",type:"comment",content:""};return o.seller=global.get("store").val.seller._id,o.content="<h3>КОММЕНТАРИЙ К ТОВАРУ</h3>"+moment(Date.now()).format("LLL")+"<h4>"+self.item.name+(self.item.artikul?" "+self.item.artikul:"")+"</h4>"+text.substring(0,30)+"...",$notification.save(o).$promise}).then(function(){return self.comment="",getComments(0)}).catch(function(err){err=err.data||err,exception.catcher("создание комментария")(err)})}}function getComments(page){0===page?self.paginate.page=page:"more"===page&&self.paginate.page++;var query={stuff:self.item._id};return Comments.getList(self.paginate,query).then(function(data){self.paginate.page?self.item.comments.push.apply(self.item.comments,data):self.item.comments=data}).catch(function(err){err=err.data||err,exception.catcher("получение комментариев")(err)})}function chancheActiveSlide(index,swipe){slideDelay||(slideDelay=!0,$timeout(function(){slideDelay=!1},700),swipe?(carousel=$element.find(".gallery-carousel"),"left"==swipe?carousel&&carousel.isolateScope&&"function"==typeof carousel.isolateScope&&carousel.isolateScope().next():"right"==swipe&&carousel&&carousel.isolateScope&&"function"==typeof carousel.isolateScope&&carousel.isolateScope().prev()):(self.activeSlide=index,self.item.gallery[index].active=!0))}function prepareStuffList(){if(global.get("stuffsInList").val){maxNumInRow=0,stuffsInList=[],currentStuffInList=0;for(var k in global.get("stuffsInList").val)global.get("stuffsInList").val[k].length&&global.get("stuffsInList").val[k].length>maxNumInRow&&(maxNumInRow=global.get("stuffsInList").val[k].length);for(var j=0;j<maxNumInRow;j++)for(var i=1;i<=6;i++)global.get("stuffsInList").val["td-list-"+i]&&global.get("stuffsInList").val["td-list-"+i].length&&global.get("stuffsInList").val["td-list-"+i][j]&&stuffsInList.push(global.get("stuffsInList").val["td-list-"+i][j]);for(var i=0;i<stuffsInList.length;i++)if(self.item&&self.item._id==stuffsInList[i]._id){currentStuffInList=i;break}}}function nextStuff(){slideDelay||(slideDelay=!0,$timeout(function(){slideDelay=!1},400),currentStuffInList<stuffsInList.length-1?(currentStuffInList++,stuffsInList&&stuffsInList[currentStuffInList]&&(self.item=stuffsInList[currentStuffInList])):(console.log("addBlockAfterScroll"),$rootScope.$broadcast("addBlockAfterScroll")))}function prevStuff(){slideDelay||(slideDelay=!0,$timeout(function(){slideDelay=!1},700),currentStuffInList>0&&currentStuffInList--,stuffsInList&&stuffsInList[currentStuffInList]&&(self.item=stuffsInList[currentStuffInList]))}function returnToList(){$rootScope.$state.go("stuffs")}$anchorScroll();var stuffsInList=[],currentStuffInList=null,maxNumInRow=0,self=this;global.get("tempContent").val?self.firstLook=!0:self.firstLook=!1,self.global=global,self.$stateParams=$stateParams,self.lang=global.get("store").val.lang,self.rate=global.get("rate"),self.mobile=global.get("mobile").val,self.crawler=global.get("crawler").val,self.currency=global.get("currency"),self.moment=moment,self.activeSlide=0,self.paginate={rows:5,page:0,items:0},self.getTagName=getTagName,self.getFilterName=getFilterName,self.createNewComment=createNewComment,self.getComments=getComments,self.increaseQty=increaseQty,self.decreaseQty=decreaseQty,self.chancheStuff=chancheStuff,self.chancheActiveSlide=chancheActiveSlide,self.nextStuff=nextStuff,self.prevStuff=prevStuff,self.returnToList=returnToList;var slideDelay,carousel;!function(){global.get("tempContent")&&global.get("tempContent").val&&($("#tempContent").empty(),global.set("tempContent",null)),$location.search("searchStr",null),$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){return self.filterTags=filterTags,Filters.getFilters()}).then(function(filters){return self.filters=filters,getStuff($stateParams.stuffUrl)})}(),$rootScope.$on("cartslide",function(data){global.get("user").val&&(self.commentName=global.get("user").val.name)}),$rootScope.$on("logout",function(data){self.commentName=""}),$scope.$on("addBlockAfterScrollDone",function(){console.log("addBlockAfterScrollDone"),prepareStuffList(),nextStuff()})}function homePageStuffCtrl($scope,global,Stuff,$q,$compile,$element,exception){var self=this;self.global=global,function(){$q.when().then(function(filters){return Stuff.getItem(self.homePageStuff)}).then(function(item){self.stuff=item;var linkFn=$compile($element[0].innerHTML),content=linkFn($scope);$element[0].innerHTML=null,$element.append(content)}).catch(function(err){err=err.data||err,exception.catcher("get stuff home page")(err)})}()}function gallerySmallCtrl($element,$timeout,$scope,$attrs){var wrapDiv=$element.children(),paddingLeft=0,paddingRight=0,arrowUp=$element.find(".arrow-up-gallery-small"),arrowDown=$element.find(".arrow-down-gallery-small");$(arrowUp).css("display","none"),$(arrowDown).css("display","none"),$scope.arrowUp=function(display){display?$(arrowUp).css("display","inline-block"):$(arrowUp).css("display","none")},$scope.arrowDown=function(display){display?$(arrowDown).css("display","inline-block"):$(arrowDown).css("display","none")};var arrowPrev=$element.find(".arrow-prev-gallery-small"),arrowNext=$element.find(".arrow-next-gallery-small");$(arrowPrev).css("display","none"),$(arrowNext).css("display","none"),$scope.arrowPrev=function(display){display?($scope.arrowPrevDisabled=!1,$(arrowPrev).removeAttr("disabled")):($scope.arrowPrevDisabled=!0,$(arrowPrev).attr("disabled","disabled"))},$scope.arrowNext=function(display){display?($scope.arrowNextDisabled=!1,$(arrowNext).removeAttr("disabled")):($(arrowNext).attr("disabled","disabled"),$scope.arrowNextDisabled=!0)},$timeout(function(){function scrollFoo(reload){if(console.log("scrollFoo"),$attrs.orientation&&"horizontal"==$attrs.orientation){if($attrs.orientation&&"horizontal"==$attrs.orientation){var left=$(child).offset().left,right=$(child).offset().left+$(child).width(),leftFirstImg=$(images[0]).offset().left,rightLastImg=$(images[imagesQty-1]).offset().left+$(images[imagesQty-1]).width();left>leftFirstImg?$scope.arrowPrev(!0):$scope.arrowPrev(!1),right>=rightLastImg?$scope.arrowNext(!1):$scope.arrowNext(!0)}}else{var top=$(child).offset().top,bottom=$(child).offset().top+$(child).height(),topFirstImg=$(images[0]).offset().top,bottomLastImg=$(images[imagesQty-1]).offset().top+$(images[imagesQty-1]).height();top>topFirstImg?$scope.arrowUp(!0):$scope.arrowUp(!1),bottom<bottomLastImg?$scope.arrowDown(!0):$scope.arrowDown(!1)}}function move_up(){if($attrs.orientation&&"horizontal"==$attrs.orientation){if($attrs.orientation&&"horizontal"==$attrs.orientation){var scrollLeft=child.scrollLeft-200;$(child).stop().animate({scrollLeft:scrollLeft},"500","swing",function(){})}}else{var scrollTop=child.scrollTop-500;$(child).stop().animate({scrollTop:scrollTop},"500","swing",function(){})}}function move_down(){if(console.log("move_down"),$attrs.orientation&&"horizontal"==$attrs.orientation){if($attrs.orientation&&"horizontal"==$attrs.orientation){var scrollLeft=child.scrollLeft+200;$(child).stop().animate({scrollLeft:scrollLeft},"500","swing",function(){})}}else{var scrollTop=child.scrollTop+500;console.log(scrollTop,child),$(child).stop().animate({scrollTop:scrollTop},"500","swing",function(){})}}function changeImg(){$timeout(function(){var h=$(".gallery-big").height();h>galleryBigH&&(galleryBigH=h,wrapDiv.css("height",h))},700)}var images=$element.find("img");$scope.loadCounter=images.length+1;var listener=$scope.$watch("loadCounter",function(n,o){0==n&&(listener(),$timeout(function(){if(top=$(child).offset().top,bottom=$(child).offset().top+$(child).height(),left=$(child).offset().left,right=$(child).offset().top+$(child).width(),$attrs.orientation&&"horizontal"==$attrs.orientation){if($attrs.orientation&&"horizontal"==$attrs.orientation){paddingLeft=$(child).css("padding-left").replace(/[^-\d\.]/g,""),paddingRight=$(child).css("padding-right").replace(/[^-\d\.]/g,"");var www=($(images[0]).offset().left,$(images[images.length-1]).offset().left,$(images[images.length-1]).width(),0);images.each(function(i,img){www+=$(img).width()}),www>$(child).width()&&($(arrowPrev).css("display","inline-block"),$(arrowNext).css("display","inline-block"),$scope.arrowNext(!0))}}else{child.style.right=child.clientWidth-child.offsetWidth+"px";var topFirstImg=$(images[0]).offset().top,bottomLastImg=$(images[images.length-1]).offset().top+$(images[images.length-1]).height();top>topFirstImg&&$scope.arrowUp(!0),bottom<bottomLastImg&&$scope.arrowDown(!0)}},500))}),imagesQty=images.length,imagesBig=$(".gallery-big img");imagesBig.length||(imagesBig=$(".zoom-big-slide img"));var galleryBigH,child=$element.find("#gallery-small-container")[0],top=$(child).offset().top,bottom=$(child).offset().top+$(child).height(),left=$(child).offset().left,right=$(child).offset().top+$(child).width();imagesBig.each(function(i,img){i||(this.complete?($attrs.orientation&&"horizontal"==$attrs.orientation?$attrs.orientation&&"horizontal"==$attrs.orientation&&(galleryBigH=imagesBig.width(),wrapDiv.css("width",galleryBigH-40)):(galleryBigH=imagesBig.height(),wrapDiv.css("height",galleryBigH)),top=$(child).offset().top,bottom=$(child).offset().top+$(child).height(),left=$(child).offset().left,right=$(child).offset().top+$(child).width(),$timeout(function(){$scope.loadCounter--})):$(this).bind("load",function(){$attrs.orientation&&"horizontal"==$attrs.orientation?$attrs.orientation&&"horizontal"==$attrs.orientation&&(galleryBigH=imagesBig.width(),wrapDiv.css("width",galleryBigH-40)):(galleryBigH=imagesBig.height(),wrapDiv.css("height",galleryBigH)),top=$(child).offset().top,bottom=$(child).offset().top+$(child).height(),left=$(child).offset().left,right=$(child).offset().top+$(child).width(),$timeout(function(){$scope.loadCounter--})}))}),images.each(function(img){this.complete?$scope.loadCounter--:$(this).bind("load",function(){$scope.loadCounter--})}),$(child).bind("scroll",scrollFoo),$scope.smallGalleryF={move_up:move_up,move_down:move_down,changeImg:changeImg},$scope.$on("reloadGallery",function(){$timeout(function(){images=$element.find("img"),imagesQty=images.length,scrollFoo("reload")},300)})},100)}function nameBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/nameBlock.html"}}function positionBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/positionBlock.html"}}function videoLinkBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/videoLinkBlock.html"}}function textBlockStuff(){return{templateUrl:function(el,attrs){return"views/template/partials/stuffDetail/blocks/blocks/textBlock"+(attrs&&attrs.blockTempl&&"0"!=attrs.blockTempl?attrs.blockTempl:"")+".html"}}}function text2BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/text2Block.html"}}function bannerBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/bannerBlock.html"}}function banner1BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/banner1Block.html"}}function sliderBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/sliderBlock.html"}}function videoBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/videoBlock.html"}}function video1BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/video1Block.html"}}function video2BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/video2Block.html"}}function mapBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/mapBlock.html"}}function map1BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/map1Block.html"}}function map2BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/map2Block.html"}}function mastersBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/mastersBlock.html"}}function feedbackBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/feedbackBlock.html"}}function feedback1BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/feedback1Block.html"}}function feedback2BlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/feedback2Block.html"}}function imgsBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/imgsBlock.html"}}function dateBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/dateBlock.html"}}function snBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/snBlock.html"}}function calendarBlockStuff(){return{templateUrl:"views/template/partials/stuffDetail/blocks/blocks/calendarBlock.html"}}function itemDirectiveFromServer(){return{scope:{},bindToController:!0,controllerAs:"$ctrl",template:"<div></div>",controller:stuffDetailFromServerCtrl,restrict:"E"}}function stuffDetailFromServerCtrl($scope,$element,$compile,$http,$stateParams,$state,$anchorScroll,global,$q,$rootScope,$location,$timeout,$sce){var self=this;self.global=global,self.lang=global.get("store").val.lang,$q.when().then(function(){if(global.get("tempContent").val){var html=global.get("tempContent").val;$("#tempContent").empty(),global.set("tempContent",null);var o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}var url="views/template/partials/stuffDetail/stuffDetailNew/"+global.get("sectionType").val+"/"+$stateParams.stuffUrl+".html?group="+$stateParams.groupUrl+"&category="+$stateParams.categoryUrl;return $http.get(url)}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);if($element.append(content),$anchorScroll(),response.data.titles&&response.data.titles.title)for(var k in response.data.titles)if(response.data.titles[k])if("title_______"==k)response.data.titles[k].indexOf(global.get("titles").val[k])<0?global.get("titles").val[k]=response.data.titles[k]+". "+global.get("titles").val[k]:global.get("titles").val[k]=response.data.titles[k];else if("canonical"==k)try{global.get("titles").val[k]=$sce.trustAsResourceUrl(response.data.titles[k])}catch(err){console.log(err)}else global.get("titles").val[k]=response.data.titles[k];$rootScope.$emit("$stateChangeEndToStuff")})}function stuffFromServer(global,$timeout){return{scope:{stuffFromServer:"@"},bindToController:!0,controllerAs:"$ctrl",restrict:"A",controller:function($scope,Stuff,global,$attrs,$stateParams,$q,seoContent,$timeout,$rootScope,$anchorScroll,$location,Comments,exception,$element,localStorage,$animate,$uibModal){function getAddInfoInModal(){var options={animation:!0,bindToController:!0,controllerAs:"$ctrl",windowClass:function(){return"modalProject"},templateUrl:"views/template/partials/stuffDetail/addInfo/modal/addinfo.html",controller:function($uibModalInstance,global,item){function getTagName(tag){if(tag)return global.get("filterTagsO").val[tag].name}var self=this;self.item=item,self.modal=global.get("mobile").val,self.lang=global.get("store").val.lang,self.getTagName=getTagName,self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{item:function(){return self.item}}};$uibModal.open(options)}function goToSchedule(){var div=$($element).find("div[schedule-place-from-server='schedule-place-from-server']");console.log(div),div&&$([document.documentElement,document.body]).animate({scrollTop:$(div).offset().top},2e3)}function getAveragePrice(price){if(price){var p=price*global.get("rate").val;return p=Math.round(100*p)/100,formatAverage&&(4==formatAverage?p=100*Math.round(p/100):3==formatAverage?p=10*Math.round(p/10):2==formatAverage?p=Math.round(p):1==formatAverage&&(p=Math.round(10*p)/10)),p}}function getMastersName(){self.stuff.masters=[],global.get("masters").val.forEach(function(m){if(m.stuffs&&m.stuffs.length&&m.stuffs.indexOf(self.stuff._id)>-1){var o={name:m.name,url:m.url};self.stuff.masters.push(o)}})}function chancheActiveSlide(index,swipe){if(!slideDelay)if(slideDelay=!0,$timeout(function(){slideDelay=!1},700),swipe){var carousel=$element.find(".gallery-carousel");"left"==swipe?carousel&&carousel.isolateScope&&"function"==typeof carousel.isolateScope&&carousel.isolateScope().next():"right"==swipe&&carousel&&carousel.isolateScope&&"function"==typeof carousel.isolateScope&&carousel.isolateScope().prev()}else self.activeSlide=index,self.item.gallery[index].active=!0}function decreaseQty(){var stuff=self.item;stuff&&stuff.quantity>1&&(stuff.multiple&&stuff.minQty?stuff.quantity-1>=stuff.minQty&&stuff.quantity--:stuff.quantity--)}function increaseQty(){var stuff=self.item;stuff&&(stuff.single&&stuff.maxQty?stuff.quantity+1<=stuff.maxQty&&stuff.quantity++:stuff.quantity++)}function chancheStuff(item){self.item.gallery=item.gallery,self.activeSlide=0,getStuff(item.url)}function getComments(page){0===page?self.paginate.page=page:"more"===page&&self.paginate.page++;var query={stuff:self.item._id};return Comments.getList(self.paginate,query).then(function(data){self.paginate.page?self.item.comments.push.apply(self.item.comments,data):self.item.comments=data}).catch(function(err){err=err.data||err,exception.catcher("получение комментариев")(err)})}function getStuff(url){var leftRow=$("#stuffDetailLeftClass"),rightRow=$("#stuffDetailRightClass");return $q.when().then(function(){var o;return $stateParams.store&&(o={},o.store=$stateParams.store),Stuff.getItem(url,o)}).then(function(item){self.gallery=item.gallery,null!=item.grid&&void 0!=item.grid?(item.leftClass=ratioClassStuffDetail[item.grid].left,item.rightClass=ratioClassStuffDetail[item.grid].right):(item.leftClass=ratioClassStuffDetail[global.get("store").val.template.stuffDetailType[global.get("sectionType").val].ratio].left,item.rightClass=ratioClassStuffDetail[global.get("store").val.template.stuffDetailType[global.get("sectionType").val].ratio].right),self.item?self.item.leftClass!=item.leftClass?leftRow.removeAttr("class"):self.item.rightClass!=item.rightClass&&rightRow.removeAttr("class"):(leftRow.removeAttr("class"),rightRow.removeAttr("class")),self.objShare=seoContent.setDataItem(item),$rootScope.$broadcast("reloadGallery");for(var key in self.item)"gallery"!=key&&"sortsOfStuff"!=key&&(item[key]&&"function"!=typeof item[key]?self.item[key]=item[key]:delete self.item[key]);for(var key in item)"gallery"==key||"sortsOfStuff"==key||self.item[key]||(self.item[key]=item[key]);if(self.activeSlide=0,item.sortsOfStuff&&item.sortsOfStuff.stuffs&&item.sortsOfStuff.stuffs.length){var filterGroup,filterGroupTags=[];item.sortsOfStuff.filterGroup&&(filterGroup=_filtersO[item.sortsOfStuff.filterGroup])&&(filterGroupTags=filterGroup.tags.map(function(t){return t._id})),item.sortsOfStuff.stuffs.forEach(function(stuff,i){stuff.gallery.forEach(function(s,ii){s.active=!ii});for(var ii=0;ii<stuff.tags.length;ii++){var idx=filterGroupTags.indexOf(stuff.tags[ii]);if(idx>-1){filterGroup.tags[idx].img&&(item.sortsOfStuff.stuffs[i].gallery[0].thumbSmallTag=filterGroup.tags[idx].img);break}}}),self.item.sortsOfStuff=item.sortsOfStuff}setComments()}).then(function(){$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")},300)}).then(function(){self.item.FullTags=self.item.tags.map(function(t){return t&&(t=angular.copy(global.get("filterTags").val.getOFA("_id",t)))?(t.filter&&!t.filter._id&&(t.filter=global.get("filters").val.getOFA("_id",t.filter)),t):null});var likes=localStorage.get(subDomain+"-likes");likes&&likes.length&&likes.some(function(s){return s===$scope.stuff._id})?$scope.stuff.inLikes=!0:$scope.stuff.inLikes=!1}).then(function(){}).catch(function(err){console.log(err),err=err.data||err,exception.catcher("получение товара")(err)})}function setComments(){if(global.get("store").val.disqus){self.disqusConfig={disqus_shortname:global.get("store").val.disqus,disqus_identifier:self.item._id,disqus_url:$location.absUrl(),disqus_title:self.item.name,disqus_config_language:global.get("store").val.lang};var u=self.disqusConfig.disqus_url.split("/");u[u.length-1]=self.item.url,self.disqusConfig.disqus_url=u.join("/")}else self.getComments(0),self.commentName=global.get("user").val?global.get("user").val.name||global.get("user").val.profile.fio:""}function prepareStuffList(){if(global.get("stuffsInList").val){maxNumInRow=0,stuffsInList=[],currentStuffInList=0;for(var k in global.get("stuffsInList").val)global.get("stuffsInList").val[k].length&&global.get("stuffsInList").val[k].length>maxNumInRow&&(maxNumInRow=global.get("stuffsInList").val[k].length);for(var j=0;j<maxNumInRow;j++)for(var i=1;i<=6;i++)global.get("stuffsInList").val["td-list-"+i]&&global.get("stuffsInList").val["td-list-"+i].length&&global.get("stuffsInList").val["td-list-"+i][j]&&stuffsInList.push(global.get("stuffsInList").val["td-list-"+i][j]);for(var i=0;i<stuffsInList.length;i++)if(self.item&&self.item._id==stuffsInList[i]._id){currentStuffInList=i;break}}}function nextStuff(){slideDelay||(slideDelay=!0,$timeout(function(){slideDelay=!1},150),currentStuffInList<stuffsInList.length-1?(currentStuffInList++,stuffsInList&&stuffsInList[currentStuffInList]&&(self.item=stuffsInList[currentStuffInList])):$rootScope.$broadcast("addBlockAfterScroll"))}function prevStuff(){slideDelay||(slideDelay=!0,$timeout(function(){slideDelay=!1},700),currentStuffInList>0&&currentStuffInList--,stuffsInList&&stuffsInList[currentStuffInList]&&(self.item=stuffsInList[currentStuffInList]))}function returnToList(){window.history.back()}function getTagName(tag){if(tag)return global.get("filterTagsO").val[tag].name}function getFilterName(filter){if(filter)return global.get("filtersO").val[filter].name}function addToLikes($event){$event.stopPropagation(),console.log("addToLikes"),(likes=localStorage.get(subDomain+"-likes"))||(likes=[]);var i=likes.indexOf($scope.stuff._id);i>-1?($scope.stuff.inLikes=!1,likes.splice(i,1)):($scope.stuff.inLikes=!0,likes.push($scope.stuff._id)),localStorage.set(subDomain+"-likes",likes),$rootScope.likes.totalCount=likes.length}var self=this;self.global=global,$scope.global=global,$scope.stuff=JSON.parse($attrs.stuffFromServer);var subDomain=global.get("store").val.subDomain;$scope.stuff=Stuff.setDataForStuff($scope.stuff,global.get("filterTags").val),self.stuff=$scope.stuff,self.item=$scope.stuff,self.objShare=seoContent.setDataItem(self.item);var slideDelay,stuffsInList=[],currentStuffInList=null,maxNumInRow=0;self.global=global,self.lang=global.get("store").val.lang,self.rate=global.get("rate"),self.mobile=global.get("mobile").val,self.crawler=global.get("crawler").val,self.currency=global.get("currency"),self.moment=moment,self.activeSlide=0,self.paginate={rows:5,page:0,items:0},self.gallery=[],self.chancheActiveSlide=chancheActiveSlide,self.getMastersName=getMastersName,self.decreaseQty=decreaseQty,self.increaseQty=increaseQty,self.chancheStuff=chancheStuff,self.nextStuff=nextStuff,self.prevStuff=prevStuff,self.returnToList=returnToList,self.getComments=getComments,self.getTagName=getTagName,self.getFilterName=getFilterName,self.getAveragePrice=getAveragePrice,self.goToSchedule=goToSchedule,self.addToLikes=addToLikes,self.getAddInfoInModal=getAddInfoInModal;var currency=global.get("currency").val,formatAverage=global.get("store").val.currency[currency][4],del=-1;1==formatAverage?del=-1:2==formatAverage?del=0:3==formatAverage?del=1:4==formatAverage&&(del=2),self.formatPrice=global.get("store").val.currency[currency][5],void 0===self.formatPrice&&(self.formatPrice=2),$rootScope.$on("changeCurrency",function(){currency=global.get("currency").val,formatAverage=global.get("store").val.currency[currency][4],self.formatPrice=global.get("store").val.currency[currency][5],void 0===self.formatPrice&&(self.formatPrice=2),del=-1,1==formatAverage?del=-1:2==formatAverage?del=0:3==formatAverage?del=1:4==formatAverage&&(del=2)}),$scope.$on("logged",function(){self.commentName=global.get("user").val?global.get("user").val.name||global.get("user").val.profile.fio:""}),$scope.$on("addBlockAfterScrollDone",function(){prepareStuffList(),nextStuff()});var likes=localStorage.get(subDomain+"-likes");likes&&likes.length&&likes.some(function(s){return s===$scope.stuff._id})?$scope.stuff.inLikes=!0:$scope.stuff.inLikes=!1,getMastersName(),setComments(),$scope.$on("$destroy",function(){$animate.enabled(!0)})},transclude:!0,link:function(scope,element,attrs,ctrl,transclude){$timeout(function(){$(element).find('a[href^="#"]').each(function(i,anchor){var selector=$(anchor).attr("href");selector&&(selector=selector.substring(1)),$(anchor).click(function(e){e.preventDefault();var el=$("[id="+selector+"]");if(el&&el[0])el[0].scrollIntoView({behavior:"smooth"});else{var el=$("[name="+selector+"]");el&&el[0]&&el[0].scrollIntoView({behavior:"smooth"})}})})},1e3),$timeout(function(){global.get("stuffsInList").val&&element[0].parentElement&&element[0].parentElement.parentElement&&element[0].parentElement.parentElement.id&&global.get("stuffsInList").val[element[0].parentElement.parentElement.id]&&global.get("stuffsInList").val[element[0].parentElement.parentElement.id].push(scope.stuff),document.querySelectorAll('a[href^="#"]').forEach(function(anchor){console.log(anchor),anchor.addEventListener("click",function(e){e.preventDefault(),document.querySelector(this.getAttribute("href")).scrollIntoView({behavior:"smooth"})})}),transclude(scope,function(clone){element.append(clone);try{if(window.videojs){var vv=document.getElementsByClassName("mainVideo");vv[0]&&scope.stuff.videoLink&&videojs(vv[0],{fluid:!0,techOrder:["vimeo"],sources:[{type:"video/vimeo",src:scope.stuff.videoLink}],vimeo:{color:"#fbc51b"}},function(){});var videoTizer=document.getElementsByClassName("videoTeaser");if(videoTizer[0]&&scope.stuff.media2){var options={fluid:!0,techOrder:["vimeo"],sources:[{type:"video/vimeo",src:scope.stuff.media2}],vimeo:{color:"#fbc51b"}};videojs(videoTizer[0],options,function(){})}document.getElementsByClassName("videoPreview")}}catch(err){console.log(err)}})},200)}}}function galleryСarouselCtrl($scope,$timeout,$element,$compile,global){function prev(){console.log("prev")}function next(){console.log("next")}console.log("galleryСarouselCtrl");var self=this;self.prev=prev,self.next=next,self.moment=moment,self.global=global,this.$onInit=function(){$timeout(function(){var navLeft=$element.find(".nav-left");$(navLeft).click(function(){prev()});var navRight=$element.find(".nav-right");$(navRight).click(function(){next()})},100)}}angular.module("gmall.directives").directive("stuffDetailTemplate",itemDirectiveFromServer).directive("stuffFromServer",stuffFromServer).directive("stuffCart",stuffCartDirective).directive("homePageStuff",homePageStuffDirective).directive("gallerySmall",gallerySmallDirective).directive("directiveBlockStuff",function($compile,$interpolate){return{template:"",link:function($scope,element,attributes){var attr=attributes.blockTempl?attributes.blockTempl:"",div="<div "+attributes.directiveBlockStuff.toLowerCase()+'-block-stuff block-templ="'+attr+'"></div>';element.append($compile(div)($scope))}}}).directive("nameBlockStuff",nameBlockStuff).directive("textBlockStuff",textBlockStuff).directive("text2BlockStuff",text2BlockStuff).directive("bannerBlockStuff",bannerBlockStuff).directive("banner1BlockStuff",banner1BlockStuff).directive("sliderBlockStuff",sliderBlockStuff).directive("videoBlockStuff",videoBlockStuff).directive("video1BlockStuff",video1BlockStuff).directive("video2BlockStuff",video2BlockStuff).directive("mapBlockStuff",mapBlockStuff).directive("map1BlockStuff",map1BlockStuff).directive("map2BlockStuff",map2BlockStuff).directive("mastersBlockStuff",mastersBlockStuff).directive("feedbackBlockStuff",feedbackBlockStuff).directive("feedback1BlockStuff",feedback1BlockStuff).directive("feedback2BlockStuff",feedback2BlockStuff).directive("stuffsBlockStuff",imgsBlockStuff).directive("filterTagsBlockStuff",imgsBlockStuff).directive("brandTagsBlockStuff",imgsBlockStuff).directive("brandsBlockStuff",imgsBlockStuff).directive("categoriesBlockStuff",imgsBlockStuff).directive("campaignBlockStuff",imgsBlockStuff).directive("dateBlockStuff",dateBlockStuff).directive("positionBlockStuff",positionBlockStuff).directive("videolinkBlockStuff",videoLinkBlockStuff).directive("snBlockStuff",snBlockStuff).directive("calendarBlockStuff",calendarBlockStuff).directive("galleryCarouselControls",galleryСarouselControls).directive("carouselControls",function(){return{restrict:"A",link:function(scope,element,attrs){scope.goNext=function(){element.isolateScope().next()},scope.goPrev=function(){element.isolateScope().prev()}}}}).directive("dirDisqus",["$window","global",function($window,global){return{restrict:"E",scope:{config:"="},template:'<div id="disqus_thread"></div><a href="http://disqus.com" class="dsq-brlink"></a>',link:function(scope){function configChanged(n,o){if(n&&scope.config.disqus_shortname&&scope.config.disqus_identifier&&scope.config.disqus_url)if($window.disqus_shortname=scope.config.disqus_shortname,$window.disqus_identifier=scope.config.disqus_identifier,$window.disqus_url=scope.config.disqus_url,$window.disqus_title=scope.config.disqus_title,$window.DISQUS)$window.DISQUS.reset({reload:!0,config:function(){this.page.identifier=scope.config.disqus_identifier,this.page.url=scope.config.disqus_url,this.page.title=scope.config.disqus_title}});else{var dsq=document.createElement("script");dsq.type="text/javascript",dsq.async=!0,dsq.src="https://"+scope.config.disqus_shortname+".disqus.com/embed.js",dsq.setAttribute("data-timestamp",+new Date),(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq)}}scope.$watch("config",configChanged,!0)}}}]).directive("checkOrienForPhoto",["$window",function($window,global){return{restrict:"A",link:function(scope,elem,attrs){function loaded(){img.naturalWidth&&img.naturalHeight&&img.naturalWidth<img.naturalHeight?elem.addClass("img-detail"):elem.removeClass("img-detail")}var img=elem[0];img.complete?loaded():(img.addEventListener("load",loaded),img.addEventListener("error",function(){})),attrs.$observe("src",function(newValue,oldValue){newValue&&oldValue&&newValue!==oldValue&&console.log(newValue)})}}}]),itemCtrl.$inject=["$scope","$anchorScroll","global","Stuff","$stateParams","$window","$q","BrandTags","FilterTags","Filters","AddInfo","Comments","exception","seoContent","$location","Sections","$uibModal","$notification","$rootScope","$timeout","$element"],homePageStuffCtrl.$inject=["$scope","global","Stuff","$q","$compile","$element","exception"],gallerySmallCtrl.$inject=["$element","$timeout","$scope","$attrs"],stuffDetailFromServerCtrl.$inject=["$scope","$element","$compile","$http","$stateParams","$state","$anchorScroll","global","$q","$rootScope","$location","$timeout","$sce"],galleryСarouselCtrl.$inject=["$scope","$timeout","$element","$compile","global"]}(),angular.module("gmall.directives").directive("filterForStuffs",["$rootScope","global","$q","$location","$section","Collection","Sections","Filter","FilterTags","Brands","Category",function($rootScope,global,$q,$location,$section,Collection,Sections,Filter,FilterTags,Brands,Category){return{scope:{query:"=",section:"=",admin:"@"},restrict:"E",templateUrl:"components/stuff/filterForStuffs.html",link:function($scope,element,attrs){function getTagFromCategoriesList(tag,field){var category=$scope.filterDirective.category
;if(category&&category.filters&&category.filters.length)for(var ii=0,ll=category.filters.length;ii<ll;ii++){var filter=category.filters[ii];if(filter&&filter.tags&&filter.tags.length)for(var iii=0,lll=filter.tags.length;iii<lll;iii++)if(filter.tags[iii][field]==tag)return filter.tags[iii]}}function _setBrand(brandId,filed){brandId&&$scope.filterDirective.brands?($scope.filterDirective.brand=$scope.filterDirective.brands.getObjectFromArray(filed,brandId),$scope.filterDirective.brand?($scope.filterDirective.query.brand=$scope.filterDirective.brand._id,$location.search("brand",$scope.filterDirective.brand.url),$scope.filterDirective.brandCollections=$scope.filterDirective.brand.tags):($scope.filterDirective.brandCollections=[],$location.search("brand",null))):($scope.filterDirective.brandCollections=[],$location.search("brand",null))}function _setBrandTag(brandTagId,filed){if(brandTagId&&$scope.filterDirective.brandCollections){var brandTag=$scope.filterDirective.brandCollections.getObjectFromArray(filed,brandTagId);brandTag?($scope.filterDirective.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}else $location.search("brandTag",null)}function _setFilterTagsUrl(){if($scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length){var queryTag=$scope.filterDirective.filterTags.map(function(tag){return tag.url}).join("+");$location.search("queryTag",queryTag||null)}else $location.search("queryTag",null)}function _getQueryTag(){var arr=[];return $scope.filterDirective.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr}console.log("??????????????");var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.filterDirective={},$scope.filterDirective.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$q.when().then(function(){return Sections.getSections()}).then(function(sections){var q=$q.defer();return"brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl?($stateParams.parentGroup?$scope.parentSection=Sections.getParentSection($stateParams.parentGroup):$scope.parentSection=Sections.getParentSection($stateParams.groupUrl),"allCategories"==$stateParams.categoryList||"category"!=$stateParams.categoryUrl?($scope.filterDirective.categories=$scope.parentSection.categories,$scope.filterDirective.sectionCategories=$scope.filterDirective.categories.map(function(el){return el._id}),"category"!=$stateParams.categoryUrl?Category.get({id:$stateParams.categoryUrl},function(res){$scope.filterDirective.query.category=res._id,$scope.filterDirective.category=res,$scope.filterDirective.category.brands&&$scope.filterDirective.category.brands.length&&($scope.filterDirective.brands=$scope.filterDirective.category.brands),q.resolve()}):q.resolve()):($scope.filterDirective.sectionCategories=Sections.getEmbededCategories($scope.parentSection,[]).map(function(el){return el._id}),$scope.filterDirective.sectionCategories.length||($scope.filterDirective.sectionCategories=[null]),q.resolve())):q.resolve(),q.promise}).then(function(){console.log($scope.filterDirective.brands);var q=$q.defer();return $stateParams.brand&&!$scope.filterDirective.brands?Brands.query(function(res){res.shift(),$scope.filterDirective.brands=res,q.resolve()}):q.resolve(),q.promise}).then(function(){_setBrand($stateParams.brand,"url"),_setBrandTag($stateParams.brandTag,"url")}).then(function(){var q=$q.defer();if($stateParams.queryTag){var queryTags=$stateParams.queryTag.split("+");queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),$scope.filterDirective.categories?($scope.filterDirective.filterTags=queryTags.map(function(tag){return getTagFromCategoriesList(tag,"url")}).filter(function(tag){return tag}),q.resolve()):FilterTags.getTagsByUrl(queryTags,function(res){$scope.filterDirective.filterTags=res,q.resolve()})}else q.resolve();return q.promise}).then(function(){_setFilterTagsUrl()}).then(function(){$scope.filterDirective.query.category&&$scope.filterDirective.category?$scope.filterDirective.category.filters&&$scope.filterDirective.category.filters.length&&($scope.filterDirective.category.filters.forEach(function(item,i){$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&$scope.filterDirective.filterTags.forEach(function(tag){tag.filter==item._id&&($scope.filterDirective.query.tags[i]||($scope.filterDirective.query.tags[i]=[]),$scope.filterDirective.query.tags[i].push(tag._id))})}),$scope.filterDirective.filters=$scope.filterDirective.category.filters):$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&($scope.filterDirective.query.tags[0]=[],$scope.filterDirective.filterTags.forEach(function(tag){$scope.filterDirective.query.tags[0].push(tag._id)}))}).then(function(){$scope.filterDirective.getQuery()}).catch(function(err){console.log(err)}),$scope.filterDirective.getQuery=function(){var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});for(var key in $scope.filterDirective.query)if($scope.filterDirective.query[key])if("tags"==key){var qu=[];$scope.filterDirective.query[key].filter(function(){return!0});$scope.filterDirective.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.filterDirective.query[key],query.push(obj)}else if("category"==key&&$scope.filterDirective.sectionCategories&&$scope.filterDirective.sectionCategories.length){var obj={};obj.category={$in:$scope.filterDirective.sectionCategories},query.push(obj)}return query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):{},void($scope.query=query)},$scope.filterDirective.changeFilter=function(reloadController){if(reloadController){if($scope.filterDirective.category&&$scope.filterDirective.query.category==$scope.filterDirective.category._id)return;if($scope.filterDirective.query.category){var categoryUrl=$scope.filterDirective.categories.getObjectFromArray("_id",$scope.filterDirective.query.category);categoryUrl=categoryUrl?categoryUrl.url:"category",$location.search("categoryList",null)}else{var categoryUrl="category";$location.search("categoryList","allCategories")}$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:categoryUrl,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else $scope.filterDirective.query.artikul="",_setBrand($scope.filterDirective.query.brand,"_id"),_setBrandTag($scope.filterDirective.query.brandTag,"_id"),$scope.filterDirective.filterTags=_getQueryTag().map(function(tag){return getTagFromCategoriesList(tag,"_id")}).filter(function(tag){return tag}),_setFilterTagsUrl(),$scope.filterDirective.getQuery()},$scope.filterDirective.clearFilter=function(){console.log("clear filetrs"),$scope.filterDirective.query.tags=[],$scope.filterDirective.changeFilter()}}}}]).directive("filterForStuffsClinic",["$rootScope","global","$q","$location","$section","Collection","Sections","Filter","FilterTags","Brands","Category",function($rootScope,global,$q,$location,$section,Collection,Sections,Filter,FilterTags,Brands,Category){return{scope:{query:"=",section:"=",admin:"@"},restrict:"E",templateUrl:"views/clinic/partials/stuff/filterForStuffs.html",link:function($scope,element,attrs){function getTagFromCategoriesList(tag,field){var category=$scope.filterDirective.category;if(category&&category.filters&&category.filters.length)for(var ii=0,ll=category.filters.length;ii<ll;ii++){var filter=category.filters[ii];if(filter&&filter.tags&&filter.tags.length)for(var iii=0,lll=filter.tags.length;iii<lll;iii++)if(filter.tags[iii][field]==tag)return filter.tags[iii]}}function _setBrand(brandId,filed){brandId&&$scope.filterDirective.brands?($scope.filterDirective.brand=$scope.filterDirective.brands.getObjectFromArray(filed,brandId),$scope.filterDirective.brand?($scope.filterDirective.query.brand=$scope.filterDirective.brand._id,$location.search("brand",$scope.filterDirective.brand.url),$scope.filterDirective.brandCollections=$scope.filterDirective.brand.tags):($scope.filterDirective.brandCollections=[],$location.search("brand",null))):($scope.filterDirective.brandCollections=[],$location.search("brand",null))}function _setBrandTag(brandTagId,filed){if(brandTagId&&$scope.filterDirective.brandCollections){var brandTag=$scope.filterDirective.brandCollections.getObjectFromArray(filed,brandTagId);brandTag?($scope.filterDirective.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}else $location.search("brandTag",null)}function _setFilterTagsUrl(){if($scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length){var queryTag=$scope.filterDirective.filterTags.map(function(tag){return tag.url}).join("+");$location.search("queryTag",queryTag||null)}else $location.search("queryTag",null)}function _getQueryTag(){var arr=[];return $scope.filterDirective.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr}var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.filterDirective={},$scope.filterDirective.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$q.when().then(function(){return Sections.getSections()}).then(function(sections){var q=$q.defer();return"brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl?($stateParams.parentGroup?$scope.parentSection=Sections.getParentSection($stateParams.parentGroup):$scope.parentSection=Sections.getParentSection($stateParams.groupUrl),"allCategories"==$stateParams.categoryList||"category"!=$stateParams.categoryUrl?($scope.filterDirective.categories=$scope.parentSection.categories,$scope.filterDirective.sectionCategories=$scope.filterDirective.categories.map(function(el){return el._id}),"category"!=$stateParams.categoryUrl?Category.get({id:$stateParams.categoryUrl},function(res){$scope.filterDirective.query.category=res._id,$scope.filterDirective.category=res,$scope.filterDirective.category.brands&&$scope.filterDirective.category.brands.length&&($scope.filterDirective.brands=$scope.filterDirective.category.brands),console.log($scope.filterDirective.brands),q.resolve()}):q.resolve()):($scope.filterDirective.sectionCategories=Sections.getEmbededCategories($scope.parentSection,[]).map(function(el){return el._id}),$scope.filterDirective.sectionCategories.length||($scope.filterDirective.sectionCategories=[null]),q.resolve())):q.resolve(),q.promise}).then(function(){var q=$q.defer();return $stateParams.brand&&!$scope.filterDirective.brands?Brands.query(function(res){res.shift(),$scope.filterDirective.brands=res,q.resolve()}):q.resolve(),q.promise}).then(function(){_setBrand($stateParams.brand,"url"),_setBrandTag($stateParams.brandTag,"url")}).then(function(){var q=$q.defer();if($stateParams.queryTag){var queryTags=$stateParams.queryTag.split("+");queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),$scope.filterDirective.categories?($scope.filterDirective.filterTags=queryTags.map(function(tag){return getTagFromCategoriesList(tag,"url")}).filter(function(tag){return tag}),q.resolve()):FilterTags.getTagsByUrl(queryTags,function(res){$scope.filterDirective.filterTags=res,q.resolve()})}else q.resolve();return q.promise}).then(function(){_setFilterTagsUrl()}).then(function(){$scope.filterDirective.query.category&&$scope.filterDirective.category?$scope.filterDirective.category.filters&&$scope.filterDirective.category.filters.length&&($scope.filterDirective.category.filters.forEach(function(item,i){$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&$scope.filterDirective.filterTags.forEach(function(tag){tag.filter==item._id&&($scope.filterDirective.query.tags[i]||($scope.filterDirective.query.tags[i]=[]),$scope.filterDirective.query.tags[i].push(tag._id))})}),$scope.filterDirective.filters=$scope.filterDirective.category.filters):$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&($scope.filterDirective.query.tags[0]=[],$scope.filterDirective.filterTags.forEach(function(tag){$scope.filterDirective.query.tags[0].push(tag._id)}))}).then(function(){$scope.filterDirective.getQuery()}).catch(function(err){console.log(err)}),$scope.filterDirective.getQuery=function(){var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});for(var key in $scope.filterDirective.query)if($scope.filterDirective.query[key])if("tags"==key){var qu=[];$scope.filterDirective.query[key].filter(function(){return!0});$scope.filterDirective.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.filterDirective.query[key],query.push(obj)}else if("category"==key&&$scope.filterDirective.sectionCategories&&$scope.filterDirective.sectionCategories.length){var obj={};obj.category={$in:$scope.filterDirective.sectionCategories},query.push(obj)}return query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):{},void($scope.query=query)},$scope.filterDirective.changeFilter=function(reloadController){if(reloadController){if($scope.filterDirective.category&&$scope.filterDirective.query.category==$scope.filterDirective.category._id)return;if($scope.filterDirective.query.category){var categoryUrl=$scope.filterDirective.categories.getObjectFromArray("_id",$scope.filterDirective.query.category);categoryUrl=categoryUrl?categoryUrl.url:"category",$location.search("categoryList",null)}else{var categoryUrl="category";$location.search("categoryList","allCategories")}$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:categoryUrl,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else $scope.filterDirective.query.artikul="",_setBrand($scope.filterDirective.query.brand,"_id"),_setBrandTag($scope.filterDirective.query.brandTag,"_id"),$scope.filterDirective.filterTags=_getQueryTag().map(function(tag){return getTagFromCategoriesList(tag,"_id")}).filter(function(tag){return tag}),_setFilterTagsUrl(),$scope.filterDirective.getQuery()},$scope.filterDirective.clearFilter=function(){console.log("clear filetrs"),$scope.filterDirective.query.tags=[],$scope.filterDirective.changeFilter()}}}}]),angular.module("gmall.directives").directive("stuffsAdminListWithPaginate",["$rootScope","Stuff","$timeout","$q","Sections","createStuffService","queryFromUrlService","filterStuffsListService","FilterTags","Filters",function($rootScope,Stuff,$timeout,$q,Sections,createStuffService,queryFromUrlService,filterStuffsListService,FilterTags,Filters){return{restrict:"E",scope:{query:"=",rate:"=",mobile:"@"},templateUrl:"components/stuff/stuffsAdminListWithPaginate.html",link:function($scope,element,attrs,ctrl){function prepareQueryForRequest(queryStart){var query=[];for(var key in queryStart)if(queryStart[key])if("tags"==key){var qu=[];for(var key2 in queryStart[key]){var obj=queryStart[key][key2],q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=queryStart[key],query.push(obj)}return query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):{}}var $state=$rootScope.$state;$rootScope.$stateParams;$scope.global=$rootScope.global,setTimeout(function(){$rootScope.displaySlideMenu=!0},400);var query,queryForFilter;$scope.paginate={page:0,rows:20,totalItems:0},$scope.newStuff={name:"",actived:!1},$scope.saveStuff=function(stuff,field){var f=field.split(" "),o={_id:stuff._id};f.forEach(function(el){o[el]=stuff[el]}),Stuff.Items.save({update:field},o,function(res){console.log(res),"index"==f[0]&&$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")})},$scope.getList=function(page,rows,reload){return $scope.paginate.page!=page&&($scope.paginate.page=page),$q(function(resolve,reject){var queryString;queryString=reload?query:$scope.query,Stuff.getList(queryString,null,page,rows,$scope.paginate).then(function(res){if($scope.items=res,$scope.newStuff.index=$scope.items&&$scope.items[0]?$scope.items[0].index:1,!reload){try{query=JSON.parse($scope.query)}catch(err){query={}}$scope.query=null}resolve()},function(err){reject(err)})})};$scope.getUrlParams=Stuff.getUrlParams,$scope.getCategoryName=Stuff.getCategoryName,$scope.getBrandName=Stuff.getBrandName,$scope.reloadList=function(){$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")},$scope.searchStuff=function(artikul){if(artikul&&!(artikul.length<3)){artikul=artikul.substring(0,20),$state.current.reloadOnSearch=!0;var o={groupUrl:"group",categoryUrl:"category",searchStr:artikul.substring(0,20),queryTag:null,brand:null,brandTag:null,categoryList:null};$state.go($state.current.name,o,{reload:!0})}},$scope.filterList=function(){$q.when().then(function(){return filterStuffsListService.setFilters(queryForFilter)}).then(function(query){return queryForFilter=query,$scope.query=prepareQueryForRequest(query),$scope.getList($scope.paginate.page,$scope.paginate.rows)}).then(function(){}).catch(function(err){console.log(err)})},$scope.cloneStuff=function(stuff){var newStuff=angular.copy(stuff);$q.when().then(function(){return createStuffService.cloneStuff(newStuff,!0)}).then(function(stuff){return console.log($scope.newStuff==stuff),$scope.newStuff=stuff,$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")}).then(function(){var url=newStuff.url;$state.go("frame.stuffs.stuff",{groupUrl:"group",categoryUrl:"category",stuffUrl:url})}).catch(function(err){console.log(err)})},$scope.createNewStuff=function(){$q.when().then(function(){return createStuffService.cloneStuff($scope.newStuff)}).then(function(stuff){return console.log($scope.newStuff==stuff),$scope.newStuff=stuff,$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")}).then(function(){var url=$scope.newStuff.url;$scope.newStuff={name:"",actived:!1},$state.go("frame.stuffs.stuff",{groupUrl:"group",categoryUrl:"category",stuffUrl:url})}).catch(function(err){console.log(err)})},$scope.deleteStuff=function(stuff){confirm("удалить???")&&Stuff.Items.delete({_id:stuff._id},function(res){$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")})},$q.when().then(function(){return queryFromUrlService.get()}).then(function(query){return queryForFilter=query,$scope.query=prepareQueryForRequest(query),$scope.getList($scope.paginate.page,$scope.paginate.rows)}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){$scope.filterTags=filterTags}).then(function(){return Filters.getFilters()}).then(function(filters){$scope.filters=filters}).catch(function(err){console.log(err)}),$scope.getTagName=function(_id){if(_id)return $scope.filterTags.getOFA("_id",_id).name||null},$scope.getFilterName=function(_id){return $scope.filters.getOFA("_id",_id).name||null},$scope.changeSortOfStuff=function(stuff){var sort=stuff.stock[stuff.sort];stuff.price=sort.price,stuff.priceSale=sort.priceSale,stuff.retail=sort.retail},$scope.filterSorts=function(sort){return sort.value.quantity},$scope.onSelected=function(){setTimeout(function(){$(":focus").blur()})}}}}]),angular.module("gmall.directives").directive("additionaInfo",function(){return{scope:{stuff:"="},bindToController:!0,controller:additionaInfoCtrl,controllerAs:"$ctrl",templateUrl:"components/additionaInfo/additionaInfo.html"}}).service("AddInfo",function($resource,$q,$uibModal){function selectItem(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/additionalInfo/selectItem.html",controller:selectItemCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){reject()})})}function selectItemCtrl(Filters,AddInfo,$uibModalInstance,$q,global){var self=this;self.global=global,self.lang=global.get("lang").val,$q.when().then(function(){return Filters.getFilters()}).then(function(filters){return self.filters=filters,AddInfo.query().$promise}).then(function(addInfos){self.filters.forEach(function(f){f.addInfos=[],addInfos.forEach(function(a){a.filter==f._id&&f.addInfos.push(a)})})}),self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(item){$uibModalInstance.close(item)}}function editTable(filter,addInfo){return $uibModal.open({animation:!0,templateUrl:"components/additionalInfo/additionalInfo.html",controller:function(filter,carrentAddInfo,AddInfo,$uibModalInstance,global,exception,Confirm){function activate(){initItem(),AddInfo.query({query:query},function(res){res.shift(),self.items=res},function(err){console.log(err)})}function initItem(){if(self.item={headerTable:{},table:{},name:"",filter:filter._id},filter.tags.forEach(function(tag){self.item.table[tag._id]={}}),langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[lang]=[""];for(var key in self.item.table)self.item.table[key][lang]=[""]});else{self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[self.lang]=[""];for(var key in self.item.table)self.item.table[key][self.lang]=[""]}}var self=this;self.global=global,self.lang=global.get("store").val.lang;var langArr=global.get("store").val.langArr;console.log(langArr),filter?self.filter=filter:$uibModalInstance.dismiss("cancel");var query={filter:filter._id};self.items=[],activate(),self.getTagName=function(id){for(var i=1,l=self.filter.tags.length;i<l;i++)if(self.filter.tags[i]._id==id)return self.filter.tags[i].name;return"noname"},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.saveTable=function(){self.item.name||(self.item.name=filter.name),self.item._id?AddInfo.save({update:"headerTable table name"},self.item,function(res){activate()}):AddInfo.save(self.item,function(res){activate()})},self.addRow=function(){if(langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[lang].push("");for(var key in self.item.table)self.item.table[key][lang].push("")});else{self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[self.lang].push("");for(var key in self.item.table)self.item.table[key][self.lang].push("")}console.log(self.item)},self.deleteRow=function(i){if(langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable[lang].splice(i,1);for(var key in self.item.table)self.item.table[key][lang].splice(i,1)});else{self.item.headerTable[self.lang].splice(i,1);for(var key in self.item.table)self.item.table[key][self.lang].splice(i,1)}},self.editTable=function(item){if(console.log(item),self.item=item,langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable[lang].push("");for(var key in self.item.table)self.item.table[key][lang].push("")});else{self.item.headerTable[self.lang].push("");for(var key in self.item.table)self.item.table[key][self.lang].push("")}},self.deleteTable=function(item){Confirm("удалить?").then(function(){return AddInfo.delete({id:item._id}).$promise}).then(function(){return activate()}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление")(err)})},self.setTable=function(item){if(self.item=item,langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable||(self.item.headerTable={},self.item.headerTable[lang]=[],self.item.headerTable[lang].push(""));for(var key in self.item.table)self.item.table[key][lang]||(self.item.table[key][lang]=[],self.item.table[key][lang].push(""))});else{self.item.headerTable||(self.item.headerTable={},self.item.headerTable[self.lang]=[],self.item.headerTable[self.lang].push(""));for(var key in self.item.table)self.item.table[key].length&&(self.item.table[key]={},self.item.table[key][self.lang]=[],self.item.table[key][self.lang].push(""))}console.log(self.item)}},controllerAs:"$ctrl",size:"lg",resolve:{filter:function(){return filter},carrentAddInfo:function(){return addInfo}}}).result.then(function(addInfo){console.log(addInfo)},function(){})}var Items=$resource("/api/collections/AddInfo/:id",{id:"@_id"});this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.editTable=editTable,this.select=selectItem,selectItemCtrl.$inject=["Filters","AddInfo","$uibModalInstance","$q","global"]}),angular.module("gmall.services").service("$order",["localStorage","global","Orders","$q","$uibModal","CartInOrder","exception","$email","CreateContent","$notification","$state","$window","Coupon","$user","$rootScope","$timeout","$http",function(localStorage,global,Orders,$q,$uibModal,CartInOrder,exception,$email,CreateContent,$notification,$state,$window,Coupon,$user,$rootScope,$timeout,$http){function shipInfoCtrl($uibModalInstance,$rootScope,short){var self=this;self.short=short,$rootScope.$on("closeShipModal",function(){$uibModalInstance.close()}),self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}}var order,storageName;this.type=null,this.reinitCart=function(){order.comment="",delete order.action,delete order._id,delete order.num,delete order.date,delete order.seller;var seller=global.get("store").val.seller;order.setSellerData(seller._id,seller.cascade,seller.opt)},this.initOrderInList=function(res){var order=myShareData.getOrder(),mainCurrency=(global.get("campaign")&&global.get("campaign").val,global.get("store").val.mainCarrency),currencyStore=global.get("store").val.currency;global.get("currency")&&global.get("currency").val&&global.get("currency").val,global.get("store").val.seller;return order.type="order",order._id=res._id,order.init(res.campaign,mainCurrency,currencyStore),order.setCurrency(res.currency),order.kurs=order.currencyStore[order.currency][0],order.payInfo=res.seller.payInfo,order.setSellerData(res.seller,res.cascade,res.opt),order.unitOfMeasure=order._getUnitOfMeasure(),order.cart._id=res.cart,order.setDiscount(res.discount),order.setCoupon(res.coupon),order.date=res.date,order.date2=res.date2,order.date3=res.date3,order.date4=res.date4,order.date5=res.date5,order.invoice=res.invoice,order.invoiceInfo=res.invoiceInfo,order.pay=res.pay,order.shipCost=res.shipCost,order.num=res.num,order.status=res.status,order.profile=res.profile,order.comment=res.comment,order.note=res.note,order.user=res.user,order.shipDetail=res.shipDetail,order.domain=global.get("store").val.domain||global.get("store").val.subDomain,order.paySum=res.paySum,order},this.init=function(type,id){storageName=global.get("store").val._id;var q=$q.defer();order=myShareData.getOrder();var campaign=global.get("campaign")?global.get("campaign").val:null,mainCurrency=global.get("store").val.mainCarrency,currencyStore=global.get("store").val.currency,currency=global.get("currency")&&global.get("currency").val?global.get("currency").val:"UAH",seller=global.get("store").val.seller;if(this.type=type,order.type=type,"cart"==type){order.init(campaign,mainCurrency,currencyStore),order.setSellerData(seller._id,seller.cascade,seller.opt),order.setCurrency(currency),order.kurs=order.currencyStore[order.currency][0];var o=localStorage.get(storageName);o||(o=[],localStorage.set(storageName,o)),order.setCart(o),order.unitOfMeasure=order._getUnitOfMeasure(),order.totalCount=order._cartCount(),q.resolve(order)}else"order"==type&&(Orders.get({_id:id},function(res){res&&res._id||q.reject("404"),order._id=res._id,order.init(res.campaign,mainCurrency,currencyStore),order.setCurrency(res.currency),order.kurs=order.currencyStore[order.currency][0],order.payInfo=res.seller.payInfo,order.setSellerData(res.seller,res.cascade,res.opt),order.setCart(res.cart.stuffs),order.unitOfMeasure=order._getUnitOfMeasure(),order.cart._id=res.cart._id,order.setDiscount(res.discount),order.setCoupon(res.coupon),order.totalCount=order._cartCount(),order.date=res.date,order.date2=res.date2,order.date3=res.date3,order.date4=res.date4,order.date5=res.date5,order.invoice=res.invoice,order.invoiceInfo=res.invoiceInfo,order.pay=res.pay,order.shipCost=res.shipCost,order.num=res.num,order.status=res.status,order.profile=res.profile,order.comment=res.comment,order.note=res.note,order.user=res.user,order.shipDetail=res.shipDetail,order.domain=global.get("store").val.domain||global.get("store").val.subDomain,order.pn=res.pn,order.rn=res.rn,q.resolve(order)},function(err){q.reject(order)}),order.totalCount=order._cartCount());return q.promise},this.getOrder=function(){return order},this.addItemToCart=function(itemTo){itemTo.seller=global.get("seller").val,itemTo.img=itemTo.gallery&&itemTo.gallery.length&&itemTo.gallery[0].thumbSmall?itemTo.gallery[0].thumbSmall:"",itemTo.quantity||(itemTo.quantity=1),order.addStuffToOrder(itemTo),this.updateOrder(itemTo)},this.checkInCart=function(item){return order.checkInCart(item)},this.updateOrder=function(itemTo){order.totalCount=order._cartCount(),order.unitOfMeasure=order._getUnitOfMeasure(),itemTo&&$rootScope.$broadcast("$updateOrder",itemTo),"cart"==this.type?(localStorage.set(storageName,order.cart.stuffs),order.totalCount=order._cartCount()):$timeout(function(){},100).then(function(){var o=angular.copy(order.cart);return o.order=order._id,CartInOrder.save(o).$promise}).then(function(){return order.priceSaleHandle=order.cart.stuffs.some(function(s){return s.priceSaleHandle}),order.maxDiscountOver=order.cart.stuffs.some(function(s){return s.maxDiscountOver}),Orders.save({update:"totalCount sum paySum maxDiscountOver priceSaleHandle"},{_id:order._id,totalCount:order.totalCount,sum:order.sum,paySum:order.paySum,priceSaleHandle:order.priceSaleHandle,maxDiscountOver:order.maxDiscountOver}).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)}).catch(function(error){exception.catcher("сохранение изменений")(error)})},this.removeItem=function(i){order.cart.stuffs.splice(i,1),this.updateOrder()},this.decreaseQty=function(i){var stuff=order.cart.stuffs[i];stuff&&stuff.quantity>1&&(stuff.multiple&&stuff.minQty?stuff.quantity-1>=stuff.minQty&&(stuff.quantity--,this.updateOrder()):(stuff.quantity--,this.updateOrder()))},this.increaseQty=function(i){var stuff=order.cart.stuffs[i];stuff&&(stuff.single&&stuff.maxQty?stuff.quantity+1<=stuff.maxQty&&(stuff.quantity++,this.updateOrder()):(stuff.quantity++,this.updateOrder()))},this.clearCart=function(){order.clearOrder(),this.updateOrder()},this.cartCount=function(){return order.totalCount},this.sendOrder=function(user,opt,cabinet){return $q.when().then(function(){try{if(user){if(!user._id)throw"не авторизирован!"}else{if(!global.get("user").val||!global.get("user").val._id)throw"не авторизирован!";order.user=global.get("user").val,console.log(global.get("user").val.profile),order.profile=angular.copy(global.get("user").val.profile),order.profile.fio||(order.profile.fio=global.get("user").val.name)}order.action="order",order.comment?order.comment.clearTag(400):order.comment="",order.coupon&&order.coupon._id?order.paySum=order.kurs*order.getCouponSum():order.paySum=order.kurs*order.getTotalSum()}catch(err){throw err}}).then(function(){return $q(function(resolve,reject){if(order.coupon&&order.coupon._id)if(global.get("user").val.coupons||(global.get("user").val.coupons=[]),
global.get("user").val.coupons.indexOf(order.coupon._id)>-1)order.coupon=null,resolve();else{Date.now();Coupon.get({_id:order.coupon._id},function(coupon){coupon?(global.get("user").val.coupons||(global.get("user").val.coupons=[]),global.get("user").val.coupons=global.get("user").val.coupons.filter(function(el){return el}),global.get("user").val.coupons.push(coupon._id),$user.save({update:"coupons"},{_id:global.get("user").val._id,coupons:global.get("user").val.coupons},function(res){resolve()},function(err){if(err)return reject(err)})):(order.coupon=null,resolve())})}else resolve()})}).then(function(){if(opt&&"object"==typeof opt)for(var key in opt)order[key]=opt[key];return Orders.save(order).$promise}).then(function(res){if(!res.num||!res._id)throw"заказ не отправлен. произошла ошибка на сервере. не присвоен номер ордеру";try{order._id=res.id,order.num=res.num,order.date=Date.now(),order.seller=global.get("store").val.seller,order.status=1}catch(err){throw err}}).then(function(){if(global.get("store").val.seller.salemail){try{order.profile.admin="Admin";var email=global.get("store").val.seller.salemail,content=CreateContent.order(order,!1,!0);delete order.profile.admin;var domain=global.get("store").val.domain,subj=global.get("langOrder").val.neworder?global.get("langOrder").val.neworder.toUpperCase()+" ✔":"НОВЫЙ ЗАКАЗ ✔",o={email:email,content:content,subject:subj,from:global.get("store").val.name+"<sales@"+domain+">"}}catch(err){throw err}return $q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).then(function(){if(!global.get("store").val.typeOfReg||!global.get("store").val.typeOfReg.phone){try{order.user=user?user:global.get("user").val;var email=user?user.email:global.get("user").val.email,content=CreateContent.order(order,!1,!0),domain=global.get("store").val.domain,subj=global.get("langOrder").val.neworder?global.get("langOrder").val.neworder.toUpperCase()+" ✔":"НОВЫЙ ЗАКАЗ ✔",o={email:email,content:content,subject:subj,from:global.get("store").val.name+"<sales@"+domain+">"}}catch(err){throw err}return $q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).then(function(){try{var content=CreateContent.orderNote(order),o={addressee:"seller",type:"order",content:content,order:order._id,num:order.num,seller:order.seller._id}}catch(err){throw err}return $q(function(resolve,reject){$notification.save(o,function(res){resolve()},function(err){exception.catcher("error")(err),resolve()})})}).then(function(){try{if(cabinet)return $state.go("cabinet");var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","order");pap&&pap.url?$state.go("thanksPage",{id:pap.url}):exception.showToaster("note",global.get("langNote").val.orderSuccess,"")}else exception.showToaster("note",global.get("langNote").val.orderSuccess,"")}catch(err){throw err}}).catch(function(err){throw err})},this.changeCurrency=function(lan){order.changeCurrency(lan)},this.checkCampaign=function(stuff){return order&&order.type?order.checkCampaign(stuff):null},this.checkOutFromList=function(user){return order.comment=user.comment?user.comment:"",order.profile=user.profile,order.user=user._id,order.seller=global.get("store").val.seller._id,this.sendOrder(user)},this.getShipInfo=function(short){return $q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/order/modal/shipInfo.html",controller:shipInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass",resolve:{short:function(){return short}}});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})},shipInfoCtrl.$inject=["$uibModalInstance","$rootScope","short"],this.getCheckOutLiqpayHtml=function(order,invoice){return $q.when().then(function(){return invoice?$http.post("/api/orders/checkoutLiqpayInvoice",order):$http.post("/api/orders/checkoutLiqpay",order)}).then(function(res){res&&res.data.html&&(order.checkOutLiqpayHtml=res.data.html,order.checkOutLiqpayHtmlIs=!0)}).then(function(res){}).catch(function(err){exception.catcher("error")(err)})},this.checkWarehouse=function(){var virtualAccount;return $q.when().then(function(){if(!global.get("store").val.virtualAccount)return $http.get("/api/collections/VirtualAccount")}).then(function(r){if(r&&r.data&&r.data.length&&(global.get("store").val.virtualAccount=r.data[1]._id),!(virtualAccount=global.get("store").val.virtualAccount))throw"невозможно установить подразделение"}).then(function(){var acts=order.cart.stuffs.map(function(s){var q={stuff:s._id,sort:s.sort},url="/api/collections/Material?query="+JSON.stringify(q);return $http.get(url)});return $q.all(acts)}).then(function(checkResult){if(checkResult){return checkResult.map(function(rr,index){if(rr.data&&rr.data.length&&rr.data[1])for(var material=rr.data[1],i=0;i<material.data.length;i++)if((material.data[i].virtualAccount&&material.data[i].virtualAccount._id?material.data[i].virtualAccount._id:material.data[i].virtualAccount)==virtualAccount&&material.data[i].qty>=order.cart.stuffs[index].quantity)return order.cart.stuffs[index].priceUchet=material.data[i].price,order.cart.stuffs[index].supplierType=material.data[i].supplierType,order.cart.stuffs[index].supplier=material.data[i].supplier&&material.data[i].supplier._id?material.data[i].supplier._id:material.data[i].supplier,void(order.cart.stuffs[index].virtualAccount=virtualAccount);return order.cart.stuffs[index]})}throw"не возможно проверить наличие на складе"}).then(function(stuffs){if(stuffs=stuffs.filter(function(s){return s}),stuffs.length){var error="";throw stuffs.forEach(function(s){var n=s.name;s.artikul&&(n+=" "+s.artikul),s.sortName&&(n+=" "+s.sortName),error+="Указанное в корзине количество "+n+" отсутствует на складе. Уменьшите количество данного товара в корзине."}),{status:"checkWarehouse",message:error}}})},this.makeRn=function(){console.log("makeRn");var o={currency:order.currency,name:"Расходная накладная на заказ "+order.num,materials:[],typeOfZakaz:"order",virtualAccount:global.get("store").val.virtualAccount,store:global.get("store")._id,worker:"any",zakaz:order._id,invoice:order._id,makeReserve:!0,customer:{name:order.profile.fio,email:order.user.email}};order.profile.phone&&(o.customer.phone=order.profile.phone),order.profile.city&&(o.customer.field1=order.profile.city),order.shipCost&&(o.delivery=Math.round(100*Number(order.shipCost))/100);var percent=0,percentCart=0,percentCoupon=0;return order.discount.type&&order.discount.value&&(percent=Number(order.discount.value)),order.sum0!==order.sum&&(percentCart=order.sum/order.sum0),order.sum!==order.couponSum&&(percentCoupon=order.couponSum/order.sum),console.log(order),console.log("percentCart",percentCart),order.cart.stuffs.forEach(function(s){var m={};m.stuff=s._id,m.sort=s.sort,m.qty=s.quantity,m.priceForSale=Math.round(s.sum/s.quantity*100)/100,m.price=Math.round(100*s.priceUchet)/100,m.supplier=s.supplier,m.supplierType=s.supplierType,m.virtualAccount=global.get("store").val.virtualAccount,3==order.discount.type||5==order.discount.type||6==order.discount.type?m.priceForSale=Math.round(m.priceForSale*(100-percent))/100:4!=order.discount.type||s.priceSale?7==order.discount.type&&(m.priceForSale=Math.round(m.priceForSale*percentCart*100)/100):m.priceForSale=Math.round(m.priceForSale*(100-percent))/100,0!=percentCoupon&&(m.priceForSale=Math.round(m.priceForSale*percentCoupon*100)/100),o.materials.push(m)}),o.materials.length?$q.when().then(function(){return $http.post("/api/bookkeep/Rn/createByAPIFromSite",o)}).then(function(res){return exception.showToaster("info","обработка данных в бухгалтерии","накладная в резерве"),res}):exception.catcher("создание накладной","не выбраны товары")},this.cancelRn=function(){console.log("cancelRn",order);var o={store:global.get("store").val._id,rn:order.rn};return order.pn&&(o.pn=order.pn),console.log(o),$q.when().then(function(){return $http.post("/api/bookkeep/Rn/cancelByAPIFromSite",o)}).then(function(res){console.log(res)}).then(function(){exception.showToaster("info","обработка данных в бухгалтерии","накладная отменена")})},this.holdZakaz=function(){console.log("holdZakaz");var o={store:global.get("store").val._id,rn:order.rn};return console.log(o),$q.when().then(function(){return $http.post("/api/bookkeep/Rn/holdByAPIFromSite",o)}).then(function(res){console.log(res)}).then(function(){exception.showToaster("info","обработка данных в бухгалтерии","накладная проведена")})},this.cancelZakaz=function(){console.log("cancelZakaz");var o={store:global.get("store").val._id,rn:order.rn};return order.pn&&(o.pn=order.pn),console.log(o),$q.when().then(function(){return $http.post("/api/bookkeep/Rn/cancelZakazByAPIFromSite",o)}).then(function(res){console.log(res)}).then(function(){exception.showToaster("info","обработка данных в бухгалтерии","накладная отменена")})},this.checkStuff=function(stuff,user){return $http.post("/api/orders/checkStuffInOldOrders",{stuff:stuff,user:user})}}]).factory("localStorage",function(){return{getB:function(item){return JSON.parse(localStorage.getItem(item)||"false")},getN:function(item){var i=localStorage.getItem(item);return"undefined"!=i?JSON.parse(i):""},get:function(item){return JSON.parse(localStorage.getItem(item)||"[]")},set:function(item,value){localStorage.setItem(item,JSON.stringify(value))}}}),function(){function orderService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response&&response.length&&response.forEach(function(o){o.totalPay=o.pay&&o.pay.length?o.pay.reduce(function(s,i){return s+=i.sum},0):0}),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(o){return o}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Order/:_id",{_id:"@_id"});return this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,{getList:getList,getItem:getItem,get:Items.get,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("Orders",orderService),orderService.$inject=["$resource","$uibModal","$q"]}(),function(){function cartInOrderService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/CartInOrder/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,get:Items.get,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("CartInOrder",cartInOrderService),cartInOrderService.$inject=["$resource","$uibModal","$q"]}(),function(){function newsService($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function search(search,setData){function getListComplete(response){return response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}var data={search:search,setData:setData};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(name){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/news/createNews.html",controller:function($uibModalInstance,name){var self=this;self.name=name,self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",resolve:{name:function(){return name}}}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}function viewEmail(item,content){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/news/viewEmail.html",controller:function($q,$uibModalInstance,SubscibtionList,item,content){var self=this;self.item=item,self.except=!1,self.list,self.content=content,self.ok=function(){$uibModalInstance.close({lists:self.lists,except:self.except})},self.cancel=function(){$uibModalInstance.dismiss()},function(){$q.when().then(function(){return SubscibtionList.getList({page:0,rows:1,items:0},{})}).then(function(data){if(data&&data[0]){data[0].list||(data[0].list=[]);for(var key in data[0].list)data[0].list[key]||delete data[0].list[key];self.subscibtionList=data[0]}else self.subscibtionList={list:[]}})}()},size:"lg",controllerAs:"$ctrl",resolve:{item:function(){return item},content:function(){return content}}}).result.then(function(item){resolve(item)},function(err){reject(err)})})}function selectItem(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/news/selectNews.html",controller:function(News,$uibModalInstance,$q){var self=this;self.stuffs=[],self.name="";var query;self.search=function(name){name.length<3||(query={name:name},News.search(name,!0).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg"}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}var Items=$resource("/api/collections/News/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create,viewEmail:viewEmail,select:selectItem,search:search}}angular.module("gmall.services").service("News",newsService),newsService.$inject=["$resource","$uibModal","$q","global"]}(),function(){function newsCartDirective(){return{templateUrl:"/views/template/partials/news/cart/news-cart.html",restrict:"A"}}function newsCartDirective1(){return{templateUrl:"/views/template/partials/news/cart/news-cart1.html",restrict:"A"}}function newsCartDirective2(){return{templateUrl:"/views/template/partials/news/cart/news-cart2.html",restrict:"A"}}function newsCartDirective3(){return{templateUrl:"/views/template/partials/news/cart/news-cart3.html",restrict:"A"}}function newsCartDirective4(){return{templateUrl:"/views/template/partials/news/cart/news-cart4.html",restrict:"A"}}function newsCartDirective5(){return{templateUrl:"/views/template/partials/news/cart/news-cart5.html",restrict:"A"}}function newsListDirective(){return{scope:{},bindToController:!0,controller:newsListCtrl,controllerAs:"$ctrl",templateUrl:"components/news/newsList.html"}}function newsListTemplateDirective($stateParams){return{template:"<div ui-view></div></div><div ng-bind-html='$ctrl.content|unsafe'></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$http","$stateParams","global",function($http,$stateParams,global){var self=this;$http.get("/views/template/partials/news").then(function(response){console.log(response),self.content=response.data.html,console.log(response.data.titles),global.set("titles",response.data.titles)})}]}}function newsListCtrl(News,$state,global,$timeout,$anchorScroll,Photo,Confirm,Label){function getList(){return!Object.keys(self.query).length&&self.actived&&(self.query={actived:!0}),News.getList(self.paginate,self.query).then(function(data){return self.itemsArr2=data.divideArrayWithChunk(2),self.itemsArr3=data.divideArrayWithChunk(3),self.itemsArr4=data.divideArrayWithChunk(4),self.items=data,$timeout(function(){self.data.rows=setRows(),$anchorScroll()}),self.items})}function setRows(){return global.get("functions").val.setRows?global.get("functions").val.setRows():2}function searchNews(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated news list View")})}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createNews(item){var name=item?item.name:"";self.Items.create(name).then(function(res){return name=res,item?self.Items.get({_id:item._id,clone:"clone"}).$promise:{name:res}}).then(function(res){return res._id?(self.newNews=angular.copy(res),self.newNews.send={date:null,quantity:0},self.newNews.name=name,self.newNews.actived=!1,delete self.newNews.date,delete self.newNews._id,delete self.newNews.url,delete self.newNews.__v,self.newNews.nameL={},self.newNews.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id?s._id:s})),block.imgs=[]})):(self.newNews={actived:!1},self.newNews.name=name),self.Items.save(self.newNews).$promise}).then(function(res){self.newNews._id=res.id,self.newNews.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newNews._id;delete self.newNews._id,setTimeout(function(){$state.go("frame.news.item",{id:id})},100)}).catch(function(err){console.log(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/News/"+item.url;Confirm("удалить?").then(function(){return News.delete({_id:item._id}).$promise}).then(function(){return getList()}).then(function(){return Photo.deleteFolder("News",folder)}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление новости")(err)})}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.$state=$state,self.Items=News,self.moment=moment,self.query={},self.paginate={page:0,rows:20,totalItems:0},self.newNews={name:"Новая иноформация",actived:!1},self.data={rows:2},self.itemsArr2=[[],[]],self.itemsArr3=[[],[],[]],self.itemsArr4=[[],[],[],[]],self.getList=getList,self.saveField=saveField,self.searchNews=searchNews,self.createNews=createNews,self.deleteItem=deleteItem,self.setRows=setRows,function(){getList().then(function(){return Label.getList({page:0,rows:100},{list:"news"})}).then(function(data){console.log(data),self.labels=data})}(),$(window).resize(function(){$timeout(function(){self.data.rows=setRows()})})}angular.module("gmall.services").directive("newsList",newsListDirective).directive("newsListTemplate",newsListTemplateDirective).directive("newsCart",newsCartDirective).directive("newsCart1",newsCartDirective1).directive("newsCart2",newsCartDirective2).directive("newsCart3",newsCartDirective3).directive("newsCart4",newsCartDirective4).directive("newsCart5",newsCartDirective5),newsListTemplateDirective.$inject=["global"],newsListCtrl.$inject=["News","$state","global","$timeout","$anchorScroll","Photo","Confirm","Label"]}(),function(){function itemTemplateDirective($stateParams){return{template:"<div ng-bind-html='$ctrl.content|unsafe'></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$http","$stateParams","global",function($http,$stateParams,global){var self=this;$http.get("views/template/partials/News/itemPage/"+$stateParams.id).then(function(response){console.log(response),self.content=response.data.html,console.log(response.data.titles),global.set("titles",response.data.titles)})}]}}function newsItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:newsItemCtrl,controllerAs:"$ctrl",templateUrl:"components/news/newsItem.html"}}function newsItemCtrl(News,$stateParams,$q,$uibModal,global,exception,Stuff,CreateContent,Email,seoContent,Photo,$resource,$anchorScroll,$timeout,FilterTags,BrandTags,Brands,Campaign,Category,$scope,Confirm,SetCSS){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение новости")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){console.log(data),data&&!data.blocks&&(data.blocks=[],saveField("blocks",[])),data.blocks.forEach(function(b,i){b.i=i});for(var key in data)self.item[key]=data[key];return self.objShare=seoContent.setDataItem(data,!0),$anchorScroll(),self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField("blocks."+block.i,block)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,$timeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}function deleteBlock(block,index){var o={_id:self.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("Подтверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.item.blocks.splice(index,1);var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)})}function deleteSlide(block,index){Photo.deleteFiles("Stat",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/staticPage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(){})}function filterBlocks(item){return keyParts.indexOf(item.key)>-1}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){block[block.type]||(block[block.type]=[]);var img,link;switch(block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link})),saveField("blocks."+block.i+".imgs",block.imgs)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs)},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs)}function changeItem(block,$index){addItemInBlock(block,$index)}function sendEmail(){var item=angular.copy(self.item);item.blocks&&item.blocks.length&&item.blocks.forEach(function(b){"stuffs"==b.type&&(b.imgs=b.stuffs)});var ownerDomain,content=CreateContent.emailFromNews(item),d=new Date,n=d.getMonth()+1;global.get("store").val.seller.mailgun&&global.get("store").val.seller.mailgun.domain&&(ownerDomain=global.get("store").val.seller.mailgun.domain),$q.when().then(function(){}).then(function(){return self.Items.viewEmail(self.item,content)}).then(function(data){var lists=data.lists,except=data.except;if(!ownerDomain&&global.get("store").val.mailData&&global.get("store").val.mailData.month&&global.get("store").val.mailData.month==n&&global.get("store").val.mailData.quantity>500)throw"Превышен лимит количества писем в месяц";var o={content:content,lists:lists,except:except,subject:self.item.name.substring(0,50)};return Email.save(o).$promise}).then(function(res){if(exception.showToaster("note","Сообщение","Рассылка отправлена"),self.item.send||(self.item.send={}),self.item.send.date=Date.now(),saveField("send",self.item.send),res.quantity&&!ownerDomain){global.get("store").val.mailData&&global.get("store").val.mailData.month?global.get("store").val.mailData.month!=n?global.get("store").val.mailData={month:n,quantity:res.quantity}:(global.get("store").val.mailData.quantity||(global.get("store").val.mailData.quantity=0),global.get("store").val.mailData.quantity+=res.quantity):global.get("store").val.mailData={month:n,quantity:res.quantity};var o={_id:global.get("store").val._id};o.mailData=global.get("store").val.mailData,Store.save({update:"mailData"},o)}}).catch(function(err){err&&exception.catcher("отправка писем")(err)})}function clearDesc(block){console.log("???????????????"),block.desc="",saveField("blocks."+block.i+".index",block.desc)}var self=this;self.Items=News,self.type="News",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForNewsDetailPage=listOfBlocksForAll,self.listOfBlocks=listOfBlocksForAll,self.animationTypes=animationTypes,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.setStyles=setStyles,self.saveField=saveField,self.sendEmail=sendEmail;var Store=$resource("/api/collections/Store/:_id",{_id:"@_id"});self.newBlock=null,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.filterBlocks=filterBlocks,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,self.clearDesc=clearDesc,activate(),$scope.$on("changeLang",function(){activate()});var keyParts=global.get("store").val.template.news.parts.filter(function(el){return el.is}).map(function(el){return el.name})}angular.module("gmall.directives").directive("newsItem",newsItemDirective).directive("newsDetailTemplate",itemTemplateDirective),newsItemCtrl.$inject=["News","$stateParams","$q","$uibModal","global","exception","Stuff","CreateContent","Email","seoContent","Photo","$resource","$anchorScroll","$timeout","FilterTags","BrandTags","Brands","Campaign","Category","$scope","Confirm","SetCSS"]}(),function(){function itemCtrl($scope,global,$location,$timeout,$state,$element){var self=this;self.global=global,self.$onInit=function(){$timeout(function(){var shareItem=angular.copy(global.get("titles").val);if(shareItem.url&&shareItem.url.indexOf&&shareItem.url.indexOf("http")<0&&(shareItem.url=global.get("store").val.link+shareItem.url),self.item){self.item.url&&("news"==$state.current.name||"master"==$state.current.name||"stat"==$state.current.name||"campaign"==$state.current.name||"additional"==$state.current.name||"workplace"==$state.current.name?shareItem.url+="/"+self.item.url:"home"==$state.current.name&&(shareItem.url+="/"+self.state+"/"+self.item.url));try{self.item.name&&(shareItem.title=self.item.name),self.item.desc&&(shareItem.description=self.item.desc),self.item.img&&(shareItem.image=photoHost+"/"+self.item.img)}catch(err){console.log(err)}}self.shareItem=shareItem},400)}}angular.module("gmall.directives").component("socialHub",{bindings:{objShare:"=",textCenter:"<",item:"<",state:"<"},controller:itemCtrl,templateUrl:"/components/socialHub/socialHub.html"})}(),angular.module("gmall.services").service("HomePage",function($resource,$uibModal){function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/homePage/selectItem.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}var Items=$resource("/api/collections/HomePage/:_id",{_id:"@_id"});this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.selectItemFromList=selectItemFromList}).directive("parallaxBanner",function($timeout){return{scope:{},restrict:"C",link:function(scope,elem,attr){function doIt(){var elementTop=$(elem).offset().top,viewportTop=($(elem).outerHeight(),$(window).scrollTop()),viewportBottom=viewportTop+$(window).height();$(window).height()
;if(elementTop<viewportBottom){var yPos=(parseInt(elem.css("background-position-y")),(elementTop-viewportBottom+$(elem).height())/4),coords="0% "+yPos+"px";elem.css({backgroundPosition:coords})}}var $window=$(window);$timeout(function(){doIt()},100),$(window).scroll(doIt),elem.on("$destroy",function(){angular.element($window).off("scroll",doIt)})}}}).directive("homePage",function(){function homePageCtrl(HomePage,$stateParams,$state,$q,global,$http,$uibModal,Stuff,Filters,FilterTags,Category,exception,BrandTags,Store,Brands,EditModelData,Photo,News,Campaign,Info,$scope,$timeout,Confirm,SetCSS,$rootScope){function getNameBlock(type){return listOfBlocksForAll[type]?listOfBlocksForAll[type]:type}function activate(){$q.when().then(function(){return self.blockForAdd=null,$q(function(resolve,reject){self.Items.get({_id:self.store.subDomain},function(res){resolve(res)},function(err){console.log(err),err&&err.status&&404==err.status?resolve(404):resolve()})})}).then(function(res){if(res&&404!=res)self.item=res,self.item.blocks||(self.item.blocks=[]),self.item.blocks.forEach(function(el,index){el.i=index});else if(404==res)return self.item={url:self.store.subDomain,header:[],left:[],right:[],blocks:[]},self.Items.save(self.item).$promise}).then(function(res){self.item&&!self.item._id&&res&&res.id&&(self.item._id=res.id)}).catch(function(err){exception.catcher("получение home page")(err)})}function addBlock(type){if(type){return console.log("addNewBlock"),$scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}}function cloneBlock(block){if(!delay){delay=!0,$timeout(function(){delay=!1},2e3);var newBlock=angular.copy(block);delete newBlock._id,delete newBlock.__v,newBlock.index?newBlock.index++:newBlock.index=1,newBlock.img=null,newBlock.imgs=[];["stuffs","filterTags","brandTags","categories","brands","news","campaign","info","filters"].forEach(function(field){newBlock[field]&&newBlock[field].length&&(newBlock[field]=newBlock[field].map(function(item){return item._id}))}),self.item.blocks.forEach(function(block){block.index&&block.index>=newBlock.index&&(newBlock.index=block.index+1)}),self.item.blocks.push(newBlock);var o={_id:self.item._id};o[blocks]=self.item.blocks;var update={update:"blocks"};Confirm("потверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){$timeout(function(){global.set("saving",!1)},1500),activate()}).catch(function(err){err&&exception.catcher("добавление блока")(err)})}}function refreshBlocks(){return self.item.blocks=null,self.Items.get({_id:self.store.subDomain}).$promise.then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function deleteBlock(block){var update,o={_id:self.item._id};Confirm("потверждаете?").then(function(){return self.item.blocks.splice(block.i,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Homepage",images)}).then(function(){activate()})}function saveInfo(){saveField("info")}function saveField(field,value){console.log(field,value),field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),field.indexOf(".type")>-1&&activate()})},100)}function movedSlide(block,field,item){return setTimeout(function(){block[field].forEach(function(el,i){el.index=i}),self.saveField(block,null,field)},100),item}function deleteSlide(block,index,$index){Confirm("Удалить?").then(function(){return Photo.deleteFiles("Homepage",[block.imgs[index].img])}).then(function(response){block.imgs.splice(index,1),self.saveField(block,$index,"imgs")},function(err){console.log(err)})}function editSlide(block,index,$index){$uibModal.open({animation:!0,templateUrl:"components/homePage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;slide.button||(slide.button={}),self.item=slide,self.animationTypes=animationTypes,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField(block,$index,"imgs",null,index)},function(){})}function movedStuff(block,item){return setTimeout(function(){saveFieldInSide(block)},100),item}function editModelData(block,i){var model=block.type,items=block[block.type];if(items[i]&&items[i]._id){var field;"brands"==model?field="Brand":"categories"==model?field="Category":"filterTags"==model?field="FilterTags":"filters"==model?field="Filters":"brandTags"==model?field="BrandTags":"stuffs"==model?field="Stuff":"news"==model?field="News":"campaign"==model?field="Campaign":"info"==model&&(field="Info"),$q.when().then(function(){return EditModelData.doIt(field,items[i]._id,items[i])}).then(function(img){console.log(img==items[i].img),img&&img!=items[i].img&&(items[i].img=img,console.log(img))})}else setCollection(items,i)}function addItemInBlock(block){var field=block.type;block[block.type]||(block[block.type]=[]);var Items,collections=block[block.type];"brands"==field?Items=Brands:"categories"==field?Items=Category:"filterTags"==field?Items=FilterTags:"filters"==field?Items=Filters:"brandTags"==field?Items=BrandTags:"stuffs"==field?Items=Stuff:"news"==field?Items=News:"campaign"==field?Items=Campaign:"info"==field&&(Items=Info),$q.when().then(function(){return Items.select({actived:!0})}).then(function(item){collections.push(item),self.saveFieldInSide(block)}).catch(function(){console.log("dismiss")})}function setCollection(block,idx){var Items,field=block.type,collections=block[block.type];"brands"==field?Items=Brands:"categories"==field?Items=Category:"filterTags"==field?Items=FilterTags:"filters"==field?Items=Filters:"brandTags"==field?Items=BrandTags:"stuffs"==field?Items=Stuff:"news"==field?Items=News:"campaign"==field?Items=Campaign:"info"==field&&(Items=Info),$q.when().then(function(){return Items.select()}).then(function(item){collections[idx]=item,self.saveFieldInSide(block)}).catch(function(){console.log("dismiss")})}function saveFieldInSide(item){var field=item.type;console.log(item[item.type]);var o={_id:self.item._id};o[field]=item[field].map(function(e){return e._id});var update={update:field,embeddedName:self.activeSide};return update.embeddedVal=item._id,console.log(update,o),self.Items.save(update,o).$promise}function deleteCollection(block,idx){block[block.type].splice(idx,1),saveFieldInSide(block)}function getNameCollection(type){switch(type){case"categories":return"категории";case"brands":return"бренды";case"brandTags":return"коллекции";case"filterTags":return"признаки";case"filters":return"характеристики";default:return"???????"}}function setColor(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField(block,idx,"blockStyle"),console.log(block.elements),saveField(block,idx,"elements")})}function uploadHP(){Confirm("выгрузить?").then(function(){return $http.post("/api/setTemplateHP",{template:{blocks:self.item.blocks},store:global.get("store").val._id})}).then(function(res){exception.showToaster("success","статус","обновлено")}).catch(function(err){exception.catcher("выгрузка шаблона")(err)})}function downloadHP(){Confirm("загрузить?").then(function(){return $http.get("/views/templatesHP/"+global.get("store").val.subDomain+".json")}).then(function(res){if(console.log(res.data),!res.data||!res.data.blocks)throw"не верный формат данных";var o={_id:self.item._id};o.blocks=res.data.blocks,self.Items.save({update:"blocks"},o,function(){self.item.blocks=res.data.blocks,exception.showToaster("success","статус","обновлено")})}).catch(function(err){exception.catcher("загрузка шаблона")(err)})}function deleteIndexPageHtml(){Confirm("перезаписать страницу?").then(function(){return $http.get("/api/deleteIndexPageHtml")}).then(function(res){exception.showToaster("info","все OK")}).catch(function(err){exception.catcher("сброс страницы")(err)})}function getBlockConfig(block){$q.when().then(function(){return $http.get("/api/getBlocksHP/"+block.type)}).then(function(res){if(res.data)return HomePage.selectItemFromList(res.data)}).then(function(b){if(b){if(block.img);else if(block.video)Photo.deleteFiles("Homepage",[block.video]);else if(block.imgs&&"stuffs"!=block.type){var a=[];block.imgs.forEach(function(i){a.push(i.img)}),a.length&&Photo.deleteFiles("Homepage",a)}for(var key in block)"_id"!=key&&"index"!=key&&delete block[key];var photos=[];for(var key in b)if("_id"!=key&&"template"!=key&&"nameTemplate"!=key&&"index"!=key)if("img"==key&&b[key]){var p=b[key].split("/");p[p.length-2]=self.item.url,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),block[key]=p.join("/"),photos.push([b[key],block[key]])}else if("imgs"==key&&b[key]&&b[key].length)b[key].forEach(function(i){if(i.img){var p=i.img.split("/");p[p.length-2]=self.item.url,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),photos.push([i.img,p.join("/")]),i.img=p.join("/")}}),block[key]=b[key];else if("video"==key&&b[key]){var p=b[key].split("/");p[p.length-2]=self.item.url,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),block[key]=p.join("/"),photos.push([b[key],block[key]])}else block[key]=b[key];var folder="/images/"+global.get("store").val.subDomain+"/HomePage/"+self.item.url,o={folder:folder,photos:photos};return $http.post(photoUpload+"/api/copyPhotosFromBrowser",o)}}).then(function(){return saveField(block,block.i)}).then(function(){activate()})}var self=this;self.Items=HomePage,self.global=global,self.$state=$state,self.activeSide="left",self.store=global.get("store").val,self.listOfBlocks=listOfBlocksForAll,self.blockEditPermission={},self.animationTypes=animationTypes,self.addBlock=addBlock,self.deleteBlock=deleteBlock,self.saveInfo=saveInfo,self.saveField=saveField,self.movedSlide=movedSlide,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.movedStuff=movedStuff,self.editModelData=editModelData,self.setCollection=setCollection,self.deleteCollection=deleteCollection,self.saveFieldInSide=saveFieldInSide,self.addItemInBlock=addItemInBlock,self.getNameCollection=getNameCollection,self.setColor=setColor,self.uploadHP=uploadHP,self.downloadHP=downloadHP,self.deleteIndexPageHtml=deleteIndexPageHtml,self.cloneBlock=cloneBlock,self.getBlockConfig=getBlockConfig,self.getNameBlock=getNameBlock,self.refreshBlocks=refreshBlocks,activate(),$scope.$on("changeLang",function(){activate()});var delay=!1}return{scope:{},restrict:"E",bindToController:!0,controller:homePageCtrl,controllerAs:"$ctrl",templateUrl:"components/homePage/homePage.html"}}),angular.module("gmall.directives").directive("directivehp",function($compile,$interpolate){return{template:"",link:function($scope,element,attributes){element.append($compile("<div "+attributes.directivehp.toLowerCase()+"hp-block></div>")($scope))}}}).directive("styleBlock",styleBlock).directive("bannerhpBlock",bannerHPBlock).directive("banneronehpBlock",banneroneHPBlock).directive("infohpBlock",infohpBlock).directive("sliderhpBlock",sliderhpBlock).directive("texthpBlock",texthpBlock).directive("texttwohpBlock",texttwohpBlock).directive("videohpBlock",videohpBlock).directive("missionhpBlock",missionhpBlock).directive("brandshpBlock",brandshpBlock).directive("stuffshpBlock",stuffshpBlock).directive("newshpBlock",newshpBlock).directive("campaignhpBlock",campaignhpBlock).directive("maphpBlock",maphpBlock).directive("reviewhpBlock",reviewhpBlock).directive("subscriptionhpBlock",subscriptionhpBlock).directive("callhpBlock",callhpBlock).directive("feedbackhpBlock",feedbackhpBlock).directive("brandtagshpBlock",brandTagshpBlock).directive("subscriptionaddhpBlock",subscriptionAddhpBlock).directive("filtertagshpBlock",filterTagshpBlock).directive("filtershpBlock",filtershpBlock).directive("categorieshpBlock",categorieshpBlock).directive("calendarhpBlock",calendarhpBlock).directive("videolinkhpBlock",videolinkhpBlock).directive("pricegoodshpBlock",pricegoodshpBlock).directive("priceserviceshpBlock",priceserviceshpBlock).directive("scheduleplacehpBlock",scheduleplacehpBlock).directive("hpBlock",undefinedhpBlock).directive("googlePlaceReviews",googlePlaceReviews),angular.module("gmall.directives").directive("paginatorMain",function(anchorSmoothScroll,$anchorScroll,global){return{restrict:"E",scope:{paginate:"=",getlist:"&",scroll:"@"},link:function(scope,element,attrs,controller){function getList(){scope.scroll&&anchorSmoothScroll.scrollTo(scope.scroll,200),scope.getlist()}var store=global.get("store").val,stuffListType=global.get("sectionType")&&global.get("sectionType").val?global.get("sectionType").val:"good",rows=store.template.stuffListType[stuffListType]&&store.template.stuffListType[stuffListType].rows||3,filterBlock=store.template.stuffListType[stuffListType].parts.find(function(e){return"filters"==e.name&&e.is&&"false"!=e.is}),filtersInModal=store.template.stuffListType[stuffListType].filtersInModal;if(!filterBlock||global.get("mobile").val||filtersInModal||rows--,scope.paginate&&"object"==typeof scope.paginate){var l;scope.paginator={},scope.$watch("paginate.items",function(n,o){(n||0===n)&&(scope.paginate.items=Number(n),l=scope.paginator.pageCount(),scope.arrayPage=scope.getListPage())}),scope.paginator.setPage=function(page){((page=Number(page))||0===page)&&(page>scope.paginator.pageCount()||page==scope.paginate.page||(scope.paginate.page=page,0==scope.paginate.page&&(scope.arrayPage=scope.getListPage(2)),scope.paginate.page==l-1&&(scope.arrayPage=scope.getListPage(6)),scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList()))},scope.paginator.nextPage=function(){scope.paginator.isLastPage()||(scope.paginate.page++,scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList())},scope.paginator.perviousPage=function(){scope.paginator.isFirstPage()||(scope.paginate.page--,scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList())},scope.paginator.firstPage=function(){scope.paginate.page=0,getList()},scope.paginator.lastPage=function(){scope.paginate.page=scope.paginator.pageCount()-1,getList()},scope.paginator.isFirstPage=function(){return 0==scope.paginate.page},scope.paginator.isLastPage=function(){return scope.paginate.page==scope.paginator.pageCount()-1},scope.paginator.pageCount=function(){var perPage=scope.paginate.rows,delta=perPage%rows;delta>=Math.round(rows/2)?perPage+=rows-delta:perPage-=delta;var count=Math.ceil(parseInt(scope.paginate.items,10)/parseInt(perPage,10));return 1===count&&(scope.paginate.page=0),count},scope.changeRow=function(rows){for(scope.paginate.rows=rows;scope.paginator.pageCount()<scope.paginate.page-1;)scope.paginate.page--;getList()},scope.arrayPage=[],scope.getListPage=function(num){var page=scope.paginate.page,arrayPage=[];if((0===num||num)&&(page=num),l<=6)for(var i=0;i<l;i++)arrayPage.push(i);else{if(page>=3)arrayPage.push(0),arrayPage.push("..."),arrayPage.push(page-1),arrayPage.push(page),arrayPage.push(page+1);else for(var i=0;i<4;i++)arrayPage.push(i);l-1-page>2&&arrayPage.push("..."),arrayPage.push(l-1)}return arrayPage},scope.getPageStr=function(i){return Number(i)||0===i?i+1:i}}},templateUrl:"components/paginator/paginator.html"}}),function(){function itemDirective(){return{scope:{modalClose:"&"},rescrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/subscription/subscription.html"}}function itemCtrl($q,global,$state,$user,exception){function ok(form){form.$valid&&$q.when().then(function(){return $user.newUser(null,self.email)}).then(function(){self.modalClose&&"function"==typeof self.modalClose&&self.modalClose();var pap;global.get("paps")&&global.get("paps").val&&(pap=global.get("paps").val.getOFA("action","subscription"))&&$state.go("thanksPage",{url:pap.url})}).catch(function(err){err=err.data,self.errors={},err&&err.error?(form.email.$setValidity("mongoose",!1),self.errors.email=err.error,exception.catcher("подписка")(err.error)):exception.catcher("подписка")(err)})}var self=this;self.ok=ok,self.email=""}angular.module("gmall.services").directive("iSubscription",itemDirective),itemCtrl.$inject=["$q","global","$state","$user","exception"]}(),function(){function categoriesForListTatiana(global){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",templateUrl:"views/"+global.get("store").val.template.folder+"/partials/category/categoriesForList.html"}}function categoriesForListTemplate(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListTemplate1(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListTemplate2(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListTemplate3(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListDirective(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",templateUrl:"components/categoriesForList/categoriesForList.html"}}function categoriesForListCtrl($stateParams,$state,$q,$location,global){function changeCategory(category,tag){var brand=$stateParams.brand?brand=$stateParams.brand:null,queryTag=null;tag&&("sale"==tag?queryTag=global.get("store").val.saleTag:(tag="new")&&(queryTag=global.get("store").val.newTag));var o={groupUrl:$stateParams.groupUrl,categoryUrl:category,queryTag:queryTag,brand:brand,brandTag:null,searchStr:void 0};$state.go("stuffs",o,{reload:!0,lacation:!0,inherit:!1,notify:!0})}function deleteCrumb(index){!function(type){var query=self.breadcrumbs.reduce(function(q,item){return item.type==type&&(q&&(q+="__"),q+=item.url),q},"");query||(query=null),$location.search(type,query)}(self.breadcrumbs.splice(index,1)[0].type)}function checkInnerData(){return!!$ctrl.parentSection&&($ctrl.parentSection.categories.length&&$ctrl.parentSection.categories.filter(function(c){return!c.notActive}).length>1)}function getFilterTagsPhoto(url){return global.get("filterTags").val.getOFA("url",url)}if(global.get("store").val){var self=this,$ctrl=self;self.getFilterTagsPhoto=getFilterTagsPhoto,self.global=global,self.prop={},self.category=$stateParams.categoryUrl,self.parentSection=global.get("parentSection").val,self.breadcrumbs=global.get("breadcrumbs").val,self.changeCategory=changeCategory,self.deleteCrumb=deleteCrumb,self.checkInnerData=checkInnerData,self.queryTag=null,$stateParams.queryTag&&(global.get("store").val.saleTag&&global.get("store").val.saleTag==$stateParams.queryTag?self.queryTag="sale":global.get("store").val.newTag&&global.get("store").val.newTag==$stateParams.queryTag&&(self.queryTag="new"))}}angular.module("gmall.directives").directive("categoriesForList",categoriesForListDirective).directive("categoriesForListTatiana",categoriesForListTatiana).directive("categoriesForListTemplate",categoriesForListTemplate).directive("categoriesForListTemplate1",categoriesForListTemplate1).directive("categoriesForListTemplate2",categoriesForListTemplate2).directive("categoriesForListTemplate3",categoriesForListTemplate3),categoriesForListCtrl.$inject=["$stateParams","$state","$q","$location","global"]}(),function(){angular.module("gmall.directives").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){element.on("keydown",function(){return ngModel.$setValidity("mongoose",!0)})}}})}(),function(){angular.module("gmall.directives").directive("ngAutocompleteCity",function($parse,$timeout,global){return{scope:{user:"=",change:"&"},link:function(scope,element,attrs,model,contorller){function activate(){scope.user||(scope.user={}),scope.user.profile||(scope.user.profile={}),scope.user.profile.city||(scope.user.profile.city=""),element[0].value=scope.user.profile.city,void 0==scope.gPlace&&(scope.gPlace=new google.maps.places.Autocomplete(element[0],{types:["(cities)"]})),google.maps.event.addListener(scope.gPlace,"place_changed",place_changed),google.maps.event.addDomListener(element[0],"keydown",function(e){13==e.keyCode&&e.preventDefault()})}function place_changed(){placeChosen=!0;var place=scope.gPlace.getPlace();place.place_id?setTimeout(function(){scope.user.profile.city=element.val(),$timeout(function(){scope.user.profile.cityId=place.place_id},200),scope.$apply(),scope.change&&"function"==typeof scope.change&&scope.change()},50):(scope.cityId=null,scope.user.profile.city=element.val(),scope.$apply()),$timeout(function(){placeChosen=!1},1e3)}var placeChosen=!1;setTimeout(function(){activate()},500),scope.$watch(function(){return element.val()},function(o,n){n&&n!=o&&!placeChosen&&(scope.user.profile.cityId=null,scope.user.profile.city=element.val())})}}})}(),function(){function serviceFunction($uibModal,$q,$state,$timeout,$rootScope){function show(item,delay){if(item.showOnes){if(getCookie("witget"+item._id))return;var options={path:"/",expires:3600};setCookie("witget"+item._id,"111",options)}return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/TEMPLATE/witget/index.html",controller:function($scope,$uibModalInstance,item){$scope.flag=!1;var self=this;self.item=item,item.stuff&&item.stuff.name&&(self.stuff=item.stuff.name+(item.stuff.artikul?" "+item.stuff.artikul:"")),self.ok=function(state){$uibModalInstance.close(state)},self.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.$on("closeWitget",function(){$uibModalInstance.close()})},resolve:{item:function(){return item}},controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"};delay=delay&&item.delay?1e3*Number(item.delay):0,$timeout(function(){$rootScope.$emit("modalOpened"),$uibModal.open(options).result.then(function(){$rootScope.$emit("modalClosed"),resolve()},function(err){$rootScope.$emit("modalClosed"),reject(err)})},delay)})}return{show:show}}angular.module("gmall.services").service("Witget",serviceFunction),serviceFunction.$inject=["$uibModal","$q","$state","$timeout","$rootScope"]}(),function(){function statService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/staticPage/createStaticPage.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}function selectItem(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/staticPage/selectItem.html",controller:selectItemCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectItemCtrl(Stat,$uibModalInstance,$q){var self=this;$q.when().then(function(){return Stat.getList({rows:100,page:0})}).then(function(stats){self.stats=stats}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(stat){$uibModalInstance.close(stat)}}var Items=$resource("/api/collections/Stat/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create,selectItem:selectItem}}angular.module("gmall.services").service("Stat",statService),statService.$inject=["$resource","$uibModal","$q"]}(),function(){function gmallSliderDirective(){return{scope:{images:"=",index:"="},restrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",template:['<div  class="slider-fade">','<div class="mytoggle" ng-repeat="slide in $ctrl.images" ng-init="$first && $ctrl.finished()" ng-show="$ctrl.currentIndex==$index">','<a  href="{{slide.link}}">','<img class="img-responsive" ng-src="{{slide.img}}">','<div class="box-overlay"></div>',"<div>",'<h1 ng-bind="slide.name"></h1>','<p ng-bind-html="slide.desc|unsafe"></p>',"</div>","</a>","</div>",'<a ng-click="$ctrl.prev()" class="navleft-carousel">','<img src="img/icon/back.png">',"</a>",'<a ng-click="$ctrl.next()" class="navright-carousel">','<img src="img/icon/next.png">',"</a>",'<ol class="carousel-indicators">','<li ng-repeat="slide in $ctrl.images track by $index" ng-click="$ctrl.setSlide($index)" ng-class="{active:$ctrl.currentIndex==$index}">',"</li>","</ol>","</div>"].join("")}}function gmallSliderPageDirective($timeout,$rootScope,global){return{restrict:"A",replace:!1,link:function(scope,element,attr){function next(){$("#"+imgs[index]).css("opacity",0),index<innerDiv.length-1?index++:index=0,$("#"+imgs[index]).css("opacity",1);try{$(lastLink).attr("href",links[index])}catch(err){console.log(err)}}function setHeight(h){innerDiv.each(function(i,div){$(div).height(h)})}function sliderFunc(){timer=$timeout(function(){$timeout.cancel(timer),next(),sliderFunc()},timeSlide)}var index=0,timeSlide=4e3;global.get("mobile").val&&(timeSlide=3e3);var substrate,lastLink,innerDiv=element.find(".mytoggle-page"),imgs=[],links=[];innerDiv.each(function(i,div){imgs.push($(div).attr("id")),links.push($(div).find("a")),i||$(div).css("opacity",1)});try{lastLink=links[links.length-1],links=links.map(function(l){return l.attr("href")})}catch(err){console.log(err)}element.find(".substrate").each(function(i,div){i||(substrate=$(div),substrate.find("img").each(function(i,img){if(!i){var self=this;if(this.complete){var k=1e3+getRandomInt(100,2e3);$timeout(function(){sliderFunc()},k),setHeight($(self).height()),$timeout(function(){$(div).css("opacity",0)},50)}else $(this).bind("load",function(){var k=1e3+getRandomInt(100,2e3);$timeout(function(){sliderFunc()},k),setHeight($(self).height()),$timeout(function(){$(div).css("opacity",0)},50)})}}))});var timer;$(window).resize(function(){setHeight(element.height())})}}}function gmallSliderPageByHoverDirective($timeout,$rootScope,global){return{restrict:"A",replace:!1,link:function(scope,element,attr){function next(){$("#"+imgs[index]).css("opacity",0),index<innerDiv.length-1?index++:index=0,$("#"+imgs[index]).css("opacity",1);try{$(lastLink).attr("href",links[index])}catch(err){console.log(err)}}function setHeight(h){innerDiv.each(function(i,div){$(div).height(h)})}function sliderFunc(){timer=$timeout(function(){$timeout.cancel(timer),next(),sliderFunc()},1700)}function handlerIn(){next(),sliderFunc()}function handlerOut(){$timeout.cancel(timer)}var index=0;global.get("mobile").val;var substrate,lastLink,innerDiv=element.find(".mytoggle-page"),imgs=[],links=[];innerDiv.each(function(i,div){imgs.push($(div).attr("id")),links.push($(div).find("a")),i||$(div).css("opacity",1)});try{lastLink=links[links.length-1],links=links.map(function(l){return l.attr("href")})}catch(err){console.log(err)}element.find(".substrate").each(function(i,div){i||(substrate=$(div),substrate.find("img").each(function(i,img){if(!i){var self=this;if(this.complete){getRandomInt(100,2e3);setHeight($(self).height()),$timeout(function(){$(div).css("opacity",0)},50)}else $(this).bind("load",function(){getRandomInt(100,2e3);setHeight($(self).height()),$timeout(function(){$(div).css("opacity",0)},50)})}}))});var timer;$(window).resize(function(){setHeight(element.height())}),$(element).mouseenter(handlerIn).mouseleave(handlerOut)}}}function gmallSliderHomeDirective($timeout,$compile,global){return{restrict:"A",scope:!0,link:function(scope,element,attr){function setDivAgainstOverlapping(idx,oldIdx){$timeout(function(){$(innerDiv[idx]).insertAfter(innerDiv[oldIdx])},1600)}function next(){if(!slideDelay){slideDelay=!0,$timeout(function(){slideDelay=!1},700);var oldIdx=index;$("#"+slideMark[index]).removeClass("active"),$("#"+imgs[index]).css("opacity",0);index<innerDiv.length-1?index++:index=0,$("#"+imgs[index]).css("opacity",1),$("#"+slideMark[index]).addClass("active"),setDivAgainstOverlapping(index,oldIdx),$timeout(function(){},2500)}}function prev(){if(!slideDelay){var oldIdx=index;slideDelay=!0,$timeout(function(){slideDelay=!1},700),$("#"+slideMark[index]).removeClass("active"),$("#"+imgs[index]).css("opacity",0),0==index?index=innerDiv.length-1:index--,$("#"+imgs[index]).css("opacity",1),$("#"+slideMark[index]).addClass("active"),setDivAgainstOverlapping(index,oldIdx)}}function setSlide(i){var oldIdx=index;$timeout.cancel(timer),$("#"+slideMark[index]).removeClass("active"),$("#"+imgs[index]).css("opacity",0),index=i,$("#"+imgs[index]).css("opacity",1),$("#"+slideMark[index]).addClass("active"),setDivAgainstOverlapping(index,oldIdx)}function setHeight(h){innerDiv.each(function(){$(this).height(h)})}
function sliderFunc(){timer=$timeout(function(){$timeout.cancel(timer),next(),sliderFunc()},timeSlide)}var timeSlide=4e3;global.get("mobile").val&&(timeSlide=3e3);var duration=attr.duration;if(duration)try{duration=Number(duration),duration>0&&duration<10&&(timeSlide=1e3*duration)}catch(err){console.log(err)}var timer,substrate,index=(iii++,0),innerDiv=element.find(".mytoggle");element.find(".box-overlay");scope.foo={},scope.foo.setSlide=setSlide,scope.slideswipeLeft=function(){$timeout.cancel(timer),next()},scope.slideswipeRight=function(){$timeout.cancel(timer),prev()};var imgs=[],links=[];innerDiv.each(function(i,div){imgs.push($(div).attr("id")),links.push($(div).find("a")),i||$(div).css("opacity",1)});try{links[links.length-1],links.map(function(l){return l.attr("ng-click")}),links=links.map(function(l){return l.attr("href")})}catch(err){console.log(err)}$timeout(function(){element.find(".prev").each(function(i,a){$(a).click(function(e){$timeout.cancel(timer),prev()})}),element.find(".navright-carousel").each(function(i,a){$(a).click(function(e){$timeout.cancel(timer),next()})}),element.find(".carousel-box li").each(function(i,li){$(li).click(function(e){$timeout.cancel(timer),setSlide(i)})})},200);var slideMark=[];element.find(".set-slide").each(function(i,li){slideMark.push($(li).attr("id")),i||$(li).addClass("active")}),element.find(".substrate").each(function(i,div){substrate=$(div),substrate.find("img").each(function(){var self=this;this.complete?($(div).css("opacity",0),$timeout(function(){sliderFunc()},1e3*iii),$timeout(function(){setHeight($(self).height()),setDivAgainstOverlapping(0,imgs.length-1)},50)):$(this).bind("load",function(){$(div).css("opacity",0),$timeout(function(){sliderFunc()},500*iii),$timeout(function(){setHeight($(self).height()),setDivAgainstOverlapping(0,imgs.length-1)},50)})})});var slideDelay;scope.zoomSliderImg=function(i,images){global.get("functions").val.zoomImg(index,images)},$(window).resize(function(){setHeight(element.height())})}}}function gmallSliderHomeNivoDirective($timeout,global){return{restrict:"A",scope:!0,link:function(scope,element,attr){var options={};return attr.effect?options.effect=attr.effect:options.effect="fade",attr.pausetime&&(options.pauseTime=Number(attr.pausetime),!options.pauseTime||options.pauseTime<2||options.pauseTime>20?options.pauseTime=3e3:options.pauseTime=1e3*options.pauseTime),options.controlNavThumbs=!0,void $(window).on("load",function(){$(element).nivoSlider(options);var nextEl=$(element).find(".nivo-nextNav"),prevEl=$(element).find(".nivo-prevNav");$(element).bind("swipeleft",function(e){return console.log("left"),$(nextEl).trigger("click"),e.stopImmediatePropagation(),!1}),$(element).bind("swiperight",function(e){return console.log("swiperight"),$(prevEl).trigger("click"),e.stopImmediatePropagation(),!1})})}}}function itemCtrl($element,$timeout,$scope){function setHeight(){self.height=0,$element.find(".mytoggle img").each(function(){var h=$(this).height();h>self.height&&(self.height=h)}),self.height>h&&self.height>100&&(h=self.height,$($element[0]).find(".slider-fade").height(self.height))}var h=0,self=this;setTimeout(function(){setHeight()}),console.log($scope.images),self.currentIndex=0,self.prev=function(){0==self.currentIndex?self.currentIndex=self.images.length-1:self.currentIndex--,self.index=self.currentIndex},self.next=function(){self.currentIndex<self.images.length-1?self.currentIndex++:self.currentIndex=0,self.index=self.currentIndex},self.setSlide=function(i){self.currentIndex=i,self.index=self.currentIndex};var timer,sliderFunc=function(){timer=$timeout(function(){self.next(),timer=$timeout(sliderFunc,3e3)},3e3)};$timeout(function(){sliderFunc()},1e3),self.finished=function(){self.height=0,$($element.find(".mytoggle img")[0]).bind("load",function(){setHeight()})},$(window).resize(function(){h=0,setHeight()})}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}angular.module("gmall.directives").directive("gmallSlider",gmallSliderDirective).directive("gmallSliderHome",gmallSliderHomeDirective).directive("gmallSliderHomeNivo",gmallSliderHomeNivoDirective).directive("gmallSliderPage",gmallSliderPageDirective).directive("gmallSliderPageByHover",gmallSliderPageByHoverDirective);var iii=0;itemCtrl.$inject=["$element","$timeout","$scope"]}(),$.fn.isOnScreen=function(){var win=$(window),viewport={top:win.scrollTop(),left:win.scrollLeft()};viewport.right=viewport.left+win.width(),viewport.bottom=viewport.top+win.height();var bounds=this.offset();if(bounds)return bounds.right=bounds.left+this.outerWidth(),bounds.bottom=bounds.top+this.outerHeight(),!(viewport.right<bounds.left||viewport.left>bounds.right||viewport.bottom<bounds.top||viewport.top>bounds.bottom)},angular.module("gmall.directives").directive("lastViewed",function($compile,$timeout,localStorage,Stuff,global){return{restrict:"EA",scope:{current:"=",header:"@",mobile:"@",blockElement:"@"},templateUrl:function(element,attrs){return"views/template/partials/stuffDetail/lastViewed/directive/lastViewed"+(attrs&&attrs.templ&&"0"!=attrs.templ?attrs.templ:"")+".html"},link:function(scope,element,attrs){function activate(){scope.position=JSON.parse(scope.blockElement).position,scope.mobile?scope.itemsInList=3:scope.position&&"bottom"==scope.position&&(scope.itemsInList=6),setViewed(angular.copy(scope.current)),viewedStuffs.length>2?(scope.stuffs=viewedStuffs,scope.stuffs.forEach(function(el){el.getUrlParams=Stuff.getUrlParams}),$timeout(function(){$("#lastViewedWrapper").owlCarousel({items:scope.itemsInList,itemsMobile:[479,3],itemsTablet:[768,scope.itemsInList],itemsDesktop:[1199,scope.itemsInList],itemsDesktopSmall:[979,scope.itemsInList]})},150)):scope.stuffs=[],scope.header||(scope.header="Последние просмотренные.")}function setViewed(stuff){for(var posItem=-1,i=0,l=viewedStuffs.length;i<l;i++)if(viewedStuffs[i]._id==stuff._id){posItem=i;break}if(posItem>-1&&viewedStuffs.splice(posItem,1),stuff.gallery[0])var img=stuff.gallery[0].thumbSmall?stuff.gallery[0].thumbSmall:stuff.gallery[0].thumb;else var img=null;var linkData=global.get("categories").val.getOFA("_id",stuff.category).linkData;linkData.stuffUrl=stuff.url;var o={_id:stuff._id,linkData:linkData,url:stuff.url,img:img,name:stuff.name};stuff.artikul&&(o.artikul=stuff.artikul),viewedStuffs.unshift(o),viewedStuffs.length>15&&viewedStuffs.splice(15,1),localStorage.set(subDomain+"-viewed",viewedStuffs)}var subDomain=global.get("store").val.subDomain;scope.localId=Date.now();var viewedStuffs=localStorage.get(subDomain+"-viewed");viewedStuffs||(viewedStuffs=[]),scope.itemsInList=4,scope.$watch("current",function(n){n&&activate()}),scope.$on("$destroy",function(){$("#carouse"+scope.localId).remove()})}}}).directive("fullImg",function($timeout){return{restrict:"A",scope:{index:"=fullImg",gallery:"="},link:function(scope,element,attrs,ngModel){function preventDefault(e){e=e||window.event,e.preventDefault&&e.preventDefault(),e.returnValue=!1}function enableScroll(){window.removeEventListener&&window.removeEventListener("DOMMouseScroll",preventDefault,!1),window.onmousewheel=document.onmousewheel=null,window.onwheel=null,window.ontouchmove=null,document.onkeydown=null}var touchStart;element.bind("click",function(event){function changePhoto(){$imagePan_panningImg.attr("src",scope.gallery[scope.currentPhoto].img),console.log(1),setHeightWigth()}function setHeightWigth(){$timeout(function(){$outer_container=$("#outer_container"),$imagePan_panning=$("#imagePan .panning"),$imagePan=$("#imagePan"),$imagePan.css("overflow","auto"),$imagePan_container=$("#imagePan .containerImg"),$imagePan_panningImg=$("#imagePan img"),$imagePan_panningImg.width()<$imagePan.width()&&($imagePan.css("width",$imagePan_panningImg.width()),$outer_container.css("width",$imagePan_panningImg.width())),$imagePan_panningImg.height()<$imagePan.height()&&($imagePan.css("height",$imagePan_panningImg.height()),$outer_container.css("height",$imagePan_panningImg.height())),containerWidth=$imagePan.width(),containerHeight=$imagePan.height(),totalContentW=$imagePan_panning.width(),totalContentH=$imagePan_panning.height(),$imagePan_container.css("width",totalContentW).css("height",totalContentH),$imagePan.bind("mousemove",function(event){MouseMove(event)}),$imagePan.bind("touchmove",function(event){touchMove(event)}),$imagePan.bind("touchstart",function(event){touchStart=event.originalEvent.touches[0].clientY,console.log("start-",event.originalEvent.touches[0].clientY)}),$imagePan.bind("touchend",function(event){})},400)}function touchMove(e){var moveY,deltaY=touchStart-e.originalEvent.touches[0].clientY;console.log($imagePan_container.offset().top);var top=$imagePan.offset().top;top<0&&deltaY<0&&(moveY=top-deltaY<0?top-deltaY:0),console.log(deltaY,moveY);$imagePan.offset().left,$imagePan.offset().top;$imagePan_container.stop().animate({top:moveY})}function MouseMove(e){if(void 0==e.offsetX){$imagePan.offset().left,$imagePan.offset().top}else{$imagePan.offset().left,$imagePan.offset().top}var mouseCoordsX=e.pageX-$imagePan.offset().left,mouseCoordsY=e.pageY-$imagePan.offset().top,mousePercentX=mouseCoordsX/containerWidth,mousePercentY=mouseCoordsY/containerHeight,destX=-((totalContentW-containerWidth-containerWidth)*mousePercentX),destY=-((totalContentH-containerHeight-containerHeight)*mousePercentY),thePosA=mouseCoordsX-destX,thePosB=destX-mouseCoordsX,thePosC=mouseCoordsY-destY,thePosD=destY-mouseCoordsY,marginL=$imagePan_panning.css("marginLeft").replace("px",""),marginT=$imagePan_panning.css("marginTop").replace("px","");mouseCoordsX>destX||mouseCoordsY>destY?$imagePan_container.css("left",-thePosA-marginL).css("top",-thePosC-marginT):mouseCoordsX<destX||mouseCoordsY<destY?$imagePan_container.stop().animate({left:thePosB-marginL,top:thePosD-marginT},500,"easeOutCirc"):$imagePan_container.stop()}scope.currentPhoto=scope.index;var height=$(window).height(),width=$(window).width(),elem=angular.element('<div id="outer_container" style="max-height:'+height+"px; max-width:"+width+'px;margin:2px auto; padding:0px;"><div id="imagePan" style="max-height:'+height+"px; max-width:"+width+'px;position:relative; overflow:hidden; cursor:crosshair;"><div class="containerImg" style="position:relative; left:0;"><div><img src="'+scope.gallery[scope.currentPhoto].img+'" class="panning"></div></div></div></div>'),mainWrapper=angular.element('<div class="photo-container" style="width:'+width+"px;height:"+height+'px;"></div>');$(window).resize(function(){$imagePan.unbind("mousemove"),height=$(window).height(),width=$(window).width(),mainWrapper.css("width",width).css("height",height),setHeightWigth()}),mainWrapper.prepend(elem),$("body").prepend(mainWrapper);var next=angular.element('<div><img src="img/logo/navright.png" class="navright"></div>');next.bind("click",function(event){return scope.currentPhoto<scope.gallery.length-1?scope.currentPhoto++:scope.currentPhoto=0,changePhoto(),event.preventDefault(),!1});var prev=angular.element('<div><img src="img/logo/navleft.png" class="navleft"></div>');prev.bind("click",function(event){return scope.currentPhoto>0?scope.currentPhoto--:scope.currentPhoto=scope.gallery.length-1,changePhoto(),event.preventDefault(),!1}),mainWrapper.prepend(next),mainWrapper.prepend(prev),mainWrapper.bind("click",function(event){enableScroll(),mainWrapper.remove()});var containerWidth,containerHeight,totalContentW,totalContentH,$outer_container,$imagePan_panning,$imagePan,$imagePan_container,$imagePan_panningImg;setHeightWigth()}),scope.$on("$destroy",function(){})}}}).directive("displayNavbar",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attr){function initFixBanner(){divFFHeight=$(divForFix).outerHeight(),posEl={},posEl.top=$(divForFix)&&$(divForFix).offset()&&$(divForFix).offset().top?$(divForFix).offset().top:0,posEl.left=$(divForFix)&&$(divForFix).offset()&&$(divForFix).offset().left?$(divForFix).offset().left:0,w=$(divForFix).width();var posEl2={};posEl2.top=posEl.top,posEl2.left=$(divForFix2).offset()?$(divForFix2).offset().left:0,w2=$(divForFix2).width();var posEl3={};posEl3.top=posEl.top,posEl3.left=$(divForFix3).offset()?$(divForFix3).offset().left:0,w3=$(divForFix3).width(),$(divForFix).css("position","fixed").width(w).offset(posEl),$(divForFix2).css("position","fixed").width(w2).offset(posEl2),$(divForFix3).css("position","fixed").width(w3).offset(posEl3),block_top=$(block).offset()?$(block).offset().top:0,hh=block_top+$(block).outerHeight(),distance=hh-posEl.top}function fixBanner(cont_top){var delta=(distance-cont_top)/distance,l=Math.round10(delta,-2);l>-.1&&(l<0&&(l=0,OpacityFixBanner=0,$(divForFix).css("display","none"),$(divForFix2).css("display","none"),$(divForFix3).css("display","none")),0!=l&&0===OpacityFixBanner&&(OpacityFixBanner=1,$(divForFix).css("display","block"),$(divForFix2).css("display","block"),$(divForFix3).css("display","block")),$(divForFix).css("opacity",l),$(divForFix2).css("opacity",l),$(divForFix3).css("opacity",l))}$("html, body").animate({scrollTop:0});var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0);if(!(w<1220)){var block,h,divForFix,divForFix2,divForFix3,w,w2,w3,firstnavbar,block_top,hh,cont_top,posEl,divFFHeight,distance,OpacityFixBanner;$timeout(function(){firstnavbar=$("#firstnavbar"),h=firstnavbar.height(),block=$("#photovideoblock"),divForFix=$("#divforfix"),divForFix2=$("#divforfix2"),divForFix3=$("#divforfix3"),$timeout(function(){initFixBanner()},300)},300),OpacityFixBanner=1,$(document).scroll(function(){cont_top=window.pageYOffset?window.pageYOffset:document.body.scrollTop,fixBanner(cont_top)}),$(window).resize(function(){console.log("resize"),h=$("#firstnavbar").height(),$(divForFix).css("position","absolute").css("top","20%"),$(divForFix2).css("position","absolute").css("top","20%").css("left",0),$(divForFix3).css("position","absolute").css("top","20%").css("left",0),$timeout(function(){initFixBanner()},50)})}}}}]).directive("backStretch",["$timeout",function($timeout){return{restrict:"AC",link:function(scope,element,attr){if(attr.backStretch.indexOf("http")<0)var src=photoHost+"/"+attr.backStretch;else var src=attr.backStretch;var w=Math.max(document.documentElement.clientWidth,window.innerWidth||0),val="url("+src+") top right no-repeat fixed";$(element).css("background",val),w<400&&($(element).css("background-position","80% 70%"),$(element).css("background-size","400%"),$(element).css("height","650px"))}}}]).directive("slideMenuTwo",["$timeout",function($timeout){return{restrict:"AC",link:function(scope,element,attr){return}}}]).directive("halfSection",["$timeout",function($timeout){return{restrict:"AC",link:function(scope,element,attr){if(attr.backgroundImage){var src=photoHost+"/"+attr.backgroundImage;console.log(src);var val="url("+src+")";$(element).css("background-image",val)}}}}]).directive("audioMute",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attr){"false"==attr.audioMute&&$(element).prop("muted",!0)}}}]).directive("centerMenu1",["$timeout",function($timeout){return{restrict:"C",link:function(scope,element,attr){$timeout(function(){element.css("margin-left",Math.round(element.parent().width()/2-element.width()/2))},50),$(window).resize(function(){element.css("margin-left",Math.round(element.parent().width()/2-element.width()/2))})}}}]).directive("contentLoaded",["$timeout","$rootScope","anchorSmoothScroll",function($timeout,$rootScope,anchorSmoothScroll){return{restrict:"AC",link:function(scope,element,attr){$rootScope.$on("$stateChangeStartToStuff",function(){$(element).fadeIn()}),$rootScope.$on("$stateChangeEndToStuff",function(){$(element).fadeOut()})}}}]).directive("setAnimate",["$timeout","global",function($timeout,global){return{restrict:"A",link:function(scope,element,attr){function doIt(){$(element).isOnScreen()?isOnScreen||!$animationRepeat&&!firstLook||(firstLook=!1,isOnScreen=!0,$(element).addClass($animationName)):isOnScreen&&$animationRepeat&&(isOnScreen=!1,$(element).removeClass($animationName))}var $animationName=attr.animation,$animationRepeat=attr.animationRepeat,$animationDelay=attr.animationDelay;$animationDelay?$animationName=$animationName+"-"+$animationDelay:$animationDelay=0;var firstLook=!0,isOnScreen=!1;$(element).isOnScreen()&&(isOnScreen=!0,$(element).addClass($animationName),$(element).css("visibility","visible")),$(window).scroll(doIt),scope.$on("openMenu",function(){$(element).hasClass($animationName)||$(element).addClass($animationName)}),scope.$on("closeMenu",function(){$(element).hasClass("pre-animate-opacity")||$(element).removeClass($animationName)}),scope.$on("$allImagesLoadedInHomePage1",function(){$(element).isOnScreen()&&!$(element).hasClass("animated")?($(element).addClass("animated").addClass($animationName),$(element).css("visibility","visible")):($(element).appear(),$(element).on("appear",function(event,$all_appeared_elements){console.log("!!!!!! setAnimate"),$(element).hasClass("animated")||($(element).addClass("animated").addClass($animationName),$(element).css("visibility","visible"))}))}),element.on("$destroy",function(){$(window).off("scroll",doIt)})}}}]).directive("scaleImg",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attr){scope.hover=!1,$timeout(function(){$("#"+attr.divId).hover(function(){scope.onDiv=!0},function(){scope.onDiv=!1}),$(element).wrap('<div style="overflow:hidden"></div>')},10),$(element).hover(function(){console.log(),$(element).addClass("scaleImg")},function(){$timeout(function(){scope.onDiv||$(element).removeClass("scaleImg")})})}}}]).directive("parallaxBox",["$timeout",function($timeout){return{restrict:"AC",link:function(scope,elem,arrts){var win=(Math.max(document.documentElement.clientWidth,window.innerWidth||0),$(window)),el=$(elem);document.addEventListener("scroll",function(event){if(el.offset().top<win.scrollTop()){var difference=win.scrollTop()-el.offset().top,half=.5*difference+"px";el.css("top",half)}else el.css("top","0")}),$timeout(function(){$(elem).wrap('<div style="height:'+($(elem).height()+70)+'px;overflow:hidden"></div>'),$timeout(function(){$(elem).css("position","relative")},200)},500)}}}]).directive("fixAndHideWhenScroll",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attr){return}}}]).directive("backImg",function(){return function(scope,element,attrs){var url=attrs.backImg;element.css({"background-image":"url("+url+")"})}}).directive("angParallax",["$window",function($window){return{restrict:"A",scope:{pCss:"@",pInitVal:"@",pRatio:"@"},link:function(iScope,iElem,iAttr){function _onScroll(){var resultVal,calcVal=$window.pageYOffset*pRatio+pInitVal;resultVal=isSpecialVal?cssValue+"("+calcVal+"px)":calcVal+"px",console.log(cssKey,resultVal),iElem.css(cssKey,resultVal)}console.log(iElem);var cssKey,cssValue,isSpecialVal,pCssVal,pRatio,pInitVal,cssValArray;pCssVal=iScope.pCss?iScope.pCss:"top",cssValArray=pCssVal.split(":"),cssKey=cssValArray[0],cssValue=cssValArray[1],isSpecialVal=!!cssValue,cssValue||(cssValue=cssKey),pRatio=iScope.pRatio?+iScope.pRatio:1.1,pInitVal=iScope.pInitVal?+iScope.pInitVal:0,iElem.css(cssKey,pInitVal+"px"),$window.addEventListener("scroll",_onScroll),angular.element($window).bind("scroll",function(){console.log("scroll")}),$(window).bind("scroll",function(){console.log("scroll")}),$(document).scroll(function(){console.log("scroll")}),document.addEventListener("scroll",function(event){console.log("scroll");var resultVal,calcVal=$window.pageYOffset*pRatio+pInitVal;resultVal=isSpecialVal?cssValue+"("+calcVal+"px)":calcVal+"px",console.log(cssKey,resultVal),iElem.css(cssKey,resultVal)},!0)}}}]),!function(a){function b(a){var b=a.length,d=c.type(a);return"function"!==d&&!c.isWindow(a)&&(!(1!==a.nodeType||!b)||("array"===d||0===b||"number"==typeof b&&b>0&&b-1 in a))}if(!a.jQuery){var c=function(a,b){return new c.fn.init(a,b)};c.isWindow=function(a){return null!=a&&a==a.window},c.type=function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?e[g.call(a)]||"object":typeof a},c.isArray=Array.isArray||function(a){return"array"===c.type(a)},c.isPlainObject=function(a){var b;if(!a||"object"!==c.type(a)||a.nodeType||c.isWindow(a))return!1;try{if(a.constructor&&!f.call(a,"constructor")&&!f.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(d){return!1}for(b in a);return void 0===b||f.call(a,b)},c.each=function(a,c,d){var f=0,g=a.length,h=b(a);if(d){if(h)for(;g>f&&c.apply(a[f],d)!==!1;f++);else for(f in a)if(c.apply(a[f],d)===!1)break}else if(h)for(;g>f&&c.call(a[f],f,a[f])!==!1;f++);else for(f in a)if(c.call(a[f],f,a[f])===!1)break;return a},c.data=function(a,b,e){if(void 0===e){var f=a[c.expando],g=f&&d[f];if(void 0===b)return g;if(g&&b in g)return g[b]}else if(void 0!==b){var f=a[c.expando]||(a[c.expando]=++c.uuid);return d[f]=d[f]||{},d[f][b]=e,e}},c.removeData=function(a,b){var e=a[c.expando],f=e&&d[e];f&&c.each(b,function(a,b){delete f[b]})},c.extend=function(){var a,b,d,e,f,g,h=arguments[0]||{},i=1,j=arguments.length,k=!1;for("boolean"==typeof h&&(k=h,h=arguments[i]||{},i++),"object"!=typeof h&&"function"!==c.type(h)&&(h={}),i===j&&(h=this,i--);j>i;i++)if(null!=(f=arguments[i]))for(e in f)a=h[e],d=f[e],h!==d&&(k&&d&&(c.isPlainObject(d)||(b=c.isArray(d)))?(b?(b=!1,g=a&&c.isArray(a)?a:[]):g=a&&c.isPlainObject(a)?a:{},h[e]=c.extend(k,g,d)):void 0!==d&&(h[e]=d));return h},c.queue=function(a,d,e){if(a){d=(d||"fx")+"queue";var g=c.data(a,d);return e?(!g||c.isArray(e)?g=c.data(a,d,function(a,c){var d=c||[];return null!=a&&(b(Object(a))?function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;)a[e++]=b[d++];if(c!==c)for(;void 0!==b[d];)a[e++]=b[d++];a.length=e,a}(d,"string"==typeof a?[a]:a):[].push.call(d,a)),d}(e)):g.push(e),g):g||[]}},c.dequeue=function(a,b){c.each(a.nodeType?[a]:a,function(a,d){b=b||"fx";var e=c.queue(d,b),f=e.shift();"inprogress"===f&&(f=e.shift()),f&&("fx"===b&&e.unshift("inprogress"),f.call(d,function(){c.dequeue(d,b)}))})},c.fn=c.prototype={init:function(a){if(a.nodeType)return this[0]=a,this;throw new Error("Not a DOM node.")},offset:function(){var b=this[0].getBoundingClientRect?this[0].getBoundingClientRect():{top:0,left:0};return{top:b.top+(a.pageYOffset||document.scrollTop||0)-(document.clientTop||0),left:b.left+(a.pageXOffset||document.scrollLeft||0)-(document.clientLeft||0)}},position:function(){function a(){for(var a=this.offsetParent||document;a&&"html"===!a.nodeType.toLowerCase&&"static"===a.style.position;)a=a.offsetParent;return a||document}var b=this[0],a=a.apply(b),d=this.offset(),e=/^(?:body|html)$/i.test(a.nodeName)?{top:0,left:0}:c(a).offset();return d.top-=parseFloat(b.style.marginTop)||0,d.left-=parseFloat(b.style.marginLeft)||0,a.style&&(e.top+=parseFloat(a.style.borderTopWidth)||0,e.left+=parseFloat(a.style.borderLeftWidth)||0),{top:d.top-e.top,left:d.left-e.left}}};var d={};c.expando="velocity"+(new Date).getTime(),c.uuid=0;for(var e={},f=e.hasOwnProperty,g=e.toString,h="Boolean Number String Function Array Date RegExp Object Error".split(" "),i=0;i<h.length;i++)e["[object "+h[i]+"]"]=h[i].toLowerCase();c.fn.init.prototype=c.fn,a.Velocity={Utilities:c}}}(window),function(a){"object"==typeof module&&"object"==typeof module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):a()}(function(){return function(a,b,c,d){function e(a){for(var b=-1,c=a?a.length:0,d=[];++b<c;){var e=a[b];e&&d.push(e)}return d}function f(a){return p.isWrapped(a)?a=[].slice.call(a):p.isNode(a)&&(a=[a]),a}function g(a){var b=m.data(a,"velocity");return null===b?d:b}function h(a){return function(b){return Math.round(b*a)*(1/a)}}function i(a,c,d,e){function f(a,b){return 1-3*b+3*a}function g(a,b){return 3*b-6*a}function h(a){return 3*a}function i(a,b,c){return((f(b,c)*a+g(b,c))*a+h(b))*a}function j(a,b,c){return 3*f(b,c)*a*a+2*g(b,c)*a+h(b)}function k(b,c){for(var e=0;p>e;++e){var f=j(c,a,d);if(0===f)return c;c-=(i(c,a,d)-b)/f}return c}function l(){for(var b=0;t>b;++b)x[b]=i(b*u,a,d)}function m(b,c,e){var f,g,h=0;do{g=c+(e-c)/2,f=i(g,a,d)-b,f>0?e=g:c=g}while(Math.abs(f)>r&&++h<s);return g}function n(b){for(var c=0,e=1,f=t-1;e!=f&&x[e]<=b;++e)c+=u;--e;var g=(b-x[e])/(x[e+1]-x[e]),h=c+g*u,i=j(h,a,d);return i>=q?k(b,h):0==i?h:m(b,c,c+u)}function o(){y=!0,(a!=c||d!=e)&&l()}var p=4,q=.001,r=1e-7,s=10,t=11,u=1/(t-1),v="Float32Array"in b;if(4!==arguments.length)return!1;for(var w=0;4>w;++w)if("number"!=typeof arguments[w]||isNaN(arguments[w])||!isFinite(arguments[w]))return!1;a=Math.min(a,1),d=Math.min(d,1),a=Math.max(a,0),d=Math.max(d,0);var x=v?new Float32Array(t):new Array(t),y=!1,z=function(b){return y||o(),a===c&&d===e?b:0===b?0:1===b?1:i(n(b),c,e)};z.getControlPoints=function(){return[{x:a,y:c},{x:d,y:e}]};var A="generateBezier("+[a,c,d,e]+")";return z.toString=function(){return A},z}function j(a,b){var c=a;return p.isString(a)?t.Easings[a]||(c=!1):c=p.isArray(a)&&1===a.length?h.apply(null,a):p.isArray(a)&&2===a.length?u.apply(null,a.concat([b])):!(!p.isArray(a)||4!==a.length)&&i.apply(null,a),c===!1&&(c=t.Easings[t.defaults.easing]?t.defaults.easing:s),c}function k(a){if(a){var b=(new Date).getTime(),c=t.State.calls.length;c>1e4&&(t.State.calls=e(t.State.calls));for(var f=0;c>f;f++)if(t.State.calls[f]){var h=t.State.calls[f],i=h[0],j=h[2],n=h[3],o=!!n,q=null;n||(n=t.State.calls[f][3]=b-16);for(var r=Math.min((b-n)/j.duration,1),s=0,u=i.length;u>s;s++){var w=i[s],y=w.element;if(g(y)){var z=!1;if(j.display!==d&&null!==j.display&&"none"!==j.display){if("flex"===j.display){var A=["-webkit-box","-moz-box","-ms-flexbox","-webkit-flex"];m.each(A,function(a,b){v.setPropertyValue(y,"display",b)})}v.setPropertyValue(y,"display",j.display)}j.visibility!==d&&"hidden"!==j.visibility&&v.setPropertyValue(y,"visibility",j.visibility);for(var B in w)if("element"!==B){var C,D=w[B],E=p.isString(D.easing)?t.Easings[D.easing]:D.easing;if(1===r)C=D.endValue;else{var F=D.endValue-D.startValue;if(C=D.startValue+F*E(r,j,F),!o&&C===D.currentValue)continue}if(D.currentValue=C,"tween"===B)q=C;else{if(v.Hooks.registered[B]){var G=v.Hooks.getRoot(B),H=g(y).rootPropertyValueCache[G];H&&(D.rootPropertyValue=H)}var I=v.setPropertyValue(y,B,D.currentValue+(0===parseFloat(C)?"":D.unitType),D.rootPropertyValue,D.scrollData);v.Hooks.registered[B]&&(g(y).rootPropertyValueCache[G]=v.Normalizations.registered[G]?v.Normalizations.registered[G]("extract",null,I[1]):I[1]),"transform"===I[0]&&(z=!0)}}j.mobileHA&&g(y).transformCache.translate3d===d&&(g(y).transformCache.translate3d="(0px, 0px, 0px)",z=!0),z&&v.flushTransformCache(y)}}j.display!==d&&"none"!==j.display&&(t.State.calls[f][2].display=!1),j.visibility!==d&&"hidden"!==j.visibility&&(t.State.calls[f][2].visibility=!1),j.progress&&j.progress.call(h[1],h[1],r,Math.max(0,n+j.duration-b),n,q),1===r&&l(f)}}t.State.isTicking&&x(k)}function l(a,b){if(!t.State.calls[a])return!1;for(var c=t.State.calls[a][0],e=t.State.calls[a][1],f=t.State.calls[a][2],h=t.State.calls[a][4],i=!1,j=0,k=c.length;k>j;j++){var l=c[j].element;if(b||f.loop||("none"===f.display&&v.setPropertyValue(l,"display",f.display),"hidden"===f.visibility&&v.setPropertyValue(l,"visibility",f.visibility)),f.loop!==!0&&(m.queue(l)[1]===d||!/\.velocityQueueEntryFlag/i.test(m.queue(l)[1]))&&g(l)){g(l).isAnimating=!1,g(l).rootPropertyValueCache={};var n=!1;m.each(v.Lists.transforms3D,function(a,b){var c=/^scale/.test(b)?1:0,e=g(l).transformCache[b];g(l).transformCache[b]!==d&&new RegExp("^\\("+c+"[^.]").test(e)&&(n=!0,delete g(l).transformCache[b])}),f.mobileHA&&(n=!0,delete g(l).transformCache.translate3d),n&&v.flushTransformCache(l),v.Values.removeClass(l,"velocity-animating")}if(!b&&f.complete&&!f.loop&&j===k-1)try{f.complete.call(e,e)}catch(o){setTimeout(function(){throw o},1)}h&&f.loop!==!0&&h(e),g(l)&&f.loop===!0&&!b&&(m.each(g(l).tweensContainer,function(a,b){/^rotate/.test(a)&&360===parseFloat(b.endValue)&&(b.endValue=0,b.startValue=360),/^backgroundPosition/.test(a)&&100===parseFloat(b.endValue)&&"%"===b.unitType&&(b.endValue=0,b.startValue=100)}),t(l,"reverse",{loop:!0,delay:f.delay})),f.queue!==!1&&m.dequeue(l,f.queue)}t.State.calls[a]=!1;for(var p=0,q=t.State.calls.length;q>p;p++)if(t.State.calls[p]!==!1){i=!0;break}i===!1&&(t.State.isTicking=!1,delete t.State.calls,t.State.calls=[])}var m,n=function(){if(c.documentMode)return c.documentMode;for(var a=7;a>4;a--){var b=c.createElement("div");if(b.innerHTML="<!--[if IE "+a+"]><span></span><![endif]-->",b.getElementsByTagName("span").length)return b=null,a}return d}(),o=function(){var a=0;return b.webkitRequestAnimationFrame||b.mozRequestAnimationFrame||function(b){var c,d=(new Date).getTime();return c=Math.max(0,16-(d-a)),a=d+c,setTimeout(function(){b(d+c)},c)}}(),p={isString:function(a){return"string"==typeof a},isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isFunction:function(a){return"[object Function]"===Object.prototype.toString.call(a)},isNode:function(a){return a&&a.nodeType},isNodeList:function(a){return"object"==typeof a&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(Object.prototype.toString.call(a))&&a.length!==d&&(0===a.length||"object"==typeof a[0]&&a[0].nodeType>0)},isWrapped:function(a){return a&&(a.jquery||b.Zepto&&b.Zepto.zepto.isZ(a))},isSVG:function(a){return b.SVGElement&&a instanceof b.SVGElement},isEmptyObject:function(a){for(var b in a)return!1;return!0}},q=!1;if(a.fn&&a.fn.jquery?(m=a,q=!0):m=b.Velocity.Utilities,8>=n&&!q)throw new Error("Velocity: IE8 and below require jQuery to be loaded before Velocity.");if(7>=n)return void(jQuery.fn.velocity=jQuery.fn.animate);var r=400,s="swing",t={State:{isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isAndroid:/Android/i.test(navigator.userAgent),isGingerbread:/Android 2\.3\.[3-7]/i.test(navigator.userAgent),isChrome:b.chrome,isFirefox:/Firefox/i.test(navigator.userAgent),prefixElement:c.createElement("div"),prefixMatches:{},scrollAnchor:null,scrollPropertyLeft:null,scrollPropertyTop:null,isTicking:!1,calls:[]},CSS:{},Utilities:m,Redirects:{},Easings:{},Promise:b.Promise,defaults:{queue:"",duration:r,easing:s,begin:d,complete:d,progress:d,display:d,visibility:d,loop:!1,delay:!1,mobileHA:!0,_cacheValues:!0},init:function(a){m.data(a,"velocity",{isSVG:p.isSVG(a),isAnimating:!1,computedStyle:null,tweensContainer:null,rootPropertyValueCache:{},transformCache:{}})},hook:null,mock:!1,version:{major:1,minor:2,patch:2},debug:!1};b.pageYOffset!==d?(t.State.scrollAnchor=b,t.State.scrollPropertyLeft="pageXOffset",t.State.scrollPropertyTop="pageYOffset"):(t.State.scrollAnchor=c.documentElement||c.body.parentNode||c.body,t.State.scrollPropertyLeft="scrollLeft",t.State.scrollPropertyTop="scrollTop");var u=function(){function a(a){return-a.tension*a.x-a.friction*a.v}function b(b,c,d){var e={x:b.x+d.dx*c,v:b.v+d.dv*c,tension:b.tension,friction:b.friction};return{dx:e.v,dv:a(e)}}function c(c,d){var e={dx:c.v,dv:a(c)},f=b(c,.5*d,e),g=b(c,.5*d,f),h=b(c,d,g),i=1/6*(e.dx+2*(f.dx+g.dx)+h.dx),j=1/6*(e.dv+2*(f.dv+g.dv)+h.dv);return c.x=c.x+i*d,c.v=c.v+j*d,c}return function d(a,b,e){var f,g,h,i={x:-1,v:0,tension:null,friction:null},j=[0],k=0;for(a=parseFloat(a)||500,b=parseFloat(b)||20,e=e||null,i.tension=a,i.friction=b,f=null!==e,f?(k=d(a,b),g=k/e*.016):g=.016;h=c(h||i,g),j.push(1+h.x),k+=16,Math.abs(h.x)>1e-4&&Math.abs(h.v)>1e-4;);return f?function(a){return j[a*(j.length-1)|0]}:k}}();t.Easings={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},spring:function(a){return 1-Math.cos(4.5*a*Math.PI)*Math.exp(6*-a)}},
m.each([["ease",[.25,.1,.25,1]],["ease-in",[.42,0,1,1]],["ease-out",[0,0,.58,1]],["ease-in-out",[.42,0,.58,1]],["easeInSine",[.47,0,.745,.715]],["easeOutSine",[.39,.575,.565,1]],["easeInOutSine",[.445,.05,.55,.95]],["easeInQuad",[.55,.085,.68,.53]],["easeOutQuad",[.25,.46,.45,.94]],["easeInOutQuad",[.455,.03,.515,.955]],["easeInCubic",[.55,.055,.675,.19]],["easeOutCubic",[.215,.61,.355,1]],["easeInOutCubic",[.645,.045,.355,1]],["easeInQuart",[.895,.03,.685,.22]],["easeOutQuart",[.165,.84,.44,1]],["easeInOutQuart",[.77,0,.175,1]],["easeInQuint",[.755,.05,.855,.06]],["easeOutQuint",[.23,1,.32,1]],["easeInOutQuint",[.86,0,.07,1]],["easeInExpo",[.95,.05,.795,.035]],["easeOutExpo",[.19,1,.22,1]],["easeInOutExpo",[1,0,0,1]],["easeInCirc",[.6,.04,.98,.335]],["easeOutCirc",[.075,.82,.165,1]],["easeInOutCirc",[.785,.135,.15,.86]]],function(a,b){t.Easings[b[0]]=i.apply(null,b[1])});var v=t.CSS={RegEx:{isHex:/^#([A-f\d]{3}){1,2}$/i,valueUnwrap:/^[A-z]+\((.*)\)$/i,wrappedValueAlreadyExtracted:/[0-9.]+ [0-9.]+ [0-9.]+( [0-9.]+)?/,valueSplit:/([A-z]+\(.+\))|(([A-z0-9#-.]+?)(?=\s|$))/gi},Lists:{colors:["fill","stroke","stopColor","color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","outlineColor"],transformsBase:["translateX","translateY","scale","scaleX","scaleY","skewX","skewY","rotateZ"],transforms3D:["transformPerspective","translateZ","scaleZ","rotateX","rotateY"]},Hooks:{templates:{textShadow:["Color X Y Blur","black 0px 0px 0px"],boxShadow:["Color X Y Blur Spread","black 0px 0px 0px 0px"],clip:["Top Right Bottom Left","0px 0px 0px 0px"],backgroundPosition:["X Y","0% 0%"],transformOrigin:["X Y Z","50% 50% 0px"],perspectiveOrigin:["X Y","50% 50%"]},registered:{},register:function(){for(var a=0;a<v.Lists.colors.length;a++){var b="color"===v.Lists.colors[a]?"0 0 0 1":"255 255 255 1";v.Hooks.templates[v.Lists.colors[a]]=["Red Green Blue Alpha",b]}var c,d,e;if(n)for(c in v.Hooks.templates){d=v.Hooks.templates[c],e=d[0].split(" ");var f=d[1].match(v.RegEx.valueSplit);"Color"===e[0]&&(e.push(e.shift()),f.push(f.shift()),v.Hooks.templates[c]=[e.join(" "),f.join(" ")])}for(c in v.Hooks.templates){d=v.Hooks.templates[c],e=d[0].split(" ");for(var a in e){var g=c+e[a],h=a;v.Hooks.registered[g]=[c,h]}}},getRoot:function(a){var b=v.Hooks.registered[a];return b?b[0]:a},cleanRootPropertyValue:function(a,b){return v.RegEx.valueUnwrap.test(b)&&(b=b.match(v.RegEx.valueUnwrap)[1]),v.Values.isCSSNullValue(b)&&(b=v.Hooks.templates[a][1]),b},extractValue:function(a,b){var c=v.Hooks.registered[a];if(c){var d=c[0],e=c[1];return b=v.Hooks.cleanRootPropertyValue(d,b),b.toString().match(v.RegEx.valueSplit)[e]}return b},injectValue:function(a,b,c){var d=v.Hooks.registered[a];if(d){var e,g=d[0],h=d[1];return c=v.Hooks.cleanRootPropertyValue(g,c),e=c.toString().match(v.RegEx.valueSplit),e[h]=b,e.join(" ")}return c}},Normalizations:{registered:{clip:function(a,b,c){switch(a){case"name":return"clip";case"extract":var d;return v.RegEx.wrappedValueAlreadyExtracted.test(c)?d=c:(d=c.toString().match(v.RegEx.valueUnwrap),d=d?d[1].replace(/,(\s+)?/g," "):c),d;case"inject":return"rect("+c+")"}},blur:function(a,b,c){switch(a){case"name":return t.State.isFirefox?"filter":"-webkit-filter";case"extract":var d=parseFloat(c);if(!d&&0!==d){var e=c.toString().match(/blur\(([0-9]+[A-z]+)\)/i);d=e?e[1]:0}return d;case"inject":return parseFloat(c)?"blur("+c+")":"none"}},opacity:function(a,b,c){if(8>=n)switch(a){case"name":return"filter";case"extract":var d=c.toString().match(/alpha\(opacity=(.*)\)/i);return c=d?d[1]/100:1;case"inject":return b.style.zoom=1,parseFloat(c)>=1?"":"alpha(opacity="+parseInt(100*parseFloat(c),10)+")"}else switch(a){case"name":return"opacity";case"extract":return c;case"inject":return c}}},register:function(){9>=n||t.State.isGingerbread||(v.Lists.transformsBase=v.Lists.transformsBase.concat(v.Lists.transforms3D));for(var a=0;a<v.Lists.transformsBase.length;a++)!function(){var b=v.Lists.transformsBase[a];v.Normalizations.registered[b]=function(a,c,e){switch(a){case"name":return"transform";case"extract":return g(c)===d||g(c).transformCache[b]===d?/^scale/i.test(b)?1:0:g(c).transformCache[b].replace(/[()]/g,"");case"inject":var f=!1;switch(b.substr(0,b.length-1)){case"translate":f=!/(%|px|em|rem|vw|vh|\d)$/i.test(e);break;case"scal":case"scale":t.State.isAndroid&&g(c).transformCache[b]===d&&1>e&&(e=1),f=!/(\d)$/i.test(e);break;case"skew":f=!/(deg|\d)$/i.test(e);break;case"rotate":f=!/(deg|\d)$/i.test(e)}return f||(g(c).transformCache[b]="("+e+")"),g(c).transformCache[b]}}}();for(var a=0;a<v.Lists.colors.length;a++)!function(){var b=v.Lists.colors[a];v.Normalizations.registered[b]=function(a,c,e){switch(a){case"name":return b;case"extract":var f;if(v.RegEx.wrappedValueAlreadyExtracted.test(e))f=e;else{var g,h={black:"rgb(0, 0, 0)",blue:"rgb(0, 0, 255)",gray:"rgb(128, 128, 128)",green:"rgb(0, 128, 0)",red:"rgb(255, 0, 0)",white:"rgb(255, 255, 255)"};/^[A-z]+$/i.test(e)?g=h[e]!==d?h[e]:h.black:v.RegEx.isHex.test(e)?g="rgb("+v.Values.hexToRgb(e).join(" ")+")":/^rgba?\(/i.test(e)||(g=h.black),f=(g||e).toString().match(v.RegEx.valueUnwrap)[1].replace(/,(\s+)?/g," ")}return 8>=n||3!==f.split(" ").length||(f+=" 1"),f;case"inject":return 8>=n?4===e.split(" ").length&&(e=e.split(/\s+/).slice(0,3).join(" ")):3===e.split(" ").length&&(e+=" 1"),(8>=n?"rgb":"rgba")+"("+e.replace(/\s+/g,",").replace(/\.(\d)+(?=,)/g,"")+")"}}}()}},Names:{camelCase:function(a){return a.replace(/-(\w)/g,function(a,b){return b.toUpperCase()})},SVGAttribute:function(a){var b="width|height|x|y|cx|cy|r|rx|ry|x1|x2|y1|y2";return(n||t.State.isAndroid&&!t.State.isChrome)&&(b+="|transform"),new RegExp("^("+b+")$","i").test(a)},prefixCheck:function(a){if(t.State.prefixMatches[a])return[t.State.prefixMatches[a],!0];for(var b=["","Webkit","Moz","ms","O"],c=0,d=b.length;d>c;c++){var e;if(e=0===c?a:b[c]+a.replace(/^\w/,function(a){return a.toUpperCase()}),p.isString(t.State.prefixElement.style[e]))return t.State.prefixMatches[a]=e,[e,!0]}return[a,!1]}},Values:{hexToRgb:function(a){var b,d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i;return a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,d){return b+b+c+c+d+d}),b=d.exec(a),b?[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:[0,0,0]},isCSSNullValue:function(a){return 0==a||/^(none|auto|transparent|(rgba\(0, ?0, ?0, ?0\)))$/i.test(a)},getUnitType:function(a){return/^(rotate|skew)/i.test(a)?"deg":/(^(scale|scaleX|scaleY|scaleZ|alpha|flexGrow|flexHeight|zIndex|fontWeight)$)|((opacity|red|green|blue|alpha)$)/i.test(a)?"":"px"},getDisplayType:function(a){var b=a&&a.tagName.toString().toLowerCase();return/^(b|big|i|small|tt|abbr|acronym|cite|code|dfn|em|kbd|strong|samp|var|a|bdo|br|img|map|object|q|script|span|sub|sup|button|input|label|select|textarea)$/i.test(b)?"inline":/^(li)$/i.test(b)?"list-item":/^(tr)$/i.test(b)?"table-row":/^(table)$/i.test(b)?"table":/^(tbody)$/i.test(b)?"table-row-group":"block"},addClass:function(a,b){a.classList?a.classList.add(b):a.className+=(a.className.length?" ":"")+b},removeClass:function(a,b){a.classList?a.classList.remove(b):a.className=a.className.toString().replace(new RegExp("(^|\\s)"+b.split(" ").join("|")+"(\\s|$)","gi")," ")}},getPropertyValue:function(a,c,e,f){function h(a,c){function e(){j&&v.setPropertyValue(a,"display","none")}var i=0;if(8>=n)i=m.css(a,c);else{var j=!1;if(/^(width|height)$/.test(c)&&0===v.getPropertyValue(a,"display")&&(j=!0,v.setPropertyValue(a,"display",v.Values.getDisplayType(a))),!f){if("height"===c&&"border-box"!==v.getPropertyValue(a,"boxSizing").toString().toLowerCase()){var k=a.offsetHeight-(parseFloat(v.getPropertyValue(a,"borderTopWidth"))||0)-(parseFloat(v.getPropertyValue(a,"borderBottomWidth"))||0)-(parseFloat(v.getPropertyValue(a,"paddingTop"))||0)-(parseFloat(v.getPropertyValue(a,"paddingBottom"))||0);return e(),k}if("width"===c&&"border-box"!==v.getPropertyValue(a,"boxSizing").toString().toLowerCase()){var l=a.offsetWidth-(parseFloat(v.getPropertyValue(a,"borderLeftWidth"))||0)-(parseFloat(v.getPropertyValue(a,"borderRightWidth"))||0)-(parseFloat(v.getPropertyValue(a,"paddingLeft"))||0)-(parseFloat(v.getPropertyValue(a,"paddingRight"))||0);return e(),l}}var o;o=g(a)===d?b.getComputedStyle(a,null):g(a).computedStyle?g(a).computedStyle:g(a).computedStyle=b.getComputedStyle(a,null),"borderColor"===c&&(c="borderTopColor"),i=9===n&&"filter"===c?o.getPropertyValue(c):o[c],(""===i||null===i)&&(i=a.style[c]),e()}if("auto"===i&&/^(top|right|bottom|left)$/i.test(c)){var p=h(a,"position");("fixed"===p||"absolute"===p&&/top|left/i.test(c))&&(i=m(a).position()[c]+"px")}return i}var i;if(v.Hooks.registered[c]){var j=c,k=v.Hooks.getRoot(j);e===d&&(e=v.getPropertyValue(a,v.Names.prefixCheck(k)[0])),v.Normalizations.registered[k]&&(e=v.Normalizations.registered[k]("extract",a,e)),i=v.Hooks.extractValue(j,e)}else if(v.Normalizations.registered[c]){var l,o;l=v.Normalizations.registered[c]("name",a),"transform"!==l&&(o=h(a,v.Names.prefixCheck(l)[0]),v.Values.isCSSNullValue(o)&&v.Hooks.templates[c]&&(o=v.Hooks.templates[c][1])),i=v.Normalizations.registered[c]("extract",a,o)}if(!/^[\d-]/.test(i))if(g(a)&&g(a).isSVG&&v.Names.SVGAttribute(c))if(/^(height|width)$/i.test(c))try{i=a.getBBox()[c]}catch(p){i=0}else i=a.getAttribute(c);else i=h(a,v.Names.prefixCheck(c)[0]);return v.Values.isCSSNullValue(i)&&(i=0),t.debug>=2&&console.log("Get "+c+": "+i),i},setPropertyValue:function(a,c,d,e,f){var h=c;if("scroll"===c)f.container?f.container["scroll"+f.direction]=d:"Left"===f.direction?b.scrollTo(d,f.alternateValue):b.scrollTo(f.alternateValue,d);else if(v.Normalizations.registered[c]&&"transform"===v.Normalizations.registered[c]("name",a))v.Normalizations.registered[c]("inject",a,d),h="transform",d=g(a).transformCache[c];else{if(v.Hooks.registered[c]){var i=c,j=v.Hooks.getRoot(c);e=e||v.getPropertyValue(a,j),d=v.Hooks.injectValue(i,d,e),c=j}if(v.Normalizations.registered[c]&&(d=v.Normalizations.registered[c]("inject",a,d),c=v.Normalizations.registered[c]("name",a)),h=v.Names.prefixCheck(c)[0],8>=n)try{a.style[h]=d}catch(k){t.debug&&console.log("Browser does not support ["+d+"] for ["+h+"]")}else g(a)&&g(a).isSVG&&v.Names.SVGAttribute(c)?a.setAttribute(c,d):a.style[h]=d;t.debug>=2&&console.log("Set "+c+" ("+h+"): "+d)}return[h,d]},flushTransformCache:function(a){function b(b){return parseFloat(v.getPropertyValue(a,b))}var c="";if((n||t.State.isAndroid&&!t.State.isChrome)&&g(a).isSVG){var d={translate:[b("translateX"),b("translateY")],skewX:[b("skewX")],skewY:[b("skewY")],scale:1!==b("scale")?[b("scale"),b("scale")]:[b("scaleX"),b("scaleY")],rotate:[b("rotateZ"),0,0]};m.each(g(a).transformCache,function(a){/^translate/i.test(a)?a="translate":/^scale/i.test(a)?a="scale":/^rotate/i.test(a)&&(a="rotate"),d[a]&&(c+=a+"("+d[a].join(" ")+") ",delete d[a])})}else{var e,f;m.each(g(a).transformCache,function(b){return e=g(a).transformCache[b],"transformPerspective"===b?(f=e,!0):(9===n&&"rotateZ"===b&&(b="rotate"),void(c+=b+e+" "))}),f&&(c="perspective"+f+" "+c)}v.setPropertyValue(a,"transform",c)}};v.Hooks.register(),v.Normalizations.register(),t.hook=function(a,b,c){var e=d;return a=f(a),m.each(a,function(a,f){if(g(f)===d&&t.init(f),c===d)e===d&&(e=t.CSS.getPropertyValue(f,b));else{var h=t.CSS.setPropertyValue(f,b,c);"transform"===h[0]&&t.CSS.flushTransformCache(f),e=h}}),e};var w=function(){function a(){return h?B.promise||null:i}function e(){function a(){function a(a,b){var c=d,e=d,g=d;return p.isArray(a)?(c=a[0],!p.isArray(a[1])&&/^[\d-]/.test(a[1])||p.isFunction(a[1])||v.RegEx.isHex.test(a[1])?g=a[1]:(p.isString(a[1])&&!v.RegEx.isHex.test(a[1])||p.isArray(a[1]))&&(e=b?a[1]:j(a[1],h.duration),a[2]!==d&&(g=a[2]))):c=a,b||(e=e||h.easing),p.isFunction(c)&&(c=c.call(f,y,x)),p.isFunction(g)&&(g=g.call(f,y,x)),[c||0,e,g]}function l(a,b){var c,d;return d=(b||"0").toString().toLowerCase().replace(/[%A-z]+$/,function(a){return c=a,""}),c||(c=v.Values.getUnitType(a)),[d,c]}if(h.begin&&0===y)try{h.begin.call(o,o)}catch(r){setTimeout(function(){throw r},1)}if("scroll"===C){var u,w,z,A=/^x$/i.test(h.axis)?"Left":"Top",D=parseFloat(h.offset)||0;h.container?p.isWrapped(h.container)||p.isNode(h.container)?(h.container=h.container[0]||h.container,u=h.container["scroll"+A],z=u+m(f).position()[A.toLowerCase()]+D):h.container=null:(u=t.State.scrollAnchor[t.State["scrollProperty"+A]],w=t.State.scrollAnchor[t.State["scrollProperty"+("Left"===A?"Top":"Left")]],z=m(f).offset()[A.toLowerCase()]+D),i={scroll:{rootPropertyValue:!1,startValue:u,currentValue:u,endValue:z,unitType:"",easing:h.easing,scrollData:{container:h.container,direction:A,alternateValue:w}},element:f},t.debug&&console.log("tweensContainer (scroll): ",i.scroll,f)}else if("reverse"===C){if(!g(f).tweensContainer)return void m.dequeue(f,h.queue);"none"===g(f).opts.display&&(g(f).opts.display="auto"),"hidden"===g(f).opts.visibility&&(g(f).opts.visibility="visible"),g(f).opts.loop=!1,g(f).opts.begin=null,g(f).opts.complete=null,s.easing||delete h.easing,s.duration||delete h.duration,h=m.extend({},g(f).opts,h);var E=m.extend(!0,{},g(f).tweensContainer);for(var F in E)if("element"!==F){var G=E[F].startValue;E[F].startValue=E[F].currentValue=E[F].endValue,E[F].endValue=G,p.isEmptyObject(s)||(E[F].easing=h.easing),t.debug&&console.log("reverse tweensContainer ("+F+"): "+JSON.stringify(E[F]),f)}i=E}else if("start"===C){var E;g(f).tweensContainer&&g(f).isAnimating===!0&&(E=g(f).tweensContainer),m.each(q,function(b,c){if(RegExp("^"+v.Lists.colors.join("$|^")+"$").test(b)){var e=a(c,!0),f=e[0],g=e[1],h=e[2];if(v.RegEx.isHex.test(f)){for(var i=["Red","Green","Blue"],j=v.Values.hexToRgb(f),k=h?v.Values.hexToRgb(h):d,l=0;l<i.length;l++){var m=[j[l]];g&&m.push(g),k!==d&&m.push(k[l]),q[b+i[l]]=m}delete q[b]}}});for(var H in q){var K=a(q[H]),L=K[0],M=K[1],N=K[2];H=v.Names.camelCase(H);var O=v.Hooks.getRoot(H),P=!1;if(g(f).isSVG||"tween"===O||v.Names.prefixCheck(O)[1]!==!1||v.Normalizations.registered[O]!==d){(h.display!==d&&null!==h.display&&"none"!==h.display||h.visibility!==d&&"hidden"!==h.visibility)&&/opacity|filter/.test(H)&&!N&&0!==L&&(N=0),h._cacheValues&&E&&E[H]?(N===d&&(N=E[H].endValue+E[H].unitType),P=g(f).rootPropertyValueCache[O]):v.Hooks.registered[H]?N===d?(P=v.getPropertyValue(f,O),N=v.getPropertyValue(f,H,P)):P=v.Hooks.templates[O][1]:N===d&&(N=v.getPropertyValue(f,H));var Q,R,S,T=!1;if(Q=l(H,N),N=Q[0],S=Q[1],Q=l(H,L),L=Q[0].replace(/^([+-\/*])=/,function(a,b){return T=b,""}),R=Q[1],N=parseFloat(N)||0,L=parseFloat(L)||0,"%"===R&&(/^(fontSize|lineHeight)$/.test(H)?(L/=100,R="em"):/^scale/.test(H)?(L/=100,R=""):/(Red|Green|Blue)$/i.test(H)&&(L=L/100*255,R="")),/[\/*]/.test(T))R=S;else if(S!==R&&0!==N)if(0===L)R=S;else{e=e||function(){var a={myParent:f.parentNode||c.body,position:v.getPropertyValue(f,"position"),fontSize:v.getPropertyValue(f,"fontSize")},d=a.position===I.lastPosition&&a.myParent===I.lastParent,e=a.fontSize===I.lastFontSize;I.lastParent=a.myParent,I.lastPosition=a.position,I.lastFontSize=a.fontSize;var h=100,i={};if(e&&d)i.emToPx=I.lastEmToPx,i.percentToPxWidth=I.lastPercentToPxWidth,i.percentToPxHeight=I.lastPercentToPxHeight;else{var j=g(f).isSVG?c.createElementNS("http://www.w3.org/2000/svg","rect"):c.createElement("div");t.init(j),a.myParent.appendChild(j),m.each(["overflow","overflowX","overflowY"],function(a,b){t.CSS.setPropertyValue(j,b,"hidden")}),t.CSS.setPropertyValue(j,"position",a.position),t.CSS.setPropertyValue(j,"fontSize",a.fontSize),t.CSS.setPropertyValue(j,"boxSizing","content-box"),m.each(["minWidth","maxWidth","width","minHeight","maxHeight","height"],function(a,b){t.CSS.setPropertyValue(j,b,h+"%")}),t.CSS.setPropertyValue(j,"paddingLeft",h+"em"),i.percentToPxWidth=I.lastPercentToPxWidth=(parseFloat(v.getPropertyValue(j,"width",null,!0))||1)/h,i.percentToPxHeight=I.lastPercentToPxHeight=(parseFloat(v.getPropertyValue(j,"height",null,!0))||1)/h,i.emToPx=I.lastEmToPx=(parseFloat(v.getPropertyValue(j,"paddingLeft"))||1)/h,a.myParent.removeChild(j)}return null===I.remToPx&&(I.remToPx=parseFloat(v.getPropertyValue(c.body,"fontSize"))||16),null===I.vwToPx&&(I.vwToPx=parseFloat(b.innerWidth)/100,I.vhToPx=parseFloat(b.innerHeight)/100),i.remToPx=I.remToPx,i.vwToPx=I.vwToPx,i.vhToPx=I.vhToPx,t.debug>=1&&console.log("Unit ratios: "+JSON.stringify(i),f),i}();var U=/margin|padding|left|right|width|text|word|letter/i.test(H)||/X$/.test(H)||"x"===H?"x":"y";switch(S){case"%":N*="x"===U?e.percentToPxWidth:e.percentToPxHeight;break;case"px":break;default:N*=e[S+"ToPx"]}switch(R){case"%":N*=1/("x"===U?e.percentToPxWidth:e.percentToPxHeight);break;case"px":break;default:N*=1/e[R+"ToPx"]}}switch(T){case"+":L=N+L;break;case"-":L=N-L;break;case"*":L*=N;break;case"/":L=N/L}i[H]={rootPropertyValue:P,startValue:N,currentValue:N,endValue:L,unitType:R,easing:M},t.debug&&console.log("tweensContainer ("+H+"): "+JSON.stringify(i[H]),f)}else t.debug&&console.log("Skipping ["+O+"] due to a lack of browser support.")}i.element=f}i.element&&(v.Values.addClass(f,"velocity-animating"),J.push(i),""===h.queue&&(g(f).tweensContainer=i,g(f).opts=h),g(f).isAnimating=!0,y===x-1?(t.State.calls.push([J,o,h,null,B.resolver]),t.State.isTicking===!1&&(t.State.isTicking=!0,k())):y++)}var e,f=this,h=m.extend({},t.defaults,s),i={};switch(g(f)===d&&t.init(f),parseFloat(h.delay)&&h.queue!==!1&&m.queue(f,h.queue,function(a){t.velocityQueueEntryFlag=!0,g(f).delayTimer={setTimeout:setTimeout(a,parseFloat(h.delay)),next:a}}),h.duration.toString().toLowerCase()){case"fast":h.duration=200;break;case"normal":h.duration=r;break;case"slow":h.duration=600;break;default:h.duration=parseFloat(h.duration)||1}t.mock!==!1&&(t.mock===!0?h.duration=h.delay=1:(h.duration*=parseFloat(t.mock)||1,h.delay*=parseFloat(t.mock)||1)),h.easing=j(h.easing,h.duration),h.begin&&!p.isFunction(h.begin)&&(h.begin=null),h.progress&&!p.isFunction(h.progress)&&(h.progress=null),h.complete&&!p.isFunction(h.complete)&&(h.complete=null),h.display!==d&&null!==h.display&&(h.display=h.display.toString().toLowerCase(),"auto"===h.display&&(h.display=t.CSS.Values.getDisplayType(f))),h.visibility!==d&&null!==h.visibility&&(h.visibility=h.visibility.toString().toLowerCase()),h.mobileHA=h.mobileHA&&t.State.isMobile&&!t.State.isGingerbread,h.queue===!1?h.delay?setTimeout(a,h.delay):a():m.queue(f,h.queue,function(b,c){return c===!0?(B.promise&&B.resolver(o),!0):(t.velocityQueueEntryFlag=!0,void a())}),""!==h.queue&&"fx"!==h.queue||"inprogress"===m.queue(f)[0]||m.dequeue(f)}var h,i,n,o,q,s,u=arguments[0]&&(arguments[0].p||m.isPlainObject(arguments[0].properties)&&!arguments[0].properties.names||p.isString(arguments[0].properties));if(p.isWrapped(this)?(h=!1,n=0,o=this,i=this):(h=!0,n=1,o=u?arguments[0].elements||arguments[0].e:arguments[0]),o=f(o)){u?(q=arguments[0].properties||arguments[0].p,s=arguments[0].options||arguments[0].o):(q=arguments[n],s=arguments[n+1]);var x=o.length,y=0;if(!/^(stop|finish|finishAll)$/i.test(q)&&!m.isPlainObject(s)){var z=n+1;s={};for(var A=z;A<arguments.length;A++)p.isArray(arguments[A])||!/^(fast|normal|slow)$/i.test(arguments[A])&&!/^\d/.test(arguments[A])?p.isString(arguments[A])||p.isArray(arguments[A])?s.easing=arguments[A]:p.isFunction(arguments[A])&&(s.complete=arguments[A]):s.duration=arguments[A]}var B={promise:null,resolver:null,rejecter:null};h&&t.Promise&&(B.promise=new t.Promise(function(a,b){B.resolver=a,B.rejecter=b}));var C;switch(q){case"scroll":C="scroll";break;case"reverse":C="reverse";break;case"finish":case"finishAll":case"stop":m.each(o,function(a,b){g(b)&&g(b).delayTimer&&(clearTimeout(g(b).delayTimer.setTimeout),g(b).delayTimer.next&&g(b).delayTimer.next(),delete g(b).delayTimer),"finishAll"!==q||s!==!0&&!p.isString(s)||(m.each(m.queue(b,p.isString(s)?s:""),function(a,b){p.isFunction(b)&&b()}),m.queue(b,p.isString(s)?s:"",[]))});var D=[];return m.each(t.State.calls,function(a,b){b&&m.each(b[1],function(c,e){var f=s===d?"":s;return f!==!0&&b[2].queue!==f&&(s!==d||b[2].queue!==!1)||void m.each(o,function(c,d){d===e&&((s===!0||p.isString(s))&&(m.each(m.queue(d,p.isString(s)?s:""),function(a,b){p.isFunction(b)&&b(null,!0)}),m.queue(d,p.isString(s)?s:"",[])),"stop"===q?(g(d)&&g(d).tweensContainer&&f!==!1&&m.each(g(d).tweensContainer,function(a,b){b.endValue=b.currentValue}),D.push(a)):("finish"===q||"finishAll"===q)&&(b[2].duration=1))})})}),"stop"===q&&(m.each(D,function(a,b){l(b,!0)}),B.promise&&B.resolver(o)),a();default:if(!m.isPlainObject(q)||p.isEmptyObject(q)){if(p.isString(q)&&t.Redirects[q]){var E=m.extend({},s),F=E.duration,G=E.delay||0;return E.backwards===!0&&(o=m.extend(!0,[],o).reverse()),m.each(o,function(a,b){parseFloat(E.stagger)?E.delay=G+parseFloat(E.stagger)*a:p.isFunction(E.stagger)&&(E.delay=G+E.stagger.call(b,a,x)),E.drag&&(E.duration=parseFloat(F)||(/^(callout|transition)/.test(q)?1e3:r),E.duration=Math.max(E.duration*(E.backwards?1-a/x:(a+1)/x),.75*E.duration,200)),t.Redirects[q].call(b,b,E||{},a,x,o,B.promise?B:d)}),a()}var H="Velocity: First argument ("+q+") was not a property map, a known action, or a registered redirect. Aborting.";return B.promise?B.rejecter(new Error(H)):console.log(H),a()}C="start"}var I={lastParent:null,lastPosition:null,lastFontSize:null,lastPercentToPxWidth:null,lastPercentToPxHeight:null,lastEmToPx:null,remToPx:null,vwToPx:null,vhToPx:null},J=[];m.each(o,function(a,b){p.isNode(b)&&e.call(b)});var K,E=m.extend({},t.defaults,s);if(E.loop=parseInt(E.loop),K=2*E.loop-1,E.loop)for(var L=0;K>L;L++){var M={delay:E.delay,progress:E.progress};L===K-1&&(M.display=E.display,M.visibility=E.visibility,M.complete=E.complete),w(o,"reverse",M)}return a()}};t=m.extend(w,t),t.animate=w;var x=b.requestAnimationFrame||o;return t.State.isMobile||c.hidden===d||c.addEventListener("visibilitychange",function(){c.hidden?(x=function(a){return setTimeout(function(){a(!0)},16)},k()):x=b.requestAnimationFrame||o}),a.Velocity=t,a!==b&&(a.fn.velocity=w,a.fn.velocity.defaults=t.defaults),m.each(["Down","Up"],function(a,b){t.Redirects["slide"+b]=function(a,c,e,f,g,h){var i=m.extend({},c),j=i.begin,k=i.complete,l={height:"",marginTop:"",marginBottom:"",paddingTop:"",paddingBottom:""},n={};i.display===d&&(i.display="Down"===b?"inline"===t.CSS.Values.getDisplayType(a)?"inline-block":"block":"none"),i.begin=function(){j&&j.call(g,g);for(var c in l){n[c]=a.style[c];var d=t.CSS.getPropertyValue(a,c);l[c]="Down"===b?[d,0]:[0,d]}n.overflow=a.style.overflow,a.style.overflow="hidden"},i.complete=function(){for(var b in n)a.style[b]=n[b];k&&k.call(g,g),h&&h.resolver(g)},t(a,l,i)}}),m.each(["In","Out"],function(a,b){t.Redirects["fade"+b]=function(a,c,e,f,g,h){var i=m.extend({},c),j={opacity:"In"===b?1:0},k=i.complete;i.complete=e!==f-1?i.begin=null:function(){k&&k.call(g,g),h&&h.resolver(g)},i.display===d&&(i.display="In"===b?"auto":"none"),t(this,j,i)}}),t}(window.jQuery||window.Zepto||window,window,document)}),angular.module("i-comments",[]).directive("commentsWrap",function(Comments){return{restrict:"E",replace:!0,scope:{parent:"=",what:"@"},controller:function($scope,global,$timeout){$scope.comments=[],Comments.setComments($scope.comments),$scope.comment={},$scope.user=global.get("user"),$scope.addChildComment=Comments.addChildComment,$scope.deleteComment=Comments.deleteComment,$scope.paginate=Comments.getPaginate(),$scope.moreComments=Comments.moreComments},templateUrl:"components/comment/commentsWrap.html",link:function(scope,element,attrs){scope.$watch("parent",function(n,o){n&&Comments.setStuffId(scope.parent,scope.what)}),scope.$on("$destroy",function(){Comments.setEmpty()})}}}).directive("comments",function(){return{restrict:"E",replace:!0,scope:{comments:"=",depth:"="},template:"<ul class='content-comments'><comment ng-repeat='comment in comments' comment ='comment' depth='depth'></comment></ul>",link:function(scope,element,attrs){}}}).directive("comment",function($compile,global,Comments){return{restrict:"E",replace:!0,scope:{comment:"=",depth:"="},transclude:!0,templateUrl:"components/comment/member.html",link:function(scope,element,attrs,controller,$transclude){scope.depth=parseInt(scope.depth)+1,scope.user=global.get("user"),scope.deleteComment=Comments.deleteComment,$transclude(function(clone,$outerScope){scope.comments=$outerScope.comments});angular.isArray(scope.comment.children)&&$compile('<comments comments="comment.children"  depth="depth"></comments>')(scope,function(cloned,scope){$(element[0].children[3]).append(cloned)}),scope.toggled=!0,scope.btnText="ответить",scope.toggle=function(){scope.toggled=!scope.toggled,scope.btnText=scope.toggled?"ответить":"закрыть",scope.child={}},scope.toggleEdit=function(){scope.toggled=!scope.toggled,scope.btnText=scope.toggled?"ответить":"закрыть",scope.child=scope.comment},scope.collapsed=!0,scope.collapse=function(){scope.collapsed=!scope.collapsed},scope.addComment=function(child){scope.toggle(),child.parent||(child.parent=scope.comment._id),scope.comment.children&&scope.comment.children||(scope.comment.children=[]),Comments.addChildComment(child,scope.comment.children)}}}}).factory("Comments",["$resource","global",function($resource,global){function getComment(){Comment.query({query:query,perPage:5,page:paginate.page},function(res){0==paginate.page&&res.length>0&&(paginate.totalItems=res.shift().index);for(var i=0,l=res.length;i<l;i++)comments.push(res[i])})}var query,comments,what,Comment=$resource("/api/collections/Comment/:id",{id:"@_id"}),paginate={page:0,totalItems:0};return{setStuffId:function(id,wh){what=wh;var w={};w[what]=id,query=JSON.stringify(w),getComment()},moreComments:function(){paginate.page++,getComment()},addChildComment:function(comment,parent,what){if(console.log("&&&&"),comment.date||(comment.date=new Date),global.get("user").val&&(comment.name||(comment.name=global.get("user").val.name),!comment.profileUrl&&global.get("user").val.profileUrl&&(comment.profileUrl=global.get("user").val.profileUrl)),!comment.text||!comment.name)return void console.log("не заполнены поля.");comment.text=comment.text.substring(0,500),comment.name=comment.name.substring(0,100),comment.profileUrl&&(comment.profileUrl=comment.profileUrl.substring(0,100));var commentForServer=angular.copy(comment);commentForServer.children?commentForServer.children=commentForServer.children.map(function(el){return el._id}):commentForServer.children=[],Comment.save(commentForServer,function(res){comment._id||(comment._id=res.id,comment.children=[],parent.unshift(angular.copy(comment)))},function(err){return!1})},deleteComment:function(id,comments){var i,l;for(i=0,l=comments.length;i<l&&comments[i]._id!=id;i++);comments.splice(i,1),Comment.delete({id:id},function(res){},function(err){console.log(err)})},setEmpty:function(){comments.length=0,paginate.page=0,paginate.totalItems=0},getComments:function(id,wh){return comments},setComments:function(c){comments=c},getPaginate:function(){return paginate}}}]),angular.module("gmall.directives").directive("focusElement",["$timeout",function($timeout){return{scope:{focusElement:"="},link:function($scope,$element,$attr){$scope.$watch("focusElement",function(value){if(console.log(value),value)return void setTimeout(function(){$element[0].focus(),$scope.focusElemen=!1},200)})}}}]).directive("simpleFocusElement",[function(){return{restrict:"A",link:function(scope,element,attrs){setTimeout(function(){element[0].focus()},300),"false"==attrs.simpleFocusElement&&(console.log("focus",element[0]),setTimeout(function(){element[0].focus()},200))}}}]).directive("focusMe1",function($timeout,$parse){return{link:function(scope,element,attrs){var model=$parse(attrs.focusMe);scope.$watch(model,function(value){console.log("value=",value),value===!0&&$timeout(function(){element[0].focus()},300,!1)}),element.bind("blur",function(){console.log("blur"),scope.$apply(model.assign(scope,!1))})}}}).directive("focusMe",function($timeout){return{link:function(scope,element,attrs){scope.$watch(attrs.focusMe,function(value){value===!0&&$timeout(function(){element[0].focus(),scope[attrs.focusMe]=!1},300,!1)})}}}),function(){function lookbookListDirective(){return{scope:{},bindToController:!0,controller:lookbookListCtrl,controllerAs:"$ctrl",templateUrl:"components/lookbook/lookbookList.html"}}function lookbookListTemplateDirective(global){return{scope:{actived:"@"},rescrict:"E",bindToController:!0,controller:lookbookListCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/lookbook/lookbookList"+(global.get("store").val.template.newsList?global.get("store").val.template.newsList:"")+".html"}}function lookbookListCtrl(Lookbook,$state,global,exception,Confirm,Photo,$timeout){function getList(){return!Object.keys(self.query).length&&self.actived&&(self.query={actived:!0}),self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createItem(){self.Items.create().then(function(res){return self.newItem={actived:!1},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,$state.go("frame.lookbook.item",{id:id})}).catch(function(err){delete self.newItem._id,err=err.data||err,exception.catcher("создание объекта")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Lookbook/"+item.url;console.log(folder),Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Lookbook",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объета")(err)})}var self=this;self.mobile=global.get("mobile").val,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.$state=$state,self.Items=Lookbook,self.moment=moment,self.query={},self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"Новая иноформация",actived:!1},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.createItem=createItem,self.deleteItem=deleteItem,function(){getList().then(function(){})}()}angular.module("gmall.services").directive("lookbookList",lookbookListDirective).directive("lookbookTemplate",lookbookListTemplateDirective),lookbookListTemplateDirective.$inject=["global"],lookbookListCtrl.$inject=["Lookbook","$state","global","exception","Confirm","Photo","$timeout"]}(),function(){function lookbookService($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){
return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/lookbook/createLookbook.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Lookbook/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Lookbook",lookbookService),lookbookService.$inject=["$resource","$uibModal","$q","global"]}(),function(){function infoService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getPaps."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(header,button){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/info/createItem.html",controller:createCtrl,size:"lg",controllerAs:"$ctrl",resolve:{header:function(){return header},button:function(){return button}}};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject()},function(err){reject(err)})})}function createCtrl($uibModalInstance,header,button){var self=this;self.header=header?header:"создание информационной страницы",self.button=button?button:"создать страницу",self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}}function selectInfo(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/info/selectInfo.html",controller:selectInfoCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectInfoCtrl(Info,$uibModalInstance,$q){var self=this;$q.when().then(function(){return Info.getList()}).then(function(items){self.items=items}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(item){$uibModalInstance.close(item)}}var Items=$resource("/api/collections/Info/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create,selectInfo:selectInfo,select:selectInfo}}angular.module("gmall.services").service("Info",infoService),infoService.$inject=["$resource","$uibModal","$q"]}(),function(){function listDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:"components/info/infoList.html"}}function listTemplateDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/info/info.html"}}function listCtrl(Items,$q,$state,$stateParams,global,Confirm,exception,$fileUpload,Photo){function activate(page){return(page||0===page)&&(self.paginate.page=0),getList().then(function(){})}function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){if(self.block=0,$stateParams.block)for(var i=0;i<data.length;i++)if($stateParams.block==data[i]._id){self.block=i;break}return self.items=data,self.items})}function searchItems(searchStr){self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,activate()}function saveField(item,field){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise}function createItem(){self.Items.create().then(function(res){return self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){self.newItem._id;delete self.newItem._id}).catch(function(err){err&&(err=err.datsa||err,exception.catcher("создание объекта")(err))})}function deleteItem(item){Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){activate(0)}).catch(function(err){err&&exception.catcher("удаление страницы")(err)})}function dropCallback(item){var actions=[];return setTimeout(function(){self.items.forEach(function(item,idx){item.index=idx+1,actions.push(saveField(item,"index"))}),$q.all(actions)},100),item}function loadPhoto(item){self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Info",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Info",$q.when().then(function(){return $fileUpload.fileUpload(self.uploadUrl,"img")}).then(function(res){var a=[];res&&res.length&&(item.img&&a.push(item.img),item.img=res[0].data.img,saveField(item,"img"),a.length&&Photo.deleteFiles("Info",a))}).catch(function(err){console.log(err)})}function deletePhoto(item){Confirm("удалить?").then(function(){var a=[];item.img&&a.push(item.img),item.img=null,console.log(item),saveField(item,"img"),a.length&&Photo.deleteFiles("Info",a)})}var self=this;self.mobile=global.get("mobile").val,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"Новый информационный раздел",index:1},self.getList=getList,self.saveField=saveField,self.searchItems=searchItems,self.createItem=createItem,self.deleteItem=deleteItem,self.dropCallback=dropCallback,self.loadPhoto=loadPhoto,self.deletePhoto=deletePhoto,activate()}angular.module("gmall.services").directive("infoList",listDirective).directive("infoListTemplate",listTemplateDirective),listCtrl.$inject=["Info","$q","$state","$stateParams","global","Confirm","exception","$fileUpload","Photo"]}(),function(){function itemInfoLinkDirective(){return{scope:{info:"=",do:"&",title:"@"},rescrict:"E",bindToController:!0,controller:itemInfoLinkCtrl,controllerAs:"$ctrl",templateUrl:"components/info/createLink.html"}}function itemInfoLinkCtrl($q,Info,global){function setInfoLink(){$q.when().then(function(){return Info.selectInfo()}).then(function(tag){self.info.link=tag._id,self.info.name=tag.name,self.do()}).catch(function(){console.log("dismiss")})}function deleteLink(){self.info.link=null,self.info.name="",console.log(self.info),self.do()}var self=this;self.info||(self.info={}),self.setInfoLink=setInfoLink,self.deleteLink=deleteLink}function itemDirective(){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/info/infoItem.html"}}function itemCtrl(Items,$stateParams,$q,$uibModal,exception,global,$scope,$timeout,Confirm){function createNewRazdel(){self.Items.create("создание раздела","создать раздел").then(function(res){res&&saveEmbeddedField({name:res},"name")})}function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){return self.item=data,self.item}).catch(function(err){return $q.reject(err)})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field];var query={update:field};self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function saveEmbeddedField(item,field){var o={_id:self.item._id};field&&(o[field]=item[field]);var update={update:field,embeddedName:"blocks"};item._id?field?update.embeddedVal=item._id:(update.embeddedPull=!0,update.update="name",o.name=item.name):update.embeddedPush=!0,field?$q.when().then(function(){return self.Items.save(update,o).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),(update.embeddedPush||update.embeddedPull)&&activate($stateParams.id)}).catch(function(err){err&&(exception.catcher("saving")(err),console.log(err),err.data&&err.data.message&&err.data.message.indexOf("cannot use the part")>-1&&(console.log(field),update.update=field+"L",delete o[field],o[update.update]={},$q.when().then(function(){return self.Items.save(update,o).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),(update.embeddedPush||update.embeddedPull)&&activate($stateParams.id)}).catch(function(err){err&&exception.catcher("saving")(err)})))}):Confirm("удалить?").then(function(){return self.Items.save(update,o).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),(update.embeddedPush||update.embeddedPull)&&activate($stateParams.id)})}function dropCallback(item){return setTimeout(function(){saveField("blocks")},100),item}var self=this;self.Items=Items,self.global=global,self.mobile=global.get("mobile").val,self.saveField=saveField,self.saveEmbeddedField=saveEmbeddedField,self.dropCallback=dropCallback,self.createNewRazdel=createNewRazdel,activate(),$scope.$on("changeLang",function(){activate()})}function itemTemplateDirective(global){return{scope:{img:"@",info:"@"},bindings:{img:"@",info:"@"},bindToController:!0,controller:itemTemplateCtrl,controllerAs:"$ctrl",templateUrl:function(element,attrs){return attrs&&attrs.templ&&"0"!=attrs.templ&&console.log(attrs.templ),"views/template/partials/home/info/infoItem"+(attrs&&attrs.templ&&"0"!=attrs.templ?attrs.templ:"")+".html"}}}function itemTemplateCtrl($scope,Items,$stateParams,$q,$uibModal,exception,global,$attrs){function activate(id){return getItem(id)}function getItem(id){return self.Items.getItem(id).then(function(data){return data&&data.blocks&&data.blocks.length&&(data.blocks=data.blocks.filter(function(b){return b.actived})),self.item=data,self.item}).catch(function(err){exception.catcher("получение данных")(err)})}var self=this;self.$onInit=function(){self.info&&activate(self.info)},self.info&&activate(self.info),self.Items=Items,self.global=global,self.mobile=global.get("mobile").val}angular.module("gmall.services").directive("infoItem",itemDirective).directive("infoItemTemplate",itemTemplateDirective).directive("createInfoLink",itemInfoLinkDirective),itemInfoLinkCtrl.$inject=["$q","Info","global"],itemCtrl.$inject=["Info","$stateParams","$q","$uibModal","exception","global","$scope","$timeout","Confirm"],itemTemplateCtrl.$inject=["$scope","Info","$stateParams","$q","$uibModal","exception","global","$attrs"]}(),function(){function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(clone){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/createMaster.html",controller:function($uibModalInstance,clone){var self=this;self.header=clone?"Клонирование объекта":"Создание объекта",self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{clone:function(){return clone}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/Master/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Master",serviceFoo),serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function mastersStaticPage(){return{scope:{},bindToController:!0,controllerAs:"$ctrl",templateUrl:"views/template/partials/stat/masters/masters.html",controller:function(global){console.log(global.get("masters").val);var self=this;self.global=global,self.mobile=global.get("mobile").val}}}function masterListDirective(){return{scope:{},bindToController:!0,controller:masterListCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/master/masterList.html"}}function masterListTemplateDirective(global){return{scope:{},rescrict:"E",bindToController:!0,controller:masterListCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/master/masterList"+(global.get("store").val.template.masterList?global.get("store").val.template.masterList:"")+".html"}}function masterListCtrl(Master,$state,global,Confirm,$q,exception,Photo,$timeout,Label){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){self.Items.create().then(function(res){return self.newItem={},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.master.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function cloneItem(item){var name;self.Items.create("clone").then(function(res){return name=res,self.Items.getItem(item._id)}).then(function(master){return self.newItem=angular.copy(master),self.newItem.name=name,self.newItem.nameL={},delete self.newItem._id,delete self.newItem.__v,delete self.newItem.url,console.log(self.newItem),self.newItem.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id})),block.imgs=[]}),self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.master.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Master/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Master",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объекта")(err)})}function dropCallback(item){var i=0;return setTimeout(function(){self.items.reduce(function(p,item){return p.then(function(){return i++,item.index=i,saveField(item,"index")})},$q.when(!0)).then(function(){console.log(self.items.map(function(el){return el.index}))})},50),item}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Master,self.query={},self.labels=[],self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"имя мастера"},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.deleteItem=deleteItem,self.createItem=createItem,self.dropCallback=dropCallback,self.cloneItem=cloneItem,function(){getList().then(function(){return Label.getList({page:0,rows:100},{list:"master"})}).then(function(data){self.labels=data})}()}angular.module("gmall.services").directive("masterList",masterListDirective).directive("masterListTemplate",masterListTemplateDirective).directive("mastersStaticPage",mastersStaticPage),masterListCtrl.$inject=["Master","$state","global","Confirm","$q","exception","Photo","$timeout","Label"]}(),function(){function masterItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:masterItemCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/master/masterItem.html"}}function masterItemCtrl(Master,$stateParams,$q,$uibModal,global,exception,Stuff,Photo,$scope,$timeout,Confirm,SetCSS,$user,Workplace,$rootScope){function activate(){return getItem($stateParams.id).then(function(){if(self.item.user)return $user.getItem(self.item.user)}).then(function(user){if(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,self.item.user=user}}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){data&&!data.blocks&&(data.blocks=[],saveField("blocks",[]));var bl=data.blocks.filter(function(b){return b});return bl.length!=data.blocks.length&&(saveField("blocks",bl),data.blocks=bl),data.blocks.forEach(function(b,i){"stuffs"==b.type&&b.stuffs.length&&(b.stuffs=b.stuffs.map(function(s){return s._is||s})),b.i=i}),data.blocks.sort(function(a,b){return a.index-b.index}),void 0==data.notification&&(data.notification=0),self.item=data,self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){block.elements&&saveField("blocks."+block.i+".elements",block.elements),block.blockStyle&&saveField("blocks."+block.i+".blockStyle",block.blockStyle)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function addBlock(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}function deleteBlock(block,index){var o={_id:self.item._id},update={update:"_id_id",embeddedName:"blocks"};o.id=block.id,update.embeddedPull=!0,Confirm("потверждаете?").then(function(){return self.item.blocks.splice(index,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Master",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function savePhone(phone){saveField("phone",phone)}function clearUser(){console.log(self.user),changeUser(self.user)}function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{"profile.phone":phone},{name:phone},{email:phone}]};$user.getList({page:0,rows:20},q).then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user})})}function changeUser(user){if(self.item.user&&self.item.user._id&&(!user||user._id!=self.item.user._id)){var o={_id:self.item.user._id,master:null};$user.save({update:"master"},o,function(){})}var u=null;if(user?(u=user._id,self.item.user=user):self.item.user=null,saveField("user",u),self.user=null,self.item.user&&self.item.user._id){var o={_id:self.item.user._id,master:self.item._id};$user.save({update:"master"},o,function(){})}}function getWorkplaces(){Workplace.getList({page:0,rows:50}).then(function(res){console.log(res,res&&res.length),res&&res.length&&(self.workplaces=res,console.log(self.workplaces))})}function addWorkplace(wp){console.log(wp),self.item.workplaces||(self.item.workplaces=[]),self.item.workplaces=self.item.workplaces.filter(function(wp){return wp});var value=self.item.workplaces.map(function(wp){return wp._id});value.indexOf(wp._id)>-1||(value.push(wp._id),self.item.workplaces.push(wp),console.log(value),saveField("workplaces",value),$timeout(function(){},1e3))}function deleteWorkplace(idx){self.item.workplaces||(self.item.workplaces=[]),self.item.workplaces.splice(idx,1),saveField("workplaces",self.item.workplaces.map(function(wp){return wp._id}))}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){if("stuffs"==block.type&&block.stuffs&&block.stuffs.length&&block.stuffs.some(function(s){return s&&s._id?s._id==item._id:s==item._id}))throw"такой объект уже есть";block[block.type]||(block[block.type]=[]);var img,link;switch(name=item.name,block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,_id:item._id}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,_id:item._id})),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}).catch(function(err){err&&exception.catcher("добавление")(err)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}function changeItem(block,$index){addItemInBlock(block,$index)}function toggleEdit(item){item.editMode=!item.editMode}function toggleAdd(){self.addMode=!self.addMode}function saveReview(item){item.name=item.name.substring(0,20),item.desc=item.desc.substring(0,200),delete item.editMode,saveField("reviews",item.reviews)}function deleteReview(i){self.item.reviews.splice(i,1),saveField("reviews",item.reviews)}function addReview(admin){if(admin)var o=self.newReview;else var o={name:global.get("user").val.profile.fio||global.get("user").val.name,date:Date.now(),desc:self.newReviewText.substring(0,200)};self.newReviewText="",self.unableAddReview=!1,self.item.reviews||(self.item.reviews=[]),self.item.reviews.unshift(o),saveField("reviews",self.item.reviews),admin&&toggleAdd()}var self=this;self.Items=Master,self.type="Master",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForMasterPage=listOfBlocksForAll,self.listOfBlocks=listOfBlocksForAll,self.moment=moment,self.saveField=saveField,self.setStyles=setStyles,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,self.deleteReview=deleteReview,self.toggleEdit=toggleEdit,self.addReview=addReview,self.toggleAdd=toggleAdd,self.saveReview=saveReview,self.newReview={name:"",desc:"",date:Date.now()},self.savePhone=savePhone,self.refreshUsers=refreshUsers,self.changeUser=changeUser,self.clearUser=clearUser,self.workplaces=[],self.deleteWorkplace=deleteWorkplace,self.addWorkplace=addWorkplace,self.getWorkplaces=getWorkplaces,activate(),$scope.$on("changeLang",function(){activate()}),global.get("store").val.template.master||(global.get("store").val.template.master={parts:[]});global.get("store").val.template.master.parts.filter(function(el){return el.is}).map(function(el){return el.name})}function masterTemplateDirective($stateParams){return{template:"<div ng-bind-html='$ctrl.content|unsafe'></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$http","$stateParams","global",function($http,$stateParams,global){var self=this;$http.get("views/template/partials/Master/itemPage/"+$stateParams.id).then(function(response){console.log(response),self.content=response.data.html,console.log(response.data.titles),global.set("titles",response.data.titles)})}]}}function masterScheduleDirective($stateParams){return{bindToController:!0,scope:{master:"@"},controllerAs:"$ctrl",controller:masterScheduleCtrl,templateUrl:"components/CONTENT/master/masterSchedule.html"}}function masterScheduleCtrl($http,$stateParams,global){var self=this;console.log("init",self.master)}angular.module("gmall.directives").directive("masterItem",masterItemDirective).directive("masterDetailTemplate",masterTemplateDirective).directive("masterSchedule",masterScheduleDirective),masterItemCtrl.$inject=["Master","$stateParams","$q","$uibModal","global","exception","Stuff","Photo","$scope","$timeout","Confirm","SetCSS","$user","Workplace","$rootScope"],masterScheduleCtrl.$inject=["$http","$stateParams","global"]}(),function(){function catalogMainPageDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:catalogMainPageCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/catalog/catalog.html"}}function catalogMainPageCtrl(global,Stuff){function forwardToSubsections(s){self.breadcrumbs.push(s),self.sectionsClass="animated slideOutLeft",s.class="animated slideInRight"}function forwardToCategories(sec,sub){self.breadcrumbs.push(sub),sec.class="animated slideOutLeft",sub.class="animated slideInRight"}function backInSection(s){s.class="animated slideOutRight",self.sectionsClass="animated slideInLeft"}function backInSubSection(sub,sec){sec.class="animated slideInLeft",sub.class="animated slideOutRight"}function backToCatalog(){self.breadcrumbs.length&&(self.breadcrumbs[self.breadcrumbs.length-1].class="animated slideOutRight",self.sectionsClass="animated slideInLeft",self.breadcrumbs.length=0)}function backToBC(i){i||(self.breadcrumbs[self.breadcrumbs.length-1].class="animated slideOutRight",self.breadcrumbs[self.breadcrumbs.length-2].class="animated slideInLeft",self.breadcrumbs.splice(self.breadcrumbs.length-1,1))}function getStuffs(category){self.category=category,Stuff.getList(null,{category:category._id}).then(function(res){self.items=res})}function getStuff(item,i){item.isOpen=!item.isOpen,item.isOpen&&(item.getData||(item.getData=!0,Stuff.getItem(item._id).then(function(res){console.log(res),self.items[i].desc=res.desc,self.items[i].desc1=res.desc1,self.items[i].desc2=res.desc2,self.items[i].gallery=res.gallery})))}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.stuffs=[],self.currentState="section",self.sectionsClass,self.breadcrumbs=[],self.forwardToSubsections=forwardToSubsections,self.forwardToCategories=forwardToCategories,self.backInSection=backInSection,self.backInSubSection=backInSubSection,self.getStuffs=getStuffs,self.backToCatalog=backToCatalog,self.backToBC=backToBC,self.getStuff=getStuff,function(){self.sections=global.get("sections").val.filter(function(el){return el._id}),console.log(self.sections)}()}angular.module("gmall.directives").directive("catalogMainPage",catalogMainPageDirective),catalogMainPageCtrl.$inject=["global","Stuff"]}(),function(){function itemsList(){return{template:"<div ui-view></div><div></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:listCtrl}}function itemsDetail(){return{template:"<div></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:detailCtrl}}function listCtrl($scope,$http,$element,global,$state,$q,$anchorScroll,$timeout,$window,$compile,$rootScope,seoContent,$sce,$location){function setLabel(label){if(labelsFromQuery&&labelsFromQuery.length){var i=labelsFromQuery.indexOf(label);if(labelsFromQuery=[],i==-1&&labelsFromQuery.push(label),labelsFromQuery.length){var str=labelsFromQuery.reduce(function(s,el){return s&&(s+="__"),s+=el},"");$location.search("labels",str)}else $location.search("labels",null)}else $location.search("labels",label)}var self=this;self.global=global,self.$state=$state,self.$stateParams=$rootScope.$stateParams,self.setLabel=setLabel;var labelsFromQuery,query,labels="";self.$stateParams&&self.$stateParams.labels&&global.get("labels").val&&(labelsFromQuery=self.$stateParams.labels.split("__"),global.get("labels").val&&global.get("labels").val.length&&labelsFromQuery&&labelsFromQuery.length&&labelsFromQuery.forEach(function(name){
var ll=global.get("labels").val.getOFA("name",name);ll&&(labels&&(labels+="__"),labels+=ll.name)}),labels&&labels.length&&(query="labels="+labels),console.log(query));var waiting,lastElement,waitingDiv,td1,td2,td3,page=0,model=getModel($state),url="views/template/partials/"+model+".html",color=global.get("store").val.template.dimScreenColor?global.get("store").val.template.dimScreenColor:"#000000",BGcolor=global.get("store").val.template.dimScreenBGColor?global.get("store").val.template.dimScreenBGColor:"#F5F5F5",innerWaitingDiv=['<div style="width:100%;height:200px;background-color:'+BGcolor+";color:"+color+'" class="clearfix text-center">','<img src="/img/spinner.gif" style="margin-top: 70px">',"</div>"].join("");self.hideList=global.get("store").val.template[model+"List"].hideList,self.hideCart=!!global.get("store").val.template[model+"List"].hideCart&&global.get("store").val.template[model+"List"].hideCart,$q.when().then(function(){if(global.get("tempContent").val){if($state.current.name.indexOf(".item")<0&&$state.current.name.indexOf(".detail")<0){var html=global.get("tempContent").val;$("#tempContent").empty(),global.set("tempContent",null);var o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}return null}return $http.get(url.trim()+(query?"?"+query:""))}).then(function(response){if(response){var linkFn=$compile(response.data.html),content=linkFn($scope);if($element.append(content),response.data.titles&&response.data.titles.title){for(var k in response.data.titles)if(response.data.titles[k])if("title"==k)global.get("titles").val[k]=response.data.titles[k];else if("canonical"==k)try{global.get("titles").val[k]=$sce.trustAsResourceUrl(response.data.titles[k])}catch(err){console.log(err)}else global.get("titles").val[k]=response.data.titles[k]}else{var key=model+"List",name=global.get("store").val.nameLists&&global.get("store").val.nameLists[key]?global.get("store").val.nameLists[key]:"list";seoContent.setDataList(model,name)}waitingDiv=$("#paginateData"+page),self.totalQty=waitingDiv.data("total"),self.currentQty=waitingDiv.data("qty"),self.page=waitingDiv.data("page"),self.lastItemId=waitingDiv.data("lastItemId"),td1=$("#td-list-1-items"),td2=$("#td-list-2-items"),td3=$("#td-list-3-items"),$timeout(function(){$anchorScroll(),lastElement=null!=self.lastItemId?$("#item-"+self.lastItemId):null});var addBlockAfterScroll=function(){!waiting&&lastElement&&$(lastElement).isOnScreen()&&self.currentQty<self.totalQty&&(waiting=!0,page++,$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url.trim()+"?page="+page+(query?"&"+query:""))}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var addHtml=angular.element(response.data.html),atd1=addHtml.find("#td-list-1-items").html(),atd2=addHtml.find("#td-list-2-items").html(),atd3=addHtml.find("#td-list-3-items").html();self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),td1.append(atd1),td2.append(atd2),td3.append(atd3),$timeout(function(){$compile(atd1)($scope),$compile(atd2)($scope),$compile(atd3)($scope),lastElement=null!=self.lastItemId?$("#item-"+self.lastItemId):null,waiting=!1},200)}}))};angular.element($window).on("scroll",addBlockAfterScroll),$scope.$on("$destroy",function(){angular.element($window).off("scroll",addBlockAfterScroll)}),$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")},100)}})}function detailCtrl($scope,$element,$compile,$http,$stateParams,$state,$anchorScroll,global,$q,$rootScope,$location,$timeout,$sce,localStorage){function openBlock(url){$timeout(function(){self.isOpen[url]?$location.search("block",url):$location.search("block",null)},200)}var self=this;self.global=global,$scope.global=global;var model=getModel($state);model=model[0].toUpperCase()+model.substr(1),$q.when().then(function(){if(global.get("tempContent").val){var html=global.get("tempContent").val;$("#tempContent").empty(),global.set("tempContent",null);var o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}if($stateParams.id)var id=$stateParams.id;else{var likes=localStorage.get(global.get("store").val.subDomain+"-likes");if(likes&&likes.length)var id=likes.join("_");else var id="_"}return $http.get("views/template/partials/"+model+"/itemPage/"+id+".html")}).then(function(response){var appendContent=$compile(response.data.html)($scope);if($element.append(appendContent),$anchorScroll(),response.data.titles&&response.data.titles.title)for(var k in response.data.titles)if(response.data.titles[k])if("title"==k)response.data.titles[k].indexOf(global.get("titles").val[k])<0?global.get("titles").val[k]=response.data.titles[k]+". "+global.get("titles").val[k]:global.get("titles").val[k]=response.data.titles[k];else if("canonical"==k)try{global.get("titles").val[k]=$sce.trustAsResourceUrl(response.data.titles[k])}catch(err){console.log(err)}else global.get("titles").val[k]=response.data.titles[k];"Campaign"!=model||"Likes"!=model?$rootScope.$emit("$stateChangeEndToStuff"):$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")},600)}),$timeout(function(){self.$stateParams=$stateParams,$stateParams.block&&self.isOpen&&(self.isOpen[$stateParams.block]=!0)},500),self.openBlock=openBlock}function getModel($state){var model="news";return"lookbook"==$state.current.name||"lookbook.item"==$state.current.name?model="lookbook":"stat"==$state.current.name||"stat.item"==$state.current.name?model="stat":"additional"==$state.current.name||"additional.item"==$state.current.name?model="additional":"workplace"==$state.current.name||"workplace.item"==$state.current.name?model="workplace":"news"==$state.current.name||"news.item"==$state.current.name?model="news":"master"==$state.current.name||"master.item"==$state.current.name?model="master":"info"==$state.current.name||"info.item"==$state.current.name?model="info":"campaign"==$state.current.name||"campaign.detail"==$state.current.name?model="campaign":"likes"==$state.current.name&&(model="likes"),model}angular.module("gmall.services").directive("itemsList",itemsList).directive("itemsDetail",itemsDetail)}(),function(){function itemDirective(){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",template:'<div ng-include="::$ctrl.getContentUrl()"></div>'}}function itemCtrl($scope,Booking,UserEntry,$user,$element,$timeout,Stuff,Master,$stateParams,$state,$q,$uibModal,exception,global,$rootScope,$auth,Account,$http,CreateContent,$notification){function getContentUrl(){return"views/template/partials/dateTime/dateTime/dateTime"+(global.get("store").val.template.addcomponents.datetime.templ?global.get("store").val.template.addcomponents.datetime.templ:"")+".html"}function checkDisable(form){console.log(form)}function activate(){self.searchEnabled=!global.get("mobile").val,self.dateTimeImg=global.get("store").val.dateTimeImg?global.get("store").val.dateTimeImg:null,self.masterName=global.get("lang").val.masters,global.get("store").val.texts&&global.get("store").val.texts.masterName&&global.get("store").val.texts.masterName[global.get("store").val.lang]&&(self.masterName=global.get("store").val.texts.masterName[global.get("store").val.lang]),$timeout(function(){$($element).height($($element).parent().height()),$($element).find("#wrapper-for-entry1").height("100%"),self.currentBlock=0},1500),$(window).resize(function(){$($element).height($($element).parent().height()),$($element).find("#wrapper-for-entry1").height("100%"),blocks&&blocks[0]&&(widthBlock=$(blocks[0]).width())}),$(window).bind("orientationchange",function(event){$($element).height($($element).parent().height()),$($element).find("#wrapper-for-entry1").height("100%"),blocks&&blocks[0]&&(widthBlock=$(blocks[0]).width())}),$scope.$on("dateTime",function(e,argsObj){self.currentBlock=0;var stuff=null,master=null;if(argsObj&&(argsObj.stuff&&(stuff=argsObj.stuff),argsObj.master&&(master=argsObj.master)),self.name=global.get("user").val&&global.get("user").val.profile&&global.get("user").val.profile.fio?global.get("user").val.profile.fio:"",self.phone=global.get("user").val&&global.get("user").val.profile&&global.get("user").val.profile.phone?global.get("user").val.profile.phone:"1",opened){if(self.masters&&self.masters.length&&1==self.masters.length){if(master=self.masters[0]._id,setMaster(master),Booking.filterListServices(self.masters,self.items,self.selectedStuff),stuff)if(self.selectedStuff.length=0,stuff.getDataForBooking)addStuff(stuff.getDataForBooking());else{var s=Stuff.getDataForBooking.call(stuff);addStuff(s)}argsObj&&argsObj.date&&(self.td=new Date(argsObj.date),setDataForDay(argsObj.date)),argsObj&&argsObj.timePart&&(argsObj.timePart.master=self.masters.getOFA("_id",argsObj.timePart.master),self.timePart=argsObj.timePart)}else{if(master&&(setMaster(master),self.selectedStuff.length=0,Booking.filterListServices(self.masters,self.items,self.selectedStuff)),stuff)if(self.selectedStuff.length=0,stuff.getDataForBooking)addStuff(stuff.getDataForBooking());else{var s=Stuff.getDataForBooking.call(stuff);addStuff(s)}argsObj&&argsObj.date&&(self.td=new Date(argsObj.date),setDataForDay(argsObj.date)),argsObj&&argsObj.timePart&&(argsObj.timePart.master=self.masters.getOFA("_id",argsObj.timePart.master),self.timePart=argsObj.timePart,console.log(self.timePart)),Booking.filterListServices(self.masters,self.items,self.selectedStuff)}self.showMasterBlock=displaySelectMasterBlock()}else opened=!0,$q.when().then(function(){return getMasters()}).then(function(){return getItems()}).then(function(){if(self.masters&&self.masters.length&&1==self.masters.length&&(master=self.masters[0]._id),master)return setMaster(master),Booking.filterListServices(self.masters,self.items,self.selectedStuff)}).then(function(){if(!stuff)return Booking.filterListServices(self.masters,self.items,self.selectedStuff);if(stuff.getDataForBooking)addStuff(stuff.getDataForBooking());else{addStuff(Stuff.getDataForBooking.call(stuff))}}).then(function(){self.showMasterBlock=displaySelectMasterBlock()}).then(function(){argsObj&&argsObj.date&&(self.td=new Date(argsObj.date),setDataForDay(argsObj.date)),argsObj&&argsObj.timePart&&(argsObj.timePart.master=self.masters.getOFA("_id",argsObj.timePart.master),self.timePart=argsObj.timePart)}).catch(function(err){console.log(err),err&&exception.catcher("init")(err)})})}function getMasters(){return $q.when().then(function(){return global.get("masters").val}).then(function(data){self.masters=data.map(function(m){return m}).filter(function(m){return m.stuffs&&m.stuffs.length})}).catch(function(err){exception.catcher("получение списка мастеров")(err)})}function setMaster(master){self.masters.forEach(function(m){m._id==master?(m.selected=!0,self.selectedMaster=m,m.show=!0):(m.selected=null,m.show=!1)}),self.timePart=null}function getItems(){return $q.when().then(function(){return self.Items.getServicesForOnlineEntry()}).then(function(res){return self.items=res}).catch(function(err){exception.catcher("получение списка услуг")(err)})}function back(){self.currentBlock=0}function forward(){self.currentBlock=0}function authComplite(){self.currentBlock=0}function addStuff(stuff){if(self.selectedStuff.map(function(s){return s.name}).indexOf(stuff.name)>-1)return void console.log("already is in list");self.selectedMaster&&"any"!=self.selectedMaster._id||(self.selectedStuff.length=0),self.selectedStuff.push(stuff),Booking.filterListServices(self.masters,self.items,self.selectedStuff),self.showMasterBlock=displaySelectMasterBlock(),self.showMasterBlock||selectMaster("any"),self.timePart=null,self.stuffForEntry=null,back()}function deleteStuff(i,event){event.stopPropagation(),self.selectedStuff.splice(i,1),Booking.filterListServices(self.masters,self.items,self.selectedStuff),self.showMasterBlock=displaySelectMasterBlock(),!self.showMasterBlock&&self.selectedStuff.length&&selectMaster("any"),console.log(!self.selectedStuff.length&&self.selectedMaster&&"any"==self.selectedMaster._id),!self.selectedStuff.length&&self.selectedMaster&&"any"==self.selectedMaster._id&&clearMaster(),self.timePart=null}function clearStuff(){self.selectedStuff.length=0,Booking.filterListServices(self.masters,self.items,self.selectedStuff),self.showMasterBlock=displaySelectMasterBlock(),self.showMasterBlock||selectMaster("any"),!self.selectedStuff.length&&self.selectedMaster&&"any"==self.selectedMaster._id&&clearMaster(),self.timePart=null}function getStuffDuration(stuff){return stuff.timePart?stuff.timePart*minTimePart:30}function selectMaster(master){master&&"any"==master?self.selectedMaster={_id:"any",name:global.get("langForm").val.noObject}:self.masters.forEach(function(m){master?master._id==m._id?(m.selected=!0,self.selectedMaster=m):m.selected=null:m.selected=!0}),Booking.filterListServices(self.masters,self.items,self.selectedStuff),forward(),self.timePart=null}function clearMaster(){self.selectedMaster=null,self.masters.forEach(function(m){m.selected=null}),Booking.filterListServices(self.masters,self.items,self.selectedStuff),self.timePart=null}function selectMasterFromList(){if(self.masters.forEach(function(m){m.nearestBlocks=null}),Booking.filterListServices(self.masters,self.items,self.selectedStuff),self.currentBlock=2,!global.get("store").val.timeTable||global.get("store").val.timeTable.some(function(day){return day.is})){var dayOfWeek,monthStr,date=self.td,month=date.getMonth(),day=date.getDate(),year=date.getFullYear(),queryArr={$or:[]},helpQuery=[],helpQueryO={},today=new Date;self.hours=today.getHours(),self.minutes=Math.ceil(today.getMinutes()/15)-1;for(var startBlockForCurrentDay=4*self.hours+self.minutes,currentMonth=today.getMonth(),currentday=today.getDate(),currentDayOfYear=Booking.getDayOfYear(currentMonth,currentday-1),daysOfMonth=Booking.getDaysOfMonth(month,year),storeTimeTable=global.get("store").val.timeTable,i=0;i<7;i++){for(date=new Date(year,month,day),dayOfWeek=date.getDay();!storeTimeTable[dayOfWeek].is;)day++,day>daysOfMonth&&(day=1,month++,daysOfMonth=Booking.getDaysOfMonth(month,year),month>11&&(month=0,year++)),date=new Date(year,month,day),dayOfWeek=date.getDay();monthStr=month,month<10&&(monthStr="0"+month),day<10&&(day="0"+day),queryArr.$or.push({date:"date"+year+monthStr+day}),helpQuery.push({y:year,m:month,d:day,dayOfWeek:dayOfWeek,dayOfYear:Booking.getDayOfYear(month,day-1),query:"date"+year+monthStr+day}),helpQueryO["date"+year+monthStr+day]=i,day++,day>daysOfMonth&&(day=1,month++,daysOfMonth=Booking.getDaysOfMonth(month,year),month>11&&(month=0,year++))}return Booking.getList({page:0,rows:3e3},queryArr).then(function(entries){var entriesForMaster=entries.reduce(function(o,item){return o[item.master]||(o[item.master]=[]),o[item.master].push(item),o},{}),durationStuffs=self.selectedStuff.reduce(function(s,item){return s+=item.timePart},0);self.masters.forEach(function(m){if(m.nearestBlocks=[],m.show&&self.selectedStuff.length){for(var entrs=[],i=0;i<7;i++)entrs.push([]);entriesForMaster[m._id]&&entriesForMaster[m._id].forEach(function(e){helpQueryO[e.date],entrs[helpQueryO[e.date]].push(e)});for(var startBlock,endBlock,blocks=[],i=0;i<7&&!blocks.length;i++)if(!m.timeTable||!m.timeTable[helpQuery[i].dayOfYear]||m.timeTable[helpQuery[i].dayOfYear].is){if(startBlock=0==i&&helpQuery[i].dayOfYear==currentDayOfYear?startBlockForCurrentDay:0,endBlock=95,storeTimeTable&&storeTimeTable[helpQuery[i].dayOfWeek]){if(storeTimeTable[helpQuery[i].dayOfWeek].start){var tempStart=4*storeTimeTable[helpQuery[i].dayOfWeek].start;tempStart>startBlock&&(startBlock=tempStart)}if(storeTimeTable[helpQuery[i].dayOfWeek].end){var tempEnd=4*storeTimeTable[helpQuery[i].dayOfWeek].end;tempEnd<endBlock&&(endBlock=tempEnd)}}if(m.timeTable&&m.timeTable[helpQuery[i].dayOfYear]){if(m.timeTable[helpQuery[i].dayOfYear].s){var tempStart=4*m.timeTable[helpQuery[i].dayOfYear].s;tempStart>startBlock&&(startBlock=tempStart)}if(m.timeTable[helpQuery[i].dayOfYear].e){var tempEnd=4*m.timeTable[helpQuery[i].dayOfYear].e;tempEnd<endBlock&&(endBlock=tempEnd)}}var entryTimeTable=angular.copy(Booking.timeParts);entrs[i].forEach(function(e){for(var ii=e.start;ii<e.start+e.qty;ii++)entryTimeTable[ii].busy=!0});for(var durationCheck,ii=startBlock;ii<=endBlock;ii++)if(!entryTimeTable[ii].busy){if(durationCheck=!0,durationStuffs)for(var iii=ii+1;iii<ii+durationStuffs;iii++)if(iii>=endBlock||entryTimeTable[iii].busy){durationCheck=!1;break}if(!durationCheck)continue;var o={i:ii,date:helpQuery[i].query};if(!blocks.length){var dd=new Date(helpQuery[i].y,helpQuery[i].m,helpQuery[i].d);o.dateString=moment(dd).format("LL")}if(blocks.push(o),blocks.length>=5)break}if(blocks.length>=5)break}m.nearestBlocks=blocks}})})}}function displaySelectMasterBlock(){if(self.masters&&self.masters.length){return self.masters.some(function(m){return m.show&&!m.workplace})}}function otherFreeTime(master){selectMaster(master),handleTimePart()}function setDay(td){self.selectedMaster&&self.selectedStuff&&self.selectedStuff.length?self.currentBlock=4:back(),td&&(self.td=td),setDataForDay(self.td),self.timePart=null}function setDataForDay(td){var date=new Date(td),currentdate=new Date;self.currentDay=currentdate.getDate(),self.hours=currentdate.getHours(),self.minutes=Math.ceil(currentdate.getMinutes()/15)-1,month=date.getMonth(),day=date.getDate(),year=date.getFullYear(),self.currentTimeBlock=self.currentDay==day?4*self.hours+self.minutes:0,month<10&&(month="0"+month),day<10&&(day="0"+day),getBookingData({date:"date"+year+month+day})}function getBookingData(query){var d=new Date(self.td),dayOfWeek=d.getDay(),month=d.getMonth(),day=d.getDate(),currentDayOfYear=Booking.getDayOfYear(month,day-1),storeSchedule=angular.copy(global.get("store").val.timeTable[dayOfWeek]);storeSchedule||(storeSchedule={start:0,end:95}),storeSchedule.start*=4,storeSchedule.end*=4;var masterSchedule;self.selectedMaster&&self.selectedMaster.timeTable&&self.selectedMaster.timeTable[currentDayOfYear]&&(masterSchedule=angular.copy(self.selectedMaster.timeTable[currentDayOfYear]),masterSchedule.s*=4,masterSchedule.e*=4);var lastBlock=95;return Booking.getList({page:0,rows:10},query).then(function(entries){var stuffsDuration=self.selectedStuff.reduce(function(d,item){return d+(item.timePart?item.timePart:4)},0);self.entryTimeTable=angular.copy(Booking.timeParts),self.entryTimeTable.forEach(function(b,i){storeSchedule.is&&i>=storeSchedule.start&&i<storeSchedule.end&&(!masterSchedule||masterSchedule.is&&i>=masterSchedule.s&&i<masterSchedule.e)?b.show=!0:b.show=!1,self.entryTimeTable[i-1]&&self.entryTimeTable[i-1].show&&!self.entryTimeTable[i].show&&(lastBlock=i),b.busy=!0,b.date=query.date}),self.masters.forEach(function(master){if(master.selected&&master.show||self.selectedMaster&&"any"==self.selectedMaster._id&&self.selectedStuff[0]&&master.stuffs.indexOf(self.selectedStuff[0]._id)>-1){master.entryTimeTable=angular.copy(Booking.timeParts),entries.forEach(function(e){if(e.master==master._id)for(var i=e.start;i<e.start+e.qty;i++)master.entryTimeTable[i].busy=!0});var tempSchedule;"any"===self.selectedMaster._id&&master.timeTable&&master.timeTable[currentDayOfYear]&&(tempSchedule=angular.copy(master.timeTable[currentDayOfYear]),tempSchedule.s*=4,tempSchedule.e*=4),master.entryTimeTable.forEach(function(block,i){if(i>self.currentTimeBlock&&self.entryTimeTable[i].show&&!block.busy&&self.entryTimeTable[i].busy){if("any"===self.selectedMaster._id&&tempSchedule&&(!tempSchedule.is||i<tempSchedule.s||i>=tempSchedule.e))return;for(var l=i+stuffsDuration,j=i;j<l;j++)if(master.entryTimeTable[j]&&master.entryTimeTable[j].busy)return;self.entryTimeTable[i].busy=!1,self.entryTimeTable[i].master=master}})}else master.entryTimeTable=[]});for(var i=lastBlock-stuffsDuration+1;i<=lastBlock;i++)self.entryTimeTable[i].busy=!0})}function setTimePart(part,master){try{var month=Number(part.date.substring(8,10)),day=Number(part.date.substring(10)),monthD=self.td.getMonth(),dayD=self.td.getDate();month==monthD&&day==dayD||self.td.setMonth(month,day)}catch(err){console.log(err)}self.timePart=part,master&&(self.selectedMaster=master,master.selected=!0,master.show=!0,self.timePart.master=master,Booking.filterListServices(self.masters,self.items,self.selectedStuff)),forward()}function filterTimePart(item){return item.show&&!item.busy&&self.timePartsI.indexOf(item.i)>-1}function filterNearesBlock(item){return self.timePartsI.indexOf(item.i)>-1}function filterTimePartForAll(){if(self.entryTimeTable){return!self.entryTimeTable.some(function(item,i){return item.show&&!item.busy})}}function orderService(form){function checkOut(userEntry){prepareMessage(self.selectedStuff,userEntry,self.timePart.date,self.timePart.i);var entry={services:self.selectedStuff,user:userEntry,remind:self.remind,timeRemind:self.timeRemind},entries=[],val=self.timePart.i;$q.when().then(function(){entry.services.forEach(function(s,i){var o={start:val,qty:s.timePart,stuffName:s.name,stuffNameL:s.nameL,stuffLink:s.link,backgroundcolor:s.backgroundcolor,masterName:self.timePart.master.name,masterNameL:self.timePart.master.nameL,masterUrl:self.timePart.master.url,service:{_id:s._id,name:s.name},user:entry.user};0==i&&entry.remind&&entry.timeRemind&&(o.remind=entry.remind,o.timeRemind=entry.timeRemind),o.master=self.timePart.master._id,o.date=self.timePart.date,o.tz=tz,s.price&&(o.paySum=s.price),s.priceSale&&(o.paySum=s.priceSale),s.currency&&(o.currency=s.currency),entries.push(o),val+=s.timePart});var actions=entries.map(function(e){return Booking.save(e).$promise});return $q.all(actions)}).then(function(res){if($http.get("/api/newRecordOnSite/"+global.get("store").val._id+"/"+global.get("store").val.seller._id),console.log("global.get('store').val.submitDateTime",global.get("store").val.submitDateTime),!global.get("store").val.submitDateTime)return console.log("client"),sendMessage()}).then(function(){if(self.selectedMaster&&self.selectedMaster.notification)if(1==self.selectedMaster.notification){if(console.log("admin notification==1"),self.selectedMaster.phone)return sendMessage(self.selectedMaster.phone)}else{if(2==self.selectedMaster.notification)return console.log("admin notification==2"),$q.when().then(function(){if(self.selectedMaster.phone)return sendMessage(self.selectedMaster.phone)}).then(function(){if(global.get("store").val.seller.phone)return sendMessage(global.get("store").val.seller.phone)});if(0==self.selectedMaster.notification&&(console.log("admin notification==0"),global.get("store").val.seller.phone))return sendMessage(global.get("store").val.seller.phone)}else if(console.log("admin default"),global.get("store").val.seller.phone)return sendMessage(global.get("store").val.seller.phone)}).then(function(res){clearStuff(),clearMaster(),self.td=new Date,self.timePart=null,$rootScope.checkedMenuChange("entryTime",!1);try{var entry=angular.copy(entries[0]),mm=self.masters.getOFA("_id",entry.master);entry.masterName=mm?mm.name:"?????",entry.dateForNote=self.dataForSend.date;var content=CreateContent.dateTimeNote(entry,userEntry),o={addressee:"seller",type:"dateTime",content:content,seller:global.get("store").val.seller._id}}catch(err){console.log(err)}return $q(function(resolve,reject){$notification.save(o,function(res){exception.showToaster("note",global.get("langNote").val.sent,""),resolve()},function(err){exception.catcher("error")(err),resolve()})})}).then(function(res){var pap=global.get("paps").val.getOFA("action","booking");pap&&pap.url&&$state.go("thanksPage",{id:pap.url})}).catch(function(err){err&&(console.log(err),err.data&&"time_is_buzy"===err.data.message&&($rootScope.$broadcast("time_is_buzy"),$rootScope.checkedMenuChange("entryTime",!1)),exception.catcher("запись на время")(err))})}function checkUserEntry(phone){return $q.when().then(function(){return $user.getItem(phone,"profile.phone")}).then(function(res){return res?res:null})}function createUserEntry(name,phone){var email=phone+"@gmall.io",user={email:email,name:name,profile:{phone:phone,fio:name}};return $auth.signup(user).then(function(response){if(console.log(response),response&&response.data&&response.data.token){if("update"==response.data.token)throw null;return $auth.setToken(response),Account.getProfile()}throw response}).then(function(response){console.log(response),response&&(global.set("user",response.data),global.get("functions").val.logged())}).catch(function(err){err&&exception.catcher("new client")(err)})}if(!form.name.$valid){var err=global.get("langError").val.entername;return void exception.catcher(global.get("lang").val.error)(err)}if(!form.phoneForm.$valid){var err=global.get("langError").val.phonenotformat;return void exception.catcher(global.get("lang").val.error)(err)}if(form.$valid){if(!self.selectedMaster){var err=global.get("langError").val.notMaster;return void exception.catcher(global.get("lang").val.error)(err)}if(!self.selectedStuff||!self.selectedStuff.length){var err=global.get("langError").val.notService;return void exception.catcher(global.get("lang").val.error)(err)}if(!self.timePart){var err=global.get("langError").val.notTime;return void exception.catcher(global.get("lang").val.error)(err)}var user=global.get("user").val,phone=(global.get("store").val,self.phone),name=self.name;if(!phone)return void console.log("нет телефона");if(self.date&&self.date.getTimezoneOffset())var tz=self.date.getTimezoneOffset()/60;else var dTemp=new Date,tz=dTemp.getTimezoneOffset()/60;user?$q.when().then(function(){return checkUserEntry(phone)}).then(function(res){if(res&&res._id&&res._id!=user._id)throw"такой телефон уже зарегистрирован. разлогинтесь и при записи на него вы получите sms с кодом авторизации"}).then(function(){checkOut({_id:global.get("user").val._id,name:name,phone:phone,email:global.get("user").val.email})}).then(function(){if(name!=user.name||phone!=user.pfone){global.get("user").val.profile.fio=name,global.get("user").val.profile.phone=phone;var o={_id:global.get("user").val._id,profile:global.get("user").val.profile};$user.save({update:"profile"},o,function(){})}}).catch(function(err){exception.catcher(global.get("lang").val.error)(err)}):$q.when().then(function(){return checkUserEntry(phone)}).then(function(res){return res&&res._id?(sendCodeToPhone(),dateTimeAuth(res),null):createUserEntry(self.name,phone)}).then(function(){if(global.get("user").val){checkOut({_id:global.get("user").val._id,name:global.get("user").val.profile.fio||global.set("user").val.name,phone:global.get("user").val.profile.phone,email:global.get("user").val.email})}})}}function handleTimePart(){self.currentBlock=4,setDataForDay(self.td)}function clearTimePart(){self.timePart=null}function dateTimeAuth(user){self.authWithEmail=!1,self.currentBlock=5}function sendCodeToPhone(){var o={phone:self.phone};self.sendCodeDisable=!0,$q.when().then(function(){return $http.post("/api/users/sendSMS",o)}).then(function(){exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)})}function verifyCode(code){var o={code:code,phone:self.phone};self.sendVerifyCodeDisable=!0,$q.when().then(function(){return $http.post("/api/users/verifySMScode",o)}).then(function(response){if(console.log(response),exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},1e4),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){response&&(authComplite(),global.set("user",response.data),global.get("functions").val.logged())}).catch(function(err){err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},1e4)})}function sendMessage(phone){return phone&&(self.dataForSend.phone=phone),self.dataForSend.phone?$q.when().then(function(){return console.log("self.dataForSend.phone",self.dataForSend.phone),$http.post("/api/users/sendMessageAboutDeal",self.dataForSend)}).catch(function(err){err&&exception.catcher("send message")(err)}):void console.log(self.dataForSend)}function prepareMessage(stuffs,user,date,start){if(self.dataForSend={},stuffs&&stuffs.length&&!(!user&user._id)&&user.phone){var hour=Math.floor(start/4),minutes=start%4*15,year=date.substring(4,8),month=date.substring(8,10),day=date.substring(10);try{date=new Date(year,month,day,hour,minutes),date=moment(date).format("lll"),self.dataForSend.name=user.name,self.dataForSend.userId=user._id,self.dataForSend.phone=user.phone,self.dataForSend.text=global.get("langOrder").val.recordedOn+" "+stuffs[0].name.toUpperCase()+" "+global.get("langOrder").val.onn+" "+date+" "+self.dataForSend.phone+(self.dataForSend.name?" "+self.dataForSend.name:""),self.dataForSend.date=date}catch(err){console.log(err)}}}var self=this;self.moment=moment;var blocks,widthBlock,opened;self.Items=Stuff,self.items=[],self.minDurationForService=global.get("store").val.seller.minDurationForService||15;var delta=0;switch(self.minDurationForService){case 30:delta=1;break;case 60:delta=3;break;case 90:delta=5;break;case 120:delta=7;break;default:delta=0}self.timePartsI=[];for(var i=0;i<96;i=i+1+delta)self.timePartsI.push(i);self.selectedStuff=[],self.timeTable15min=Booking.timeTable15min,self.timeParts=Booking.timeParts,self.timeRemindArr=Booking.timeRemindArr;var month,day,year;self.moment=moment,self.global=global,self.mobile=global.get("mobile").val,self.today=moment(Date.now()),self.dateEnd=moment(self.today+2592e6),self.countries=[{name:"Afghanistan",code:"AF"},{name:"Åland Islands",code:"AX"},{name:"Albania",code:"AL"},{name:"Algeria",code:"DZ"},{name:"American Samoa",code:"AS"},{name:"Andorra",code:"AD"},{name:"Angola",code:"AO"},{name:"Anguilla",code:"AI"},{name:"Antarctica",code:"AQ"},{name:"Antigua and Barbuda",code:"AG"},{name:"Argentina",code:"AR"},{name:"Armenia",code:"AM"},{name:"Aruba",code:"AW"},{name:"Australia",code:"AU"},{name:"Austria",code:"AT"},{name:"Azerbaijan",code:"AZ"},{name:"Bahamas",code:"BS"},{name:"Bahrain",code:"BH"},{name:"Bangladesh",code:"BD"}],self.td=new Date,self.altInputFormats=["M!/d!/yyyy"];var today=new Date;self.dateOptions={minDate:new Date,maxDate:(new Date).setDate(today.getDate()+30)},self.getContentUrl=getContentUrl,self.back=back,self.forward=forward,self.authComplite=authComplite,self.addStuff=addStuff,self.deleteStuff=deleteStuff,self.clearStuff=clearStuff,self.getStuffDuration=getStuffDuration,self.selectMaster=selectMaster,self.clearMaster=clearMaster,self.selectMasterFromList=selectMasterFromList,self.displaySelectMasterBlock=displaySelectMasterBlock,self.otherFreeTime=otherFreeTime,self.setDay=setDay,self.handleTimePart=handleTimePart,self.setTimePart=setTimePart,self.clearTimePart=clearTimePart,self.filterTimePart=filterTimePart,self.filterNearesBlock=filterNearesBlock,self.filterTimePartForAll=filterTimePartForAll,self.orderService=orderService,self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.sendMessage=sendMessage,self.checkDisable=checkDisable,self.$onInit=function(){activate()}}angular.module("gmall.directives").directive("dateTimeEntry",itemDirective),itemCtrl.$inject=["$scope","Booking","UserEntry","$user","$element","$timeout","Stuff","Master","$stateParams","$state","$q","$uibModal","exception","global","$rootScope","$auth","Account","$http","CreateContent","$notification"]}(),function(){function categoryService($resource,$uibModal,$q){function save(){return Items.save.apply(this,arguments).$promise.then(function(){})}function select(categoryId,selectSection,sections,forGroupStuffs){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectCategoryModal.html",controller:selectCategoryCtrl,size:"lg",resolve:{categoryId:function(){return categoryId},selectSection:function(){return selectSection},sections:function(){return sections?sections:null},forGroupStuffs:function(){return forGroupStuffs?forGroupStuffs:null}},
controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){reject()})})}function selectWithSection(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectCategoryWithSectionModal.html",controller:selectCategoryWithSectionCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){reject()})})}var Items=$resource("/api/collections/Category/:_id",{_id:"@_id"});return{get:Items.get,query:Items.query,save:save,delete:Items.delete,select:select,selectWithSection:selectWithSection}}function selectCategoryCtrl($q,$uibModalInstance,Sections,categoryId,selectSection,sections,forGroupStuffs){var self=this;self.categoryId=categoryId,self.selectSection=selectSection,$q.when().then(function(){return sections?sections:Sections.getSections()}).then(function(sections){self.sections=sections.filter(function(s){return forGroupStuffs?s.groupStuffs:!s.groupStuffs})}),self.ok=function(selectedCategory){$uibModalInstance.close(selectedCategory)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}function selectCategoryWithSectionCtrl($q,$uibModalInstance,Sections){var self=this;$q.when().then(function(){return Sections.getSections()}).then(function(sections){self.sections=sections}),self.ok=function(selectedCategory){$uibModalInstance.close(selectedCategory)},self.okSection=function(section){var categories=section.categories;$uibModalInstance.close(categories)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}angular.module("gmall.services").service("Category",categoryService),categoryService.$inject=["$resource","$uibModal","$q"],selectCategoryCtrl.$inject=["$q","$uibModalInstance","Sections","categoryId","selectSection","sections","forGroupStuffs"],selectCategoryWithSectionCtrl.$inject=["$q","$uibModalInstance","Sections"]}(),function(){function itemService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/SEO/seopages/createSeopage.html",controller:createCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject()})})}function createCtrl($uibModalInstance,Category){function getUrl(){return self.data.category&&self.data.category._id,"/"}function clearUrl(){self.data={}}function selectCategory(){Category.select(null,!0).then(function(category,section){console.log(category),self.data.category=category})}var self=this;self.name="",self.data={category:null},self.selectCategory=selectCategory,self.getUrl=getUrl,self.clearUrl=clearUrl,self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Seopage/:_id",{_id:"@_id"});return{get:Items.get,getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Seopage",itemService),itemService.$inject=["$resource","$uibModal","$q"]}(),function(){function itemService($resource,$uibModal,$q){function getList(){function getListComplete(response){return response&&response.length&&response.shift(),response}return Items.query().$promise.then(getListComplete)}var Items=$resource("/api/collections/Keywords/:_id",{_id:"@_id"});return{getList:getList,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("Keywords",itemService),itemService.$inject=["$resource","$uibModal","$q"]}(),function(){function itemDirective(){return{scope:{},rescrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/PROMO/campaign/campaignItem.html"}}function expirationDateDirective(){return{scope:{date:"@"},rescrict:"E",bindToController:!0,controller:expirationDateCtrl,controllerAs:"$ctrl",templateUrl:function(){return"components/PROMO/campaign/expirationDate.html"}}}function expirationDateCtrl($interval,global){function activate(){var d=new Date(self.date);d.setHours(23),d.setMinutes(59),d.setSeconds(59),self.dateEnd=Math.round((Date.parse(d)-Date.now())/1e3);$interval(function(){--self.dateEnd<=0||(self.seconds=Math.floor(self.dateEnd%60),self.minutes=Math.floor(self.dateEnd/60%60),self.hours=Math.floor(self.dateEnd/3600%24),self.days=Math.floor(self.dateEnd/3600/24),self.sseconds=self.seconds<10?"0"+self.seconds:self.seconds,self.mminutes=self.minutes<10?"0"+self.minutes:self.minutes,self.hhours=self.hours<10?"0"+self.hours:self.hours,self.ddays=self.days<10?"0"+self.days:self.days)},1e3)}function gethumanizeDay(d){return 1==d||21==d||31==d||41==d||51==d||61==d||71==d||71==d||91==d||101==d||121==d||131==d||141==d||151==d||161==d||171==d||181==d||191==d||201==d||221==d||231==d||241==d||251==d||261==d||271==d||281==d||291==d||301==d||321==d||331==d||341==d||351==d||361==d?global.get("lang").val.day:d>1&&d<5||d>21&&d<25||d>31&&d<35||d>41&&d<45||d>51&&d<55||d>61&&d<65||d>71&&d<75||d>81&&d<85||d>91&&d<95||d>101&&d<105||d>121&&d<125||d>131&&d<135||d>141&&d<145||d>151&&d<155||d>161&&d<165||d>171&&d<175||d>181&&d<185||d>191&&d<195||d>201&&d<205||d>221&&d<225||d>231&&d<235||d>241&&d<245||d>251&&d<255||d>261&&d<265||d>271&&d<275||d>281&&d<285||d>291&&d<295||d>301&&d<305||d>321&&d<325||d>331&&d<335||d>341&&d<345||d>351&&d<355||d>361&&d<365?global.get("lang").val.days:0==d||d>=5&&d<21||d>=25&&d<31||d>=35&&d<41||d>=45&&d<51||d>=65&&d<71||d>=75&&d<81||d>=85&&d<91||d>=95&&d<101||d>=105&&d<121||d>=125&&d<131||d>=135&&d<141||d>=145&&d<151||d>=165&&d<171||d>=175&&d<181||d>=185&&d<191||d>=195&&d<201||d>=205&&d<221||d>=225&&d<231||d>=235&&d<241||d>=245&&d<251||d>=265&&d<271||d>=275&&d<281||d>=285&&d<291||d>=295&&d<301||d>=305&&d<321||d>=325&&d<331||d>=335&&d<341||d>=345&&d<351||d>=365&&d<371?global.get("lang").val.dayss:void 0}function gethumanizeHour(h){return 1==h||21==h?global.get("lang").val.hour:h>1&&h<5||h>21&&h<25?global.get("lang").val.hours:0==h||h<21?global.get("lang").val.hourss:void 0}function gethumanizeMin(h){return 1==h||21==h||31==h||41==h||51==h?global.get("lang").val.minute_a:h>1&&h<5||h>21&&h<25||h>31&&h<35||h>41&&h<45||h>51&&h<55?global.get("lang").val.minutes:0==h||h<21||h>24&&h<31||h>34&&h<41||h>44&&h<51||h>54&&h<61?global.get("lang").val.minutess:void 0}function gethumanizeSec(h){return 1==h||21==h||31==h||41==h||51==h?global.get("lang").val.second:h>1&&h<5||h>21&&h<25||h>31&&h<35||h>41&&h<45||h>51&&h<55?global.get("lang").val.seconds:0==h||h<21||h>24&&h<31||h>34&&h<41||h>44&&h<51||h>54&&h<61?global.get("lang").val.secondss:void 0}var self=this;self.gethumanizeDay=gethumanizeDay,self.gethumanizeHour=gethumanizeHour,self.gethumanizeMin=gethumanizeMin,self.gethumanizeSec=gethumanizeSec,this.$onInit=function(){activate()}}function itemCtrl(Campaign,$stateParams,$state,$q,$uibModal,global,exception,Stuff,News,$window,FilterTags,BrandTags,Category,$timeout,$interval,$scope,Brand){function activate(){return getItem($stateParams.id).then(function(){self.campaignStuff="stuffs"}).catch(function(err){exception.catcher("получение компании")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){self.showCondition={percent:!1,sum:!1},self.showCondition[data.condition]=!0,self.item=data,self.item.cartType&&(self.cartType=self.item.cartType),console.log(self.cartType)}).catch(function(err){return $q.reject(err)})}function saveField(field,defer){if("dateStart"==field){var d=new Date(self.item[field]);d.setHours(0),d.setMinutes(0),d.setSeconds(1),self.item[field]=d,console.log(self.item[field])}else if("dateEnd"==field){var d=new Date(self.item[field]);d.setHours(23),d.setMinutes(59),d.setSeconds(59),self.item[field]=d,console.log(self.item[field])}defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]="brandTags"==field||"categories"==field||"tags"==field||"brands"==field||"conditionBrandTags"==field||"conditionCategories"==field||"conditionTags"==field||"conditionBrands"==field?self.item[field].map(function(b){return b._id}):self.item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createNews(){var news={name:self.item.name,link:"/campaign/"+self.item.url,img:self.item.img,desc:self.item.desc,actived:!1};$q.when().then(function(){return News.save(news).$promise}).then(function(res){$state.go("frame.news",{url:res.id})}).catch(function(err){exception.catcher("создание новости")(err)})}function selectFilterTag(){$q.when().then(function(){return FilterTags.selectFilterTag()}).then(function(tag){self.item.tags||(self.item.tags=[]),self.item.tags.push(tag),saveField("tags")}).catch(function(err){exception.catcher("выбор характеристики")(err)})}function selectBrandTag(){$q.when().then(function(){return BrandTags.selectBrandTag()}).then(function(tag){self.item.brandTags||(self.item.brandTags=[]),self.item.brandTags.push(tag),saveField("brandTags")}).catch(function(err){exception.catcher("выбор коллекции")(err)})}function selectBrand(){$q.when().then(function(){return Brand.select()}).then(function(tag){self.item.brands||(self.item.brands=[]),self.item.brands.push(tag),saveField("brands")}).catch(function(err){exception.catcher("выбор коллекции")(err)})}function selectCategory(){$q.when().then(function(){return Category.selectWithSection()}).then(function(c){c&&(self.item.categories||(self.item.categories=[]),"object"==typeof c&&c.length?c.forEach(function(cat){self.item.categories.getOFA("_id",cat._id)||self.item.categories.push(cat)}):self.item.categories.getOFA("_id",c._id)||self.item.categories.push(c),saveField("categories"))}).catch(function(err){err&&exception.catcher("выбор категории")(err)})}function selectStuff(){$q.when().then(function(){return Stuff.selectItem({actived:!0})}).then(function(stuff){self.item.stuffs||(self.item.stuffs=[]),self.item.stuffs.push(stuff),saveField("stuffs")}).catch(function(err){err&&exception.catcher("выбор товара")(err)})}function selectConditionFilterTag(){$q.when().then(function(){return FilterTags.selectFilterTag()}).then(function(tag){self.item.conditionTags||(self.item.conditionTags=[]),self.item.conditionTags.push(tag),saveField("conditionTags")}).catch(function(err){exception.catcher("выбор характеристики")(err)})}function selectConditionBrandTag(){$q.when().then(function(){return BrandTags.selectBrandTag()}).then(function(tag){self.item.conditionBrandTags||(self.item.conditionBrandTags=[]),self.item.conditionBrandTags.push(tag),saveField("conditionBrandTags")}).catch(function(err){exception.catcher("выбор коллекции")(err)})}function selectConditionBrand(){$q.when().then(function(){return Brand.select()}).then(function(tag){self.item.conditionBrands||(self.item.conditionBrands=[]),self.item.conditionBrands.push(tag),saveField("conditionBrands")}).catch(function(err){exception.catcher("выбор коллекции")(err)})}function selectConditionCategory(){$q.when().then(function(){return Category.selectWithSection()}).then(function(c){c&&(self.item.conditionCategories||(self.item.conditionCategories=[]),"object"==typeof c&&c.length?c.forEach(function(cat){self.item.conditionCategories.getOFA("_id",cat._id)||self.item.conditionCategories.push(cat)}):self.item.conditionCategories.getOFA("_id",c._id)||self.item.conditionCategories.push(c),saveField("conditionCategories"))}).catch(function(err){err&&exception.catcher("выбор категории")(err)})}function selectConditionStuff(){$q.when().then(function(){return Stuff.selectItem()}).then(function(stuff){self.item.conditionStuffs||(self.item.conditionStuffs=[]),self.item.conditionStuffs.push(stuff),saveField("conditionStuffs")}).catch(function(err){exception.catcher("выбор товара")(err)})}function deleteBrandTag(i){self.item.brandTags.splice(i,1),saveField("brandTags")}function deleteBrand(i){self.item.brands.splice(i,1),saveField("brands")}function deleteCategory(i){self.item.categories.splice(i,1),saveField("categories")}function deleteFilterTag(i){self.item.tags.splice(i,1),saveField("tags")}function deleteStuff(i){self.item.stuffs.splice(i,1),saveField("stuffs")}function deleteConditionBrandTag(i){self.item.conditionBrandTags.splice(i,1),saveField("conditionBrandTags")}function deleteConditionBrand(i){self.item.conditionBrands.splice(i,1),saveField("conditionBrands")}function deleteConditionCategory(i){self.item.conditionCategories.splice(i,1),saveField("conditionCategories")}function deleteConditionFilterTag(i){self.item.conditionTags.splice(i,1),saveField("conditionTags")}function deleteConditionStuff(i){self.item.conditionStuffs.splice(i,1),saveField("conditionStuffs")}function onSelected(){setTimeout(function(){$(":focus").blur()},50)}function showConditionInput(val){for(var key in self.showCondition)key==val?$timeout(function(){self.showCondition[val]=!0},530):self.showCondition[key]=!1}function dispalyCondition(){if(self.item)return!!(self.item.conditionTags&&self.item.conditionTags.length||self.item.conditionBrandTags&&self.item.conditionBrandTags.length||self.item.conditionStuffs&&self.item.conditionStuffs.length||self.item.conditionCategories&&self.item.conditionCategories.length)||void 0}console.log("Campaign");var self=this;self.Items=Campaign,self.mobile=global.get("mobile").val,self.global=global,self.cartType="good",self.cartTypes=[{type:"good",name:"товар"},{type:"service",name:"услуга"},{type:"info",name:"инфо"},{type:"media",name:"медиа"}],self.saveField=saveField,self.createNews=createNews,self.selectFilterTag=selectFilterTag,self.selectBrandTag=selectBrandTag,self.selectBrand=selectBrand,self.selectCategory=selectCategory,self.selectStuff=selectStuff,self.selectConditionFilterTag=selectConditionFilterTag,self.selectConditionBrandTag=selectConditionBrandTag,self.selectConditionBrand=selectConditionBrand,self.selectConditionCategory=selectConditionCategory,self.selectConditionStuff=selectConditionStuff,self.deleteBrandTag=deleteBrandTag,self.deleteCategory=deleteCategory,self.deleteFilterTag=deleteFilterTag,self.deleteStuff=deleteStuff,self.deleteConditionBrandTag=deleteConditionBrandTag,self.deleteConditionBrand=deleteConditionBrand,self.deleteBrand=deleteBrand,self.deleteConditionCategory=deleteConditionCategory,self.deleteConditionFilterTag=deleteConditionFilterTag,self.deleteConditionStuff=deleteConditionStuff,self.onSelected=onSelected,self.showConditionInput=showConditionInput,self.dispalyCondition=dispalyCondition,activate(),$scope.$on("changeLang",function(){activate()})}function campaignItemTemplateDirective(global){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/campaign/campaignDetail"+(global.get("store").val.template.campaignTempl?global.get("store").val.template.campaignTempl:"")+".html",restrict:"E"}}angular.module("gmall.services").directive("campaignItem",itemDirective).directive("campaignItemTemplate",campaignItemTemplateDirective).directive("expirationDate",expirationDateDirective),expirationDateCtrl.$inject=["$interval","global"],itemCtrl.$inject=["Campaign","$stateParams","$state","$q","$uibModal","global","exception","Stuff","News","$window","FilterTags","BrandTags","Category","$timeout","$interval","$scope","Brands"]}(),function(){function staticPageDirective(){return{scope:{},bindToController:!0,controller:staticPageCtrl,controllerAs:"$ctrl",templateUrl:"components/staticPage/staticPage.html"}}function staticPageTemplateDirective($stateParams){return{bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$scope","$element","$compile","$http","$stateParams","global",function($scope,$element,$compile,$http,$stateParams,global){var self=this;$http.get("views/template/partials/Stat/itemPage/"+$stateParams.id).then(function(response){self.content=response.data.html;var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content),global.set("titles",response.data.titles)})}]}}function staticPageCtrl(Stat,$stateParams,global,Photo,$q,$uibModal,Stuff,FilterTags,BrandTags,Brands,Campaign,Category,$timeout,$scope,Confirm,SetCSS){function activate(){Stat.get({_id:$stateParams.id}).$promise.then(function(res){res&&!res.blocks&&(res.blocks=[],saveField("blocks",[]));var bl=res.blocks.filter(function(b){return b});bl.length!=res.blocks.length&&(saveField("blocks",bl),res.blocks=bl),console.log(res.blocks),res.blocks.forEach(function(b,i){b&&(b.i=i)}),res.blocks.sort(function(a,b){return a.index-b.index}),self.item=res})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField("blocks."+block.i,block)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks");setTimeout(function(){var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},100)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}function deleteBlock(block,index){var o={_id:self.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("подтверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.item.blocks.splice(index,1);var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Stat",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/staticPage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function filterBlocks(item){return keyParts.indexOf(item.key)>-1}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){block[block.type]||(block[block.type]=[]);var img,link,url=item.url;switch(block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,url:url}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,url:url})),saveField("blocks."+block.i+".imgs",block.imgs)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs)},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs)}function changeItem(block,$index){addItemInBlock(block,$index)}var self=this;self.Items=Stat,self.type="Stat",self.global=global,self.listOfBlocksForStaticPage=listOfBlocksForAll,self.listOfBlocks=listOfBlocksForAll,self.animationTypes=animationTypes,self.setStyles=setStyles,self.saveField=saveField,self.newBlock=null,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.filterBlocks=filterBlocks,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,activate(),$scope.$on("changeLang",function(){activate()});var keyParts=global.get("store").val.template.stat.parts.filter(function(el){return el.is}).map(function(el){return el.name})}angular.module("gmall.directives").directive("staticPage",staticPageDirective).directive("staticPageTemplate",staticPageTemplateDirective),staticPageCtrl.$inject=["Stat","$stateParams","global","Photo","$q","$uibModal","Stuff","FilterTags","BrandTags","Brands","Campaign","Category","$timeout","$scope","Confirm","SetCSS"]}(),function(){function serviceFunction($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return console.log(id),Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/PROMO/coupon/createCoupon.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Coupon/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Coupon",serviceFunction),serviceFunction.$inject=["$resource","$uibModal","$q"]}(),function(){function itemDirectiveTemplate(global){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/paps/paps.html",restrict:"E"}}function itemDirective(){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/paps/papsItem.html"}}function itemCtrl(Paps,$stateParams,$q,$uibModal,exception,global,$timeout,$scope,$anchorScroll){function activate(){return $anchorScroll(),getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение post action page")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){return self.item=data,self.item}).catch(function(err){return $q.reject(err)})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}var self=this;self.Items=Paps,self.mobile=global.get("mobile").val,self.saveField=saveField,activate(),$scope.$on("changeLang",function(){activate()})}angular.module("gmall.services").directive("papsItem",itemDirective).directive("papsItemTemplate",itemDirectiveTemplate),itemCtrl.$inject=["Paps","$stateParams","$q","$uibModal","exception","global","$timeout","$scope","$anchorScroll"]}(),function(){function serviceBooking($resource,$uibModal,$q,global,$http,exception){function getCheckOutLiqpayHtml(entryM,user){var entry=angular.copy(entryM);return user&&(entry.user=user),$q.when().then(function(){return $http.post("/api/orders/checkoutLiqpayEntry",entry)}).then(function(res){res&&res.data.html&&(entryM.checkOutLiqpayHtml=res.data.html,entryM.checkOutLiqpayHtmlIs=!0)}).then(function(res){}).catch(function(err){exception.catcher("error")(err)})}function getDatesForWeek(date,num){num||(num=7);var ds=[],d=new Date(date),dw=date.getDay();0==dw&&(dw=7);for(var i=1;i<=num;i++){d=new Date(date),d.setTime(d.getTime()+864e5*(i-dw)),d.setHours(0);var month=d.getMonth(),day=d.getDate(),year=d.getFullYear(),dayOfYear=getDayOfYear(month,day-1);month<10&&(month="0"+month),day<10&&(day="0"+day);var o={date:"date"+year+month+day,d:d,dayOfYear:dayOfYear,month:moment(d).format("MMMM")};ds.push(o)}return ds}function getDateFromEntry(entry){var hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10);try{return new Date(year,month,day,hour,minutes)}catch(err){return console.log(err),"error handle date"}}function getDateFromStrDateEntry(str){var year=str.substring(4,8),month=str.substring(8,10),day=str.substring(10);try{return new Date(year,month,day)}catch(err){return console.log(err),"error handle date"}}function getDateStringFromEntry(entry,format){var hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10);try{if(format)var date=new Date(year,month,day);else{var date=new Date(year,month,day,hour,minutes);date=moment(date).format("LLL")}return date}catch(err){return console.log(err),"error handle date"}}function sendMessage(entry,user){entry=JSON.parse(JSON.stringify(entry)),user&&(entry.user=user);var dataForSend={},hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10);try{var date=new Date(year,month,day,hour,minutes);date=moment(date).format("lll"),dataForSend.name=entry.user.name,dataForSend.userId=entry.user._id,dataForSend.phone=entry.user.phone,dataForSend.text=global.get("langOrder").val.recordedOn+" "+entry.service.name.toUpperCase()+" "+global.get("langOrder").val.onn+" "+date,dataForSend.date=date}catch(err){console.log(err)}console.log(dataForSend),dataForSend&&dataForSend.date&&$q.when().then(function(){return $http.post("/api/users/sendMessageAboutDeal",dataForSend)}).catch(function(err){err&&exception.catcher("send message")(err)})}function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function newBooking(master,timePart,services,date,entryDate,start,workplaces){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/newBooking.html",controller:function($uibModalInstance,global,$timeout,$user,exception,master,timePart,services,Booking,entryDate,start,workplaces){function addingNewUser(){if(self.addingUser=!self.addingUser,self.addingUser&&self.cachePhone){var newVal=self.cachePhone.replace(pattern,"");if(console.log(newVal),console.log(newVal.length==self.cachePhone.length),newVal.length==self.cachePhone.length){for(var tempPhone=self.cachePhone.substring(0,10),i=tempPhone.length;i<10;i++)tempPhone+="0";self.oldPhone=tempPhone}else self.userName=self.cachePhone}}function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{"profile.phone":phone},{name:phone},{email:phone}]};$user.getList({page:0,rows:20},q).then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user})})}function clearUser(){self.user=null}function addUser(){console.log("add user");var user={name:self.userName,profile:{phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10),fio:self.userName},store:global.get("store").val._id};return $q.when().then(function(){return $user.checkPhoneForExist(user.profile.phone)}).then(function(res){if(res&&res.exist)throw"phone exist in base";if(user.email)return $user.checkEmailForExist(user.email);user.email=user.profile.phone+"@gmall.io"}).then(function(res){if(res&&res.exist)throw"email exist in base"}).then(function(){return $user.save(user).$promise}).then(function(res){user._id=res._id?res._id:res.id,self.addingUser=!1,self.userName="",self.user=user,console.log(user),self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function allFieldCheck(){return!self.services.length&&!self.reserved||!self.user&&!self.schedule&&!self.reserved}function checkNameNewUser(){return!self.userName||self.userName.length<3}function moveEtry(){for(var busy=!1,i=start;i<start+self.entryToMove.qty;i++)if(master.entryTimeTable[i].busy||master.entryTimeTable[i].out){busy=!0;break}if(busy)return void $uibModalInstance.dismiss("не достаточно времени");var o={_id:self.entryToMove._id};o.date=entryDate,o.start=start,o.move=!1;Booking.save({update:"start move date"},o,function(err){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)}),$uibModalInstance.close()}var self=this;self.global=global,self.workplaces=workplaces,self.date=moment(date).format("L"),self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",self.hour=parseInt(timePart/4),self.minutes=15*(timePart-4*self.hour)?15*(timePart-4*self.hour):"00",self.timeRemindArr=timeRemindArr,self.schedule=!0,self.mastersInEntry=[],master.services.forEach(function(s){s.used=!1,s.duration=15*s.timePart}),self.userName="",self.master=master,self.oldPhone="",self.services=services.length?services:[],self.entriesToMove=null,self.entryToMove=null;var pattern=/[^0-9]*/g;if(global.get("store").val.seller&&global.get("store").val.seller.minDurationForService&&Number(global.get("store").val.seller.minDurationForService/15)){
var delta=Number(global.get("store").val.seller.minDurationForService/15);1==delta&&(delta=0,console.log(delta)),self.timeDurationdArr=timeDurationdArr.filter(function(p){return!(p.part%delta)})}else self.timeDurationdArr=timeDurationdArr;self.searchUser=searchUser,self.clearUser=clearUser,self.allFieldCheck=allFieldCheck,self.addUser=addUser,self.checkNameNewUser=checkNameNewUser,self.refreshUsers=refreshUsers,self.moveEtry=moveEtry,self.addingNewUser=addingNewUser,function(){var query={query:{master:master._id,move:!0}};Booking.query(query,function(res){res&&res.length&&(res.shift(),self.entriesToMove=res.map(function(e){return e.name=e.service.name+" "+Booking.getDateStringFromEntry(e),e}))}),self.masters=global.get("masters").val.filter(function(m){return m._id!=master._id})}(),self.ok=function(){var item={remind:self.remind,timeRemind:self.timeRemind,schedule:self.schedule,setColor:self.setColor};if(self.services.length)item.services=self.services;else{if(!self.reserved)return;item.services=[{_id:"reserved",name:"reserved",timePart:self.reserved}]}self.user&&self.user._id?(item.user={_id:self.user._id,name:self.user.name,email:self.user.email},self.user.profile&&self.user.profile.phone&&(item.user.phone=self.user.profile.phone)):self.schedule?item.user={_id:"schedule",name:"schedule"}:self.reserved&&(item.user={_id:"reserved",name:"reserved"}),self.mastersInEntry.length&&(item.masters=self.mastersInEntry),self.workplace&&(item.workplace=self.workplace),$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{master:function(){return master},timePart:function(){return timePart},services:function(){return services},entryDate:function(){return entryDate},start:function(){return start},workplaces:function(){return workplaces}}}).result.then(function(item){resolve(item)},function(err){reject(err)})})}function editBooking(entry,masters,workplaces){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/editBooking.html",controller:function(global,$uibModalInstance,$user,Booking,$timeout,UserEntry,exception,entry,masters,Confirm,workplaces){function _setTimeParts(){return timeTable15min.map(function(t,i){var busy=!1;if(self.master.entryTimeTable[i].out)busy=!0;else if(self.master.entryTimeTable[i].busy&&self.master.entryTimeTable[i].entry._id!=self.entry._id)busy=!0;else for(var j=i+1;j<i+self.qty;j++)(!self.master.entryTimeTable[j]||self.master.entryTimeTable[j].out||self.master.entryTimeTable[j].busy&&self.master.entryTimeTable[j].entry._id!=self.entry._id)&&(busy=!0);return{part:i,time:t,busy:busy}})}function addNewUser(user){if(user&&(self.newUser=user),!(self.entry.users&&self.entry.users.length&&self.entry.users.some(function(u){return u._id==self.newUser._id}))){var o={_id:self.newUser._id,phone:self.newUser.phone,name:self.newUser.name,email:self.newUser.email};self.entry.users.push(o),saveField("users")}}function deleteUser(i){Confirm("удалить?").then(function(){self.entry.users.splice(i,1),saveField("users")})}function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{"profile.phone":phone},{name:phone},{email:phone}]};$user.getList({page:0,rows:20},q).then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user})})}function addUser(){var user={name:self.userName,profile:{phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10),fio:self.userName},store:global.get("store").val._id};return $q.when().then(function(){return $user.checkPhoneForExist(user.profile.phone)}).then(function(res){if(res&&res.exist)throw"phone exist in base";if(user.email)return $user.checkEmailForExist(user.email);user.email=user.profile.phone+"@gmall.io"}).then(function(res){if(res&&res.exist)throw"email exist in base"}).then(function(){return $user.save(user).$promise}).then(function(res){user._id=res._id?res._id:res.id,self.user={_id:user._id,name:user.name,email:user.email,phone:user.profile.phone},addNewUser(self.user),self.addingUser=!1,self.userName="",self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function actived(){self.user=Object.assign({},entry.user),self.user.phone&&(self.splitPoint=self.user.phone.length-10,self.phoneCode="+"+self.user.phone.substring(0,self.splitPoint),self.user.phone=self.user.phone.substring(self.splitPoint)),self.mastersAdditional=global.get("masters").val.filter(function(m){return m._id!=self.entry.master._id})}function updateUser(){self.editingUser=!1;var o={_id:entry.user._id};return o["profile.phone"]=self.phoneCode.substring(1)+self.user.phone,o["profile.fio"]=self.user.name,o.email=self.user.email,update="profile.phone profile.fio email",$q.when().then(function(){if(o["profile.phone"])return $user.checkPhoneForExist(o["profile.phone"],entry.user._id);throw"phone is empty"}).then(function(res){if(res&&res.exist)throw"phone exist in base";if(o.email)return $user.checkEmailForExist(o.email,entry.user._id);o.email=o["profile.phone"]+"@gmall.io"}).then(function(res){if(res&&res.exist)throw"email exist in base"}).then(function(){return $user.save({update:update},o).$promise}).then(function(){entry.user=self.user,entry.user.phone=o["profile.phone"],saveField("user")}).catch(function(err){err&&exception.catcher("обновление данных")(err)})}function recordAgreed(user){delay||(delay=!0,$timeout(function(){delay=!1},2e3),entry.confirm=Date.now(),saveField("confirm"),Booking.sendMessage(entry,user))}function saveField(field){var o={_id:entry._id};o[field]=entry[field],Booking.save({update:field},o,function(err){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function changeDuration(){var delta=self.qty-self.entry.qty;if(delta<0){for(var i=self.entry.start+self.qty;i<self.entry.start+self.entry.qty;i++)self.master.entryTimeTable[i].busy=!1,delete self.master.entryTimeTable[i].entry,delete self.master.entryTimeTable[i].noBorder,console.log(i);self.entry.qty=self.qty,oldEntry.qty=self.qty,saveField("qty"),self.timeParts=_setTimeParts()}else{for(var start=self.entry.start+self.entry.qty,busy=!1,i=start;i<start+delta;i++)if(!self.master.entryTimeTable[i]||self.master.entryTimeTable[i].busy||self.master.entryTimeTable[i].out){busy=!0;break}if(busy)exception.catcher("изменение продолжительности")("недостаточно свободного времени"),self.qty=self.entry.qty;else{console.log(start,start+delta),self.master.entryTimeTable[start-1]&&(self.master.entryTimeTable[start-1].noBorder=!0);for(var i=start;i<start+delta;i++)console.log(i),self.master.entryTimeTable[i].busy=!0,self.master.entryTimeTable[i].entry=self.entry,self.master.entryTimeTable[i].noBorder=i<start+delta-1;self.entry.qty=self.qty,oldEntry.qty=self.qty,saveField("qty"),self.timeParts=_setTimeParts()}}}function changeStartPart(){var delta=self.entry.start-self.startPart,part={busy:!1,i:0,master:self.master._id};if(delta>0){for(var i=0;i<self.entry.qty;i++){var j=self.startPart+i;self.master.entryTimeTable[j]=self.master.entryTimeTable[j+delta],self.master.entryTimeTable[j].i=j}for(var i=self.startPart+self.entry.qty;i<self.startPart+self.entry.qty+delta;i++)self.master.entryTimeTable[i].busy&&self.master.entryTimeTable[i].entry&&self.master.entryTimeTable[i].entry._id==self.entry._id&&(self.master.entryTimeTable[i]=angular.copy(part),self.master.entryTimeTable[i].i=i)}else{for(var i=self.entry.qty;i>0;i--){var j=self.startPart+i-1;self.master.entryTimeTable[j]=self.master.entryTimeTable[j+delta],self.master.entryTimeTable[j].i=j}for(var i=self.entry.start;i<self.entry.start-delta;i++)self.master.entryTimeTable[i].busy&&self.master.entryTimeTable[i].entry&&self.master.entryTimeTable[i].entry._id==self.entry._id&&(self.master.entryTimeTable[i]=angular.copy(part),self.master.entryTimeTable[i].i=i)}self.entry.start=self.startPart,self.hour=parseInt(self.entry.start/4),self.minutes=15*(self.entry.start-4*self.hour),saveField("start")}function moveEntry(){self.entry.move=!self.entry.move,self.saveField("move"),self.entry.move&&$uibModalInstance.close()}function changeTimeFilter(p){return!(p.busy||p.part%delta)}function changeService(){self.service&&(entry.service={_id:self.service._id,name:self.service.name},self.service.backgroundcolor&&(entry.service.backgroundcolor=self.service.backgroundcolor),saveField("service"),entry.stuffName=self.service.name,saveField("name"),entry.stuffNameL=self.service.nameL,saveField("stuffNameL"),entry.stuffLink=self.service.link,saveField("stuffLink"))}function changeWorkplace(){saveField("workplace")}var self=this;self.master=masters[entry.master],self.global=global,self.moment=moment,self.entry=entry,self.workplaces=workplaces,console.log(self.workplaces);var currentDate=Booking.getDateStringFromEntry(entry,!0);self.dateEntry=moment(currentDate).format("LL")+","+moment(currentDate).format("dddd");var oldEntry=angular.copy(entry);self.qty=oldEntry.qty,self.remind=entry.remind,self.timeRemind=entry.timeRemind,self.hour=parseInt(entry.start/4),self.minutes=15*(entry.start-4*self.hour),self.timeRemindArr=timeRemindArr;var delta=0;if(global.get("store").val.seller&&global.get("store").val.seller.minDurationForService&&Number(global.get("store").val.seller.minDurationForService/15)){var delta=Number(global.get("store").val.seller.minDurationForService/15);1==delta&&(delta=0,console.log(delta)),self.timeDurationdArr=timeDurationdArr.filter(function(p){return!(p.part%delta)})}else self.timeDurationdArr=timeDurationdArr;self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38";var update="";self.updateUser=updateUser,self.recordAgreed=recordAgreed,self.saveField=saveField,self.changeDuration=changeDuration,self.changeStartPart=changeStartPart,self.moveEntry=moveEntry,self.timeParts=_setTimeParts(),self.changeTimeFilter=changeTimeFilter,self.addNewUser=addNewUser,self.refreshUsers=refreshUsers,self.deleteUser=deleteUser,self.addUser=addUser,self.changeService=changeService,self.changeWorkplace=changeWorkplace,self.startPart=oldEntry.start,actived();var delay;self.ok=function(){update="",$uibModalInstance.close({action:"save",update:update})},self.delete=function(){Confirm("удалить?").then(function(){$uibModalInstance.close({action:"delete"})})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{entry:function(){return entry},masters:function(){return masters},workplaces:function(){return workplaces}}}).result.then(function(action){resolve(action)},function(){reject()})})}function filterListServices(masters,items,selectedStuff){selectedStuff||(selectedStuff=[]),selectedStuff=selectedStuff.filter(function(s){return s});var stuffs=null,selectedMaster=masters.filter(function(m){return m.selected});stuffs=selectedMaster&&selectedMaster.length?selectedMaster[0].stuffs:masters.filter(function(m){return selectedStuff.length?(m.show=selectedStuff.every(function(s){return m.stuffs.indexOf(s._id)>-1}),m.show):(m.show=!0,!0)}).reduce(function(a,item){return Array.prototype.push.apply(a,item.stuffs),a},[]),selectedStuff&&selectedStuff.length&&masters.forEach(function(m){m.show=selectedStuff.every(function(s){return m.stuffs.indexOf(s._id)>-1})}),items.forEach(function(s){stuffs&&selectedMaster.length?stuffs.indexOf(s._id)>-1?s.show=!0:s.show=!1:s.show=!0})}function getDayOfYear(selectedMonth,day){return 1==selectedMonth?31+day:2==selectedMonth?60+day:3==selectedMonth?91+day:4==selectedMonth?121+day:5==selectedMonth?152+day:6==selectedMonth?182+day:7==selectedMonth?213+day:8==selectedMonth?244+day:9==selectedMonth?274+day:10==selectedMonth?305+day:11==selectedMonth?335+day:day}function getDaysOfMonth(x,y){return 28+(x+Math.floor(x/8))%2+2%x+Math.floor((1+(y%100+2)%(y%100+1)*(1-(y%4+2)%(y%4+1))+(1-(y%400+2)%(y%400+1)))/x)+Math.floor(1/x)-Math.floor(((y%100+2)%(y%100+1)*(1-(y%4+2)%(y%4+1))+(1-(y%400+2)%(y%400+1)))/x)}function selectService(items){return $uibModal.open({animation:!0,size:"lg",windowClass:"modalProject",templateUrl:"components/ORDERS/online/selectServiceInSite.html",controller:function($uibModalInstance,global,$timeout,items){var self=this;self.global=global,self.items=items,self.ok=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{items:function(){return items}}}).result}function getUsedTime(start,qty){var end=start+qty,h=Math.floor(start/4),m=15*(start-4*h)||"00",h1=Math.floor(end/4);return h+"."+m+" - "+h1+"."+(15*(end-4*h1)||"00")}function getBookingWeek(queryWeek,selectedMaster,datesOfWeeks,ngClickOnEntry,admin){var storeScheduleWeek=angular.copy(global.get("store").val.timeTable);return getList(paginate,queryWeek).then(function(data){selectedMaster.week={},datesOfWeeks.forEach(function(d,dayOfWeek){selectedMaster.week[d.date]={},selectedMaster.week[d.date].entryTimeTable=angular.copy(timeParts),selectedMaster.week[d.date].entryTimeTable.forEach(function(p,i){if(p.date=d.date,p.ngClickOnEntry=ngClickOnEntry,storeScheduleWeek){var j=dayOfWeek+1;6==dayOfWeek&&(j=0),(!storeScheduleWeek[j].is||p.i<4*storeScheduleWeek[j].start||p.i>=4*storeScheduleWeek[j].end)&&(p.out=!0)}selectedMaster.timeTable&&selectedMaster.timeTable[d.dayOfYear]&&(!selectedMaster.timeTable[d.dayOfYear].is||p.i<4*selectedMaster.timeTable[d.dayOfYear].s||p.i>=4*selectedMaster.timeTable[d.dayOfYear].e)&&(p.out=!0)})}),data.forEach(function(e){for(var master=selectedMaster,i=e.start;i<e.start+e.qty;i++)master.week[e.date].entryTimeTable[i].busy=!0,i==e.start&&(master.week[e.date].entryTimeTable[i].usedTime=getUsedTime(e.start,e.qty),master.week[e.date].entryTimeTable[i].userId=e.user._id,master.week[e.date].entryTimeTable[i].service=e.service.name,master.week[e.date].entryTimeTable[i].new=!0,master.week[e.date].entryTimeTable[i].qty=e.qty,master.week[e.date].entryTimeTable[i].used=e.used,master.week[e.date].entryTimeTable[i].confirm=e.confirm,admin&&(master.week[e.date].entryTimeTable[i].user=e.user)),master.week[e.date].entryTimeTable[i].setColor=e.setColor,i!=e.start&&(master.week[e.date].entryTimeTable[i].noBorder=!0),master.week[e.date].entryTimeTable[i].entry=e,!global.get("store").val.onlineReservation||e.status&&1==e.status||(master.week[e.date].entryTimeTable[i].reservation=!0),e.start})})}function getBookingWeekScheldule(queryWeek,selectedWorkplace,datesOfWeeks,services,masters,ngClickOnEntry){var storeScheduleWeek=angular.copy(global.get("store").val.timeTable);return getList(paginate,queryWeek).then(function(data){selectedWorkplace.week={},datesOfWeeks.forEach(function(d,dayOfWeek){selectedWorkplace.week[d.date]={},selectedWorkplace.week[d.date].entryTimeTable=angular.copy(timeParts),selectedWorkplace.week[d.date].entryTimeTable.forEach(function(p,i){if(p.date=d.date,p.ngClickOnEntry=ngClickOnEntry,storeScheduleWeek){var j=dayOfWeek+1;6==dayOfWeek&&(j=0),(!storeScheduleWeek[j].is||p.i<4*storeScheduleWeek[j].start||p.i>=4*storeScheduleWeek[j].end)&&(p.out=!0)}})}),data.forEach(function(e){var serviseLink=null;if(e.service&&e.service._id&&services){var sTemp=services.getOFA("_id",e.service._id);sTemp&&(serviseLink=sTemp.link)}var masterLink=null,masterName="";if(e.master&&masters){var mTemp=masters.getOFA("_id",e.master);mTemp&&(masterLink="/master/"+mTemp.url,masterName=mTemp.name)}for(var workplace=selectedWorkplace,i=e.start;i<e.start+e.qty;i++)workplace.week[e.date].entryTimeTable[i].busy=!0,i==e.start&&(workplace.week[e.date].entryTimeTable[i]._id=e._id,workplace.week[e.date].entryTimeTable[i].usedTime=getUsedTime(e.start,e.qty),workplace.week[e.date].entryTimeTable[i].userId=e.user._id,workplace.week[e.date].entryTimeTable[i].service=e.service.name,workplace.week[e.date].entryTimeTable[i].serviceLink=serviseLink,workplace.week[e.date].entryTimeTable[i].masterLink=masterLink,workplace.week[e.date].entryTimeTable[i].masterName=masterName,e.masters&&e.masters.length&&(workplace.week[e.date].entryTimeTable[i].masters=e.masters.map(function(m){return masters.getOFA("_id",m)})),workplace.week[e.date].entryTimeTable[i].new=!0,workplace.week[e.date].entryTimeTable[i].qty=e.qty,workplace.week[e.date].entryTimeTable[i].used=e.used,workplace.week[e.date].entryTimeTable[i].confirm=e.confirm,workplace.week[e.date].entryTimeTable[i].comment=e.comment,workplace.week[e.date].entryTimeTable[i].zIndex=1),workplace.week[e.date].entryTimeTable[i].setColor=e.setColor,e.service.backgroundcolor?workplace.week[e.date].entryTimeTable[i].backgroundcolor=e.service.backgroundcolor:workplace.week[e.date].entryTimeTable[i].backgroundcolor=null,i!=e.start&&(workplace.week[e.date].entryTimeTable[i].noBorder=!0),workplace.week[e.date].entryTimeTable[i].entry=e,!global.get("store").val.onlineReservation||e.status&&1==e.status||(workplace.week[e.date].entryTimeTable[i].reservation=!0)})})}function getWeeksRange(today){today||(today=new Date);var weeksRange=[{},{},{},{},{},{},{}];return weeksRange.forEach(function(el,i){if(i){var date=new Date(today);date.setTime(date.getTime()+7*i*864e5),date.setHours(0)}else var date=today;var datesOfWeeks=getDatesForWeek(date);el.startDate=datesOfWeeks[0].d,el.startDateString=moment(datesOfWeeks[0].d).format("DD MMM"),el.endDate=datesOfWeeks[6].d,el.endDateString=moment(datesOfWeeks[6].d).format("DD MMM")}),weeksRange}function scheduleTransfer(){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/scheduleTransfer.html",controller:function(global,$uibModalInstance,Booking,$timeout,exception){var self=this;self.global=global,self.moment=moment,self.paginate={};var startdate=moment().subtract(42,"days"),td=new Date(startdate);self.weeksFrom=getWeeksRange(td),self.weeksFrom.forEach(function(el){el.date=el.startDateString+"/"+el.endDateString});var addDate=moment().add(7,"days"),addDate=moment().add(0,"days"),tdAdd=new Date(addDate);self.weeksTo=getWeeksRange(tdAdd),self.weeksTo.forEach(function(el){el.date=el.startDateString+"/"+el.endDateString}),self.ok=function(){if(!self.weekFrom||!self.weekTo)return void exception.catcher("ошибка")("не выбрана неделя");self.disabled=!0;var date=new Date(self.weekFrom.startDate);self.datesOfWeeks=Booking.getDatesForWeek(date),self.queryWeek={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},"user.name":"schedule"};var dataFrom,dataTo;return Booking.getList(self.paginate,self.queryWeek).then(function(data){return data&&data.length&&data.shift(),dataFrom=data,date=new Date(self.weekTo.startDate),self.datesOfWeeks=Booking.getDatesForWeek(date),self.queryWeek={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},"user.name":"schedule"},Booking.getList(self.paginate,self.queryWeek)}).then(function(data){data&&data.length&&data.shift(),dataTo=data;var acts=[];return data.forEach(function(d){var delEntryPromise=Booking.delete({_id:d._id});acts.push(delEntryPromise.$promise)}),$q.all(acts)}).then(function(){var start=moment(self.weekFrom.startDate),end=moment(self.weekTo.startDate),daysDelta=end.diff(start,"days"),acts=[];return dataFrom.forEach(function(d){delete d._id,delete d.__v,d.users=[];var newDate=getDateFromEntry(d);newDate.setDate(newDate.getDate()+daysDelta);var month=newDate.getMonth(),day=newDate.getDate(),year=newDate.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),d.date="date"+year+month+day,delete d.masterReplace,delete d.pays,delete d.members;var newEntryPromise=Booking.save(d);acts.push(newEntryPromise.$promise)}),$q.all(acts)}).then(function(res){$uibModalInstance.close()}).catch(function(err){$uibModalInstance.close(err)});var date,date},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(){resolve()},function(){reject()})})}for(var Items=$resource("/api/collections/Booking/:_id",{_id:"@_id"}),timeRemindArr=timeRemindArrLang.map(function(el){return{time:el[global.get("store").val.lang],part:el.part}}),timeDurationdArr=timeDurationArrLang.map(function(el){return{time:el[global.get("store").val.lang],part:el.part}}),timeParts=[],i=0;i<96;i++)timeParts.push({busy:!1,i:i});var timeTable=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],timeTable15min=["00:00","00:15","00:30","00:45","01:00","01:15","01:30","01:45","02:00","02:15","02:30","02:45","03:00","03:15","03:30","03:45","04:00","04:15","04:30","04:45","05:00","05:15","05:30","05:45","06:00","06:15","06:30","06:45","07:00","07:15","07:30","07:45","08:00","08:15","08:30","08:45","09:00","09:15","09:30","09:45","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30","13:45","14:00","14:15","14:30","14:45","15:00","15:15","15:30","15:45","16:00","16:15","16:30","16:45","17:00","17:15","17:30","17:45","18:00","18:15","18:30","18:45","19:00","19:15","19:30","19:45","20:00","20:15","20:30","20:45","21:00","21:15","21:30","21:45","22:00","22:15","22:30","22:45","23:00","23:15","23:30","23:45"],paginate={page:0,rows:500,totalItems:0};return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,timeTable:timeTable,timeTable15min:timeTable15min,timeParts:timeParts,startTimeParts:36,endTimeParts:72,newBooking:newBooking,editBooking:editBooking,filterListServices:filterListServices,timeRemindArr:timeRemindArr,getDayOfYear:getDayOfYear,getDaysOfMonth:getDaysOfMonth,sendMessage:sendMessage,getDateStringFromEntry:getDateStringFromEntry,getDateFromEntry:getDateFromEntry,getDateFromStrDateEntry:getDateFromStrDateEntry,getDatesForWeek:getDatesForWeek,selectService:selectService,getCheckOutLiqpayHtml:getCheckOutLiqpayHtml,getUsedTime:getUsedTime,getBookingWeek:getBookingWeek,getBookingWeekScheldule:getBookingWeekScheldule,getWeeksRange:getWeeksRange,scheduleTransfer:scheduleTransfer}}function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/createMaster.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}function selectService(master,timePart){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/selectService.html",controller:function($uibModalInstance,global,$user,UserEntry,exception,master,timePart){function selectUser(user){self.user=user,self.users=null}function refreshUsers(phone){phone.length<3||(self.oldPhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{phone:phone},{name:phone},{email:phone}]};UserEntry.getList({page:0,rows:20},q).then(function(res){self.users=res})}function clearUser(){self.user=null}function addUser(){console.log("add user");self.userName,self.userEmail,self.phoneCode.substring(1),self.oldPhone.substring(0,10)}function allFieldCheck(){return!self.services.length||!self.user}function checkNameNewUser(){return!self.userName||self.userName.length<3}var self=this;self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",self.hour=parseInt(timePart/4),self.minutes=15*(timePart-4*self.hour),self.timeRemindArr=timeRemindArr,master.services.forEach(function(s){s.used=!1}),self.userName="",self.master=master,self.oldPhone="",self.services=[];self.selectUser=selectUser,self.searchUser=searchUser,self.clearUser=clearUser,self.allFieldCheck=allFieldCheck,self.addUser=addUser,self.checkNameNewUser=checkNameNewUser,self.refreshUsers=refreshUsers,self.ok=function(){var item={services:self.services,user:{_id:self.user._id,name:self.user.name,phone:self.user.phone,email:self.user.email},remind:self.remind,timeRemind:self.timeRemind};$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{master:function(){return master},timePart:function(){return timePart}}}).result.then(function(item){resolve(item)},function(){reject()})})}function editEntry(master,entry,saveFoo){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/editOnline.html",controller:function($uibModalInstance,$user,UserEntry,master,entry){function actived(){self.user=Object.assign({},entry.user),self.splitPoint=self.user.phone.length-10,self.phoneCode="+"+self.user.phone.substring(0,self.splitPoint),self.user.phone=self.user.phone.substring(self.splitPoint)}function updateUser(){self.editingUser=!1;var o={_id:entry.user._id};o.phone=self.phoneCode.substring(1)+self.user.phone,o.name=self.user.name,o.email=self.user.email;var update="";"+"+entry.user.phone.substring(0,self.splitPoint)!=self.phoneCode?update="phone":entry.user.phone.substring(self.splitPoint)!=self.user.phone&&(update="phone"),entry.user.name!=self.user.name&&(update+=update?" name":"name"),entry.user.email!=self.user.email&&(update+=update?" email":"email"),UserEntry.save({update:update},o,function(){entry.user=o,actived()})}function changeDuration(){console.log(self.entry,master)}console.log(entry);var self=this;self.master=master,self.entry=entry,self.remind=entry.remind,self.timeRemind=entry.timeRemind,self.hour=parseInt(entry.start/4),self.minutes=15*(entry.start-4*self.hour),self.timeRemindArr=timeRemindArr,self.timeDuration=timeDuration,console.log(self.timeDuration),self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",self.updateUser=updateUser,self.changeDuration=changeDuration,actived(),self.ok=function(){entry.remind=self.remind,entry.timeRemind=self.timeRemind,$uibModalInstance.close("save")},self.delete=function(){$uibModalInstance.close("delete")},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{master:function(){return master},entry:function(){return entry}}}).result.then(function(action){resolve(action)},function(){reject()})})}function filterListServices(masters,items,selectedStuff){console.log(masters);var stuffs=null;stuffs=masters.filter(function(m){return selectedStuff.length?(m.show=selectedStuff.every(function(s){return m.stuffs.indexOf(s._id)>-1}),m.show):(m.show=!0,!0)}).reduce(function(a,item){return a.extend(item.stuffs),a},[]),console.log(stuffs),items.forEach(function(item){item.stuffs.forEach(function(s){stuffs?stuffs.indexOf(s._id)>-1?s.hide=!1:s.hide=!0:s.hide=!1}),console.log(item)})}for(var Items=$resource("/api/collections/Online/:_id",{_id:"@_id"}),timeRemindArr=[{time:"полчаса",part:2},{time:"час",part:4},{time:"два часа",part:8},{time:"три часа",part:12}],timeDuration=[{time:"15 мин",part:1},{time:"полчаса",part:2},{time:"45 мин",part:3},{time:"час",part:4},{time:"1 час 30 мин",part:6},{time:"два часа",part:8},{time:"два часа 30 мин",part:10},{time:"три часа",part:12},{time:"четыре часа",part:16}],timeParts=[],i=0;i<96;i++)timeParts.push({busy:!1,i:i});var timeTable=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],timeTable15min=["00:00","00:15","00:30","00:45","01:00","01:15","01:30","01:45","02:00","02:15","02:30","02:45","03:00","03:15","03:30","03:45","04:00","04:15","04:30","04:45","05:00","05:15","05:30","05:45","06:00","06:15","06:30","06:45","07:00","07:15","07:30","07:45","08:00","08:15","08:30","08:45","09:00","09:15","09:30","09:45","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30","13:45","14:00","14:15","14:30","14:45","15:00","15:15","15:30","15:45","16:00","16:15","16:30","16:45","17:00","17:15","17:30","17:45","18:00","18:15","18:30","18:45","19:00","19:15","19:30","19:45","20:00","20:15","20:30","20:45","21:00","21:15","21:30","21:45","22:00","22:15","22:30","22:45","23:00","23:15","23:30","23:45"];return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create,editEntry:editEntry,selectService:selectService,timeTable:timeTable,timeTable15min:timeTable15min,timeParts:timeParts,startTimeParts:36,endTimeParts:72,filterListServices:filterListServices}}angular.module("gmall.services").service("Online",serviceFoo).service("Booking",serviceBooking).directive("reminderOnline",function(){return{templateUrl:"components/ORDERS/online/reminderOnline.html"}}),serviceBooking.$inject=["$resource","$uibModal","$q","global","$http","exception"],serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function searchList(){return{template:"<div></div>",bindToController:!0,scope:{searchStr:"="},controllerAs:"$ctrl",controller:listCtrl}}function searchStuffList(){return{templateUrl:"views/template/header/search/list.html",scope:{searchStuffList:"=",searchStr:"="},controllerAs:"$ctrl",controller:controllersearchStuffList}}function listCtrl($scope,$http,$element,global,$stateParams,$q,$anchorScroll,$timeout,$compile){this.global=global;var url="api/search?searchStr="+$stateParams.searchStr;$q.when().then(function(){if(global.get("tempContent").val){var html=global.get("tempContent").val;$("#tempContent").empty(),global.set("tempContent",null);var o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}return $http.get(url)}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);if($element.append(content),$anchorScroll(),response.data.titles&&response.data.titles.title)for(var k in response.data.titles)response.data.titles[k]&&("title"==k?global.get("titles").val[k]+=response.data.titles[k]:global.get("titles").val[k]=response.data.titles[k])})}angular.module("gmall.directives").directive("searchList",searchList).directive("searchStuffList",searchStuffList);var controllersearchStuffList=["$scope","$rootScope","global",function($scope,$rootScope,global){var self=this;self.global=global,self.allResults=function(){$rootScope.$emit("closeSearchModal"),$rootScope.$state.go("search",{searchStr:$scope.searchStr},{reload:!0,inherit:!1,notify:!0})}}]}(),function(){function cabinetItem(global){return{scope:{},restrict:"EA",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",
templateUrl:"views/template/partials/cabinet/cabinet"+(global.get("store").val.template.addcomponents.cabinet&&global.get("store").val.template.addcomponents.cabinet.templ?global.get("store").val.template.addcomponents.cabinet.templ:"")+".html"}}function itemCtrl(global,$q,$timeout,$state,exception,Orders,CartInOrder,$order,$user,Coupon,Confirm,Booking,CreateContent,$notification,$http,$uibModal,$stateParams){function getOrders(){var payData=global.get("store").val.payData;return Orders.getList(self.paginate,self.query).then(function(res){self.orders=res.filter(function(o){return o}).map(function(o){return $order.initOrderInList(o)}),self.orders.forEach(function(o){o.date=moment(o.date).format("lll"),2==o.status&&global.get("store").val.onlinePay?payData&&payData.liqPay&&payData.liqPay.is&&$order.getCheckOutLiqpayHtml(o):o.pay&&o.pay[0]&&(o.pay[0].date=moment(o.pay[0].date).format("lll"))})})}function getEntries(){var payData=global.get("store").val.payData;return Booking.getList(self.paginateEntry,self.queryEntry).then(function(res){self.entries=res.map(function(entry){entry.master=global.get("mastersO").val[entry.master],entry.dateOblect=Booking.getDateFromEntry(entry),entry.dateString=moment(entry.dateOblect).format("LLL");try{moment(entry.dateOblect).unix()-moment().unix()>3600&&(entry.cancel=!0)}catch(err){console.log(err)}if(entry.user&&"schedule"!=entry.user._id)entry.status&&1==entry.status||!global.get("store").val.onlinePayEntry?entry.pay&&entry.pay.date&&(entry.pay.date=moment(entry.pay.date).format("lll")):payData&&payData.liqPay&&payData.liqPay.is&&Booking.getCheckOutLiqpayHtml(entry);else if(entry.user&&"schedule"==entry.user._id&&entry.users){var userData=entry.users.getOFA("_id",global.get("user").val._id);global.get("store").val.onlinePayEntry&&(userData.pay&&userData.pay.date?userData.pay&&userData.pay.date&&(entry.pay.date=moment(userData.pay.date).format("lll")):Booking.getCheckOutLiqpayHtml(entry,userData))}return entry})})}function cancelEntry(entry){console.log(entry);try{entry.masterName=entry.master&&entry.master.name?entry.master.name:"?????",entry.dateForNote=entry.dateString;var content=CreateContent.dateTimeCancelNote(entry),o={addressee:"seller",type:"dateTime",content:content,seller:global.get("store").val.seller._id}}catch(err){console.log(err)}Confirm(global.get("lang").val.delete+"?").then(function(){return Booking.delete({_id:entry._id}).$promise}).then(function(){return getEntries(),$http.get("/api/newRecordOnSite/"+global.get("store").val._id+"/"+global.get("store").val.seller._id),$notification.save(o).$promise}).then(function(res){if(exception.showToaster("note",global.get("langNote").val.sent,""),global.get("store").val.seller.phone){var o={};return o.userId=global.get("user").val._id,o.text="удалена запись на "+entry.dateString+" "+entry.master.name,o.phone=global.get("store").val.seller.phone,$http.post("/api/users/sendMessageAboutDeal",o)}}).catch(function(err){err&&exception.catcher("error")(err)})}function orderDetail(order){order.collapse=!order.collapse,order.firsOpen||(order.firsOpen=!0,CartInOrder.get({_id:order.cart._id},function(res){order.setCart(res.stuffs),order.coupon&&Coupon.get({_id:order.coupon},function(res){res&&(order.coupon=res)})}))}function deleteOrder(order){Confirm(global.get("lang").val.delete+"?").then(function(){return order.status=6,Orders.save({update:"status"},{_id:order._id,status:order.status}).$promise}).then(function(){return self.paginate.page=0,Orders.getList(self.paginate,self.query)}).then(function(res){self.orders=res.filter(function(o){return o}).map(function(o){return $order.initOrderInList(o)})}).catch(function(err){err&&exception.catcher("cabinet")(err)})}function changePswd(_){$q.when().then(function(){return $user.changePswd(self.user.val._id)}).then(function(){exception.showToaster("succes","статус","обновлено!")}).catch(function(err){err&&(err=err.data||err,exception.catcher("смена пароля")(err))})}function saveProfile(form){var o={_id:self.user.val._id,profile:self.user.val.profile};$user.save({update:"profile"},o,function(){exception.showToaster("succes","статус","обновлено!")})}function changePhone(phone){phone?$q.when().then(function(){return $user.checkPhoneForExist(phone)}).then(function(res){if(console.log("done"),res&&res.exist)throw"phone exist in base";saveProfile()}).catch(function(err){err&&exception.catcher("change phone")(err)}):(self.user.val.profile.phone="",saveProfile())}function saveFieldUser(field){var o={_id:self.user.val._id},fieldFoDB="profile."+field;o[fieldFoDB]=self.user.val.profile[field],"cityId"==field&&(fieldFoDB+=" profile.city",o["profile.city"]=self.user.val.profile.city),$user.save({update:fieldFoDB},o,function(){exception.showToaster("succes","статус","обновлено!")})}function changeEmail(){$q.when().then(function(){return $user.changeEmail(global.get("user").val._id)}).then(function(res){console.log(res),global.get("user").val.email=res}).catch(function(err){err&&exception.catcher("change email")(err)})}function changeSubscription(){item.subscription=!subscription;var item=global.get("user").val,o={_id:item._id};return o.subscription=item.subscription,$user.save({update:"subscription"},o).$promise.then(function(){exception.showToaster("succes","статус","обновлено!")},function(err){console.log(err)})}var self=this;self.moment=moment,self.global=global,self.paginate={page:0,rows:20,items:0},self.paginateEntry={page:0,rows:5,items:0},self.query={},self.notOrders=global.get("store").val.texts&&global.get("store").val.texts.notOrdersText&&global.get("store").val.texts.notOrdersText[global.get("store").val.lang]?global.get("store").val.texts.notOrdersText[global.get("store").val.lang]:"",self.notDateTime=global.get("store").val.texts&&global.get("store").val.texts.notDateTimeText&&global.get("store").val.texts.notDateTimeText[global.get("store").val.lang]?global.get("store").val.texts.notDateTimeText[global.get("store").val.lang]:"",self.orderDetail=orderDetail,self.deleteOrder=deleteOrder,self.getOrders=getOrders,self.changePswd=changePswd,self.saveFieldUser=saveFieldUser,self.saveProfile=saveProfile,self.changeEmail=changeEmail,self.changeSubscription=changeSubscription,self.getEntries=getEntries,self.cancelEntry=cancelEntry,self.changePhone=changePhone,function(){$q.when().then(function(){if(!global.get("user").val)return $timeout(function(){},700)}).then(function(){if(!global.get("user").val)throw $state.go("home"),"there is not a user in the system"}).then(function(){return self.query.user=global.get("user").val._id,self.user=global.get("user"),getOrders()}).then(function(){return self.queryEntry={$or:[{},{}]},self.queryEntry.$or[0]["user._id"]=global.get("user").val._id,self.queryEntry.$or[1]["users._id"]=global.get("user").val._id,getEntries()}).then(function(){$stateParams&&$stateParams.sec?"order"==$stateParams.sec?self.activeTabIndex=0:"online"==$stateParams.sec?self.activeTabIndex=1:"personal"==$stateParams.sec?self.activeTabIndex=2:"subscription"==$stateParams.sec?self.activeTabIndex=3:self.activeTabIndex=0:(self.activeTabIndex=0,global.get("store").val.orderis&&(global.get("store").val.onlineis?self.activeTabIndex=2:self.activeTabIndex=1))}).catch(function(err){console.log(err),err&&exception.catcher("cabinet")(err)})}()}angular.module("gmall.directives").directive("cabinetItem",cabinetItem),itemCtrl.$inject=["global","$q","$timeout","$state","exception","Orders","CartInOrder","$order","$user","Coupon","Confirm","Booking","CreateContent","$notification","$http","$uibModal","$stateParams"]}(),function(){function itemCtrl($scope,Booking,$timeout,$element,$compile,global){function setDay(day){self.selectedDay=day,self.parent.td.setDate(day),self.parent.setDay()}function filterNumOfDays(item){var i=Number(item);if(i>=self.minDay||i<=self.daysOfMonth)return!0}function prev(){console.log("prev"),self.$owl.trigger("prev.owl.carousel",[self.selectedDay-3,300])}function next(){console.log("next"),self.$owl.trigger("next.owl.carousel",[self.selectedDay+3,300])}var self=this;self.setDay=setDay,self.filterNumOfDays=filterNumOfDays,self.prev=prev,self.next=next,self.moment=moment,self.global=global,self.daysOfMonth=[],this.$onInit=function(){self.$owl=$("body").find("#dayPicker"),self.$owl.on("initialized.owl.carousel",function(event){}),activate()};var carousel_Settings={items:10,nav:!1,dots:!1},activate=function(reload){var today=new Date,month=self.parent.td.getMonth();self.selectedDay=self.parent.td.getDate();var year=self.parent.td.getFullYear(),currentMonth=today.getMonth(),currentday=today.getDate();self.minDay=month<=currentMonth?currentday:1;var qtyDaysOfMonth=Booking.getDaysOfMonth(month+1,year);if(reload){for(var daysOfMonth=[],_i=self.minDay;_i<=qtyDaysOfMonth;_i++)daysOfMonth.push(_i);self.daysOfMonth=daysOfMonth;for(var _html="",_i2=self.minDay;_i2<=qtyDaysOfMonth;_i2++)_html+='<div class="item" ng-class="{\'active\':'+_i2+'==$ctrl.selectedDay}"><a  ng-click="$ctrl.setDay('+_i2+')">'+_i2+"</a></div>";$timeout(function(){self.$owl.trigger("replace.owl.carousel",_html).trigger("refresh.owl.carousel"),$timeout(function(){var html=$("#dayPicker .owl-stage-outer");$compile(html)($scope),self.$owl.trigger("to.owl.carousel",[Number(self.selectedDay)-Number(self.minDay),1,!0])})})}else{for(var html="",i=self.minDay;i<=qtyDaysOfMonth;i++)html+='<div class="item" ng-class="{\'active\':'+i+'==$ctrl.selectedDay}"><a  ng-click="$ctrl.setDay('+i+')">'+i+"</a></div>";var linkFn=$compile(html),content=linkFn($scope);self.$owl.append(content),$timeout(function(){carousel_Settings.startPosition=Number(self.selectedDay)-Number(self.minDay),self.$owl.owlCarousel(carousel_Settings)},100)}self.qtyDaysOfMonth=qtyDaysOfMonth};$scope.$watch(function(){return self.parent.td},function(n,o){if(n&&o){self.date=n;var nd=new Date(n),od=new Date(o);nd.getMonth()!=od.getMonth()?activate("reload"):self.selectedDay=self.parent.td.getDate()}})}angular.module("gmall.directives").component("dayOfMonth",{require:{parent:"^dateTimeEntry"},controller:itemCtrl,templateUrl:"views/template/partials/dateTime/dayOfMonth.html"}),itemCtrl.$inject=["$scope","Booking","$timeout","$element","$compile","global"]}(),function(){function goodsCtrl($scope,$element,$compile,$http,$stateParams,$state,$anchorScroll,global,$q,$rootScope,$location,$timeout,$sce){this.global=global,$q.when().then(function(){if(global.get("tempContent").val){var html=global.get("tempContent").val;$("#tempContent").empty(),global.set("tempContent",null);var o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}return $http.get("views/template/partials/pricegoods.html")}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);if($element.append(content),$anchorScroll(),response.data.titles&&response.data.titles.title)for(var k in response.data.titles)if(response.data.titles[k])if("title"==k)response.data.titles[k].indexOf(global.get("titles").val[k])<0?global.get("titles").val[k]=response.data.titles[k]+". "+global.get("titles").val[k]:global.get("titles").val[k]=response.data.titles[k];else if("canonical"==k)try{global.get("titles").val[k]=$sce.trustAsResourceUrl(response.data.titles[k])}catch(err){console.log(err)}else global.get("titles").val[k]=response.data.titles[k]})}function servicesCtrl($scope,$element,$compile,$http,$stateParams,$state,$anchorScroll,global,$q,$rootScope,$location,$timeout,$sce){function getNewPrice(){$q.when().then(function(){return $http.get("views/template/partials/priceservices.html?currency="+global.get("currency").val)}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);$element.empty(),$element.append(content),$anchorScroll()})}this.global=global,$scope.$watch(function(){return global.get("currency").val},function(n,o){n!=o&&getNewPrice()}),$q.when().then(function(){if(global.get("tempContent").val){var html=global.get("tempContent").val;$("#tempContent").empty(),global.set("tempContent",null);var o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}return $http.get("views/template/partials/priceservices.html?currency="+global.get("currency").val)}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);if($element.append(content),$anchorScroll(),response.data.titles&&response.data.titles.title)for(var k in response.data.titles)if(response.data.titles[k])if("title"==k)response.data.titles[k].indexOf(global.get("titles").val[k])<0?global.get("titles").val[k]=response.data.titles[k]+". "+global.get("titles").val[k]:global.get("titles").val[k]=response.data.titles[k];else if("canonical"==k)try{global.get("titles").val[k]=$sce.trustAsResourceUrl(response.data.titles[k])}catch(err){console.log(err)}else global.get("titles").val[k]=response.data.titles[k]})}angular.module("gmall.directives").directive("priceGoods",function(){return{template:"<div></div>",controller:goodsCtrl}}).directive("priceServices",function(){return{template:"<div></div>",controller:servicesCtrl}})}(),function(){function schedulePlaceFromServerDirective(global){return{scope:!0,bindToController:!0,controller:schedulePlaceFromServerCtrl,controllerAs:"$ctrl",replace:!1}}function schedulePlaceFromServerCtrl($rootScope,Booking,$scope,$http,global,$q,$compile,$attrs,$uibModal,$state,$timeout){function changeWeek(week,service){return self.week=week,service||(service=$attrs.stuff),$q.when().then(function(){var url="views/template/partials/scheduleplace/"+week;return $http.get(url.trim()+".html",{params:{stuff:service,templ:$attrs.templ}})}).then(function(response){if(response){var atd1,addHtml=angular.element(response.data.html);atd1=addHtml.find("#innerDivInschedule").html()?$compile(addHtml.find("#innerDivInschedule").html())($scope):$compile(addHtml)($scope);var innerDivInschedule=$("#innerDivInschedule");innerDivInschedule[0]&&innerDivInschedule.empty().append(atd1)}}).catch(function(err){console.log(err)})}function chancheActiveSlide(direction){if(!delay){var week=self.week;if("right"==direction){if(!(week>0))return;week--}else{if(!(week<6))return;week++}delay=!0,changeWeek(week).then(function(){delay=!1})}}function changeService(s){self.stuff=s,delay||(delay=!0,changeWeek(self.week,s).then(function(){delay=!1}))}function setDataForEntry(entry){if(global.get("seller").val)return console.log(entry),$q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/ORDERS/online/classInfo.html",controller:classInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass",resolve:{entry:function(){return entry}}});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(entry){$rootScope.$emit("modalClosed"),console.log(entry);var o={_id:entry._id};o.masterReplace=entry.masterReplace,o.pays=entry.pays,o.members=entry.members,$state.reload(),resolve(entry)},function(){$rootScope.$emit("modalClosed"),reject()})})}function classInfoCtrl($scope,$uibModalInstance,$rootScope,global,exception,Booking,entry,$user){function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){$user.query({perPage:50,page:0,search:phone}).$promise.then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user.profile&&user.profile.fio&&(user.name=user.profile.fio),user})})}function saveField(field){var o={_id:entry._id};o[field]=entry[field],Booking.save({update:field},o,function(err){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function addNewUser(){if(entry.members||(entry.members=[]),self.user&&self.user.abonement){self.user.abonement--;var user={_id:self.user._id,name:self.user.name,phone:self.user.phone};entry.members.push(user),self.user=null,saveField("members")}}function deleteUser(idx){if(entry.members&&entry.members.length){entry.members.splice(idx,1);saveField("membrs")}}var self=this;self.entry=entry,self.users=[],self.refreshUsers=refreshUsers,self.saveField=saveField,self.deleteUser=deleteUser,self.addNewUser=addNewUser,self.ok=function(){$uibModalInstance.close($scope.entry)},self.cancel=function(){$uibModalInstance.dismiss()},$scope.entry=entry;var currentDate=Booking.getDateStringFromEntry(entry,!0);self.dateEntry=moment(currentDate).format("LL")+","+moment(currentDate).format("dddd"),$scope.dateEntry=self.dateEntry,$q.when().then(function(){return global.get("masters").val}).then(function(data){$scope.masters=data.map(function(m){return m})}).catch(function(err){exception.catcher("получение списка мастеров")(err)})}var self=this;self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.changeWeek=changeWeek,self.chancheActiveSlide=chancheActiveSlide,self.changeService=changeService,self.setDataForEntry=setDataForEntry,self.week=0;var delay;if(self.services=null,$attrs.services)try{JSON.parse($attrs.services)}catch(err){console.log(err)}$attrs.stuff&&(self.stuff=$attrs.stuff),self.$onInit=function(){},$scope.$watch(function(){return self.week},function(n,o){n!=o&&self.changeWeek(n)}),classInfoCtrl.$inject=["$scope","$uibModalInstance","$rootScope","global","exception","Booking","entry","$user"]}angular.module("gmall.services").directive("schedulePlaceFromServer",schedulePlaceFromServerDirective).directive("ngRepeatEndWatch",function(){return{restrict:"A",scope:{},link:function(scope,element,attrs){if(!attrs.ngRepeat)throw"ngRepeatEndWatch: `ngRepeat` Directive required to use this Directive";scope.$parent.$last&&(""!==attrs.ngRepeatEndWatch?"function"==typeof scope.$parent.$parent[attrs.ngRepeatEndWatch]?scope.$parent.$parent[attrs.ngRepeatEndWatch]():scope.$parent.$parent[attrs.ngRepeatEndWatch]=!0:scope.$parent.$parent.ngRepeatEnd=!0)}}}).directive("setClassWhenAtTop",function($window,$timeout){var $win=angular.element($window);return{restrict:"A",link:function(scope,element,attrs){function mastersRepeatDone(){first?delay=500:first=!0,$timeout(function(){init()},delay)}function init(){var w=0,outerW=1;try{w=element.width(),outerW=element.parent().parent().width()}catch(err){}outerW>=w?$(window).scroll(scrollHandler):$(window).off("scroll",scrollHandler)}var topClass=attrs.setClassWhenAtTop,offsetTop=element.offset().top-60;scope.mastersRepeatDone=mastersRepeatDone;var first,delay=1e3,scrollHandler=function(e){$win.scrollTop()>=offsetTop?element.addClass(topClass):element.removeClass(topClass)}}}}),schedulePlaceFromServerCtrl.$inject=["$rootScope","Booking","$scope","$http","global","$q","$compile","$attrs","$uibModal","$state","$timeout"]}(),function(){function scheduleDirective(global){return{scope:{masterId:"@"},bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:function(element,attrs){return"views/template/partials/home/schedule/directive/schedule"+(attrs&&attrs.templ&&"0"!=attrs.templ?attrs.templ:"")+(attrs&&attrs.mobile?"Mobile":"")+".html"}}}function schedulePlaceDirective(global){return{scope:{placeId:"@",scheduleStuff:"@"},bindToController:!0,controller:placeCtrl,controllerAs:"$ctrl",templateUrl:function(element,attrs){return"views/template/partials/home/scheduleplace/directive/scheduleplace"+(attrs&&attrs.templ&&"0"!=attrs.templ?attrs.templ:"")+(attrs&&attrs.mobile?"Mobile":"")+".html"}}}function schedulePlaceFromServerDirective(global){return{scope:!0,bindToController:!0,controller:schedulePlaceFromServerCtrl,controllerAs:"$ctrl",replace:!1}}function listCtrl($scope,Booking,Master,Stuff,$rootScope,global,Confirm,$q,exception,$state,Workplace){function selectStuff(item){self.selectedStuff=item?[item]:[],self.selectedMaster=null,Booking.filterListServices(self.masters,self.items,self.selectedStuff),$scope.mastersRepeatDone()}function activate(){global.get("user").val||$scope.$on("logged",function(){setUserAtEntry()}),changeStartEndTimeParts(),setWeekDates(0),self.weeksRange=Booking.getWeeksRange(self.td),$q.when().then(function(){return getMasters()}).then(function(){if(!global.get("workplaces").val)return Workplace.getList()}).then(function(wp){if(wp&&(global.set("workplaces",wp),self.workplaces=global.get("workplaces").val),self.selectedMaster=angular.copy(self.masters.getOFA("_id",self.masterId)),self.selectedMaster)self.query.master=self.selectedMaster._id;else{if(self.selectedMaster=angular.copy(self.masters.getOFA("url",self.masterId)),!self.selectedMaster)throw self.masters=null,"master doesn't match222";self.query.master=self.selectedMaster._id}return getBooking()}).then(function(){return getServices()}).catch(function(err){console.log(err),exception.catcher("инициализация")(err)})}function setWeekDates(week){if(self.week=week,week){var date=new Date(self.td);date.setTime(date.getTime()+7*week*864e5),date.setHours(0)}else var date=self.td;self.datesOfWeeks=Booking.getDatesForWeek(date);try{self.currentMonth=moment(date).format("MMMM")}catch(err){}self.currentDayOfWeek=self.date.getDay(),0==self.currentDayOfWeek&&(self.currentDayOfWeek=7),self.currentDayOfWeek--,week&&self.currentDayOfWeek,self.query={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},master:self.masterId}}function changeWeek(week){setWeekDates(week),self.tempEntry=null,$q.when().then(function(){return getBooking()})}function getMasters(){return $q.when().then(function(){return global.get("masters").val}).then(function(data){self.masters=data.map(function(m){return m.stuffs||(m.stuffs=[]),m}).filter(function(m){return m.stuffs.length})}).catch(function(err){exception.catcher("получение списка мастеров")(err)})}function getBooking(){console.log(global.get("workplaces").val),Booking.getBookingWeek(self.query,self.selectedMaster,self.datesOfWeeks,ngClickOnEntry).then(function(data){for(var date in self.selectedMaster.week)self.selectedMaster.week[date].dateStr=getDateObj2(date,self.selectedMaster.week[date].entryTimeTable);global.get("user").val&&setUserAtEntry()})}function clearTempBooking(){var e=self.tempEntry;if(e)for(var master=self.selectedMaster,i=e.start;i<e.start+e.qty;i++)master.week[e.date].entryTimeTable[i].busy=!1,delete master.week[e.date].entryTimeTable[i].temp,delete master.week[e.date].entryTimeTable[i].entry,delete master.week[e.date].entryTimeTable[i].user,delete master.week[e.date].entryTimeTable[i].phone,delete master.week[e.date].entryTimeTable[i].email,delete master.week[e.date].entryTimeTable[i].usedTime,delete master.week[e.date].entryTimeTable[i].service,delete master.week[e.date].entryTimeTable[i].qty,delete master.week[e.date].entryTimeTable[i].noBorder,delete master.week[e.date].entryTimeTable[i].new,delete master.week[e.date].entryTimeTable[i].ngClick}function setTempBooking(e){self.tempEntry=e;for(var master=self.selectedMaster,i=e.start;i<e.start+e.qty;i++)master.week[e.date].entryTimeTable[i].busy=!0,master.week[e.date].entryTimeTable[i].temp=!0,i==e.start&&(e.user&&(master.week[e.date].entryTimeTable[i].user=e.user.name,master.week[e.date].entryTimeTable[i].phone=e.user.phone,master.week[e.date].entryTimeTable[i].email=e.user.email||""),master.week[e.date].entryTimeTable[i].usedTime=Booking.getUsedTime(e.start,e.qty),master.week[e.date].entryTimeTable[i].service=e.service.name,master.week[e.date].entryTimeTable[i].new=!0,master.week[e.date].entryTimeTable[i].qty=e.qty),i!=e.start&&(master.week[e.date].entryTimeTable[i].noBorder=!0),master.week[e.date].entryTimeTable[i].entry=e}function ngClickOnEntry(date,index){var item=this;item.user||item.temp?item.user&&!item.temp&&item.uiSref?$state.go("cabinet",{sec:"online"}):item.temp&&clearTempBooking():newBooking(date,item,index)}function setUserAtEntry(){var user=global.get("user").val;if(self.selectedMaster&&self.selectedMaster.week)for(var key in self.selectedMaster.week)self.selectedMaster.week[key].entryTimeTable.forEach(function(part){part.userId&&part.userId==user._id&&(part.user=global.get("langOrder").val.yourEntry||"Ваша запись",part.uiSref="cabinet({sec:'online'})")})}function getServices(){return $q.when().then(function(){return global.get("services").val?global.get("services").val:Stuff.getServicesForOnlineEntry()}).then(function(res){return global.get("services").val||global.set("services",res),self.items=res.map(function(s){return s.duration=15*s.timePart,s.currency||(s.currency=global.get("store").val.mainCurrency),s.currencyName=global.get("store").val.currency&&global.get("store").val.currency[s.currency]&&global.get("store").val.currency[s.currency][2]?global.get("store").val.currency[s.currency][2]:s.currency,s}).filter(function(s){return self.selectedMaster.stuffs.some(function(stuff){return stuff==s._id})})}).catch(function(err){console.log(err),exception.catcher("получение списка услуг")(err)})}function newBooking(date,part,index){if(!(part.busy||part.out||index<self.currentDayOfWeek&&!self.week)){if(!self.week&&index==self.currentDayOfWeek){var d=new Date,h=d.getHours(),p=Math.ceil(d.getMinutes()/15)-1;if(part.i-4*h+p<4)return void console.log("провека времени записи. просрочена")}$q.when().then(function(){return Booking.selectService(self.items)}).then(function(item){clearTempBooking();for(var val=part.i,i=0+val;i<item.timePart+val;i++)if(!self.selectedMaster.week[date].entryTimeTable[i]||self.selectedMaster.week[date].entryTimeTable[i].out||self.selectedMaster.week[date].entryTimeTable[i].busy)throw"Не хватает времени";setTempBooking({date:date,service:{name:item.name},stuffName:item.name,stuffNameL:item.nameL,stuffLink:item.link,backgroundcolor:item.backgroundcolor,masterName:self.selectedMaster.name,masterNameL:self.selectedMaster.nameL,masterUrl:self.selectedMaster.url,start:part.i,qty:item.timePart}),self.newEntry={};var tempDate=self.datesOfWeeks.getOFA("date",date);self.newEntry.stuff=item,self.newEntry.date=tempDate.d,self.newEntry.timePart={i:part.i,date:tempDate.date,master:self.selectedMaster._id}}).catch(function(err){console.log(err),err&&"backdrop click"!=err&&exception.catcher("запись на время")(err)})}}function changeDate(){self.date||(self.date=new Date);var date=new Date(self.date);changeStartEndTimeParts(date);var month=date.getMonth(),day=date.getDate(),year=date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.query={date:"date"+year+month+day},getBooking()}function changeStartEndTimeParts(date){date||(date=self.date);var dayOfWeek=date.getDay(),month=date.getMonth(),day=date.getDate();if(self.currentDayOfYear=Booking.getDayOfYear(month,day-1),global.get("store").val.timeTable){self.storeSchedule=angular.copy(global.get("store").val.timeTable),self.dayoff=!self.storeSchedule[dayOfWeek]||!self.storeSchedule[dayOfWeek].is;var start=self.storeSchedule[dayOfWeek]&&self.storeSchedule[dayOfWeek].start?self.storeSchedule[dayOfWeek].start:6,end=self.storeSchedule[dayOfWeek]&&self.storeSchedule[dayOfWeek].end?self.storeSchedule[dayOfWeek].end:20;self.startTimeParts=4*start,self.endTimeParts=4*end;for(dayOfWeek in global.get("store").val.timeTable)global.get("store").val.timeTable[dayOfWeek].start<start&&(start=global.get("store").val.timeTable[dayOfWeek].start),global.get("store").val.timeTable[dayOfWeek].end>end&&(end=global.get("store").val.timeTable[dayOfWeek].end);self.startTimeParts=4*start,self.endTimeParts=4*end}}function filterTimePart(part){return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function filterTimePartForMaster(part){if(!(self.timePartsI.indexOf(part.i)<0))return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function booking(){self.newEntry&&(self.newEntry.master=self.selectedMaster._id,global.get("functions").val.witget("dateTime",self.newEntry))}function getDateObj(dateStr){var year=dateStr.substring(4,8),month=dateStr.substring(8,10),day=dateStr.substring(10);try{var date=new Date(year,month,day);return moment(date).format("ddd")+"/"+day}catch(err){return console.log(err),"error handle date"}}function getDateObj2(dateStr,data){if(data&&data.length){if(data.filter(function(el){if(el.busy&&el.i&&el.entry&&el.entry.start==el.i&&el.entry.workplace&&self.workplaces&&self.workplaces.length){var wp=self.workplaces.getOFA("_id",el.entry.workplace);wp&&(el.workplaceName=wp.name),el.comment=el.entry.comment}return!el.out&&el.busy}).length){var year=dateStr.substring(4,8),month=dateStr.substring(8,10),day=dateStr.substring(10);try{var date=new Date(year,month,day),s=moment(date).format("dddd"),d=moment(date).format("DD.MM.YY");return capitalizeFirstLetter(s)+" "+d}catch(err){return console.log(err),"error handle date"}}}}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}function disabledTimePart(part,index){if(index<self.currentDayOfWeek&&!self.week)return!0;if(!self.week&&index==self.currentDayOfWeek&&!part.busy){var d=new Date,h=d.getHours(),p=Math.ceil(d.getMinutes()/15)-1;if(part.i-4*h+p<4)return!0}}var self=this;self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.$state=$rootScope.$state,self.Items=Booking,self.onlineEntr={},self.date=new Date,self.td=new Date;var d;self.datesFoeWeeks=[];for(var i=0;i<=7;i++)d=new Date(self.date),d.setTime(d.getTime()+7*i*864e5),d.setHours(0),self.datesFoeWeeks.push(d);var month=(self.date.getTimezoneOffset(),self.date.getMonth()),day=self.date.getDate();self.date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.minDurationForService=global.get("store").val.seller.minDurationForService||15;var delta=0;switch(self.minDurationForService){case 30:delta=1;break;case 60:delta=3;break;case 90:delta=5;break;case 120:delta=7;break;default:delta=0}self.timeParts=Booking.timeParts,self.timePartsForTable=[],self.timePartsI=[];for(var i=0;i<96;i=i+1+delta)self.timePartsForTable.push(Booking.timeParts[i]),self.timePartsI.push(i);self.startTimeParts=Booking.startTimeParts,self.endTimeParts=Booking.endTimeParts,self.timeTable=Booking.timeTable,self.timeTable15min=Booking.timeTable15min,self.paginate={page:0,rows:100,totalItems:0},self.items=[],self.selectedStuff=[],self.selectedMaster,self.newItem={};self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD.MM.YY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,autoUpdateInput:!0,autoapply:!0,eventHandlers:{"apply.daterangepicker":function(ev,picker){changeDate()}}};var dtt=new Date;self.datePickerOptions={formatYear:"yy",maxDate:dtt.setDate(dtt.getDate()+30),startingDay:1},self.newBooking=newBooking,self.changeDate=changeDate,self.selectStuff=selectStuff,self.filterTimePart=filterTimePart,self.filterTimePartForMaster=filterTimePartForMaster,self.booking=booking,self.getDateObj=getDateObj,self.getDateObj2=getDateObj2,self.changeWeek=changeWeek,self.disabledTimePart=disabledTimePart,self.$onInit=function(){activate(),$scope.$on("time_is_buzy",function(){console.log("time_is_buzy"),getBooking()})}}function placeCtrl($scope,Booking,Master,Stuff,$rootScope,global,Confirm,$q,exception,$state,Workplace,$element){function swipeLeft(idx){idx.id<6?self.currentDayOfWeek++:self.currentDayOfWeek=0}function swipeRight(idx){0==idx.id?self.currentDayOfWeek=6:self.currentDayOfWeek--}function activate(){changeStartEndTimeParts(),setWeekDates(0),self.weeksRange=Booking.getWeeksRange(self.td),$q.when().then(function(){return getWorkplaces()}).then(function(){return getMasters()}).then(function(){return getServices()}).then(function(){return self.placeId&&(self.selectedWorkplace=angular.copy(self.workplaces.getOFA("_id",self.placeId))),
self.selectedWorkplace?self.query.workplace=self.selectedWorkplace._id:self.selectedWorkplace={},self.stuff&&(self.query["service._id"]=self.stuff),getBooking()}).then(function(){return getServices()}).catch(function(err){console.log(err),exception.catcher("инициализация")(err)})}function setWeekDates(week){if(self.week=week,week){var date=new Date(self.td);date.setTime(date.getTime()+7*week*864e5),date.setHours(0)}else var date=self.td;self.datesOfWeeks=Booking.getDatesForWeek(date);try{self.currentMonth=moment(date).format("MMMM")}catch(err){}self.currentDayOfWeek=self.date.getDay(),0==self.currentDayOfWeek&&(self.currentDayOfWeek=7),self.currentDayOfWeek--,week&&self.currentDayOfWeek,self.query={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},master:self.masterId}}function changeWeek(week){setWeekDates(week),self.tempEntry=null,$q.when().then(function(){return getBooking()})}function getWorkplaces(){return $q.when().then(function(){return Workplace.getList(null,{})}).then(function(data){self.workplaces=data}).catch(function(err){exception.catcher("получение списка рабочих мест")(err)})}function getMasters(){return $q.when().then(function(){return global.get("masters").val}).then(function(data){self.masters=data}).catch(function(err){exception.catcher("получение списка мастеров")(err)})}function getBooking(){Booking.getBookingWeekScheldule(self.query,self.selectedWorkplace,self.datesOfWeeks,self.items,self.masters).then(function(data){})}function getServices(){return $q.when().then(function(){return global.get("services").val?global.get("services").val:Stuff.getServicesForOnlineEntry()}).then(function(res){return global.get("services").val||global.set("services",res),self.items=res.map(function(s){return s.duration=15*s.timePart,s.currency||(s.currency=global.get("store").val.mainCurrency),s.currencyName=global.get("store").val.currency&&global.get("store").val.currency[s.currency]&&global.get("store").val.currency[s.currency][2]?global.get("store").val.currency[s.currency][2]:s.currency,s})}).catch(function(err){console.log(err),exception.catcher("получение списка услуг")(err)})}function changeDate(){self.date||(self.date=new Date);var date=new Date(self.date);changeStartEndTimeParts(date);var month=date.getMonth(),day=date.getDate(),year=date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.query={date:"date"+year+month+day},getBooking()}function changeStartEndTimeParts(date){date||(date=self.date);var dayOfWeek=date.getDay(),month=date.getMonth(),day=date.getDate();if(self.currentDayOfYear=Booking.getDayOfYear(month,day-1),global.get("store").val.timeTable){self.storeSchedule=angular.copy(global.get("store").val.timeTable),self.dayoff=!self.storeSchedule[dayOfWeek]||!self.storeSchedule[dayOfWeek].is;var start=self.storeSchedule[dayOfWeek]&&self.storeSchedule[dayOfWeek].start?self.storeSchedule[dayOfWeek].start:6,end=self.storeSchedule[dayOfWeek]&&self.storeSchedule[dayOfWeek].end?self.storeSchedule[dayOfWeek].end:20;self.startTimeParts=4*start,self.endTimeParts=4*end;for(dayOfWeek in global.get("store").val.timeTable)global.get("store").val.timeTable[dayOfWeek].start<start&&(start=global.get("store").val.timeTable[dayOfWeek].start),global.get("store").val.timeTable[dayOfWeek].end>end&&(end=global.get("store").val.timeTable[dayOfWeek].end);self.startTimeParts=4*start,self.endTimeParts=4*end}}function filterTimePart(part){return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function filterTimePartForMaster(part){if(!(self.timePartsI.indexOf(part.i)<0))return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function getDateObj(dateStr){var year=dateStr.substring(4,8),month=dateStr.substring(8,10),day=dateStr.substring(10);try{var date=new Date(year,month,day);return moment(date).format("ddd")+"/"+day}catch(err){return console.log(err),"error handle date"}}function disabledTimePart(part,index){if(!self.week&&index==self.currentDayOfWeek){var d=new Date,h=d.getHours(),p=Math.ceil(d.getMinutes()/15)-1;if(part.i-4*h+p<4)return!0}}var self=this;angular.element($element).data("stuff")&&(self.stuff=angular.element($element).data("stuff")),self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.$state=$rootScope.$state,self.Items=Booking,self.onlineEntr={},self.date=new Date,self.td=new Date;var d;self.datesFoeWeeks=[];for(var i=0;i<=7;i++)d=new Date(self.date),d.setTime(d.getTime()+7*i*864e5),d.setHours(0),self.datesFoeWeeks.push(d);var month=(self.date.getTimezoneOffset(),self.date.getMonth()),day=self.date.getDate();self.date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.week=0,self.noWrapSlides=!0,$scope.$watch(function(){return self.week},function(n,o){n!=o&&self.changeWeek(n)}),self.minDurationForService=global.get("store").val.seller.minDurationForService||15;var delta=0;switch(self.minDurationForService){case 30:delta=1;break;case 60:delta=3;break;case 90:delta=5;break;case 120:delta=7;break;default:delta=0}self.timeParts=Booking.timeParts,self.timePartsForTable=[],self.timePartsI=[];for(var i=0;i<96;i=i+1+delta)self.timePartsForTable.push(Booking.timeParts[i]),self.timePartsI.push(i);self.slideMasterWeekArry=[{id:0,active:!1},{id:1,active:!1},{id:2,active:!1},{id:3,active:!1},{id:4,active:!1},{id:5,active:!1},{id:6,active:!1}],self.currentDayOfWeek=5,self.startTimeParts=Booking.startTimeParts,self.endTimeParts=Booking.endTimeParts,self.timeTable=Booking.timeTable,self.timeTable15min=Booking.timeTable15min,self.paginate={page:0,rows:100,totalItems:0},self.items=[],self.selectedStuff=[],self.selectedMaster,self.newItem={};var dtt=new Date;self.datePickerOptions={formatYear:"yy",maxDate:dtt.setDate(dtt.getDate()+30),startingDay:1},self.changeDate=changeDate,self.filterTimePart=filterTimePart,self.filterTimePartForMaster=filterTimePartForMaster,self.getDateObj=getDateObj,self.changeWeek=changeWeek,self.disabledTimePart=disabledTimePart,self.swipeLeft=swipeLeft,self.swipeRight=swipeRight,self.$onInit=function(){activate()}}function schedulePlaceFromServerCtrl($scope,$http,global,$q,$compile,$attrs){function changeWeek(week,service){return self.week=week,service||(service=$attrs.stuff),$q.when().then(function(){var url="views/template/partials/scheduleplace/"+week;return $http.get(url.trim()+".html",{params:{stuff:service,templ:$attrs.templ}})}).then(function(response){if(response){var atd1,addHtml=angular.element(response.data.html);atd1=addHtml.find("#innerDivInschedule").html()?$compile(addHtml.find("#innerDivInschedule").html())($scope):$compile(addHtml)($scope);var innerDivInschedule=$("#innerDivInschedule");innerDivInschedule[0]&&innerDivInschedule.empty().append(atd1)}}).catch(function(err){console.log(err)})}function chancheActiveSlide(direction){if(!delay){var week=self.week;if("right"==direction){if(!(week>0))return;week--}else{if(!(week<6))return;week++}delay=!0,changeWeek(week).then(function(){delay=!1})}}function changeService(s){self.stuff=s,delay||(delay=!0,changeWeek(self.week,s).then(function(){delay=!1}))}var self=this;self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.changeWeek=changeWeek,self.chancheActiveSlide=chancheActiveSlide,self.changeService=changeService,self.week=0;var delay;if(self.services=null,$attrs.services)try{JSON.parse($attrs.services)}catch(err){console.log(err)}$attrs.stuff&&(self.stuff=$attrs.stuff),self.$onInit=function(){},$scope.$watch(function(){return self.week},function(n,o){n!=o&&self.changeWeek(n)})}angular.module("gmall.services").directive("scheduleMaster",scheduleDirective).directive("schedulePlace",schedulePlaceDirective).directive("schedulePlaceFromServer22",schedulePlaceFromServerDirective).directive("ngRepeatEndWatch",function(){return{restrict:"A",scope:{},link:function(scope,element,attrs){if(!attrs.ngRepeat)throw"ngRepeatEndWatch: `ngRepeat` Directive required to use this Directive";scope.$parent.$last&&(""!==attrs.ngRepeatEndWatch?"function"==typeof scope.$parent.$parent[attrs.ngRepeatEndWatch]?scope.$parent.$parent[attrs.ngRepeatEndWatch]():scope.$parent.$parent[attrs.ngRepeatEndWatch]=!0:scope.$parent.$parent.ngRepeatEnd=!0)}}}).directive("setClassWhenAtTop",function($window,$timeout){var $win=angular.element($window);return{restrict:"A",link:function(scope,element,attrs){function mastersRepeatDone(){first?delay=500:first=!0,$timeout(function(){init()},delay)}function init(){var w=0,outerW=1;try{w=element.width(),outerW=element.parent().parent().width()}catch(err){}outerW>=w?$(window).scroll(scrollHandler):$(window).off("scroll",scrollHandler)}var topClass=attrs.setClassWhenAtTop,offsetTop=element.offset().top-60;scope.mastersRepeatDone=mastersRepeatDone;var first,delay=1e3,scrollHandler=function(e){$win.scrollTop()>=offsetTop?element.addClass(topClass):element.removeClass(topClass)}}}}),listCtrl.$inject=["$scope","Booking","Master","Stuff","$rootScope","global","Confirm","$q","exception","$state","Workplace"],placeCtrl.$inject=["$scope","Booking","Master","Stuff","$rootScope","global","Confirm","$q","exception","$state","Workplace","$element"],schedulePlaceFromServerCtrl.$inject=["$scope","$http","global","$q","$compile","$attrs"]}(),function(){function itemListDirective(){return{scope:{},bindToController:!0,controller:itemListCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/workplace/workplaceList.html"}}function workplaceItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:ItemCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/workplace/workplaceItem.html"}}function itemListCtrl(Items,$state,global,Confirm,$q,exception,Photo,$timeout){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){self.Items.create().then(function(res){return self.newItem={},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.workplace.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function cloneItem(item){var name;self.Items.create().then(function(res){return name=res,self.Items.getItem(item._id)}).then(function(master){return self.newItem=angular.copy(master),self.newItem.name=name,self.newItem.nameL={},delete self.newItem._id,delete self.newItem.__v,delete self.newItem.url,console.log(self.newItem),self.newItem.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id})),block.imgs=[]}),self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.workplace.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание объекта")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Workplace/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Workplace",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объекта")(err)})}function dropCallback(item){var i=0;return setTimeout(function(){self.items.reduce(function(p,item){return p.then(function(){return i++,item.index=i,saveField(item,"index")})},$q.when(!0)).then(function(){console.log(self.items.map(function(el){return el.index}))})},50),item}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:20,totalItems:0},self.newItem={name:"наименование"},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.deleteItem=deleteItem,self.createItem=createItem,self.dropCallback=dropCallback,self.cloneItem=cloneItem,function(){getList().then(function(){})}()}function ItemCtrl(Items,$stateParams,$q,$uibModal,global,exception,Stuff,Photo,$scope,$timeout,Confirm,SetCSS){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){data&&!data.blocks&&(data.blocks=[],saveField("blocks",[]));var bl=data.blocks.filter(function(b){return b});return bl.length!=data.blocks.length&&(saveField("blocks",bl),data.blocks=bl),data.blocks.forEach(function(b,i){"stuffs"==b.type&&b.stuffs.length&&(b.stuffs=b.stuffs.map(function(s){return s._is||s})),b.i=i}),data.blocks.sort(function(a,b){return a.index-b.index}),self.item=data,self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){block.elements&&saveField("blocks."+block.i+".elements",block.elements),block.blockStyle&&saveField("blocks."+block.i+".blockStyle",block.blockStyle)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){if(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}}function deleteBlock(block,index){var o={_id:self.item._id},update={update:"_id_id",embeddedName:"blocks"};o.id=block.id,update.embeddedPull=!0,Confirm("потверждаете?").then(function(){return self.item.blocks.splice(index,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Workplace",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/workplace/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){if("stuffs"==block.type&&block.stuffs&&block.stuffs.length&&block.stuffs.some(function(s){return s&&s._id?s._id==item._id:s==item._id}))throw"такой объект уже есть";block[block.type]||(block[block.type]=[]);var img,link;switch(name=item.name,block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,_id:item._id}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,_id:item._id})),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}).catch(function(err){err&&exception.catcher("добавление")(err)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}function changeItem(block,$index){addItemInBlock(block,$index)}var self=this;self.Items=Items,self.type="Workplace",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForWorkplacePage=listOfBlocksForWorkplacePage,self.listOfBlocks=listOfBlocksForWorkplacePage,console.log(self.listOfBlocksForWorkplacePage),console.log(self.listOfBlocks),self.moment=moment,self.saveField=saveField,self.setStyles=setStyles,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,activate(),$scope.$on("changeLang",function(){activate()}),global.get("store").val.template.workplace||(global.get("store").val.template.workplace={parts:[]});global.get("store").val.template.workplace.parts.filter(function(el){return el.is}).map(function(el){return el.name})}function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/workplace/createItem.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/Workplace/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Workplace",serviceFoo),angular.module("gmall.directives").directive("workplaceList",itemListDirective).directive("workplaceItem",workplaceItemDirective),itemListCtrl.$inject=["Workplace","$state","global","Confirm","$q","exception","Photo","$timeout"],ItemCtrl.$inject=["Workplace","$stateParams","$q","$uibModal","global","exception","Stuff","Photo","$scope","$timeout","Confirm","SetCSS"],serviceFoo.$inject=["$resource","$uibModal","$q","global"]}();