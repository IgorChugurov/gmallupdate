"use strict";function getCookie(name){var parts=document.cookie.split(name+"=");if(2==parts.length)return parts.pop().split(";").shift()}function findObInArray(arr,prop,value){for(var i=0,l=arr.length;i<l;i++)if(arr[i][prop]==value)return arr[i]}!function(){function decimalAdjust(type,value,exp){return void 0===exp||0==+exp?Math[type](value):(value=+value,exp=+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp))),value=value.toString().split("e"),+(value[0]+"e"+(value[1]?+value[1]+exp:exp))))}Math.round10||(Math.round10=function(value,exp){return decimalAdjust("round",value,exp)}),Math.floor10||(Math.floor10=function(value,exp){return decimalAdjust("floor",value,exp)}),Math.ceil10||(Math.ceil10=function(value,exp){return decimalAdjust("ceil",value,exp)})}();var globalFunction=globalFunction||{};globalFunction.getObjectFromArray=function(arr,prop,value){for(var i=0,l=arr.length;i<l;i++)if(arr[i][prop]&&arr[i][prop]==value)return arr[i]},Array.prototype.getObjectFromArray||(Array.prototype.getObjectFromArray=function(prop,value){for(var i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop]==value)return this[i]}),function($){$.extend({playSound:function(){return $("<embed src='"+arguments[0]+".mp3' hidden='true' autostart='true' loop='false' class='playSound'><audio autoplay='autoplay' style='display:none;' controls='controls'><source src='"+arguments[0]+".mp3' /><source src='"+arguments[0]+".ogg' /></audio>").appendTo("body")}})}(jQuery),String.prototype.insert=function(index,string){return index>0?this.substring(0,index)+string+this.substring(index,this.length):string+this},Array.prototype.indexOf||(Array.prototype.indexOf=function(elem){var len=this.length,from=Number(arguments[1])||0;for(from=from<0?Math.ceil(from):Math.floor(from),from<0&&(from+=len);from<len;from++)if(from in this&&this[from]===elem)return from;return-1}),Array.prototype.remove||(Array.prototype.remove=function(elem){var index=this.indexOf(elem);alert(index),index!==-1&&this.splice(index,1)}),Array.prototype.getObjectFromArray=function(prop,value,a,filter){for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop]==value){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.getArrayObjects=function(prop,value){for(var arr=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].length){var _arr=this[i][prop].map(function(item){return"object"==typeof item?item._id:item});_arr.indexOf(value)>-1&&arr.push(this[i])}return arr};var myApp=angular.module("gmall",["ngRoute","ui.router","ngResource","ngCookies","ui.bootstrap","btford.socket-io","ui.select2","i.mongoPaginate","checklist-model","ngAutocomplete","gmall.controllers","gmall.filters","gmall.services","gmall.directives","i-orders","ngTasty","ui.select","textAngular","JSONedit","angular-json-editor"]).run(["$rootScope","$state","$stateParams","globalSrv","global",function($rootScope,$state,$stateParams,globalSrv,global){$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,globalSrv.getData("user").then(function(response){global.set("user",response.data)}),globalSrv.getData("config").then(function(response){global.set("config",response.data)}),globalSrv.getData("store").then(function(response){global.set("store",response.data)}),globalSrv.getData("groups").then(function(response){global.set("groups",response.data)}),globalSrv.getData("categories").then(function(response){response.data.shift(),global.set("categories",response.data),globalSrv.getData("groups").then(function(response){response.data.shift(),global.set("groups",response.data),global.get("categories").val.forEach(function(el){})})}),globalSrv.getData("brands").then(function(response){response.data.shift(),global.set("brands",response.data)}),globalSrv.getData("partners").then(function(response){response.data.shift(),global.set("partners",response.data)}),globalSrv.getData("discounts").then(function(response){response.data.shift(),global.set("discounts",response.data)}),globalSrv.getData("filters").then(function(response){response.data.shift(),global.set("filters",response.data),globalSrv.getData("filterTags").then(function(response){response.data.shift(),global.set("filterTags",response.data),global.set("nostore",globalFunction.getObjectFromArray(response.data,"type","nostore"));var filterSticker=global.get("filters").val.getObjectFromArray("sticker",!0);filterSticker&&global.set("filterTagsSticker",global.get("filterTags").val.getObjectFromArray("filter",filterSticker._id,"array","sticker"))})}),globalSrv.getData("campaign").then(function(response){response.data.shift(),global.set("campaign",response.data)})}]).config(["$stateProvider","$urlRouterProvider","$locationProvider","globalProvider","JSONEditorProvider",function($stateProvider,$urlRouterProvider,$locationProvider,globalProvider,JSONEditorProvider){$locationProvider.html5Mode(!0),$locationProvider.hashPrefix("!"),$urlRouterProvider.when("/","/admin123").otherwise("/"),JSONEditorProvider.configure({plugins:{sceditor:{style:"sce/development/jquery.sceditor.default.css"}},defaults:{options:{iconlib:"bootstrap3",theme:"bootstrap3",ajax:!0}}}),globalProvider.setUrl({config:"/api/config/",user:"/api/users/me",partners:"/api/collections/Partner/",brands:"/api/collections/Brand/",discounts:"/api/collections/Discount/",categories:"/api/collections/Category/",filterTags:"/api/collections/FilterTags/",filters:"/api/collections/Filter/",groups:"/api/collections/Group/",store:"/api/collections/Store/current",campaign:"/api/collections/Campaign"}),globalProvider.set("config"),globalProvider.set("brands"),globalProvider.set("discounts"),globalProvider.set("partners"),globalProvider.set("categories"),globalProvider.set("filters"),globalProvider.set("filterTags"),globalProvider.set("nostore"),globalProvider.set("groups"),globalProvider.set("campaign"),globalProvider.set("store"),globalProvider.set("filterTagsSticker"),globalProvider.set("coupon"),globalProvider.set("user"),$stateProvider.state("frame",{url:"/admin123",abstract:!0,templateUrl:function(){return"/manager/views/partials/mainFrame.html"},controller:"mainFrameCtrl"}).state("frame.home",{url:"",templateUrl:function(){return"manager/views/partials/home.html"},controller:"homeCtrl"}).state("frame.brands",{url:"/brands",templateUrl:function(){return"manager/views/partials/brands.html"},controller:"brandsCtrl"}).state("frame.brandsSeo",{url:"/brandsSeo",resolve:{model:function(){return"Brand"}},templateUrl:function(){return"manager/views/partials/pageSeo.html"},controller:"seoPageCtrl"}).state("frame.slides",{url:"/slides",templateUrl:function(){return"manager/views/partials/slides.html"},controller:"brandsCtrl"}).state("frame.filters",{url:"/filters",templateUrl:function(){return"manager/views/partials/filters.html"},controller:"filtersCtrl"}).state("frame.category",{url:"/category",resolve:{model:function(){return"Category"}},templateUrl:function(){return"manager/views/partials/category.html"},controller:"categoryCtrl"}).state("frame.categoryGroupList",{url:"/categoryGroupList",resolve:{model:function(){return"Group"},data:function(){return{head:"Группы категорий",action:"группу"}}},templateUrl:function(){return"manager/views/partials/categoryGroupList.html"},controller:"listCtrl"}).state("frame.categoryGroupList.edit",{url:"/categoryGroupListEdit/:model/:id",resolve:{model:function(){return"Group"}},templateUrl:function(){return"manager/views/partials/categoryGroupList.edit.html"},controller:"listEditCtrl"}).state("frame.PAP",{url:"/PAPList",resolve:{model:function(){return"PAP"},data:function(){return{head:"Страницы past-action",action:"страницу"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.PAP.edit",{url:"/:model:/:id",resolve:{model:function(){return"PAP"}},templateUrl:function(){return"manager/views/partials/PAP.edit.html"},controller:"listEditCtrl"}).state("frame.feedBackList",{url:"/feedBackList",resolve:{model:function(){return"FeedBack"},data:function(){return{head:"Сообщения обратной связи",action:"сообщение"}}},templateUrl:function(){return"manager/views/partials/feedBack.html"},controller:"listCtrl"}).state("frame.Template",{url:"/template",resolve:{model:function(){return"Template"},data:function(){return{head:"Шаблоны",action:"шаблон"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.Template.edit",{url:"/:model/:id",resolve:{model:function(){return"Template"}},templateUrl:function(){return"manager/views/partials/template.edit.html"},controller:"listEditCtrl"}).state("frame.Store",{url:"/store",resolve:{model:function(){return"Store"},data:function(){return{head:"Магазины",action:"магазин"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.Store.edit",{url:"/:model/:id",resolve:{model:function(){return"Store"}},templateUrl:function(){return"manager/views/partials/store.edit.html"},controller:"listEditCtrl"}).state("frame.Seller",{url:"/seller",resolve:{model:function(){return"Seller"},data:function(){return{head:"Продавцы",action:"продавца"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.Seller.edit",{url:"/:model/:id",resolve:{model:function(){return"Seller"}},templateUrl:function(){return"manager/views/partials/seller.edit.html"},controller:"listEditCtrl"}).state("frame.Helper",{url:"/helper",resolve:{model:function(){return"Helper"},data:function(){return{head:"Подсказки и помощь",action:"подсказку и помощь"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.Helper.edit",{url:"/:model/:id",resolve:{model:function(){return"Helper"}},templateUrl:function(){return"manager/views/partials/helper.edit.html"},controller:"listEditCtrl"}).state("frame.StuffGroups",{url:"/stuffGroups",resolve:{model:function(){return"StuffGroups"},data:function(){return{head:"Группы товаров",action:"группу"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.StuffGroups.edit",{url:"/:model/:id",resolve:{model:function(){return"StuffGroups"}},templateUrl:function(){return"manager/views/partials/stuffGroups.edit.html"},controller:"listEditCtrl"}).state("frame.Config",{url:"/сonfig",resolve:{model:function(){return"Config"},data:function(){return{head:"Основная конфигурация",action:"конфигурация"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.Config.edit",{url:"/:model/:id",resolve:{model:function(){return"Config"}},templateUrl:function(){return"manager/views/partials/mainConfig.edit.html"},controller:"listEditCtrl"}).state("frame.categorySeo",{url:"/categorySeo",resolve:{model:function(){return"Category"}},templateUrl:function(){return"manager/views/partials/pageSeo.html"},controller:"seoPageCtrl"}).state("frame.size",{url:"/size",templateUrl:function(){return"manager/views/partials/size.html"},controller:"sizeCtrl"}).state("frame.addCriterion",{url:"/addCriterion",resolve:{model:function(){return"AddCriterion"},data:function(){return{head:"Дополнительные параметры",action:"доп.параметр"}}},templateUrl:function(){return"manager/views/partials/list.html"},controller:"listCtrl"}).state("frame.addCriterion.edit",{url:"/:id",resolve:{model:function(){return"AddCriterion"}},templateUrl:function(){return"manager/views/partials/addCriterion.edit.html"},controller:"listEditCtrl"}).state("frame.stuffSeo",{url:"/stuffSeo",templateUrl:function(){return"manager/views/partials/stuffSeo.html"},controller:"stuffCtrl"}).state("frame.stuffSeo.edit",{url:"/detail/:id",templateUrl:function(){return"manager/views/partials/stuffSeo.edit.html"},controller:"stuffEditCtrl"}).state("frame.stuff.gallery",{url:"/gallery/:id",templateUrl:function(){return"manager/views/partials/stuff.gallery.html"},controller:"stuffGalleryCtrl"}).state("frame.campaign",{url:"/campaign",templateUrl:function(){return"manager/views/partials/campaign_new.html"},controller:"campaignCtrl"}).state("frame.discount",{url:"/discount",templateUrl:function(){return"manager/views/partials/discount.html"},controller:"discountCtrl"}).state("frame.configEdit",{url:"/configEdit",templateUrl:function(){return"manager/views/partials/config.edit.html"},controller:"configEditCtrl"}).state("frame.users",{url:"/users",templateUrl:function(){return"manager/views/partials/users.html"},controller:"usersCtrl"}).state("frame.orders",{url:"/orders",templateUrl:function(){return"manager/views/partials/orders.new.html"},controller:"ordersCtrl"}).state("frame.orders.detail",{url:"/:id",templateUrl:function(){return"manager/views/partials/order.detail.html"},controller:"orders.detailCtrl"}).state("frame.partner",{url:"/partner",templateUrl:function(){return"manager/views/partials/partner.html"},controller:"partnerCtrl"}).state("frame.page",{url:"/page/:type",templateUrl:function($stateParams){return"News"==$stateParams.type?"manager/views/partials/news.html":"manager/views/partials/page.html"},resolve:{type:function($stateParams){return $stateParams.type}},controller:"pageCtrl"}).state("frame.pageSeo",{url:"/pageSeo/:type",templateUrl:function($stateParams){return $stateParams.type,"manager/views/partials/pageSeo.html"},resolve:{type:function($stateParams){return $stateParams.type}},controller:"pageCtrl"}).state("frame.page.gallery",{url:"/gallery/:id",templateUrl:function(){return"manager/views/partials/page.gallery.html"},controller:"pageGalleryCtrl"}).state("frame.witget",{url:"/witget",templateUrl:function(){return"manager/views/partials/witget.html"},controller:"witgetCtrl"}).state("frame.coupon",{url:"/coupon",templateUrl:function(){return"manager/views/partials/coupon.html"},controller:"couponCtrl"}).state("frame.prom",{url:"/prom",template:"<h1>Пром</h1><div ng-show='done'>Готово!</div>",controller:"promCtrl"}).state("frame.promUpdate",{url:"/promUpdate",template:"<h1>Пром апдэйт</h1><div ng-show='done'>Готово!</div>",controller:"promUpdateCtrl"}).state("frame.siteMAP",{url:"/sitemap",template:"<h1>siteMAP</h1><div ng-show='done'>Готово!</div>",controller:"siteMapCtrl"}).state("frame.siteMAP1",{url:"/sitemap1",template:"<h1>Дополнительно</h1><div ng-show='done'>Готово!</div>",controller:"siteMap1Ctrl"}).state("frame.seopage",{url:"/seopage",resolve:{model:function(){return"Seopage"}},templateUrl:function(){return"manager/views/partials/seopage.html"},controller:"seopageCtrl"}).state("frame.seopageTemplate",{url:"/seopageTemplate",resolve:{model:function(){return"SeopageTemplate"}},templateUrl:function(){return"manager/views/partials/seopageTemplate.html"},controller:"commonCtrl"}).state("frame.editComments",{url:"/editComments",templateUrl:function(){return"manager/views/partials/comments.html"},controller:"editCommentsCtrl"}).state("frame.wl",{url:"/wl",templateUrl:function(){return"manager/views/partials/wl.html"},controller:"wlCtrl"}).state("frame.invoice",{url:"/invoice",templateUrl:function(){return"manager/views/partials/invoice.html"},controller:"invoiceCtrl"}).state("frame.correctPrice",{url:"/correctPrice",templateUrl:function(){return"manager/views/partials/correct.pric.html"},controller:"correctPriceCtrl"}).state("frame.subscribe",{url:"/subscribe",templateUrl:function(){return"manager/views/partials/subscribe.html"},controller:"subscribeCtrl"}).state("frame.subscribeFromFile",{url:"/subscribeFromFile",templateUrl:function(){return"manager/views/partials/subscribeFromFile.html"},controller:"subscribeFromFileCtrl"}).state("frame.landing",{url:"/landing",templateUrl:function(){return"manager/views/partials/landing.html"},controller:"landingCtrl"}).state("frame.section",{url:"/sections",templateUrl:function(){return"manager/views/partials/sections.html"},controller:"sectionsCtrl"}).state("frame.article",{url:"/artiles",templateUrl:function($stateParams){return"manager/views/partials/articles.html"},controller:"articlesCtrl"}).state("frame.articleSeo",{url:"/articleSeo",resolve:{model:function(){return"Article"}},templateUrl:function(){return"manager/views/partials/pageSeo.html"},controller:"seoPageCtrl"}).state("frame.article.gallery",{url:"/gallery/:id",templateUrl:function(){return"manager/views/partials/page.gallery.html"},controller:"articleGalleryCtrl"}).state("frame.stuff",{url:"/:groupUrl/:categoryUrl?parentGroup&searchStr&queryTag&brand&brandTag&msg",reloadOnSearch:!1,templateUrl:function(){return"manager/views/partials/stuff.html"},controller:"stuffCtrl"}).state("frame.stuff.edit",{url:"/:stuffUrl?clone",templateUrl:function(){return"manager/views/partials/stuff.edit.html"},controller:"stuffEditCtrl"})}]);angular.module("checklist-model",[]).directive("checklistModel",["$parse","$compile",function($parse,$compile){function contains(arr,item){if(angular.isArray(arr))for(var i=0;i<arr.length;i++)if(angular.equals(arr[i],item))return!0;return!1}function add(arr,item){arr=angular.isArray(arr)?arr:[];for(var i=0;i<arr.length;i++)if(angular.equals(arr[i],item))return arr;return arr.push(item),arr}function remove(arr,item){if(angular.isArray(arr))for(var i=0;i<arr.length;i++)if(angular.equals(arr[i],item)){arr.splice(i,1);break}return arr}function postLinkFn(scope,elem,attrs){$compile(elem)(scope);var getter=$parse(attrs.checklistModel),setter=getter.assign,value=$parse(attrs.checklistValue)(scope.$parent);scope.$watch("checked",function(newValue,oldValue){if(newValue!==oldValue){var current=getter(scope.$parent);newValue===!0?setter(scope.$parent,add(current,value)):setter(scope.$parent,remove(current,value))}}),scope.$parent.$watch(attrs.checklistModel,function(newArr,oldArr){scope.checked=contains(newArr,value)},!0)}return{restrict:"A",priority:1e3,terminal:!0,scope:!0,compile:function(tElement,tAttrs){if("INPUT"!==tElement[0].tagName||!tElement.attr("type","checkbox"))throw'checklist-model should be applied to `input[type="checkbox"]`.';if(!tAttrs.checklistValue)throw"You should provide `checklist-value`.";return tElement.removeAttr("checklist-model"),tElement.attr("ng-model","checked"),postLinkFn}}}]),angular.module("ngAutocomplete",[]).directive("ngAutocomplete",function($parse,$timeout){return{require:"ngModel",scope:{ngModel:"=",options:"=?",details:"=?",fromList:"=",cityId:"=",countryId:"="},link:function(scope,element,attrs,model){$timeout(function(){element[0].value=scope.ngModel});var opts,initOpts=function(){opts={},scope.options&&(scope.options.types&&(opts.types=[],opts.types.push(scope.options.types)),scope.options.bounds&&(opts.bounds=scope.options.bounds),scope.options.country&&(opts.componentRestrictions={country:scope.options.country}))};initOpts(),element.bind("blur",function(){$timeout(function(){scope.cityId=""})});var newAutocomplete=function(){scope.gPlace=new google.maps.places.Autocomplete(element[0],scope.options),google.maps.event.addListener(scope.gPlace,"place_changed",function(){scope.$apply(function(){if(scope.details=scope.gPlace.getPlace(),scope.details.address_components&&scope.details.address_components.length)for(var i=0,l=scope.details.address_components.length;i<l;i++){var c=scope.details.address_components[i];c.types&&c.types[0]&&"country"==c.types[0]&&(console.log(scope.details.address_components[i].short_name),scope.countryId=scope.details.address_components[i].short_name)}scope.details&&scope.details.types&&"locality"==scope.details.types[0]&&$timeout(function(){scope.ngModel=scope.ngAutocomplete=element.val(),scope.cityId=scope.details.place_id},100)})})};newAutocomplete(),scope.watchOptions=function(){return scope.options},scope.$watch(scope.watchOptions,function(){initOpts(),newAutocomplete(),element[0].value="",scope.ngAutocomplete=element.val()},!0)}}}),angular.module("btford.socket-io",[]).provider("socketFactory",function(){this.$get=function($rootScope,$timeout){var asyncAngularify=function(socket,callback){return callback?function(){var args=arguments;$timeout(function(){callback.apply(socket,args)},0)}:angular.noop};return function(options){options=options||{};var socket=options.ioSocket||io.connect(),prefix=options.prefix||"socket:",defaultScope=options.scope||$rootScope,addListener=function(eventName,callback){socket.on(eventName,asyncAngularify(socket,callback))};return{on:addListener,addListener:addListener,socket:socket,emit:function(eventName,data,callback){return socket.emit(eventName,data,asyncAngularify(socket,callback))},removeListener:function(){return socket.removeListener.apply(socket,arguments)},forward:function(events,scope){events instanceof Array==!1&&(events=[events]),scope||(scope=defaultScope),events.forEach(function(eventName){var prefixedEvent=prefix+eventName,forwardBroadcast=asyncAngularify(socket,function(data){scope.$broadcast(prefixedEvent,data)});scope.$on("$destroy",function(){socket.removeListener(eventName,forwardBroadcast)}),socket.on(eventName,forwardBroadcast)})}}}}}),angular.module("JSONedit111",["ui.sortable"]).directive("ngModelOnblur",function(){return{restrict:"A",require:"ngModel",priority:1,link:function(scope,elm,attr,ngModelCtrl){"radio"!==attr.type&&"checkbox"!==attr.type&&(elm.unbind("input").unbind("keydown").unbind("change"),elm.bind("blur change",function(){scope.$apply(function(){ngModelCtrl.$setViewValue(elm.val()),ngModelCtrl.$render()})}))}}}).directive("json",function($compile){return{restrict:"E",scope:{child:"=",type:"@",defaultCollapsed:"="},link:function(scope,element,attributes){scope.valueTypes=["Text","Object","Array","Reference"],scope.sortableOptions={axis:"y"},void 0===scope.$parent.defaultCollapsed?scope.collapsed=!1:scope.collapsed=scope.defaultCollapsed,scope.collapsed?scope.chevron="glyphicon-chevron-right":scope.chevron="glyphicon-chevron-down";var getType=function(obj){var type=Object.prototype.toString.call(obj);return"[object Object]"===type?"Object":"[object Array]"===type?"Array":"Literal"},isNumber=function(n){return!isNaN(parseFloat(n))&&isFinite(n)};scope.getType=function(obj){return getType(obj)},scope.toggleCollapse=function(){scope.collapsed?(scope.collapsed=!1,scope.chevron="glyphicon-chevron-down"):(scope.collapsed=!0,scope.chevron="glyphicon-chevron-right")},scope.moveKey=function(obj,key,newkey){key!==newkey&&(obj[newkey]=obj[key],delete obj[key])},scope.deleteKey=function(obj,key){"Object"==getType(obj)?confirm('Delete "'+key+'" and all it contains?')&&delete obj[key]:"Array"==getType(obj)?confirm('Delete "'+obj[key]+'"?')&&obj.splice(key,1):console.error("object to delete from was "+obj)},scope.addItem=function(obj){if("Object"==getType(obj))if(void 0==scope.keyName||0==scope.keyName.length)alert("Please fill in a name");else if(0==scope.keyName.indexOf("$"))alert("The name may not start with $ (the dollar sign)");else if(0==scope.keyName.indexOf("_"))alert("The name may not start with _ (the underscore)");else{if(obj[scope.keyName]&&!confirm('An item with the name "'+scope.keyName+'" exists already. Do you really want to replace it?'))return;switch(scope.valueType){case"Text":obj[scope.keyName]=scope.valueName?scope.possibleNumber(scope.valueName):"";break;case"Object":obj[scope.keyName]={};break;case"Array":obj[scope.keyName]=[];break;case"Reference":obj[scope.keyName]={"Reference!!!!":"todo"}}scope.keyName="",scope.valueName="",scope.showAddKey=!1}else if("Array"==getType(obj)){switch(scope.valueType){case"Text":obj.push(scope.valueName?scope.valueName:"");break;case"Object":obj.push({});break;case"Array":obj.push([]);break;case"Reference":obj.push({"Reference!!!!":"todo"})}scope.valueName="",scope.showAddKey=!1}else console.error("object to add to was "+obj)},scope.possibleNumber=function(val){return isNumber(val)?parseFloat(val):val};var switchTemplate='<span ng-switch on="getType(val)" ><json ng-switch-when="Object" child="val" type="object" default-collapsed="defaultCollapsed"></json><json ng-switch-when="Array" child="val" type="array" default-collapsed="defaultCollapsed"></json><span ng-switch-default class="jsonLiteral"><input type="text" ng-model="child[$index]" placeholder="Empty" ng-model-onblur ng-change="child[key] = possibleNumber(val)"/></span></span>',addItemTemplate='<div ng-switch on="showAddKey" class="block" ><span ng-switch-when="true">';if("object"==scope.type&&(addItemTemplate+='<input placeholder="Name" type="text" ui-keyup="{\'enter\':\'addItem(child)\'}" class="form-control input-sm addItemKeyInput" ng-model="$parent.keyName" /> '),addItemTemplate+='<select ng-model="$parent.valueType" ng-options="option for option in valueTypes" class="form-control input-sm"ng-init="$parent.valueType=\'Text\'" ui-keydown="{\'enter\':\'addItem(child)\'}"></select><span ng-show="$parent.valueType == \'Text\'"> : <input type="text" placeholder="Value" class="form-control input-sm addItemValueInput" ng-model="$parent.valueName" ui-keyup="{\'enter\':\'addItem(child)\'}"/></span> <button class="btn btn-primary btn-sm" ng-click="addItem(child)">Add</button> <button class="btn btn-default btn-sm" ng-click="$parent.showAddKey=false">Cancel</button></span><span ng-switch-default><button class="addObjectItemBtn" ng-click="$parent.showAddKey = true"><i class="glyphicon glyphicon-plus"></i></button></span></div>',"object"==scope.type)var template='<i ng-click="toggleCollapse()" class="glyphicon" ng-class="chevron"></i><span class="jsonItemDesc">Object</span><div class="jsonContents" ng-hide="collapsed"><span class="block" ng-hide="key.indexOf(\'_\') == 0" ng-repeat="(key, val) in child"><span class="jsonObjectKey"><input class="keyinput" type="text" ng-model="newkey" ng-init="newkey=key" ng-blur="moveKey(child, key, newkey)"/><i class="deleteKeyBtn glyphicon glyphicon-trash" ng-click="deleteKey(child, key)"></i></span><span class="jsonObjectValue">'+switchTemplate+"</span></span>"+addItemTemplate+"</div>";else if("array"==scope.type)var template='<i ng-click="toggleCollapse()" class="glyphicon"ng-class="chevron"></i><span class="jsonItemDesc">Array</span><div class="jsonContents" ng-hide="collapsed"><ol class="arrayOl" ui-sortable="sortableOptions" ng-model="child"><li class="arrayItem" ng-repeat="val in child"><i class="deleteKeyBtn glyphicon glyphicon-trash" ng-click="deleteKey(child, $index)"></i><i class="moveArrayItemBtn glyphicon glyphicon-align-justify"></i><span>'+switchTemplate+"</span></li></ol>"+addItemTemplate+"</div>";else console.error("scope.type was "+scope.type);var newElement=angular.element(template);$compile(newElement)(scope),element.empty().html(newElement)}}}),angular.module("i.mongoPaginate",[]).filter("forLoop",function(){return function(input,start,end){if(!end)return[];input=new Array(end-start);for(var i=0;start<end;start++,i++)input[i]=start;return input}}).directive("paginator",function(anchorSmoothScroll){return{restrict:"E",scope:{page:"=",rows:"=",items:"=",getlist:"&"},link:function(scope,element,attrs,controller){function getList(){anchorSmoothScroll.scrollTo("topPage"),scope.getlist({page:scope.page,rows:scope.paginator.rows})}scope.paginator={},scope.paginator.rows=parseInt(scope.rows),scope.paginator.items=0,scope.$watch("items",function(n,o){n&&(scope.paginator.items=Number(n))}),scope.paginator.setPage=function(page){page>scope.paginator.pageCount()||page==scope.page||(scope.page=page,getList())},scope.paginator.nextPage=function(){scope.paginator.isLastPage()||(scope.page++,getList())},scope.paginator.perviousPage=function(){scope.paginator.isFirstPage()||(scope.page--,getList())},scope.paginator.firstPage=function(){scope.page=0,getList()},scope.paginator.lastPage=function(){scope.page=scope.paginator.pageCount()-1,getList()},scope.paginator.isFirstPage=function(){return 0==scope.page},scope.paginator.isLastPage=function(){return scope.page==scope.paginator.pageCount()-1},scope.paginator.pageCount=function(){var count=Math.ceil(parseInt(scope.paginator.items,10)/parseInt(scope.paginator.rows,10));return 1===count&&(scope.page=0),count},scope.changeRow=function(rows){for(scope.paginator.rows=rows;scope.paginator.pageCount()<scope.page-1;)scope.page--;getList()}},templateUrl:"manager/views/templates/paginator.html"}}).directive("mongoPaginatorAll",function(){return{restrict:"E",scope:{page:"=",row:"=",rowsPerPage:"@",totalItems:"="},link:function(scope,element,attrs,controller){scope.paginator={},scope.paginator.page=0,scope.paginator.itemCount=0,scope.paginator.rowsPerPage=scope.rowsPerPage,scope.row=scope.rowsPerPage,scope.paginator.setPage=function(page){page>scope.paginator.pageCount()||(scope.paginator.page=page)},scope.paginator.nextPage=function(){scope.paginator.isLastPage()||scope.paginator.page++},scope.paginator.perviousPage=function(){scope.paginator.isFirstPage()||scope.paginator.page--},scope.paginator.firstPage=function(){scope.paginator.page=0},scope.paginator.lastPage=function(){scope.paginator.page=scope.paginator.pageCount()-1},scope.paginator.isFirstPage=function(){return 0==scope.paginator.page},scope.paginator.isLastPage=function(){return scope.paginator.page==scope.paginator.pageCount()-1},scope.paginator.pageCount=function(){var count=Math.ceil(parseInt(scope.paginator.itemCount,10)/parseInt(scope.paginator.rowsPerPage,10));return 1===count&&(scope.paginator.page=0),count},scope.$watch("totalItems",function(n,o){scope.paginator.itemCount=scope.totalItems}),scope.$watch("paginator.page",function(n,o){scope.page=scope.paginator.page}),scope.changeRow=function(row){scope.row=row,scope.paginator.rowsPerPage=row,console.log(scope.row)}},templateUrl:"manager/views/templates/mongoPaginationControlAll.html"}}).directive("mongoPaginatorAllNew",function($timeout){return{restrict:"E",scope:{page:"=",row:"=",rowsPerPage:"@",totalItems:"=",getStuff:"&",hideRow:"@"},link:function(scope,element,attrs,controller){scope.paginator={},scope.page,scope.row=scope.rowsPerPage,scope.paginator.itemCount=scope.totalItems,scope.paginator.setPage=function(page){page>scope.paginator.pageCount()||(scope.page=page,$timeout(function(){scope.getStuff()},100))},scope.changeRow=function(row){scope.row=row,row>0&&(scope.page?scope.paginator.setPage(0):$timeout(function(){scope.getStuff()},100))},scope.paginator.nextPage=function(){scope.paginator.isLastPage()||(scope.page++,$timeout(function(){scope.getStuff()},100))},scope.paginator.perviousPage=function(){scope.paginator.isFirstPage()||(scope.page--,$timeout(function(){scope.getStuff()},100))},scope.paginator.firstPage=function(){scope.page=0,$timeout(function(){console.log("sd"),scope.getStuff()},100)},scope.paginator.lastPage=function(){scope.page=scope.paginator.pageCount()-1,$timeout(function(){scope.getStuff()},100)},scope.paginator.isFirstPage=function(){return 0==scope.page},scope.paginator.isLastPage=function(){return scope.page==scope.paginator.pageCount()-1},scope.paginator.pageCount=function(){var count=Math.ceil(parseInt(scope.paginator.itemCount,10)/parseInt(scope.row,10));return 1===count&&(scope.page=0),count},scope.$watch("totalItems",function(n,o){scope.paginator.itemCount=scope.totalItems})},templateUrl:"manager/views/templates/mongoPaginationControlAll.html"}}),angular.module("ngAutocomplete",[]).directive("ngAutocomplete1",function($parse,$timeout){return{require:"ngModel",scope:{ngModel:"=",options:"=?",details:"=?",fromList:"=",cityId:"=",countryId:"="},link:function(scope,element,attrs,model){$timeout(function(){scope.ngModel&&(element[0].value=scope.ngModel)});var opts,initOpts=function(){opts={},scope.options&&(scope.options.types&&(opts.types=[],opts.types.push(scope.options.types)),scope.options.bounds&&(opts.bounds=scope.options.bounds),scope.options.country&&(opts.componentRestrictions={country:scope.options.country}))};initOpts(),element.bind("blur",function(){$timeout(function(){scope.cityId=""})});var newAutocomplete=function(){var options={types:["(cities)"]};scope.gPlace=new google.maps.places.Autocomplete(element[0],options),
google.maps.event.addListener(scope.gPlace,"place_changed",function(){scope.$apply(function(){if(scope.details=scope.gPlace.getPlace(),console.log(scope.details),scope.details.address_components&&scope.details.address_components.length)for(var i=0,l=scope.details.address_components.length;i<l;i++){var c=scope.details.address_components[i];c.types&&c.types[0]&&"country"==c.types[0]&&(console.log(scope.details.address_components[i].short_name),scope.countryId=scope.details.address_components[i].short_name)}scope.details&&scope.details.types&&"locality"==scope.details.types[0]&&$timeout(function(){scope.ngModel=scope.ngAutocomplete=element.val(),scope.cityId=scope.details.place_id},100)})})};newAutocomplete(),scope.watchOptions=function(){return scope.options},scope.$watch(scope.watchOptions,function(){initOpts(),newAutocomplete(),element[0].value="",scope.ngAutocomplete=element.val()},!0)}}}),angular.module("gmall.services",[]).factory("User",function($resource){return $resource("/api/users/:id",{id:"@_id"},{update:{method:"PUT",params:{id:"profile",email:""}},get:{method:"GET",params:{id:"me"}},list:{method:"GET",isArray:!0,params:{id:""}},delete:{method:"DELETE",params:{id:"@_id"}}})}).service("$fileUpload",["$http",function($http){this.uploadFileToUrl=function(file,uploadUrl,id,params){var fd=new FormData;if(fd.append("file",file),fd.append("id",id),params&&"object"==typeof params)for(var key in params)fd.append(key,params[key]);return $http.post(uploadUrl,fd,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}}]).factory("Orders",["$resource",function($resource){return $resource("/api/order/:id",{},{list:{method:"GET",isArray:!0,params:{id:""}},add:{method:"POST",params:{id:""}},update:{method:"PUT",params:{id:""}},delete:{method:"DELETE",params:{id:"@_id"}},get:{method:"GET",params:{id:"@_id"}}})}]).factory("OrdersNew",["$resource",function($resource){return $resource("/api/collections/Order/:id",{},{list:{method:"GET",isArray:!0,params:{id:""}},add:{method:"POST",params:{id:""}},update:{method:"PUT",params:{id:""}},delete:{method:"DELETE",params:{id:"@_id"}},get:{method:"GET",params:{id:"@_id"}}})}]).factory("genericPrice12",function(global){function _getPriceCoupon(){var use=!1,price=_stuff.price;return _coupon.val&&(_coupon.val.group?1==_coupon.val.group?_stuff.tags.indexOf(_coupon.val.tag)>-1&&(use=!0):2==_coupon.val.group?_coupon.val.stuffs.some(function(el){return el.stuff==_stuff.stuff&&el.size==_stuff.size})&&(use=!0):3==_coupon.val.group&&_coupon.val.tag==_stuff.brand&&(use=!0):use=!0),use&&(price=function(p,s,v){var sum=0;return p&&(sum=v-v/100*p),s&&(sum=v-s),sum}(_coupon.val.per,_coupon.val.sum,price)),price}function _getCascadePrice(){if(_stuff.priceSale)return _stuff.priceSale;for(var cascade,i=0,l=global.get("discounts").val.length;i<l;i++)if(global.get("discounts").val[i].brand==_stuff.brand){cascade=global.get("discounts").val[i].cascade;break}if(cascade){for(var newPrice=_stuff.price,i=0,l=cascade.length;i<l;i++)_totalCountForBrand>=cascade[i][0]&&(newPrice=_stuff.price-_stuff.price*cascade[i][1]/100);if(newPrice!=_stuff.price)return newPrice}return newPrice==_stuff.price?_getPriceCoupon():newPrice}function _cartCountForBrand(brand){var i=0;return _inCartItems.forEach(function(item){item.brand==brand&&item.quantity&&(i+=Number(item.quantity))}),i}function _cartCount(){var i=0;return _inCartItems.forEach(function(item){item.quantity&&(i+=Number(item.quantity))}),i}var _totalCount,_brandOpt,_partners,_totalCountForBrand,_stuff,_inCartItems,_coupon,_opt=global.get("config").val.opt;return{getPrice:function(stuff,where,inCartItems,coupon){_stuff=stuff,_inCartItems=inCartItems,_totalCount=_cartCount(),_totalCountForBrand=_cartCountForBrand(_stuff.brand),"cart"==where?_coupon={}:"order"==where&&(_coupon=coupon);for(var i=0,l=global.get("brands").val.length;i<l;i++)if(global.get("brands").val[i]._id==_stuff.brand){_brandOpt=global.get("brands").val[i].opt,_partners=global.get("brands").val[i].partner,_partners&&"none"!=_partners&&(_partners=globalFunction.getObjectFromArray(global.get("partners").val,"_id",_partners));break}if(_partners){if("none"==_partners)return _totalCountForBrand>=_brandOpt?_getCascadePrice():stuff.retail;if(_totalCountForBrand>=_brandOpt)return _getCascadePrice();for(var isOpt=!1,i=0,l=_partners.brands.length;i<l;i++){var p=_partners.brands[i];for(var key in p)_cartCountForBrand(key)>=p[key]&&(isOpt=!0);if(isOpt)break}return isOpt?_getCascadePrice():stuff.retail}return _totalCount>=_opt?_getCascadePrice():stuff.retail},getTotalSum:function(items){var sum=0;return items.forEach(function(c){sum+=c.sum}),sum},getTotalQuantity:function(items){var q=0;return items.forEach(function(c){q+=c.quantity}),q},getItemsForOrder:function(order){var arr=[];return order.cartInner.forEach(function(el){el.cart&&el.cart.cart&&el.cart.cart.length&&el.cart.cart.forEach(function(item){arr.push(item)})}),arr}}}).factory("priceFactory",function(global){function _isStuffInCampaign(stuff,campaign){if(!_campaign||!_campaign.length)return!1;if(campaign){for(var __campaign=globalFunction.getObjectFromArray(_campaign,"_id",campaign),i=0,l=__campaign.stuffs.length;i<l;i++)if(__campaign.stuffs[i].stuff==stuff.stuff)return stuff.sticker=__campaign.sticker,__campaign._id}else for(var j=0,ll=_campaign.length;j<ll;j++)for(var i=0,l=_campaign[j].stuffs.length;i<l;i++)if(_campaign[j].stuffs[i].stuff==stuff.stuff)return stuff.campaign=!0,_campaign[j]._id;return!1}function _cartCount(campaign){var i=0;return _inCartItems.forEach(function(item){campaign?"withoutcampaign"==campaign?_isStuffInCampaign(item)||(i+=Number(item.quantity)):_isStuffInCampaign(item,campaign)&&(i+=Number(item.quantity)):item.quantity&&(i+=Number(item.quantity))}),i}function _getCountForBaseStuffs(campaign){var sum=0;return _inCartItems.forEach(function(item){for(var i=0,l=campaign.baseStuffs.length;i<l;i++)if(campaign.baseStuffs[i].stuff==item.stuff){sum+=Number(item.quantity);break}}),sum}function _getConditionForCampaignPrice(id){if(!_campaign||!_campaign.length)return 2;var c,__campaign=globalFunction.getObjectFromArray(_campaign,"_id",id);c=__campaign.forAll?_getCountForBaseStuffs(__campaign):_cartCount("withoutcampaign");var cc=_cartCount(id);return __campaign.condition>c&&cc>0?{condition:!1,name:__campaign.name}:__campaign.condition<=c&&parseInt(c/__campaign.ratio)<cc?{condition:__campaign.ratio*cc,name:__campaign.name}:{condition:!0,name:__campaign.name}}function _getCampagnDiscount(id){for(var j=0,ll=_campaign.length;j<ll;j++)if(_campaign[j]._id==id)return _campaign[j].discount}function _cartCount(campaign){var i=0;return _inCartItems.forEach(function(item){campaign?"withoutcampaign"==campaign?_isStuffInCampaign(item)||(i+=Number(item.quantity)):_isStuffInCampaign(item,campaign)&&(i+=Number(item.quantity)):item.quantity&&(i+=Number(item.quantity))}),i}function _checkDiscount(){var dis=_discount;if(dis){if(1==dis.type)return _price;if(2==dis.type)return _priceSale?_priceSale:_price;if(3==dis.type)return Math.ceil10(_price-_price/100*dis.value,-5);if(4==dis.type)return _priceSale?_priceSale:Math.ceil10(_price-_price/100*dis.value,-5);if(5==dis.type){var cena;return cena=_priceSale?_priceSale:_price,Math.ceil10(cena-cena/100*dis.value,-5)}}}function _getCascadePrice(){var newPrice=_price,cascade=_cascade;if(cascade&&cascade.length){for(var i=0,l=cascade.length;i<l;i++)_totalCount>=cascade[i][0]&&(newPrice=Math.ceil10(_price-_price/100*cascade[i][1],-2));return newPrice}return _price}var _inCartItems,_totalCount,_sum,_campaign,_idCampaign,_price,_priceSale,_retail,_coupon,_opt,_cascade,_currency,_discount;return{init:function(what,order){"order"==what&&(_inCartItems=order.cart.stuffs?order.cart.stuffs:order.cart,_coupon=order.coupon,_campaign=order.campaigns?order.campaigns:order.campaign,_opt=order.opt,_cascade=order.cascade?order.cascade:[],_currency=order.currencyStore,_discount=order.discount)},getPrice:function(stuff){if(_totalCount=_cartCount(),_price=stuff.price,_priceSale=stuff.priceSale,_retail=stuff.retail,stuff.currency!=global.get("store").val.mainCurrency&&(_price=Math.ceil10(Number(stuff.price)/Number(_currency[stuff.currency][0]),-5),_priceSale=Math.ceil10(Number(stuff.priceSale)/Number(_currency[stuff.currency][0]),-5),_retail=Math.ceil10(Number(stuff.retail)/Number(_currency[stuff.currency][0]),-5)),(_idCampaign=_isStuffInCampaign(stuff))&&_getConditionForCampaignPrice(_idCampaign).condition===!0)return Math.ceil10(Number(stuff.price)-_getCampagnDiscount(_idCampaign)/100*Number(stuff.price),-2);var cena;return(cena=_checkDiscount())?cena:_opt&&_opt.quantity&&_totalCount<_opt.quantity?_retail||_price:stuff.priceSale?_priceSale:_getCascadePrice()},getTotalSum:function(){_sum=0,_inCartItems.forEach(function(c){_sum+=c.sum});var dis=_discount;return dis&&(6==dis.type?_sum=Math.ceil10(_sum-_sum/100*dis.value,-5):7==dis.type&&(_sum-=dis.value)),_sum},getTotalQuantity:function(){var q=0;return _inCartItems.forEach(function(c){q+=c.quantity}),q},getCampaignQuantity:function(){return _cartCount("campaign")},getConditionForDisplayMsg:function(){return _getConditionForCampaignPrice()},getCouponSum:function(coupon){if(coupon){if(coupon.per)return Math.ceil10(_sum-_sum/100*Number(coupon.per),-5);if(coupon.sum){return _sum-Number(coupon.sum)}return _sum}return _sum}}}).factory("genericPrice",function(global){return function(what,order){function _isStuffInCampaign(stuff,campaign){if(!_campaign||!_campaign.length)return!1;if(campaign){for(var __campaign=globalFunction.getObjectFromArray(_campaign,"_id",campaign),i=0,l=__campaign.stuffs.length;i<l;i++)if(__campaign.stuffs[i].stuff==stuff.stuff)return stuff.sticker=__campaign.sticker,__campaign._id}else for(var j=0,ll=_campaign.length;j<ll;j++)for(var i=0,l=_campaign[j].stuffs.length;i<l;i++)if(_campaign[j].stuffs[i].stuff==stuff.stuff)return stuff.campaign=!0,_campaign[j]._id;return!1}function _cartCount(campaign){var i=0;return _inCartItems.forEach(function(item){campaign?"withoutcampaign"==campaign?_isStuffInCampaign(item)||(i+=Number(item.quantity)):_isStuffInCampaign(item,campaign)&&(i+=Number(item.quantity)):item.quantity&&(i+=Number(item.quantity))}),i}function _getCountForBaseStuffs(campaign){var sum=0;return _inCartItems.forEach(function(item){for(var i=0,l=campaign.baseStuffs.length;i<l;i++)if(campaign.baseStuffs[i].stuff==item.stuff){sum+=Number(item.quantity);break}}),sum}function _getConditionForCampaignPrice(id){if(!_campaign||!_campaign.length)return 2;var c,__campaign=globalFunction.getObjectFromArray(_campaign,"_id",id);c=__campaign.forAll?_getCountForBaseStuffs(__campaign):_cartCount("withoutcampaign");var cc=_cartCount(id);return __campaign.condition>c&&cc>0?{condition:!1,name:__campaign.name}:__campaign.condition<=c&&parseInt(c/__campaign.ratio)<cc?{condition:__campaign.ratio*cc,name:__campaign.name}:{condition:!0,name:__campaign.name}}function _getCampagnDiscount(id){for(var j=0,ll=_campaign.length;j<ll;j++)if(_campaign[j]._id==id)return _campaign[j].discount}function _checkDiscount(){var dis=_order.discount;if(dis){if(1==dis.type)return _price;if(2==dis.type)return _priceSale?_priceSale:_price;if(3==dis.type)return Math.ceil10(_price-_price/100*dis.value,-5);if(4==dis.type)return _priceSale?_priceSale:Math.ceil10(_price-_price/100*dis.value,-5);if(5==dis.type){var cena;return cena=_stuff.priceSale?_priceSale:_price,Math.ceil10(cena-cena/100*dis.value,-5)}}}function _getCascadePrice(){var newPrice=_price,cascade=_cascade;if(cascade&&cascade.length){for(var i=0,l=cascade.length;i<l;i++)_totalCount>=cascade[i][0]&&(newPrice=Math.ceil10(_price-_price/100*cascade[i][1],-2));return newPrice}return _price}var _opt,_totalCount,_campaign,_idCampaign,_stuff,_inCartItems,_coupon,_price,_priceSale,_retail,_cascade,_brands={},_order=order;return function(what,order){if(_order=order,"order"==what){var arr=[];order.cartInner.forEach(function(el){el.cart&&el.cart.cart&&el.cart.cart.length&&el.cart.cart.forEach(function(item){arr.push(item)})}),_inCartItems=arr,_coupon={val:order.coupon},_campaign=order.campaigns?order.campaigns:order.campaign,_opt=order.opt}if("orderNew"==what){var arr=[];_inCartItems=order.cart.stuffs,_coupon={val:order.coupon},_campaign=order.campaigns?order.campaigns:order.campaign,_opt=order.opt,_cascade=_order.cascade?_order.cascade:[]}else if("cart"==what){_inCartItems=order,_coupon=global.get("coupon"),_campaign=global.get("campaign").val,_opt=global.get("config").val.opt;for(var i=0,l=global.get("brands").val.length;i<l;i++){var item=global.get("brands").val[i];_brands[item._id]={opt:item.opt,partner:item.partner},_brands[item._id].partner&&"none"!=_brands[item._id].partner&&(_brands[item._id].partner=globalFunction.getObjectFromArray(global.get("partners").val,"_id",_brands[item._id].partner));for(var j=0,ll=global.get("discounts").val.length;j<ll;j++)if(global.get("discounts").val[j].brand==item._id){_brands[item._id].cascade=global.get("discounts").val[j].cascade?global.get("discounts").val[j].cascade:null;break}}}_totalCount=_cartCount()}(what,order),{getPrice:function(stuff){if(_stuff=stuff,_totalCount=_cartCount(),_price=_stuff.price,_priceSale=_stuff.priceSale,_retail=_stuff.retail,_stuff.currency!=global.get("store").val.mainCurrency&&(_price=Math.ceil10(Number(_stuff.price)/Number(order.currencyStore[_stuff.currency][0]),-5),_priceSale=Math.ceil10(Number(_stuff.priceSale)/Number(order.currencyStore[_stuff.currency][0]),-5),_retail=Math.ceil10(Number(_stuff.retail)/Number(order.currencyStore[_stuff.currency][0]),-5)),(_idCampaign=_isStuffInCampaign(_stuff))&&_getConditionForCampaignPrice(_idCampaign).condition===!0)return Math.ceil10(Number(_stuff.price)-_getCampagnDiscount(_idCampaign)/100*Number(_stuff.price),-2);var cena;return(cena=_checkDiscount())?cena:_totalCount<_order.opt.quantity?_retail||_price:stuff.priceSale?_priceSale:_getCascadePrice()},getTotalSum:function(){var sum=0;return _inCartItems.forEach(function(c){sum+=c.sum}),sum},getTotalQuantity:function(){var q=0;return _inCartItems.forEach(function(c){q+=c.quantity}),q},reFresh:function(cartInner){var arr=[];cartInner.forEach(function(el){el.cart&&el.cart.cart&&el.cart.cart.length&&el.cart.cart.forEach(function(item){arr.push(item)})}),_inCartItems=arr,cartInner.forEach(function(el){_brands[el.brand._id]={opt:el.cart.opt||5,partner:el.cart.partner||null,cascade:el.cart.cascade||null},_brands[el.brand._id].partner&&"none"!=_brands[el.brand._id].partner&&(_brands[el.brand._id].partner=JSON.parse(_brands[el.brand._id].partner))})},getCampaignQuantity:function(){return _cartCount("campaign")},getConditionForDisplayMsg:function(){return _getConditionForCampaignPrice()},getCoupunSum:function(){}}}}).service("anchorSmoothScroll",function(){this.scrollTo=function(eID){var startY=function(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}(),stopY=function(eID){var elm=document.getElementById(eID);if(!elm)return 0;for(var y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return y}(eID),distance=stopY>startY?stopY-startY:startY-stopY;if(distance<100)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(var i=startY;i<stopY;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(var i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,leapY<stopY&&(leapY=stopY),timer++}}),String.prototype.replaceBlanks=function(){if(this)return this.replace(/(["',.\/\s])/g,"-")},angular.module("gmall.controllers",[]).controller("mainFrameCtrl",["$scope","global",function($scope,global){$scope.mainFrameCtrl=this,$scope.mainFrameCtrl.groups=global.get("groups"),$scope.mainFrameCtrl.getDate=function(date){var d=new Date(date),curr_date=d.getDate(),curr_month=d.getMonth()+1;return d.getFullYear()+"-"+curr_month+"-"+curr_date},$scope.toMainSite=function(){window.location="/"},moment.locale("ru"),$scope.moment=moment;$scope.clearTag=function(name){if(name)return name.replace(/<\/?[^>]+(>|$)/g,"")};var getCategoryNameUrl=function(id){if(!id||"category"==id)return{name:"category",url:"id"};for(var i=0,l=global.get("categories").val.length;i<l;i++)if(global.get("categories").val[i]._id==id){var s=global.get("categories").val[i].name.replace(/(["'\/\s])/g,"-");return{name:s,url:global.get("categories").val[i].url,groupUrl:global.get("categories").val[i].group.url}}};$scope.mainFrameCtrl.getUrlParams=function(stuff){if(stuff){var category=stuff.category&&stuff.category._id?stuff.category._id:stuff.category,categoryNameUrl=(stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,getCategoryNameUrl(category)),categoryNameUrl=getCategoryNameUrl(category),url=stuff.url?stuff.url:stuff.stuffUrl,obj={groupUrl:categoryNameUrl.groupUrl,categoryName:categoryNameUrl.name.replaceBlanks(),categoryUrl:categoryNameUrl.url,stuffUrl:url};return stuff.addCriterionToCart&&stuff.addCriterionToCart.length&&(obj.param1=stuff.addCriterionToCart[0],2==stuff.addCriterionToCart.length&&(obj.param2=stuff.addCriterionToCart[1])),obj}}}]).controller("homeCtrl",["$scope","$resource",function($scope,$resource){var Item=$resource("/api/collections/Stuff/:id",{id:"@id"});$scope.go=function(){Item.query(function(res){$scope.list=res})},$scope.getItem=function(id){Item.get({id:id},function(res){$scope.item=res})}}]).controller("configEditCtrl",["$scope","$resource","$filter","$timeout",function($scope,$resource,$filter,$timeout){$scope.config={};var Config=$resource("/api/config");$scope.updateConfig=function(){console.log("dd!!"),$scope.disabledButton=!0,Config.save($scope.config.cfg,function(){console.log($scope.config.cfg),$scope.showMessage=!0,$timeout(function(){$scope.showMessage=!1,$scope.disabledButton=!1},3e3),Config.get({cache:"erase"},function(res){$scope.config.cfg=res})})},Config.get({cache:"erase"},function(res){$scope.config.cfg=res}),$scope.$watch("config",function(json){$scope.jsonString=$filter("json")(json)},!0),$scope.$watch("jsonString",function(json){try{$scope.config=JSON.parse(json),$scope.wellFormed=!0}catch(e){$scope.wellFormed=!1}},!0)}]).controller("seoPageCtrl",["$scope","$resource","$state","model",function($scope,$resource,$state,model){$scope.model=model;var Items=$resource("/api/collections/"+model+"/:id",{id:"@_id"});$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){item?Items.get({id:item._id},function(res){$scope.item=res}):$scope.item={},$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item={},$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save({update:"seo"},item,function(res){$scope.afterSave()})}}]).controller("commonCtrl",["$scope","$resource","$state","model",function($scope,$resource,$state,model){$scope.commonCtrl=this,$scope.model=model;var Items=$resource("/api/collections/"+model+"/:id",{id:"@_id"});$scope.paginate={page:0,rows:3,totalItems:0},$scope.editItem=function(item){item?Items.get({id:item._id},function(res){$scope.item=res}):$scope.item={},$scope.disEdit=!1},$scope.commonCtrl.getList=function(page,rows){Items.query({perPage:rows,page:page},function(res){0==page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item={},$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.commonCtrl.getList($scope.paginate.page,$scope.paginate.rows)})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.commonCtrl.getList($scope.paginate.page,$scope.paginate.rows)})},$scope.paginate.page=0,$scope.commonCtrl.getList($scope.paginate.page,$scope.paginate.rows)}]).controller("listCtrl",["$scope","$resource","$state","model","$rootScope","data",function($scope,$resource,$state,model,$rootScope,data){$scope.listCtrl=this,$scope.listCtrl.model=model,$scope.listCtrl.data=data;var Items=$resource("/api/collections/"+model+"/:id",{id:"@_id"});$scope.listCtrl.paginate={page:0,rows:5,totalItems:0},(0===$rootScope.page||$rootScope.page)&&($scope.listCtrl.paginate.page=$rootScope.page,$rootScope.page=null),$rootScope.rows&&($scope.listCtrl.paginate.rows=$rootScope.rows,$rootScope.rows=null),$rootScope.totalItems&&($scope.listCtrl.paginate.totalItems=$rootScope.totalItems,$rootScope.totalItems=null);var query=null;$scope.listCtrl.getList=function(page,rows){"Group"==model&&(query={level:0}),Items.query({perPage:rows,page:page,query:query},function(res){0==page&&res.length>0&&($scope.listCtrl.paginate.totalItems=res.shift().index),$scope.listCtrl.items=res})},$scope.listCtrl.deleteItem=function(item){console.log("??"),Items.delete({id:item._id},function(err){err&&console.log(err),$scope.listCtrl.getList($scope.listCtrl.paginate.page,$scope.listCtrl.paginate.rows)})},$scope.listCtrl.editItem=function(item){$rootScope.page=$scope.listCtrl.paginate.page,$rootScope.rows=$scope.listCtrl.paginate.rows,$rootScope.totalItems=$scope.listCtrl.paginate.totalItems;var id;if(id="new"!=item?item.url||item._id:"new","FeedBack"==model)return"new"==id?void alert("нельзя выполнить действие"):void Items.save({update:"read"},{_id:id,read:!0},function(res){console.log("сохранен")});var state="frame.home";"Group"==model?state="frame.categoryGroupList.edit":"PAP"==model?state="frame.PAP.edit":"AddCriterion"==model?(item&&item._id&&!item.filter&&console.log("нельзя редактировать и уничтожать соответственно"),state="frame.addCriterion.edit"):state="frame."+model+".edit",$state.go(state,{id:id,model:model})},$scope.listCtrl.getList($scope.listCtrl.paginate.page,$scope.listCtrl.paginate.rows)}]).controller("listEditCtrl",["$scope","$resource","$state","model","$stateParams","$rootScope","global","$filter",function($scope,$resource,$state,model,$stateParams,$rootScope,global,$filter){var page=$rootScope.page,rows=$rootScope.rows,totalItems=$rootScope.totalItems;$rootScope.page=null,$rootScope.rows=null,$rootScope.totalItems=null,$scope.listEditCtrl=this;var Items=$resource("/api/collections/"+model+"/:id",{id:"@_id"}),Collection=$resource("/api/collections/Collection/:id",{id:"@_id"});if($scope.item={},$scope.listEditCtrl.paginate={page:0,rows:4,totalItems:0},$scope.listEditCtrl.getCollections=function(page,rows){Collection.query({perPage:rows,page:page,query:{seller:$scope.item._id}},function(res){0==$scope.listEditCtrl.paginate.page&&res.length>0&&($scope.listEditCtrl.paginate.totalItems=res.shift().index),$scope.listEditCtrl.collections=res})},"new"==$stateParams.id?"Group"==model?(oldChild=[],oldCategories=[]):"AddCriterion"==model?($scope.item.brands=[],$scope.item.categories=[]):"Store"==model?$scope.item.seller={}:"Helper"==model?($scope.item.intro={},$scope.item.popover={}):"StuffGroups"==model&&($scope.item.stuffs=[]):Items.get({id:$stateParams.id},function(res){$scope.item=res,"Group"==model?($scope.item.child&&$scope.item.child.length?(oldChild=angular.copy($scope.item.child),$scope.item.parent&&$scope.groups&&$scope.groups.length&&!$scope.item.parentName&&($scope.item.parentName=$scope.groups.getObjectFromArray("_id",$scope.item.parent).name)):oldChild=[],oldCategories=$scope.item.categories&&$scope.item.categories.length?angular.copy($scope.item.categories):[]):"Store"==model?$scope.item.seller||($scope.item.seller={}):"AddCriterion"==model?($scope.listEditCtrl.changeBrand(),$scope.listEditCtrl.changeCategory()):"Seller"==model?($scope.listEditCtrl.getCollections($scope.listEditCtrl.paginate.page,$scope.listEditCtrl.paginate.rows),$scope.listEditCtrl.collection={}):"Helper"==model&&($scope.item.intro||($scope.item.intro={}),$scope.item.popover||($scope.item.popover={}))}),$scope.listEditCtrl.updateItem=function(item){item.config=null,Items.save($scope.item,function(res){$scope.listEditCtrl.returnToList()}),"Group"==model&&(console.log(oldChild),oldChild.forEach(function(child){(!item.child||!item.child.length||item.child.indexOf(child)<0)&&Items.save({update:"parent level"},{_id:child,parent:null,level:0},function(res){console.log("сохранен c null- ",res)})}),item.child&&item.child.length&&item.child.forEach(function(child){oldChild.indexOf(child)<0&&Items.save({update:"parent level"},{_id:child,parent:item._id,level:item.level+1},function(res){console.log("сохранен с id- ",res)})}),oldCategories.forEach(function(category){(!item.categories||!item.categories.length||item.categories.indexOf(category)<0)&&Category.save({update:"group"},{_id:category,group:null},function(res){console.log("сохранен c null- ",res)})}),item.categories&&item.categories.length&&item.categories.forEach(function(category){oldCategories.indexOf(category)<0&&Category.save({update:"group"},{_id:category,group:item._id},function(res){console.log("сохранен с id- ",res)})}))},$scope.listEditCtrl.returnToList=function(){$rootScope.page=page,$rootScope.rows=rows,$rootScope.totalItems=totalItems;var state;state="Group"==model?"frame.categoryGroupList":"PAP"==model?"frame.PAP":"AddCriterion"==model?"frame.addCriterion":"frame."+model,$state.go(state,{},{reload:!0})},"Group"==model){var oldChild,oldCategories;$resource("/api/collections/Group/:id",{id:"@_id"}).query({perPage:500,page:0},function(res){res.shift(),$scope.groups=res,$scope.item.parent&&$scope.groups.length&&!$scope.item.parentName&&($scope.item.parentName=$scope.groups.getObjectFromArray("_id",$scope.item.parent).name)});var Category=$resource("/api/collections/Category/:id",{id:"@_id"});Category.query({perPage:500,page:0},function(res){res.shift(),$scope.categories=res}),$scope.listEditCtrl.filterGroup=function(item){return item._id!=$stateParams.id&&(item.parent==$stateParams.id||!item.parent&&!item.child.length)},$scope.listEditCtrl.filterCategories=function(item){return!item.group||item.group==$scope.item._id}}else"AddCriterion"==model?($scope.listEditCtrl.brands=global.get("brands").val,$scope.listEditCtrl.changeBrand=function(){var categories=[];$scope.item.brands.forEach(function(b){global.get("brands").val.getObjectFromArray("_id",b).categories.forEach(function(category){categories.indexOf(category)<0&&categories.push(category)})}),$scope.listEditCtrl.categories=categories.map(function(c){return global.get("categories").val.getObjectFromArray("_id",c)});for(var i=0,l=$scope.item.categories.length;i<l;i++)categories.indexOf($scope.item.categories[i])<0&&$scope.item.categories.splice(i,1);$scope.listEditCtrl.categories=global.get("categories").val},$scope.listEditCtrl.changeCategory=function(){$scope.item.categories||($scope.item.categories=[]);var filters=[];$scope.item.categories.forEach(function(c){global.get("categories").val.getObjectFromArray("_id",c).filters.forEach(function(filter){filters.indexOf(filter)<0&&filters.push(filter)})}),$scope.listEditCtrl.filters=filters.map(function(f){return global.get("filters").val.getObjectFromArray("_id",f)}),filters.indexOf($scope.item.filter)<0&&($scope.item.filter=null)},$scope.listEditCtrl.changeFilter=function(){$scope.listEditCtrl.changeCols()},$scope.listEditCtrl.changeCols=function(){var cols=parseInt($scope.item.cols);console.log($scope.item.cols),$scope.item.head&&$scope.item.head.length&&!$scope.item.head.length==cols||($scope.item.head=cols?new Array(cols):null),cols?function(col){var rows=global.get("filterTags").val.filter(function(t){return t.filter==$scope.item.filter}).sort(function(a,b){return b.index-a.index}).map(function(t){return t.name});console.log(rows);for(var table={},i=0,l=rows.length;i<l;i++)table[rows[i]]=new Array(col);$scope.item.table=table,console.log($scope.item.table)}(cols):$scope.item.table=null}):"Store"==model?($resource("/api/collections/Template/:id",{id:"@_id"}).query({perPage:500,page:0},function(res){res.shift(),$scope.listEditCtrl.templates=res}),$resource("/api/collections/Config/:id",{id:"@_id"}).query({perPage:500,page:0},function(res){res.shift(),$scope.listEditCtrl.currency=res[0].currency,$scope.listEditCtrl.unitOfMeasure=res[0].unitOfMeasure,$scope.listEditCtrl.config=res[0]}),$scope.listEditCtrl.changeCurrency=function(){$scope.item.currency||($scope.item.currency={}),$scope.item.currencyArr.forEach(function(item,i,arr){$scope.item.currency[item]||($scope.item.currency[item]=[1,item,""])});for(var key in $scope.item.currency)$scope.item.currencyArr.indexOf(key)<0&&delete $scope.item.currency[key]},$scope.listEditCtrl.store={},$scope.listEditCtrl.store.setUser=function(user){console.log($scope.item.owner),$scope.item.owner.push(user._id),console.log($scope.item.owner)}):"Seller"==model?($resource("/api/collections/Brand/:id",{id:"@_id"}).query({perPage:500,page:0},function(res){res.shift(),$scope.listEditCtrl.brands=res}),$resource("/api/collections/Group/:id",{id:"@_id"}).query({perPage:500,page:0},function(res){res.shift(),$scope.listEditCtrl.groups=res.filter(function(el){return 0==el.level})}),$resource("/api/collections/Config/:id",{id:"@_id"}).query({perPage:500,page:0},function(res){res.shift(),$scope.listEditCtrl.currency=res[0].currency,$scope.listEditCtrl.unitOfMeasure=res[0].unitOfMeasure}),$scope.listEditCtrl.seller={},$scope.listEditCtrl.seller.updateCollection=function(event){event.stopPropagation(),$scope.item._id&&($scope.listEditCtrl.collection._id?Collection.save($scope.listEditCtrl.collection):($scope.listEditCtrl.collection.seller=$scope.item._id,Collection.save($scope.listEditCtrl.collection,function(res){0!=$scope.listEditCtrl.paginate.page&&($scope.listEditCtrl.paginate.page=0),$scope.listEditCtrl.getCollections($scope.listEditCtrl.paginate.page,$scope.listEditCtrl.paginate.rows)})),$scope.listEditCtrl.collection={})},$scope.listEditCtrl.deleteCollection=function(collection,i){Collection.delete({id:collection._id},function(res){console.log(res),$scope.listEditCtrl.paginate.totalItems--,1==$scope.listEditCtrl.collections.length&&$scope.listEditCtrl.paginate.page&&$scope.listEditCtrl.paginate.page--,$scope.listEditCtrl.getCollections($scope.listEditCtrl.paginate.page,$scope.listEditCtrl.paginate.rows)})},$scope.listEditCtrl.seller.addCascade=function(){event.stopPropagation(),$scope.item.cascade||($scope.item.cascade=[]),$scope.item.cascade.push([1,0])},$scope.listEditCtrl.seller.addAdmin=function(user){console.log(user),$scope.item.admins||($scope.item.admins=[]),$scope.item.admins.push(user)},$scope.listEditCtrl.seller.setUser=function(user){$scope.item.user=user}):"Helper"==model?($scope.$watch("item.popover",function(json){$scope.popoverString=$filter("json")(json)},!0),$scope.$watch("popoverString",function(json){try{$scope.item.popover=JSON.parse(json),$scope.wellFormedPopover=!0}catch(e){$scope.wellFormedPopover=!1}},!0),$scope.$watch("item.intro",function(json){$scope.introString=$filter("json")(json)},!0),$scope.$watch("introString",function(json){try{$scope.item.intro=JSON.parse(json),$scope.wellFormedintro=!0}catch(e){$scope.wellFormedintro=!1}},!0)):"StuffGroups"==model&&($scope.listEditCtrl.stuffGroupsType=global.get("store").val.stuffGroups,$scope.listEditCtrl.stuffs=[],$scope.listEditCtrl.selectStuff=function(stuff){$scope.item.stuffs||($scope.item.stuffs=[]);for(var i=0,l=$scope.item.stuffs.length;i<l;i++)if($scope.item.stuffs[i]._id==stuff._id)return;$scope.item.stuffs.push(stuff)},$scope.listEditCtrl.refresStuffs=function(search){
search&&search.length&&search.length>2&&Stuff.getList(null,search.substring(0,30),0,30,$scope.listEditCtrl.paginate).then(function(res){res?(res.shift(),$scope.listEditCtrl.stuffs=res):$scope.listEditCtrl.stuffs=[]})})}]).controller("brandsCtrl",["$scope","$resource","$state",function($scope,$resource,$state){if("frame.brands"==$state.current.name){var Items=$resource("/api/collections/Brand/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/BrandTags/:id",{id:"@_id"});$scope.Items=Items}else if("frame.slides"==$state.current.name){var Items=$resource("/api/collections/Slide/:id",{id:"@_id"});$scope.Items=Items}else var Items=$resource("/api/collections/Filter/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/FilterTags/:id",{id:"@_id"});$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.categories=res}),$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.getCategoryName=function(id){for(var i=0,l=$scope.categories.length;i<l;i++)if($scope.categories[i]._id==id)return $scope.categories[i].name},$scope.editItem=function(item){$scope.item=item,$scope.disEdit=!1,item||($scope.item={categories:[]}),"frame.brands"==$state.current.name&&($scope.item.categoriesSEO?console.log($scope.item.categoriesSEO):($scope.item.categoriesSEO={},$scope.item.categories.forEach(function(item){$scope.item.categoriesSEO[item]={title:"",description:"",keywords:""}}),console.log($scope.item.categoriesSEO)),$scope.item.promGroup||($scope.item.promGroup={},$scope.item.categories.forEach(function(item){$scope.item.promGroup[item]=""}),console.log($scope.item.categoriesSEO))),"frame.slides"!=$state.current.name&&$scope.afterSaveTag()},$scope.categoryChange=function(){if($scope.item&&$scope.item.categoriesSEO){console.log($scope.item.categories);var keys=Object.keys($scope.item.categoriesSEO);$scope.item.categories.forEach(function(cat){keys.indexOf(cat)<0&&($scope.item.categoriesSEO[cat]={},$scope.item.promGroup[cat]="")}),keys.forEach(function(key){$scope.item.categories.indexOf(key)<0&&(delete $scope.item.categoriesSEO[key],delete $scope.item.promGroup[key])}),console.log($scope.item.categoriesSEO)}},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item={},$scope.item.city="",$scope.disEdit=!0,$scope.noLoad=!0,$scope.noChange=!0,"frame.slides"!=$state.current.name&&$scope.afterSaveTag()})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.editItemTag=function(itemTag){$scope.itemTag=itemTag},$scope.afterSaveTag=function(){if(!$scope.item||!$scope.item._id)return void($scope.itemsTag=null);var query;query="frame.brands"==$state.current.name?{query:{brand:$scope.item._id}}:{query:{filter:$scope.item._id}},ItemsTag.query(query,function(res){res.length>0&&res.shift(),$scope.itemsTag=res;var FileExist=$resource("/api/checkFileExist/");$scope.itemsTag.forEach(function(el){el.file=!1,FileExist.save({file:"/images/Brand/"+el._id+".zip"},function(res){console.log(res),el.file=res.file})}),$scope.itemTag=null})},$scope.updateItemTag=function(itemTag){if(!itemTag||!itemTag.name)return void alert("надо что-то ввести!");itemTag._id||("frame.brands"==$state.current.name?itemTag.brand=$scope.item._id:itemTag.filter=$scope.item._id),ItemsTag.save(itemTag,function(res){$scope.afterSaveTag()})},$scope.deleteItemTag=function(itemTag){confirm("Удалить?")&&itemTag.$delete(function(err){err&&console.log(err),$scope.afterSaveTag()})},$scope.createArch=function(itemTag){$resource("/api/createArchCollection/:id",{id:"@id"}).get({id:itemTag._id},function(){$resource("/api/checkFileExist/").save({file:"/images/Brand/"+itemTag._id+".zip"},function(res){itemTag.file=res.file})})}}]).controller("slidesCtrl",["$scope","$resource","$state",function($scope,$resource,$state){if("frame.brands"==$state.current.name){var Items=$resource("/api/collections/Brand/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/BrandTags/:id",{id:"@_id"});$scope.Items=Items}else var Items=$resource("/api/collections/Filter/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/FilterTags/:id",{id:"@_id"});$resource("/api/users").query({query:{role:"brandAdmin"}},function(res){res.shift(),$scope.users=res}),$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.categories=res}),$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item,$scope.disEdit=!1,$scope.afterSaveTag()},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item={},$scope.item.city="",$scope.disEdit=!0,$scope.noLoad=!0,$scope.noChange=!0,$scope.afterSaveTag()})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.editItemTag=function(itemTag){$scope.itemTag=itemTag},$scope.afterSaveTag=function(){if(!$scope.item||!$scope.item._id)return void($scope.itemsTag=null);var query;query="frame.brands"==$state.current.name?{query:{brand:$scope.item._id}}:{query:{filter:$scope.item._id}},ItemsTag.query(query,function(res){res.length>0&&res.shift(),$scope.itemsTag=res;var FileExist=$resource("/api/checkFileExist/");$scope.itemsTag.forEach(function(el){el.file=!1,FileExist.save({file:"/images/Brand/"+el._id+".zip"},function(res){console.log(res),el.file=res.file})}),$scope.itemTag=null})},$scope.updateItemTag=function(itemTag){if(!itemTag||!itemTag.name)return void alert("надо что-то ввести!");itemTag._id||("frame.brands"==$state.current.name?itemTag.brand=$scope.item._id:itemTag.filter=$scope.item._id),ItemsTag.save(itemTag,function(res){$scope.afterSaveTag()})},$scope.deleteItemTag=function(itemTag){confirm("Удалить?")&&itemTag.$delete(function(err){err&&console.log(err),$scope.afterSaveTag()})},$scope.createArch=function(itemTag){$resource("/api/createArchCollection/:id",{id:"@id"}).get({id:itemTag._id},function(){$resource("/api/checkFileExist/").save({file:"/images/Brand/"+itemTag._id+".zip"},function(res){itemTag.file=res.file})})}}]).controller("filtersCtrl",["$scope","$resource","$state",function($scope,$resource,$state){if("frame.brands"==$state.current.name){var Items=$resource("/api/collections/Brand/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/BrandTags/:id",{id:"@_id"});$scope.Items=Items}else{var Items=$resource("/api/collections/Filter/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/FilterTags/:id",{id:"@_id"});$scope.ItemsTag=ItemsTag}$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.categories=res}),$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item,$scope.disEdit=!1,$scope.afterSaveTag()},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0,$scope.noLoad=!0,$scope.noChange=!0,$scope.afterSaveTag()})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.editItemTag=function(itemTag){$scope.itemTag=itemTag},$scope.afterSaveTag=function(){if(!$scope.item||!$scope.item._id)return void($scope.itemsTag=null);var query;query="frame.brands"==$state.current.name?{query:{brand:$scope.item._id}}:{query:{filter:$scope.item._id}},ItemsTag.query(query,function(res){res.length>0&&res.shift(),$scope.itemsTag=res,$scope.itemTag=null})},$scope.updateItemTag=function(itemTag){if(!itemTag||!itemTag.name)return void alert("надо что-то ввести!");itemTag._id||("frame.brands"==$state.current.name?itemTag.brand=$scope.item._id:itemTag.filter=$scope.item._id),ItemsTag.save(itemTag,function(res){$scope.afterSaveTag()})},$scope.deleteItemTag=function(itemTag){confirm("Удалить?")&&itemTag.$delete(function(err){err&&console.log(err),$scope.afterSaveTag()})}}]).controller("categoryCtrl",["$scope","$resource","model",function($scope,$resource,model){var Items=$resource("/api/collections/"+model+"/:id",{id:"@_id"});$scope.model=model,$resource("/api/collections/Filter/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.filters=res}),$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item,$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})}}]).controller("feedBackCtrl",["$scope","$resource",function($scope,$resource){var Items=$resource("/api/collections/FeedBack/:id",{id:"@_id"});$scope.Items=Items,$scope.paginate={page:0,rows:0,totalItems:0},$scope.readItem=function(item){console.log(item)},$scope.getList=function(){Items.query({perPage:$scope.paginate.rows,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})}}]).controller("sizeCtrl",["$scope","$resource",function($scope,$resource){function setEmptyTable(rows,col){if(col=parseInt(col),rows){$scope.item.table={};for(var i=0;i<rows.length;i++)$scope.item.table[rows[i]]=new Array(col),console.log(rows[i])}}var Items=$resource("/api/collections/Size/:id",{id:"@_id"});$resource("/api/collections/Filter/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.filters=res}),$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.categories=res}),$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res});var ItemsTag=$resource("/api/collections/FilterTags/:id",{id:"@_id"});$scope.groupSetup={formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.groupSetup1={multiple:!0,formatSearching:"Searching the category...",formatNoMatches:"Не найдено",width:"50%"},$scope.groupSetup2={multiple:!0,formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"50%"},$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.updeteTags=function(){if(console.log($scope.item.filter),$scope.item.filter){var query={query:{filter:$scope.item.filter}};ItemsTag.query(query,function(res){res.length>0&&res.shift(),$scope.itemsTag=res.map(function(item){return item.name}),console.log($scope.itemsTag);for(var table={},oldT=Object.keys($scope.item.table),col=$scope.item.cols,i=0,l=$scope.itemsTag.length;i<l;i++){var t=$scope.itemsTag[i];oldT.indexOf(t)>-1?table[t]=$scope.item.table[t]:table[t]=new Array(col)}$scope.item.table=table})}},$scope.editItem=function(item){item||(item={}),item.table&&"string"==typeof item.table&&(item.table=JSON.parse(item.table)),item.head&&"string"==typeof item.head&&(item.head=JSON.parse(item.head)),item.filter&&$scope.changeFilter(item.filter,!0),item.cols||(item.cols=3,item.head=new Array(item.cols)),$scope.item=item,$scope.disEdit=!1},$scope.changeFilter=function(id,first){var query={query:{filter:id}};ItemsTag.query(query,function(res){res.length>0&&res.shift(),$scope.itemsTag=res.sort(function(a,b){return a.index-b.index}).map(function(item){return item.name}),console.log($scope.itemsTag),first||setEmptyTable($scope.itemsTag,$scope.item.cols)})},$scope.cols=_.range(1,10),$scope.changeCols=function(col){$scope.item.head=new Array(parseInt(col)),console.log(col),setEmptyTable($scope.itemsTag,col)},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){item.table=JSON.stringify(item.table),item.head=JSON.stringify(item.head),Items.save(item,function(res){$scope.afterSave()}),$scope.item=null},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})}}]).controller("stuffCtrl1",["$scope","$resource","$state","global",function($scope,$resource,$state,global){$scope.query={category:null,brand:null,brandTag:null,tags:[]};var Items=$resource("/api/collections/Stuff/:id",{id:"@_id"});$scope.Items=Items,$scope.filters={},$scope.filters.check=[],$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.filters.categories=res}),$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.filters.brands=res}),$resource("/api/collections/Filter/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.filters.filters=res});var BrandTags=$resource("/api/collections/BrandTags/:id",{id:"@_id"});$scope.filterTags=[];$resource("/api/collections/FilterTags/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.filterTags=res});$scope.nostore=global.get("nostore"),$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.$watch("query",function(newVal,oldVal){newVal!=oldVal&&$scope.afterSave()},!0),$scope.$watch("query.brand",function(n,o){if(n){var query={query:{brand:n}};BrandTags.query(query,function(res){res.shift(),$scope.brandTags=res})}else $scope.brandTags=[]}),$scope.checkFilters=function(filters){console.log(filters),filters.splice(0,filters.length)},$scope.afterSave=function(){var query=[];for(var key in $scope.query)if($scope.query[key])if("tags"==key){var qu=[];$scope.query[key].forEach(function(obj,i){obj&&obj.length&&(qu[i]=[],obj.forEach(function(objT){console.log(objT),qu[i].push({tags:objT})}),qu[i].length>1?qu[i]={$or:qu[i]}:qu[i]=qu[i][0])}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.query[key],query.push(obj)}1==query.length?(query=JSON.stringify(query[0]),console.log(query)):query.length>1?(query=JSON.stringify({$and:query}),console.log(query)):query="",Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page,query:query},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.disEdit=!0})},$scope.deleteStuff=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.editStuff=function(stuff,seo){var id=stuff?stuff._id:"";seo?$state.transitionTo("frame.stuffSeo.edit",{id:id}):$state.transitionTo("frame.stuff.edit",{id:id})},$scope.cloneStuff=function(stuff){var id=stuff?stuff._id:"";$state.transitionTo("frame.stuff.edit",{id:id,clone:"clone"})},$scope.editStuffGallery=function(stuff){var id=stuff?stuff._id:"";$state.transitionTo("frame.stuff.gallery",{id:id})},$scope.$on("saved",function(){$scope.afterSave()})}]).controller("stuffCtrl2",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll){function _getQueryTag(){var arr=[];return $scope.stuffCtrl.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr.length?arr.map(function(tag){return global.get("filterTags").val.getObjectFromArray("_id",tag).url}).join("+"):void 0}function _getBrand(){if($scope.stuffCtrl.query.brand)return global.get("brands").val.getObjectFromArray("_id",$scope.stuffCtrl.query.brand).url}function _getBrandTag(){if($scope.stuffCtrl.query.brandTag)return $scope.stuffCtrl.brandCollections.getObjectFromArray("_id",$scope.stuffCtrl.query.brandTag).url}var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.stuffCtrl=this,$scope.stuffCtrl.paginate={page:0,rows:5,totalItems:0},$scope.stuffCtrl.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$scope.stuffCtrl.categories=[];var queryTags,category;$scope.stuffCtrl.brands=[],$scope.stuffCtrl.brandCollections=[],$scope.stuffCtrl.filters=[],function(){var q=$q.defer();return q.resolve(),q.promise}().then(function(){var q=$q.defer();if("brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl){var group=global.get("groups").val.getObjectFromArray("url",$stateParams.groupUrl);if(group){if($scope.stuffCtrl.query.section=group._id,$stateParams.parentGroup){var categories=$section.getCategories($stateParams.parentGroup).map(function(i){return i._id?i._id:i});console.log(categories),categories&&($scope.stuffCtrl.categories=global.get("categories").val.filter(function(item){return categories.indexOf(item._id)>-1}))}q.resolve($scope.stuffCtrl.categories)}else $tate.go("404")}else q.resolve(1);return q.promise}).then(function(r){var q=$q.defer();return $scope.stuffCtrl.categories.length&&$stateParams.categoryUrl&&"id"!=$stateParams.categoryUrl&&(category=$scope.stuffCtrl.categories.getObjectFromArray("url",$stateParams.categoryUrl),category?$scope.stuffCtrl.query.category=category._id:$state.go("404")),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffCtrl.query.category&&($scope.stuffCtrl.brands=global.get("brands").val.getArrayObjects("categories",$scope.stuffCtrl.query.category)),1===$scope.stuffCtrl.brands.length)$scope.stuffCtrl.query.brand=$scope.stuffCtrl.brands[0]._id;else if($stateParams.brand){var brand=$scope.stuffCtrl.brands.getObjectFromArray("url",$stateParams.brand);brand&&($scope.stuffCtrl.query.brand=brand._id,$location.search("brand",brand.url))}return $scope.stuffCtrl.query.brand||$location.search("brand",null),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffCtrl.query.brand){var query={brand:$scope.stuffCtrl.query.brand};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffCtrl.brandCollections=res,$stateParams.brandTag){var brandTag=$scope.stuffCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}q.resolve(1)},function(){q.resolve(3)})}else q.resolve(2);return q.promise}).then(function(){var q=$q.defer();return $stateParams.queryTag&&(queryTags=$stateParams.queryTag.split("+"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),queryTags=queryTags.reduce(function(tags,tag){var t;return(t=global.get("filterTags").val.getObjectFromArray("url",tag))&&tags.push(t),tags},[])),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffCtrl.query.category){var filters=global.get("filters").val.filter(function(item){return!item.dontshow&&category.filters.indexOf(item._id)>-1});filters.forEach(function(item,i){item.tags=[],global.get("filterTags").val.forEach(function(tag){tag.filter==item._id&&item.tags.push(tag)}),queryTags&&queryTags.length&&queryTags.forEach(function(tag){tag.filter==item._id&&($scope.stuffCtrl.query.tags[i]||($scope.stuffCtrl.query.tags[i]=[]),$scope.stuffCtrl.query.tags[i].push(tag._id))})}),$scope.stuffCtrl.filters=filters}else queryTags&&queryTags.length&&($scope.stuffCtrl.query.tags[0]=[queryTags[0]._id],$location.search("queryTag",queryTags[0].url));return q.resolve("finsh"),q.promise}).then(function(r){$scope.stuffCtrl.getList($scope.stuffCtrl.paginate.page,$scope.stuffCtrl.paginate.rows)});var prevBrand;$scope.stuffCtrl.getList=function(page,rows){prevBrand=$scope.stuffCtrl.query.brand;var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});for(var key in $scope.stuffCtrl.query)if($scope.stuffCtrl.query[key])if("tags"==key){var qu=[];$scope.stuffCtrl.query[key].filter(function(){return!0});$scope.stuffCtrl.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.stuffCtrl.query[key],query.push(obj)}query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):"",Stuff.getList(query,null,page,rows,$scope.stuffCtrl.paginate).then(function(res){console.log($scope.stuffCtrl.paginate.totalItems),$scope.stuffCtrl.items=res,$scope.endLoadStuff=!0},function(err){$state.go("404")})},$scope.stuffCtrl.changeFilter=function(c){$anchorScroll();var category=$scope.stuffCtrl.query.category?$scope.stuffCtrl.categories.getObjectFromArray("_id",$scope.stuffCtrl.query.category):{name:"category",url:"id"};if(c){$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:category.url,categoryName:category.name,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else{$location.search(""),$scope.stuffCtrl.query.artikul="",!$scope.stuffCtrl.query.brand||$scope.stuffCtrl.brandCollections&&prevBrand==$scope.stuffCtrl.query.brand?$scope.stuffCtrl.query.brand||($scope.stuffCtrl.brandCollections=null,$scope.stuffCtrl.query.brandTag=""):(getCollections($scope.stuffCtrl.query.brand),$scope.stuffCtrl.query.brandTag=""),$scope.stuffCtrl.paginate.page=0,$scope.stuffCtrl.getList($scope.stuffCtrl.paginate.page,$scope.stuffCtrl.paginate.rows);var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand();queryTag&&$location.search("queryTag",queryTag),brandTag&&$location.search("brandTag",brandTag),brand&&$location.search("brand",brand),$stateParams.brandTag&&$location.search("brandTag",$stateParams.brandTag)}}}]).controller("stuffEditCtrl",["$scope","$resource","$stateParams","$state","$timeout","global","Collection",function($scope,$resource,$stateParams,$state,$timeout,global,Collection){function getAddCriterion(){var category=$scope.item.category||null,brand=$scope.item.brand||null,query=JSON.stringify({$and:[{categories:category},{brands:brand}]});AddCriterion.query({query:query},function(res){res.length&&res.shift(),$scope.stuffEditCtrl.addCriterions=res,$scope.stuffEditCtrl.addCriterions.length&&1==$scope.stuffEditCtrl.addCriterions.length&&($scope.item.addCriterion=[$scope.stuffEditCtrl.addCriterions[0]._id]),$scope.stuffEditCtrl.changeAddCriterion()})}function getCollections(brand,group){var query={brand:brand,group:group};Collection.getCollectionsForBrand({query:query},function(res){res.shift(),$scope.stuffEditCtrl.collections=res})}$scope.stuffEditCtrl=this,$scope.split_custom=function(string,spliter,is_integer){return $scope.ret_arr=string.split(spliter),1==is_integer&&($scope.ret_arr=$scope.ret_arr.map(Number)),$scope.ret_arr},$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"100%"},$scope.stuffEditCtrl.unitOfMeasure=global.get("config").val.unitOfMeasure;var Items=$resource("/api/collections/Stuff/:id",{id:"@id"}),ColorGroup=($resource("/api/collections/BrandTags/:id",{id:"@_id"}),$resource("/api/collections/GroupColor/:id",{id:"@_id"})),AddCriterion=$resource("/api/collections/AddCriterion/:id",{id:"@_id"});if($scope.colorGroup={members:[]},$scope.focusInput=!0,$scope.filtersValue={},$scope.stuffEditCtrl.categories=[],$scope.stuffEditCtrl.filters=[],$scope.stuffEditCtrl.brands=[],$scope.stuffEditCtrl.categories=[],$scope.stuffEditCtrl.groups=[],$scope.stuffEditCtrl.groups[0]=global.get("groups"),$scope.stuffEditCtrl.groups[1]=[],$scope.stuffEditCtrl.section1="",$scope.stuffEditCtrl.groups[2]=[],$scope.stuffEditCtrl.section2="",$scope.stuffEditCtrl.addCriterions=[],$scope.stuffEditCtrl.collections=[],$scope.stuffEditCtrl.changeGroup=function(id,level){if($scope.stuffEditCtrl.categories=[],$scope.stuffEditCtrl.filters=[],$scope.stuffEditCtrl.brands=[],$scope.stuffEditCtrl.addCriterions=[],$scope.stuffEditCtrl.collections=[],$scope.item.category=null,$scope.item.brand=null,$scope.item.brandTag=null,$scope.item.addCriterion=null,$scope.item.tags=[],$scope.item.available={},0===level){$scope.stuffEditCtrl.categories=[],$scope.stuffEditCtrl.groups[1]=[],$scope.stuffEditCtrl.section1="",$scope.stuffEditCtrl.groups[2]=[],$scope.stuffEditCtrl.section2="";var group=$scope.stuffEditCtrl.groups[0].val.getObjectFromArray("_id",id);group.categories.length?$scope.stuffEditCtrl.categories=global.get("categories").val.filter(function(item){return group.categories.indexOf(item._id)>-1}):$scope.stuffEditCtrl.groups[1]=group.child}else if(1===level){$scope.stuffEditCtrl.groups[2]=[],$scope.stuffEditCtrl.section2="";var group=$scope.stuffEditCtrl.groups[1].getObjectFromArray("_id",id);group.categories.length?$scope.stuffEditCtrl.categories=global.get("categories").val.filter(function(item){return group.categories.indexOf(item._id)>-1}):$scope.stuffEditCtrl.groups[2]=group.child}else if(2===level){var group=$scope.stuffEditCtrl.groups[2].getObjectFromArray("_id",id);group.categories.length&&($scope.stuffEditCtrl.categories=global.get("categories").val.filter(function(item){return group.categories.indexOf(item._id)>-1}))}},$scope.stuffEditCtrl.changeCategory=function(id,first){if($scope.stuffEditCtrl.filters=[],$scope.stuffEditCtrl.brands=[],$scope.stuffEditCtrl.addCriterions=[],$scope.stuffEditCtrl.collections=[],first||($scope.item.brand=null,$scope.item.tags=[],$scope.item.brandTag=null,$scope.item.addCriterion=null,$scope.item.available={}),id){var category=global.get("categories").val.getObjectFromArray("_id",id);if(first){var group=global.get("groups").val.getObjectFromArray("_id",category.group._id);$scope.stuffEditCtrl.categories=global.get("categories").val.filter(function(item){return group.categories.indexOf(item._id)>-1})}var filters=global.get("filters").val.filter(function(item){return category.filters.indexOf(item._id)>-1});filters&&(filters.forEach(function(item,i){item.tags=[],global.get("filterTags").val&&global.get("filterTags").val.forEach(function(tag){tag.filter==item._id&&item.tags.push(tag)})}),$scope.stuffEditCtrl.filters=filters,first||$scope.stuffEditCtrl.setFilterValue([])),$scope.stuffEditCtrl.brands=global.get("brands").val.getArrayObjects("categories",id)}},$scope.stuffEditCtrl.changeBrand=function(id,first){$scope.stuffEditCtrl.addCriterions=[],$scope.stuffEditCtrl.collections=[],first||($scope.item.brandTag=null,$scope.item.addCriterion=null,$scope.item.available={}),getCollections(id,$scope.item.section),getAddCriterion()},$scope.stuffEditCtrl.changeAddCriterion=function(){if($scope.item.addCriterion&&$scope.item.addCriterion.length){if($scope.item.addCriterion.length>=1){$scope.item.available||($scope.item.available={});var store={},addCr=$scope.stuffEditCtrl.addCriterions.getObjectFromArray("_id",$scope.item.addCriterion[0]),arr=global.get("filterTags").val.filter(function(tag){return tag.filter==addCr.filter});$scope.stuffEditCtrl.headTable1=arr.map(function(t){return t.name});for(var i=0,l=arr.length;i<l;i++)$scope.item.available[arr[i]._id]?store[arr[i]._id]=$scope.item.available[arr[i]._id]:store[arr[i]._id]={name:arr[i].name,quantity:1,stage:0};if(2==$scope.item.addCriterion.length){addCr=$scope.stuffEditCtrl.addCriterions.getObjectFromArray("_id",$scope.item.addCriterion[1]),arr=global.get("filterTags").val.filter(function(tag){return tag.filter==addCr.filter}),$scope.stuffEditCtrl.headTable2=arr.map(function(t){return t.name});for(var j in store){store[j]={};for(var i=0,l=arr.length;i<l;i++)$scope.item.available[j][arr[i]._id]?store[j][arr[i]._id]=$scope.item.available[j][arr[i]._id]:store[j][arr[i]._id]={name:arr[i].name,quantity:1,stage:0}}}$scope.item.available=store}}else $scope.item.available={notable:{name:"наличие",quantity:1,stage:0}}},$scope.stuffEditCtrl.setFilterValue=function(tags){$scope.stuffEditCtrl.filtersValue={},$scope.stuffEditCtrl.filters.forEach(function(filter){$scope.stuffEditCtrl.filtersValue[filter._id]=[],filter.tags.forEach(function(tag){tags.indexOf(tag._id)>-1&&(2==filter.type?$scope.stuffEditCtrl.filtersValue[filter._id].push(tag._id):$scope.stuffEditCtrl.filtersValue[filter._id]=tag._id)})})},console.log($stateParams),"new"==$stateParams.stuffUrl){$scope.item={name:""};var group=$scope.stuffEditCtrl.groups[0].val.getObjectFromArray("url",$stateParams.groupUrl);if(group?($scope.item.section=group._id,$scope.stuffEditCtrl.changeGroup($scope.item.section,0)):$scope.item.section=null,$stateParams.categoryUrl){var category=global.get("categories").val.getObjectFromArray("url",$stateParams.categoryUrl);category&&($scope.item.category=category._id,$scope.stuffEditCtrl.changeCategory($scope.item.category,!0))}$scope.item.brand=$stateParams.brand,$scope.stuffEditCtrl.changeBrand($scope.item.brand,!0)}else Items.get({id:$stateParams.stuffUrl},function(res){$stateParams.clone&&"clone"==$stateParams.clone&&(delete res._id,delete res.url,delete res.gallery,delete res.groupColorIs,delete res.group,delete res.store),$scope.item=res,$scope.item.addCriterion=$scope.item.addCriterion.map(function(c){return c._id}),$scope.stuffEditCtrl.changeCategory($scope.item.category,!0),$scope.stuffEditCtrl.changeBrand($scope.item.brand,!0),$scope.stuffEditCtrl.setFilterValue($scope.item.tags),$scope.item.group&&$scope.item.group.col&&$scope.item.group.col._id&&($scope.colorGroup=ColorGroup.get({id:$scope.item.group.col._id})),$scope.item.group&&$scope.item.group.rec&&$scope.item.group.rec._id&&($scope.recommendGroup=ColorGroup.get({id:$scope.item.group.rec._id}))})
;$scope.updateStuff=function(seo){var filtersValue=$scope.stuffEditCtrl.filtersValue;$scope.item.tags=[];for(var i in filtersValue)if(angular.isArray(filtersValue[i])&&null!==filtersValue[i])for(var j=0;j<filtersValue[i].length;j++)$scope.item.tags.push(filtersValue[i][j]);else filtersValue[i]&&$scope.item.tags.push(filtersValue[i]);$scope.item.group&&($scope.item.group.col&&($scope.item.group.col=$scope.item.group.col._id),$scope.item.group.rec&&($scope.item.group.rec=$scope.item.group.rec._id)),Items.save($scope.item,function(res){$scope.$emit("saved"),$state.go("frame.stuff",$stateParams)})}}]).controller("stuffGalleryCtrl",["$scope","$rootScope","$fileUpload","$http","$timeout","$resource",function($scope,$rootScope,$fileUpload,$http,$timeout,$resource){var Items=$resource("/api/collections/Stuff/:id",{id:"@id"});$scope.photoIndexArrayNew=[1,2,3,4,5,6,7,8,9,10,11,12,100],$scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12],$scope.photoIndex=1,$scope.mainFilterTag="",$scope.gallery=[],Items.get({id:$rootScope.$stateParams.id},function(res){$scope.stuff=res,$scope.gallery=res.gallery}),$scope.deletePhoto=function(index){confirm("Удалить?")&&$http.get("/api/collections/Stuff/fileGalleryDelete/"+$scope.stuff._id+"/"+index).then(function(response){$scope.gallery=[],$timeout(function(){$scope.gallery=response.data.gallery},10)})},$scope.updateStuffGallery=function(){$http.post("/api/collections/Stuff/fileGalleryUpdate/"+$scope.stuff._id,{gallery:$scope.gallery}).then(function(response){alert(response.data.msg),$scope.gallery=response.data.gallery})},$scope.backToList=function(){$rootScope.$state.transitionTo("frame.stuff")}}]).controller("pageCtrl",["$scope","$resource","$state","type",function($scope,$resource,$state,type){var Items=$resource("/api/collections/"+type+"/:id",{id:"@_id"});$scope.type=type,$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item?Items.get({id:item._id}):{},$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(res){$scope.afterSave()})},$scope.editGallery=function(news){var id=news?news._id:"";$state.transitionTo("frame.page.gallery",{id:id,type:$scope.type})},$scope.shareSN={sn:{g:!1,f:!1}},$scope.shareSN.doIt=function(item){console.log(item),$resource("/api/sharePost/").save({},function(res){console.log(res)})}}]).controller("pageGalleryCtrl",["$scope","$fileUpload","$http","$timeout","$resource","$stateParams","$state",function($scope,$fileUpload,$http,$timeout,$resource,$stateParams,$state){var Items=$resource("/api/collections/"+$scope.$parent.type+"/:id",{id:"@id"});$scope.photoIndexArrayNew=[1,2,3,4,5,6,7,8,9,10,11,12],$scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12],$scope.photoIndex=1,$scope.mainFilterTag="",$scope.gallery=[],Items.get({id:$stateParams.id},function(res){$scope.item=res,$scope.gallery=res.gallery}),$scope.deletePhoto=function(index){confirm("Удалить?")&&$http.get("/api/collections/"+$stateParams.type+"/fileGalleryDelete/"+$scope.item._id+"/"+index).then(function(response){alert(response.data.msg),$scope.gallery=[],$timeout(function(){$scope.gallery=response.data.gallery},10)})},$scope.updateGallery=function(){$http.post("/api/collections/"+$stateParams.type+"/fileGalleryUpdate/"+$scope.item._id,{gallery:$scope.gallery}).then(function(response){alert(response.data.msg),$scope.gallery=response.data.gallery})},$scope.backToList=function(){$state.transitionTo("frame.page",{type:$stateParams.type})}}]).controller("newsCtrl",["$scope","$resource","$state",function($scope,$resource,$state){var Items=$resource("/api/collections/News/:id",{id:"@_id"});$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item?Items.get({id:item._id}):{},$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.editNewsGallery=function(news){var id=news?news._id:"";$state.transitionTo("frame.news.gallery",{id:id})}}]).controller("newsGalleryCtrl",["$scope","$rootScope","$fileUpload","$http","$timeout","$resource",function($scope,$rootScope,$fileUpload,$http,$timeout,$resource){var Items=$resource("/api/collections/News/:id",{id:"@id"});$scope.photoIndexArrayNew=[1,2,3,4,5,6,7,8,9,10,11,12],$scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12],$scope.photoIndex=1,$scope.mainFilterTag="",$scope.gallery=[],Items.get({id:$rootScope.$stateParams.id},function(res){$scope.news=res,$scope.gallery=res.gallery}),$scope.deletePhoto=function(index){confirm("Удалить?")&&$http.get("/api/collections/News/fileGalleryDelete/"+$scope.news._id+"/"+index).then(function(response){alert(response.data.msg),$scope.gallery=[],$timeout(function(){$scope.gallery=response.data.gallery},10)})},$scope.updateGallery=function(){$http.post("/api/collections/News/fileGalleryUpdate/"+$scope.news._id,{gallery:$scope.gallery}).then(function(response){alert(response.data.msg),$scope.gallery=response.data.gallery})},$scope.backToList=function(){$rootScope.$state.transitionTo("frame.news")}}]).controller("campaignCtrl",["$scope","$resource","$state","global",function($scope,$resource,$state,global){$scope.campaignCtrl=this;var Items=$resource("/api/collections/Campaign/:id",{id:"@_id"});$scope.disEdit=!0,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){if($scope.campaignCtrl.filtersBase=null,$scope.campaignCtrl.filterBase=null,$scope.campaignCtrl.tagsBase=null,$scope.campaignCtrl.tagBase=null,$scope.campaignCtrl.filtersStuff=null,$scope.campaignCtrl.filterStuff=null,$scope.campaignCtrl.tagsStuff=null,$scope.campaignCtrl.tagStuff=null,$scope.item=item?item:{forGroupBase:null,forGroupStuff:null},$scope.item.forGroupBase)if(0==$scope.item.groupTypeBase){if($scope.campaignCtrl.filtersBase=global.get("filters").val,$scope.item.groupBaseTag){var tag=global.get("filterTags").val.getObjectFromArray("_id",$scope.item.groupBaseTag);$scope.campaignCtrl.filterBase=tag.filter,$scope.campaignCtrl.tagBase=item.groupBaseTag,$scope.campaignCtrl.tagsBase=global.get("filterTags").val.filter(function(item){return item.filter==$scope.campaignCtrl.filterBase})}}else if(1==$scope.item.groupTypeBase&&($scope.campaignCtrl.filtersBase=global.get("brands").val,$scope.item.groupBaseCollection)){var collection=$scope.collections.getObjectFromArray("_id",$scope.item.groupBaseCollection);$scope.campaignCtrl.filterBase=collection.brand,$scope.campaignCtrl.tagBase=item.groupBaseCollection,$scope.campaignCtrl.tagsBase=$scope.collections.filter(function(item){return item.brand==$scope.campaignCtrl.filterBase})}if($scope.item.forGroupStuff)if(0==$scope.item.groupTypeStuff){if($scope.campaignCtrl.filtersStuff=global.get("filters").val,$scope.item.groupStuffTag){var tag=global.get("filterTags").val.getObjectFromArray("_id",$scope.item.groupStuffTag);$scope.campaignCtrl.filterStuff=tag.filter,$scope.campaignCtrl.tagStuff=item.groupStuffTag,$scope.campaignCtrl.tagsStuff=global.get("filterTags").val.filter(function(item){return item.filter==$scope.campaignCtrl.filterStuff})}}else if(1==$scope.item.groupTypeStuff&&($scope.campaignCtrl.filtersStuff=global.get("brands").val,$scope.item.groupStuffCollection)){var collection=$scope.collections.getObjectFromArray("_id",$scope.item.groupStuffCollection);$scope.campaignCtrl.filterStuff=collection.brand,$scope.campaignCtrl.tagStuff=item.groupStuffCollection,$scope.campaignCtrl.tagsStuff=$scope.collections.filter(function(item){return item.brand==$scope.campaignCtrl.filterStuff})}$scope.disEdit=!1};var Collection=$resource("/api/getAllCollections/:id",{id:"@id"});$scope.collections=Collection.query(),$scope.changeForGroupBase=function(){$scope.item.groupTypeBase=null,$scope.campaignCtrl.filtersBase=null,$scope.campaignCtrl.filterBase=null,$scope.campaignCtrl.tagsBase=null,$scope.campaignCtrl.tagBase=null,$scope.item.groupBaseTag=null,$scope.item.groupBaseCollection=null},$scope.changeTypeBase=function(groupTypeBase){$scope.campaignCtrl.filtersBase=null,$scope.campaignCtrl.filterBase=null,$scope.campaignCtrl.tagsBase=null,$scope.campaignCtrl.tagBase=null,$scope.item.groupBaseTag=null,$scope.item.groupBaseCollection=null,0==groupTypeBase?$scope.campaignCtrl.filtersBase=global.get("filters").val:1==groupTypeBase&&($scope.campaignCtrl.filtersBase=global.get("brands").val)},$scope.changeFilterBase=function(filter){$scope.campaignCtrl.tagBase=null,0==$scope.item.groupTypeBase?($scope.campaignCtrl.tagsBase=global.get("filterTags").val.filter(function(item){return item.filter==filter}),$scope.item.groupBaseTag=null):1==$scope.item.groupTypeBase&&($scope.campaignCtrl.tagsBase=$scope.collections.filter(function(col){return col.brand==filter}),console.log($scope.campaignCtrl.tagsBase),$scope.item.groupBaseCollection=null)},$scope.changeTagBase=function(tag){0==$scope.item.groupTypeBase?$scope.item.groupBaseTag=tag:1==$scope.item.groupTypeBase&&($scope.item.groupBaseCollection=tag)},$scope.changeForGroupStuff=function(){$scope.item.groupTypeStuff=null,$scope.campaignCtrl.filtersStuff=null,$scope.campaignCtrl.filterStuff=null,$scope.campaignCtrl.tagsStuff=null,$scope.campaignCtrl.tagStuff=null,$scope.item.groupStuffTag=null,$scope.item.groupStuffCollection=null},$scope.changeTypeStuff=function(groupTypeStuff){$scope.campaignCtrl.filtersStuff=null,$scope.campaignCtrl.filterStuff=null,$scope.campaignCtrl.tagsStuff=null,$scope.campaignCtrl.tagStuff=null,$scope.item.groupStuffTag=null,$scope.item.groupStuffCollection=null,0==groupTypeStuff?$scope.campaignCtrl.filtersStuff=global.get("filters").val:1==groupTypeStuff&&($scope.campaignCtrl.filtersStuff=global.get("brands").val)},$scope.changeFilterStuff=function(filter){$scope.campaignCtrl.tagStuff=null,0==$scope.item.groupTypeStuff?($scope.campaignCtrl.tagsStuff=global.get("filterTags").val.filter(function(item){return item.filter==filter}),$scope.item.groupStuffTag=null):1==$scope.item.groupTypeStuff&&($scope.campaignCtrl.tagsStuff=$scope.collections.filter(function(col){return col.brand==filter}),console.log($scope.campaignCtrl.tagsStuff),$scope.item.groupStuffCollection=null)},$scope.changeTagStuff=function(tag){0==$scope.item.groupTypeStuff?$scope.item.groupStuffTag=tag:1==$scope.item.groupTypeStuff&&($scope.item.groupStuffCollection=tag)},$scope.updateItem=function(item){if(!item)return $scope.item={},$scope.disEdit=!0,$scope.noLoad=!0,void($scope.noChange=!0);item.forGroupBase&&(item.baseStuffs=[]),item.forGroupStuff&&(item.stuffs=[]),Items.save(item,function(res){$scope.afterSave()})},$scope.dt=new Date,$scope.today=function(t){return t?new Date($scope.dt.setHours(0,0,0)):new Date($scope.dt.setHours(23,59,59))},$scope.dtto=$scope.today(),$scope.dtfrom=$scope.today(!0),$scope.dtfrom.setDate($scope.dtfrom.getDate()-30),console.log($scope.dtfrom),$scope.clear=function(){$scope.dtto=$scope.dtfrom=null},$scope.openfrom=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedfrom=!0},$scope.opento=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedto=!0},$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],$scope.format=$scope.formats[0],$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item={},$scope.disEdit=!0,$scope.noLoad=!0,$scope.noChange=!0})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.addStuff=function(stuff){$scope.item.stuffs||($scope.item.stuffs=[]);for(var i=0,l=$scope.item.stuffs.length;i<l;i++)if($scope.item.stuffs[i].stuff==stuff.stuff&&$scope.item.stuffs[i].size==stuff.size)return;if($scope.item.baseStuffs)for(var i=0,l=$scope.item.baseStuffs.length;i<l;i++)if($scope.item.baseStuffs[i].stuff==stuff.stuff)return;$scope.item.stuffs.push({stuff:stuff.stuff,img:stuff.img,size:stuff.size,name:stuff.name,sizeName:stuff.sizeName,category:stuff.category,categoryName:stuff.categoryName,brand:stuff.brand,brandName:stuff.brandName})},$scope.addBaseStuff=function(stuff){$scope.item.baseStuffs||($scope.item.baseStuffs=[]);for(var i=0,l=$scope.item.stuffs.length;i<l;i++)if($scope.item.stuffs[i].stuff==stuff.stuff)return;for(var i=0,l=$scope.item.baseStuffs.length;i<l;i++)if($scope.item.baseStuffs[i].stuff==stuff.stuff)return;$scope.item.baseStuffs.push({stuff:stuff.stuff,img:stuff.img,name:stuff.name,category:stuff.category,categoryName:stuff.categoryName,brand:stuff.brand,brandName:stuff.brandName})},$scope.quant=_.range(1,51)}]).controller("groupsCtrl",["$scope","$resource","$timeout",function($scope,$resource,$timeout){$scope.disEdit=!0;var Items=$resource("/api/collections/GroupColor/:id",{id:"@_id"}),Stuff=$resource("/api/collections/Stuff/:id",{id:"@_id"});$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.categories=res}),$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.paginateStuff={page:0,row:0,totalItems:0},$scope.$watch("paginateStuff.row",function(n,o){n&&$scope.category&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.getStuff())}),$scope.$watch("paginateStuff.page",function(n,o){0!=$scope.paginate.row&&$scope.getStuff()}),$scope.getStuff=function(){if($scope.category){var query={perPage:$scope.paginateStuff.row,page:$scope.paginateStuff.page};"1"==$scope.group.type?query.query=JSON.stringify({$and:[{category:$scope.category},{$where:"!this.group.col"}]}):query.query=JSON.stringify({$and:[{category:$scope.category},{$where:"!this.group.rec"}]}),Stuff.query(query,function(res){0==$scope.paginateStuff.page&&res.length>0&&($scope.paginateStuff.totalItems=res.shift().index),$scope.stuffs=res})}},$scope.$watch("category",function(n,o){n&&$scope.getStuff()}),$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.afterSave=function(){$scope.groups=Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index)})},$scope.getStuffName=function(name){return name.replace(/\//g,"-").split(" ").join("-")},$scope.addStuffInGroup=function(stuff){if(!stuff.gallery.length)return void alert("нет фотографий");stuff.gallery.sort(function(a,b){return a.index-b.index});for(var i=0,l=$scope.group.members.length;i<l;i++)if($scope.group.members[i].stuff==stuff._id)return void alert("такой товар есть в группе -"+$scope.group.members[i].name);var i,key,img="";if(!$scope.group.type)return void alert("выберите тип!");"1"==$scope.group.type?(i=stuff.gallery.length-1,key="col"):(i=0,key="rec"),img=stuff.gallery[i].thumbSmall?stuff.gallery[i].thumbSmall:stuff.gallery[i].thumb,console.log(img);var name=$scope.getStuffName(stuff.name);stuff.artikul&&(name+=" "+stuff.artikul),$scope.group.members[$scope.group.members.length]={stuff:stuff._id,name:name,img:img,brand:findObInArray($scope.brands,"_id",stuff.brand).name,category:findObInArray($scope.categories,"_id",stuff.category).name,stuffUrl:stuff.url,categoryUrl:findObInArray($scope.categories,"_id",stuff.category).url,brandUrl:findObInArray($scope.brands,"_id",stuff.brand).url},$scope.updateGroup(function(res){res.id&&Stuff.get({id:stuff._id},function(stuff){stuff.group||(stuff.group={col:null,rec:null}),stuff.group[key]=res.id,stuff.groupColorIs=!0,stuff.groupColorw=res.id,Stuff.save(stuff,function(){$scope.getStuff()})})})},$scope.deleteStuffFromGroup=function(stuff,i){if("1"==$scope.group.type)var key="col";else var key="rec";$scope.group.members.splice(i,1),$scope.updateGroup(function(){Stuff.get({id:stuff.stuff},function(res){res.groupColorIs=!1,res.groupColor="",res.group||(res.group={col:null,rec:null}),res.group[key]="",Stuff.save(res,function(res){$scope.getStuff()})})})},$scope.editGroup=function(item){$scope.group=item,$scope.group||($scope.group={}),$scope.group.members||($scope.group.members=[]),$scope.disEdit=!1,$scope.category="",$scope.stuffs=[],$scope.paginateStuff={page:0,row:50,totalItems:0}},$scope.updateGroup=function(cb){if(!$scope.group.name){var name=$scope.group.members[0]&&$scope.group.members[0].name?$scope.group.members[0].name:"no name";$scope.group.name=name}Items.save($scope.group,function(res){res.id&&!$scope.group._id&&($scope.group._id=res.id),cb(res)})},$scope.doneGroup=function(){$scope.disEdit=!0,$scope.group={},$scope.stuffs=[],$scope.category="",$scope.afterSave()},$scope.deleteGroup=function(item){if(confirm("Удалить?")){if(item.members.length>0)return void alert("Удалите сначала товары из группы");$scope.disEdit=!0,$scope.group={},item.$delete(function(err){err&&console.log(err),$scope.afterSave()})}}}]).controller("usersCtrl",["$scope","User","$resource","$http","Orders",function($scope,User,$resource,$http,Orders){$resource("/api/config").get(function(res){$scope.config=res,$scope.config.clients.push("admin"),$scope.config.clients.push("brandAdmin")}),$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.query={},$scope.fio="",$scope.name="",$scope.email="",$scope.afterSave=function(){$scope.fio&&($scope.query.fio=$scope.fio.substring(0,50)),$scope.name&&($scope.query.name=$scope.name.substring(0,50)),$scope.email&&($scope.query.email=$scope.email.substring(0,50)),User.list({perPage:$scope.paginate.row,page:$scope.paginate.page,fio:$scope.fio.substring(0,50),name:$scope.name.substring(0,50),email:$scope.email.substring(0,50)},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.users=res})},$scope.updateUser=function(user){user.$update(function(res){$scope.afterSave()},function(err){err=err.data,$scope.errors={},err.errors?angular.forEach(err.errors,function(error,field){form[field].$setValidity("mongoose",!1),$scope.errors[field]=error.message}):alert(err.error)})},$scope.deleteUser=function(user){confirm("Удалить?")&&user.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.password="",$scope.changePswd=function(form,user){$scope.submitted=!0,form.$valid&&(console.log(form),$http.post(" /api/users/editForce",{email:user.email,password:user.password}).then(function(res){$scope.done=!0,$scope.password="",alert("обновлено!")},function(err){alert(err.data.error)}))},$scope.orders={};var getOrderQuantity=function(){for(var q=0,i=0,l=this.cartInner.length;i<l;i++)for(var j=0,lj=this.cartInner[i].cart.cart.length;j<lj;j++)q+=this.cartInner[i].cart.cart[j].quantity;return this.quantity=q,q},getTotalSum=function(){function getPriceCouponCustomOrder(price,coupon,use){return coupon&&coupon._id&&use?function(p,s,v){var sum=0;return p&&(sum=v-v/100*p),s&&(sum=v-s),sum}(coupon.p,coupon.s,price):price}for(var s=0,i=0;i<this.cartInner.length;i++)for(var j=0,lj=this.cartInner[i].cart.cart.length;j<lj;j++){var good=this.cartInner[i].cart.cart[j];s+=this.quantity>=5||this.opt?good.quantity*getPriceCouponCustomOrder(good.price,this.coupon,good.coupon):good.quantity*getPriceCouponCustomOrder(good.retail,this.coupon,good.coupon)}return s};$scope.getOrders=function(user){Orders.list({user:user._id},function(res){res.shift().index,$scope.orders[user._id]=res,$scope.orders[user._id].forEach(function(el){el.getQuantity=getOrderQuantity,el.getSum=getTotalSum})})}}]).controller("orders1Ctrl",["$scope","OrdersNew","$resource",function($scope,Orders,$resource){$scope.ordersCtrl=this,$scope.ordersCtrl.paginate={page:0,rows:20,totalItems:0};var query=null;$scope.ordersCtrl.query={};var query=null;$scope.ordersCtrl.getList=function(page,rows){page!=$scope.ordersCtrl.paginate.page&&($scope.ordersCtrl.paginate.page=page),$scope.ordersCtrl.query.date={$gte:new Date($scope.ordersCtrl.dtfrom),$lte:new Date($scope.ordersCtrl.dtto)};for(var key in $scope.ordersCtrl.query)$scope.ordersCtrl.query[key]||delete $scope.ordersCtrl.query[key];if(Object.keys($scope.ordersCtrl.query).length>1){query={$and:[]};for(var key in $scope.ordersCtrl.query){var o={};"fio"==key?o["profile.fio"]=$scope.ordersCtrl.query[key]:o[key]=$scope.ordersCtrl.query[key],query.$and.push(o)}}else query=$scope.ordersCtrl.query;Orders.query({perPage:rows,page:page,query:query},function(res){0==page&&res.length>0&&($scope.ordersCtrl.paginate.totalItems=res.shift().index),$scope.ordersCtrl.orders=res})},$scope.ordersCtrl.deleteItem=function(item){confirm("Удалить?")&&Orders.delete({id:item._id},function(err){err&&console.log(err),$scope.ordersCtrl.getList($scope.ordersCtrl.paginate.page,$scope.ordersCtrl.paginate.rows)})},$scope.ordersCtrl.editItem=function(id){console.log(id),$state.go(state,{id:id,model:model})},$scope.dt=new Date,$scope.today=function(t){return t?new Date($scope.dt.setHours(0,0,0)):new Date($scope.dt.setHours(23,59,59))};var dtto=$scope.today(),dtfrom=$scope.today(!0);dtfrom.setDate(dtfrom.getDate()-30),$scope.clear=function(){$scope.ordersCtrl.dtto=dtto,$scope.ordersCtrl.dtfrom=dtfrom},$scope.clear(),$scope.openfrom=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedfrom=!0},$scope.opento=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedto=!0},$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],$scope.format=$scope.formats[0],$scope.ordersCtrl.getList($scope.ordersCtrl.paginate.page,$scope.ordersCtrl.paginate.rows)}]).controller("orderEditCtrl1",["$scope","OrdersNew","$resource","$stateParams","genericPrice","$state","priceFactory","Stuff",function($scope,Orders,$resource,$stateParams,genericPrice,$state,priceFactory,Stuff){$scope.orderEditCtrl=this,$scope.orderEditCtrl.stuff="",Orders.get({id:$stateParams.id},function(res){$scope.orderEditCtrl.order=res,$scope.orderEditCtrl.order.priceFactory=priceFactory,$scope.orderEditCtrl.order.priceFactory.init("order",$scope.orderEditCtrl.order),$scope.orderEditCtrl.order.coupon&&$scope.orderEditCtrl.order.coupon._id&&($scope.orderEditCtrl.coupon=$scope.orderEditCtrl.order.coupon._id),$scope.orderEditCtrl.order.kurs=$scope.orderEditCtrl.order.currencyStore[$scope.orderEditCtrl.order.currency][0],$scope.orderEditCtrl.order.cart.stuffs[0].priceSale=50,$scope.orderEditCtrl.order.cart.stuffs[0].currency="RUB",$scope.orderEditCtrl.order.genericPrice=new genericPrice("orderNew",$scope.orderEditCtrl.order)},function(err){});var now=Date.now(),query={$and:[{status:1},{dateto:{$gte:now}}]};$resource("/api/collections/Coupon/:id",{id:"@_id"}).query({query:query},function(res){res.shift(),$scope.orderEditCtrl.coupons=res}),$scope.orderEditCtrl.updateItem=function(order){$scope.orderEditCtrl.order.$save(),$state.go("frame.orders")},$scope.orderEditCtrl.changeCurrency=function(){$scope.orderEditCtrl.order.kurs=$scope.orderEditCtrl.order.currencyStore[$scope.orderEditCtrl.order.currency][0]},$scope.orderEditCtrl.changeCoupon=function(id){$scope.orderEditCtrl.coupon?$scope.orderEditCtrl.order.coupon=$scope.orderEditCtrl.coupons.getObjectFromArray("_id",id):$scope.orderEditCtrl.order.coupon=null},$scope.orderEditCtrl.selectStuff=function(stuff){for(var i=0,l=$scope.orderEditCtrl.order.cart.stuffs.length;i<l;i++){var s=$scope.orderEditCtrl.order.cart.stuffs[i];if(s.stuff==stuff.stuff){if(!(s.addCriterionName&&stuff.addCriterionName&&s.addCriterionName.length&&stuff.addCriterionName.length))return;if(s.addCriterionName[0]==stuff.addCriterionName[0]){if(1==s.addCriterionName.length&&1==stuff.addCriterionName.length)return;if(s.addCriterionName[1]==stuff.addCriterionName[1])return}}}$scope.orderEditCtrl.order.cart.stuffs.push(stuff),$scope.orderEditCtrl.order.cart.stuffs.sort(function(a,b){return a.groupUrl<b.groupUrl?-1:a.groupUrl>b.groupUrl?1:0})},$scope.orderEditCtrl.refresStuffs=function(search){search&&search.length>2&&Stuff.getList(null,search.substring(0,30),0,30,"fullListForAddToCart").then(function(res){res?($scope.orderEditCtrl.stuffs.length=0,res.forEach(function(el){$scope.orderEditCtrl.stuffs.push(el)})):$scope.orderEditCtrl.stuffs.length=0})},$scope.orderEditCtrl.stuffs=[]}]).controller("orders1Ctrl",["$scope","Orders","$modal","$resource",function($scope,Orders,$modal,$resource){$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.verbOrder="",$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave($scope.verbOrder))}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave($scope.verbOrder)}),$scope.q={brand:""},$scope.q.filterStatus="",$scope.filterFio="",$scope.filterNumber="",$scope.clients=!1;var getQuantity=function(){var s=0;return this.forEach&&"function"==typeof this.forEach&&this.forEach(function(el){s+=el.quantity}),console.log(s),s},getSum=function(){var s=0;return this.forEach&&"function"==typeof this.forEach&&this.forEach(function(el){s+=el.sum,el.shipCost&&(s+=el.shipCost)}),s},getDiscount=function(){var s=0;return this.forEach&&"function"==typeof this.forEach&&this.forEach(function(el){console.log(el.discount),el.discount&&(s+=el.discount)}),s};$scope.afterSave=function(verb){if(verb!=$scope.verbOrder&&($scope.verbOrder=verb,0!=$scope.paginate.page))return void($scope.paginate.page=0);$scope.clients="clients"==verb&&!0,$scope.summary="summary"==verb&&!0,$scope.stat="stat"==verb&&!0,$scope.orders=[],Orders.list({verb:verb,perPage:$scope.paginate.row,page:$scope.paginate.page,brand:$scope.q.brand,fio:$scope.filterFio,num:$scope.filterNumber,status:$scope.q.filterStatus,dtfrom:$scope.dtfrom,dtto:$scope.dtto},function(res){verb&&"clients"!=verb?($scope.paginate.page=0,$scope.paginate.totalItems=1):0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),verb&&"summary"==verb?(console.log(res[0]),$scope.orders=res[0].orders,$scope.summary={users:res[0].users},$scope.orders.getQuantity=getQuantity,$scope.orders.getSum=getSum,$scope.orders.getDiscount=getDiscount):($scope.orders=res,$scope.orders.getQuantity=getQuantity)})},$scope.clientsList=function(){$scope.afterSave("clients")},$scope.dt=new Date,$scope.today=function(t){return t?new Date($scope.dt.setHours(0,0,0)):new Date($scope.dt.setHours(23,59,59))},$scope.dtto=$scope.today(),$scope.dtfrom=$scope.today(!0),$scope.dtfrom.setDate($scope.dtfrom.getDate()-30),console.log($scope.dtfrom),$scope.clear=function(){$scope.dtto=$scope.dtfrom=null},$scope.openfrom=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedfrom=!0},$scope.opento=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedto=!0},$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],$scope.format=$scope.formats[0],$scope.getList=function(verb){$scope.afterSave(verb)},$scope.getStatusClass=function(status){return status==$scope.q.filterStatus},$scope.newOrder=function(){$modal.open({templateUrl:"manager/views/templates/users.html",controller:ModalInstanceCtrl,windowClass:"xx-dialog"}).result.then(function(data){console.log("Уведомление",data);var newOrder=new Orders({user:data._id,profile:data.profile});console.log(newOrder),newOrder.$save({newOrder:"newOrder"},function(){$scope.afterSave()})},function(){console.log("Modal dismissed at: "+Date.now())})};var ModalInstanceCtrl=function($scope,$modalInstance,User,$resource){$resource("/api/config").get(function(res){$scope.config=res,$scope.config.clients.push("admin"),$scope.config.clients.push("brandAdmin")}),$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.query={},$scope.ModalInstanceCtrl={},$scope.ModalInstanceCtrl.fio="",$scope.ModalInstanceCtrl.name="",$scope.ModalInstanceCtrl.email="",$scope.afterSave=function(){console.log($scope.fio),$scope.ModalInstanceCtrl.fio&&($scope.query.fio=$scope.ModalInstanceCtrl.fio.substring(0,50)),$scope.ModalInstanceCtrl.name&&($scope.query.name=$scope.ModalInstanceCtrl.name.substring(0,50)),$scope.ModalInstanceCtrl.email&&($scope.query.email=$scope.ModalInstanceCtrl.email.substring(0,50)),User.list({perPage:$scope.paginate.row,page:$scope.paginate.page,fio:$scope.ModalInstanceCtrl.fio.substring(0,50),name:$scope.ModalInstanceCtrl.name.substring(0,50),email:$scope.ModalInstanceCtrl.email.substring(0,50),newOrder:"newOrder"},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.users=res})},$scope.add=function(data){$modalInstance.close(data)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}}]).controller("couponCtrl",["$scope","$resource",function($scope,$resource){var Items=$resource("/api/collections/Coupon/:id",{id:"@_id"});$resource("/api/collections/FilterTags").query(function(res){res.shift(),$scope.filterTags=res}),$resource("/api/collections/Brand").query(function(res){res.shift(),$scope.brands=res}),$resource("/api/collections/Seller").query(function(res){res.shift(),$scope.sellers=res}),$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"},$scope.dt=new Date,$scope.dtto=new Date($scope.dt.setHours(23,59,59)),$scope.setDate=function(){return $scope.dtto.setDate($scope.dtto.getDate()+30)},$scope.opento=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedto=!0},$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],$scope.format=$scope.formats[0],$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item,item||($scope.item={stuffs:[],dateto:$scope.setDate()}),$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){
0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.addStuff=function(s){console.log(s),$scope.item.stuffs.push({stuff:s.stuff,size:s.size,name:s.name,sizeName:s.sizeName})},$scope.deleteStuff=function(i){$scope.item.stuffs.splice(i,1)}}]).controller("siteMapCtrl",["$scope","$rootScope","$http",function($scope,$rootScope,$http){$http.get("/api/siteMAP").then(function(res){$scope.done=!0,console.log(res)})}]).controller("siteMap1Ctrl",["$scope","$rootScope","$http",function($scope,$rootScope,$http){$http.get("/api/siteMAP1").then(function(res){$scope.done=!0,console.log(res)})}]).controller("promCtrl",["$scope","$rootScope","$http",function($scope,$rootScope,$http){$http.get("/api/prom").then(function(res){$scope.done=!0,console.log(res)})}]).controller("promUpdateCtrl",["$scope","$rootScope","$http",function($scope,$rootScope,$http){$http.get("/api/promUpdate").then(function(res){$scope.done=!0,console.log(res)})}]).controller("editCommentsCtrl",["$scope","$resource","$timeout",function($scope,$resource,$timeout){function afterSave(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})}var Items=$resource("/api/collections/Comment/:id",{id:"@_id"});$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&afterSave()}),$scope.updateItem=function(item){Items.save(item,function(err){afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&Items.delete({id:item._id},function(err){err&&console.log(err),afterSave()})},$scope.getStuffName=function(comment){Items.get({id:comment._id,query:"stuffname"},function(res){comment.stuff=res.parent})}}]).controller("wlCtrl",["$scope","$resource",function($scope,$resource){var Items=$resource("/api/addCollections/wishlist/:id",{id:"@_id"});$scope.Items=Items,$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"50%"},$scope.groupSetup4={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"},$scope.brand=null,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()});var gc=function(){return this.reduce(function(prev,el){return prev+=el.count},0)};$scope.afterSave=function(){var query=$scope.brand?{brand:$scope.brand}:null;Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page,dtfrom:$scope.dtfrom,dtto:$scope.dtto,query:query},function(res){$scope.items=res,$scope.item=null,$scope.disEdit=!0,$scope.items.getCount=gc})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&Items.delete({stuff:item.stuff,size:item.sizeId},function(res){$scope.afterSave()})},$scope.dt=new Date,$scope.today=function(t){return t?new Date($scope.dt.setHours(0,0,0)):new Date($scope.dt.setHours(23,59,59))},$scope.dtto=$scope.today(),$scope.dtfrom=$scope.today(!0),$scope.clear=function(){$scope.dtto=$scope.dtfrom=null},$scope.openfrom=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedfrom=!0},$scope.opento=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedto=!0},$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],$scope.format=$scope.formats[0],$scope.getList=function(){console.log($scope.dtfrom,$scope.dtto),$scope.afterSave()},$scope.hoverIn=function(item){var ob={stuff:item.stuff,size:item.sizeId};$resource("/api/addCollections/wishlist/:stuff/:size",{stuff:"@stuff",size:"@size"}).query(ob,function(res){item.details=res,item.showDetail=!0})},$scope.hoverOut=function(item){item.showDetail=!1}}]).controller("correctPriceCtrl",["$scope","$resource","$http",function($scope,$resource,$http){$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"},$scope.groupSetup1={formatSearching:"Searching the categories...",formatNoMatches:"Не найдено",width:"100%"};var Stuff=$resource("/api/collections/Stuff/:id",{id:"@id"});$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.brand=null,$scope.category=null,$scope.paginate={page:0,row:100,totalItems:0},$scope.sum=!0,$scope.plus=!0,$scope.newRetail=0,$scope.newPrice=0,$scope.all=!1,$scope.$watch("all",function(n,o){n!=o&&$scope.stuffs&&$scope.stuffs.forEach(function(el){el.correct=$scope.all})}),$scope.$watch("paginate.page",function(n,o){$scope.brand&&0!=$scope.paginate.row&&$scope.afterSave()}),$scope.$watch("paginate.row",function(n,o){n&&n!=o&&($scope.paginate.page>0?$scope.paginate.page=0:(console.log($scope.paginate,n,o),$scope.afterSave()))}),$scope.afterSave=function(){if($scope.brand){var query={brand:$scope.brand};$scope.category&&(query.category=$scope.category),Stuff.query({perPage:$scope.paginate.row,page:$scope.paginate.page,query:query},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.stuffs=res})}},$scope.categories=[],$scope.changeBrand=function(){$scope.brand&&($resource("/api/collections/Brand/:id",{id:"@_id"}).get({id:$scope.brand},function(res){$scope.categories=res.categories}),$scope.afterSave())},$scope.$watch("category",function(n,o){(n||o)&&$scope.afterSave()}),$scope.changeCategory=function(){},$scope.updateItem=function(item){item.$save({update:"price retail"},function(res){$scope.afterSave()})},$scope.correctForGroup=function(){if($scope.newPrice||$scope.newRetail){var arr=[];$scope.stuffs.forEach(function(el){el.correct&&arr.push(el._id)});var update="update=";$scope.newPrice&&(update+="price"),$scope.newRetal&&($scope.newPrice&&(update+=" "),update+="retail"),$http.post("/api/collections/Stuff?update=price retail&sum="+$scope.sum+"&plus="+$scope.plus+"&retail="+$scope.newRetail+"&price="+$scope.newPrice,arr).then(function(res){$scope.afterSave()})}},$scope.getPrice=function(price,retail){return retail-price<0}}]).controller("subscribeCtrl",["$scope","$resource","$window",function($scope,$resource,$window){$resource("/api/collections/Coupon/:id").query(function(res){res.shift(),$scope.coupons=res}),$resource("/api/config").get(function(res){$scope.clients=res.clients}),$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"},$scope.groupSetup1={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"};var Items=$resource("/api/collections/Subscribe/:id",{id:"@_id"});$scope.Items=Items,$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.brand=null,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.preViewItem=function(item){$resource("/api/subscribeAdd/createFile/:id",{id:"@_id"}).get({id:item._id},function(){var path="/subscribe/"+item._id+".html";console.log(path);$window.open(path)})},$scope.sendItem=function(item){confirm("Отправить?")&&(item.dateSend=Date.now(),$resource("/api/subscribeAdd/sendSubscribe/:id",{id:"@_id"}).get({id:item._id},function(data){alert("everything is ok."+data.q+" sent!!!")}))},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){if($scope.brand="",$scope.category="",$scope.categories=[],$scope.stuffs=[],$scope.photos=[],$scope.focusInputDesc=[],item.stuffs&&item.stuffs.length)for(var i=0,l=item.stuffs.length;i<l;i++)item.stuffs[i].stuff=item.stuffs[i].stuff._id;if(item.descs&&item.descs.length)for(var i=0,l=item.descs.length;i<l;i++)item.descs[i]?item.descs[i]=item.descs[i].substring(0,1e3):item.descs.splice(i,1);item.coupon||(item.coupon=null),Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(res){$scope.afterSave()})},$scope.editItem=function(item){$scope.category="",$scope.brand="",$scope.stuffs=[],$scope.item=item?item:{type:1},$scope.categories=[],$scope.photos=[],$scope.focusInputDesc=[],$scope.disEdit=!1,item&&($scope.item=Items.get({id:item._id},function(res){$scope.item.headImage||($scope.item.headImage="dd"),$scope.item.fon||($scope.item.fon="dd1"),$scope.item.coupon&&($scope.item.coupon=$scope.item.coupon._id),console.log(item)}))},$scope.changeBrand=function(brand){brand&&$resource("/api/collections/Brand/:id",{id:"@_id"}).get({id:brand},function(res){$scope.categories=res.categories})},$scope.paginateModal={page:0,row:100,totalItems:0},$scope.$watch("paginateModal.page",function(n,o){$scope.category&&$scope.changeCategory($scope.category)});var Stuff=$resource("/api/collections/Stuff/:id",{id:"@id"});$scope.changeCategory=function(category){if(category&&$scope.brand){var query=JSON.stringify({category:category,brand:$scope.brand});$scope.stuffs=[],Stuff.query({query:query,page:$scope.paginateModal.page,perPage:$scope.paginateModal.row},function(resModal){0==$scope.paginateModal.page&&resModal.length>0&&($scope.paginateModal.totalItems=resModal.shift().index);var name;$scope.stuffs=resModal.map(function(stuff){return name=stuff.name,stuff.artikul&&(name=name+" "+stuff.artikul),stuff.name=name,stuff})})}},$scope.getGallery=function(stuff){stuff&&($scope.stuff=stuff,$scope.photos=$scope.stuff.gallery)},$scope.addPhoto=function(index){$scope.item.stuffs||($scope.item.stuffs=[]),$scope.item.stuffs.push({stuff:$scope.stuff,img:index})},$scope.quant=_.range(1,51)}]).controller("subscribeFromFileCtrl",["$scope","$resource","$window",function($scope,$resource,$window){var Item=$resource("/api/subscribeAdd/sendSubscribeFromFile");$resource("/api/collections/Subscribe").query(function(res){res.shift(),$scope.sbs=res}),$scope.sbCtrl={},$scope.all=!0,$scope.sbCtrl.item={list:[],sbCode:""},$scope.send=function(){if(!$scope.sbCtrl.item.sbCode)return void alert("рассылка?");Item.save({list:$scope.sbCtrl.item.list.filter(function(e){return e.use}).map(function(e){return{name:e.name,email:e.email,profile:e.profile}}),sbCode:$scope.sbCtrl.item.sbCode},function(res){alert("Всего - "+res.num+",отправленео - "+res.send)})},$scope.markUsers=function(label){$scope.sbCtrl.item.list.forEach(function(el){el.use=label})},$scope.changeSb=function(c){console.log(c)}}]).controller("landingCtrl",["$scope","$resource","$window",function($scope,$resource,$window){$resource("/api/collections/Coupon/:id").query(function(res){res.shift(),$scope.coupons=res}),$resource("/api/config").get(function(res){$scope.clients=res.clients}),$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"},$scope.groupSetup1={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"};var Items=$resource("/api/collections/Landing/:id",{id:"@_id"});$scope.Items=Items,$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.brand=null,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.preViewItem=function(item){$resource("/api/landingAdd/createFile/:id",{id:"@_id"}).get({id:item._id},function(){var path="/landing/"+item._id+".html";$window.open(path)})},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){if($scope.brand="",$scope.category="",$scope.categories=[],$scope.stuffs=[],$scope.photos=[],$scope.focusInputDesc=[],item.stuffs&&item.stuffs.length)for(var i=0,l=item.stuffs.length;i<l;i++)item.stuffs[i].stuff=item.stuffs[i].stuff._id;if(item.descs&&item.descs.length)for(var i=0,l=item.descs.length;i<l;i++)item.descs[i]?item.descs[i]=item.descs[i].substring(0,1e3):item.descs.splice(i,1);item.coupon||(item.coupon=null),Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(res){$scope.afterSave()})},$scope.editItem=function(item){$scope.category="",$scope.brand="",$scope.stuffs=[],$scope.item=item?item:{type:1},$scope.categories=[],$scope.photos=[],$scope.focusInputDesc=[],$scope.disEdit=!1,item&&($scope.item=Items.get({id:item._id},function(){$scope.item.coupon&&($scope.item.coupon=$scope.item.coupon._id)}))},$scope.changeBrand=function(brand){brand&&$resource("/api/collections/Brand/:id",{id:"@_id"}).get({id:brand},function(res){$scope.categories=res.categories})},$scope.paginateModal={page:0,row:100,totalItems:0},$scope.$watch("paginateModal.page",function(n,o){$scope.category&&$scope.afterSaveModal()});var Stuff=$resource("/api/collections/Stuff/:id",{id:"@id"});$scope.changeCategory=function(category){if(category&&$scope.brand){var query=JSON.stringify({category:category,brand:$scope.brand});$scope.stuffs=[],Stuff.query({query:query,page:$scope.paginateModal.page,perPage:$scope.paginateModal.row},function(resModal){0==$scope.paginateModal.page&&resModal.length>0&&($scope.paginateModal.totalItems=resModal.shift().index);var name;$scope.stuffs=resModal.map(function(stuff){return name=stuff.name,stuff.artikul&&(name=name+" "+stuff.artikul),stuff.name=name,stuff})})}},$scope.getGallery=function(stuff){stuff&&($scope.stuff=stuff,$scope.photos=$scope.stuff.gallery)},$scope.addPhoto=function(index){$scope.item.stuffs||($scope.item.stuffs=[]),$scope.item.stuffs.push({stuff:$scope.stuff,img:index})},$scope.quant=_.range(1,51)}]).controller("invoiceCtrl",["$scope","$resource","$modal",function($scope,$resource,$modal){$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"50%"},$scope.groupSetup1={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"};var Items=$resource("/api/collections/Invoice/:id",{id:"@_id"});$scope.Items=Items,$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"50%"},$scope.brand=null,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()});var gc=function(){return this.list.reduce(function(prev,el){return prev+=el.quantity},0)},gs=function(){return this.list.reduce(function(prev,el){return prev+=el.quantity*el.price},0).toFixed(2)};$scope.afterSave=function(){console.log($scope.dtfrom+"  "+$scope.dtto);var query=$scope.brand?{brand:$scope.brand}:null;Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page,dtfrom:$scope.dtfrom,dtto:$scope.dtto,query:query},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0,$scope.stuffs=[];for(var i=0,l=$scope.items.length;i<l;i++)$scope.items[i].getCount=gc,$scope.items[i].getSum=gs})},$scope.categories=[],$scope.editItem=function(item){$scope.category="",$scope.item=item?item:{},$scope.item.brand&&$scope.item.brand._id&&($scope.item.brandEdit=$scope.item.brand._id,$resource("/api/collections/Brand/:id",{id:"@_id"}).get({id:$scope.item.brand._id},function(res){$scope.categories=res.categories})),$scope.disEdit=!1},$scope.updateItem=function(item){$scope.category="",$scope.categories=[],item.brand=item.brandEdit,Items.save(item,function(res){$scope.afterSave()})},$scope.doInvoice=function(item){item.status=1,$scope.updateItem(item)},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(res){$scope.afterSave()})},$scope.dt=new Date,$scope.today=function(t){return t?new Date($scope.dt.setHours(0,0,0)):new Date($scope.dt.setHours(23,59,59))},$scope.dtto=$scope.today(),$scope.dtfrom=$scope.today(!0),$scope.dtfrom=$scope.today(!0),$scope.clear=function(){$scope.dtto=$scope.dtfrom=null},$scope.openfrom=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedfrom=!0},$scope.opento=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.openedto=!0},$scope.dateOptions={formatYear:"yy",startingDay:1},$scope.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],$scope.format=$scope.formats[0],$scope.getList=function(){console.log($scope.dtfrom,$scope.dtto),$scope.afterSave()},$scope.paginateModal={page:0,row:100,totalItems:0},$scope.$watch("paginateModal.page",function(n,o){$scope.category&&$scope.afterSaveModal()});var Stuff=$resource("/api/collections/Stuff/:id",{id:"@id"});$scope.afterSaveModal=function(){if($scope.category){var query=JSON.stringify({category:$scope.category,brand:$scope.item.brand._id});$scope.stuffs=[],Stuff.query({query:query,page:$scope.paginateModal.page,perPage:$scope.paginateModal.row},function(resModal){0==$scope.paginateModal.page&&resModal.length>0&&($scope.paginateModal.totalItems=resModal.shift().index),$scope.stuffList=[];var name;resModal.forEach(function(stuff){for(var size in stuff.store)name=stuff.name,stuff.artikul&&(name=name+" "+stuff.artikul),$scope.stuffList[$scope.stuffList.length]={size:size,sizeName:stuff.store[size].name,stuff:stuff._id,name:name,quantity:1,price:stuff.price}}),$scope.stuffs=$scope.stuffList})}},$scope.addStuff=function(stuff){stuff&&($scope.item.list.some(function(el){return el.stuff==stuff.stuff&&el.size==stuff.size})||$scope.item.list.unshift(stuff))},$scope.quant=_.range(1,51)}]).controller("discountCtrl",["$scope","$resource",function($scope,$resource){var Items=$resource("/api/collections/Discount/:id",{id:"@_id"});$scope.discountCtrl=this,$scope.discountCtrl.globalFunction=globalFunction,$resource("/api/collections/Brand/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.brands=res}),$scope.groupSetup={formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.discountCtrl.cols=[1,2,3,4,5],$scope.$watch("discountCtrl.item.cols",function(n,o){if(n&&$scope.discountCtrl.item.cascade.length!=n){$scope.discountCtrl.item.cascade=[];for(var i=0,l=n;i<l;i++){var t=5*$scope.discountCtrl.cols[i];$scope.discountCtrl.item.cascade.push([t,t])}}}),angular.extend(this,{notUse:function(id){if($scope.items&&$scope.items.length){return $scope.items.some(function(el){return el.brand._id==id})}return!1}}),$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.discountCtrl.item=item?Items.get({id:item._id}):{cols:1,cascade:[[5,5]]},$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.discountCtrl.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave(),$scope.discountCtrl.item=null})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})}}]).controller("partnerCtrl",["$scope","$resource","$timeout",function($scope,$resource,$timeout){function _updateBrands(){Brand.query(function(res){res.shift(),_brands=res,$scope.brands=_brands.filter(function(el){return!el.partner})})}$scope.partnerCtrl=this,$scope.disEdit=!0;var _brands,Items=$resource("/api/collections/Partner/:id",{id:"@_id"}),Brand=$resource("/api/collections/Brand/:id",{id:"@_id"});_updateBrands(),$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.afterSave=function(){$scope.groups=Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res})},$scope.deleteBrandFromGroup=function(brand,i){$scope.partnerCtrl.item&&($scope.partnerCtrl.item.brands.splice(i,1),$scope.partnerCtrl.item.pay[brand]&&delete $scope.partnerCtrl.item.pay[brand],Items.save({update:"brands pay"},$scope.partnerCtrl.item),Brand.save({update:"partner"},{_id:brand,partner:null},function(res){_updateBrands()}))},$scope.editGroup=function(item){if($scope.disEdit=!1,$scope.partnerCtrl.item=item,!$scope.partnerCtrl.item){$scope.partnerCtrl.item={},$scope.partnerCtrl.item.name="Новая группа";for(var is=!0,j=1;is&&$scope.partnerCtrl.items;){is=!1;for(var i=0,l=$scope.partnerCtrl.items.length;i<l;i++)if($scope.partnerCtrl.items[i].name==$scope.partnerCtrl.item.name){is=!0,$scope.partnerCtrl.item.name+=" "+j,j++;break}}Items.save($scope.partnerCtrl.item,function(res){res.id&&($scope.partnerCtrl.item._id=res.id),$scope.afterSave()})}},$scope.getBrandName=function(id){for(var i=0,l=_brands.length;i<l;i++)if(id==_brands[i]._id)return _brands[i].name;return"noname"},$scope.addBrandInGroup=function(brand){console.log(brand),$scope.partnerCtrl.item&&($scope.partnerCtrl.item.brands||($scope.partnerCtrl.item.brands=[]),$scope.partnerCtrl.item.brands.push(brand),Items.save({update:"brands"},$scope.partnerCtrl.item),Brand.save({update:"partner"},{_id:brand,partner:$scope.partnerCtrl.item._id},function(res){_updateBrands()}))},$scope.updateGroup=function(){Items.save($scope.partnerCtrl.item,function(res){})},$scope.doneGroup=function(){if($scope.partnerCtrl.item.pay)for(var key in $scope.partnerCtrl.item.pay)$scope.partnerCtrl.item.pay[key]&&$scope.partnerCtrl.item.pay[key]!=key||delete $scope.partnerCtrl.item.pay[key];$scope.partnerCtrl.item.name&&Items.save({update:"name pay opt"},$scope.partnerCtrl.item),$scope.disEdit=!0,$scope.partnerCtrl.item={},$scope.afterSave()},$scope.deleteGroup=function(item){if(confirm("Удалить?")){if(item.brands.length>0)return void alert("Удалите сначала бренды из группы");$scope.disEdit=!0,item.$delete(function(err){err&&console.log(err),$scope.afterSave()})}}}]).controller("articlesCtrl",["$scope","$resource","$state",function($scope,$resource,$state){var Items=$resource("/api/collections/Article/:id",{id:"@_id"});$resource("/api/collections/Section/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.sections=res}),$resource("/api/collections/SectionTags/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.sectionTags=res}),$scope.type="Article",$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item?Items.get({id:item._id}):{},$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){if(item.descs&&item.descs.length)for(var i=0,l=item.descs.length;i<l;i++)item.descs[i]?item.descs[i]=item.descs[i].substring(0,5e3):item.descs.splice(i,1);Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(res){$scope.afterSave()})},$scope.editGallery=function(news){var id=news?news._id:"";$state.transitionTo("frame.article.gallery",{id:id})},$scope.shareSN={sn:{g:!1,f:!1}},$scope.shareSN.doIt=function(item){console.log(item),$resource("/api/sharePost/").save({},function(res){console.log(res)})}}]).controller("articleGalleryCtrl",["$scope","$fileUpload","$http","$timeout","$resource","$stateParams","$state",function($scope,$fileUpload,$http,$timeout,$resource,$stateParams,$state){$scope.type="Article";var Items=$resource("/api/collections/Article/:id",{id:"@id"});$scope.photoIndexArrayNew=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],$scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],$scope.photoIndex=1,$scope.mainFilterTag="",$scope.gallery=[],Items.get({id:$stateParams.id},function(res){$scope.item=res,console.log(res),$scope.gallery=res.gallery}),$scope.deletePhoto=function(index){confirm("Удалить?")&&$http.get("/api/collections/Article/fileGalleryDelete/"+$scope.item._id+"/"+index).then(function(response){alert(response.data.msg),$scope.gallery=[],$timeout(function(){$scope.gallery=response.data.gallery},10)})},$scope.updateGallery=function(){$http.post("/api/collections/Article/fileGalleryUpdate/"+$scope.item._id,{gallery:$scope.gallery}).then(function(response){alert(response.data.msg),$scope.gallery=response.data.gallery})},$scope.backToList=function(){$state.transitionTo("frame.article")}}]).controller("sectionsCtrl",["$scope","$resource","$state",function($scope,$resource,$state){var Items=$resource("/api/collections/Section/:id",{id:"@_id"}),ItemsTag=$resource("/api/collections/SectionTags/:id",{id:"@_id"});$scope.Items=Items,$resource("/api/collections/Category/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.categories=res}),$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.item=item,$scope.disEdit=!1,$scope.afterSaveTag()},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item={},$scope.item.city="",$scope.disEdit=!0,$scope.noLoad=!0,$scope.noChange=!0,$scope.afterSaveTag()})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.editItemTag=function(itemTag){$scope.itemTag=itemTag},$scope.afterSaveTag=function(){if(!$scope.item||!$scope.item._id)return void($scope.itemsTag=null);var query;query={query:{section:$scope.item._id}},ItemsTag.query(query,function(res){res.length>0&&res.shift(),$scope.itemsTag=res,$scope.itemTag=null})},$scope.updateItemTag=function(itemTag){if(!itemTag||!itemTag.name)return void alert("надо что-то ввести!");itemTag._id||(itemTag.section=$scope.item._id),ItemsTag.save(itemTag,function(res){$scope.afterSaveTag()})},$scope.deleteItemTag=function(itemTag){confirm("Удалить?")&&itemTag.$delete(function(err){err&&console.log(err),$scope.afterSaveTag()})}}]).controller("seopageCtrl",["$scope","$resource","global","anchorSmoothScroll","model","$timeout",function($scope,$resource,global,anchorSmoothScroll,model,$timeout){function getClearName(name){if(name)return name.replace(/(["'\/\s])/g,"-")}var Items=$resource("/api/collections/"+model+"/:id",{id:"@_id"});$resource("/api/collections/SeopageTemplate/:id",{id:"@_id"}).query(function(res){res.shift(),$scope.seopageCtrl.templates=res}),$scope.seopageCtrl=this,$scope.seopageCtrl.brands=global.get("brands"),$scope.seopageCtrl.categories=global.get("categories").val,$scope.seopageCtrl.filters=global.get("filters"),$scope.seopageCtrl.filterTags=global.get("filterTags"),$scope.seopageCtrl.m={},$scope.seopageCtrl.m.getName=function(){var brandName,brandUrl,categoryName,categoryUrl,filterTagsUrl,filterTagsName,brand=$scope.item.brand?globalFunction.getObjectFromArray(global.get("brands").val,"_id",$scope.item.brand):null,category=$scope.item.category?globalFunction.getObjectFromArray(global.get("categories").val,"_id",$scope.item.category):null,filterTags=$scope.item.filterTags?globalFunction.getObjectFromArray(global.get("filterTags").val,"_id",$scope.item.filterTags):null;$scope.seopageCtrl.categories=brand?brand.categories.map(function(el){return globalFunction.getObjectFromArray(global.get("categories").val,"_id",el)}):global.get("categories").val,brand?(brandName=brand.name,brandUrl="/"+brand.url):(brandName="",brandUrl="/brand"),category?(categoryName=category.name,categoryUrl="/"+getClearName(category.name)+"/"+category.url):(categoryName="",categoryUrl="/category/id"),filterTags?(filterTagsName=filterTags.name,filterTagsUrl="?queryTag="+filterTags.url):(filterTagsName="",filterTagsUrl=""),$scope.item.name=brandName+" "+categoryName+" "+filterTagsName,$scope.item.url=brandUrl+categoryUrl+filterTagsUrl},$scope.setCatalogPage=function(){$scope.item.brand="",$scope.item.category="",$scope.item.filterTags="",$scope.item.brandTag="",$scope.seopageCtrl.m.getName(),$scope.item.name="каталог"},$scope.setHomePage=function(){$scope.item.name="главная страница",$scope.item.url="/home"},$scope.handEnter=function(){$scope.seopageCtrl.handlBlock=!0},$scope.seopageCtrl.m.cancel=function(){$scope.seopageCtrl.handlBlock=!1,$scope.item=null,$scope.disEdit=!0},$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){if(item){$scope.item=item;var brand=$scope.item.brand?globalFunction.getObjectFromArray(global.get("brands").val,"_id",$scope.item.brand):null;$scope.seopageCtrl.categories=brand?brand.categories.map(function(el){return globalFunction.getObjectFromArray(global.get("categories").val,"_id",el)}):global.get("categories").val}else $scope.item={},$scope.seopageCtrl.categories=global.get("categories").val;$scope.disEdit=!1},$scope.afterSave=function(id){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0,id&&$timeout(function(){anchorSmoothScroll.scrollTo(id)},300)})},$scope.updateItem=function(item){$scope.seopageCtrl.handlBlock=!1,Items.save(item,function(res){$scope.afterSave(res.id)},function(err){err&&alert(err.data.error)})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){
err&&console.log(err),$scope.afterSave()})}}]).controller("SyncButtonsController",function($scope){$scope.onSubmit=function(){console.log("onSubmit data in sync controller",$scope.editor.getValue())},$scope.onAction2=function(){console.log("onAction2")},$scope.changeSchema=function(){$scope.schema.properties.height={required:!0,title:"Height",type:"integer"}}}),angular.module("gmall.controllers").controller("witgetCtrl",["$scope","$resource","$upload",function($scope,$resource,$upload){var Items=$resource("/api/collections/Witget/:id",{id:"@_id"});$scope.groupSetup={multiple:!0,formatSearching:"Searching the group...",formatNoMatches:"Не найдено",width:"50%"},$scope.Items=Items,$scope.paginate={page:0,row:0,totalItems:0},$scope.$watch("paginate.row",function(n,o){n&&($scope.paginate.page>0?$scope.paginate.page=0:$scope.afterSave())}),$scope.$watch("paginate.page",function(n,o){0!=$scope.paginate.row&&$scope.afterSave()}),$scope.editItem=function(item){$scope.focusInput=!0,$scope.item=item,$scope.disEdit=!1},$scope.afterSave=function(){Items.query({perPage:$scope.paginate.row,page:$scope.paginate.page},function(res){0==$scope.paginate.page&&res.length>0&&($scope.paginate.totalItems=res.shift().index),$scope.items=res,$scope.item=null,$scope.disEdit=!0})},$scope.updateItem=function(item){Items.save(item,function(res){$scope.afterSave()})},$scope.updateFromList=function(item){item.$save(item,function(res){$scope.afterSave()})},$scope.deleteItem=function(item){confirm("Удалить?")&&item.$delete(function(err){err&&console.log(err),$scope.afterSave()})},$scope.getListWitgetAuth=function(w){return 2!=w.whom},$scope.getListWitgetNotAuth=function(w){return 1!=w.whom},$scope.tinymceOptions={resize:!1,width:"100%",height:300,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste "],content_css:"/bower_components/bootstrap/dist/css/bootstrap.css,/style/style.css",toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"},$scope.myFiles=[],$scope.$watch("myFiles",function(){for(var i=0;i<$scope.myFiles.length;i++){var file=$scope.myFiles[i];$scope.upload=$upload.upload({url:"api/server/uploadFile",data:{myObj:$scope.myModelObj},file:file}).progress(function(evt){console.log("progress: "+parseInt(100*evt.loaded/evt.total)+"% file :"+evt.config.file.name)}).success(function(data,status,headers,config){console.log("file "+config.file.name+"is uploaded successfully. Response: "+data)})}})}]),angular.module("gmall.filters",[]).filter("interpolate",function(version){return function(text){return String(text).replace(/\%VERSION\%/gm,version)}}).filter("cut",function(){return function(value,wordwise,max,tail){if(!value)return"";if(!(max=parseInt(max,10)))return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");lastspace!=-1&&(value=value.substr(0,lastspace))}return value+(tail||"")}}).filter("filterSection",function(version){return function(input,sectionId){if(0==sectionId)return input;var temp=[];return angular.forEach(input,function(item){item.category==sectionId&&temp.push(item)}),temp}}),angular.module("gmall.directives",[]).directive("fileReadSrc",["$parse","$timeout",function($parse,$timeout){return{restrict:"A",scope:{fileSrc:"=fileReadSrc",myFile:"="},link:function(scope,element,attrs){element.bind("change",function(changeEvent){var reader=new FileReader;reader.onload=function(loadEvent){scope.$apply(function(){$timeout(function(){scope.fileSrc=loadEvent.target.result})})},scope.myFile=changeEvent.target.files[0],reader.readAsDataURL(changeEvent.target.files[0])})}}}]).directive("loadImage",["$fileUpload","$timeout",function($fileUpload,$timeout){return{restrict:"AE",scope:{noLoad:"=noLoad",noChange:"=noChange",uploadUrl:"@",itemId:"@",fileSrc:"=",Item:"=itemResourse",gallery:"=",nameImg:"@"},templateUrl:"manager/views/templates/loadimage.html",link:function(scope,element,attrs){scope.now=Date.now(),scope.nameImg||(scope.nameImg="img"),scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,100],scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.clickFile=function(){var id="#imagefile"+scope.now;console.log(id),angular.element(id).trigger("click")},scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0,$fileUpload.uploadFileToUrl(file,scope.uploadUrl,scope.itemId,{index:scope.index,nameImg:scope.nameImg}).then(function(res){scope.myFile=null,console.log(res),scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=res.data.img,$timeout(function(){scope.gallery=res.data.gallery},10)})}},scope.deleteImg=function(){scope.itemId&&(scope.noChange=!0,scope.fileSrc="",scope.Item.delete({id:scope.itemId,file:"file"},function(res){scope.noChange=!1,scope.noLoad=!0,alert(res.msg)}))}}}}]).directive("loadImageWithLink",["$fileUpload","$timeout","$http",function($fileUpload,$timeout,$http){return{restrict:"AE",scope:{noLoad:"=noLoad",noChange:"=noChange",uploadUrl:"@",itemId:"@",fileSrc:"=",additionUrl:"@",Item:"=itemResourse",gallery:"="},templateUrl:"manager/views/templates/loadimagewithlinks.html",link:function(scope,element,attrs){var additionUrl=scope.additionUrl?scope.additionUrl:"Subscribe";scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12,100],scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.link="",scope.index=1,scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0,$fileUpload.uploadFileToUrl(file,scope.uploadUrl,scope.itemId,{index:scope.index,link:scope.link}).then(function(res){scope.myFile=null,scope.link="",scope.index=1,console.log(res),scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=res.data.img,$timeout(function(){scope.gallery=res.data.gallery},10)})}},scope.deleteImg=function(){scope.itemId&&(scope.noChange=!0,scope.fileSrc="",scope.Item.delete({id:scope.itemId,file:"file"},function(res){scope.noChange=!1,scope.noLoad=!0,alert(res.msg)}))},scope.deletePhoto=function(index){confirm("Удалить?")&&$http.get("/api/collections/"+additionUrl+"/fileGalleryDelete/"+scope.itemId+"/"+index).then(function(response){scope.gallery=response.data.gallery})},scope.updateStuffGallery=function(){$http.post("/api/collections/"+additionUrl+"/fileGalleryUpdate/"+scope.itemId,{gallery:scope.gallery}).then(function(response){scope.gallery=response.data.gallery})}}}}]).directive("loadImageBig",["$fileUpload","$timeout",function($fileUpload,$timeout){return{restrict:"AE",scope:{noLoad:"=noLoad",noChange:"=noChange",uploadUrl:"@",itemId:"@",fileSrc:"=",Item:"=itemResourse",nameImage:"@"},templateUrl:"manager/views/templates/loadimagebig.html",link:function(scope,element,attrs){scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.clickOnUpload=function(id){$timeout(function(){angular.element("#"+id).trigger("click")},100)},scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0,$fileUpload.uploadFileToUrl(file,scope.uploadUrl,scope.itemId,{nameImg:scope.nameImage}).then(function(res){scope.myFile=null,scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=res.data.img,$timeout(function(){scope.fileSrc=res.data.img},10)})}},scope.deleteImg=function(){scope.itemId&&(scope.noChange=!0,scope.fileSrc="",scope.Item.delete({id:scope.itemId,file:scope.nameImage},function(res){scope.noChange=!1,scope.noLoad=!0,alert(res.msg)}))}}}}]).directive("focusMe",function($timeout){return{scope:{trigger:"=focusMe"},link:function(scope,element){scope.$watch("trigger",function(value){value===!0&&($timeout(function(){element[0].focus()},50),scope.trigger=!1)})}}}).directive("hoverImg",function(){return{restrict:"A",scope:{hoverImg:"@",hoverThumb:"@"},link:function(scope,element,attrs){element.on("mouseenter",function(){attrs.$set("src","http://localhost:8090/"+scope.hoverImg)})}}}).directive("editInPlace",function(){return{restrict:"E",scope:{value:"=",done:"&"},template:'<span class="todoName" ng-click="edit()" ng-bind="value"></span><input  ng-model="value">',link:function($scope,element,attrs){$scope.$watch("value",function(n,o){});var inputElement=angular.element(element.children()[1]);element.addClass("edit-in-place"),$scope.editing=!1,$scope.edit=function(){$scope.editing=!0,element.addClass("active"),inputElement.focus()},inputElement.on("blur",function(){$scope.editing=!1,element.removeClass("active"),$scope.done()})}}}).directive("editInTd",function(){return{restrict:"E",scope:{value:"=",editingD:"=editing",done:"&"},template:'<input  style="width:150px" ng-model="value"/>',link:function($scope,element,attrs){$scope.$watch("editingD",function(n,o){n&&$scope.edit()});var inputElement=angular.element(element.children()[1]);$scope.editing=!1,$scope.edit=function(){console.log(element.width(),element.find("input").width()),inputElement.focus()},inputElement.on("blur",function(){$scope.editing=!1,$scope.done()})}}}).directive("parseFloat",function($timeout){return{restrict:"A",scope:{parseFloat:"="},link:function(scope,element,attrs){element.on("blur",function(){$timeout(function(){try{scope.parseFloat=parseInt(scope.parseFloat)}catch(e){console.log("ss"),scope.parseFloat=0}},100)})}}}).directive("selectStuff",function($timeout,$resource,global){return{restrict:"AE",scope:{addStuff:"&",disEdit:"="},templateUrl:"manager/views/templates/selectStuff.html",controller:function($scope,$resource){var getCategoryNameUrl=function(id){if(!id)return{name:"category",url:"id"};for(var i=0,l=global.get("categories").val.length;i<l;i++)if(global.get("categories").val[i]._id==id){var s=global.get("categories").val[i].name.replace(/(["'\/\s])/g,"-");return{name:s,url:global.get("categories").val[i].url,groupUrl:global.get("categories").val[i].group.url}}};$scope.groupSetup={formatSearching:"Searching the ...",formatNoMatches:"Не найдено",width:"100%"},$scope.qq={};var Stuff=$resource("/api/collections/Stuff/:id",{id:"@id"});$scope.brands=global.get("brands").val,$scope.brand=null,$scope.paginateModal={page:0,row:3,totalItems:0},$scope.categories=[],$scope.changeBrand=function(brand){brand&&($scope.paginateModal.page=0,$scope.paginateModal.totalItems=0,$scope.category="",$scope.categories=$scope.brands.getObjectFromArray("_id",brand).categories,$scope.categories=global.get("categories").val.filter(function(item){return $scope.categories.indexOf(item._id)>-1}),console.log($scope.categories))},$scope.changeCategory=function(){$scope.paginateModal.page=0,$scope.paginateModal.totalItems=0,$scope.getStuffs($scope.category,$scope.brand)},$scope.getStuffs=function(category,brand){if(category){var query=JSON.stringify({category:category,brand:brand});$scope.stuffs=[],Stuff.query({query:query,page:$scope.paginateModal.page,perPage:$scope.paginateModal.row},function(resModal){0==$scope.paginateModal.page&&resModal.length>0&&($scope.paginateModal.totalItems=resModal.shift().index),$scope.stuffList=[];resModal.forEach(function(stuff){getCategoryNameUrl(stuff.category);if(stuff.store)for(var size in stuff.store){var img;if(stuff.store[size].quantity-stuff.store[size].stage>0){img=stuff.gallery&&stuff.gallery[0]&&stuff.gallery[0].thumb?stuff.gallery[0].thumb:"",name=stuff.name,stuff.artikul&&(name=name+" "+stuff.artikul);var _brand=$scope.brands.getObjectFromArray("_id",stuff.brand);$scope.stuffList[$scope.stuffList.length]={size:size,brand:stuff.brand,brandName:_brand.name,brandUrl:_brand.url,sizeName:stuff.store[size].name,category:stuff.category,categoryName:findObInArray($scope.categories,"_id",stuff.category).name,categoryUrl:findObInArray($scope.categories,"_id",stuff.category).url,stuff:stuff._id,name:name,quantity:1,price:stuff.priceSale?stuff.priceSale:stuff.price,retail:stuff.retail,img:img}}}else{var img;img=stuff.gallery&&stuff.gallery[0]&&stuff.gallery[0].thumb?stuff.gallery[0].thumb:"";var name=stuff.name;stuff.artikul&&(name=name+" "+stuff.artikul);var _brand=$scope.brands.getObjectFromArray("_id",stuff.brand);$scope.stuffList[$scope.stuffList.length]={size:null,brand:stuff.brand,brandName:_brand.name,brandUrl:_brand.url,sizeName:null,category:stuff.category,categoryName:findObInArray($scope.categories,"_id",stuff.category).name,categoryUrl:findObInArray($scope.categories,"_id",stuff.category).url,stuff:stuff._id,name:name,quantity:1,price:stuff.priceSale?stuff.priceSale:stuff.price,retail:stuff.retail,img:img}}}),$scope.stuffs=$scope.stuffList})}},$scope.addStuffDirective=function(stuff,order){stuff&&order?$scope.addStuff({stuff:stuff,order:order}):stuff&&$scope.addStuff({stuff:stuff})}},link:function(scope,element,attrs){scope.qq.disEdit=scope.disEdit,scope.$watch("disEdit",function(n){scope.qq.disEdit=n})}}}).directive("readJsonFile",function($timeout){return{restrict:"AE",transclude:"true",scope:{readJsonFile:"=readJsonFile"},link:function(scope,element,attrs){function readMultipleFiles(evt){var files=evt.target.files;if(files)for(var f,i=0;f=files[i];i++){var r=new FileReader;r.onload=function(f){return function(e){var contents=JSON.parse(e.target.result),arr=[];contents.shift(),contents.forEach(function(el){if(el.name){var newEl={name:el.name.replace("Подписчик (","").replace(")",""),email:el.email,date:el.date};el.profile&&el.profile.city&&el.profile.fio&&(newEl.profile=el.profile,arr.push(newEl))}}),$timeout(function(){scope.readJsonFile=arr},100)}}(),r.readAsText(f)}else alert("Failed to load files")}element.on("change",readMultipleFiles)}}}).directive("setLeft",function($timeout){return{restrict:"AC",link:function(scope,element,attrs){var w=(Math.max(document.documentElement.clientHeight,window.innerHeight||0),$("#firstBlock").width()+20);$(element).css("left",w+"px")}}}).directive("tagManager",function(){return{restrict:"E",scope:{tags:"=",header:"@"},template:'<div class="tags"><h3 style="color:black"ng-bind="header"></h3></br>удалить - <a ng-repeat="(idx, tag) in tags" class="tag" ng-click="remove(idx)">{{tag}}</a></div><input type="text" placeholder="Add a tag..." ng-model="new_value"></input> <a class="btn" ng-click="add()">Add</a><h4>Редактировать из списка</h4><ul><li ng-repeat="tag in tags" ng-click="edit($index)">{{tag}}</li></ul><hr>',link:function($scope,$element){var input=angular.element($element.children()[1]);$scope.add=function(){$scope.tags&&$scope.tags.length||($scope.tags=[]),$scope.tags.push($scope.new_value),$scope.new_value=""},$scope.remove=function(idx){$scope.tags.splice(idx,1)},$scope.edit=function(idx){$scope.new_value=$scope.tags[idx],$scope.tags.splice(idx,1)},input.bind("keypress",function(event){13==event.keyCode&&($scope.$apply($scope.add),event.preventDefault())})}}}).directive("tagManagerForObject",function(){return{restrict:"E",scope:{tags:"=",header:"@"},template:'<div class="tags"><h3 style="color:black"ng-bind="header"></h3></br>удалить - <a ng-repeat="(idx, tag) in tags" class="tag" ng-click="remove(idx)">{{getNameTag(idx)}} - {{tags[idx][getNameTag(idx)]}}</a></div><input type="text" placeholder="Add a key..." ng-model="new_value.key"></input> <input type="text" placeholder="Add a value..." ng-model="new_value.value"></input> <a class="btn" ng-click="add()">Add</a><h4>Редактировать из списка</h4><ul><li ng-repeat="(idx,tag) in tags" ng-click="edit(idx)">{{getNameTag(idx)}} - {{tags[idx][getNameTag(idx)]}}</li></ul><hr>',link:function($scope,$element){$scope.new_value={},$scope.getNameTag=function(i){return Object.getOwnPropertyNames($scope.tags[i])[0]};var input=angular.element($element.children()[1]);$scope.add=function(){$scope.tags&&$scope.tags.length||($scope.tags=[]);var o={};o[$scope.new_value.key]=$scope.new_value.value,$scope.tags.push(o),$scope.new_value={}},$scope.remove=function(idx){$scope.tags.splice(idx,1)},$scope.edit=function(idx){$scope.new_value.key=$scope.getNameTag(idx),$scope.new_value.value=$scope.tags[idx][$scope.new_value.key],$scope.tags.splice(idx,1)},input.bind("keypress",function(event){13==event.keyCode&&$scope.$apply($scope.add)})}}}).directive("tagManagerForObject2",function(){return{restrict:"E",scope:{tags:"=",header:"@"},template:'<div class="tags"><h3 style="color:black"ng-bind="header"></h3></br>удалить - <a ng-repeat="(idx, tag) in tags" class="tag" ng-click="remove(idx)">{{idx}} - {{tags[idx]}}</a></div><input type="text" placeholder="Add a key..." ng-model="new_value.key"></input> <input type="text" placeholder="Add a value..." ng-model="new_value.value"></input> <a class="btn" ng-click="add()">Add</a><h4>Редактировать из списка</h4><ul><li ng-repeat="(idx,tag) in tags" ng-click="edit(idx)">{{idx}} - {{tags[idx]}}</li></ul><hr>',link:function($scope,$element){$scope.new_value={},$scope.getNameTag=function(i){return Object.getOwnPropertyNames($scope.tags[i])[0]};var input=angular.element($element.children()[1]);$scope.add=function(){$scope.tags||($scope.tags={}),$scope.tags[$scope.new_value.key]=$scope.new_value.value,$scope.new_value={}},$scope.remove=function(idx){delete $scope.tags[idx]},$scope.edit=function(idx){$scope.new_value.key=idx,$scope.new_value.value=$scope.tags[$scope.new_value.key],$scope.remove(idx)},input.bind("keypress",function(event){13==event.keyCode&&$scope.$apply($scope.add)})}}}).directive("checkUniqueFieldInBase",[function(){return{restrict:"E",scope:{result:"=",Items:"=",field:"@",item:"=",msg:"@",color:"@"},template:'<p style="color:{{color}}" ng-if="result" ng-bind="msg"></p>',link:function(scope,$element){scope.color||(scope.color="red"),scope.msg||(scope.msg="такое значение уже используется");scope.field;scope.$watch(function(){return"item."+scope.field},function(n,o){if(console.log(n,o),n&&n!=o){var query={};qyery[scope.field]=n,Items.query({query:query},function(res){res.shift(),$scope.item._id&&res.length&&$scope.item._id!=res[0]._id||$scope.item._id&&res.length>1||!$scope.item._id&&res.length?scope.result=!0:scope.result=!1})}})}}}]),angular.module("i-orders",[]).directive("ordersWrap",function(){return{restrict:"A",controller:function($scope,$resource,Orders,$timeout,genericPrice){$scope.customOrderCtrl=this,$scope.customOrderCtrl.initPriceInstanceForOrder=function(order){order.genericPrice=new genericPrice("order",order),order.getTotalShip=function(){return this.cartInner.reduce(function(sum,current){return sum+(current.cart&&current.cart.ship?parseInt(current.cart.ship):0)},0)}},$resource("/api/config").get(function(res){$scope.config=res}),$scope.groupSetup={formatSearching:"Searching the brand...",formatNoMatches:"Не найдено",width:"100%"},$scope.q={disEdit:!0},$scope.quant=_.range(1,51),$scope.invoice=function(order){order.invoice=(new Date).getTime(),order.$update({invoice:order.invoice},function(res){$scope.afterSave()})},$scope.updateOrder=function(order){Orders.update(order,function(res){$scope.afterSave()},function(err){err=err.data,alert(err.error)})},$scope.deleteOrder=function(order){confirm("Удалить?")&&Orders.delete({id:order._id},function(res){$scope.afterSave()},function(err){err&&(console.log(err),alert(err.error))})},$scope.getOrderQuantity=function(order){var q=0;if(!order.cartInner)return q;for(var i=0,l=order.cartInner.length;i<l;i++)for(var j=0,lj=order.cartInner[i].cart.cart.length;j<lj;j++)q+=order.cartInner[i].cart.cart[j].quantity;return q},$scope.getPriceCouponCustomOrder=function(price,coupon,use){return coupon&&coupon._id&&use?function(p,s,v){var sum=0;return p&&(sum=v-v/100*p),s&&(sum=v-s),sum}(coupon.p,coupon.s,price):price},$scope.getTotalSum=function(order,quantity,clear){var s=0;if(!order.cartInner)return s;for(var i=0;i<order.cartInner.length;i++)for(var j=0,lj=order.cartInner[i].cart.cart.length;j<lj;j++){var good=order.cartInner[i].cart.cart[j];s+=clear?quantity>=5||order.opt?good.quantity*good.price:good.quantity*good.retail:quantity>=5||order.opt?good.quantity*$scope.getPriceCouponCustomOrder(good.price,order.coupon,good.coupon):good.quantity*$scope.getPriceCouponCustomOrder(good.retail,order.coupon,good.coupon)}return s},$scope.addStuff=function(stuff,order){if(stuff){$scope.q.disEdit=!0;var done=!1;order.cartInner.forEach(function(cart){cart.brand._id==stuff.brand&&(done=!0,cart.cart.cart.some(function(el){return el.stuff==stuff.stuff&&el.size==stuff.size})||cart.cart.cart.unshift(stuff))}),order.genericPrice.reFresh(order.cartInner),done||Orders.update({newInnerCart:stuff.brand,order:order._id},{_id:order._id,stuff:stuff},function(res){order.genericPrice.reFresh(res.cartInner),order.cartInner=res.cartInner},function(err){err=err.data,alert(err.error)})}},$scope.deleteStuff=function(cart,i,j,order){cart.cart.cart.splice(i,1),cart.cart.cart.length<1&&(order.cartInner.splice(j,1),order.genericPrice.reFresh(order.cartInner),Orders.update({deleteInnerCart:cart._id,order:order._id},order,function(res){},function(err){err=err.data,alert(err.error)}))},$scope.changeOptPrice=function(order){},$scope.printOrder=function(order){order.genericPrice=new genericPrice("order",order);var popupWin=window.open();popupWin.window.focus();var s="";s+='<div class="container"><div class="row"><div class="col-lg-8"><h3>Ордер № '+order.num+"</h3> от "+moment(order.date).format("lll")+"</br>",s+='<table width="100%" cellspacing="0" cellpadding="5" border="1px">',s+='<thead><tr><th>#</th><th>Наименование</th><th class="text-center">Размер</th><th class="text-center">Цена</th>',s+='<th class="text-center">Количество</th><th class="text-center">Сумма</th></tr></thead>';for(var i=0,l=order.cartInner.length;i<l;i++){var cart=order.cartInner[i];s+="<tbody>",cart.cart.cart.length&&(s+='<tr><td colspan="6" class="text-center">'+cart.brand.name+"</td>");for(var j=0,lj=cart.cart.cart.length;j<lj;j++){var good=cart.cart.cart[j];s+="<tr><td>"+(j+1)+"</td><td> "+good.name+'</td><td class="text-center">'+good.sizeName+'</td><td class="text-center">'+(order.kurs*(good.cena=order.genericPrice.getPrice(good))).toFixed(2)+" "+order.currency+'</td><td class="text-center">'+good.quantity+'</td><td class="text-center">'+(order.kurs*(good.sum=good.cena*good.quantity)).toFixed(2)+" "+order.currency+"</td></tr>"}s+="</tbody>"}s+='<tbody class="cart-item-total"><tr><td></td><td>Итого</td><td></td><td></td><td class="text-center">'+order.quantity+'</td><td class="text-center" >'+(order.kurs*order.sum).toFixed(2)+" "+order.currency+'</td></tr><tr><td></td><td>доставка</td><td></td><td></td><td></td><td class="text-center">'+(order.shipCost||"0")+" "+order.currency+"</td></tr>",s+='<tr><th></th><th>Итого всего</th><th></th><th></th><th class="text-center">'+order.quantity+'</th><th class="text-center">'+(order.kurs*order.sum+(order.shipCost?order.shipCost:0)).toFixed(2)+" "+order.currency+"</th><th></th></tr>",s+='<tr><td colspan="7"><h4>Данные для доставки:</h4></td></tr><tr><td colspan="2">email : </td><td colspan="6">'+order.user.email+'</td></tr><tr><td colspan="2">login :</td><td colspan="6"> '+order.user.name+'</td></tr><tr><td colspan="2">ФИО : </td><td colspan="6">'+order.profile.fio+'</td></tr><tr><td colspan="2">телефон : </td><td colspan="6">'+order.profile.phone+'</td></tr><tr><td colspan="2">индекс :</td><td colspan="6"> '+(order.profile.zip?order.profile.zip:"&nbsp")+'</td></tr><tr><td colspan="2">город :</td><td colspan="6"> '+(order.profile.city?order.profile.city:"&nbsp")+'</td></tr><tr><td colspan="2">адрес :</td><td colspan="6"> '+(order.profile.address?order.profile.address:"&nbsp")+"</td></tr></table></div><h3>Комментарии:</h3><p>"+order.comment.replace(/\r\n|\r|\n/g,"<br />")+"</p></div></div>";var printContents=s;popupWin.document.write('<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+printContents+"</div></html>")}},templateUrl:"manager/views/templates/ordersWrap.html",link:function(scope,element,attrs){console.log("linked")}}})(function(){var root=this,previousUnderscore=root._,breaker={},ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype,push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty,nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind,_=function(obj){return obj instanceof _?obj:this instanceof _?void(this._wrapped=obj):new _(obj)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=_),exports._=_):root._=_,_.VERSION="1.6.0";var each=_.each=_.forEach=function(obj,iterator,context){if(null==obj)return obj;if(nativeForEach&&obj.forEach===nativeForEach)obj.forEach(iterator,context);else if(obj.length===+obj.length){for(var i=0,length=obj.length;i<length;i++)if(iterator.call(context,obj[i],i,obj)===breaker)return}else for(var keys=_.keys(obj),i=0,length=keys.length;i<length;i++)if(iterator.call(context,obj[keys[i]],keys[i],obj)===breaker)return;return obj};_.map=_.collect=function(obj,iterator,context){var results=[];return null==obj?results:nativeMap&&obj.map===nativeMap?obj.map(iterator,context):(each(obj,function(value,index,list){results.push(iterator.call(context,value,index,list))}),results)};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(null==obj&&(obj=[]),nativeReduce&&obj.reduce===nativeReduce)return context&&(iterator=_.bind(iterator,context)),initial?obj.reduce(iterator,memo):obj.reduce(iterator);if(each(obj,function(value,index,list){initial?memo=iterator.call(context,memo,value,index,list):(memo=value,initial=!0)}),!initial)throw new TypeError(reduceError);return memo},_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(null==obj&&(obj=[]),nativeReduceRight&&obj.reduceRight===nativeReduceRight)return context&&(iterator=_.bind(iterator,context)),initial?obj.reduceRight(iterator,memo):obj.reduceRight(iterator);var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}if(each(obj,function(value,index,list){index=keys?keys[--length]:--length,initial?memo=iterator.call(context,memo,obj[index],index,list):(memo=obj[index],initial=!0)}),!initial)throw new TypeError(reduceError);return memo},_.find=_.detect=function(obj,predicate,context){var result;return any(obj,function(value,index,list){if(predicate.call(context,value,index,list))return result=value,!0}),result},_.filter=_.select=function(obj,predicate,context){var results=[];return null==obj?results:nativeFilter&&obj.filter===nativeFilter?obj.filter(predicate,context):(each(obj,function(value,index,list){predicate.call(context,value,index,list)&&results.push(value)}),results)},_.reject=function(obj,predicate,context){return _.filter(obj,function(value,index,list){return!predicate.call(context,value,index,list)},context)},_.every=_.all=function(obj,predicate,context){predicate||(predicate=_.identity);var result=!0;return null==obj?result:nativeEvery&&obj.every===nativeEvery?obj.every(predicate,context):(each(obj,function(value,index,list){if(!(result=result&&predicate.call(context,value,index,list)))return breaker}),!!result)};var any=_.some=_.any=function(obj,predicate,context){predicate||(predicate=_.identity);var result=!1;return null==obj?result:nativeSome&&obj.some===nativeSome?obj.some(predicate,context):(each(obj,function(value,index,list){if(result||(result=predicate.call(context,value,index,list)))return breaker}),!!result)};_.contains=_.include=function(obj,target){return null!=obj&&(nativeIndexOf&&obj.indexOf===nativeIndexOf?obj.indexOf(target)!=-1:any(obj,function(value){return value===target}))},_.invoke=function(obj,method){var args=slice.call(arguments,2),isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})},_.pluck=function(obj,key){return _.map(obj,_.property(key))},_.where=function(obj,attrs){return _.filter(obj,_.matches(attrs))},_.findWhere=function(obj,attrs){return _.find(obj,_.matches(attrs))},_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535)return Math.max.apply(Math,obj);var result=-(1/0),lastComputed=-(1/0);return each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>lastComputed&&(result=value,lastComputed=computed)}),result},_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj)&&obj[0]===+obj[0]&&obj.length<65535)return Math.min.apply(Math,obj);var result=1/0,lastComputed=1/0;return each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<lastComputed&&(result=value,lastComputed=computed)}),result},_.shuffle=function(obj){var rand,index=0,shuffled=[];return each(obj,function(value){rand=_.random(index++),shuffled[index-1]=shuffled[rand],shuffled[rand]=value}),shuffled},_.sample=function(obj,n,guard){return null==n||guard?(obj.length!==+obj.length&&(obj=_.values(obj)),obj[_.random(obj.length-1)]):_.shuffle(obj).slice(0,Math.max(0,n))};var lookupIterator=function(value){return null==value?_.identity:_.isFunction(value)?value:_.property(value)};_.sortBy=function(obj,iterator,context){return iterator=lookupIterator(iterator),_.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria,b=right.criteria;if(a!==b){if(a>b||void 0===a)return 1;if(a<b||void 0===b)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iterator,context){var result={};return iterator=lookupIterator(iterator),each(obj,function(value,index){var key=iterator.call(context,value,index,obj);behavior(result,key,value)}),result}};_.groupBy=group(function(result,key,value){_.has(result,key)?result[key].push(value):result[key]=[value]}),_.indexBy=group(function(result,key,value){result[key]=value}),_.countBy=group(function(result,key){_.has(result,key)?result[key]++:result[key]=1}),_.sortedIndex=function(array,obj,iterator,context){iterator=lookupIterator(iterator);for(var value=iterator.call(context,obj),low=0,high=array.length;low<high;){var mid=low+high>>>1;iterator.call(context,array[mid])<value?low=mid+1:high=mid}return low},_.toArray=function(obj){return obj?_.isArray(obj)?slice.call(obj):obj.length===+obj.length?_.map(obj,_.identity):_.values(obj):[]},_.size=function(obj){return null==obj?0:obj.length===+obj.length?obj.length:_.keys(obj).length},_.first=_.head=_.take=function(array,n,guard){if(null!=array)return null==n||guard?array[0]:n<0?[]:slice.call(array,0,n)},_.initial=function(array,n,guard){return slice.call(array,0,array.length-(null==n||guard?1:n))},_.last=function(array,n,guard){if(null!=array)return null==n||guard?array[array.length-1]:slice.call(array,Math.max(array.length-n,0))},_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,null==n||guard?1:n)},_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,output){return shallow&&_.every(input,_.isArray)?concat.apply(output,input):(each(input,function(value){_.isArray(value)||_.isArguments(value)?shallow?push.apply(output,value):flatten(value,shallow,output):output.push(value)}),output)};_.flatten=function(array,shallow){return flatten(array,shallow,[])},_.without=function(array){return _.difference(array,slice.call(arguments,1))},_.partition=function(array,predicate){var pass=[],fail=[];return each(array,function(elem){
(predicate(elem)?pass:fail).push(elem)}),[pass,fail]},_.uniq=_.unique=function(array,isSorted,iterator,context){_.isFunction(isSorted)&&(context=iterator,iterator=isSorted,isSorted=!1);var initial=iterator?_.map(array,iterator,context):array,results=[],seen=[];return each(initial,function(value,index){(isSorted?index&&seen[seen.length-1]===value:_.contains(seen,value))||(seen.push(value),results.push(array[index]))}),results},_.union=function(){return _.uniq(_.flatten(arguments,!0))},_.intersection=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,function(other){return _.contains(other,item)})})},_.difference=function(array){var rest=concat.apply(ArrayProto,slice.call(arguments,1));return _.filter(array,function(value){return!_.contains(rest,value)})},_.zip=function(){for(var length=_.max(_.pluck(arguments,"length").concat(0)),results=new Array(length),i=0;i<length;i++)results[i]=_.pluck(arguments,""+i);return results},_.object=function(list,values){if(null==list)return{};for(var result={},i=0,length=list.length;i<length;i++)values?result[list[i]]=values[i]:result[list[i][0]]=list[i][1];return result},_.indexOf=function(array,item,isSorted){if(null==array)return-1;var i=0,length=array.length;if(isSorted){if("number"!=typeof isSorted)return i=_.sortedIndex(array,item),array[i]===item?i:-1;i=isSorted<0?Math.max(0,length+isSorted):isSorted}if(nativeIndexOf&&array.indexOf===nativeIndexOf)return array.indexOf(item,isSorted);for(;i<length;i++)if(array[i]===item)return i;return-1},_.lastIndexOf=function(array,item,from){if(null==array)return-1;var hasIndex=null!=from;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf)return hasIndex?array.lastIndexOf(item,from):array.lastIndexOf(item);for(var i=hasIndex?from:array.length;i--;)if(array[i]===item)return i;return-1},_.range=function(start,stop,step){arguments.length<=1&&(stop=start||0,start=0),step=arguments[2]||1;for(var length=Math.max(Math.ceil((stop-start)/step),0),idx=0,range=new Array(length);idx<length;)range[idx++]=start,start+=step;return range};var ctor=function(){};_.bind=function(func,context){var args,bound;if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError;return args=slice.call(arguments,2),bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));ctor.prototype=func.prototype;var self=new ctor;ctor.prototype=null;var result=func.apply(self,args.concat(slice.call(arguments)));return Object(result)===result?result:self}},_.partial=function(func){var boundArgs=slice.call(arguments,1);return function(){for(var position=0,args=boundArgs.slice(),i=0,length=args.length;i<length;i++)args[i]===_&&(args[i]=arguments[position++]);for(;position<arguments.length;)args.push(arguments[position++]);return func.apply(this,args)}},_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(0===funcs.length)throw new Error("bindAll must be passed function names");return each(funcs,function(f){obj[f]=_.bind(obj[f],obj)}),obj},_.memoize=function(func,hasher){var memo={};return hasher||(hasher=_.identity),function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}},_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)},_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))},_.throttle=function(func,wait,options){var context,args,result,timeout=null,previous=0;options||(options={});var later=function(){previous=options.leading===!1?0:_.now(),timeout=null,result=func.apply(context,args),context=args=null};return function(){var now=_.now();previous||options.leading!==!1||(previous=now);var remaining=wait-(now-previous);return context=this,args=arguments,remaining<=0?(clearTimeout(timeout),timeout=null,previous=now,result=func.apply(context,args),context=args=null):timeout||options.trailing===!1||(timeout=setTimeout(later,remaining)),result}},_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result,later=function(){var last=_.now()-timestamp;last<wait?timeout=setTimeout(later,wait-last):(timeout=null,immediate||(result=func.apply(context,args),context=args=null))};return function(){context=this,args=arguments,timestamp=_.now();var callNow=immediate&&!timeout;return timeout||(timeout=setTimeout(later,wait)),callNow&&(result=func.apply(context,args),context=args=null),result}},_.once=function(func){var memo,ran=!1;return function(){return ran?memo:(ran=!0,memo=func.apply(this,arguments),func=null,memo)}},_.wrap=function(func,wrapper){return _.partial(wrapper,func)},_.compose=function(){var funcs=arguments;return function(){for(var args=arguments,i=funcs.length-1;i>=0;i--)args=[funcs[i].apply(this,args)];return args[0]}},_.after=function(times,func){return function(){if(--times<1)return func.apply(this,arguments)}},_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)_.has(obj,key)&&keys.push(key);return keys},_.values=function(obj){for(var keys=_.keys(obj),length=keys.length,values=new Array(length),i=0;i<length;i++)values[i]=obj[keys[i]];return values},_.pairs=function(obj){for(var keys=_.keys(obj),length=keys.length,pairs=new Array(length),i=0;i<length;i++)pairs[i]=[keys[i],obj[keys[i]]];return pairs},_.invert=function(obj){for(var result={},keys=_.keys(obj),i=0,length=keys.length;i<length;i++)result[obj[keys[i]]]=keys[i];return result},_.functions=_.methods=function(obj){var names=[];for(var key in obj)_.isFunction(obj[key])&&names.push(key);return names.sort()},_.extend=function(obj){return each(slice.call(arguments,1),function(source){if(source)for(var prop in source)obj[prop]=source[prop]}),obj},_.pick=function(obj){var copy={},keys=concat.apply(ArrayProto,slice.call(arguments,1));return each(keys,function(key){key in obj&&(copy[key]=obj[key])}),copy},_.omit=function(obj){var copy={},keys=concat.apply(ArrayProto,slice.call(arguments,1));for(var key in obj)_.contains(keys,key)||(copy[key]=obj[key]);return copy},_.defaults=function(obj){return each(slice.call(arguments,1),function(source){if(source)for(var prop in source)void 0===obj[prop]&&(obj[prop]=source[prop])}),obj},_.clone=function(obj){return _.isObject(obj)?_.isArray(obj)?obj.slice():_.extend({},obj):obj},_.tap=function(obj,interceptor){return interceptor(obj),obj};var eq=function(a,b,aStack,bStack){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof _&&(a=a._wrapped),b instanceof _&&(b=b._wrapped);var className=toString.call(a);if(className!=toString.call(b))return!1;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var length=aStack.length;length--;)if(aStack[length]==a)return bStack[length]==b;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&"constructor"in a&&"constructor"in b)return!1;aStack.push(a),bStack.push(b);var size=0,result=!0;if("[object Array]"==className){if(size=a.length,result=size==b.length)for(;size--&&(result=eq(a[size],b[size],aStack,bStack)););}else{for(var key in a)if(_.has(a,key)&&(size++,!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack))))break;if(result){for(key in b)if(_.has(b,key)&&!size--)break;result=!size}}return aStack.pop(),bStack.pop(),result};_.isEqual=function(a,b){return eq(a,b,[],[])},_.isEmpty=function(obj){if(null==obj)return!0;if(_.isArray(obj)||_.isString(obj))return 0===obj.length;for(var key in obj)if(_.has(obj,key))return!1;return!0},_.isElement=function(obj){return!(!obj||1!==obj.nodeType)},_.isArray=nativeIsArray||function(obj){return"[object Array]"==toString.call(obj)},_.isObject=function(obj){return obj===Object(obj)},each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}}),_.isArguments(arguments)||(_.isArguments=function(obj){return!(!obj||!_.has(obj,"callee"))}),"function"!=typeof/./&&(_.isFunction=function(obj){return"function"==typeof obj}),_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))},_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj},_.isBoolean=function(obj){return obj===!0||obj===!1||"[object Boolean]"==toString.call(obj)},_.isNull=function(obj){return null===obj},_.isUndefined=function(obj){return void 0===obj},_.has=function(obj,key){return hasOwnProperty.call(obj,key)},_.noConflict=function(){return root._=previousUnderscore,this},_.identity=function(value){return value},_.constant=function(value){return function(){return value}},_.property=function(key){return function(obj){return obj[key]}},_.matches=function(attrs){return function(obj){if(obj===attrs)return!0;for(var key in attrs)if(attrs[key]!==obj[key])return!1;return!0}},_.times=function(n,iterator,context){for(var accum=Array(Math.max(0,n)),i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum},_.random=function(min,max){return null==max&&(max=min,min=0),min+Math.floor(Math.random()*(max-min+1))},_.now=Date.now||function(){return(new Date).getTime()};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){return null==string?"":(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}}),_.result=function(object,property){if(null!=object){var value=object[property];return _.isFunction(value)?value.call(object):value}},_.mixin=function(obj){each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];return push.apply(args,arguments),result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id},_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"};_.template=function(text,data,settings){var render;settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||/(.)^/).source,(settings.interpolate||/(.)^/).source,(settings.evaluate||/(.)^/).source].join("|")+"|$","g"),index=0,source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){return source+=text.slice(index,offset).replace(/\\|'|\r|\n|\t|\u2028|\u2029/g,function(match){return"\\"+escapes[match]}),escape&&(source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"),interpolate&&(source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"),evaluate&&(source+="';\n"+evaluate+"\n__p+='"),index=offset+match.length,match}),source+="';\n",settings.variable||(source="with(obj||{}){\n"+source+"}\n"),source="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{render=new Function(settings.variable||"obj","_",source)}catch(e){throw e.source=source,e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};return template.source="function("+(settings.variable||"obj")+"){\n"+source+"}",template},_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_),each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;return method.apply(obj,arguments),"shift"!=name&&"splice"!=name||0!==obj.length||delete obj[0],result.call(this,obj)}}),each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}}),_.extend(_.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return _})}).call(this);