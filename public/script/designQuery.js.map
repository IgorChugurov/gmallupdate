{"version":3,"sources":["../scripts/babel/designQuery.js"],"names":["designQuery","brands","brandTags","filters","sections","categories","filterTags","reduce","a","item","concat","tags","s","child","forEach","c","console","log","queryCategory","params","query","group","category","brand","brandTag","queryTag","q","b","getOFA","_id","bt","i","length","split","map","url","filter","t","push","_prepareQueryForRequest","queryStart","arr_id","key","qu","key2","obj","objT","$or","$and","$in","JSON","stringify","window","exports","init"],"mappings":"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","file":"designQuery.js","sourcesContent":["'use strict';\r\n(function(){\r\n    class designQuery {\r\n        constructor(brands,brandTags,filters,sections,categories){\r\n            this.brands=brands;\r\n            this.brandTags=brandTags;\r\n            this.filterTags=filters.reduce(function (a,item) {return a.concat(item.tags);},[]);\r\n            this.sections=sections;\r\n            this.categories=sections.reduce(function (a,s) {\r\n                if(s.categories){\r\n                    a.concat(s.categories)\r\n                }\r\n                if(s.child){\r\n                    s.child.forEach(function (c) {\r\n                        if(c.categories){\r\n                            a.concat(c.categories)\r\n                        }\r\n                    })\r\n                }\r\n                return a;\r\n            },[])\r\n            console.log(this.categories)\r\n            this.queryCategory=queryCategory;\r\n        }\r\n        getQueryString(params,query,queryCategory){\r\n            this.queryCategory=queryCategory;\r\n            let {group,category}=params;\r\n            let {brand,brandTag,queryTag}=query;\r\n            /*console.log(params,query)\r\n            console.log(group,category,brand,brandTag,queryTag);*/\r\n            let q={},b=this.brands.getOFA('url',brand);\r\n            if(brand && b){\r\n                q.brand=b._id\r\n            }\r\n            if(brandTag){\r\n                let bt;\r\n                if(b){\r\n                    let bt=b.tags.getOFA('url',brandTag);\r\n                    if(bt){q.brandTag=bt._id}\r\n                }else{\r\n                    for(let i=0;i<this.brands.length;i++){\r\n                        bt=this.brands[i].tags.getOFA('url',brandTag)\r\n                        if(bt){q.brandTag=bt._id;break}\r\n                    }\r\n                }\r\n            }\r\n            // анализ url на наличие тегов*************\r\n            if(queryTag){\r\n                q.tags={}\r\n                let filterTags=this.filterTags;\r\n                queryTag.split('+').map(function(url){\r\n                    //console.log(url)\r\n                    return filterTags.getOFA('url',url)\r\n                }).filter(function (t) {\r\n                    return t;\r\n                }).forEach(function (t) {\r\n                    //console.log(t)\r\n                    if(!q.tags[t.filter]){q.tags[t.filter]=[]}\r\n                    //console.log(q.tags)\r\n                    q.tags[t.filter].push(t._id);\r\n                })\r\n            }\r\n\r\n\r\n            //console.log(q,this.queryCategory)\r\n            if(this.queryCategory && this.queryCategory.category){\r\n                q.category=this.queryCategory.category;\r\n            }\r\n            //console.log(_prepareQueryForRequest(q))\r\n            return _prepareQueryForRequest(q);\r\n        }\r\n    }\r\n\r\n    function _prepareQueryForRequest(queryStart){\r\n        //console.log(queryStart)\r\n        // формирование строки запроса для выбора  товаров из БД\r\n        var query=[];\r\n        var arr_id;\r\n        for (var key in queryStart){\r\n            if (queryStart[key]){\r\n                //console.log(queryStart[key],key);\r\n                if (key==\"tags\"){\r\n                    var qu=[];\r\n                    for (var key2 in queryStart[key]){\r\n                        var obj=queryStart[key][key2];\r\n                        var q=[];\r\n                        if (obj && obj.length){\r\n                            obj.forEach(function(objT){\r\n                                q.push({tags:objT});\r\n                            })\r\n\r\n                            if (q.length>1){\r\n                                q={$or:q}\r\n                                qu.push(q)\r\n                            } else {\r\n                                q=q[0];\r\n                                qu.push(q)\r\n                            }\r\n                        }\r\n                    }\r\n                    if (qu.length){\r\n                        if(qu.length==1){\r\n                            query.push(qu[0]);\r\n                        } else {\r\n                            query.push({$and:qu});\r\n                        }\r\n                    }\r\n                }else if(key==\"brandTag\"){\r\n                    //console.log(key,queryStart[key])\r\n                    // это если запрос на список со страницы акции.\r\n                    // в акции могут быть товары из нестольких коллекций\r\n                    if(queryStart[key].length){\r\n                        var obj={};\r\n                        obj[key]={$in:queryStart[key]};\r\n                        query.push(obj);\r\n                        //console.log(key,obj)\r\n                    }/*else {\r\n\r\n                     var obj={};\r\n                     obj[key]=queryStart[key];\r\n                     query.push(obj);\r\n\r\n                     }*/\r\n                    //console.log(obj[key])\r\n                }else if(key==\"_id\"){\r\n                    // это если запрос на список со страницы акции.\r\n                    // в акции могут быть просто товары\r\n                    if(queryStart[key].length){\r\n                        arr_id={};\r\n                        arr_id[key]={$in:queryStart[key]};\r\n                    }\r\n                } else {\r\n                    var obj={};\r\n                    obj[key]=queryStart[key];\r\n                    query.push(obj);\r\n                }\r\n            }\r\n        }\r\n        if (query.length==1){\r\n            if(arr_id){\r\n                query =  JSON.stringify({$or:[query[0],arr_id]});\r\n            }else{\r\n                query=JSON.stringify(query[0]);\r\n            }\r\n\r\n        } else if(query.length>1){\r\n            if(arr_id){\r\n                query =  JSON.stringify({$or:[{$and:query},arr_id]});\r\n            }else{\r\n                query =JSON.stringify({$and:query});\r\n            }\r\n\r\n        } else {\r\n            if(arr_id){\r\n                query =  JSON.stringify(arr_id);\r\n            }else{\r\n                query={};\r\n            }\r\n\r\n        }\r\n        return query;\r\n    }\r\n\r\n\r\n\r\n    if(typeof window === 'undefined') {\r\n        exports.init=designQuery;\r\n    }\r\n})()\r\n\r\n"]}