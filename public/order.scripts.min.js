"use strict";function validateEmail(email){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)}function md5www(str){var k,AA,BB,CC,DD,a,b,c,d,RotateLeft=function(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits},AddUnsigned=function(lX,lY){var lX4,lY4,lX8,lY8,lResult;return lX8=2147483648&lX,lY8=2147483648&lY,lX4=1073741824&lX,lY4=1073741824&lY,lResult=(1073741823&lX)+(1073741823&lY),lX4&lY4?2147483648^lResult^lX8^lY8:lX4|lY4?1073741824&lResult?3221225472^lResult^lX8^lY8:1073741824^lResult^lX8^lY8:lResult^lX8^lY8},F=function(x,y,z){return x&y|~x&z},G=function(x,y,z){return x&z|y&~z},H=function(x,y,z){return x^y^z},I=function(x,y,z){return y^(x|~z)},FF=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},GG=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},HH=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},II=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},WordToHex=function(lValue){var lByte,lCount,WordToHexValue="",WordToHexValue_temp="";for(lCount=0;lCount<=3;lCount++)lByte=lValue>>>8*lCount&255,WordToHexValue_temp="0"+lByte.toString(16),WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);return WordToHexValue},x=Array();for(str=unescape(encodeURIComponent(str)),x=function(str){for(var lWordCount,lMessageLength=str.length,lNumberOfWords_temp1=lMessageLength+8,lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64,lNumberOfWords=16*(lNumberOfWords_temp2+1),lWordArray=Array(lNumberOfWords-1),lBytePosition=0,lByteCount=0;lByteCount<lMessageLength;)lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|str.charCodeAt(lByteCount)<<lBytePosition,lByteCount++;return lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition,lWordArray[lNumberOfWords-2]=lMessageLength<<3,lWordArray[lNumberOfWords-1]=lMessageLength>>>29,lWordArray}(str),a=1732584193,b=4023233417,c=2562383102,d=271733878,k=0;k<x.length;k+=16)AA=a,BB=b,CC=c,DD=d,a=FF(a,b,c,d,x[k+0],7,3614090360),d=FF(d,a,b,c,x[k+1],12,3905402710),c=FF(c,d,a,b,x[k+2],17,606105819),b=FF(b,c,d,a,x[k+3],22,3250441966),a=FF(a,b,c,d,x[k+4],7,4118548399),d=FF(d,a,b,c,x[k+5],12,1200080426),c=FF(c,d,a,b,x[k+6],17,2821735955),b=FF(b,c,d,a,x[k+7],22,4249261313),a=FF(a,b,c,d,x[k+8],7,1770035416),d=FF(d,a,b,c,x[k+9],12,2336552879),c=FF(c,d,a,b,x[k+10],17,4294925233),b=FF(b,c,d,a,x[k+11],22,2304563134),a=FF(a,b,c,d,x[k+12],7,1804603682),d=FF(d,a,b,c,x[k+13],12,4254626195),c=FF(c,d,a,b,x[k+14],17,2792965006),b=FF(b,c,d,a,x[k+15],22,1236535329),a=GG(a,b,c,d,x[k+1],5,4129170786),d=GG(d,a,b,c,x[k+6],9,3225465664),c=GG(c,d,a,b,x[k+11],14,643717713),b=GG(b,c,d,a,x[k+0],20,3921069994),a=GG(a,b,c,d,x[k+5],5,3593408605),d=GG(d,a,b,c,x[k+10],9,38016083),c=GG(c,d,a,b,x[k+15],14,3634488961),b=GG(b,c,d,a,x[k+4],20,3889429448),a=GG(a,b,c,d,x[k+9],5,568446438),d=GG(d,a,b,c,x[k+14],9,3275163606),c=GG(c,d,a,b,x[k+3],14,4107603335),b=GG(b,c,d,a,x[k+8],20,1163531501),a=GG(a,b,c,d,x[k+13],5,2850285829),d=GG(d,a,b,c,x[k+2],9,4243563512),c=GG(c,d,a,b,x[k+7],14,1735328473),b=GG(b,c,d,a,x[k+12],20,2368359562),a=HH(a,b,c,d,x[k+5],4,4294588738),d=HH(d,a,b,c,x[k+8],11,2272392833),c=HH(c,d,a,b,x[k+11],16,1839030562),b=HH(b,c,d,a,x[k+14],23,4259657740),a=HH(a,b,c,d,x[k+1],4,2763975236),d=HH(d,a,b,c,x[k+4],11,1272893353),c=HH(c,d,a,b,x[k+7],16,4139469664),b=HH(b,c,d,a,x[k+10],23,3200236656),a=HH(a,b,c,d,x[k+13],4,681279174),d=HH(d,a,b,c,x[k+0],11,3936430074),c=HH(c,d,a,b,x[k+3],16,3572445317),b=HH(b,c,d,a,x[k+6],23,76029189),a=HH(a,b,c,d,x[k+9],4,3654602809),d=HH(d,a,b,c,x[k+12],11,3873151461),c=HH(c,d,a,b,x[k+15],16,530742520),b=HH(b,c,d,a,x[k+2],23,3299628645),a=II(a,b,c,d,x[k+0],6,4096336452),d=II(d,a,b,c,x[k+7],10,1126891415),c=II(c,d,a,b,x[k+14],15,2878612391),b=II(b,c,d,a,x[k+5],21,4237533241),a=II(a,b,c,d,x[k+12],6,1700485571),d=II(d,a,b,c,x[k+3],10,2399980690),c=II(c,d,a,b,x[k+10],15,4293915773),b=II(b,c,d,a,x[k+1],21,2240044497),a=II(a,b,c,d,x[k+8],6,1873313359),d=II(d,a,b,c,x[k+15],10,4264355552),c=II(c,d,a,b,x[k+6],15,2734768916),b=II(b,c,d,a,x[k+13],21,1309151649),a=II(a,b,c,d,x[k+4],6,4149444226),d=II(d,a,b,c,x[k+11],10,3174756917),c=II(c,d,a,b,x[k+2],15,718787259),b=II(b,c,d,a,x[k+9],21,3951481745),a=AddUnsigned(a,AA),b=AddUnsigned(b,BB),c=AddUnsigned(c,CC),d=AddUnsigned(d,DD);return(WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d)).toLowerCase()}function exception(toaster){function catcher(header){return function(err){err?"object"==typeof err&&(err.data&&(err=err.data),err.message?err=err.message:err.error&&(err=err.error)):err="ошибка",toaster.pop("error",header,err)}}function showToaster(type,title,content){"object"==typeof content&&(content.message?content=content.message:content.error&&(content=content.error)),toaster.pop({type:type,title:title,body:content,bodyOutputType:"trustedHtml",showCloseButton:!0,delay:15e3,closeHtml:"<button>Close</button>"})}return{catcher:catcher,showToaster:showToaster}}function confirmFactory($q,$uibModal){function service(question){return $q(function(resolve,reject){var options={animation:!0,template:['<div class="modal-header">','<h3 class="modal-title text-center" ng-bind="$ctrl.question"></h3>',"<span class='icon-cancel-img' ng-click='$ctrl.cancel()'></span>","</div>",'<div class="modal-body confirm">','<form ng-submit="$ctrl.ok()"><button autofocus class="btn btn-project btn-border  btn-modal pull-right" type="reset" ng-click="$ctrl.cancel()">{{global.get("langOrder").val.noo}}</button>','<button class="btn btn-project btn-modal pull-left" type="submit">{{global.get("langOrder").val.yes}}</button>','</form><div class="clearfix"></div>',"</div>"].join(""),controller:function($uibModalInstance,question){var self=this;self.question=question,self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"sm",resolve:{question:function(){return question}}};$uibModal.open(options).result.then(function(){resolve()},function(){reject()})})}return service}function sectionServiceFunction($resource,$q,global,$uibModal,$timeout){function init(){Items.query(function(res){res.shift(),sections=res,setCategoriesFromSections(sections),pending=!1})}function reloadItems(){pending=!0,init()}function save(){return Items.save.apply(this,arguments).$promise.then(function(){})}function _getParentSection(sections,sectionUrl,id){if(!sections)return null;for(var i=0,l=sections.length;i<l;i++){if(id){if(sections[i]._id==sectionUrl)return sections[i]}else if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length){var categories;if(categories=_getParentSection(sections[i].child,sectionUrl,id))return categories}}return null}function _getEmbededCategories(section,arr){return section.categories&&section.categories.length&&arr.push.apply(arr,section.categories),section.child&&section.child.length&&section.child.forEach(function(section){getEmbededCategories(section,arr)}),arr}function returnSections(resolve){pending?setTimeout(function(){returnSections(resolve)},100):resolve(sections)}function getSections(){return $q(function(resolve,reject){global.get("sections")&&global.get("sections").val?(sections||(sections=global.get("sections").val),resolve(global.get("sections").val)):pending?setTimeout(function(){returnSections(resolve)},100):sections?resolve(sections):(pending=!0,Items.query(function(res){res.shift(),sections=res,pending=!1,setCategoriesFromSections(sections),resolve(sections)},function(err){pending=!1,reject(err)}))})}function setSections(newSections){sections=newSections,setCategoriesFromSections(sections?sections:[])}function getSection(sections,sectionUrl){sections||(sections=getSections());for(var i=0,l=sections.length;i<l;i++){if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length)for(var j=0,ll=sections[i].child.length;j<ll;j++)if(sections[i].child[j].url&&sections[i].child[j].url==sectionUrl)return sections[i].child[j]}return null}function getParentSection(sectionUrl,id){return _getParentSection(sections,sectionUrl,id)}function getEmbededCategories(section,arr){return _getEmbededCategories(section,arr)}function setCategoriesFromSections(sections){var categories=[],categoriesO={};sections.forEach(function(section){section.categories&&section.categories.length&&(section.categories.forEach(function(c){c.section={url:section.url},c.linkData={groupUrl:section.url,categoryUrl:c.url},categoriesO[c._id]=c}),categories.push.apply(categories,section.categories)),section.child&&section.child.length&&section.child.forEach(function(subSection){subSection.categories&&subSection.categories.length&&(subSection.categories.forEach(function(c){c.section={url:section.url},c.linkData={groupUrl:section.url,categoryUrl:c.url,parentGroup:subSection.url},categoriesO[c._id]=c}),categories.push.apply(categories,subSection.categories))})}),global.set("categories",categories),global.set("categoriesO",categoriesO)}function select(){var that=this;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectSubsectionModal.html",controller:selectSubsectionCtrl,size:"lg",resolve:{sections:function(){return that.getSections()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectSubsectionCtrl($q,$uibModalInstance,sections){var self=this;self.sections=sections,console.log(sections),self.ok=function(section){$uibModalInstance.close(section)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Group/:id",{id:"@_id"}),sections=null,pending=!0;return function(){$timeout(function(){global.get("sections")&&global.get("sections").val||init()})}(),{query:Items.query,get:Items.get,delete:Items.delete,save:save,savePure:Items.save,getSections:getSections,getSection:getSection,getParentSection:getParentSection,getEmbededCategories:getEmbededCategories,setCategoriesFromSections:setCategoriesFromSections,select:select,setSections:setSections,reloadItems:reloadItems}}function filterTagsService($resource,$uibModal,$q,global,$timeout,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function getFilterTags(){return $q(function(resolve,reject){return global.get("filterTags")&&global.get("filterTags").val?(filterTags||(filterTags=global.get("filterTags").val),resolve(global.get("filterTags").val)):pending?$timeout(function(){return resolve(filterTags)},400):void(filterTags?resolve(filterTags):(pending=!0,Items.query(function(res){res.shift(),filterTags=res?res:[],pending=!1,resolve(filterTags)},function(err){pending=!1,reject(err)})))})}function getTagsByUrl(queryTags,cb){$q.when().then(function(){return getFilterTags()}).then(function(){queryTags=queryTags.map(function(url){return filterTags.getOFA("url",url)}),cb(queryTags)})}function selectFilterTag(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/bindFilterTagToModel.html",controller:selectFilterTagCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectFilterTagCtrl(Filters,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),$uibModalInstance.close(filterTag)}}function init(){Items.query(qu,function(res){res.shift(),filterTags=res,filterTags.forEach(function(t){_filterTagsO[t._id]=t}),pending=!1})}function reloadItems(){pending=!0,init()}function getSticker(tags){if(tags&&tags.length&&filterTags&&filterTags.length)for(var i=0;i<tags.length;i++)if(__filterTagsO[tags[i]]&&__filterTagsO[tags[i]].sticker)return __filterTagsO[tags[i]].sticker}var qu,Items=$resource("/api/collections/FilterTags/:_id",{_id:"@_id"}),filterTags=null,pending=!0;return filterTags=__filterTags,$timeout(function(){qu={query:JSON.stringify({store:global.get("store").val._id})},global.get("filterTags")&&global.get("filterTags").val?filterTags=global.get("filterTags").val:init()},50),{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,getFilterTags:getFilterTags,getTagsByUrl:getTagsByUrl,selectFilterTag:selectFilterTag,select:selectFilterTag,reloadItems:reloadItems,getSticker:getSticker,reloadItems:reloadItems}}function configDataComponent(){return{scope:{},restrict:"E",bindToController:!0,controller:configDataComponentCtrl,controllerAs:"$ctrl",templateUrl:"components/storeSetting/configData.component.html"}}function configDataComponentCtrl(Items,$q){function selectType(type){query={type:type},$q.when().then(function(){return Items.getList(null,query)}).then(function(res){if(res.length){if(res.length!=languagesOfPlatform.length){var arr=languagesOfPlatform.diff(res.map(function(item){return item.lang})),acts=[];return arr.forEach(function(lang,idx){var o={type:type,lang:lang,data:[]};acts.push(Items.save(o).$promise)}),$q.when().then(function(){return $q.all(acts)}).then(function(){return Items.getList(null,query)})}return res}var acts=[];return languagesOfPlatform.forEach(function(lang,idx){var o={type:type,lang:lang,data:[]};acts.push(Items.save(o).$promise)}),$q.when().then(function(){return $q.all(acts)}).then(function(){return Items.getList(null,query)})}).then(function(res){self.items=res,console.log(self.items)})}function saveField(item,field){console.log(item);var o={_id:item._id};o[field]=item[field],Items.save({update:field},o)}var self=this;self.selectType=selectType,self.languagesOfPlatform=languagesOfPlatform,self.propertiesOfConfigData=propertiesOfConfigData,self.saveField=saveField;var query=null;!function(){self.type=propertiesOfConfigData[0].key,selectType(self.type)}()}function currencyComponent(){return{scope:{},restrict:"E",bindToController:!0,controller:currencyComponentCtrl,controllerAs:"$ctrl",templateUrl:"components/storeSetting/currency.component.html"}}function currencyComponentCtrl(Store,$q,global,$http,$uibModal,exception){function save(){var o={_id:global.get("store").val._id};for(var key in self.item.currency)self.item.currency[key][2]&&(self.item.currency[key][2]=self.item.currency[key][2].substring(0,5));o.currency=self.item.currency,Store.save({update:"currency"},o)}function recalculatePrice(){return self.percValue=0,void $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/progressBar.html",controller:function($uibModalInstance,socket){$q.when().then(function(){return $http({method:"get",url:"/api/recalculatePrice"})}).then(function(){$uibModalInstance.close(),exception.showToaster("info","выполнено")}).catch(function(err){console.log(err),err&&exception.catcher("пересчет цены")(err),$uibModalInstance.close()})},controllerAs:"$ctrl",size:"lg"})}var self=this;self.save=save,self.recalculatePrice=recalculatePrice,function(){$q.when().then(function(){return Store.get({_id:global.get("store").val._id}).$promise}).then(function(res){for(var key in res.currency)key==res.mainCurrency?res.currency[key][0]=1:res.currency[key][0]=Number(res.currency[key][0]);self.item=res})}()}function mainConfigComponent(){return{scope:{},restrict:"E",bindToController:!0,controller:mainConfigComponentCtrl,controllerAs:"$ctrl",templateUrl:"components/storeSetting/mainConfig.component.html"}}function mainConfigComponentCtrl(Config,$q,global,exception,toaster){function updateItem(){var item=angular.copy(self.item);delete item._id,delete item.__v;var keys=Object.keys(item).join(" ");Config.save({update:keys},self.item,function(res){toaster.pop("success","сохранение","перезаписано")})}var self=this;self.updateItem=updateItem,function(){$q.when().then(function(){return Config.query().$promise}).then(function(res){self.item=res[1],console.log(self.item)})}()}function enterPhoneNumderCtrl($scope,global){function changePhone(){self.phone?self.enterPhoneNumder=self.phoneCode.substring(1)+self.phone.substring(0,10):self.enterPhoneNumder="",self.changeFoo&&"function"==typeof self.changeFoo&&self.changeFoo({phone:self.enterPhoneNumder})}function changeCode(){}var self=this;self.global=global,self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",$scope.$watch(function(){return self.enterPhoneNumder},function(enterPhoneNumder,old){if(enterPhoneNumder){var phoneCode="+"+enterPhoneNumder.substring(0,enterPhoneNumder.length-10);self.phoneCodes.getOFA("code",phoneCode)&&(self.phoneCode=phoneCode),self.phone=enterPhoneNumder.substring(enterPhoneNumder.length-10)}}),self.changePhone=changePhone,self.changeCode=changeCode}function externalCatalogComponent(){return{scope:{},restrict:"E",bindToController:!0,controller:externalCatalogCtrl,controllerAs:"$ctrl",templateUrl:"components/externalCatalog/externalCatalog.html"}}function externalCatalogDownload(){return{scope:{},restrict:"E",bindToController:!0,controller:externalCatalogDownloadCtrl,controllerAs:"$ctrl",templateUrl:"components/externalCatalog/externalCatalogDownload.html"}}function externalCatalogDownloadCtrl(Items,$q,Confirm,exception,global,$timeout,$http,$resource,Sections,Brands,$uibModal){function getList(){var query={};return $q.when().then(function(){return Items.getList(null,query)}).then(function(res){res.forEach(function(item){item.brand&&(item.brand=self.brands.find(function(b){return b._id==item.brand})),item.group&&(item.group=self.sections.find(function(s){return s._id==item.group}))}),self.items=res})}function downloadCatalog(item){$q.when().then(function(){self.myFile;$uibModal.open({animation:!0,templateUrl:"components/externalCatalog/modal/uploadExternalCatalog.html",controller:function($uibModalInstance,$q,$resource,item){function confirmUpload(){fdata.append("confirm",!0),$resource(uploadUrl,{},{postWithFile:{method:"POST",params:fdata,transformRequest:angular.identity,headers:{"Content-Type":void 0}}}).postWithFile(fdata),$uibModalInstance.close()}var self=this;self.disabledUpload=!0;var uploadUrl=stuffHost+"/api/downLoadExternalCatalog";self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()},self.catalogName=item.name,self.confirmUpload=confirmUpload,console.log(item);var fdata=new FormData;item.file&&fdata.append("file",item.file),fdata.append("_id",item._id),fdata.append("url",item.url),fdata.append("link",item.link),fdata.append("index",item.index),item.group&&fdata.append("group",item.group._id),item.brand&&fdata.append("brand",item.brand._id),item.name&&fdata.append("name",item.name),item.desc&&fdata.append("desc",item.desc),item.price&&fdata.append("price",item.price),item.qty&&fdata.append("qty",item.qty),item.artikul&&fdata.append("artikul",item.artikul),item.tags&&fdata.append("tags",item.tags),$q.when().then(function(){return $http.post(uploadUrl,fdata,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}).then(function(res){console.log(res),res.err?(self.errText=JSON.stringify(res.err),"{}"==self.errText&&(self.errText="произошла ошибка при обработке файла")):(self.disabledUpload=!1,self.disableSpinner=!0,self.updateStuffs=res.updateStuffs,self.newStuffs=res.newStuffs,self.newCategories=res.newCategories,self.newBrands=res.newBrands,self.newBrandTags=res.newBrandTags,self.newFilters=res.newFilters,self.newFilterTags=res.newFilterTags)})},controllerAs:"$ctrl",size:"lg",resolve:{item:function(){return item}}}).result}).catch(function(error){console.log(error)})}function setGroup(item){$q.when().then(function(){return Sections.select()}).then(function(group){item.group=group,saveField(item,"group",group._id)})}function setBrand(item){$q.when().then(function(){return Brands.select()}).then(function(brand){item.brand=brand,saveField(item,"brand",brand._id)})}function clearField(item,field){item[field]=null,saveField(item,field)}function saveField(item,field,value){console.log(item);var o={_id:item._id};o[field]="undefined"!=value?item[field]:value,Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500);var url=stuffHost+"/api/changeTaskSchedule",i=angular.copy(item);i.brand&&(i.brand=i.brand._id),i.group&&(i.group=i.group._id),$http.post(url,i).success(function(res){exception.showToaster("info","schedule","was changed")}).error(function(err){exception.catcher("error")(err),console.log(err)})})}function viewLogFile(){$uibModal.open({animation:!0,templateUrl:"components/externalCatalog/modal/viewLog.html",controller:function($uibModalInstance,$q,$http,global,$sce){var self=this;self.$sce,self.url=stuffHost+"/log/"+global.get("store").val.subDomain+"_externalCatalog.log",self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()},$http.get(self.url).success(function(res){console.log(res.replace(/[\r\n]/g,"<br />")),self.loaded,self.logFile=$sce.getTrustedHtml(res.replace(/[\r\n]/g,"<br />"))}).error(function(err){self.loaded,console.log(err)})},controllerAs:"$ctrl",size:"lg"})}var self=this;self.downloadCatalog=downloadCatalog,self.setGroup=setGroup,self.setBrand=setBrand,self.viewLogFile=viewLogFile,self.clearField=clearField,self.saveField=saveField,self.updateList=updateExternalCatalogList,self.lang=global.get("store").val.lang,function(){$q.when().then(function(){return Brands.getBrands()}).then(function(brands){return self.brands=brands,Sections.getSections()}).then(function(sections){self.sections=sections}).then(function(){getList()})}()}function externalCatalogCtrl(Items,$q,Confirm,exception,global,$timeout){function getList(){var query={};return $q.when().then(function(){return Items.getList(null,query)}).then(function(res){console.log(res),self.items=res}).then(function(){var d=new Date;self.items.forEach(function(item){item.timezoneOffset||0==item.timezoneOffset||(item.timezoneOffset=Math.ceil(d.getTimezoneOffset()/60),saveField(item,"timezoneOffset"))})})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){$q.when().then(function(){return Items.create()}).then(function(item){var d=new Date;return item.timezoneOffset=d.getTimezoneOffset(),Items.save(item).$promise}).then(function(){return getList()}).catch(function(err){err&&exception.catcher("создание внешнего каталога")(err)})}function deleteItem(item){Confirm("удалить?").then(function(){item.actived=!1,saveField(item,"actived")}).then(function(){}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление внешнего каталога")(err)})}var self=this;self.saveField=saveField,self.createItem=createItem,self.deleteItem=deleteItem,function(){getList()}()}function compileStyleForBlock(block){var elements=[],el="";if(block.blockStyle)for(var i=0;i<lengthStyleBlock;i++){var n;block.blockStyle[i]&&(n=getNamePropertyCSS(i,block.blockStyle[i]))&&(el+="\n"+n[0]+":"+n[1]+";")}if(el&&(el&&(el="{"+el+"}\n"),elements.push(el)),block.elements&&"object"==typeof block.elements)for(var key in block.elements){el="";for(var i=0;i<lengthStyleBlock;i++)if("a"!=key||1!=i){var n;block.elements[key][i]&&(n=getNamePropertyCSS(i,block.elements[key][i]))&&(el+="\n"+n[0]+":"+n[1]+";")}el&&(el=key.replace("@",".")+"{"+el+"}\n"),"a"==key&&block.elements.a[1]&&(el+="a:hover {color:"+block.elements.a[1]+"}"),el&&elements.push(el)}return elements}angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. H:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"H:mm:ss",short:"dd.MM.yy H:mm",shortDate:"dd.MM.yy",shortTime:"H:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"₽",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru",localeID:"ru",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]),angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. H:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"H:mm:ss",short:"dd.MM.yy H:mm",shortDate:"dd.MM.yy",shortTime:"H:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"₽",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru-ru",localeID:"ru_RU",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]),angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. HH:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"HH:mm:ss",short:"dd.MM.yy HH:mm",shortDate:"dd.MM.yy",shortTime:"HH:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"грн.",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru-ua",localeID:"ru_UA",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]),function(){function url_slug(s,opt){s=String(s),opt=Object(opt);var defaults={delimiter:"-",limit:void 0,lowercase:!0,replacements:{},transliterate:"undefined"==typeof XRegExp};for(var k in defaults)opt.hasOwnProperty(k)||(opt[k]=defaults[k]);var char_map={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ő":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ű":"U","Ý":"Y","Þ":"TH","ß":"ss","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ð":"d","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ő":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ű":"u","ý":"y","þ":"th","ÿ":"y","©":"(c)","Α":"A","Β":"B","Γ":"G","Δ":"D","Ε":"E","Ζ":"Z","Η":"H","Θ":"8","Ι":"I","Κ":"K","Λ":"L","Μ":"M","Ν":"N","Ξ":"3","Ο":"O","Π":"P","Ρ":"R","Σ":"S","Τ":"T","Υ":"Y","Φ":"F","Χ":"X","Ψ":"PS","Ω":"W","Ά":"A","Έ":"E","Ί":"I","Ό":"O","Ύ":"Y","Ή":"H","Ώ":"W","Ϊ":"I","Ϋ":"Y","α":"a","β":"b","γ":"g","δ":"d","ε":"e","ζ":"z","η":"h","θ":"8","ι":"i","κ":"k","λ":"l","μ":"m","ν":"n","ξ":"3","ο":"o","π":"p","ρ":"r","σ":"s","τ":"t","υ":"y","φ":"f","χ":"x","ψ":"ps","ω":"w","ά":"a","έ":"e","ί":"i","ό":"o","ύ":"y","ή":"h","ώ":"w","ς":"s","ϊ":"i","ΰ":"y","ϋ":"y","ΐ":"i","А":"A","Б":"B","В":"V","Г":"G","Д":"D","Е":"E","Ё":"Yo","Ж":"Zh",
"З":"Z","И":"I","Й":"J","К":"K","Л":"L","М":"M","Н":"N","О":"O","П":"P","Р":"R","С":"S","Т":"T","У":"U","Ф":"F","Х":"H","Ц":"C","Ч":"Ch","Ш":"Sh","Щ":"Sh","Ъ":"","Ы":"Y","Ь":"","Э":"E","Ю":"Yu","Я":"Ya","а":"a","б":"b","в":"v","г":"g","д":"d","е":"e","ё":"yo","ж":"zh","з":"z","и":"i","й":"j","к":"k","л":"l","м":"m","н":"n","о":"o","п":"p","р":"r","с":"s","т":"t","у":"u","ф":"f","х":"h","ц":"c","ч":"ch","ш":"sh","щ":"sh","ъ":"","ы":"y","ь":"","э":"e","ю":"yu","я":"ya","Є":"Ye","І":"I","Ї":"Yi","Ґ":"G","є":"ye","і":"i","ї":"yi","ґ":"g","Č":"C","Ď":"D","Ě":"E","Ň":"N","Ř":"R","Š":"S","Ť":"T","Ů":"U","Ž":"Z","č":"c","ď":"d","ě":"e","ň":"n","ř":"r","š":"s","ť":"t","ů":"u","ž":"z"};for(var k in opt.replacements)s=s.replace(RegExp(k,"g"),opt.replacements[k]);if(opt.transliterate)for(var k in char_map)s=s.replace(RegExp(k,"g"),char_map[k]);var alnum="undefined"==typeof XRegExp?RegExp("[^a-z0-9]+","ig"):XRegExp("[^\\p{L}\\p{N}]+","ig");return s=s.replace(alnum,opt.delimiter),s=s.replace(RegExp("["+opt.delimiter+"]{2,}","g"),opt.delimiter),s=s.substring(0,opt.limit),s=s.replace(RegExp("(^"+opt.delimiter+"|"+opt.delimiter+"$)","g"),""),opt.lowercase?s.toLowerCase():s}function decimalAdjust(type,value,exp){return void 0===exp||0==+exp?Math[type](value):(value=+value,exp=+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp))),value=value.toString().split("e"),+(value[0]+"e"+(value[1]?+value[1]+exp:exp))))}Math.round10||(Math.round10=function(value,exp){return decimalAdjust("round",value,exp)}),Math.floor10||(Math.floor10=function(value,exp){return decimalAdjust("floor",value,exp)}),Math.ceil10||(Math.ceil10=function(value,exp){return decimalAdjust("ceil",value,exp)}),Array.prototype.getObjectFromArray=function(prop,value,a,filter){for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].toString&&"function"==typeof this[i][prop].toString&&(this[i][prop]=this[i][prop].toString()),this[i][prop]&&this[i][prop]==value){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.getOFA=function(prop,value,a,filter){prop=prop.split("."),1==prop.length&&(prop=prop[0]);for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i]&&(this[i][prop]&&this[i][prop].toString&&"function"==typeof this[i][prop].toString&&(this[i][prop]=this[i][prop].toString()),this[i][prop]&&this[i][prop]==value||prop.length&&this[i][prop[0]]&&this[i][prop[0]][prop[1]]&&this[i][prop[0]][prop[1]]==value)){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.removeOFA=function(prop,value){for(var i=this.length;i--;)this[i]&&this[i].hasOwnProperty(prop)&&arguments.length>1&&this[i][prop]===value&&this.splice(i,1);return this},Array.prototype.getArrayObjects=function(prop,value){for(var arr=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].length){var _arr=this[i][prop].map(function(item){return"object"==typeof item?item._id:item});_arr.indexOf(value)>-1&&arr.push(this[i])}return arr},Array.prototype.diff=function(a){return this.filter(function(i){return a.indexOf(i)<0})},Array.prototype.divideArrayWithChunk=function(chunk,fillArrayToEquil){if(!chunk)return[[],[],[],[],[]];if((chunk=Number(chunk))<2)return this;for(var data=this,arr=[],j=0;j<chunk;j++){arr[j]=[];for(var i=j,l=data.length;i<l;i+=chunk)arr[j].push(data[i])}if(fillArrayToEquil)for(var i=1,l=arr.length;i<l;i++)arr[i].length<arr[0].length&&arr[i].push({});return arr},Array.prototype.extend=function(other_array){other_array.forEach(function(v){this.push(v)},this)},String.prototype.clearTag=function(num){return num?this.replace(/<\/?[^>]+(>|$)/g,"").substring(0,num):this.replace(/<\/?[^>]+(>|$)/g,"")},String.prototype.myTrim=function(){return this.trim().split("\n").filter(function(str){return str}).map(function(str){return str.replace(/&nbsp;/g," ").trim()}).filter(function(str){return str}).join("")},String.prototype.clearFirstTag=function(tag){var i=tag.length;return this.substring(2+i,this.length-(3+i))},String.prototype.replaceBlanks=function(){if(this)return this.replace(/(["',.\/\s])/g,"-")},String.prototype.getFormatedDate=function(){var d=new Date(this);return d.getDate()+"-"+(d.getMonth()+1)+"-"+d.getFullYear()},String.prototype.splice||(String.prototype.splice=function(start,delCount,newSubStr){return this.slice(0,start)+newSubStr+this.slice(start+Math.abs(delCount))});new Array("Я","я","Ю","ю","Ч","ч","Ш","ш","Щ","щ","Ж","ж","А","а","Б","б","В","в","Г","г","Д","д","Е","е","Ё","ё","З","з","И","и","Й","й","К","к","Л","л","М","м","Н","н","О","о","П","п","Р","р","С","с","Т","т","У","у","Ф","ф","Х","х","Ц","ц","Ы","ы","Ь","ь","Ъ","ъ","Э","э","/","&"),new Array("Ya","ya","Yu","yu","Ch","ch","Sh","sh","Sh","sh","Zh","zh","A","a","B","b","V","v","G","g","D","d","E","e","E","e","Z","z","I","i","J","j","K","k","L","l","M","m","N","n","O","o","P","p","R","r","S","s","T","t","U","u","F","f","H","h","C","c","Y","y","","","'","'","E","e","-","-");String.prototype.getUrl=function(){return url_slug(this)},String.prototype.shuffle=function(len){len||(len=this.length);for(var parts=this.split(""),i=parts.length;i>0;){var random=parseInt(Math.random()*i),temp=parts[--i];parts[i]=parts[random],parts[random]=temp}return parts.join("").substring(0,len)}}(),function(){function checkMaxDiscount(stuff,price){stuff.maxDiscount&&100*(1-price/stuff.price)>stuff.maxDiscount&&(stuff.maxDiscountOver=!0)}function getOrder(){return new order}var order=function(){function _checkInCondition(__campaign,stuff){var stuffBrand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,stuffCategory="object"==typeof stuff.category&&stuff.category.length?stuff.category[0]:stuff.category;return!!(__campaign.conditionStuffs&&__campaign.conditionStuffs.length&&__campaign.conditionStuffs.indexOf(stuff._id)>-1)||(!!(__campaign.conditionTags&&__campaign.conditionTags.length&&__campaign.conditionTags.some(function(tag){return stuff.tags.indexOf(tag)>-1}))||(!!(__campaign.conditionBrandTags&&__campaign.conditionBrandTags.length&&__campaign.conditionBrandTags.indexOf(stuff.brandTag)>-1)||(!!(__campaign.conditionBrands&&__campaign.conditionBrands.length&&__campaign.conditionBrands.indexOf(stuffBrand)>-1)||(!!(__campaign.conditionCategories&&__campaign.conditionCategories.length&&__campaign.conditionCategories.indexOf(stuffCategory)>-1)||void 0))))}var self=this;this.cart={stuffs:[]},this.seller=null,this.cascade=[],this.opt={},this.campaign=[],this.coupon={},this.totalCount=0,this.sum=0,this.price,this.priceSale,this.retail,this.discount=null,this.currency,this.mainCurrency,this.currencyStore,this.messageForCampaign={},this.type,this.user,this.paySum,this._cartCount=function(campaign,cam){var i=0;return this.cart.stuffs.forEach(function(item){campaign?"withoutcampaign"==campaign?item.campaignId||(cam?_checkInCondition(cam,item)&&(i+=Number(item.quantity)):i+=Number(item.quantity)):item.campaignId==campaign&&(i+=Number(item.quantity)):item.quantity&&(i+=Number(item.quantity))}),i},this._checkDiscount=function(){var dis=this.discount;if(dis)return dis.value||(dis.value=0),1==dis.type||3==dis.type?self.price:2==dis.type||4==dis.type||5==dis.type?self.priceSale?self.priceSale:self.price:void 0},this._getDiscountPrice=function(dis,s){if(dis){if(dis.value||(dis.value=0),1==dis.type)return s.price;if(2==dis.type)return s.priceSale?s.priceSale:s.price;if(3==dis.type)return Math.ceil10(s.price-s.price/100*dis.value,-5);if(4==dis.type)return s.priceSale?s.priceSale:Math.ceil10(s.price-s.price/100*dis.value,-5);if(5==dis.type){var cena;return cena=s.priceSale?s.priceSale:s.price,Math.ceil10(cena-cena/100*dis.value,-5)}}},this._checkDiscount2302=function(){var dis=this.discount;if(dis){if(dis.value||(dis.value=0),1==dis.type)return self.price;if(2==dis.type)return self.priceSale?self.priceSale:self.price;if(3==dis.type)return Math.ceil10(self.price-self.price/100*dis.value,-5);if(4==dis.type)return self.priceSale?self.priceSale:Math.ceil10(self.price-self.price/100*dis.value,-5);if(5==dis.type){var cena;return cena=self.priceSale?self.priceSale:self.price,Math.ceil10(cena-cena/100*dis.value,-5)}}},this._isStuffInCampaign=function(stuff,campaign){function check(__campaign){return!!(__campaign.stuffs&&__campaign.stuffs.length&&__campaign.stuffs.indexOf(stuff._id)>-1)||(!!(__campaign.tags&&__campaign.tags.length&&stuff.tags&&__campaign.tags.some(function(tag){return stuff.tags.indexOf(tag)>-1}))||(!!(__campaign.brandTags&&__campaign.brandTags.length&&__campaign.brandTags.indexOf(stuff.brandTag)>-1)||(!!(__campaign.brands&&__campaign.brands.length&&__campaign.brands.indexOf(stuffBrand)>-1)||(!!(__campaign.categories&&__campaign.categories.length&&__campaign.categories.indexOf(stuffCategory)>-1)||void 0))))}function setCampaignPrice(__campaign){stuff.sticker=__campaign.sticker,stuff.campaignUrl=__campaign.url,stuff.campaignId=__campaign._id;var i=0;for(var key in stuff.stock){var price=Number(stuff.stock[key].price);stuff.stock[key].priceCampaign="percent"==__campaign.condition?Math.ceil10(price-Number(__campaign.percent)/100*price,-2):Math.ceil10(price-Number(__campaign.sum),-2),i||(i++,stuff.priceCampaign=stuff.stock[key].priceCampaign)}}var stuffCategory="object"==typeof stuff.category&&stuff.category.length?stuff.category[0]:stuff.category,stuffBrand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand;if(!self.campaign||!self.campaign.length)return!1;if(campaign){var __campaign=self.campaign.getObjectFromArray("_id",campaign);if(__campaign){var is=check(__campaign);if(is&&!__campaign.revers||!is&&__campaign.revers)return setCampaignPrice(__campaign),__campaign}}else for(var j=0,ll=self.campaign.length;j<ll;j++){var is=check(self.campaign[j]);if(is&&!self.campaign[j].revers||!is&&self.campaign[j].revers)return setCampaignPrice(self.campaign[j]),self.campaign[j]}return!1},this._getCountForBaseStuffs=function(campaign){var q=0;return this.cart.stuffs.forEach(function(item){campaign.forGroupBase?campaign.groupBaseTag&&item.tags&&item.tags.indexOf(campaign.groupBaseTag)>-1?q+=Number(item.quantity):campaign.groupBaseCollection&&campaign.groupBaseCollection==stuff.brandTag&&(q+=Number(item.quantity)):campaign.baseStuffs.indexOf(item._id)>-1&&(q+=Number(item.quantity))}),q},this._checkCompaignCondition=function(id){if(self.campaign){var __campaign=self.campaign.getOFA("_id",id);if(!__campaign||__campaign.forAll||__campaign.revers)return!0;var countConditionStuffs=self._cartCount("withoutcampaign",__campaign);if(!__campaign.ratio)return!0;var countStuff=self._cartCount(__campaign._id);return parseInt(countConditionStuffs/__campaign.ratio)>=countStuff||void 0}},this._checkCompaignConditionForBase=function(id){var campaign=self.campaign.getObjectFromArray("_id",id);if(campaign.useBase&&self._getCountForBaseStuffs(campaign)>=campaign.condition&&!self._cartCount(campaign._id))return!0},this._getUnitOfMeasure=function(){var a=this.cart.stuffs.reduce(function(arr,i){return i.unitOfMeasure&&arr.indexOf(i.unitOfMeasure)<0&&arr.push(i.unitOfMeasure),arr},[]);return 1==a.length?a[0]:null}},_getCascadePrice=function(self){var newPrice=self.price,cascade=self.cascade;if(cascade&&cascade.length){for(var i=0,l=cascade.length;i<l;i++)self.totalCount>=cascade[i][0]&&(newPrice=Math.ceil10(self.price-self.price/100*cascade[i][1],-2));return newPrice}return self.price};order.prototype.init=function(campaign,mainCurrency,currencyStore){this.campaign=campaign,this.mainCurrency=mainCurrency,this.currencyStore=currencyStore},order.prototype.setCamapign=function(campaign){this.campaign=campaign;for(var i=0,l=campaign.length;i<l;i++)this.messageForCampaign[campaign[i].url]={base:null,stuff:null}},order.prototype.setCart=function(stuffs){this.cart.stuffs=stuffs,this.sortCart()},order.prototype.setSellerData=function(seller,cascade,opt){this.seller=seller,this.cascade=cascade,this.opt=opt},order.prototype.setCoupon=function(coupon){this.coupon=coupon},order.prototype.setDiscount=function(discount){this.discount=discount},order.prototype.setCurrency=function(currency){this.currency=currency},order.prototype.changeCurrency=function(currency){this.currency=currency,this.kurs=this.currencyStore[this.currency][0]},order.prototype.getPrice=function(i){var stuff=this.cart.stuffs[i];this.totalCount=this._cartCount(),this.price=stuff.price,this.priceSale=stuff.priceSale,this.retail=stuff.retail,this.priceCampaign=stuff.priceCampaign,stuff.maxDiscountOver=!1;var optIs=!1;(!this.opt||!this.opt.quantity||this.totalCount>=this.opt.quantity)&&(optIs=!0);var cena;return(cena=this._checkDiscount())?(this.discount&&this.discount.value&&stuff.maxDiscount&&this.discount.value>stuff.maxDiscount?stuff.maxDiscountOver=!0:checkMaxDiscount(stuff,cena),cena):stuff.priceCampaign&&optIs&&this._checkCompaignCondition(stuff.campaignId)?stuff.priceCampaign:optIs?this.priceSale?(checkMaxDiscount(stuff,this.priceSale),this.priceSale):_getCascadePrice(this):this.retail||this.price},order.prototype.getTotalSum=function(discount){var sum=0,self=this;if(this.cart.stuffs.forEach(function(c){var s=c.sum?c.sum:c.price;if(discount){var p=self._getDiscountPrice(self.discount,c);p&&(s=p*c.quantity)}sum+=s}),discount){var dis=this.discount;dis&&(6==dis.type?sum=Math.ceil10(sum-sum/100*dis.value,-5):7==dis.type&&(sum-=dis.value))}return sum},order.prototype.getTotalQuantity=function(){var q=0;return this.cart.stuffs.forEach(function(c){q+=Number(c.quantity)}),q},order.prototype.getCampaignQuantity=function(){return this._cartCount("campaign")},order.prototype.getConditionForDisplayMsg=function(){return this.messageForCampaign},order.prototype.getCouponSum=function(){if(!this.coupon||!Object.keys(this.coupon).length)return this.sum;if(!this.coupon.condition)return Math.ceil10(this.sum-this.sum/100*Number(this.coupon.val),-5);if(this.coupon.condition){var val=this.coupon.val;return this.coupon.currency&&this.currencyStore[this.coupon.currency]&&this.currencyStore[this.coupon.currency][0]&&(val=Math.round(val/this.currencyStore[this.coupon.currency][0])),this.sum-Number(val)}},order.prototype.clearOrder=function(){this.cart.stuffs.length=0,this.coupon={},this.totalCount=0,this.sum=0},order.prototype.checkInCart=function(itemTo){return this.cart.stuffs.some(function(c){return itemTo._id==c._id&&itemTo.sort==c.sort})},order.prototype.addStuffToOrder=function(itemTo){if(this.cart.stuffs.length>=150)return!1;if(this.cart.stuffs.some(function(c){return itemTo._id==c._id&&itemTo.sort==c.sort}))return!1;var itemToCart=angular.copy(itemTo);for(var key in itemToCart)"function"==typeof itemToCart[key]&&delete itemToCart[key];return delete itemToCart.comments,delete itemToCart.desc,delete itemToCart.gallery,delete itemToCart.imgs,delete itemToCart.nameL,delete itemToCart.checkInCart,delete itemToCart.addItemToOrder,delete itemToCart.addInfo,delete itemToCart.getDataForBooking,delete itemToCart.FullTags,delete itemToCart.changeSortOfStuff,delete itemToCart.checkInCart,delete itemToCart.driveRetailPrice,delete itemToCart.getBonus,delete itemToCart.zoomImg,delete itemToCart.stockKeysArray,delete itemToCart.sortsOfStuff,delete itemToCart.setPrice,this.cart.stuffs.push(itemToCart),this.sortCart(),!0},order.prototype.getShipCost=function(){return this.shipDetail.reduce(function(s,c){return isNaN(c.sum)?s:s+Number(c.sum)},0)},order.prototype.getTotalPay=function(){return this.pay||(this.pay=[]),this.pay.reduce(function(s,c){return isNaN(c.sum)?s:s+Number(c.sum)},0)},order.prototype.getTotalDiscount=function(){if(this.sum&&this.sum0)return this.sum>this.sum0?0:100-Math.round(100*this.sum/this.sum0)},order.prototype.checkCampaign=function(stuff){return this._isStuffInCampaign(stuff)},order.prototype.sortCart=function(){this.cart.stuffs.sort(function(a,b){if(!a.extCatalog&&!b.extCatalog)return a.category<b.category?-1:a.category>b.category?1:0;if(a.extCatalog&&!b.extCatalog)return 1;if(!a.extCatalog&&b.extCatalog)return-1;if(a.extCatalog&&b.extCatalog&&a.extCatalog!=b.extCatalog){if(a.category<b.category)return-1;if(a.category>b.category)return 1}else if(a.extCatalog&&b.extCatalog&&a.extCatalog==b.extCatalog)return a.category<b.category?-1:a.category>b.category?1:0})};var myShareData={getOrder:getOrder};"undefined"!=typeof window?(window.myShareData=myShareData,window.OrderModel=order):module.exports=myShareData}();var _filterTags=[],_filterTagsO={},myApp=angular.module("gmall",["ngRoute","ui.router","ngResource","ngCookies","ui.bootstrap","ngAnimate","gmall.controllers","gmall.services","gmall.directives","gmall.exception","ui.select","dndLists","daterangepicker","btford.socket-io","toaster","satellizer","ngMessages","ui.mask","ngTouch"]).run(["$rootScope","$state","$stateParams","globalSrv","global","socket","$timeout","$window","$location","$auth",function($rootScope,$state,$stateParams,globalSrv,global,socket,$timeout,$window,$location,$auth){function setNotificationsCount(newNote){var lastCount=$rootScope.notificationsCount;lastCount||0===lastCount||(lastCount=0),$rootScope.notificationsCount=0;for(var type in global.get("notifications").val)newNote&&newNote.type==type&&(global.get("notifications").val[type]++,delete newNote.type),$rootScope.notificationsCount+=global.get("notifications").val[type];if(newNote&&newNote.type){var o=global.get("notifications").val;o?global.get("notifications").val[newNote.type]=1:(o={},o[newNote.type]=1,global.set("notifications",o)),$rootScope.notificationsCount++}$rootScope.notificationsCount&&$rootScope.notificationsCount>lastCount&&$rootScope.soundChat.play()}function getChatUnReadMessages(){var recipient,o={};global.get("seller").val?(o.seller=global.get("seller").val,recipient="seller"):(o.user=global.get("user").val._id,recipient="user"),globalSrv.getData("chatMessages",recipient,o).then(function(response){global.set("chatMessages",response.data),global.set("dialogs",response.data)})}function _changeLocation(url){$window.location.href=url}function _logout(){$rootScope.$broadcast("logout"),$auth.logout(),global.set("user",null),socket.emit("getUser:data",{user:null})}function _logged(){var id=global.get("user").val?global.get("user").val._id:null;$rootScope.$broadcast("logged"),socket.emit("getUser:data",{user:id,seller:global.get("store").val.seller._id,store:global.get("store").val._id})}$timeout(function(){$.material.togglebutton=function(selector){$(selector?selector:this.options.togglebuttonElements).filter(":notmdproc").filter(function(){return 0===$(this).parent().find(".toggle").length}).data("mdproc",!0).after("<span class=toggle></span>")},$.material.init()},1e3),$rootScope.moment=moment,$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.global=global,$rootScope.soundChat=document.getElementById("soundChat"),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState){$timeout(function(){if(!global.get("user").val)return void $state.go("frame")},1e3)}),$rootScope.setDataForSocket=function(seller){if(seller)socket.emit("getUser:data",{user:"seller",seller:seller,store:global.get("store").val._id});else{var id=global.get("user").val._id||null;socket.emit("getUser:data",{user:id,seller:global.get("store").val.seller._id,store:global.get("store").val._id})}getChatUnReadMessages(),getNotifications(seller)},socket.on("connect_failed",function(){console.log("connect_failed")}),socket.on("disconnected",function(){console.log("disconnected")}),socket.on("getUser",function(){global.get("user").val&&(global.get("seller").val?$rootScope.setDataForSocket(global.get("seller").val):$rootScope.setDataForSocket())}),socket.on("newMessage",function(data){var dd=angular.copy(data);$rootScope.$broadcast("newChatMessage",dd);try{var participant=global.get("seller").val?"seller":"user";if(data.recipient!=participant)return;if(data.count=1,data.participant=global.get("seller").val?data.userName:data.sellerName,$rootScope.soundChat.play(),global.get("dialogs").val){global.get("dialogs").val.length||global.set("dialogs",[]);for(var i=0,l=global.get("dialogs").val.length;i<l;i++)if(global.get("dialogs").val[i].dialog==data.dialog){global.get("dialogs").val[i].count++;var is=!0;break}is||global.get("dialogs").val.push(data)}else global.set("dialogs",[data])}catch(err){console.log(err)}}),$rootScope.setInitData=function(){global.set("store",storeTemp),mobileFromServer&&global.set("mobile",mobileFromServer),global.set("local",local),moment.locale(storeTemp.lang);var q={query:JSON.stringify({actived:"true",dateEnd:{$gte:"+Date.now()+"}})},q1={perPage:2,query:JSON.stringify({actived:!0})};globalSrv.getData("groups").then(function(response){global.set("groups",angular.copy(response.data)),response.data&&response.data.length&&response.data.shift(),global.set("sections",response.data)}),globalSrv.getData("categories").then(function(response){response.data.shift(),global.set("categories",response.data);var o={};response.data.forEach(function(c){o[c._id]=c}),global.set("categoriesO",o)}),globalSrv.getData("filters").then(function(response){response.data.shift(),global.set("filters",response.data),globalSrv.getData("filterTags").then(function(response){response.data.shift(),global.set("filterTags",response.data);var filterSticker=global.get("filters").val.getObjectFromArray("sticker",!0);filterSticker&&global.set("filterTagsSticker",global.get("filterTags").val.getObjectFromArray("filter",filterSticker._id,"array","sticker"))})}),globalSrv.getData("brands").then(function(response){response.data.shift(),global.set("brands",response.data)}),globalSrv.getData("campaign",null,q).then(function(response){response.data.shift(),global.set("campaign",response.data)}),globalSrv.getData("coupons",null,q1).then(function(response){response.data.shift(),global.set("coupons",response.data)})},$rootScope.setInitData();var getNotifications=function(seller){var user=global.get("seller").val?"seller":global.get("user").val._id;globalSrv.getData("notifications",user,{seller:seller}).then(function(response){response.data.shift&&response.data.shift(),global.set("notifications",response.data),setNotificationsCount()})};socket.on("newNotification",function(data){setNotificationsCount(data)}),$rootScope.getNotifications=getNotifications,$rootScope.getTotalUnreadMessage=function(){if(global.get("dialogs")&&global.get("dialogs").val&&global.get("dialogs").val.length){var count=0;return global.get("dialogs").val.forEach(function(el){count+=el.count}),count||void 0}},$rootScope.changeLocation=function(url){console.log(url),$window.location.href=url};var functions={changeLocation:_changeLocation,logout:_logout,logged:_logged};global.set("functions",functions);var qm=globalSrv.getData("masters").then(function(response){response.data.shift();var ms=response.data.filter(function(m){return m.actived});return global.set("masters",ms),response.data});global.set("masters",qm);var lang,langError,langOrder,langForm,langNote;globalSrv.getData("lang").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){lang=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("lang",d)}),globalSrv.getData("langError").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langError=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langError",d)}),globalSrv.getData("langNote").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langNote=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langNote",d)}),globalSrv.getData("langOrder").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langOrder=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langOrder",d)}),globalSrv.getData("langForm").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langForm=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langForm",d)}),$timeout(function(){$window.ga&&$window.ga("require","ecommerce")},2e3)}]).config(["$stateProvider","$urlRouterProvider","$locationProvider","globalProvider","$authProvider","$httpProvider",function($stateProvider,$urlRouterProvider,$locationProvider,globalProvider,$authProvider,$httpProvider){$httpProvider.interceptors.push("myInterceptorService"),$authProvider.baseUrl=userHost,$locationProvider.html5Mode(!0),$locationProvider.hashPrefix("!"),globalProvider.setUrl({groups:"/api/collections/Group/",categories:"/api/collections/Category/",filters:"/api/collections/Filter/",filterTags:"/api/collections/FilterTags/",brands:"/api/collections/Brand/",campaign:"/api/collections/Campaign",coupons:"/api/collections/Coupon",notifications:notificationHost+"/api/notificationList",chatMessages:"/api/chatMessagesList",masters:'/api/collections/Master?query={"actived":true}',lang:'/api/collections/Lang?query={"name":"gmall.home"}',langError:'/api/collections/Lang?query={"name":"index.error"}',langNote:'/api/collections/Lang?query={"name":"index.note"}',langOrder:'/api/collections/Lang?query={"name":"index.order"}',langForm:'/api/collections/Lang?query={"name":"index.form"}'}),globalProvider.set("groups"),globalProvider.set("sections"),globalProvider.set("categories"),globalProvider.set("categoriesO"),globalProvider.set("filters"),globalProvider.set("filterTags"),globalProvider.set("brands"),globalProvider.set("campaign"),globalProvider.set("notifications"),globalProvider.set("chatMessages"),globalProvider.set("dialogs"),globalProvider.set("store"),globalProvider.set("user"),globalProvider.set("admin"),globalProvider.set("mobile"),globalProvider.set("local"),globalProvider.set("nostore"),globalProvider.set("filterTagsSticker"),globalProvider.set("coupons"),globalProvider.set("sellers"),globalProvider.set("seller"),globalProvider.set("functions"),globalProvider.set("masters"),globalProvider.set("lang"),globalProvider.set("langError"),globalProvider.set("langNote"),globalProvider.set("langOrder"),globalProvider.set("langForm"),globalProvider.set("services"),$authProvider.baseUrl=userHost,$stateProvider.state("frame",{url:"/manage?token",controller:"mainFrameCtrl",templateUrl:"modules/order/views/index.html"}).state("frame.404",{url:"/404",templateUrl:"modules/order/views/404.html"}).state("frame.orders",{url:"/orders?order",template:"<orders-list></orders-list>"}).state("frame.downloads",{url:"/downloads",template:"<download-stuffs></download-stuffs>"}).state("frame.downloads1",{url:"/downloads1",template:"<download1-stuffs></download1-stuffs>"}).state("frame.downloads2",{url:"/downloads2",template:"<download2-stuffs></download2-stuffs>"}).state("frame.orders.order",{url:"/:id?block",template:"<orders-item></orders-item>"}).state("frame.online",{url:"/online?type",template:"<online-booking></online-booking>"}).state("frame.schedule",{url:"/schedule",template:"<week-schedule></week-schedule>"}).state("frame.schedule.entry",{url:"/:id",template:"<schedule-entry></schedule-entry>"}).state("frame.user",{url:"/user",template:"<user-profile></user-profile>"}).state("frame.dialogs",{url:"/dialogs",cache:!1,templateUrl:function(){return"components/dialogs/dialogs.html"},controller:"dialogsCtrl"}).state("frame.dialogs.dialog",{url:"/:id",cache:!1,templateUrl:function(){return"components/dialogs/dialog.html"},controller:"dialogCtrl"}).state("frame.currency",{url:"/currency",cache:!1,template:"<currency-component></currency-component>"}).state("frame.notification",{url:"/notification?type",templateUrl:function(){return"components/notification/notification.html"},controller:"notificationCtrl"}).state("frame.comments",{url:"/comments",cache:!1,template:"<comment-list></comment-list>"})}]).config(function($provide){}).filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}});angular.module("gmall.directives",[]),angular.module("gmall.controllers",[]).controller("mainFrameCtrl",["$rootScope","$auth","$location","Account","toaster","global","$user","$q",function($rootScope,$auth,$location,Account,toaster,global,$user,$q){function activate(){$q.when($auth.isAuthenticated()).then(function(auth){if(!auth)return $user.login()}).then(function(){return Account.getPermissionOrder()}).then(function(res){console.log(res),res?(global.set("user",res.data),global.set("seller",res.data.seller),$rootScope.$broadcast("logged"),global.get("seller").val?$rootScope.setDataForSocket(global.get("seller").val):$rootScope.setDataForSocket()):(toaster.error("у данного аккаунта нет прав"),logout())}).catch(function(error){return error&&error.data&&toaster.error(error.data.message,error.status),logout()})}function logout(){$q.when($auth.isAuthenticated()).then(function(auth){if(auth)return $auth.logout()}).then(function(){global.set("user",null),global.set("seller",null),$rootScope.setDataForSocket(),activate()})}$rootScope.$stateParams.token&&($auth.setToken({data:{token:$rootScope.$stateParams.token}}),$location.search("token",null)),activate(),$rootScope.logout=logout}]),angular.module("gmall.services",[]).factory("socket",function(socketFactory){return socketFactory({host:socketHost})}),function(){function userSign(){return{scope:{closeModal:"&",toaster:"@",social:"="},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/sign.html",restrict:"AE"}}function subscriptionAdd(){return{scope:{closeModal:"&",toaster:"@"},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/subscriptionAdd.html",restrict:"AE"}}function userSignShort(){return{scope:{toaster:"@",buttonName:"@"},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/sign-short.html",restrict:"AE"}}function userLogin(){return{scope:{closeModal:"&",modalClose:"&",toaster:"@",social:"=",successFoo:"&"},bindings:{toaster:"<",social:"=",successFoo:"&"},bindToController:!0,controller:loginCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/login.html",restrict:"AE"}}function userLoginPhone(){return{scope:{closeModal:"&",modalClose:"&",toaster:"@",social:"=",successFoo:"&"},bindings:{toaster:"<",social:"=",successFoo:"&"},bindToController:!0,controller:loginPhoneCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/loginPhone.html",restrict:"AE"}}function enterButton(){return{scope:{toaster:"@"},bindToController:!0,controller:enterButtonCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/enter-button.html",restrict:"AE"}}function signupCtrl($scope,$auth,toaster,$q,global,Account,$state,Stuff,CreateContent,$email,exception){function signup(form){form.$valid&&(self.user.store=global.get("store").val._id,$auth.signup(self.user).then(function(response){if(response&&response.data&&response.data.token){if("update"==response.data.token)throw $scope.$emit("closeWitget"),toaster.info(response.data.message),null;$auth.setToken(response);var msg=global.get("langNote").val.subscriptionSuccess;return toaster.info(msg),Account.getProfile()}throw response}).then(function(response){if($scope.$emit("closeWitget"),response){if(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}),"cart"==$state.current.name||"stuffs.stuff"==$state.current.name)return;var states=$state.get();if(global.get("paps")&&global.get("paps").val&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","subscription");pap&&pap.url&&$state.go("thanksPage",{id:pap.url})}}}).then(function(){if("subscription"==self.user.type){
if(global.get("coupons")&&global.get("coupons").val&&global.get("coupons").val.length)return[{imgs:global.get("coupons").val}]}else if("subscriptionAdd"==self.user.type){var p={page:0,rows:100},query={$and:[{orderType:4},{actived:!0}]};return Stuff.getList(p,query)}}).then(function(stuffs){if(stuffs&&stuffs.length){if(!self.user||!self.user.email)throw"нет email";var content=CreateContent.emailBonus(stuffs),bonus=global.get("langNote").val.getBonus,domain=global.get("store").val.domain,o={email:self.user.email,content:content,subject:bonus+" ✔",from:"<promo@"+domain+">"};return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note","",global.get("langNote").val.emailSent),resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).catch(function(err){err&&exception.catcher("signup")(err)}))}function authenticate(provider){$auth.authenticate(provider).then(function(response){$scope.$emit("closeWitget"),$auth.setToken(response);var msg=global.get("langNote").val.subscriptionSuccess;toaster.info(msg)}).then(function(){return Account.getProfile()}).then(function(response){console.log(response),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(error){self.toaster&&(error.error?toaster.error(error.error):error.data?toaster.error(error.data.message,error.status):toaster.error(error))})}var self=this;self.global=global,self.formData=global.get("store").val.bonusForm?global.get("store").val.bonusForm:{phone:!0,fields:[]},self.user={email:"",profile:{},addInfo:{},subscription:!0},self.buttonName||self.buttonName,self.signup=signup,self.authenticate=authenticate}function loginCtrl($scope,$auth,toaster,$q,global,Account,exception,sendPhoneFactory,$timeout){function login(form){form.$valid||retrun,self.user.store=global.get("store").val._id,$auth.login(self.user).then(function(data){console.log(data),self.successFoo?self.successFoo():$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite)}).then(function(){return Account.getProfile()}).then(function(response){response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"})),$timeout(function(){$scope.$emit("closeWitget")},50)}).catch(function(err){global.set("user",null),self.toaster&&exception.catcher("login")(err)})}function authenticate(provider){$auth.authenticate(provider).then(function(response){$scope.$emit("closeWitget"),self.successFoo&&"function"==typeof self.successFoo?self.successFoo():$scope.$emit("closeWitget");var msg=global.get("langNote").val.authComplite;toaster.info(msg)}).then(function(){return Account.getProfile()}).then(function(response){response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(error){self.toaster&&(error.error?toaster.error(error.error):error.data?toaster.error(error.data.message,error.status):toaster.error(error))})}function sendCodeToPhone(){self.sendCodeDisable||(self.sendCodeDisable=!0,console.log(self.phone),self.phone&&$q.when().then(function(){return sendPhoneFactory.sendCodeToPhone(self.phone)}).then(function(){self.codeSent=!0,exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)}))}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){self.successFoo?self.successFoo():$scope.$emit("closeWitget"),$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}var self=this;self.$onInit=function(){},self.login=login,self.authenticate=authenticate,self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.global=global,self.phone=null,self.codeSent,self.sendCodeDisable,self.sendVerifyCodeDisable}function enterButtonCtrl(toaster,$q,Account,global,exception){function getEnterButton(form){form.$invalid||$q.when().then(function(){return self.blockButton=!0,setTimeout(function(){self.blockButton=!1},1e3),Account.getEnterButton(self.user)}).then(function(response){self.toaster&&toaster.info(response.data.message)}).catch(function(err){err&&exception.catcher(global.get("langNote").val.error)(err)})}var self=this;self.global=global,self.getEnterButton=getEnterButton}function loginPhoneCtrl($scope,$auth,toaster,$q,global,Account,exception,sendPhoneFactory,$timeout,$user){function sendCodeToPhone(){self.sendCodeDisable||(self.sendCodeDisable=!0,self.phone&&$q.when().then(function(){return sendPhoneFactory.checkPhone(self.phone)}).then(function(res){if(!res||!res._id)return $user.newUserByPhone(self.name,self.phone)}).then(function(){return console.log("sendPhoneFactory.sendCodeToPhone(self.phone)"),sendPhoneFactory.sendCodeToPhone(self.phone)}).then(function(){self.codeSent=!0,exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)}))}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){self.successFoo?self.successFoo():$scope.$emit("closeWitget"),$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}var self=this;self.$onInit=function(){},self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.global=global,self.phone=null,self.name="",self.codeSent,self.sendCodeDisable,self.sendVerifyCodeDisable}angular.module("gmall.directives").directive("userSign",userSign).directive("subscriptionAdd",subscriptionAdd).directive("userSignShort",userSignShort).directive("userLogin",userLogin).directive("userLoginPhone",userLoginPhone).directive("enterButton",enterButton),signupCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","$state","Stuff","CreateContent","$email","exception"],loginCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","exception","sendPhoneFactory","$timeout"],loginPhoneCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","exception","sendPhoneFactory","$timeout","$user"]}(),function(){angular.module("gmall.directives").directive("pswdCheck",["$timeout",function($timeout){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword="#"+attrs.pswdCheck;$timeout(function(){elem.on("keyup",function(){scope.$apply(function(){var v=elem.val()===$(firstPassword).val();console.log(v),ctrl.$setValidity("pswdmatch",v)})})},100)}}}]).directive("passwordMatch",function(){return{require:"ngModel",scope:{otherModelValue:"=passwordMatch"},link:function(scope,element,attributes,ngModel){ngModel.$validators.compareTo=function(modelValue){return!("undefined"!==modelValue&&""!==modelValue&&modelValue||"undefined"!==scope.otherModelValue&&""!==scope.otherModelValue&&scope.otherModelValue)||modelValue===scope.otherModelValue},scope.$watch("otherModelValue",function(){ngModel.$validate()})}}}).directive("passwordStrength",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var indicator=element.children(),dots=Array.prototype.slice.call(indicator.children()),weakest=dots.slice(-1)[0],weak=dots.slice(-2),strong=dots.slice(-3),strongest=dots.slice(-4);element.after(indicator),element.bind("keyup",function(){var tmp,matches={positive:{},negative:{}},counts={positive:{},negative:{}},strength=0;angular.forEach(dots,function(el){el.style.backgroundColor="#ebeef1"}),ngModel.$viewValue&&(matches.positive.lower=ngModel.$viewValue.match(/[a-z]/g),matches.positive.upper=ngModel.$viewValue.match(/[A-Z]/g),matches.positive.numbers=ngModel.$viewValue.match(/\d/g),matches.positive.symbols=ngModel.$viewValue.match(/[$-\/:-?{-~!^_`\[\]]/g),matches.positive.middleNumber=ngModel.$viewValue.slice(1,-1).match(/\d/g),matches.positive.middleSymbol=ngModel.$viewValue.slice(1,-1).match(/[$-\/:-?{-~!^_`\[\]]/g),counts.positive.lower=matches.positive.lower?matches.positive.lower.length:0,counts.positive.upper=matches.positive.upper?matches.positive.upper.length:0,counts.positive.numbers=matches.positive.numbers?matches.positive.numbers.length:0,counts.positive.symbols=matches.positive.symbols?matches.positive.symbols.length:0,counts.positive.numChars=ngModel.$viewValue.length,tmp+=counts.positive.numChars>=8?1:0,counts.positive.requirements=tmp>=3?tmp:0,counts.positive.middleNumber=matches.positive.middleNumber?matches.positive.middleNumber.length:0,counts.positive.middleSymbol=matches.positive.middleSymbol?matches.positive.middleSymbol.length:0,matches.negative.consecLower=ngModel.$viewValue.match(/(?=([a-z]{2}))/g),matches.negative.consecUpper=ngModel.$viewValue.match(/(?=([A-Z]{2}))/g),matches.negative.consecNumbers=ngModel.$viewValue.match(/(?=(\d{2}))/g),matches.negative.onlyNumbers=ngModel.$viewValue.match(/^[0-9]*$/g),matches.negative.onlyLetters=ngModel.$viewValue.match(/^([a-z]|[A-Z])*$/g),counts.negative.consecLower=matches.negative.consecLower?matches.negative.consecLower.length:0,counts.negative.consecUpper=matches.negative.consecUpper?matches.negative.consecUpper.length:0,counts.negative.consecNumbers=matches.negative.consecNumbers?matches.negative.consecNumbers.length:0,strength+=4*counts.positive.numChars,counts.positive.upper&&(strength+=2*(counts.positive.numChars-counts.positive.upper)),counts.positive.lower&&(strength+=2*(counts.positive.numChars-counts.positive.lower)),(counts.positive.upper||counts.positive.lower)&&(strength+=4*counts.positive.numbers),strength+=6*counts.positive.symbols,strength+=2*(counts.positive.middleSymbol+counts.positive.middleNumber),strength+=2*counts.positive.requirements,strength-=2*counts.negative.consecLower,strength-=2*counts.negative.consecUpper,strength-=2*counts.negative.consecNumbers,matches.negative.onlyNumbers&&(strength-=counts.positive.numChars),matches.negative.onlyLetters&&(strength-=counts.positive.numChars),strength=Math.max(0,Math.min(100,Math.round(strength))),strength>85?angular.forEach(strongest,function(el){el.style.backgroundColor="#008cdd"}):strength>65?angular.forEach(strong,function(el){el.style.backgroundColor="#6ead09"}):strength>30?angular.forEach(weak,function(el){el.style.backgroundColor="#e09115"}):weakest.style.backgroundColor="#e01414")})},template:'<span class="password-strength-indicator"><span></span><span></span><span></span><span></span></span>'}})}(),angular.module("gmall.exception",[]).factory("exception",exception),exception.$inject=["toaster"],angular.module("gmall.services").factory("Confirm",confirmFactory),confirmFactory.$inject=["$q","$uibModal"],angular.module("gmall.services").factory("myInterceptorService",function($q,$rootScope,$templateCache){var keys=$templateCache.getKeys(),store=globalStoreId;try{globalCrawler&&globalCrawler}catch(err){}return{request:function(config){return keys.indexOf(config.url)>-1?config:(config.params=config.params||{},config.params.store||(config.params.store=store),$rootScope.global&&$rootScope.global.get("store")&&$rootScope.global.get("store").val&&$rootScope.global.get("store").val.lang&&(config.params.lang=$rootScope.global.get("store").val.lang),config)},response:function(response){return response.status,response}}}),angular.module("gmall").config(["$provide",function($provide){$provide.decorator("$templateCache",["$delegate",function($delegate){var keys=[],origPut=$delegate.put;return $delegate.put=function(key,value){origPut(key,value),keys.push(key)},$delegate.getKeys=function(){return keys},$delegate}])}]),angular.module("gmall.services").service("Store",function($resource,$q,$uibModal,$http){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function upload(item){var url=storeHost?"http://"+storeHost+"/api/upload/"+item._id:"/api/upload/"+item._id;return $http.get(url)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/storeSetting/createStore.html",controller:createStoreCtrl,controllerAs:"$ctrl"}).result.then(function(store){store.name?(store.name=store.name.substring(0,25),resolve(store)):reject("empty")},function(err){reject(err)})})}function selectPartOfTemplate(stores){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/selectStore.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,stores){function selectStore(store){$uibModalInstance.close(store)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.stores=stores,self.selectStore=selectStore,self.cancel=cancel},resolve:{stores:function(){return stores}}}).result}function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/selectItem.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}function createStoreCtrl($uibModalInstance,exception,$user){function addOwner(){$user.selectItem().then(function(user){self.user=user})}var self=this;self.name="",self.addOwner=addOwner,self.ok=function(){if(!self.name)return void exception.catcher("создание магазина")("нужено название");$uibModalInstance.close({name:self.name})},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Store/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,upload:upload,create:create,selectPartOfTemplate:selectPartOfTemplate,selectItemFromList:selectItemFromList}}).service("Template",function($resource,$q,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/storeSetting/createTemplate.html",controller:createTemplateCtrl,controllerAs:"$ctrl"}).result.then(function(o){o.name?(o.name=o.name.substring(0,25),resolve(o)):reject("empty")},function(err){reject(err)})})}function createTemplateCtrl($uibModalInstance,exception){var self=this;self.name="",self.folder="",self.ok=function(){if(!self.name||!self.folder)return void exception.catcher("создание шаблона")("нужено имя и папка");$uibModalInstance.close({name:self.name,folder:self.folder})},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Template/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}).service("BlocksConfig",function($resource,$q,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0,rows:500}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/selectItemForBlocks.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}var Items=$resource("/api/collections/BlocksConfig/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,selectItemFromList:selectItemFromList}}).service("Config",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Config/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}).service("ConfigData",function($resource,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/ConfigData/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}).service("Seller",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}function getItem(id,param){function getItemComplete(response){return response}return Items.get({_id:id,param:param}).$promise.then(getItemComplete)}var Items=$resource("/api/collections/Seller/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}).service("siteName",function($uibModal){function choiceName(data){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/websiteName.html",controller:function($uibModalInstance,global,Store,data){function checkSubDomain(name){if(name&&!(name.length>20)){var o={};o[self.field]=name.toLowerCase(),Store.query({query:o},function(res){res&&res.length?(console.log(!0),self.exist=!0):self.exist=!1},function(err){self.exist=!0})}}var self=this;self.global=global,self.item="",self.focus=!0,self.windowName="Выберите поддомен",self.field="subDomain",data&&(data.windowName&&(self.windowName=data.windowName),data.field&&(self.field=data.field)),self.checkSubDomain=checkSubDomain,self.exist=!1,self.re=/^[a-zA-Z0-9][a-zA-Z0-9-_\.]{1,20}$/,self.ok=function(websiteNameForm){websiteNameForm.$invalid||self.exist||$uibModalInstance.close(self.item.toLowerCase())},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{data:function(){return data}}}).result}return{choiceName:choiceName}}),angular.module("gmall.services").service("Sections",sectionServiceFunction).service("selectCategoryFromModal",function($q,$uibModal){this.bind=function(categoryId){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/selectCategoryModal/selectCategoryModal.html",controller:"selectCategoryModalCtrl",size:"lg",resolve:{categoryId:function(){return categoryId}}};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}}),sectionServiceFunction.$inject=["$resource","$q","global","$uibModal","$timeout"],function(){function categoryService($resource,$uibModal,$q){function save(){return Items.save.apply(this,arguments).$promise.then(function(){})}function select(categoryId,selectSection,sections,forGroupStuffs){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectCategoryModal.html",controller:selectCategoryCtrl,size:"lg",resolve:{categoryId:function(){return categoryId},selectSection:function(){return selectSection},sections:function(){return sections?sections:null},forGroupStuffs:function(){return forGroupStuffs?forGroupStuffs:null}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){reject()})})}function selectWithSection(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectCategoryWithSectionModal.html",controller:selectCategoryWithSectionCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){reject()})})}var Items=$resource("/api/collections/Category/:_id",{_id:"@_id"});return{get:Items.get,query:Items.query,save:save,delete:Items.delete,select:select,selectWithSection:selectWithSection}}function selectCategoryCtrl($q,$uibModalInstance,Sections,categoryId,selectSection,sections,forGroupStuffs){var self=this;self.categoryId=categoryId,self.selectSection=selectSection,$q.when().then(function(){return sections?sections:Sections.getSections()}).then(function(sections){self.sections=sections.filter(function(s){return forGroupStuffs?s.groupStuffs:!s.groupStuffs})}),self.ok=function(selectedCategory){$uibModalInstance.close(selectedCategory)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}function selectCategoryWithSectionCtrl($q,$uibModalInstance,Sections){var self=this;$q.when().then(function(){return Sections.getSections()}).then(function(sections){self.sections=sections}),self.ok=function(selectedCategory){$uibModalInstance.close(selectedCategory)},self.okSection=function(section){var categories=section.categories;$uibModalInstance.close(categories)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}angular.module("gmall.services").service("Category",categoryService),categoryService.$inject=["$resource","$uibModal","$q"],selectCategoryCtrl.$inject=["$q","$uibModalInstance","Sections","categoryId","selectSection","sections","forGroupStuffs"],selectCategoryWithSectionCtrl.$inject=["$q","$uibModalInstance","Sections"]}(),function(){function brandTagsService($resource,$uibModal,$q,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function selectBrandTag(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/brand/selectBrandTag.html",controller:selectBrandTagCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectBrandTagCtrl(Brands,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Brands.getBrands()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),filterTag.brand=self.filters.find(function(b){return b._id==filterTag.brand}),$uibModalInstance.close(filterTag)}}var Items=$resource("/api/collections/BrandTags/:id",{id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,selectBrandTag:selectBrandTag,select:selectBrandTag}}angular.module("gmall.services").service("Brands",function($resource,$q,global,$uibModal,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function returnBrands(resolve){pending?setTimeout(function(){returnBrands(resolve)},300):resolve(brands)}function reloadItems(){pending=!0,Items.query(function(res){res.shift(),brands=res,global.set("brands",brands),pending=!1})}function selectBrand(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/brand/selectBrand.html",controller:selectBrandCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectBrandCtrl(Brands,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Brands.getBrands()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),$uibModalInstance.close(filterTag)}}var Items=$resource("/api/collections/Brand/:id",{id:"@_id"}),brands=null,pending=!0;this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.reloadItems=reloadItems,this.select=selectBrand,this.getList=getList,this.getItem=getItem,this.getBrands=function(){return $q(function(resolve,reject){if(global.get("brands")&&global.get("brands").val)return brands||(brands=global.get("brands").val),resolve(global.get("brands").val);pending?setTimeout(function(){returnBrands(resolve)},300):brands?resolve(brands):(pending=!0,Items.query(function(res){res.shift(),brands=res?res:[],pending=!1,resolve(brands)},function(err){pending=!1,reject(err)}))})},global.get("brands")&&global.get("brands").val||Items.query(function(res){res.shift(),brands=res,global.get("brands")&&!global.get("brands").val&&global.set("brands",brands),pending=!1}),selectBrandCtrl.$inject=["Brands","$uibModalInstance","$q","global","sections"]}).service("BrandTags",brandTagsService),brandTagsService.$inject=["$resource","$uibModal","$q","Sections"]}(),angular.module("gmall.controllers").controller("stuffsFilterCtrl",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll","$timeout",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll,$timeout){function _getCollections(){var query={brand:$scope.stuffsFilterCtrl.query.brand,group:$scope.stuffsFilterCtrl.query.section};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffsFilterCtrl.brandCollections=res,$scope.stuffsFilterCtrl.brandCollections&&$stateParams.brandTag){var brandTag=$scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffsFilterCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}})}function _getQueryTag(){var arr=[];return $scope.stuffsFilterCtrl.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr.length?arr.map(function(tag){return global.get("filterTags").val.getObjectFromArray("_id",tag).url}).join("+"):void 0}function _getBrand(){if($scope.stuffsFilterCtrl.query.brand)return global.get("brands").val.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.brand).url}function _getBrandTag(){if($scope.stuffsFilterCtrl.query.brandTag)return $scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.brandTag).url}var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.stuffsFilterCtrl=this,$scope.stuffsFilterCtrl.paginate={page:0,rows:50,
totalItems:0},$scope.stuffsFilterCtrl.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$scope.stuffsFilterCtrl.categories=[];var queryTags,category;$scope.stuffsFilterCtrl.brands=[],$scope.stuffsFilterCtrl.brandCollections=[],$scope.stuffsFilterCtrl.filters=[],function(){var q=$q.defer();return q.resolve(),q.promise}().then(function(){var q=$q.defer();if("brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl){var group=global.get("groups").val.getObjectFromArray("url",$stateParams.groupUrl);if(group){if($scope.stuffsFilterCtrl.query.section=group._id,$stateParams.parentGroup){var categories=$section.getCategories($stateParams.parentGroup).map(function(i){return i._id?i._id:i});categories&&($scope.stuffsFilterCtrl.categories=global.get("categories").val.filter(function(item){return categories.indexOf(item._id)>-1}))}q.resolve($scope.stuffsFilterCtrl.categories)}else $state.go("404")}else q.resolve(1);return q.promise}).then(function(r){var q=$q.defer();return $scope.stuffsFilterCtrl.categories.length&&$stateParams.categoryUrl?"id"!=$stateParams.categoryUrl&&(category=$scope.stuffsFilterCtrl.categories.getObjectFromArray("url",$stateParams.categoryUrl),category?$scope.stuffsFilterCtrl.query.category=category._id:$state.go("404")):"id"!=$stateParams.categoryUrl&&(category=global.get("categories").val.getObjectFromArray("url",$stateParams.categoryUrl))&&($scope.stuffsFilterCtrl.query.category=category._id,$scope.stuffsFilterCtrl.categories=$section.getCategories(category.group.url)),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.category&&($scope.stuffsFilterCtrl.brands=global.get("brands").val.getArrayObjects("categories",$scope.stuffsFilterCtrl.query.category)),1===$scope.stuffsFilterCtrl.brands.length)$scope.stuffsFilterCtrl.query.brand=$scope.stuffsFilterCtrl.brands[0]._id;else if($stateParams.brand){var brand=$scope.stuffsFilterCtrl.brands.getObjectFromArray("url",$stateParams.brand);brand&&($scope.stuffsFilterCtrl.query.brand=brand._id,$location.search("brand",brand.url))}return $scope.stuffsFilterCtrl.query.brand||$location.search("brand",null),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.brand){var query={brand:$scope.stuffsFilterCtrl.query.brand,group:$scope.stuffsFilterCtrl.query.section};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffsFilterCtrl.brandCollections=res,$stateParams.brandTag){var brandTag=$scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffsFilterCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}q.resolve(1)},function(){q.resolve(3)})}else q.resolve(2);return q.promise}).then(function(){var q=$q.defer();return $stateParams.queryTag&&(queryTags=$stateParams.queryTag.split("+"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),queryTags=queryTags.reduce(function(tags,tag){var t;return(t=global.get("filterTags").val.getObjectFromArray("url",tag))&&tags.push(t),tags},[])),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.category){var filters=global.get("filters").val.filter(function(item){return!item.dontshow&&category.filters.indexOf(item._id)>-1});filters.forEach(function(item,i){item.tags=[],global.get("filterTags").val.forEach(function(tag){tag.filter==item._id&&item.tags.push(tag)}),queryTags&&queryTags.length&&queryTags.forEach(function(tag){tag.filter==item._id&&($scope.stuffsFilterCtrl.query.tags[i]||($scope.stuffsFilterCtrl.query.tags[i]=[]),$scope.stuffsFilterCtrl.query.tags[i].push(tag._id))})}),$scope.stuffsFilterCtrl.filters=filters}else queryTags&&queryTags.length&&($scope.stuffsFilterCtrl.query.tags[0]=[queryTags[0]._id],$location.search("queryTag",queryTags[0].url));return q.resolve("finsh"),q.promise}).then(function(r){$scope.stuffsFilterCtrl.getList($scope.stuffsFilterCtrl.paginate.page,$scope.stuffsFilterCtrl.paginate.rows)});var prevBrand;$scope.stuffsFilterCtrl.getList=function(page,rows){prevBrand=$scope.stuffsFilterCtrl.query.brand;var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});var queryTag=[];for(var key in $scope.stuffsFilterCtrl.query)if($scope.stuffsFilterCtrl.query[key])if("tags"==key){var qu=[];$scope.stuffsFilterCtrl.query[key].filter(function(){return!0});$scope.stuffsFilterCtrl.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.stuffsFilterCtrl.query[key],query.push(obj)}query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):"";var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand(),queryTagsForSEO="";queryTag&&(queryTagsForSEO+="queryTag="+queryTag),brand&&(queryTagsForSEO&&(queryTagsForSEO+="&"),queryTagsForSEO+="brand="+brand),brandTag&&(queryTagsForSEO&&(queryTagsForSEO+="&"),queryTagsForSEO+="brandTag="+brandTag),console.log(queryTagsForSEO),$rootScope.$broadcast("$allDataLoaded",{state:$state.current.name,data:queryTagsForSEO}),$scope.stuffsFilterCtrl.queryForDirective=query},$scope.stuffsFilterCtrl.changeFilter=function(c){$anchorScroll();var category=$scope.stuffsFilterCtrl.query.category?$scope.stuffsFilterCtrl.categories.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.category):{name:"category",url:"id"};if(c){$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:category.url,categoryName:category.name,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else{$location.search(""),$scope.stuffsFilterCtrl.query.artikul="",!$scope.stuffsFilterCtrl.query.brand||$scope.stuffsFilterCtrl.brandCollections&&prevBrand==$scope.stuffsFilterCtrl.query.brand?$scope.stuffsFilterCtrl.query.brand||($scope.stuffsFilterCtrl.brandCollections=null,$scope.stuffsFilterCtrl.query.brandTag=""):(_getCollections($scope.stuffsFilterCtrl.query.brand),$scope.stuffsFilterCtrl.query.brandTag=""),$scope.stuffsFilterCtrl.paginate.page=0,$scope.stuffsFilterCtrl.getList($scope.stuffsFilterCtrl.paginate.page,$scope.stuffsFilterCtrl.paginate.rows);var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand();queryTag&&$location.search("queryTag",queryTag),brandTag&&$location.search("brandTag",brandTag),brand&&$location.search("brand",brand),$stateParams.brandTag&&$location.search("brandTag",$stateParams.brandTag)}},$scope.stuffsFilterCtrl.clearFilter=function(){console.log("clear filetrs"),$scope.stuffsFilterCtrl.query.tags=[],$scope.stuffsFilterCtrl.changeFilter()}}]).controller("stuffsLWPCtrl",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll","$timeout",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll,$timeout){var $state=$rootScope.$state;$rootScope.$stateParams;$scope.stuffsLWPCtrl=this,$scope.stuffsLWPCtrl.query=null,$scope.stuffsLWPCtrl.paginate={page:0,rows:20,totalItems:0},$scope.stuffsLWPCtrl.query=null,$scope.stuffsLWPCtrl.getList=function(page,rows){Stuff.getList($scope.stuffsLWPCtrl.query,null,page,rows,$scope.stuffsLWPCtrl.paginate).then(function(res){$scope.stuffsLWPCtrl.items=res,$scope.stuffsLWPCtrl.query=null},function(err){$state.go("404")})},$scope.$watch(function(){return $scope.stuffsLWPCtrl.query},function(n){n&&($scope.stuffsLWPCtrl.paginate.page=0,$scope.stuffsLWPCtrl.getList($scope.stuffsLWPCtrl.paginate.page,$scope.stuffsLWPCtrl.paginate.rows))}),$timeout(function(){$scope.stuffsLWPCtrl.getList($scope.stuffsLWPCtrl.paginate.page,$scope.stuffsLWPCtrl.paginate.rows)}),$scope.getUrlParams=Stuff.getUrlParams,$scope.getCategoryName=Stuff.getCategoryName,$scope.getBrandName=Stuff.getBrandName}]),function(){function stuffService($resource,$uibModal,$q,Sections,$stateParams,$state,$location,Brands,FilterTags,global,$order,exception,$user,$email,CreateContent,$rootScope,Filters,$timeout){function _salePrice(doc,sale){if(doc.driveSalePrice&&doc.driveSalePrice.maxDiscount&&(doc.maxDiscount=doc.driveSalePrice.maxDiscount),doc.driveSalePrice&&0!=doc.driveSalePrice.type){if(2==doc.driveSalePrice.type){doc.priceSale=Math.ceil10(Number(doc.price)-sale*doc.price,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale*doc.stock[key].price,-2)}else if(1==doc.driveSalePrice.type)if(doc.driveSalePrice.condition){sale=doc.driveSalePrice.percent/100,doc.priceSale=Math.ceil10(Number(doc.price)-sale*doc.price,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale*doc.stock[key].price,-2)}else{sale=Number(doc.driveSalePrice.sum),doc.priceSale=Math.ceil10(Number(doc.price)-sale,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale,-2)}}else{doc.priceSale=0;for(var key in doc.stock)doc.stock[key].priceSale=0}}function _retailPrice(doc,retail){if(doc.driveRetailPrice||(global.get("store").val.seller.retail?doc.driveRetailPrice={type:2}:doc.driveRetailPrice={type:0}),0==doc.driveRetailPrice.type){doc.retail=0;for(var key in doc.stock)doc.stock[key].retail=0}else if(2==doc.driveRetailPrice.type){doc.retail=Math.ceil10(Number(doc.price)+retail*Number(doc.price),-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail*doc.stock[key].price,-2)}else if(1==doc.driveRetailPrice.type)if(doc.driveRetailPrice.condition){retail=doc.driveRetailPrice.percent/100,doc.retail=Math.ceil10(Number(doc.price)+retail*doc.price,-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail*doc.stock[key].price,-2)}else{retail=Number(doc.driveRetailPrice.sum),doc.retail=Math.ceil10(Number(doc.price)+retail,-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail,-2)}}function _setPrice(doc){doc||(doc=this),doc.price<0&&(doc.price=0),doc.sort=null;var sale=(global.get("store").val.seller.sale||0)/100,retail=(global.get("store").val.seller.retail||0)/100,el=doc?doc:this;if(el.stock&&"object"==typeof el.stock?el.stock.notag&&(el.stock.notag.price=el.price):(el.stock={notag:{quantity:1,price:el.price}},el.sort="notag"),global.get("currency")&&el.currency&&global.get("store").val.mainCurrency!=el.currency){el.price=Math.ceil10(Number(el.price)/Number(global.get("store").val.currency[el.currency][0]),-2);for(var tag in el.stock)el.stock[tag].price=Math.ceil10(Number(el.stock[tag].price)/Number(global.get("store").val.currency[el.currency][0]),-2)}return _salePrice(el,sale),_retailPrice(el,retail),el}function _changeSortOfStuff(sort){if(!(this.stock&&sort&&this.stock[sort])||this.stock[sort].quantity)if(sort&&(this.sort=sort),this.sort){var sort=this.stock[this.sort];this.sortName=sort.name,this.price=sort.price,this.priceSale=sort.priceSale,this.retail=sort.retail,this.priceCampaign=sort.priceCampaign}else this.sortName=null,this.stock&&this.stock.notag||(this.price=0,this.priceSale=0,this.retail=0)}function _addItemToOrder(){var self=this;if(!this.sort)return this.unableToOrder=!0,$timeout(function(){self.unableToOrder=!1},2500),"nosort";this.sortsOfStuff&&this.sortsOfStuff.filter&&!this.sort?exception.catcher("ошибка")("выберите разновидность"):(this.stock[this.sort].name&&(this.sortName=this.stock[this.sort].name),$order.addItemToCart(this)),$rootScope.$emit("AddToCart")}function _dateTime(){var self=this;if(!this.sort)return this.unableToOrder=!0,$timeout(function(){self.unableToOrder=!1},2500),"nosort";global.get("functions").val.witget("dateTime",{stuff:this})}function _setSticker(stuff){return FilterTags.getSticker(stuff.tags)}function _checkInCart(){return $order.checkInCart(this)}function zoomImgGlobal(i,images,home){var img,horizontalOrient,imgs=$("img[src$='"+images[i].img+"']");if(imgs&&imgs[0]?(img=$(imgs[0]),img.width()&&img.height()&&img.width()>img.height()&&(horizontalOrient=!0)):(imgs=$("img[src$='"+images[i].thumb+"']"),imgs&&imgs[0]?(img=$(imgs[0]),img.width()&&img.height()&&img.width()>img.height()&&(horizontalOrient=!0)):images[i].el&&images[i].el.width&&images[i].el.height&&images[i].el.width>images[i].el.height&&(horizontalOrient=!0)),!delay){delay=!0,$timeout(function(){delay=!1},1e3);var content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no",viewPort=document.getElementById("viewport"),templ=global.get("store").val.template.addcomponents&&global.get("store").val.template.addcomponents.zoom&&global.get("store").val.template.addcomponents.zoom.templ?global.get("store").val.template.addcomponents.zoom.templ:"",templateUrl="views/template/partials/stuffDetail/modal/zoom"+templ+".html";viewPort.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=3"),$rootScope.$emit("modalOpened");var options={animation:!0,bindToController:!0,controllerAs:"$ctrl",windowClass:function(){return horizontalOrient?"zoom zoom-modal-horizontal":"zoom zoom-modal-vertical"},templateUrl:templateUrl,controller:function($uibModalInstance,global,gallery,i,home,horizontalOrient){function next(i){delay||(delay=!0,i+1==self.gallery.length?(self.gallery[0].active=!0,self.idx=0):(self.gallery[i+1].active=!0,self.idx=i+1),$timeout(function(){delay=!1},500))}function prev(i){delay||(delay=!0,0==i?(self.gallery[self.gallery.length-1].active=!0,self.idx=self.gallery.length-1):(self.gallery[i-1].active=!0,self.idx=i-1),$timeout(function(){delay=!1},500))}function chancheActiveSlide(i){self.gallery[i].active=!0,self.idx=i}var self=this;self.style=home?horizontalOrient?"width:98vw;height:auto":"height:93vh;width:auto":"width:100%",self.modal=global.get("mobile").val,self.idx=i,self.gallery=angular.copy(gallery),self.gallery[i].active=!0,self.next=next,self.prev=prev,self.chancheActiveSlide=chancheActiveSlide;var delay=!1;self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{gallery:function(){return images},i:function(){return i},home:function(){return home},horizontalOrient:horizontalOrient}};home||(options.size="lg"),$q.when().then(function(){return $uibModal.open(options).result}).then(function(res){viewPort.setAttribute("content",content),$rootScope.$emit("modalClosed")}).catch(function(err){viewPort.setAttribute("content",content),$rootScope.$emit("modalClosed"),err&&"backdrop click"!=err&&(err=err.data||err,exception.catcher("zoom")(err))})}}function _zoomImg(i){zoomImgGlobal(i,this.gallery)}function _setCategoryName(item){if(item.category&&item.category._id&&(item.category=[item.category]),item.category&&item.category.length)for(var i=0,c=null;i<item.category.length&&!c;)"object"==typeof item.category[i]&&(item.category[i]=item.category[i]._id),global.get("categoriesO").val[item.category[i]]&&(c=global.get("categoriesO").val[item.category[i]]),i++;if(global.get("categories").val&&(c||(c=categoriesLink[item.category]?categoriesLink[item.category]:global.get("categories").val.getOFA("_id",item.category)),c?(item.categoryUrl=c.url,item.categoryName=c.name,c.linkData?(item.groupUrl=c.linkData.groupUrl,item.parentGroup=c.linkData.parentGroup||null):(item.groupUrl="group",item.categoryUrl="category",item.parentGroup=null)):(item.groupUrl="group",item.categoryUrl="category")),item.brand&&global.get("brands")&&global.get("brands").val){"object"==typeof item.brand&&(item.brand=item.brand._id);var b=global.get("brands").val.getOFA("_id",item.brand);if(b&&(item.brandUrl=b.url,item.brandName=b.name,item.brandTag)){var bt=b.tags.getOFA("_id",item.brandTag);bt&&(item.brandTagUrl=bt.url,item.brandTagName=bt.name)}}}function _setDataForStuff(stuff,filterTags,stuffsState){if(stuff.changeSortOfStuff=_changeSortOfStuff,stuff.addItemToOrder=_addItemToOrder,stuff.dateTime=_dateTime,stuff.onSelected=_onSelectedSort,stuff.order=_orderStuff,stuff.getBonus=_getBonus,stuff.zoomImg=_zoomImg,stuff.checkInCart=_checkInCart,stuff.getDataForBooking=_getDataForBooking,_setCategoryName(stuff),_setPrice(stuff),stuff.setPrice=_setPrice,stuff.multiple&&stuff.minQty?stuff.quantity=Number(stuff.minQty):(stuff.quantity=1,stuff.minQty=1),stuff.single||(stuff.maxQty=150),stuff.sale||_checkCamapign(stuff),stuff.expected=!0,stuff.stock&&"object"==typeof stuff.stock&&!stuff.stock.notag){if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filterGroup&&global.get("filtersO")&&global.get("filtersO").val&&global.get("filtersO").val[stuff.sortsOfStuff.filterGroup]){var filterGroupTags,filterGroup=global.get("filtersO").val[stuff.sortsOfStuff.filterGroup];if(filterGroup){stuff.sortsOfStuff.name=filterGroup.name.charAt(0).toUpperCase()+filterGroup.name.slice(1).toLowerCase(),stuff.groupName=stuff.sortsOfStuff.name,filterGroupTags=filterGroup.tags.map(function(t){return t._id});for(var ii=0;ii<stuff.tags.length;ii++){var idx=filterGroupTags.indexOf(stuff.tags[ii]);if(idx>-1){stuff.groupTagName=filterGroup.tags[idx].name.charAt(0).toUpperCase()+filterGroup.tags[idx].name.slice(1).toLowerCase();break}}}}if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&global.get("filtersO")&&global.get("filtersO").val&&global.get("filtersO").val[stuff.sortsOfStuff.filter]&&(stuff.filterName=global.get("filtersO").val[stuff.sortsOfStuff.filter].name.toLowerCase(),stuff.filterName=stuff.filterName.charAt(0).toUpperCase()+stuff.filterName.slice(1).toLowerCase()),stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs)for(var i21=0;i21<stuff.sortsOfStuff.stuffs.length;i21++)if(stuff.sortsOfStuff.stuffs[i21]._id!=stuff._id&&stuff.sortsOfStuff.stuffs[i21].archived)stuff.sortsOfStuff.stuffs.splice(i21,1),i21--;else if(stuff.sortsOfStuff.stuffs[i21].stock&&"object"==typeof stuff.sortsOfStuff.stuffs[i21].stock)for(var k in stuff.sortsOfStuff.stuffs[i21].stock)stuff.sortsOfStuff.stuffs[i21].stock[k].quantity&&(stuff.sortsOfStuff.stuffs[i21].stock[k].quantity=Number(stuff.sortsOfStuff.stuffs[i21].stock[k].quantity));var keys=Object.keys(stuff.stock);stuff.stockKeysArray=keys.map(function(k){if(stuff.stock[k].quantity=Number(stuff.stock[k].quantity),global.get("filterTagsO")&&global.get("filterTagsO").val&&global.get("filterTagsO").val[k])var tag=global.get("filterTagsO").val[k];else var tag=filterTags.getOFA("_id",k);return tag?{_id:k,index:tag.index,name:tag.name,quantity:Number(stuff.stock[k].quantity)}:null}).filter(function(key){return key}).sort(function(a,b){return a&&b?a.index-b.index:1});var sort_Id=null;stuff.stockKeysArray.forEach(function(key){stuff.sort||global.get("sectionType")&&global.get("sectionType").val&&global.get("store").val.template.stuffListType[global.get("sectionType").val].unsetSort&&"stuffs.stuff"==$state.current.name&&!stuffsState||!sort_Id&&stuff.stock[key._id].quantity&&(sort_Id=key._id,stuff.sort=sort_Id),key.quantity=Number(stuff.stock[key._id].quantity),key.quantity&&stuff.expected&&(stuff.expected=!1),key.quantity&&(stuff.multiple&&stuff.minQty?key.quantity=Number(stuff.minQty):(key.quantity=1,stuff.minQty=1)),stuff.stock[key._id].name=key.name}),stuff.stockKeysArray.length&&sort_Id&&_changeSortOfStuff.call(stuff,sort_Id)}else stuff.stock&&"object"==typeof stuff.stock&&stuff.stock.notag&&(stuff.stock.notag.quantity&&(stuff.sort="notag",stuff.expected=!1),stuff.stockKeysArray=[{name:"notag",_id:"notag",quantity:stuff.stock.notag.quantity}]);if(stuff.campaignId||(stuff.sticker=_setSticker(stuff)),stuff.gallery&&stuff.gallery.length&&stuff.gallery.sort(function(a,b){return a.index-b.index}),!stuffsState&&"undefined"!=typeof _filtersO&&stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs&&stuff.sortsOfStuff.stuffs.length){var filterGroup,filterGroupTags=[];stuff.sortsOfStuff.filterGroup&&(filterGroup=_filtersO[stuff.sortsOfStuff.filterGroup])&&(filterGroupTags=filterGroup.tags.map(function(t){return t._id})),stuff.sortsOfStuff.stuffs.forEach(function(itemS,i){itemS.gallery.forEach(function(s,ii){s.active=!ii});for(var ii=0;ii<itemS.tags.length;ii++){var idx=filterGroupTags.indexOf(itemS.tags[ii]);if(idx>-1){filterGroup.tags[idx].img&&(stuff.sortsOfStuff.stuffs[i].gallery[0].thumbSmallTag=filterGroup.tags[idx].img);break}}})}return stuff}function _onSelectedSort(){setTimeout(function(){$(":focus").blur()},50)}function _orderStuff(){var stuff=this;$order.clearCart(),stuff.cena=stuff.price,stuff.sum=stuff.cena*stuff.quantity,"nosort"!=stuff.addItemToOrder()&&$q.when().then(function(){return $user.getInfo(stuff.service)}).then(function(user){return $order.checkOutFromList(user)}).then(function(){$order.clearCart()}).catch(function(err){$order.clearCart(),err&&exception.catcher("заказ")(err)})}function getAllBonus(){return _getBonus(!0)}function _getBonus(all){var stuffs,stuff=this;return $q.when().then(function(){if(all){return getList({page:0,rows:100},{$and:[{orderType:4},{actived:!0}]})}return[stuff]}).then(function(sts){stuffs=sts}).then(function(){return $user.getInfoBonus()}).then(function(user){if(!user||!user.email)throw"нет email";var content=CreateContent.emailBonus(stuffs),bonus=stuffs&&stuffs[0]&&stuffs[0].imgs&&stuffs[0].imgs[0]&&stuffs[0].imgs[0].name?stuffs[0].imgs[0].name:"получение контента",domain=global.get("store").val.domain,o={email:user.email,content:content,subject:bonus+" ✔",from:"<promo@"+domain+">"};return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note","Сообщение","На Ваш email отправлено письмо"),resolve()},function(err){exception.showToaster("warning","отправка уведомления",err.data),resolve()})})}).then(function(){var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","bonus");pap&&pap.url?$state.go("thanksPage",{id:pap.url}):exception.showToaster("note","Заказ","Все прошло успешно.")}else exception.showToaster("note","Заказ","Все прошло успешно.")}).catch(function(err){err&&exception.catcher("получение бонуса")(err)})}function _checkCamapign(stuff){return $order.checkCampaign(stuff)}function _getDataForBooking(){var el=this,stuff={_id:this._id,artikul:this.artikul,name:this.name,nameL:this.nameL,link:this.link,backgroundcolor:this.backgroundcolor,timePart:el.timePart?el.timePart:4,price:this.price,priceSale:this.priceSale,currency:this.currency};return el.sort&&(stuff.price=el.stock[el.sort].price,stuff.priceSale=el.stock[el.sort].priceSale,stuff.timePart=el.stock[el.sort].timePart?el.stock[el.sort].timePart:4),el.sortName&&(stuff.name=el.name+" "+el.sortName),stuff}function getList(paginate,query,search){function getListComplete(response){0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0);var maxIndex;return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){response.forEach(function(el){99999==el.index&&maxIndex&&el.index--,99999==el.index&&(maxIndex=!0),_setDataForStuff(el,ft)})}).then(function(){return response})}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query,search:search};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function search(search,setData){function getListComplete(response){return setData?$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){response.forEach(function(el){99999==el.index&&maxIndex&&el.index--,99999==el.index&&(maxIndex=!0),_setDataForStuff(el,ft)})}).then(function(){return response}):response}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}var data={search:search,setData:setData};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,o){function getItemComplete(res){return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){return _setDataForStuff(res,ft),res})}function getItemFailed(error){return $q.reject(error)}var query={_id:id};if(o)for(var k in o)query[k]=o[k];return Items.get(query).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/createStuff.html",controller:function($uibModalInstance){var self=this;self.item="",self.ok=function(){$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){item.name?resolve(item):reject()},function(err){reject(err)})})}function getQueryFromUrl(campaignCondition){function setQueryForCampaign(campaign,campaignCondition){var query={};return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){campaignCondition?(campaign.conditionTags&&campaign.conditionTags.length&&(query.queryTags={},campaign.conditionTags.forEach(function(tag){var t=filterTags.getOFA("_id",tag);t&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})),campaign.conditionBrandTags&&campaign.conditionBrandTags.length&&(query.brandTag={$in:campaign.conditionBrandTags}),campaign.conditionBrands&&campaign.conditionBrands.length&&(query.brand={$in:campaign.conditionBrands}),campaign.conditionCategories&&campaign.conditionCategories.length&&(query.category={$in:campaign.conditionCategories}),campaign.conditionStuffs&&campaign.conditionStuffs.length&&(query._id={$in:campaign.conditionStuffs})):(campaign.tags&&campaign.tags.length&&(query.queryTags={},campaign.conditionTags.forEach(function(tag){var t=filterTags.getOFA("_id",tag);t&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})),campaign.brandTags&&campaign.brandTags.length&&(query.brandTag={$in:campaign.brandTags}),campaign.brands&&campaign.brands.length&&(query.brand={$in:campaign.brands}),campaign.categories&&campaign.categories.length&&(query.category={$in:campaign.categories}),campaign.stuffs&&campaign.stuffs.length&&(query._id={$in:campaign.stuffs})),_setQueryForTags(query);var keys=Object.keys(query),q={};if(1==keys.length)q=query;else if(keys.length>1){q.$or=[];for(var k in query){var o={};o[k]=query[k],q.$or.push(o)}}return q.actived=!0,q})}return"campaign.detail"==$state.current.name?$q.when().then(function(){return global.get("campaign").val}).then(function(campaigns){var campaign=campaigns.getOFA("url",$stateParams.id);if(campaign)return setQueryForCampaign(campaign,campaignCondition)}):queryData}function getQuery(stateParams,to){return _setQuery(stateParams,to)}function _setQueryForTags(query,filters){if(query.queryTags&&"object"==typeof query.queryTags){try{var keys=Object.keys(query.queryTags)}catch(err){keys=[]}1==keys.length?query.tags={$in:query.queryTags[keys[0]]}:keys.length>1&&(query.$and=[],keys.forEach(function(k){query.$and.push({tags:{$in:query.queryTags[k]}})}))}if(delete query.queryTags,query.filters&&"object"==typeof query.filters){try{var keys=Object.keys(query.filters)}catch(err){keys=[]}if(1==keys.length){var filter;filters&&(filter=filters.getOFA("_id",keys[0])),filter&&filter.price?(query.priceForFilter=query.filters[keys[0]],console.log("query.filters[keys[0]]",query.filters[keys[0]])):query["filters."+keys[0]]=query.filters[keys[0]]}else if(keys.length>1&&(query.$and||(query.$and=[]),keys.forEach(function(k){var filter;if(filters&&(filter=filters.getOFA("_id",k)),filter&&filter.price)query.priceForFilter=query.filters[k];else{var o={};o["filters."+k]=query.filters[k],query.$and.push(o)}}),1==query.$and.length)){for(var k in query.$and[0])query[k]=query.$and[0][k];delete query.$and}}delete query.filters}function _setQuery(stateParams,to){global.set("category",null);var parentSection,sectionCategories,categoryBrands=[],categoryFilters=[],query={},breadcrumbs=[];return $q(function(resolve,reject){$q.when().then(function(){return $q.all([Sections.getSections(),Brands.getBrands(),Filters.getFilters()])}).then(function(data){var sections=data[0],brands=data[1],filters=data[2];if(parentSection=Sections.getSection(sections,stateParams.groupUrl),global.set("parentSection",parentSection),parentSection)if("category"!=stateParams.categoryUrl){if(!parentSection.categories||!parentSection.categories.length)throw 404;var categorySet;if(parentSection.categories.forEach(function(c){c.url==stateParams.categoryUrl?(global.set("category",c),categorySet=!0,c.set=!0,query.category=c._id,categoryBrands=c.brands,categoryFilters=c.filters):c.set=!1}),!query.category)throw 404}else sectionCategories=Sections.getEmbededCategories(parentSection,[]).map(function(el){return el._id}),sectionCategories.length?(query.category={$in:sectionCategories},sectionCategories.forEach(function(cat){var c=global.get("categoriesO").val[cat];c.filters.forEach(function(f){categoryFilters.indexOf(f)<0&&categoryFilters.push(f)}),c.brands.forEach(function(b){categoryBrands.indexOf(b)<0&&categoryBrands.push(b)})})):query.category=null;var brandSet,brandTagSet,brandsArr,brandTagsArr;stateParams.brand&&(brandsArr=stateParams.brand.split("__")),stateParams.brandTag&&(brandTagsArr=stateParams.brandTag.split("__")),query.brand=[],query.brandTag=[],brands.forEach(function(b){b.inList=!1,b.showCollections=!1,"stuffs"==to.name||"stuffs.stuff"==to.name?categoryBrands&&categoryBrands.length&&categoryBrands.indexOf(b._id)>-1&&(b.inList=!0):b.inList=!0,brandsArr&&brandsArr.indexOf(b.url)>-1?(query.brand.push(b._id),b.set=!0,breadcrumbs.push({type:"brand",name:b.name,url:b.url}),brandSet=!0):b.set=!1,b.tags.forEach(function(t){brandTagsArr&&brandTagsArr.indexOf(t.url)>-1?(query.brandTag.push(t._id),t.set=!0,breadcrumbs.push({type:"brandTag",name:t.name,url:t.url}),b.showCollections=!0,brandTagSet=!0):t.set=!1})}),query.brand.length?1==query.brand.length?query.brand=query.brand[0]:query.brand={$in:query.brand}:query.brand=null,query.brandTag.length?1==query.brandTag.length?query.brandTag=query.brandTag[0]:query.brandTag={$in:query.brandTag}:query.brandTag=null,query.brandTag||delete query.brandTag,query.brand||delete query.brand,brandSet||$location.search("brand",null),brandTagSet||$location.search("brandTag",null);var queryTags;stateParams.queryTag&&(queryTags=stateParams.queryTag.split("__"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos})),query.filters={};var filterTags;if(stateParams.filterTag&&(filterTags=stateParams.filterTag.split("__"),filterTags=filterTags.filter(function(item,pos){return filterTags.indexOf(item)==pos}),filterTags=filterTags.map(function(f){return f.split("_")}).filter(function(f){return 3==f.length}).forEach(function(f){query.filters[f[0]]={$gte:Number(f[1]),$lte:Number(f[2])}})),query.queryTags={},filters.forEach(function(f){f.inList=!1,"stuffs"==to.name||"stuffs.stuff"==to.name?categoryFilters.indexOf(f._id)>-1&&(f.inList=!0,f.open=!1):f.inList=!0,categoryFilters&&categoryFilters.length&&categoryFilters.indexOf(f._id)>-1&&(f.inList=!0,f.open=!1),f.count?query.filters[f._id]?(f.open=!0,f.set=!0,f.minValue=query.filters[f._id].$gte,f.maxValue=query.filters[f._id].$lte):(f.minValue=f.min,f.maxValue=f.max):f.tags.forEach(function(t){queryTags&&queryTags.indexOf(t.url)>-1?(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id),f.open=!0,t.set=!0,breadcrumbs.push({type:"queryTag",name:t.name,url:t.url})):t.set=!1})}),_setQueryForTags(query,filters),global.set("breadcrumbs",breadcrumbs),"stuffs"!=to.name&&"stuffs.stuff"!=to.name||(query.actived=!0),stateParams.searchStr){var search=stateParams.searchStr.substring(0,20)
;query["keywords."+global.get("store").val.lang]=search}resolve(query)}).catch(function(err){reject(err)})})}function setFilters(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/filterStuffsList.html",controller:setFiltersCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"}).result.then(function(){resolve()},function(){reject()})})}function cloneStuff(stuff,clone){if(global.get("seller").val)return $q.when().then(function(){if(stuff&&stuff._id)return Items.get({_id:stuff._id,clone:"clone"}).$promise;if($stateParams&&"category"!=$stateParams.categoryUrl){var category=global.get("categories").val.getOFA("url",$stateParams.categoryUrl);category&&category._id&&(stuff.category=category)}return stuff}).then(function(st){return console.log(st),stuff=angular.copy(st),stuff.category&&!stuff.category.length&&(stuff.category=[stuff.category]),stuff.index||(stuff.index=0),stuff.index++,delete stuff._id,delete stuff.url,delete stuff.link,delete stuff.__v,delete stuff.nameL,delete stuff.artikulL,delete stuff.gallery,delete stuff.sort,delete stuff.sortsOfStuff,delete stuff.keywords,stuff.blocks&&stuff.blocks.length&&stuff.blocks.forEach(function(b){delete b._id,b.template=null,b.templateName=null,b.img&&(b.img=null),b.video&&(b.video=null),b.imgs&&b.imgs.length&&b.imgs.forEach(function(slide){slide.img&&(slide.img=null)})}),stuff.stock={notag:{price:stuff.price}},stuff.actived=!1,$q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/cloneStuffModal.html",controller:cloneStuffCtrl,controllerAs:"$ctrl",size:"lg",resolve:{stuff:function(){return stuff},clone:function(){return clone}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})})}function saveField(stuff,field){var f=field.split(" "),o={_id:stuff._id};return f.forEach(function(el){o[el]=stuff[el]}),Items.save({update:field},o).$promise}function selectItem(query){return console.log("внимание - сделать так же как и  selectItemWithSort"),$q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffModal.html",controller:selectStuffCtrl,controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}function selectItemWithSort(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffWithSortModal.html",controller:selectItemWithSortCtrl,controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}function getServicesForOnlineEntry(){function getListComplete(data){data.shift();var items=[];return data.forEach(function(el){_setPrice(el),el.sort=null;var category=el.category&&el.category.length?el.category[0]:el.category;if(global.get("categoriesO")&&global.get("categoriesO").val)var c=global.get("categoriesO").val[category];else var c=global.get("categories").val.getOFA("_id",category);c||(c={name:"Категория"}),el.category=c.name,el.timePart||(el.timePart=4);try{if(el.sortsOfStuff&&el.sortsOfStuff.differentPrice)for(var sort in el.stock){var s={_id:el._id,name:el.name+" "+_getTagName(sort),nameL:el.nameL,link:el.link,artikul:el.artikul,price:el.stock[sort].price,category:el.category,timePart:el.timePart};items.push(s)}else{if(el.stock.notag)el.price=el.stock.notag.price;else try{el.price=el.stock[Object.keys(el.stock)[0]].price}catch(err){console.log(err)}items.push(el)}}catch(err){console.log(err)}}),stuffsService=items,items}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}function _getTagName(_id){return _id&&filterTags&&"notag"!=_id&&_filterTagsO[_id]?_filterTagsO[_id].name:""}if(stuffsService&&stuffsService.length)return stuffsService;var data={query:{orderType:{$in:[2,7]},actived:!0}},filterTags=[];return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(fts){filterTags=fts}).then(function(){return Items.query(data).$promise}).then(getListComplete).catch(getListFailed)}var Items=$resource("/api/collections/Stuff/:_id",{_id:"@_id"}),categoriesLink={},queryData={},stuffsService=[];return $rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){"stuffs"!=to.name&&"stuffs.stuff"!=to.name&&"frame.stuffs"!=to.name&&"frame.stuffs.stuff"!=to.name||$q.when().then(function(){return getQuery(toParams,to)}).then(function(query){queryData=query})}),{Items:Items,query:Items.query,get:Items.get,getList:getList,search:search,getItem:getItem,save:Items.save,delete:Items.delete,create:create,getQuery:getQuery,getQueryFromUrl:getQueryFromUrl,setFilters:setFilters,cloneStuff:cloneStuff,saveField:saveField,selectItem:selectItem,select:selectItem,selectItemWithSort:selectItemWithSort,getServicesForOnlineEntry:getServicesForOnlineEntry,getAllBonus:getAllBonus,zoomImg:zoomImgGlobal,setDataForStuff:_setDataForStuff,getDataForBooking:_getDataForBooking};var delay}function setFiltersCtrl(global,$uibModalInstance){var self=this;self.global=global,self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(){$uibModalInstance.close()}}function cloneStuffCtrl($q,global,Stuff,stuff,$uibModalInstance,Category,clone){var self=this;self.Items=Stuff;self.stuff=stuff,self.clone=clone,self.categoryDisabled=!0,self.selectCategory=function(){$q.when().then(function(){return Category.select()}).then(function(selectedCategory){self.stuff.category||(self.categoryDisabled=!1,setTimeout(function(){$("#createStuffCategory").trigger("change"),self.categoryDisabled=!0},100)),self.stuff.category=selectedCategory}).catch(function(err){console.log(err)})},self.createNewStuff=function(){return self.stuff.category?self.stuff.name?(self.stuff.name=self.stuff.name.substring(0,100),self.stuff.artikul&&(self.stuff.artikul=self.stuff.artikul.substring(0,100)),!self.clone&&self.stuff.category&&self.stuff.category._id&&(self.stuff.category=self.stuff.category._id),stuff.stock&&stuff.stock.notag&&stuff.stock.notag.price!=stuff.price&&(stuff.stock.notag.price=stuff.price),void $q.when().then(function(){self.stuff.keywords={};var k=self.stuff.name;if(self.stuff.artikul&&(k+=" "+self.stuff.artikul),self.stuff.category){var c;if("object"==typeof self.stuff.category){var cc="object"==typeof self.stuff.category[0]?self.stuff.category[0]._id:self.stuff.category[0];c=global.get("categories").val.getOFA("_id",cc)}else c=global.get("categories").val.getOFA("_id",self.stuff.category);k+=" "+(c.nameL&&c.nameL[global.get("store").val.lang]?c.nameL[global.get("store").val.lang]:c.name)}if(self.stuff.brand){var bb="object"==typeof self.stuff.brand?self.stuff.brand._id:self.stuff.brand,b=global.get("brands").val.getOFA("_id",bb);if(k+=" "+(b.nameL&&b.nameL[global.get("store").val.lang]?b.nameL[global.get("store").val.lang]:b.name),self.stuff.brandTag){var bt=b.tags.getOFA("_id",self.stuff.brandTag);bt&&bt.nameL&&bt.nameL[global.get("store").val.lang]&&(k+=" "+bt.nameL[global.get("store").val.lang])}}return stuff.keywords[global.get("store").val.lang]=k,self.Items.save(self.stuff).$promise}).then(function(res){self.stuff._id=res.id,self.stuff.url=res.url;var c;if("object"==typeof self.stuff.category){var cc="object"==typeof self.stuff.category[0]?self.stuff.category[0]._id:self.stuff.category[0];c=global.get("categories").val.getOFA("_id",cc)}else c=global.get("categories").val.getOFA("_id",self.stuff.category);self.stuff.link="/"+c.linkData.groupUrl+"/"+c.linkData.categoryUrl+"/"+res.url,self.Items.save({update:"link"},{_id:self.stuff._id,link:self.stuff.link}),$uibModalInstance.close(self.stuff)}).catch(function(err){return $q.reject(err)})):(self.alertMessage2=!0,void setTimeout(function(){self.alertMessage2=!1},3e3)):(self.alertMessage2=!0,void setTimeout(function(){console.log("))))"),self.alertMessage2=!1},3e3))},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}function selectStuffCtrl($q,Stuff,$uibModalInstance,query){var self=(angular.copy(query),this);self.stuffs=[],self.name="";self.search=function(name){name.length<3||(query?(query.$and||(query={$and:[query]}),query.$and.push({$or:[{name:name},{artikul:name}]})):query={$or:[{name:name},{artikul:name}]},$q.when().then(function(){return Stuff.search(name,!0)}).then(function(res){self.stuffs=res}))},self.selectStuff=function(stuff){stuff.imgThumb&&(stuff.img=stuff.imgThumb),stuff.link="/"+stuff.groupUrl+"/"+stuff.categoryUrl+"/"+stuff.url,$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss()}}function selectItemWithSortCtrl($q,Stuff,$uibModalInstance,Filters,FilterTags,exception,query,global){function getFilterName(_id){return self.filters.getOFA("_id",_id).name||null}var self=(angular.copy(query),this);self.global=global,self.stuffs=[],self.name="";self.getFilterName=getFilterName,self.search=function(name){name.length<3||$q.when().then(function(){return Stuff.search(name,!0)}).then(function(res){global.get("seller")&&global.get("seller").val?self.stuffs=res:self.stuffs=res.map(function(s){for(var i=0;i<s.stockKeysArray.length;i++)s.stockKeysArray[i].quantity||(s.stockKeysArray.splice(i,1),i--);return s}).filter(function(s){return s.actived&&s.stockKeysArray.length})})},self.selectStuff=function(stuff){stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&!stuff.sort?exception.catcher("ошибка")("выберите разновидность"):$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss()},function(){$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){self.filterTags=filterTags}).catch(function(err){console.log(err)})}()}function commentService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/createComment.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Comment/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Stuff",stuffService).service("Comments",commentService),stuffService.$inject=["$resource","$uibModal","$q","Sections","$stateParams","$state","$location","Brands","FilterTags","global","$order","exception","$user","$email","CreateContent","$rootScope","Filters","$timeout"],setFiltersCtrl.$inject=["global","$uibModalInstance"],cloneStuffCtrl.$inject=["$q","global","Stuff","stuff","$uibModalInstance","Category","clone"],selectStuffCtrl.$inject=["$q","Stuff","$uibModalInstance","query"],selectItemWithSortCtrl.$inject=["$q","Stuff","$uibModalInstance","Filters","FilterTags","exception","query","global"],commentService.$inject=["$resource","$uibModal","$q"]}(),function(){function directiveFunction(){return{scope:{},bindToController:!0,controller:directiveCtrl,controllerAs:"$ctrl",templateUrl:"components/stuff/downloadStuffs.html",restrict:"E"}}function directive1Function(){return{scope:{},bindToController:!0,controller:directiveCtrl,controllerAs:"$ctrl",templateUrl:"components/stuff/downloadStuffs1.html",restrict:"E"}}function directive2Function(){return{scope:{},bindToController:!0,controller:directiveCtrl,controllerAs:"$ctrl",templateUrl:"components/stuff/downloadStuffs2.html",restrict:"E"}}function directiveCtrl($scope,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,anchorSmoothScroll,$timeout,$anchorScroll,Category,Brands,BrandTags,$window,$http){function setLink(){return self.link+"/downloads/"+global.get("store").val.subDomain.toLowerCase()+"/"+self.lang+"/"+self.currency.toLowerCase()+"/"+self.brand+"/catalog_"+(self.razdel?"razdel_":"")+self.catalog+"."+self.ext}function copyLink(){var val=setLink();console.log(val);try{var dummy=document.createElement("input");document.body.appendChild(dummy),dummy.setAttribute("id","dummy_id"),document.getElementById("dummy_id").value=val,dummy.select();var successful=document.execCommand("copy"),msg=successful?"successful":"unsuccessful";console.log("Copying text command was "+msg),exception.showToaster("info","Copying text",msg),document.body.removeChild(dummy)}catch(err){document.body.removeChild(dummy),exception.catcher("Copying text")(err),console.log("Oops, unable to copy")}}function setCollection(){$q.when().then(function(){return BrandTags.select()}).then(function(collection){self.collection=collection})}function deleteCollection(){self.collection=null}function setCategory(){$q.when().then(function(){return Category.select()}).then(function(category){self.category=category})}function deleteCategory(){self.category=null}function getLinkToXMLCatalog(){return stuffHost+"/downloads/"+global.get("store").val.subDomain.toLowerCase()+"/"+global.get("store").val.lang.toLowerCase()+"/"+self.currency.toLowerCase()+"/catalog.xml"}function getStuffs(XML){XML=XML?"XML":"";var newWindow=window.open("","_blank");return void(newWindow.location.href=getLinkToXMLCatalog());var newWindow}anchorSmoothScroll.scrollTo("topPage");var self=this;self.catalog="prom",self.langArr=global.get("store").val.langArr,self.lang=global.get("store").val.lang,self.currencyArray=global.get("store").val.currencyArr,self.currency=global.get("store").val.mainCurrency,self.brand="all",self.ext="frame.downloads1"==$rootScope.$state.current.name?"xlsx":"xml",self.razdel,self.brands=global.get("brands"),global.get("local").val?self.link=global.get("store").val.protocol+"://"+global.get("store").val.subDomain+".localhost:8909":self.link=global.get("store").val.link,self.link=stuffHost,self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.dataImage=null,self.setLink=setLink,self.copyLink=copyLink,self.setCollection=setCollection,self.deleteCollection=deleteCollection,self.setCategory=setCategory,self.deleteCategory=deleteCategory,self.getStuffs=getStuffs,self.getLinkToXMLCatalog=getLinkToXMLCatalog}angular.module("gmall.services").directive("downloadStuffs",directiveFunction).directive("download1Stuffs",directive1Function).directive("download2Stuffs",directive2Function),directiveCtrl.$inject=["$scope","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","anchorSmoothScroll","$timeout","$anchorScroll","Category","Brands","BrandTags","$window","$http"]}(),angular.module("gmall.services").service("Filters",function($resource,$q,global,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function returnFilters(resolve){pending?setTimeout(function(){returnFilters(resolve)},300):resolve(filters)}function reloadItems(){pending=!0,Items.query(function(res){res.shift(),filters=res,global.set("filters",filters),pending=!1})}function selectFilter(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/selectFilter.html",controller:selectFilterCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectFilterCtrl(Filters,$uibModalInstance,$q,global){var self=this;self.lang=global.get("lang").val,$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filter){$uibModalInstance.close(filter)}}var Items=$resource("/api/collections/Filter/:_id",{_id:"@_id"}),filters=null,pending=!0;this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.select=selectFilter,this.reloadItems=reloadItems,this.getItem=getItem,this.getList=getList,this.getFilters=function(){return $q(function(resolve,reject){if(global.get("filters")&&global.get("filters").val)return filters||(filters=global.get("filters").val),resolve(global.get("filters").val);pending?setTimeout(function(){returnFilters(resolve)},300):filters?resolve(filters):(pending=!0,Items.query(function(res){res.shift(),filters=res,pending=!1,resolve(filters)},function(err){pending=!1,reject(err)}))})},global.get("filters")&&global.get("filters").val||Items.query(function(res){res.shift(),filters=res,global.get("filters")&&!global.get("filters").val&&global.set("filters",filters),pending=!1}),selectFilterCtrl.$inject=["Filters","$uibModalInstance","$q","global"]});var __filterTagsO=_filterTagsO,__filterTags=_filterTags;angular.module("gmall.services").service("FilterTags",filterTagsService),filterTagsService.$inject=["$resource","$uibModal","$q","global","$timeout","Sections"],angular.module("gmall.services").service("SelectFilterTags",["$q","$uibModal",function($q,$uibModal){function bindFilterTagToModelCtrl(Filters,$uibModalInstance){var self=this;$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){$uibModalInstance.close(filterTag)}}this.bindFiterTagToModel=function(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/bindFilterTagToModel.html",controller:bindFilterTagToModelCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}}]),angular.module("gmall.services").provider("global",[function(){var _data={},_urls={};this.setUrl=function(urls){_urls=urls};var _set=function(what,val){val=val||null,angular.isDefined(what)&&(_data[what]?_data[what].val=angular.isDefined(val)?val:null:_data[what]={val:val})},_getSticker=function(stuff){stuff._id?stuff._id:stuff.stuff;if(stuff.tags&&stuff.tags.length&&_data.filterTagsSticker.val){for(var i=0,l=_data.filterTagsSticker.val.length;i<l;i++){var tag=_data.filterTagsSticker.val[i]._id;if(stuff.tags.indexOf(tag)>-1)return!!_data.filterTagsSticker.val[i].sticker&&_data.filterTagsSticker.val[i].sticker}return!1}},_getDataForCart=function(stuff){return void console.log("не используется!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")};this.set=_set,this.$get=["$http",function($http){return{request:function(url,vars){return angular.isDefined(vars)?$http.post(url,$.param(vars),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}):$http.get(url)},url:function(which){return _urls[which]},set:_set,get:function(what){return angular.isDefined(what)&&what in _data?_data[what]:void 0},del:function(what){if(angular.isDefined(what)){var i=_data.indexOf(what);if(i>=0)return _data.splice(i,1)}return!1},clear:function(){_data=[]},getAll:function(){return _data},getSticker:_getSticker,getDataForCart:_getDataForCart}}]}]).factory("globalSrv",["global",function(global){var _send=global.request;return{getData:function(name,param,abbr){var url=global.url(name);if(!angular.isDefined(param)||angular.equals(param,null)||angular.equals(param,"")||(url+="/"+param),angular.isDefined(abbr)&&!angular.equals(abbr,null)&&!angular.equals(abbr,"")&&"object"==typeof abbr){url+="?";for(var key in abbr)"?"!=url[url.length-1]&&(url+="&"),url+=key+"="+abbr[key]}return _send(url)}}}]),function(){function helperService($resource,$uibModal,$q,exception){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return _items[id]=response,response}function getItemFailed(error){return _items[id]=null,$q.reject(error)}return _items[id]?$q.when(_items[id]):Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function getHelp(state){$q.when().then(function(){return getItem(state)}).then(function(helper){$uibModal.open({animation:!0,templateUrl:"components/helper/helperModal.html",controller:function($uibModalInstance,$sce,desc){var self=this;self.desc=desc,self.cancel=function(){$uibModalInstance.dismiss("cancel")}},resolve:{desc:function(){return helper.desc}},controllerAs:"$ctrl"})}).catch(function(err){var msg="ошибка";err&&("object"==typeof err?err.data?msg=err.data:err.message&&(msg=err.message):msg=err),err=err.data||err,exception.catcher("получение справки")(msg)})}var Items=$resource("/api/collections/Helper/:_id",{_id:"@_id"}),_items={};return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,getHelp:getHelp}}angular.module("gmall.services").service("Helper",helperService),helperService.$inject=["$resource","$uibModal","$q","exception"]}(),angular.module("gmall.services").factory("$email",function($resource){return $resource("/api/sendEmail")}).factory("Email",function($resource){return $resource("/api/sendEmails")}),angular.module("gmall.services").service("$order",["localStorage","global","Orders","$q","$uibModal","CartInOrder","exception","$email","CreateContent","$notification","$state","$window","Coupon","$user","$rootScope","$timeout","$http",function(localStorage,global,Orders,$q,$uibModal,CartInOrder,exception,$email,CreateContent,$notification,$state,$window,Coupon,$user,$rootScope,$timeout,$http){function shipInfoCtrl($uibModalInstance,$rootScope){var self=this;$rootScope.$on("closeShipModal",function(){$uibModalInstance.close()}),self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}}var order,storageName;this.type=null,this.reinitCart=function(){order.comment="",delete order.action,delete order._id,delete order.num,delete order.date,delete order.seller;var seller=global.get("store").val.seller;order.setSellerData(seller._id,seller.cascade,seller.opt)},this.initOrderInList=function(res){var order=myShareData.getOrder(),mainCurrency=(global.get("campaign")&&global.get("campaign").val,global.get("store").val.mainCarrency),currencyStore=global.get("store").val.currency;global.get("currency")&&global.get("currency").val&&global.get("currency").val,global.get("store").val.seller;return order.type="order",order._id=res._id,order.init(res.campaign,mainCurrency,currencyStore),order.setCurrency(res.currency),order.kurs=order.currencyStore[order.currency][0],order.payInfo=res.seller.payInfo,order.setSellerData(res.seller,res.cascade,res.opt),order.unitOfMeasure=order._getUnitOfMeasure(),order.cart._id=res.cart,order.setDiscount(res.discount),order.setCoupon(res.coupon),order.date=res.date,order.date2=res.date2,order.date3=res.date3,order.date4=res.date4,order.date5=res.date5,order.invoice=res.invoice,order.invoiceInfo=res.invoiceInfo,order.pay=res.pay,order.shipCost=res.shipCost,order.num=res.num,order.status=res.status,order.profile=res.profile,order.comment=res.comment,order.note=res.note,order.user=res.user,order.shipDetail=res.shipDetail,order.domain=global.get("store").val.domain||global.get("store").val.subDomain,order.paySum=res.paySum,order},this.init=function(type,id){storageName=global.get("store").val._id;var q=$q.defer();order=myShareData.getOrder();var campaign=global.get("campaign")?global.get("campaign").val:null,mainCurrency=global.get("store").val.mainCarrency,currencyStore=global.get("store").val.currency,currency=global.get("currency")&&global.get("currency").val?global.get("currency").val:"UAH",seller=global.get("store").val.seller;if(this.type=type,order.type=type,"cart"==type){order.init(campaign,mainCurrency,currencyStore),order.setSellerData(seller._id,seller.cascade,seller.opt),order.setCurrency(currency),order.kurs=order.currencyStore[order.currency][0];var o=localStorage.get(storageName);o||(o=[],localStorage.set(storageName,o)),order.setCart(o),order.unitOfMeasure=order._getUnitOfMeasure(),order.totalCount=order._cartCount(),q.resolve(order)}else"order"==type&&(Orders.get({_id:id},function(res){res&&res._id||q.reject("404"),order._id=res._id,order.init(res.campaign,mainCurrency,currencyStore),order.setCurrency(res.currency),order.kurs=order.currencyStore[order.currency][0],order.payInfo=res.seller.payInfo,order.setSellerData(res.seller,res.cascade,res.opt),order.setCart(res.cart.stuffs),order.unitOfMeasure=order._getUnitOfMeasure(),order.cart._id=res.cart._id,order.setDiscount(res.discount),order.setCoupon(res.coupon),order.totalCount=order._cartCount(),order.date=res.date,order.date2=res.date2,order.date3=res.date3,order.date4=res.date4,order.date5=res.date5,order.invoice=res.invoice,order.invoiceInfo=res.invoiceInfo,order.pay=res.pay,order.shipCost=res.shipCost,order.num=res.num,order.status=res.status,order.profile=res.profile,order.comment=res.comment,order.note=res.note,order.user=res.user,order.shipDetail=res.shipDetail,order.domain=global.get("store").val.domain||global.get("store").val.subDomain,q.resolve(order)},function(err){q.reject(order)}),order.totalCount=order._cartCount());return q.promise},this.getOrder=function(){return order},this.addItemToCart=function(itemTo){itemTo.seller=global.get("seller").val,itemTo.img=itemTo.gallery&&itemTo.gallery.length&&itemTo.gallery[0].thumbSmall?itemTo.gallery[0].thumbSmall:"",itemTo.quantity||(itemTo.quantity=1),order.addStuffToOrder(itemTo),this.updateOrder(itemTo)},this.checkInCart=function(item){return order.checkInCart(item)},this.updateOrder=function(itemTo){order.totalCount=order._cartCount(),order.unitOfMeasure=order._getUnitOfMeasure(),itemTo&&$rootScope.$broadcast("$updateOrder",itemTo),"cart"==this.type?(localStorage.set(storageName,order.cart.stuffs),order.totalCount=order._cartCount()):$timeout(function(){},100).then(function(){var o=angular.copy(order.cart);return o.order=order._id,CartInOrder.save(o).$promise}).then(function(){return order.priceSaleHandle=order.cart.stuffs.some(function(s){return s.priceSaleHandle}),order.maxDiscountOver=order.cart.stuffs.some(function(s){return s.maxDiscountOver}),Orders.save({update:"totalCount sum paySum maxDiscountOver priceSaleHandle"},{_id:order._id,totalCount:order.totalCount,sum:order.sum,paySum:order.paySum,priceSaleHandle:order.priceSaleHandle,maxDiscountOver:order.maxDiscountOver}).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)}).catch(function(error){exception.catcher("сохранение изменений")(error)})},this.removeItem=function(i){order.cart.stuffs.splice(i,1),this.updateOrder()},this.decreaseQty=function(i){var stuff=order.cart.stuffs[i];stuff&&stuff.quantity>1&&(stuff.multiple&&stuff.minQty?stuff.quantity-1>=stuff.minQty&&(stuff.quantity--,this.updateOrder()):(stuff.quantity--,this.updateOrder()))},this.increaseQty=function(i){var stuff=order.cart.stuffs[i];stuff&&(stuff.single&&stuff.maxQty?stuff.quantity+1<=stuff.maxQty&&(stuff.quantity++,this.updateOrder()):(stuff.quantity++,this.updateOrder()))},this.clearCart=function(){order.clearOrder(),this.updateOrder()},this.cartCount=function(){return order.totalCount},this.sendOrder=function(user){return $q.when().then(function(){try{if(user){if(!user._id)throw conosole.log(user),"не авторизирован!"}else{if(!global.get("user").val||!global.get("user").val._id)throw"не авторизирован!";order.user=global.get("user").val,order.profile=angular.copy(global.get("user").val.profile)}order.action="order",order.comment?order.comment.clearTag(400):order.comment="",order.coupon&&order.coupon._id?order.paySum=order.kurs*order.getCouponSum():order.paySum=order.kurs*order.getTotalSum()}catch(err){throw err}}).then(function(){return $q(function(resolve,reject){if(order.coupon&&order.coupon._id)if(global.get("user").val.coupons||(global.get("user").val.coupons=[]),global.get("user").val.coupons.indexOf(order.coupon._id)>-1)order.coupon=null,resolve();else{Date.now();Coupon.get({_id:order.coupon._id},function(coupon){coupon?(global.get("user").val.coupons||(global.get("user").val.coupons=[]),global.get("user").val.coupons=global.get("user").val.coupons.filter(function(el){return el}),global.get("user").val.coupons.push(coupon._id),$user.save({update:"coupons"},{_id:global.get("user").val._id,coupons:global.get("user").val.coupons},function(res){resolve()},function(err){if(err)return reject(err)})):(order.coupon=null,resolve())})}else resolve()})}).then(function(){return Orders.save(order).$promise}).then(function(res){if(!res.num||!res._id)throw"заказ не отправлен. произошла ошибка на сервере. не присвоен номер ордеру";try{order._id=res.id,order.num=res.num,order.date=Date.now(),order.seller=global.get("store").val.seller,order.status=1}catch(err){throw err}}).then(function(){if(global.get("store").val.seller.salemail){try{order.profile.admin="Admin";var email=global.get("store").val.seller.salemail,content=CreateContent.order(order,!1,!0);delete order.profile.admin;var domain=global.get("store").val.domain,subj=global.get("langOrder").val.neworder?global.get("langOrder").val.neworder.toUpperCase()+" ✔":"НОВЫЙ ЗАКАЗ ✔",o={email:email,content:content,subject:subj,from:global.get("store").val.name+"<sales@"+domain+">"}}catch(err){throw err}return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note",global.get("langNote").val.emailSent,""),resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).then(function(){try{order.user=user?user:global.get("user").val;var email=user?user.email:global.get("user").val.email,content=CreateContent.order(order,!1,!0),domain=global.get("store").val.domain,subj=global.get("langOrder").val.neworder?global.get("langOrder").val.neworder.toUpperCase()+" ✔":"НОВЫЙ ЗАКАЗ ✔",o={email:email,content:content,subject:subj,from:global.get("store").val.name+"<sales@"+domain+">"}}catch(err){throw err}return $q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}).then(function(){try{var content=CreateContent.orderNote(order),o={addressee:"seller",type:"order",
content:content,order:order._id,num:order.num,seller:order.seller._id}}catch(err){throw err}return $q(function(resolve,reject){$notification.save(o,function(res){exception.showToaster("note",global.get("langNote").val.sent,""),resolve()},function(err){exception.catcher("error")(err),resolve()})})}).then(function(){try{var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","order");pap&&pap.url?$state.go("thanksPage",{id:pap.url}):exception.showToaster("note",global.get("langNote").val.orderSuccess,"")}else exception.showToaster("note",global.get("langNote").val.orderSuccess,"")}catch(err){throw err}}).catch(function(err){throw err})},this.changeCurrency=function(lan){order.changeCurrency(lan)},this.checkCampaign=function(stuff){return order&&order.type?order.checkCampaign(stuff):null},this.checkOutFromList=function(user){return order.comment=user.comment?user.comment:"",order.profile=user.profile,order.user=user._id,order.seller=global.get("store").val.seller._id,this.sendOrder(user)},this.getShipInfo=function(){return $q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/order/modal/shipInfo.html",controller:shipInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})},shipInfoCtrl.$inject=["$uibModalInstance","$rootScope"],this.getCheckOutLiqpayHtml=function(order,invoice){return $q.when().then(function(){return invoice?$http.post("/api/orders/checkoutLiqpayInvoice",order):$http.post("/api/orders/checkoutLiqpay",order)}).then(function(res){res&&res.data.html&&(order.checkOutLiqpayHtml=res.data.html,order.checkOutLiqpayHtmlIs=!0)}).then(function(res){}).catch(function(err){exception.catcher("error")(err)})}}]).factory("localStorage",function(){return{getB:function(item){return JSON.parse(localStorage.getItem(item)||"false")},getN:function(item){var i=localStorage.getItem(item);return"undefined"!=i?JSON.parse(i):""},get:function(item){return JSON.parse(localStorage.getItem(item)||"[]")},set:function(item,value){localStorage.setItem(item,JSON.stringify(value))}}}),function(){function orderService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response&&response.length&&response.forEach(function(o){o.totalPay=o.pay&&o.pay.length?o.pay.reduce(function(s,i){return s+=i.sum},0):0}),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(o){return o}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Order/:_id",{_id:"@_id"});return this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,{getList:getList,getItem:getItem,get:Items.get,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("Orders",orderService),orderService.$inject=["$resource","$uibModal","$q"]}(),function(){function cartInOrderService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/CartInOrder/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,get:Items.get,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("CartInOrder",cartInOrderService),cartInOrderService.$inject=["$resource","$uibModal","$q"]}(),angular.module("gmall.controllers").controller("ordersCtrl",["$scope","Orders","global","$rootScope","$window","$timeout","$location","socket","$q","$user",function($scope,Orders,global,$rootScope,$window,$timeout,$location,socket,$q,$user){var self=this;$rootScope.ordersCtrl=self,self.paginate={page:0,rows:20,items:0},self.query={};var query=null;self.setUnReadChatMessages=function(){self.orders.forEach(function(order){var name="N-"+order.num;global.get("chatMessages").val[name]?(console.log(global.get("chatMessages").val[name]),order.chatMessages=global.get("chatMessages").val[name].count):order.chatMessages=null})},self.getList=function(page){if(0===page&&(self.paginate.page=page),global.get("user").val&&global.get("user").val._id){if(global.get("seller")&&global.get("seller").val?self.query.seller=global.get("seller").val:self.query.user=global.get("user").val._id,self.query.num||(self.query.date={$gte:new Date($scope.datePicker.date.startDate),$lte:new Date($scope.datePicker.date.endDate)}),Object.keys(self.query).length>1){query={$and:[]};for(var key in self.query){var o={};o[key]=self.query[key],query.$and.push(o)}}else query=self.query;Orders.getList(self.paginate,self.query).then(function(){self.orders=res,self.query={},query=null,self.itemsCount=self.paginate.items,$timeout(function(){self.setUnReadChatMessages()},100)}).then(function(){})}},socket.on("newMessage",function(){$timeout(function(){self.setUnReadChatMessages()},100)}),self.reloadOrders=function(s){if(s){var a=parseInt(s.substring(0,30));"number"==typeof a&&a%1==0?self.query.num=a:(self.query["profile.fio"]=s.substring(0,30),console.log(self.query["profile.fio"]))}self.getList(0)},self.deleteItem=function(item){confirm("Удалить?")&&Orders.delete({id:item._id},function(err){err&&console.log(err),self.getList(0)})},self.dt=new Date,self.today=function(t){return t?new Date(self.dt.setHours(0,0,0)):new Date(self.dt.setHours(23,59,59))},self.maxDate=self.today(!0);var dtto=self.today(),dtfrom=self.today(!0);dtfrom.setDate(dtfrom.getDate()-30),self.dtto=dtto,self.dtfrom=dtfrom;var now=new Date,yesterday=new Date(new Date(self.today(!0)).setDate(now.getDate()-1)),nextWeek=new Date(new Date(self.today(!0)).setDate(now.getDate()-7)),nextMonth=new Date(new Date(self.today(!0)).setMonth(now.getMonth()-1)),y=dtto.getFullYear(),m=dtto.getMonth(),thisMonth=new Date(y,m,1),last30day=new Date(new Date(self.today(!0)).setDate(now.getDate()-30));$scope.datePicker={},self.options={ranges:{"сегодня":[self.today(!0),dtto],"вчера":[yesterday,self.today(!0)],"последние 7 дней":[nextWeek,dtto],"последние 30 дней":[last30day,dtto],"текущий месяц":[thisMonth,dtto],"прошлый месяц":[nextMonth,dtto]},locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"прозвольный диапазон",format:"DD MMMM YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]}},$scope.datePicker.date={startDate:dtfrom,endDate:dtto},moment.locale("ru"),$scope.moment=moment,self.getList(self.paginate.page,self.paginate.rows),self.deleteOrder=function(order){confirm("Удалить?")&&order.$delete(function(err){err&&console.log(err),self.getList(0)})},self.newOrder=function(){$q.when().then(function(){return $user.selectItem()}).then(function(user){return console.log(user),self.Items.save(self.stuff).$promise}).catch(function(err){(err=err.data||err)&&exception.catcher("создание ордера")(err)})},self.pickOrder=function(id){$rootScope.$stateParams.order!=id&&($location.search("order",id),$rootScope.$stateParams.order=id),self.orderId=id},$rootScope.$stateParams.order&&self.pickOrder($rootScope.$stateParams.order)}]).controller("orderCtrl",["$scope","$rootScope","Orders","Stuff","$order","global","$anchorScroll","Helper","CreateContent","$window","$email","$notification","toaster","$q","$http","$location",function($scope,$rootScope,Orders,Stuff,$order,global,$anchorScroll,Helper,CreateContent,$window,$email,$notification,toaster,$q,$http,$location){function showToaster(type,title,content){toaster.pop({type:type,title:title,body:content,bodyOutputType:"trustedHtml",showCloseButton:!0,delay:15e3,closeHtml:"<button>Close</button>"})}function displayContentInPopUpWin(c){var popupWin=window.open();popupWin.window.focus(),popupWin.document.write(c)}$anchorScroll(),$scope.orderEditCtrl=this,$scope.orderEditCtrl.mobile=global.get("mobile").val,$scope.moment=moment,$scope.global=global,$rootScope.orderEditCtrl=$scope.orderEditCtrl,$scope.orderEditCtrl.stuff="",$scope.orderEditCtrl.statusArray=[{status:"поступил",value:1},{status:"принят",value:2},{status:"оплачен",value:3},{status:"доставлен",value:5}];var $state=($rootScope.$stateParams,$rootScope.$state);$scope.orderEditCtrl.order=null,$scope.orderEditCtrl.participant=global.get("seller").val?"seller":"user",$scope.orderEditCtrl.orderId=null,$scope.orderEditCtrl.loadOrder=function(){$order.init("order",$scope.orderEditCtrl.orderId).then(function(order){$scope.orderEditCtrl.order=order,$scope.orderEditCtrl.status=$scope.orderEditCtrl.statusArray.getObjectFromArray("value",order.status),$scope.orderEditCtrl.listStuffForShip=order.cart.stuffs.map(function(s){return s.name+" "+s.artikul+" "+s.addCriterionName}),$scope.orderEditCtrl.currencyArray=Object.keys(order.currencyStore).map(function(k){return order.currencyStore[k]}),$scope.orderEditCtrl.currency=order.currencyStore[order.currency],$scope.orderEditCtrl.order.coupon||$http({method:"GET",url:"/api/getCouponsForOrder/"+$scope.orderEditCtrl.order._id}).then(function(data){$scope.orderEditCtrl.coupons=data.data},function(response){})})},$scope.orderEditCtrl.removeItem=function(i){$order.removeItem(i)},$scope.orderEditCtrl.updateOrder=function(dontUpdate){if($location.search("order",null),$rootScope.$stateParams.id=null,$scope.$parent.$parent.ordersCtrl&&$scope.$parent.$parent.ordersCtrl.setUnReadChatMessages&&(console.log($scope.$parent.$parent.ordersCtrl),$scope.$parent.$parent.ordersCtrl.setUnReadChatMessages()),dontUpdate)return $scope.orderEditCtrl.orderId=null;Orders.save($scope.orderEditCtrl.order).$promise.then(function(res){$scope.$parent.ordersCtrl.reloadOrders(),$scope.orderEditCtrl.orderId=null},function(){$scope.orderEditCtrl.orderId=null})},$scope.orderEditCtrl.selectStuff=function(stuff){$order.addItemToCart(stuff)},$scope.orderEditCtrl.refresStuffs=function(search){search&&search.length&&search.length>2&&Stuff.getList(null,search.substring(0,30),0,30,"fullListForAddToCart").then(function(res){res?(res.forEach(function(el){var _sp;global.getSticker&&(_sp=global.getSticker(el,!0)),_sp&&_sp.sticker?el.sticker=_sp.sticker:el.sticker=_sp}),$scope.orderEditCtrl.stuffs=res):$scope.orderEditCtrl.stuffs=[]})},Helper.getItem($state.current.name,function(res){res.popover&&($scope.orderEditCtrl.popover=res.popover),res.intro&&($scope.orderEditCtrl.intro=res.intro),$scope.IntroOptions={steps:[{element:document.querySelector("#step1"),intro:$scope.orderEditCtrl.intro[1]},{element:document.querySelectorAll("#step2")[0],intro:"<strong>You</strong> can also <em>include</em> HTML"},{element:"#step3",intro:"More features, more fun."},{element:"#step4",intro:"Another step."},{element:"#step5",intro:"Get it, use it."}],showStepNumbers:!1,showBullets:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>еще</strong>",prevLabel:'<span style="color:green">назад</span>',skipLabel:"Выход",doneLabel:"Thanks"}}),$scope.orderEditCtrl.getNow=function(){return Date.now()};var getCategoryNameUrl=function(id){if(!id||"category"==id)return{name:"category",url:"id"};for(var i=0,l=global.get("categories").val.length;i<l;i++)if(global.get("categories").val[i]._id==id){var s=global.get("categories").val[i].name.replace(/(["'\/\s])/g,"-");return{name:s,url:global.get("categories").val[i].url,groupUrl:global.get("categories").val[i].group.url}}};$scope.orderEditCtrl.goToStuff=function(stuff){if(stuff){var category=stuff.category&&stuff.category._id?stuff.category._id:stuff.category,categoryNameUrl=(stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,getCategoryNameUrl(category)),stuffUrl=stuff.url?stuff.url:stuff.stuffUrl,obj={groupUrl:categoryNameUrl.groupUrl,categoryName:categoryNameUrl.name.replaceBlanks(),categoryUrl:categoryNameUrl.url,stuffUrl:stuffUrl},url="/"+obj.groupUrl+"/"+obj.categoryName+"/"+obj.categoryUrl+"/"+obj.stuffUrl;stuff.addCriterionToCart&&stuff.addCriterionToCart.length&&(obj.param1=stuff.addCriterionToCart[0],url+="?param1="+obj.param1,2==stuff.addCriterionToCart.length&&(obj.param2=stuff.addCriterionToCart[1],url+="&param2="+obj.param1)),$window.location.href=url}},$scope.orderEditCtrl.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0};var sendMail=function(dataEmail,cb){var deferred=$q.defer(),domain=$scope.orderEditCtrl.order.domain,o={email:dataEmail.email,content:dataEmail.content,subject:dataEmail.subject+" ✔",from:domain+"<"+dataEmail.addSubject+"@madaland.biz>"};return $email.save(o,function(res){deferred.resolve()},function(err){deferred.reject()}),deferred.promise},pushNotification=function(note,cb){$notification.save(note,function(res){cb()},function(err){cb(err)})},updateOrderField=function(){var deferred=$q.defer(),fieldList="",o=($scope.orderEditCtrl.order,{_id:$scope.orderEditCtrl.order._id,seller:$scope.orderEditCtrl.order.seller});return Array.prototype.forEach.call(arguments,function(field){o[field]=$scope.orderEditCtrl.order[field],fieldList&&(fieldList+=" "),fieldList+=field}),Orders.save({update:fieldList},o,function(){deferred.resolve()},function(err){deferred.reject()}),deferred.promise};$scope.orderEditCtrl.changeCurrency=function(){$scope.orderEditCtrl.order.currency=$scope.orderEditCtrl.currency[1],$scope.orderEditCtrl.order.kurs=$scope.orderEditCtrl.currency[0],$scope.orderEditCtrl.updateOrderField("currency","kurs")},$scope.orderEditCtrl.updateOrderField=function(){updateOrderField.apply(updateOrderField,arguments).then(function(){showToaster("note","Сохренено","информация обновлена")},function(){showToaster("error","Ошибка","не удалось сохранить")})},$scope.orderEditCtrl.printShip=function(){displayContentInPopUpWin(CreateContent.orderShipInfo($scope.orderEditCtrl.order))},$scope.orderEditCtrl.printOrder=function(){displayContentInPopUpWin(CreateContent.order($scope.orderEditCtrl.order))},$scope.orderEditCtrl.printInvoice=function(){displayContentInPopUpWin(CreateContent.order($scope.orderEditCtrl.order,"invoice"))},$scope.orderEditCtrl.sendNotification=function(type,obj,addressee){addressee=addressee?$scope.orderEditCtrl.order.user._id||$scope.orderEditCtrl.order.user:"seller";var o={addressee:addressee,type:type,content:""};o.seller=$scope.orderEditCtrl.order.seller._id;var noteContent,dataEmail={content:""},notification="send";"pay"==type?(updateOrderField("pay"),o.content=CreateContent.payInfo($scope.orderEditCtrl.order,obj),noteContent="уведомление об оплате отправлено"):"shipDetail"==type?(updateOrderField("shipDetail"),o.content=CreateContent.shipInfo($scope.orderEditCtrl.order,obj),noteContent="уведомление о доставке отправлено"):"invoice"==type?($scope.orderEditCtrl.order.invoice=Date.now(),updateOrderField("ivoice"),noteContent="счет отправлен на email.",o.content=CreateContent.invoiceInfo($scope.orderEditCtrl.order),dataEmail.content=CreateContent.order($scope.orderEditCtrl.order,"invoice"),dataEmail.subject="счет",dataEmail.addSubject="invoice",dataEmail.email=$scope.orderEditCtrl.order.user.email):"accepted"==type?($scope.orderEditCtrl.order.date2=Date.now(),updateOrderField("date2"),dataEmail.content=CreateContent.acceptedInfo($scope.orderEditCtrl.order),o.content=dataEmail.content,noteContent="уведомление и письмо отправлены",dataEmail.subject="заказ принят",dataEmail.addSubject="accepted",dataEmail.email=$scope.orderEditCtrl.order.user.email):"shipOrder"==type&&(notification=null,updateOrderField("shipDetail"),dataEmail.content=CreateContent.orderShipInfo($scope.orderEditCtrl.order),noteContent="информация о доставке отправлена на email.",dataEmail.subject="информация о доставке",dataEmail.addSubject="shipDetail",dataEmail.email=$scope.orderEditCtrl.order.user.email),o.order=$scope.orderEditCtrl.order._id,$q.when(dataEmail.content?sendMail(dataEmail):"note").then(function(res){var title,defer=$q.defer();return"send"==notification?(title="Отправлено уведомление",pushNotification(o,function(err){err?defer.reject(err):defer.resolve(title)})):(title="Отправлено письмо",defer.resolve(title)),defer.promise},function(){showToaster("error","Ошибка","не удалось отправить письмо")}).then(function(title){showToaster("note",title,noteContent)},function(){showToaster("error","Ошибка","не удалось отаправить уведомление")})},$scope.orderEditCtrl.deleteCoupon=function(){$http({method:"GET",url:"/api/deleteCouponFromOrder/"+$scope.orderEditCtrl.order._id}).then(function(data){$scope.orderEditCtrl.order.coupon=null,updateOrderField("coupon"),$scope.orderEditCtrl.coupons=data.data},function(response){showToaster("error","Ошибка","не удалось удалить купон")})},$scope.orderEditCtrl.setCoupon=function(){$http({method:"POST",url:"/api/setCouponToOrder",data:{order:$scope.orderEditCtrl.order._id,coupon:$scope.orderEditCtrl.order.coupon._id,user:$scope.orderEditCtrl.order.user._id}}).then(function(){$scope.orderEditCtrl.coupons=null},function(response){showToaster("error","Ошибка","не удалось установить купон")})}}]),function(){function ordersListDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:orderListCtrl,controllerAs:"$ctrl",templateUrl:"components/order/orders-list.html"}}function orderListCtrl(Orders,global,$rootScope,$window,$timeout,$location,socket,$q,$user,exception,Confirm,$dialogs,CartInOrder){function changeRows(rows){self.paginate.rows!=rows&&(self.paginate.rows=rows,self.paginate.page=0,self.paginate.items=0,getList(0))}function markAllStuffs(m){self.orders.forEach(function(el){el.select=m})}function changeAction(){Confirm(self.action+"?").then(function(){if(self.action){var a=angular.copy(self.action);switch(self.action=null,self.mark=!1,a){case"delete":return deleteOrders()}}}).catch(function(){self.action=null})}function deleteOrders(){Confirm("потверждаете?").then(function(){var ids=self.orders.filter(function(el){return el.select}).map(function(el){return el._id}).join("_"),idsInnerCart=self.orders.filter(function(el){return el.select}).map(function(el){return el.cart}).join("_");$q.when().then(function(){return Orders.delete({ids:ids}).$promise.then(function(){global.set("saving",!0),getList(),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}).then(function(){return CartInOrder.delete({ids:idsInnerCart}).$promise.then(function(){},function(err){console.log(err)})})}).catch(function(){self.action=null})}function activate(){return self.participant=global.get("seller").val?"seller":"user","seller"==self.participant?(socket.on("userStatus",function(data){self.orders.forEach(function(o){o.user==data.user&&(o.online=data.status)})}),socket.on("newNotification",function(data){data&&"order"==data.type&&self.getList(0)})):socket.on("sellerStatus",function(data){self.orders&&self.orders.length&&self.orders.forEach(function(o){o.online=data.status})}),self.getList(0)}function getList(page){if(0===page&&(self.paginate.page=page),!global.get("user").val||!global.get("user").val._id)return void setTimeout(function(){getList(page)},1500);if(global.get("seller")&&global.get("seller").val||(self.query.user=global.get("user").val._id),self.query.num||(self.query.date={$gte:new Date(self.datePicker.date.startDate),$lte:new Date(self.datePicker.date.endDate)}),Object.keys(self.query).length>1){query={$and:[]};for(var key in self.query){var o={};o[key]=self.query[key],query.$and.push(o)}}else query=self.query;Orders.getList(self.paginate,self.query).then(function(res){self.orders=res,query=null,self.itemsCount=self.paginate.items,self.orders.forEach(function(o){"seller"==self.participant?socket.emit("getUserStatus",{user:o.user}):socket.emit("getSellerStatus",{seller:o.seller})})}).then(function(){})}function reloadOrders(s){if(self.query={},s){var a=parseInt(s.substring(0,30));"number"==typeof a&&a%1==0?self.query.num=a:(self.query["profile.fio"]=s.substring(0,30),console.log(self.query["profile.fio"]))}self.getList(0)}function deleteItem(item,e){e.stopPropagation(),global.get("seller").val?Confirm("Удалить?").then(function(){var dialog={seller:item.seller,user:item.user,order:item._id};return $dialogs.query({query:dialog}).$promise}).then(function(dialogs){if(dialogs&&dialogs[0]&&dialogs[0].index)return $dialogs.delete({id:dialogs[1]._id}).$promise}).then(function(){return Orders.delete({_id:item._id}).$promise}).then(function(){return self.getList(0)}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление ордера")(err)}):Confirm("Удалить?").then(function(){return item.status=6,Orders.save({update:"status"},{_id:item._id,status:item.status}).$promise}).then(function(){return self.getList(0)})}function newOrder(){$q.when().then(function(){return $user.selectOrCreat()}).then(function(user){user.profile||(user.profile={phone:user.phone,fio:user.name});var order={cart:{stuffs:[]},kurs:1,currency:"UAH",profile:user.profile,seller:global.get("store").val.seller._id,currencyStore:global.get("store").val.currency,opt:global.get("store").val.seller.opt,campaign:global.get("campaign").val?global.get("campaign").val.map(function(el){return el._id}):null};return"user"==user.type?order.user=user._id:"userEntry"==user.type&&(order.userEntry=user._id),Orders.save(order).$promise}).then(function(res){return newId=res.id,activate()}).then(function(){self.$state.go("frame.orders.order",{id:newId})}).catch(function(err){err&&(err=err.data||err)&&exception.catcher("создание ордера")(err)})}function getUnReadChatMessages(order){if(global.get("dialogs").val&&global.get("dialogs").val.length){var d=global.get("dialogs").val.getOFA("order",order._id);return d?d.count:void 0}}function searchItem(searchStr){if(console.log(searchStr),self.query={},!searchStr)return getList(0);var n=Number(searchStr);if(console.log(n),n)self.query.num=n;else{var s=searchStr.substring(0,20);self.query["profile.fio"]=s}getList(0)}function filterOrderList(item){return!!global.get("seller").val||6!=item.status}var self=this;self.global=global,self.mobile=global.get("mobile").val,$rootScope.ordersCtrl=self,self.$state=$rootScope.$state,self.paginate={page:0,rows:20,items:0},self.query={};var newId,query=null;self.listOfActions={delete:"удаление"},self.action1=null,self.getList=getList,self.reloadOrders=reloadOrders,self.deleteItem=deleteItem,self.newOrder=newOrder,self.getUnReadChatMessages=getUnReadChatMessages,self.searchItem=searchItem,self.filterOrderList=filterOrderList,self.markAllStuffs=markAllStuffs,self.changeAction=changeAction,self.changeRows=changeRows,socket.on("newMessage",function(){}),self.dt=new Date,self.today=function(t){return t?new Date(self.dt.setHours(0,0,0)):new Date(self.dt.setHours(23,59,59))},self.maxDate=self.today(!0);var dtto=self.today(),dtfrom=self.today(!0);dtfrom.setDate(dtfrom.getDate()-30),self.dtto=dtto,self.dtfrom=dtfrom;var now=new Date,yesterday=new Date(new Date(self.today(!0)).setDate(now.getDate()-1)),nextWeek=new Date(new Date(self.today(!0)).setDate(now.getDate()-7)),nextMonth=new Date(new Date(self.today(!0)).setMonth(now.getMonth()-1)),y=dtto.getFullYear(),m=dtto.getMonth(),thisMonth=new Date(y,m,1),last30day=new Date(new Date(self.today(!0)).setDate(now.getDate()-30));self.datePicker={},self.options={ranges:{"сегодня":[self.today(!0),dtto],"вчера":[yesterday,self.today(!0)],"последние 7 дней":[nextWeek,dtto],"последние 30 дней":[last30day,dtto],"текущий месяц":[thisMonth,dtto],"прошлый месяц":[nextMonth,dtto]},locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"прозвольный диапазон",format:"DD.MM.YY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]}},self.datePicker.date={startDate:dtfrom,endDate:dtto},moment.locale("ru"),self.moment=moment,global.get("user").val?activate():$rootScope.$on("logged",function(){activate()}),$rootScope.$on("reloadOrderList",function(){getList(self.paginate.page)})}angular.module("gmall.services").directive("ordersList",ordersListDirective).directive("emptyList",["$timeout",function($timeout){return{restrict:"E",scope:{items:"=items",message:"@"},template:'<div ng-if="show" class="text-center"><h3 ng-bind="message"></h3></div>',link:function(scope,element){scope.$watch("items",function(n,o){scope.show=0===n})}}}]),orderListCtrl.$inject=["Orders","global","$rootScope","$window","$timeout","$location","socket","$q","$user","exception","Confirm","$dialogs","CartInOrder"]}(),function(){function ordersItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:orderItemCtrl,controllerAs:"$ctrl",templateUrl:"components/order/order-item.html"}}function orderItemCtrl($rootScope,Orders,Stuff,$order,global,$anchorScroll,Helper,CreateContent,$window,$email,$notification,toaster,$q,$http,$location,exception,Confirm,CartInOrder,$user,$timeout,$dialogs,Seller,ExternalCatalog,$uibModal,FilterTags,Filters){function createByAPI(){$q.when().then(function(){console.log(self.order),console.log(global.get("brands").val);var zakaz={customer:{name:self.order.profile.fio,email:self.order.user.email}};return self.order.profile.phone&&(zakaz.customer.phone=self.order.profile.phone),self.order.profile.city&&(zakaz.customer.field1=self.order.profile.city),zakaz.materials=[],self.order.cart.stuffs.forEach(function(s){var m={};if(m.name=s.name,s.brand){var b=global.get("brands").val.getOFA("_id",s.brand);b&&(m.producer=b.name)}s.artikul&&(m.sku=s.artikul),s.sortName&&(m.sku+=" "+s.sortName),m.qty=s.quantity,m.priceForSale=Math.round(s.sum/s.quantity*100)/100,m.price=Math.round(.7*m.priceForSale*100)/100,m.supplier=global.get("store").val.name,zakaz.materials.push(m)}),zakaz.virtualAccount=global.get("store").val.name,zakaz.currency=self.order.currency,zakaz.currencyRn=self.order.currency,self.order.createByAPI&&(zakaz.createByAPI=self.order.createByAPI),zakaz.comment="Заказ № "+self.order.num+" от "+moment(self.order.date).format("LLL"),console.log(zakaz),$http.post("/api/bookkeep/Zakaz/createByAPI",zakaz)}).then(function(res){console.log(res),res.data&&res.data.createByAPI&&(self.order.createByAPI=res.data.createByAPI,updateOrderField("createByAPI"))}).catch(function(err){console.log(err)})}function backState(){$rootScope.$state.go("frame.orders",$rootScope.$stateParams,{reload:reload})}function getExtCatalog(i){return 0==i&&self.order.cart.stuffs[i].extCatalog?self.extCatalogs.find(function(c){return c._id==self.order.cart.stuffs[i].extCatalog}):self.order.cart.stuffs[i].extCatalog&&self.order.cart.stuffs[i-1].extCatalog!=self.order.cart.stuffs[i].extCatalog?self.extCatalogs.find(function(c){return c._id==self.order.cart.stuffs[i].extCatalog}):void 0}function addStuffInOrder(){$q.when().then(function(){return Stuff.selectItemWithSort()}).then(function(stuff){$order.addItemToCart(stuff)}).then(function(stuff){setStuffListForShip()}).then(function(){showToaster("note","Сохренено","информация обновлена")}).catch(function(err){err&&exception.catcher("обновление данных")(err)})}function decreaseQty(i){if(1!=self.order.cart.stuffs[i].quantity){reload=!0,$order.decreaseQty(i);var s=self.order.cart.stuffs[i],n=s.name+" "+(s.artikul||"")+" "+(s.sortName||"");removeItemFromShip(self.order.shipDetail,n),updateOrderField("shipDetail"),setStuffListForShip()}}function removeItemFromShip(ship,n,all){for(var done=!1,i=0;i<ship.length&&!done;i++)for(var j=0;j<ship[i].stuffs.length;j++)if(n==ship[i].stuffs[j].name){ship[i].stuffs[j].qty--,ship[i].stuffs[j].qty&&!all||ship[i].stuffs.splice(j,1),done=!0;break}}function increaseQty(i){reload=!0,$order.increaseQty(i),setStuffListForShip()}function increaseDiscount(){self.order.discount.value<1e3&&self.order.discount.value++}function decreaseDiscount(){self.order.discount.value>0&&self.order.discount.value--}function getFilterName(tag){if(self.filterTags&&self.filters){var t=self.filterTags.getOFA("_id",tag);if(t&&t.filter){var f=self.filters.getOFA("_id",t.filter);return f?f.name:""}return""}}function getShipDetailQty(stuffs){return stuffs.reduce(function(s,i){return s+Number(i.qty)},0)}function setNewPriceForStuff(stuff){$uibModal.open({animation:!0,templateUrl:"components/order/modal/setNewPrice.html",controller:function($uibModalInstance,stuff){var self=this;self.price=stuff.priceSale?stuff.priceSale:"",self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(){$uibModalInstance.close(self.price)}},controllerAs:"$ctrl",resolve:{stuff:function(){return stuff}}}).result.then(function(priceSale){reload=!0,priceSale&&"0"!=priceSale&&priceSale!=stuff.price?(stuff.priceSale=priceSale,stuff.priceSaleHandle=!0):(stuff.priceSale=null,stuff.priceSaleHandle=!1),stuff.campaignUrl=null,stuff.campaignId=null,stuff.priceCampaign=null,$order.updateOrder()})}function createNewOrder(){for(var n,name,newCart=[],i=0;i<self.order.cart.stuffs.length;i++)self.order.cart.stuffs[i].selected&&(n=self.order.cart.stuffs.splice(i,1),i--,newCart.push(n[0]),name=n[0].name+" "+(n[0].artikul||"")+" "+(n[0].sortName||""),console.log(name),removeItemFromShip(self.order.shipDetail,name,!0));if(newCart.length){var newOrder=angular.copy(self.order);newOrder.cart={stuffs:newCart},delete newOrder._id,delete newOrder.num,delete newOrder.date,delete newOrder.date1,delete newOrder.date2,delete newOrder.date3,delete newOrder.date4,delete newOrder.invoice,delete newOrder.invoiceInfo,delete newOrder.statSent,newOrder.coupon&&newOrder.coupon._id&&(newOrder.coupon=newOrder.coupon._id),newOrder.seller&&newOrder.seller._id&&(newOrder.seller=newOrder.seller._id),newOrder.user&&newOrder.user._id&&(newOrder.user=newOrder.user._id),newOrder.userEntry&&(newOrder.user=null),newOrder.campaign&&newOrder.campaign.length&&(newOrder.campaign=newOrder.campaign.map(function(c){return c._id?c._id:c})),newOrder.status=1,newOrder.pay=[],newOrder.discount={type:0,value:0},newOrder.quantity=newOrder.cart.stuffs.reduce(function(q,i){return q+i.quantity},0),newOrder.sum=newOrder.cart.stuffs.reduce(function(s,i){return s+i.quantity*i.cena},0),newOrder.paySum=newOrder.sum*newOrder.kurs,newOrder.priceSaleHandle=newOrder.cart.stuffs.some(function(s){return s.priceSaleHandle}),newOrder.maxDiscountOver=newOrder.cart.stuffs.some(function(s){return s.maxDiscountOver}),console.log(newOrder),$timeout(function(){$order.updateOrder()},100),updateOrderField("shipDetail"),setStuffListForShip(),Orders.save(newOrder,function(){$rootScope.$emit("reloadOrderList")})}}function addStuffToExistOrder(){$q.when().then(function(){var paginate={page:0,rows:20},query={};return query.user=self.order.user,query.status={$lte:2},Orders.getList(paginate,query)}).then(function(results){
var orders=results.filter(function(o){return o._id!=self.order._id});return $uibModal.open({animation:!0,templateUrl:"components/order/modal/selectOrders.html",controller:function($uibModalInstance,orders){var self=this;orders||(orders=[]),self.orders=orders.map(function(o){return o.date=moment(o.date).format("LLL"),o}),self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(order){$uibModalInstance.close(order)}},controllerAs:"$ctrl",resolve:{orders:function(){return orders}}}).result}).then(function(order){if(order&&order._id)return Orders.getItem(order._id)}).then(function(order){if(!order||!order.cart)throw"нет корзины с товарами в ордере";var cart=angular.copy(order.cart);if("object"==typeof cart){cart.stuffs||(cart.stuffs=[]),cart.order=order._id;for(var n,is,i=0;i<self.order.cart.stuffs.length;i++)if(self.order.cart.stuffs[i].selected){n=self.order.cart.stuffs.splice(i,1),i--,is=!1;for(var j=0;j<cart.stuffs.length;j++)if(cart.stuffs[j]._id==n[0]._id&&cart.stuffs[j].sort==n[0].sort){is=!0,cart.stuffs[j].quantity++;break}is||cart.stuffs.push(n[0]),name=n[0].name+" "+(n[0].artikul||"")+" "+(n[0].sortName||""),removeItemFromShip(self.order.shipDetail,name,!0)}return CartInOrder.save({update:"stuffs"},cart).$promise}}).then(function(){$timeout(function(){$order.updateOrder()},100),updateOrderField("shipDetail"),setStuffListForShip()}).catch(function(err){err&&exception.catcher("добавление товара в ордер")(err)})}function showToaster(type,title,content){toaster.pop({type:type,title:title,body:content,bodyOutputType:"trustedHtml",showCloseButton:!0,delay:15e3,closeHtml:"<button>Close</button>"})}function updateDiscount(){self.order.priceSaleHandle=self.order.cart.stuffs.some(function(s){return s.priceSaleHandle}),self.order.maxDiscountOver=self.order.cart.stuffs.some(function(s){return s.maxDiscountOver}),updateOrderField("discount","sum","paySum","maxDiscountOver","priceSaleHandle")}function displayContentInPopUpWin(c){var popupWin=window.open();popupWin.window.focus(),popupWin.document.write(c)}function setStuffListForShip(){self.listStuffForShip=[],self.order.cart.stuffs.forEach(function(s){var n=s.name+" "+(s.artikul||"")+" "+(s.sortName||""),o={name:n.trim(),qty:s.quantity};s.unitOfMeasure&&(o.unitOfMeasure=s.unitOfMeasure),self.listStuffForShip.push(o)}),self.order.shipDetail||(self.order.shipDetail=[]),self.order.shipDetail.forEach(function(sd){for(var i=0;i<sd.stuffs.length;i++)if(sd.stuffs[i].name){var s=self.listStuffForShip.getOFA("name",sd.stuffs[i].name);s&&(s.qty-=sd.stuffs[i].qty)}}),self.listStuffForShip=self.listStuffForShip.filter(function(o){return o.qty})}function enableAddStussInShipDetail(name){var s=self.listStuffForShip.getOFA("name",name);return s&&s.qty}function addStuffInShipDetail(shipDetail,stuff){for(var added=!1,i=0;i<shipDetail.stuffs.length;i++)if(shipDetail.stuffs[i].name&&shipDetail.stuffs[i].name==stuff.name){added=!0,shipDetail.stuffs[i].qty+=stuff.qty;break}if(!added){var o={name:stuff.name,qty:stuff.qty};stuff.unitOfMeasure&&(o.unitOfMeasure=stuff.unitOfMeasure),shipDetail.stuffs.push(o)}setStuffListForShip(),updateOrderField("shipDetail")}function addStuffToShipDetail(shipDetail,i){var s=self.listStuffForShip.getOFA("name",shipDetail.stuffs[i].name);s&&s.qty&&shipDetail.stuffs[i].qty++,setStuffListForShip(),updateOrderField("shipDetail")}function removeStuffFromShipDetail(shipDetail,i){shipDetail.stuffs[i].qty&&shipDetail.stuffs[i].qty>1?shipDetail.stuffs[i].qty--:shipDetail.stuffs.splice(i,1),setStuffListForShip(),updateOrderField("shipDetail")}function deleteShip(i){self.order.shipDetail.splice(i,1),self.setStuffListForShip(),updateOrderField("shipDetail","paySum")}function deletePay(i){self.order.pay.splice(i,1),updateOrderField("pay","paySum")}function startChat(){self.dialog._id||$dialogs.save(self.dialog,function(res){self.dialog._id=res.id},function(err){console.log(err)})}function changeStatus(status){if(self.order.status=status.value,self.updateOrderField("status"),!(self.order.statSent||3!=self.order.status&&5!=self.order.status)){self.order.statSent=!0,self.updateOrderField("statSent");var order=self.order;try{if(global.get("local")&&!global.get("local").val&&$window.ga){var transaction={id:order.num,affiliation:global.get("store").val.domain||global.get("store").val.subDomain,revenue:(order.kurs*order.getCouponSum()).toFixed(2),shipping:order.shipCost?order.shipCost:0,currency:order.currency};console.log(transaction),$window.ga("ecommerce:addTransaction",transaction);order.cart.stuffs.forEach(function(el){var o={id:"",name:el.name+" "+(el.artikul?el.artikul:"")+" "+(el.sortName?el.sortName:""),price:(order.kurs*el.cena).toFixed(2),quantity:el.quantity};$window.ga("ecommerce:addItem",o)}),$window.ga("ecommerce:send"),$window.ga("ecommerce:clear")}}catch(err){throw err}try{if(global.get("local")&&!global.get("local").val&&window.yaCounter&&window.yaCounter.reachGoal){var yaParams={order_id:order.num,order_price:(order.kurs*order.getCouponSum()).toFixed(2),currency:order.currency,exchange_rate:order.rate,goods:[]};order.cart.stuffs.forEach(function(el){yaParams.goods.push({id:"",name:el.name+" "+(el.artikul?el.artikul:"")+" "+(el.sortName?el.sortName:""),price:(order.kurs*el.cena).toFixed(2),quantity:el.quantity})}),window.yaCounter.reachGoal("order",yaParams)}}catch(err){throw err}}}var self=this;$rootScope.$stateParams.block?self.block=$rootScope.$stateParams.block:self.block="delivery",self.mobile=global.get("mobile").val,self.moment=moment,self.global=global,$rootScope.orderEditCtrl=self,self.statusArray=[{status:"поступил",value:1},{status:"принят",value:2},{status:"оплачен",value:3},{status:"отправлен",value:4},{status:"доставлен",value:5},{status:"удален",value:6}];var $stateParams=$rootScope.$stateParams,$state=$rootScope.$state;self.stuff="",self.order=null;var reload=!1;$rootScope.$on("logged",function(){self.participant=global.get("seller").val?"seller":"user"}),self.participant=global.get("seller").val?"seller":"user",self.addStuffInOrder=addStuffInOrder,self.startChat=startChat,self.setStuffListForShip=setStuffListForShip,self.addStuffInShipDetail=addStuffInShipDetail,self.removeStuffFromShipDetail=removeStuffFromShipDetail,self.deleteShip=deleteShip,self.deletePay=deletePay,self.getExtCatalog=getExtCatalog,self.changeStatus=changeStatus,self.setNewPriceForStuff=setNewPriceForStuff,self.enableAddStussInShipDetail=enableAddStussInShipDetail,self.addStuffToShipDetail=addStuffToShipDetail,self.decreaseQty=decreaseQty,self.increaseQty=increaseQty,self.getFilterName=getFilterName,self.backState=backState,self.decreaseDiscount=decreaseDiscount,self.increaseDiscount=increaseDiscount,self.getShipDetailQty=getShipDetailQty,self.createNewOrder=createNewOrder,self.addStuffToExistOrder=addStuffToExistOrder,self.updateDiscount=updateDiscount,self.createByAPI=createByAPI,function(){$anchorScroll(),$q.when().then(function(){return global.get("masters")?global.get("masters").val:[]}).then(function(data){self.masters=data}).then(function(){return FilterTags.getFilterTags()}).then(function(res){return self.filterTags=res,Filters.getFilters()}).then(function(res){return self.filters=res,ExternalCatalog.getItems()}).then(function(extCatalogs){self.extCatalogs=extCatalogs,$order.init("order",$stateParams.id).then(function(order){order.sortCart(),self.order=order,self.orderForChat={_id:order._id,num:order.num},self.status=self.statusArray.getObjectFromArray("value",order.status),setStuffListForShip(),self.currencyArray=Object.keys(order.currencyStore).map(function(k){return order.currencyStore[k]}),self.currency=order.currencyStore[order.currency],$q.when().then(function(user){!global.get("coupons").val||!global.get("coupons").val[0]||order.coupon&&order.coupon._id||(order.user.coupons.indexOf(global.get("coupons").val[0]._id)<0?self.coupon=global.get("coupons").val[0]:global.get("coupons").val[1]&&order.user.coupons.indexOf(global.get("coupons").val[1]._id)<0&&(self.coupon=global.get("coupons").val[1]))}).then(function(){return self.dialog={seller:self.order.seller._id,user:self.order.user._id,order:self.order._id},$dialogs.query({query:self.dialog}).$promise}).then(function(res){return self.dialog.sellerName=self.order.seller.name,self.dialog.userName=self.order.user.name,self.dialog.orderNum=self.order.num,res&&res[0]&&res[0].index?res[1]._id:null}).then(function(id){id?self.dialog._id=id:self.buttonStartDialog=!0}).catch(function(err){console.log(err)})},function(err){$dialogs.query({query:{order:$stateParams.id}},function(res){if(res&&res[0].index)for(var i=1;i<res.length;i++)res[i]._id&&$dialogs.delete({id:res[i]._id})}),$rootScope.$state.go("frame.404")})})}(),self.removeItem=function(i){Confirm(global.get("lang").val.delete+"?").then(function(){reload=!0;var s=self.order.cart.stuffs[i],n=s.name+" "+(s.artikul||"")+" "+(s.sortName||"");removeItemFromShip(self.order.shipDetail,n,!0),updateOrderField("shipDetail"),$order.removeItem(i),setStuffListForShip()})},self.updateOrder=function(field){if($state.go("frame.orders",{reload:!0}),dontUpdate)return self.orderId=null},self.selectStuff=function(stuff){reload=!0,$order.addItemToCart(stuff)},self.refresStuffs=function(search){search&&search.length&&search.length>2&&Stuff.getList(null,search.substring(0,30),0,30,"fullListForAddToCart").then(function(res){res?(res.forEach(function(el){var _sp;global.getSticker&&(_sp=global.getSticker(el,!0)),_sp&&_sp.sticker?el.sticker=_sp.sticker:el.sticker=_sp}),self.stuffs=res):self.stuffs=[]})},self.getPercent=function(){return self.order.sum&&self.order.sum0?Math.round(100*(1-self.order.getTotalSum()/self.order.sum0)):0},self.getNow=function(){return Date.now()};self.goToStuff=function(stuff){return $window.location.href="/content/stuffs/group/category/"+stuff.url},self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD.MM.YY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0};var sendMail=function(dataEmail,cb){var deferred=$q.defer(),domain=global.get("store").val.name||self.order.domain,o={email:dataEmail.email,content:dataEmail.content,subject:dataEmail.subject+" ✔",from:domain+"<"+dataEmail.addSubject+"@"+global.get("store").val.domain+">"};return $email.save(o,function(res){deferred.resolve()},function(err){deferred.reject()}),deferred.promise},pushNotification=function(note,cb){$notification.save(note,function(res){cb()},function(err){cb(err)})},updateOrderField=function(){var deferred=$q.defer(),fieldList="",o=(self.order,{_id:self.order._id,seller:self.order.seller}),args=arguments;return $timeout(function(){Array.prototype.forEach.call(args,function(field){"paySum"==field&&(reload=!0),o[field]=self.order[field],fieldList&&(fieldList+=" "),fieldList+=field}),Orders.save({update:fieldList},o,function(){deferred.resolve(),global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){deferred.reject()})},300),deferred.promise};self.changeCurrency=function(){reload=!0,self.order.currency=self.currency[1],self.order.kurs=self.currency[0],self.updateOrderField("currency","kurs"),self.updateCart()},self.updateOrderField=function(){updateOrderField.apply(updateOrderField,arguments).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(){showToaster("error","Ошибка","не удалось сохранить")})},self.printShip=function(){displayContentInPopUpWin(CreateContent.orderShipInfo(self.order))},self.printOrder=function(){displayContentInPopUpWin(CreateContent.order(self.order,!1,!0))},self.printInvoice=function(){displayContentInPopUpWin(CreateContent.order(self.order,"invoice"))},self.updateCart=function(){$order.updateOrder(),setStuffListForShip()},self.sendNotification=function(type,obj,addressee){$q.when().then(function(){if("invoice"==type)return $order.getCheckOutLiqpayHtml(self.order,!0)}).then(function(){if(self.order.checkOutLiqpayHtmlIs){var pos=self.order.checkOutLiqpayHtml.indexOf('src="//');self.order.checkOutLiqpayHtml=self.order.checkOutLiqpayHtml.substr(0,pos+5)+"https:"+self.order.checkOutLiqpayHtml.substr(pos+5)}addressee=addressee?self.order.user._id||self.order.user:"seller";var o={addressee:addressee,type:type,content:""};o.seller=self.order.seller._id;var noteContent,dataEmail={content:""};"pay"==type?(updateOrderField("pay"),o.content=CreateContent.payInfo(self.order,obj),noteContent="уведомление об оплате отправлено"):"shipDetail"==type?(updateOrderField("shipDetail"),o.content=CreateContent.shipInfo(self.order,obj),noteContent="уведомление о доставке отправлено"):"invoice"==type?self.order.user.email&&(self.order.invoice=Date.now(),updateOrderField("invoice"),noteContent="счет отправлен на email.",o.content=CreateContent.invoiceInfo(self.order),dataEmail.content=CreateContent.order(self.order,"invoice"),dataEmail.subject=global.get("langOrder").val.invoiceforpay?global.get("langOrder").val.invoiceforpay.toUpperCase():"СЧЕТ НА ОПЛАТУ ✔",dataEmail.addSubject="sales",dataEmail.email=[self.order.user.email,global.get("store").val.seller.salemail]):"accepted"==type?(self.order.date2=Date.now(),updateOrderField("date2"),self.order.user.email&&(dataEmail.content=CreateContent.order(self.order,!1,!0),o.content=dataEmail.content,noteContent="уведомление и письмо отправлены",dataEmail.subject=global.get("langOrder").val.orderaccepted?global.get("langOrder").val.orderaccepted.toUpperCase():"ЗАКАЗ ПРИНЯТ ✔",dataEmail.addSubject="sales",dataEmail.email=self.order.user.email)):"shipOrder"==type&&self.order.user.email&&(self.order.date4=Date.now(),updateOrderField("shipDetail","date4"),dataEmail.content=CreateContent.orderShipInfo(self.order),o.content=CreateContent.shipInfoNote(self.order),noteContent="информация о доставке отправлена на email.",dataEmail.subject=global.get("langOrder").val.shipinfo?global.get("langOrder").val.shipinfo.toUpperCase():"ИНФОРМАЦИЯ О ДОСТАВКЕ ✔",dataEmail.addSubject="sales",dataEmail.email=self.order.user.email),self.order.user.email&&(o.order=self.order._id,$q.when(dataEmail.content?sendMail(dataEmail):"note").then(function(res){var title,defer=$q.defer();return title="Отправлено уведомление",pushNotification(o,function(err){err?defer.reject(err):defer.resolve(title)}),defer.promise},function(){showToaster("error","Ошибка","не удалось отправить письмо")}).then(function(title){showToaster("note",title,noteContent)},function(){showToaster("error","Ошибка","не удалось отаправить уведомление")}))})},self.deleteCoupon=function(){reload=!0,self.order.user.coupons?self.order.user.coupons.splice(self.order.user.coupons.indexOf(self.order.coupon._id),1):self.order.user.coupons=[];var o={_id:self.order.user._id,coupons:self.order.user.coupons};$user.save({update:"coupons"},o),global.get("coupons").val&&(self.order.user.coupons.indexOf(global.get("coupons").val[0]._id)<0?self.coupon=global.get("coupons").val[0]:global.get("coupons").val[1]&&self.order.user.coupons.indexOf(global.get("coupons").val[1]._id)<0&&(self.coupon=global.get("coupons").val[1])),self.order.coupon=null,$timeout(function(){o={_id:self.order._id,seller:self.order.seller},o.coupon=null,o.paySum=self.order.paySum,Orders.save({update:"coupon paySum"},o)},100)},self.setCoupon=function(coupon){self.order.coupon=coupon,$timeout(function(){var o={_id:self.order._id,seller:self.order.seller};o.coupon=coupon._id,o.paySum=self.order.paySum,Orders.save({update:"coupon paySum"},o),self.order.user.coupons||(self.order.user.coupons=[]),self.order.user.coupons.push(coupon._id),o={_id:self.order.user._id,coupons:self.order.user.coupons},$user.save({update:"coupons"},o)},100)}}angular.module("gmall.services").directive("ordersItem",ordersItemDirective),orderItemCtrl.$inject=["$rootScope","Orders","Stuff","$order","global","$anchorScroll","Helper","CreateContent","$window","$email","$notification","toaster","$q","$http","$location","exception","Confirm","CartInOrder","$user","$timeout","$dialogs","Seller","ExternalCatalog","$uibModal","FilterTags","Filters"]}(),angular.module("gmall.services").factory("$notification",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}var Items=$resource("/api/collections/Notification/:id",{id:"@_id"},{deleteArray:{method:"DELETE"},updateNote:{method:"POST",params:{update:"note"}}});return{getList:getList,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}),angular.module("gmall.controllers").controller("notificationCtrl",["$scope","$rootScope","global","$anchorScroll","Helper","$notification","$sce","exception","$location",function($scope,$rootScope,global,$anchorScroll,Helper,$notification,$sce,exception,$location){function activate(){$scope.notificationCtrl.getList($scope.notificationCtrl.paginate.page,$scope.notificationCtrl.paginate.rows)}var self=this;self.dt=new Date,self.today=function(t){return t?new Date(self.dt.setHours(0,0,0)):new Date(self.dt.setHours(23,59,59))},self.maxDate=self.today(!0);var dtto=self.today(),dtfrom=self.today(!0);dtfrom.setDate(dtfrom.getDate()-30),self.dtto=dtto,self.dtfrom=dtfrom;var now=new Date,yesterday=new Date(new Date(self.today(!0)).setDate(now.getDate()-1)),nextWeek=new Date(new Date(self.today(!0)).setDate(now.getDate()-7)),nextMonth=new Date(new Date(self.today(!0)).setMonth(now.getMonth()-1)),y=dtto.getFullYear(),m=dtto.getMonth(),thisMonth=new Date(y,m,1),last30day=new Date(new Date(self.today(!0)).setDate(now.getDate()-30));self.datePicker={},self.options={ranges:{"сегодня":[self.today(!0),dtto],"вчера":[yesterday,self.today(!0)],"последние 7 дней":[nextWeek,dtto],"последние 30 дней":[last30day,dtto],"текущий месяц":[thisMonth,dtto],"прошлый месяц":[nextMonth,dtto]},locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"прозвольный диапазон",format:"DD.MM.YY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]}},self.datePicker.date={startDate:dtfrom,endDate:dtto},moment.locale("ru"),self.moment=moment,$anchorScroll(),$scope.notificationCtrl=this,$scope.notificationCtrl.typeNote=$rootScope.$stateParams.type,$scope.notificationCtrl.lang=global.get("store").val.lang,$scope.notificationCtrl.notificationsTypeLang=notificationsTypeLang,console.log($scope.notificationCtrl.notificationsTypeLang),$scope.notificationCtrl.notifications=global.get("notifications"),$scope.notificationCtrl.type=$rootScope.$stateParams.type,$scope.notificationCtrl.trustHtml=function(text){return $sce.trustAsHtml(text)},$scope.notificationCtrl.allNote=function(){$location.search("type",null)},$scope.notificationCtrl.paginate={page:0,rows:20,items:0},$scope.notificationCtrl.items=[],$scope.notificationCtrl.setCheckAll=function(){$scope.notificationCtrl.items.forEach(function(el,i){$scope.notificationCtrl.items[i].check=$scope.notificationCtrl.checkAll})},$scope.notificationCtrl.changeType=function(type){$scope.notificationCtrl.type=type,$scope.notificationCtrl.paginate.page=0,$scope.notificationCtrl.getList($scope.notificationCtrl.paginate.page,$scope.notificationCtrl.paginate.rows)};var query=null;$scope.notificationCtrl.getList=function(){var pagin=$scope.notificationCtrl.paginate;$scope.notificationCtrl.checkAll=!1;var user=global.get("seller").val?"seller":global.get("user").val._id;query={$and:[{type:$scope.notificationCtrl.type},{addressee:user}]},global.get("seller").val&&query.$and.push({seller:global.get("seller").val}),$notification.query({perPage:pagin.rows,page:pagin.page,query:query},function(res){0==pagin.page&&res.length>0&&($scope.notificationCtrl.paginate.items=res.shift().index),$scope.notificationCtrl.items=res;var ids=res.filter(function(mes){return!mes.read}).map(function(mes){return mes._id});ids.length&&$notification.save({update:"read dateNote"},{_id:ids,dateNote:Date.now(),read:!0},function(res){},function(err){err.data&&(err=err.data),exception.catcher("обновление статуса сообщений")(err)});var notes=res.filter(function(mes){return!mes.read}).reduce(function(o,item){return o[item.type]?o[item.type]++:o[item.type]=1,o},{});for(var type in notes)global.get("notifications").val&&global.get("notifications").val[type]&&(global.get("notifications").val[type]-=notes[type],$rootScope.notificationsCount-=notes[type],$rootScope.notificationsCount<0&&($rootScope.notificationsCount=0),(!global.get("notifications").val[type]||global.get("notifications").val[type]<0)&&delete global.get("notifications").val[type])})},$scope.notificationCtrl.deleteItem=function(id){var items;items=id?{id:id}:$scope.notificationCtrl.items.filter(function(el){return el.check}).map(function(el){return el._id}),$notification.delete(items,function(res){$scope.notificationCtrl.getList($scope.notificationCtrl.paginate.page,$scope.notificationCtrl.paginate.rows)},function(err){err&&exception.catcher(err)})},$scope.notificationCtrl.deleteEnable=function(){return!!$scope.notificationCtrl.items.length&&$scope.notificationCtrl.items.some(function(el){return el.check})},$scope.notificationCtrl.saveNote=function(note){var field="note",o={_id:note._id,note:note.note};note.dateNote||(note.dateNote=Date.now(),field+=" dateNote",o.dateNote=note.dateNote),$notification.save({update:field},o,function(res){})},global.get("user").val?activate():$rootScope.$on("logged",function(){activate()})}]),angular.module("gmall.directives").directive("goToOrder",["$compile",function($compile){return{scope:{order:"=goToOrder"},link:function(scope,element){setTimeout(function(){if(scope.order){var a=angular.element('<a ui-sref="frame.orders.order({id:order})"></a>');$compile(a)(scope);element.wrap(a)}},100)}}}]),angular.module("gmall.services").factory("$chat",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}var Items=$resource("/api/collections/Chat/:id",{id:"@_id"});return{getList:getList,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}),angular.module("gmall.controllers").controller("chatCtrl",["$scope","$rootScope","global","$anchorScroll","$chat","$sce","$order","$timeout","$location","$http","socket","$auth",function($scope,$rootScope,global,$anchorScroll,$chat,$sce,$order,$timeout,$location,$http,socket,$auth){function setMessagesRead(ids,correct){$http({method:"POST",url:"/api/chatSetReadMessages",data:{ids:ids}}).then(function(){if(correct){if($scope.chatCtrl.order){var name="N-"+$scope.chatCtrl.order.num;global.get("chatMessages")&&global.get("chatMessages").val&&global.get("chatMessages").val[name]&&(global.get("chatMessages").val[name].count-=ids.length,global.get("chatMessages").val[name].count||delete global.get("chatMessages").val[name])}if($scope.chatCtrl.dialog){var name;name="seller"==$scope.chatCtrl.participant?$scope.chatCtrl.user.name:$scope.chatCtrl.seller.name,global.get("dialogs")&&global.get("dialogs").val&&global.get("dialogs").val[name]&&(global.get("dialogs").val[name].count-=ids.length,global.get("dialogs").val[name].count||delete global.get("dialogs").val[name])}$rootScope.setChatMessagesCount&&$rootScope.setChatMessagesCount()}},function(response){console.log(response)})}$anchorScroll(),$scope.chatCtrl=this,$scope.chatCtrl.messages=[],$scope.chatCtrl.page=0,$scope.chatCtrl.rows=10,$scope.chatCtrl.localCount=0,$scope.chatCtrl.totalCount=0,$scope.chatCtrl.firstMessage=null,$scope.chatCtrl.global=global,$scope.moment=moment,socket.on("newMessage",function(message){$scope.chatCtrl.order&&$scope.chatCtrl.order._id!=message.order||$scope.chatCtrl.dialog&&$scope.chatCtrl.dialog._id!=message.dialog||("seller"==message.recipient?message.name=$scope.chatCtrl.user.name:message.name=$scope.chatCtrl.seller.name,$scope.chatCtrl.messages.push(message),setMessagesRead([message._id]))});var delay;console.log($scope.chatCtrl.dialog),$scope.chatCtrl.sendMessage=function(){var form=$scope.formChat,message=$scope.chatCtrl.message;if(!delay)if(delay=!0,$timeout(function(){delay=!1},1200),form.$valid){$scope.chatCtrl.submitted=!1;var o={message:message.clearTag(250)};o.seller=$scope.chatCtrl.seller._id,o.user=$scope.chatCtrl.user._id,$scope.chatCtrl.order?(o.order=$scope.chatCtrl.order._id,o.name="N-"+$scope.chatCtrl.order.num,o.recipient="seller"==$scope.chatCtrl.participant?$scope.chatCtrl.user._id:"seller",o.type="order"):("seller"==$scope.chatCtrl.participant?(o.recipient=o.user,o.name=$scope.chatCtrl.seller.name):(o.recipient="seller",o.name=$scope.chatCtrl.user.name),o.type="user",o.dialog=$scope.chatCtrl.dialog._id),o.token=$auth.getToken(),o.host=socketHost,socket.emit("newMessage",o),$scope.chatCtrl.messages.push(o),$scope.chatCtrl.message=""}else $scope.chatCtrl.submitted=!0},$scope.chatCtrl.getMessages=function(p,r){var query;query=$scope.chatCtrl.order?{order:$scope.chatCtrl.order._id}:{$and:[{order:{$exists:!1}},{user:$scope.chatCtrl.user._id},{seller:$scope.chatCtrl.seller._id}]},$chat.query({perPage:r,page:p,query:query},function(res){0==p&&res&&res.length&&($scope.chatCtrl.totalCount=res.shift().index),$scope.chatCtrl.localCount+=res.length,res.forEach(function(el){"seller"==el.recipient?el.name=$scope.chatCtrl.user.name:el.name=$scope.chatCtrl.seller.name}),$scope.chatCtrl.messages.length?res.forEach(function(el){$scope.chatCtrl.messages.unshift(el)}):$scope.chatCtrl.messages=res.reverse();var ids=res.reduce(function(ids,c){return c.read||ids.push(c._id),ids},[]);ids.length&&setMessagesRead(ids,!0)})},$scope.chatCtrl.getMoreMessage=function(){$scope.chatCtrl.page++,$scope.chatCtrl.getMessages($scope.chatCtrl.page,$scope.chatCtrl.rows)},$scope.chatCtrl.getWho=function(recipient){var participant=$scope.chatCtrl.participant;return"seller"==recipient&&"seller"==participant||"seller"!=recipient&&"seller"!=participant?"he":"seller"!=recipient&&"seller"==participant||"seller"==recipient&&"seller"!=participant?"me":void 0}}]),angular.module("gmall.directives").directive("chatBox",function($timeout){return{restrict:"E",controller:"chatCtrl",scope:{state:"@",order:"=",participant:"=",seller:"=",user:"=",dialog:"=",message:"="},templateUrl:"components/chat/chat.html",link:function(scope,element,attribute,ctrl){$timeout(function(){ctrl.participant=scope.participant,ctrl.seller=scope.seller,ctrl.order=scope.order,ctrl.user=scope.user,ctrl.dialog=scope.dialog,ctrl.getMessages(ctrl.page,ctrl.rows),scope.message&&(ctrl.message=scope.message,$timeout(function(){ctrl.sendMessage()},20))},10)}}}),function(){function itemDirective(){return{restrict:"E",scope:{participant:"@",dialog:"="},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/chat/chat-dialog.html"}}function itemCtrl($scope,$chat,$state,global,$timeout,socket,exception){function activate(){return global.get("store").val.seller._id==self.dialog.seller&&(self.dialog.sellerName=global.get("store").val.seller.name||global.get("store").val.name),"seller"==self.participant?(socket.emit("getUserStatus",{user:self.dialog.user}),socket.on("userStatus",function(data){self.online=data.status})):(socket.emit("getSellerStatus",{seller:self.dialog.seller}),socket.on("sellerStatus",function(data){self.online=data.status})),getList().then(function(){})}function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){data.reverse(),data.forEach(function(mes){getWho(mes)});var ids=data.filter(function(mes){return!mes.read&&mes.recipient==self.participant}).map(function(mes){return mes._id});return ids.length&&$chat.save({update:"read"},{_id:ids,read:!0},function(res){getChatUnReadMessages({dialog:self.dialog._id,count:ids.length})},function(err){err.data&&(err=err.data),exception.catcher("обновление статуса сообщений")(err)}),self.items&&self.items.length&&data&&data.length&&Array.prototype.push.apply(data,self.items),self.items=data,self.items}).catch(function(err){err&&(err.data&&(err=err.data),exception.catcher("получение сообщений")(укк))})}function getWho(mes){("seller"==mes.recipient&&"seller"==self.participant||"seller"!=mes.recipient&&"seller"!=self.participant)&&(mes.who="he"),("seller"!=mes.recipient&&"seller"==self.participant||"seller"==mes.recipient&&"seller"!=self.participant)&&(mes.who="me"),"seller"==mes.recipient?mes.name=self.dialog.userName:"user"==mes.recipient&&(mes.name=self.dialog.sellerName)}function sendMessage(form){if(!delay&&(delay=!0,$timeout(function(){delay=!1},1200),form.$valid)){var o=angular.copy(self.message);o.message=self.text.clearTag(250),socket.emit("newMessage",o),self.text=""}}function getChatUnReadMessages(data){if(global.get("dialogs")&&global.get("dialogs").val){for(var i=0,l=global.get("dialogs").val.length;i<l;i++)if(global.get("dialogs").val[i].dialog==data.dialog){global.get("dialogs").val[i].count-=data.count,(!global.get("dialogs").val[i].count||global.get("dialogs").val[i].count<0)&&global.get("dialogs").val.splice(i,1);break}}else global.get("dialogs")||setTimeout(function(data){getChatUnReadMessages(data)},4e3)}function getMoreMessage(){self.paginate.page++,self.dontscroll=!0,getList()}var self=this;self.mobile=global.get("mobile").val,self.$state=$state,self.global=global,self.Items=$chat,self.moment=moment,self.paginate={page:0,rows:5,items:0},self.text="";var delay;angular.version.minor<6?(self.query={dialog:self.dialog._id},self.dialog.order&&global.get("dialogs").val,self.guest="guest"==self.dialog.user.split("-")[0],self.message={dialog:self.dialog,recipient:"seller"==self.participant?"user":"seller",sellerName:self.dialog.sellerName,userName:self.dialog.userName},self.dialog.order&&(self.message.order=self.dialog.order,self.message.orderNum=self.dialog.orderNum),activate()):self.$onInit=function(){self.query={dialog:self.dialog._id},self.dialog.order&&global.get("dialogs").val,self.guest="guest"==self.dialog.user.split("-")[0],self.message={dialog:self.dialog,recipient:"seller"==self.participant?"user":"seller",sellerName:self.dialog.sellerName,userName:self.dialog.userName},self.dialog.order&&(self.message.order=self.dialog.order,self.message.orderNum=self.dialog.orderNum),activate()},self.getList=getList,self.getWho=getWho,self.sendMessage=sendMessage,self.getMoreMessage=getMoreMessage,$scope.$on("newChatMessage",function(event,message){self.dialog._id==message.dialog&&(getWho(message),self.items.push(message),message.recipient==self.participant&&($timeout(function(){getChatUnReadMessages({dialog:message.dialog,count:1})},300),$chat.save({update:"read"},{_id:message._id,read:!0})))})}angular.module("gmall.services").directive("chatDialog",itemDirective).directive("scrollUp",function($timeout){return{restrict:"A",scope:!0,link:function(scope,element,attr){scope.$watchCollection(attr.scrollUp,function(newVal){$timeout(function(){scope.$ctrl&&scope.$ctrl.dontscroll?scope.$ctrl.dontscroll=!1:element[0].scrollTop=element[0].scrollHeight})})}}}),itemCtrl.$inject=["$scope","$chat","$state","global","$timeout","socket","exception"]}(),angular.module("gmall.services").factory("$dialogs",function($resource){return $resource("/api/collections/Dialog/:id",{id:"@_id"})}),
angular.module("gmall.controllers").controller("dialogsCtrl",["$scope","$rootScope","global","$anchorScroll","$dialogs","$timeout","$location","$q","socket","Confirm","exception",function($scope,$rootScope,global,$anchorScroll,$dialogs,$timeout,$location,$q,socket,Confirm,exception){function startDialog(){var newDialog={seller:global.get("store").val.seller._id,user:global.get("user").val._id,ellerName:global.get("store").val.seller.name,userName:global.get("user").val.profile&&global.get("user").val.profile.fio?global.get("user").val.profile.fio:global.get("user").val.name};$dialogs.save(newDialog,function(res){$scope.dialogsCtrl.getList(0,1)},function(err){console.log(err)})}function activate(){$scope.dialogsCtrl.participant=global.get("seller").val?"seller":"user",$scope.dialogsCtrl.getList($scope.dialogsCtrl.paginate.page,$scope.dialogsCtrl.paginate.rows),"seller"==$scope.dialogsCtrl.participant?socket.on("userStatus",function(data){var d;(d=$scope.dialogsCtrl.items.getOFA("user",data.user))&&(d.online=data.status)}):socket.on("sellerStatus",function(data){$scope.dialogsCtrl.items.forEach(function(d){d.online=data,status})})}function getGuest(d){if("guest"==d.user.split("-")[0])return!0}$anchorScroll(),$scope.dialogsCtrl=this,$scope.dialogsCtrl.paginate={page:0,rows:20,items:0};var query=null;$scope.dialogsCtrl.items=[],$scope.dialogsCtrl.getGuest=getGuest,$scope.dialogsCtrl.startDialog=startDialog,$scope.dialogsCtrl.getUnReadChatMessages=function(dialog){if(global.get("dialogs").val)for(var i=0,l=global.get("dialogs").val.length;i<l;i++)if(global.get("dialogs").val[i].dialog==dialog._id)return global.get("dialogs").val[i].count},$scope.dialogsCtrl.deleteDialog=function(id,e){e.stopPropagation(),Confirm("удалить???").then(function(){return $dialogs.delete({id:id}).$promise}).then(function(){for(var i=0,l=global.get("dialogs").val.length;i<l;i++)if(id==global.get("dialogs").val[i].dialog){global.get("dialogs").val.splice(i,1);break}$scope.dialogsCtrl.getList($scope.dialogsCtrl.paginate.page,$scope.dialogsCtrl.paginate.rows)}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление диалога")(err)})},$scope.dialogsCtrl.getList=function(page,rows){global.get("user").val&&global.get("user").val._id&&(query=global.get("seller").val?{seller:global.get("seller").val}:{user:global.get("user").val._id},query={$and:[{order:{$exists:!1}},query]},$dialogs.query({perPage:rows,page:page,query:query},function(res){0==page&&res.length>0&&($scope.dialogsCtrl.paginate.items=res.shift().index),0==res.length&&($scope.dialogsCtrl.paginate.items=0),$scope.dialogsCtrl.items=res,$scope.dialogsCtrl.items.forEach(function(d){"seller"==$scope.dialogsCtrl.participant?socket.emit("getUserStatus",{user:d.user}):socket.emit("getSellerStatus",{seller:d.seller})}),query=null},function(err){console.log(err),exception.catcher("получение диалогов")(err)}))},global.get("user").val?activate():$scope.$on("logged",function(){activate()}),socket.on("deleteDialog",function(data){$scope.dialogsCtrl.items.forEach(function(el){$scope.dialogsCtrl.getList($scope.dialogsCtrl.paginate.page,$scope.dialogsCtrl.paginate.rows)})}),socket.on("newDialog",function(data){$scope.dialogsCtrl.getList($scope.dialogsCtrl.paginate.page,$scope.dialogsCtrl.paginate.rows)}),socket.on("newMessage",function(data){$scope.dialogsCtrl.items.some(function(d){return d._id==data.dialog})||($scope.dialogsCtrl.paginate.page=0,activate())}),$scope.$on("$destroy",function(){socket.removeListener("deleteDialog")})}]).controller("dialogCtrl",["$scope","$rootScope","global","$anchorScroll","$dialogs","$timeout","$location","$q","socket",function($scope,$rootScope,global,$anchorScroll,$dialogs,$timeout,$location,$q,socket){function activate(){$dialogs.get({id:$rootScope.$stateParams.id},function(res){res?($scope.dialogCtrl.participant=global.get("seller").val?"seller":"user",$scope.dialogCtrl.dialog=res):console.log("нет такого диалога")},function(err){})}$anchorScroll(),$scope.dialogCtrl=this,global.get("user").val?activate():$scope.$on("logged",function(){activate()})}]),angular.module("gmall.directives"),function(){function userService($resource,$uibModal,$q,Session,User,global,exception,$state,$window,$rootScope,$http,$auth,Account){function newUser(name,email,password){return name||(name=email.split("@")[0]),User.save({name:name,email:email,password:password,action:"subscribtion"}).$promise.then(function(user){if($rootScope.emit("CompleteRegistration"),global&&global.get("user")&&global.set("user",user),global.get("local")&&!global.get("local").val&&$window.ga&&$window.ga("send","event","registration","complete"),"cart"!=$state.current.name&&"couponDetail"!=$state.current.name){var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","subscribtion");pap&&pap.url&&$state.go("thanksPage",{url:pap.url})}}return user})}function newUserByPhone(name,phone){var email=phone+"@gmall.io",user={email:email,name:name,profile:{phone:phone,fio:name}};return $auth.signup(user).then(function(response){if(console.log(response),!(response&&response.data&&response.data.token))throw response;if("update"==response.data.token)throw null}).then(function(response){}).catch(function(err){err&&exception.catcher("new client")(err)})}function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}function selectItem(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/selectUser.html",controller:function($user,$uibModalInstance,query){var self=(angular.copy(query),this);self.items=[],self.name="";var paginate={page:0,rows:30,items:0};self.search=function(name){var q=angular.copy(query);name.length<3||(q?(q.$and||(q={$and:[query]}),q.$and.push({$or:[{name:name},{email:name},{"profile.fio":name}]})):q={$or:[{name:name},{email:name},{"profile.fio":name}]},$user.getList(paginate,q).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(item){resolve(item)},function(){reject()})})}function selectOrCreat(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/selectOrCreate.html",controller:function($user,UserEntry,global,$uibModalInstance){function refreshUsers(str){str.length<3||searchUser(str)}function searchUser(str){if(isNumeric(str)){if(str.length>10)self.oldPhone=str.substring(0,10);else{for(var d=10-str.length,i=0;i<d;i++)str+="0";self.oldPhone=str}self.userName=""}else self.oldPhone=null,self.userName=str;self.users=[];var users=[],q={$or:[{name:str},{email:str},{"profile.fio":str},{"profile.phone":str}]},q1={$or:[{phone:str},{name:str},{email:str}]},acts=[];acts.push(get$user(q)),acts.push(getEntryUser(q1)),$q.all(acts).then(function(res){res[0]&&res[0].length&&res[0].forEach(function(item){item.type="user",users.push(item)}),res[1]&&res[1].length&&res[1].forEach(function(item){item.type="userEntry",users.push(item)}),self.users=users})}function get$user(q){return $user.getList(paginate,q)}function getEntryUser(q){return UserEntry.getList(paginate,q)}function addUser(){var user={name:self.userName,email:self.userEmail,phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10),type:"userEntry"};return $q.when().then(function(){return UserEntry.save(user).$promise}).then(function(res){user._id=res._id?res._id:res.id,self.addingUser=!1,self.userName="",self.user=user,self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function clearUser(){self.user=null}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}var self=this;self.items=[],self.user="",self.oldPhone=null,self.userName="name",self.userEmail="",self.global=global,self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38";var paginate={page:0,rows:30,items:0};self.refreshUsers=refreshUsers,self.addUser=addUser,self.clearUser=clearUser;new RegExp(/^\d+$/);self.ok=function(){$uibModalInstance.close(self.user)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg"}).result.then(function(item){resolve(item)},function(){reject()})})}function saveProfile(user){return Items.save({update:"profile"},{_id:user._id,profile:user.profile}).$promise}function login(){return $q(function(resolve,reject){if(global.get("user")&&global.get("user").val&&global.get("user").val._id)return resolve();var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/login-sign.html",controller:loginCtrl2,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function loginOnlyPhone(){return $q(function(resolve,reject){if(global.get("user")&&global.get("user").val&&global.get("user").val._id)return resolve();var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/login-sign.onlyPhone.html",controller:loginOnlyPhoneCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfo(service){return service=!1,service=service?"Service":"Good",$q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/getInfo.html",controller:getInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass",resolve:{service:function(){return service}}});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfoCtrl($uibModalInstance,exception,global,User,$q,$http,service,Account){function closeModal(){$q.when().then(function(){return self.user._id?Items.save({update:"profile"},{_id:self.user._id,profile:self.user.profile}).$promise:$http.post("/auth/signupOrder",self.user)}).then(function(response){if(response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();response&&response.data&&response.data._id&&(self.user._id=response.data._id)}).then(function(){global.get("user").val&&(self.user=global.get("user").val),$uibModalInstance.close(self.user)})}var self=this;self.service=service,self.global=global,self.user=global.get("user").val,self.user||(self.user={email:"",profile:{}}),self.ok=closeModal,self.cancel=function(){$uibModalInstance.dismiss()}}function getInfoBonus(){return $q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/getInfoBonus.html",controller:getInfoBonusCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfoBonusCtrl($uibModalInstance,exception,global,User,$q,$http,Account,$auth){function closeModal(){$q.when().then(function(){return self.user._id?Items.save({update:"profile"},{_id:self.user._id,profile:self.user.profile}).$promise:$http.post("/auth/signupOrder",self.user)}).then(function(response){if(response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();response&&response.data&&response.data._id&&(self.user._id=response.data._id)}).then(function(){global.get("user").val&&(self.user=global.get("user").val),$uibModalInstance.close(self.user)})}var self=this;self.global=global,self.user=global.get("user").val,self.formData=global.get("store").val.bonusForm?global.get("store").val.bonusForm:null,self.user||(self.user={email:"",profile:{},addInfo:{}}),self.ok=closeModal,self.cancel=function(){$uibModalInstance.dismiss()}}function createUser(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/createUser.html",controller:function($user,$uibModalInstance,$http,$q,exception){var self=this;self.user={profile:{}},self.ok=function(form){form.$invalid||(self.blockButton=!0,$q.when().then(function(){if(self.user.profile&&self.user.profile.phone){var phone=self.user.profile.phone;return $user.getItem(phone,"profile.phone")}return null}).then(function(res){if(res&&res._id)throw"phone exist"}).then(function(){return $user.checkEmailForExist(self.user.email)}).then(function(res){if(res&&res.exist)throw"email exist"}).then(function(){return $http.post(userHost+"/api/createUser",self.user)}).then(function(res){$uibModalInstance.close(res)}).catch(function(err){err&&exception.catcher("error")(err),self.blockButton=!1}))},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){resolve(item)},function(){reject()})})}function changeEmail(userId){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changeEmail.html",controller:function($user,global,$uibModalInstance,$http,$q,exception){function checkEmail(email,valid){if(!valid)return void(self.cheched=!1);$q.when().then(function(){return $user.checkEmailForExist(email)}).then(function(res){if(!res||res.exist)throw"email exist";self.cheched=!0}).catch(function(err){err&&exception.catcher("change email")(err),self.cheched=!1})}var self=this;self.global=global,self.checkEmail=checkEmail,self.email="",self.ok=function(){if(!self.cheched)return void exception.catcher("change email")("email используется");self.blockButton=!0,$q.when().then(function(){return Items.save({update:"email"},{_id:userId,email:self.email})}).then(function(res){$uibModalInstance.close(self.email)}).catch(function(err){self.blockButton=!1})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",windowClass:"modalProject"}).result.then(function(item){resolve(item)},function(){reject()})})}function checkEmailForExist(email,_id){return $q(function(rs,rj){var o={email:email};_id&&(o._id=_id),User.checkEmail(o,function(res){rs(res)},function(err){rj(err)})})}function checkPhoneForExist(phone,_id){return $q(function(rs,rj){var o={email:phone};_id&&(o._id=_id),User.checkPhone(o,function(res){rs(res)},function(err){rj(err)})})}function changePhone(userId){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changePhone.html",controller:function($user,global,$uibModalInstance,$http,$q,exception){function checkPhone(phone){return $q.when().then(function(){return $user.checkPhoneForExist(phone)}).then(function(res){if(!res||res.exist)throw"phone exist"})}var self=this;self.global=global,self.checkPhone=checkPhone,self.email="",self.ok=function(){if(!self.phone)return void exception.catcher("change phone")("phone???");self.blockButton=!0,$q.when().then(function(){return checkPhone(self.phone)}).then(function(){var o={_id:userId};return o["profile.phone"]=self.phone,Items.save({update:"profile.phone"},o)}).then(function(res){$uibModalInstance.close(self.phone)}).catch(function(err){exception.catcher("change phone")(err),self.blockButton=!1})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){resolve(item)},function(){reject()})})}function changePswd(_id){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changePswd.html",controller:function($user,global,$uibModalInstance,$http,$q,_id){var self=this;self.global=global,self.user={_id:_id,password:""},self.ok=function(){$q.when().then(function(){return $http.post(userHost+"/api/changePswd",self.user)}).then(function(res){$uibModalInstance.close(res)}).catch(function(err){$uibModalInstance.dismiss(err)})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{_id:function(){return _id}},windowClass:"modalProject"}).result.then(function(item){resolve(item)},function(){reject()})})}function logout(callback){var cb=callback||angular.noop;return Session.delete(function(){return global.set("user",null),cb()},function(err){return cb(err)}).$promise}function loginCtrl2($scope,$uibModalInstance,exception,global,User,$state){var self=this;self.global=global,$scope.$on("closeWitget",function(){$uibModalInstance.close()}),self.cancel=function(){$uibModalInstance.dismiss()}}function loginOnlyPhoneCtrl($scope,$uibModalInstance,exception,global,User,$state){var self=this;self.global=global,$scope.$on("closeWitget",function(){$uibModalInstance.close()}),self.cancel=function(){$uibModalInstance.dismiss()}}var Items=$resource("/api/collections/User/:_id",{_id:"@_id"});return this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,selectItem:selectItem,selectOrCreat:selectOrCreat,login:login,loginOnlyPhone:loginOnlyPhone,logout:logout,saveProfile:saveProfile,newUser:newUser,newUserByPhone:newUserByPhone,query:Items.query,getInfo:getInfo,createUser:createUser,changePswd:changePswd,getInfoBonus:getInfoBonus,changeEmail:changeEmail,changePhone:changePhone,checkEmailForExist:checkEmailForExist,checkPhoneForExist:checkPhoneForExist}}function accountFactory($http,$state,global){return{getProfile:function(){var store=global.get("store").val._id;return $http.get("/api/me/"+store)},getPermission:function(){var store=global.get("store").val._id;return $http.get("/api/permission/"+store)},getPermissionTranslator:function(){var store=global.get("store").val._id;return $http.get("/api/permissionTranslator/"+store)},getPermissionOrder:function(){var store=global.get("store").val._id;return $http.get("/api/permissionOrder/"+store)},getPermissionMaster:function(master){var store=global.get("store").val._id;return $http.get("/api/permissionMaster/"+store+"/"+master)},getEnterButton:function(user){var store=global.get("store").val._id;return user.frame=$state.get("frame")?$state.get("frame").url:null,user.store=store,$http.post("/api/getEnterButton",user)},updateProfile:function(profileData){var store=global.get("store").val._id;return profileData.store=store,$http.put(userHost+"/api/me",profileData)},unsubscription:function(){global.get("store").val._id;return $http.get("/api/unsubscription/"+global.get("user").val._id)}}}function subscibtionListService($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return error}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/SubscribtionList/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get}}function userEntryService($resource,$q){function getList(paginate,query){function getListComplete(response){return paginate.page||(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/UserEntry/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query}}function sendPhoneFactory($http,$q,$user){function sendCodeToPhone(phone){if(phone){var o={phone:phone};return $q.when().then(function(){return $http.post("/api/users/sendSMS",o)})}}function verifyCode(code,phone){var o={code:code,phone:phone};return $q.when().then(function(){return $http.post("/api/users/verifySMScode",o)})}function checkPhone(phone){return $q.when().then(function(){return $user.getItem(phone,"profile.phone")}).then(function(res){return res?res:null})}return{sendCodeToPhone:sendCodeToPhone,verifyCode:verifyCode,checkPhone:checkPhone}}angular.module("gmall.services").factory("Session",["$resource",function($resource){return $resource("/api/session/")}]).factory("User",function($resource){return $resource("/api/users/:id/:email",{id:"@id"},{update:{method:"PUT",params:{id:"profile",email:""}},updateCoupon:{method:"PUT",params:{id:"coupon",email:""}},updatePswd:{method:"PUT",params:{id:"changepswd",email:""}},resetPswd:{method:"POST",params:{id:"resetpswd",email:"@email"}},get:{method:"GET",params:{id:"me",email:""}},checkEmail:{method:"GET",params:{id:"checkemail"}},checkPhone:{method:"GET",params:{id:"checkphone"}},useCoupon:{method:"GET",params:{id:"useCoupon"}},cancelCoupon:{method:"GET",params:{id:"cancelCoupon"}},repeatMailForConfirm:{method:"GET",params:{id:"repeatMailForConfirm"}}})}).service("$user",userService).service("UserEntry",userEntryService).factory("Account",accountFactory).factory("sendPhoneFactory",sendPhoneFactory).service("SubscibtionList",subscibtionListService),userService.$inject=["$resource","$uibModal","$q","Session","User","global","exception","$state","$window","$rootScope","$http","$auth","Account"],accountFactory.$inject=["$http","$state","global"],subscibtionListService.$inject=["$resource"],userEntryService.$inject=["$resource","$q"],sendPhoneFactory.$inject=["$http","$q","$user"]}(),angular.module("gmall.controllers").controller("usersCtrl",["$scope","$rootScope","global","$anchorScroll","$user","$chat","$sce","$timeout","$http",function($scope,$rootScope,global,$anchorScroll,$user,$chat,$sce,$timeout,$http){$anchorScroll(),$scope.usersCtrl=this,$scope.usersCtrl.paginate={page:0,rows:20,totalItems:0},$scope.usersCtrl.query={};var query=null;$rootScope.$stateParams.user&&($scope.usersCtrl.query={_id:$rootScope.$stateParams.user}),$scope.usersCtrl.deleteUser=function(id){$user.delete({id:id},function(res){$scope.usersCtrl.getList($scope.usersCtrl.paginate.page,$scope.usersCtrl.paginate.rows)})},$scope.usersCtrl.getList=function(page,rows){global.get("user").val&&global.get("user").val._id&&$user.query({perPage:rows,page:page,query:$scope.usersCtrl.query},function(res){0==page&&res.length>0&&($scope.usersCtrl.paginate.totalItems=res.shift().index),0==res.length&&($scope.usersCtrl.paginate.totalItems=0),$scope.usersCtrl.users=res,$scope.usersCtrl.query={},query=null})},$scope.usersCtrl.getList($scope.usersCtrl.paginate.page,$scope.usersCtrl.paginate.rows)}]),function(){function userProfile(){return{restrict:"E",scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/user/userProfile.html"}}function itemCtrl(global,$user,exception,$timeout,$scope,$q){function changePswd(_){$q.when().then(function(){return $user.changePswd(self.user.val._id)}).then(function(){exception.showToaster("succes","статус","обновлено!")}).catch(function(err){err&&(err=err.data||err,exception.catcher("смена пароля")(err))})}function saveField(field){var o={_id:self.user.val._id},fieldFoDB="profile."+field;o[fieldFoDB]=self.user.val.profile[field],"cityId"==field&&(fieldFoDB+=" profile.city",o["profile.city"]=self.user.val.profile.city),self.Items.save({update:fieldFoDB},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function changeEmail(){$q.when().then(function(){return $user.changeEmail(global.get("user").val._id)}).then(function(res){console.log(res),global.get("user").val.email=res}).catch(function(err){err&&exception.catcher("change email")(err)})}var self=this;self.Items=$user,self.global=global,self.user=global.get("user"),self.changePswd=changePswd,self.changeEmail=changeEmail,self.saveField=saveField;var listener=$scope.$watch(function(){return self.user.val},function(n,o){n&&(listener(),n.profile||(n.profile={}),n.profile.cityId||(n.profile.cityId=null),n.profile.phone||(n.profile.phone=""),$scope.$watch(function(){return self.user.val.profile.cityId},function(n,o){n!=o&&saveField("cityId")}),$scope.$watch(function(){return self.user.val.profile.phone},function(n,o){n!=o&&$q.when().then(function(){return console.log(self.user.val.profile.phone),self.user.val.profile.phone?$user.getItem(self.user.val.profile.phone,"profile.phone"):null}).then(function(res){console.log(res),console.log(!res||res&&!res._id||res&&res._id&&res._id==self.user.val._id),!res||res&&!res._id||res&&res._id&&res._id==self.user.val._id?saveField("phone"):(self.phoneExist=!0,$timeout(function(){self.phoneExist=!1},5e3))})}))})}angular.module("gmall.directives").directive("userCard",function(){return{restrict:"E",scope:{deleteUserFunction:"&",user:"="},templateUrl:"/components/user/user.html",link:function(scope){scope.moment=moment,scope.deleteUser=function(id){scope.deleteUserFunction({id:id})}}}}).directive("userProfile",userProfile),itemCtrl.$inject=["global","$user","exception","$timeout","$scope","$q"]}(),function(){function itemService($resource,$uibModal,$q,global,exception,$state){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Comment/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("Comment",itemService),itemService.$inject=["$resource","$uibModal","$q","global","exception","$state"]}(),function(){function itemDirective(){return{rescrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/comment/commentsList.html"}}function itemCtrl($q,global,$state,Comment,exception,SubscibtionList,Confirm,$uibModal,$http,socket,$timeout){function activate(){return self.participant=global.get("seller").val?"seller":"user","seller"==self.participant&&socket.on("newNotification",function(data){console.log("newNotification",data),data&&"comment"==data.type&&getList(0)}),getList().then(function(){console.log("Activated list View")})}function getList(page){return"undefined"!==page&&(self.paginate,page=page),self.Items.getList(self.paginate,self.query).then(function(data){return data.forEach(function(el){el.stuff&&el.stuff.gallery&&el.stuff.gallery.sort&&el.stuff.gallery.sort(function(a,b){return a.index-b.index})}),self.items=data,self.items})}function saveField(item,field){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),console.log("saved")},function(err){console.log(err)})}function deleteItem(item){Confirm("Удалить??").then(function(){return Comment.delete({_id:item._id}).$promise}).then(function(){getList()}).catch(function(err){err=err.data||err,exception.catcher("Удаление")(err)}),console.log(item)}var self=this;self.Items=Comment,self.$state=$state,self.moment=moment,self.query={},self.paginate={page:0,rows:100,totalItems:0},self.store=global.get("store").val._id,self.getList=getList,self.deleteItem=deleteItem,self.saveField=saveField,activate(),socket.on("newComment",function(data){console.log(data),self.paginate.page=0,activate()})}angular.module("gmall.directives").directive("commentList",itemDirective),itemCtrl.$inject=["$q","global","$state","Comment","exception","SubscibtionList","Confirm","$uibModal","$http","socket","$timeout"]}(),angular.module("gmall.directives").directive("storeSetting",function(){function storeCtrl($q,Store,global,Seller,FilterTags,exception,Config,Template,$uibModal,$http,$scope,ConfigData,$timeout,Confirm,Master,$user){function clearCache(){$q.when().then(function(){return $http.get("/api/resetStoreCashe/"+global.get("store").val._id)}).then(function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)}).catch(function(err){exception.catcher("cброс кеша")(err)})}function savePhoneForSale(){console.log(self.item.seller.phone),self.saveFieldSeller("phone")}function changeMaster(){console.log(self.selectedMaster)}function changeMonth(month){self.selectedMonth=month,self.monthDayDelta=getMonthDayDelta(),self.currentMonthDays=getDaysInMonth()}function getMonthDayDelta(){return 1==self.selectedMonth?31:2==self.selectedMonth?60:3==self.selectedMonth?91:4==self.selectedMonth?121:5==self.selectedMonth?152:6==self.selectedMonth?182:7==self.selectedMonth?213:8==self.selectedMonth?244:9==self.selectedMonth?274:10==self.selectedMonth?305:11==self.selectedMonth?335:0}function getMonthDayDeltaByIdx(idx){return 1==idx?31:2==idx?60:3==idx?91:4==idx?121:5==idx?152:6==idx?182:7==idx?213:8==idx?244:9==idx?274:10==idx?305:11==idx?335:0}function getDayOfWeek(day){var d=new Date(year,self.selectedMonth,day),weekday=new Array(7);return weekday[0]="Воскресенье",weekday[1]="Понедельник",weekday[2]="Вторник",weekday[3]="Среда",weekday[4]="Четверг",weekday[5]="Пятница",weekday[6]="Суббота",weekday[d.getDay()]}function getDaysInMonth(){var x=self.selectedMonth+1;return function(x,y){return 28+(x+Math.floor(x/8))%2+2%x+Math.floor((1+(y%100+2)%(y%100+1)*(1-(y%4+2)%(y%4+1))+(1-(y%400+2)%(y%400+1)))/x)+Math.floor(1/x)-Math.floor(((y%100+2)%(y%100+1)*(1-(y%4+2)%(y%4+1))+(1-(y%400+2)%(y%400+1)))/x)}(x,year)}function saveMasterSchedule(){if(self.selectedMaster){var o={_id:self.selectedMaster._id,timeTable:self.selectedMaster.timeTable};Master.save({update:"timeTable"},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}}function setConfigData(lang){self.configData=self.configDatas.reduce(function(o,item){return item.lang==lang&&(o[item.type]=item.data),o},{})}function saveFieldTemplate(field,value){var o={_id:global.get("store").val._id};o[field]=value,console.log(o),Store.save({update:field},o,function(err){exception.showToaster("info","обновлено")})}function saveField(field){var o={_id:global.get("store").val._id};if("currencyArr"==field){var i=0;if(self.currencyList=self.item.currencyArr.map(function(c){return{name:c,index:i++}}),self.item[field]&&self.item[field].length){try{var currencyArrOld=Object.keys(self.item.currency).filter(function(el){return el})}catch(err){var currencyArrOld=[];self.item.currency=[]}
if(self.item[field].length<currencyArrOld.length){var diff=currencyArrOld.filter(function(x){return self.item.currencyArr.indexOf(x)<0});delete self.item.currency[diff[0]];for(var i=0,l=self.item.currency.length;i<l;i++)if(self.item.currency[i][Object.keys(self.item.currency[i])[0]]==diff[0]){self.item.currency.splice(i,1);break}diff[0]==self.item.mainCurrency&&(self.item.mainCurrency=Object.keys(self.item.currency)[0],self.item.currency[self.item.mainCurrency][0]=1)}else{var diff=self.item.currencyArr.filter(function(x){return currencyArrOld.indexOf(x)<0});self.item.currency[diff[0]]=[1,diff[0],"",[],0,2]}}else self.item[field]=["UAH"],self.item.currency={UAH:[1,"UAH","грн.",[],0,2]},self.item.mainCurrency="UAH";self.item.mainCurrency||(self.item.mainCurrency="UAH"),field+=" mainCurrency currency",o.mainCurrency=self.item.mainCurrency,self.item.currency||(self.item.currency={UAH:[1,"UAH","грн.",[],0,2]}),o.currency=self.item.currency,o.currencyArr=self.item.currencyArr}else if("mainCurrency"==field)self.item.currency[self.item.mainCurrency][0]=1,field+=" currency",o.currency=self.item.currency,o.mainCurrency=self.item.mainCurrency;else if("owner"==field)o[field]=self.item[field].map(function(item){return item._id});else{var fields=field.split(" ");fields.forEach(function(f){o[f]=self.item[f]})}Store.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){if("unitOfMeasure"==fields){console.log("in thems");var oo={_id:global.get("store").val._id,unitOfMeasureL:{}};Store.save({update:"unitOfMeasureL"},oo,function(){Store.get({_id:global.get("store").val._id,clone:"clone"}),Store.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})})}})}function selectTag(field){$q.when().then(function(){return FilterTags.selectFilterTag()}).then(function(tag){self.item[field]=tag;var o={_id:global.get("store").val._id};return o[field]=self.item[field].url,Store.save({update:field},o).$promise}).catch(function(err){"cancel"!=err&&exception.catcher("выбор группы")(err)})}function deleteTag(field){$q.when().then(function(){self.item[field]=null;var o={_id:global.get("store").val._id};return o[field]=self.item[field],Store.save({update:field},o).$promise}).catch(function(err){"cancel"!=err&&exception.catcher("сброс группы")(err)})}function changePhoneCodes(){self.item.phoneCodes&&self.item.phoneCodes.length?self.saveField("phoneCodes"):(self.item.phoneCodes=[self.config.phoneCodes[0]],self.item.phoneCode=self.config.phoneCodes[0])}function onSelected(){setTimeout(function(){$(":focus").blur()},50)}function bonusFormAdditionFields(){self.item.bonusForm||(self.item.bonusForm={}),self.item.bonusForm.fields||(self.item.bonusForm.fields=[{name:"Ближайший магазин",type:"select",values:["n2 ffdf","dd 444","jjdjdjd"]},{name:"Пол",type:"radio",values:["men","femail"]}]),$uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/setFieldsForBonusForm.html",controller:setFieldsForBonusFormCtrl,controllerAs:"$ctrl",size:"lg",resolve:{fields:function(){return self.item.bonusForm.fields}}}).result.then(function(){self.item.bonusForm.fields=self.item.bonusForm.fields.filter(function(e){return e}),self.saveField("bonusForm")},function(){})}function setFieldsForBonusFormCtrl($uibModalInstance,exception,global,$q,fields){function addField(){self.fields.push(self.newField),self.newField={type:"text",name:"название поля",values:[]}}var self=this;self.fields=fields,self.addField=addField,self.newField={type:"text",name:"название поля",values:[]},self.ok=function(){console.log(fields),$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}}function addRedirects(){self.item.redirects.push({from:"",to:""}),saveField("redirects")}function deleteRedirects(i){self.item.redirects.splice(i,1),saveField("redirects")}function saveTemplate(){$q.when().then(function(){return $http.post("/api/setTemplate",{template:self.item.template,store:self.item._id})}).then(function(res){exception.showToaster("success","статус","обновлено")}).catch(function(err){exception.catcher("выгрузка шаблона")(err)})}function changeTemplate(file){function getPromiseForSave(field,value){var field="template."+field,o={_id:self.item._id};return o[field]=value,Store.save({update:field},o)}console.log(file),Confirm("Обновить?").then(function(){return $http.get("/views/templates/"+file)}).then(function(res){console.log(res.data),console.log();var acts=[];for(var f in res.data)acts.push(getPromiseForSave(f,res.data[f]));return $q.all(acts)}).then(function(){exception.showToaster("success","статус","обновлено")}).catch(function(err){exception.catcher("загрузка шаблона")(err)})}function setRowsForStuffList(list){list.rows||(list.rows=4)}function changeCurrencyOrder(){self.item.currencyArr=self.currencyList.map(function(c){return c.name}),self.saveField("currencyArr")}function checkTest(item){console.log(item)}function deleteOwner(i){Confirm("Убрать админа?").then(function(){i?(self.item.owner.splice(i,1),self.saveField("owner")):exception.showToaster("error","запрет","нельзя удалить владельца")})}function getOwner(){if(self.item.owner&&self.item.owner.length){var q={$and:[{store:self.item._id},{_id:{$in:self.item.owner}}]};$q.when().then(function(){return $user.getList({page:0,rows:50},q)}).then(function(res){res&&res.length&&(self.item.owner=self.item.owner.map(function(user){for(var i=0;i<res.length;i++)if(res[i]._id==user)return res[i];return null}).filter(function(item){return item})),self.item.showOwner=!0})}else self.item.showOwner=!0}function addOwner(){$user.selectItem({store:self.item._id}).then(function(user){if(self.item.owner||(self.item.owner=[]),!self.item.owner.some(function(e){return e._id==user._id})&&(self.item.owner.push({_id:user._id,name:user.name,email:user.email}),self.saveField("owner"),!self.item.seller.user)){var o={_id:self.item.seller._id};o.user=user._id,o.name=user.name,Seller.save({update:"user name"},o)}})}function deleteTranslater(i){Confirm("Убрать переводчика?").then(function(){self.item.еranslaters.splice(i,1),self.saveField("translaters")})}function getTranslaters(){if(self.item.translaters&&self.item.translaters.length){var q={$and:[{store:self.item._id},{_id:{$in:self.item.translaters}}]};$q.when().then(function(){return $user.getList({page:0,rows:50},q)}).then(function(res){res&&res.length&&(self.item.translaters=self.item.translaters.map(function(user){for(var i=0;i<res.length;i++)if(res[i]._id==user)return res[i];return null}).filter(function(item){return item})),self.item.showTranslaters=!0})}else self.item.showTranslaters=!0}function addTranslater(){$user.selectItem({store:self.item._id}).then(function(user){self.item.translaters||(self.item.translaters=[]),self.item.translaters.some(function(e){return e._id==user._id})||(self.item.translaters.push({_id:user._id,name:user.name,email:user.email}),self.saveField("translaters"))})}function syncWithStore(){self.currentMonthDays&&self.selectedMaster.timeTable.forEach(function(item,i){if(i>=self.monthDayDelta&&i<self.monthDayDelta+self.currentMonthDays){var day=i-self.monthDayDelta+1,d=new Date(year,self.selectedMonth,day);try{var n=d.getDay();self.item.timeTable&&self.item.timeTable[n]&&(item.s=self.item.timeTable[n].start,item.e=self.item.timeTable[n].end,item.is=self.item.timeTable[n].is)}catch(err){console.log(err)}}})}function syncWithMonth(idx){if(self.currentMonthDays){var j,k=1;try{for(;1!=j&&k<31;){var d=new Date(year,idx,k);j=d.getDay(),console.log(j,k,d.toString()),k++}var weekData=[];if(1==j)for(var d=getMonthDayDeltaByIdx(idx)+k-1,l=0;l<7;l++){weekData[l]={},weekData[l].s=32,weekData[l].e=60,weekData[l].is=!0;var tItem=self.selectedMaster.timeTable[d+l-1];tItem&&(weekData[l].s=tItem.s,weekData[l].e=tItem.e,weekData[l].is=tItem.is)}var f=weekData.pop();weekData.unshift(f)}catch(err){console.log(err)}self.selectedMaster.timeTable.forEach(function(item,i){if(i>=self.monthDayDelta&&i<self.monthDayDelta+self.currentMonthDays){var day=i-self.monthDayDelta+1,d=new Date(year,self.selectedMonth,day);try{var n=d.getDay();weekData&&weekData[n]&&(item.s=weekData[n].s,item.e=weekData[n].e,item.is=weekData[n].is)}catch(err){console.log(err)}}})}}var self=this;self.Items=Store,self.item={},self.item.timeTable=[{start:8,end:18},{start:8,end:18},{start:8,end:18},{start:8,end:18},{start:8,end:18},{start:8,end:18},{start:8,end:18}],self.lang=global.get("store").val.lang,self.cacheTime=[{name:"1 hour",val:3600},{name:"12 hours",val:43200},{name:"1 day",val:86400},{name:"7 days",val:604800},{name:"30 days",val:2592e3}],self.yearTable=[];for(var ii=0;ii<=365;ii++)self.yearTable.push({is:!0,s:10,e:18});self.months=["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],self.selectedMonth=0,self.selectTag=selectTag,self.deleteTag=deleteTag,self.addRedirects=addRedirects,self.deleteRedirects=deleteRedirects,self.global=global,self.animationTypes=animationTypes,self.onSelected=onSelected,self.bonusFormAdditionFields=bonusFormAdditionFields;var filtertTags=[];self.checkTest=checkTest,self.saveField=saveField,self.changePhoneCodes=changePhoneCodes,self.saveFieldTemplate=saveFieldTemplate,self.saveTemplate=saveTemplate,self.changeTemplate=changeTemplate,self.clearCache=clearCache,self.setRowsForStuffList=setRowsForStuffList,self.changeCurrencyOrder=changeCurrencyOrder,self.savePhoneForSale=savePhoneForSale,self.deleteOwner=deleteOwner,self.getOwner=getOwner,self.addOwner=addOwner,self.deleteTranslater=deleteTranslater,self.getTranslaters=getTranslaters,self.addTranslater=addTranslater,self.syncWithStore=syncWithStore,self.syncWithMonth=syncWithMonth,self.weekDays=weekDays,self.sliderOptions={floor:0,ceil:24,step:1,onEnd:function(){saveField("timeTable")}},self.sliderOptionsForMsster={floor:0,ceil:24,step:1},self.changeMaster=changeMaster,self.changeMonth=changeMonth,self.getDayOfWeek=getDayOfWeek,self.saveMasterSchedule=saveMasterSchedule;var today=new Date,year=today.getFullYear();self.list=[];for(var i=1;i<=3;++i)self.list.push({label:"Item A"+i});self.formatAverage=["не округлять","до десятков копеек","до целых","до десятков целых","сотен целых"],function(){var today=new Date;self.selectedMonth=today.getMonth(),$q.when().then(function(){return $http.get("/api/getTemplates")}).then(function(res){self.templates=res.data}).then(function(){return Master.getList()}).then(function(items){items.forEach(function(item){item.timeTable&&item.timeTable.length&&366==item.timeTable.length||(item.timeTable=angular.copy(self.yearTable))}),self.masters=items}).then(function(){return Config.getList()}).then(function(res){return console.log(res),self.config=res[0],self.config.phoneCodes=phoneCodes,console.log(self.config.currency,self.config.unitOfMeasure),self.config.langs=languagesOfPlatform,Store.get({_id:global.get("store").val._id}).$promise}).then(function(res){res.domain||(res.domain=res.subDomain+".gmall.io"),res.lang||(res.lang="ru"),res.langArr||(res.langArr=["ru"]),res.timeTable||(res.timeTable=[{},{},{},{},{},{},{}]),res.timeTable.forEach(function(item,i){res.timeTable[i]||(res.timeTable[i]={}),res.timeTable[i].start||0==res.timeTable[i].start||(res.timeTable[i].start=8),res.timeTable[i].end||0==res.timeTable[i].end||(res.timeTable[i].end=18)});var r=res;r.texts||(r.texts={}),r.texts.subscriptionName||(r.texts.suscriptionName={}),r.texts.subscriptionText||(r.texts.suscriptionText={}),r.texts.callName||(r.texts.callName={}),r.texts.callText||(r.texts.callText={}),r.texts.feedbackName||(r.texts.feedbackName={}),r.texts.feedbackText||(r.texts.feedbackText={}),r.texts.emailName||(r.texts.emailName={}),r.texts.emailText||(r.texts.emailText={}),r.texts.confirmemail||(r.texts.confirmemail={}),r.texts.mailTextRepeat||(r.texts.mailTextRepeat={}),r.texts.orderMailText||(r.texts.orderMailText={}),r.texts.buttonAuth||(r.texts.buttonAuth={}),r.texts.auth||(r.texts.auth={}),r.texts.pswd||(r.texts.pswd={}),r.texts.unsubscribeName||(r.texts.unsubscribeName={}),r.texts.unsubscribeText||(r.texts.unsubscribeText={}),r.texts.dateTimeText||(r.texts.dateTimeText={}),r.texts.masterName||(r.texts.masterName={}),r.texts.notOrdersText||(r.texts.notOrdersText={}),r.texts.notDateTimeText||(r.texts.notDateTimeText={}),r.payData||(r.payData={}),r.payData.liqPay||(r.payData.liqPay={}),r.payData.pv24||(r.payData.pv24={});for(var key in res)"_id"!=key&&(self.item[key]=res[key]);var i=0;if(self.item.currency)for(var key in self.item.currency)self.item.currency[key][3]||(self.item.currency[key][3]=[]),void 0===self.item.currency[key][4]&&(self.item.currency[key][4]=0),void 0===self.item.currency[key][5]&&(self.item.currency[key][5]=2);return self.currencyList=self.item.currencyArr.map(function(c){return{name:c,index:i++}}),self.item.phoneCodes&&self.item.phoneCodes.length||(self.item.phoneCodes=[self.config.phoneCodes[0]],self.item.phoneCode=self.config.phoneCodes[0],self.saveField("phoneCodes phoneCode")),self.item.redirects||(self.item.redirects=[]),self.item.turbosms||(self.item.turbosms={}),self.item.alphasms||(self.item.alphasms={}),$timeout(function(){self.item._id=res._id},100),FilterTags.getFilterTags()}).then(function(res){filtertTags=res,self.item.saleTag=filtertTags.getOFA("url",self.item.saleTag),self.item.newTag=filtertTags.getOFA("url",self.item.newTag)}).then(function(){return ConfigData.getList(null)}).then(function(res){console.log(res),self.configDatas=res,setConfigData(global.get("store").val.lang)}).catch(function(err){exception.catcher("получение данных")(err)})}(),$scope.$on("changeLang",function(){setConfigData(global.get("store").val.lang),self.lang=global.get("store").val.lang,self.item.name=self.item.nameL[self.lang]?self.item.nameL[self.lang]:""}),self.saveFieldSeller=function(field){var o={_id:self.item.seller._id};"archImages"==field?self.item.seller[field]=self.item.seller[field].substring(0,300):"oayInfo"==field?self.item.seller[field]=self.item.seller[field].substring(0,3e3):"saleMail"==field&&(self.item.seller[field]=self.item.seller[field].substring(0,100)),o[field]=self.item.seller[field],Seller.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},setFieldsForBonusFormCtrl.$inject=["$uibModalInstance","exception","global","$q","fields"],self.countriesList=[{name:"AllOther",code:"ALLOTHER"},{name:"Afghanistan",code:"AF"},{name:"Åland Islands",code:"AX"},{name:"Albania",code:"AL"},{name:"Algeria",code:"DZ"},{name:"American Samoa",code:"AS"},{name:"AndorrA",code:"AD"},{name:"Angola",code:"AO"},{name:"Anguilla",code:"AI"},{name:"Antarctica",code:"AQ"},{name:"Antigua and Barbuda",code:"AG"},{name:"Argentina",code:"AR"},{name:"Armenia",code:"AM"},{name:"Aruba",code:"AW"},{name:"Australia",code:"AU"},{name:"Austria",code:"AT"},{name:"Azerbaijan",code:"AZ"},{name:"Bahamas",code:"BS"},{name:"Bahrain",code:"BH"},{name:"Bangladesh",code:"BD"},{name:"Barbados",code:"BB"},{name:"Belarus",code:"BY"},{name:"Belgium",code:"BE"},{name:"Belize",code:"BZ"},{name:"Benin",code:"BJ"},{name:"Bermuda",code:"BM"},{name:"Bhutan",code:"BT"},{name:"Bolivia",code:"BO"},{name:"Bosnia and Herzegovina",code:"BA"},{name:"Botswana",code:"BW"},{name:"Bouvet Island",code:"BV"},{name:"Brazil",code:"BR"},{name:"British Indian Ocean Territory",code:"IO"},{name:"Brunei Darussalam",code:"BN"},{name:"Bulgaria",code:"BG"},{name:"Burkina Faso",code:"BF"},{name:"Burundi",code:"BI"},{name:"Cambodia",code:"KH"},{name:"Cameroon",code:"CM"},{name:"Canada",code:"CA"},{name:"Cape Verde",code:"CV"},{name:"Cayman Islands",code:"KY"},{name:"Central African Republic",code:"CF"},{name:"Chad",code:"TD"},{name:"Chile",code:"CL"},{name:"China",code:"CN"},{name:"Christmas Island",code:"CX"},{name:"Cocos (Keeling) Islands",code:"CC"},{name:"Colombia",code:"CO"},{name:"Comoros",code:"KM"},{name:"Congo",code:"CG"},{name:"Congo, The Democratic Republic of the",code:"CD"},{name:"Cook Islands",code:"CK"},{name:"Costa Rica",code:"CR"},{name:"Cote D'Ivoire",code:"CI"},{name:"Croatia",code:"HR"},{name:"Cuba",code:"CU"},{name:"Cyprus",code:"CY"},{name:"Czech Republic",code:"CZ"},{name:"Denmark",code:"DK"},{name:"Djibouti",code:"DJ"},{name:"Dominica",code:"DM"},{name:"Dominican Republic",code:"DO"},{name:"Ecuador",code:"EC"},{name:"Egypt",code:"EG"},{name:"El Salvador",code:"SV"},{name:"Equatorial Guinea",code:"GQ"},{name:"Eritrea",code:"ER"},{name:"Estonia",code:"EE"},{name:"Ethiopia",code:"ET"},{name:"Falkland Islands (Malvinas)",code:"FK"},{name:"Faroe Islands",code:"FO"},{name:"Fiji",code:"FJ"},{name:"Finland",code:"FI"},{name:"France",code:"FR"},{name:"French Guiana",code:"GF"},{name:"French Polynesia",code:"PF"},{name:"French Southern Territories",code:"TF"},{name:"Gabon",code:"GA"},{name:"Gambia",code:"GM"},{name:"Georgia",code:"GE"},{name:"Germany",code:"DE"},{name:"Ghana",code:"GH"},{name:"Gibraltar",code:"GI"},{name:"Greece",code:"GR"},{name:"Greenland",code:"GL"},{name:"Grenada",code:"GD"},{name:"Guadeloupe",code:"GP"},{name:"Guam",code:"GU"},{name:"Guatemala",code:"GT"},{name:"Guernsey",code:"GG"},{name:"Guinea",code:"GN"},{name:"Guinea-Bissau",code:"GW"},{name:"Guyana",code:"GY"},{name:"Haiti",code:"HT"},{name:"Heard Island and Mcdonald Islands",code:"HM"},{name:"Holy See (Vatican City State)",code:"VA"},{name:"Honduras",code:"HN"},{name:"Hong Kong",code:"HK"},{name:"Hungary",code:"HU"},{name:"Iceland",code:"IS"},{name:"India",code:"IN"},{name:"Indonesia",code:"ID"},{name:"Iran, Islamic Republic Of",code:"IR"},{name:"Iraq",code:"IQ"},{name:"Ireland",code:"IE"},{name:"Isle of Man",code:"IM"},{name:"Israel",code:"IL"},{name:"Italy",code:"IT"},{name:"Jamaica",code:"JM"},{name:"Japan",code:"JP"},{name:"Jersey",code:"JE"},{name:"Jordan",code:"JO"},{name:"Kazakhstan",code:"KZ"},{name:"Kenya",code:"KE"},{name:"Kiribati",code:"KI"},{name:"Korea, Democratic People'S Republic of",code:"KP"},{name:"Korea, Republic of",code:"KR"},{name:"Kuwait",code:"KW"},{name:"Kyrgyzstan",code:"KG"},{name:"Lao People'S Democratic Republic",code:"LA"},{name:"Latvia",code:"LV"},{name:"Lebanon",code:"LB"},{name:"Lesotho",code:"LS"},{name:"Liberia",code:"LR"},{name:"Libyan Arab Jamahiriya",code:"LY"},{name:"Liechtenstein",code:"LI"},{name:"Lithuania",code:"LT"},{name:"Luxembourg",code:"LU"},{name:"Macao",code:"MO"},{name:"Macedonia, The Former Yugoslav Republic of",code:"MK"},{name:"Madagascar",code:"MG"},{name:"Malawi",code:"MW"},{name:"Malaysia",code:"MY"},{name:"Maldives",code:"MV"},{name:"Mali",code:"ML"},{name:"Malta",code:"MT"},{name:"Marshall Islands",code:"MH"},{name:"Martinique",code:"MQ"},{name:"Mauritania",code:"MR"},{name:"Mauritius",code:"MU"},{name:"Mayotte",code:"YT"},{name:"Mexico",code:"MX"},{name:"Micronesia, Federated States of",code:"FM"},{name:"Moldova, Republic of",code:"MD"},{name:"Monaco",code:"MC"},{name:"Mongolia",code:"MN"},{name:"Montserrat",code:"MS"},{name:"Morocco",code:"MA"},{name:"Mozambique",code:"MZ"},{name:"Myanmar",code:"MM"},{name:"Namibia",code:"NA"},{name:"Nauru",code:"NR"},{name:"Nepal",code:"NP"},{name:"Netherlands",code:"NL"},{name:"Netherlands Antilles",code:"AN"},{name:"New Caledonia",code:"NC"},{name:"New Zealand",code:"NZ"},{name:"Nicaragua",code:"NI"},{name:"Niger",code:"NE"},{name:"Nigeria",code:"NG"},{name:"Niue",code:"NU"},{name:"Norfolk Island",code:"NF"},{name:"Northern Mariana Islands",code:"MP"},{name:"Norway",code:"NO"},{name:"Oman",code:"OM"},{name:"Pakistan",code:"PK"},{name:"Palau",code:"PW"},{name:"Palestinian Territory, Occupied",code:"PS"},{name:"Panama",code:"PA"},{name:"Papua New Guinea",code:"PG"},{name:"Paraguay",code:"PY"},{name:"Peru",code:"PE"},{name:"Philippines",code:"PH"},{name:"Pitcairn",code:"PN"},{name:"Poland",code:"PL"},{name:"Portugal",code:"PT"},{name:"Puerto Rico",code:"PR"},{name:"Qatar",code:"QA"},{name:"Reunion",code:"RE"},{name:"Romania",code:"RO"},{name:"Russian Federation",code:"RU"},{name:"RWANDA",code:"RW"},{name:"Saint Helena",code:"SH"},{name:"Saint Kitts and Nevis",code:"KN"},{name:"Saint Lucia",code:"LC"},{name:"Saint Pierre and Miquelon",code:"PM"},{name:"Saint Vincent and the Grenadines",code:"VC"},{name:"Samoa",code:"WS"},{name:"San Marino",code:"SM"},{name:"Sao Tome and Principe",code:"ST"},{name:"Saudi Arabia",code:"SA"},{name:"Senegal",code:"SN"},{name:"Serbia and Montenegro",code:"CS"},{name:"Seychelles",code:"SC"},{name:"Sierra Leone",code:"SL"},{name:"Singapore",code:"SG"},{name:"Slovakia",code:"SK"},{name:"Slovenia",code:"SI"},{name:"Solomon Islands",code:"SB"},{name:"Somalia",code:"SO"},{name:"South Africa",code:"ZA"},{name:"South Georgia and the South Sandwich Islands",code:"GS"},{name:"Spain",code:"ES"},{name:"Sri Lanka",code:"LK"},{name:"Sudan",code:"SD"},{name:"Suriname",code:"SR"},{name:"Svalbard and Jan Mayen",code:"SJ"},{name:"Swaziland",code:"SZ"},{name:"Sweden",code:"SE"},{name:"Switzerland",code:"CH"},{name:"Syrian Arab Republic",code:"SY"},{name:"Taiwan, Province of China",code:"TW"},{name:"Tajikistan",code:"TJ"},{name:"Tanzania, United Republic of",code:"TZ"},{name:"Thailand",code:"TH"},{name:"Timor-Leste",code:"TL"},{name:"Togo",code:"TG"},{name:"Tokelau",code:"TK"},{name:"Tonga",code:"TO"},{name:"Trinidad and Tobago",code:"TT"},{name:"Tunisia",code:"TN"},{name:"Turkey",code:"TR"},{name:"Turkmenistan",code:"TM"},{name:"Turks and Caicos Islands",code:"TC"},{name:"Tuvalu",code:"TV"},{name:"Uganda",code:"UG"},{name:"Ukraine",code:"UA"},{name:"United Arab Emirates",code:"AE"},{name:"United Kingdom",code:"GB"},{name:"United States",code:"US"},{name:"United States Minor Outlying Islands",code:"UM"},{name:"Uruguay",code:"UY"},{name:"Uzbekistan",code:"UZ"},{name:"Vanuatu",code:"VU"},{name:"Venezuela",code:"VE"},{name:"Viet Nam",code:"VN"},{name:"Virgin Islands, British",code:"VG"},{name:"Virgin Islands, U.S.",code:"VI"},{name:"Wallis and Futuna",code:"WF"},{name:"Western Sahara",code:"EH"},{name:"Yemen",code:"YE"},{name:"Zambia",code:"ZM"},{name:"Zimbabwe",code:"ZW"}]}return storeCtrl.$inject=["$q","Store","global","Seller","FilterTags","exception","Config","Template","$uibModal","$http","$scope","ConfigData","$timeout","Confirm","Master","$user"],{scope:{},bindToController:!0,controller:storeCtrl,controllerAs:"$ctrl",templateUrl:"components/storeSetting/storeSetting.html"}}).directive("storesList",function(){function storeListCtrl($q,$state,Store,global,Seller,exception,Config,Template,$user,$http,Confirm,Photo,$timeout,siteName){function activate(){$q.when().then(function(){return Template.getList()}).then(function(res){self.templates=res}).then(function(){return Config.getList()}).then(function(res){return self.config=res[0],Store.getList(self.paginate,self.query)}).then(function(data){return data.forEach(function(s){s.date=moment(s.date).format("LLL")}),self.items=data,self.items}).then(function(){var url=storeHost?"http://"+storeHost+"/api/getSubDomains":"/api/getSubDomains";return $http.get(url)}).then(function(res){self.subDomains=res.data,console.log("self.subDomains",self.subDomains)}).catch(function(err){console.log(err),exception.catcher("получение данных")(err)})}function getList(){return $q.when().then(function(){return Store.getList(self.paginate,self.query)}).then(function(data){return data.forEach(function(s){s.date=moment(s.date).format("LLL")}),self.items=data,self.items})}function saveField(item,field,exist){exist&&exception.catcher("выбор домена")("занят");var o={_id:item._id};if(o[field]=angular.copy(item[field]),"owner"==field&&(o[field]=o[field].map(function(e){return e._id})),"template"==field){console.log("template");var ooo=self.templates.getOFA("_id",item[field]);o[field]=ooo}Store.save({update:field},o,function(){global.set("saving",!0),console.log(global.get("saving")),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){$q.when().then(function(){return siteName.choiceName()}).then(function(subDomain){var store={subDomain:subDomain};return store.name=subDomain,store.storeType="in-work",store.currencyArr=["UAH"],store.mainCurrency="UAH",store.currency={UAH:[1,"UAH","грн."]},Store.save(store).$promise}).then(function(){return Store.getList(self.paginate,self.query)}).then(function(data){return self.items=data,self.items}).catch(function(err){err&&exception.catcher("создание магазина")(err)})}function deleteOwner(item,i){item.owner.splice(i,1),self.saveField(item,"owner")}function getOwner(item){if(item.showOwner=!0,item.owner&&item.owner.length){var q={$and:[{store:item._id},{_id:{$in:item.owner}}]};$q.when().then(function(){return $user.getList({page:0,rows:50},q)}).then(function(res){item.owner=res})}}function addOwner(item){$user.selectItem({store:item._id}).then(function(user){if(item.owner||(item.owner=[]),!item.owner.some(function(e){return e._id==user._id})&&(item.owner.push({_id:user._id,name:user.name,email:user.email}),self.saveField(item,"owner"),!item.seller.user)){var o={_id:item.seller._id};o.user=user._id,o.name=user.name,Seller.save({update:"user name"},o)}})}function cloneStore(item){return $q.when().then(function(){return Store.upload(item)}).then(function(){exception.showToaster("success","статус","выгрузка Store завершена")}).then(function(){var url=stuffHost?"http://"+stuffHost+"/api/uploadStore/"+item._id:"/api/uploadStore/"+item._id;return $http.get(url)}).then(function(){exception.showToaster("success","статус","выгрузка models завершена")}).catch(function(err){err&&exception.catcher("выгрузка магазина")(err)})}function readStore(item,readStore){readStore&&Confirm("подтверждаете?").then(function(){return $http.get("/api/readStoreStuff/"+item._id+"?subDomain="+readStore)}).then(function(){exception.showToaster("success","статус","чтение models завершено")}).then(function(){var url=storeHost?"http://"+storeHost+"/api/readStoreStore/"+item._id+"?subDomain="+readStore:"/api/readStoreStore/"+item._id+"?subDomain="+readStore;return $http.get(url)}).then(function(){exception.showToaster("success","статус","чтение Store завершено")}).then(function(){self.subDomain=""}).catch(function(err){err&&exception.catcher("загрузка магазина")(err)})}function deleteStore(item){item.subDomain;return void Confirm("удалить?").then(function(){Confirm("удалить "+item.subDomain+"???").then(function(){var url="http://"+stuffHost+"/api/deleteStore/"+item._id;return $http.get(url)}).then(function(){var url=socketHost+"/api/deleteStore/"+item._id;return $http.get(url)}).then(function(){var url="http://"+orderHost+"/api/deleteStore/"+item._id;return $http.get(url)}).then(function(){var url="http://"+userHost+"/api/deleteStore/"+item._id;return $http.get(url)}).then(function(){var url="http://"+storeHost+"/api/deleteStore/"+item._id;return $http.get(url)}).then(function(){var folder="images/"+(item.subDomain?item.subDomain:item._id);return Photo.deleteFolder("Store",folder)}).then(function(res){exception.showToaster("info","status","good")}).then(function(){return self.paginate.items--,self.paginate.page&&self.paginate.page--,getList()}).catch(function(err){err&&exception.catcher("удаление магазина")(err)})})}function readStoreUnable(item){item.readStore=!0,$timeout(function(){item.readStore=!1},15e3)}function changeType(type){self.paginate.page=0,type?self.query.storeType=type:delete self.query.storeType,delete self.query.$or,getList()}function searchItem(str){str=str.substring(0,15),console.log(str),self.paginate.page=0,delete self.query.storeType,str?self.query.$or=[{name:str},{subDomain:str}]:delete self.query.$or,getList()}function changeSubDomain(item){$q.when().then(function(){return siteName.choiceName()}).then(function(name){item.subDomain=name.toLowerCase(),saveField(item,"subDomain")})}function changeDomain(item){$q.when().then(function(){var data={windowName:"Введите название домена",field:"domain"};return siteName.choiceName(data)}).then(function(name){item.domain=name.toLowerCase(),saveField(item,"domain")})}function clearDomain(item){Confirm("Очистить значение поля домен?").then(function(){item.domain=null,saveField(item,"domain")})}console.log("storeListCtrl"),console.log("stuffHost",stuffHost,"storeHost",storeHost),console.log(userHost);var self=this;self.Items=Store,self.$state=$state,self.query={storeType:"in-work"},self.paginate={page:0,rows:30,items:0},self.storeTypes=["work","template","in-work"],self.getList=getList,self.createItem=createItem,self.saveField=saveField,self.addOwner=addOwner,self.deleteOwner=deleteOwner,self.getOwner=getOwner,self.deleteStore=deleteStore,self.cloneStore=cloneStore,self.readStore=readStore,self.readStoreUnable=readStoreUnable,self.changeDomain=changeDomain,self.changeType=changeType,self.searchItem=searchItem,self.changeSubDomain=changeSubDomain,self.clearDomain=clearDomain,activate(),self.saveFieldSeller=function(field){var o={_id:self.item.seller._id};o[field]=self.item.seller[field],Seller.save({update:field},o)}}return{scope:{},restrict:"E",bindToController:!0,controller:storeListCtrl,controllerAs:"$ctrl",templateUrl:"components/storeSetting/storeList.html"}}).directive("currencyComponent",currencyComponent).directive("mainConfig",mainConfigComponent).directive("configData",configDataComponent),configDataComponentCtrl.$inject=["ConfigData","$q"],currencyComponentCtrl.$inject=["Store","$q","global","$http","$uibModal","exception"],mainConfigComponentCtrl.$inject=["Config","$q","global","exception","toaster"],angular.module("gmall.directives").directive("tagManagerForObject",function(){return{restrict:"E",scope:{tags:"=",header:"@"},template:'<div class="tags"><h3 ng-bind="header"></h3><p class="link-warning">удалить теги</p><p><a ng-repeat="(idx, tag) in tags" class="tag" ng-click="remove(idx)">{{getNameTag(idx)}} - {{tags[idx][getNameTag(idx)]}}</a></p><hr></div><div class="form-group"><div class="input-group"><input class="form-control" type="text" placeholder="добавить тег" ng-model="new_value.key" style="width: 45%; margin-right: 10px"> <input class="form-control"  type="text" placeholder="добавить значение" ng-model="new_value.value" style="width: 45%"><span class="input-group-btn"><a class="btn btn-fab btn-fab-mini" ng-click="add()"><i class="material-icons link-success">add</i></a></div></div> <h4 class="link-success">редактировать из списка</h4><div><a  class="tag-list" ng-repeat="(idx,tag) in tags" ng-click="edit(idx)">{{getNameTag(idx)}} - {{tags[idx][getNameTag(idx)]}}</a></div><hr>',link:function($scope,$element){$scope.new_value={},$scope.getNameTag=function(i){return Object.getOwnPropertyNames($scope.tags[i])[0]};var input=angular.element($element.children()[1]);$scope.add=function(){$scope.tags&&$scope.tags.length||($scope.tags=[]);var o={};o[$scope.new_value.key]=$scope.new_value.value,$scope.tags.push(o),$scope.new_value={}},$scope.remove=function(idx){$scope.tags.splice(idx,1)},$scope.edit=function(idx){$scope.new_value.key=$scope.getNameTag(idx),$scope.new_value.value=$scope.tags[idx][$scope.new_value.key],$scope.tags.splice(idx,1)},input.bind("keypress",function(event){13==event.keyCode&&$scope.$apply($scope.add)})}}}).directive("tagManager",function(){return{restrict:"E",scope:{tags:"=",header:"@"},template:'<div class="tags"><h3 ng-bind="header"></h3></br><p class="link-warning">удалить метки</p><p><a ng-repeat="(idx, tag) in tags" class="tag" ng-click="remove(idx)">{{tag}}</a></p><hr></div><div class="form-group"><div class="input-group"><input class="form-control"  type="text" placeholder="добавить тег" ng-model="new_value"> <span class="input-group-btn"><a class="btn btn-fab btn-fab-mini" ng-click="add()"><i class="material-icons link-success">add</i></a></span></div></div><h4 class="link-success">редактировать из списка</h4><div><a class="tag-list" ng-repeat="tag in tags" ng-click="edit($index)">{{tag}}</a></div><hr>',link:function($scope,$element){var input=angular.element($element.children()[1]);$scope.add=function(){$scope.tags&&$scope.tags.length||($scope.tags=[]),$scope.tags.push($scope.new_value),$scope.new_value=""},$scope.remove=function(idx){$scope.tags.splice(idx,1)},
$scope.edit=function(idx){$scope.new_value=$scope.tags[idx],$scope.tags.splice(idx,1)},input.bind("keypress",function(event){13==event.keyCode&&($scope.$apply($scope.add),event.preventDefault())})}}}),angular.module("gmall.directives").directive("focusElement",["$timeout",function($timeout){return{scope:{focusElement:"="},link:function($scope,$element,$attr){$scope.$watch("focusElement",function(value){if(console.log(value),value)return void setTimeout(function(){$element[0].focus(),$scope.focusElemen=!1},200)})}}}]).directive("simpleFocusElement",[function(){return{restrict:"A",link:function(scope,element,attrs){setTimeout(function(){element[0].focus()},300),"false"==attrs.simpleFocusElement&&(console.log("focus",element[0]),setTimeout(function(){element[0].focus()},200))}}}]).directive("focusMe1",function($timeout,$parse){return{link:function(scope,element,attrs){var model=$parse(attrs.focusMe);scope.$watch(model,function(value){console.log("value=",value),value===!0&&$timeout(function(){element[0].focus()},300,!1)}),element.bind("blur",function(){console.log("blur"),scope.$apply(model.assign(scope,!1))})}}}).directive("focusMe",function($timeout){return{link:function(scope,element,attrs){scope.$watch(attrs.focusMe,function(value){value===!0&&$timeout(function(){element[0].focus(),scope[attrs.focusMe]=!1},300,!1)})}}}),angular.module("gmall.directives").directive("selectDropDown",["$window",function($window){return{link:function(scope,element,attrs){var defer=50;"defer"==attrs.selectDropDown&&(defer=200),setTimeout(function(){$(element).dropdown({callback:function($dropdown){$dropdown.fadeIn("slow")}})},defer)}}}]),angular.module("gmall.directives").directive("paginatorMain",function(anchorSmoothScroll,$anchorScroll){return{restrict:"E",scope:{paginate:"=",getlist:"&",scroll:"@"},link:function(scope,element,attrs,controller){function getList(){scope.scroll&&anchorSmoothScroll.scrollTo(scope.scroll,200),scope.getlist()}if(scope.paginate&&"object"==typeof scope.paginate){var l;scope.paginator={},scope.$watch("paginate.items",function(n,o){(n||0===n)&&(scope.paginate.items=Number(n),l=scope.paginator.pageCount(),scope.arrayPage=scope.getListPage())}),scope.paginator.setPage=function(page){((page=Number(page))||0===page)&&(page>scope.paginator.pageCount()||page==scope.paginate.page||(scope.paginate.page=page,0==scope.paginate.page&&(scope.arrayPage=scope.getListPage(2)),scope.paginate.page==l-1&&(scope.arrayPage=scope.getListPage(6)),scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList()))},scope.paginator.nextPage=function(){scope.paginator.isLastPage()||(scope.paginate.page++,scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList())},scope.paginator.perviousPage=function(){scope.paginator.isFirstPage()||(scope.paginate.page--,scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList())},scope.paginator.firstPage=function(){scope.paginate.page=0,getList()},scope.paginator.lastPage=function(){scope.paginate.page=scope.paginator.pageCount()-1,getList()},scope.paginator.isFirstPage=function(){return 0==scope.paginate.page},scope.paginator.isLastPage=function(){return scope.paginate.page==scope.paginator.pageCount()-1},scope.paginator.pageCount=function(){var count=Math.ceil(parseInt(scope.paginate.items,10)/parseInt(scope.paginate.rows,10));return 1===count&&(scope.paginate.page=0),count},scope.changeRow=function(rows){for(scope.paginate.rows=rows;scope.paginator.pageCount()<scope.paginate.page-1;)scope.paginate.page--;getList()},scope.arrayPage=[],scope.getListPage=function(num){var page=scope.paginate.page,arrayPage=[];if((0===num||num)&&(page=num),l<=6)for(var i=0;i<l;i++)arrayPage.push(i);else{if(page>=3)arrayPage.push(0),arrayPage.push("..."),arrayPage.push(page-1),arrayPage.push(page),arrayPage.push(page+1);else for(var i=0;i<4;i++)arrayPage.push(i);l-1-page>2&&arrayPage.push("..."),arrayPage.push(l-1)}return arrayPage},scope.getPageStr=function(i){return Number(i)||0===i?i+1:i}}},templateUrl:"components/paginator/paginator.html"}}),angular.module("gmall.directives").directive("lostFocus",["$window",function($window){return{scope:{lostFocus:"&",focusElement:"="},link:function(scope,element){setTimeout(function(){scope.focusElement&&element[0].focus(),element.bind("blur",function(e){setTimeout(function(){scope.lostFocus()})}),element.trigger("change")},500)}}}]).directive("focusMe",[function(){return{scope:{focusMe:"="},link:function(scope,element){scope.$watch("focusMe",function(n){n&&setTimeout(function(){element[0].focus(),scope.focusMe=!1})})}}}]).directive("isScrolledIntoView",[function(){return{scope:{isScrolledIntoView:"="},link:function(scope,elem){function isScrolledIntoViewF(elem){var docViewTop=$(window).scrollTop(),docViewBottom=docViewTop+$(window).height(),elemTop=$(elem).offset().top-150;return elemTop+$(elem).height()<=docViewBottom&&elemTop>=docViewTop}$(window).scroll(function(){scope.isScrolledIntoView=isScrolledIntoViewF(elem),scope.$apply()})}}}]),function(){angular.module("gmall.directives").directive("ngAutocompleteCity",function($parse,$timeout,global){return{scope:{user:"=",change:"&"},link:function(scope,element,attrs,model,contorller){function activate(){scope.user||(scope.user={}),scope.user.profile||(scope.user.profile={}),scope.user.profile.city||(scope.user.profile.city=""),element[0].value=scope.user.profile.city,void 0==scope.gPlace&&(scope.gPlace=new google.maps.places.Autocomplete(element[0],{types:["(cities)"]})),google.maps.event.addListener(scope.gPlace,"place_changed",place_changed),google.maps.event.addDomListener(element[0],"keydown",function(e){13==e.keyCode&&e.preventDefault()})}function place_changed(){placeChosen=!0;var place=scope.gPlace.getPlace();place.place_id?setTimeout(function(){scope.user.profile.city=element.val(),$timeout(function(){scope.user.profile.cityId=place.place_id},200),scope.$apply(),scope.change&&"function"==typeof scope.change&&scope.change()},50):(scope.cityId=null,scope.user.profile.city=element.val(),scope.$apply()),$timeout(function(){placeChosen=!1},1e3)}var placeChosen=!1;setTimeout(function(){activate()},500),scope.$watch(function(){return element.val()},function(o,n){n&&n!=o&&!placeChosen&&(scope.user.profile.cityId=null,scope.user.profile.city=element.val())})}}})}(),angular.module("gmall.services").factory("Collection",function($resource){return $resource("/api/collections/Collection/:id",{id:"@id"},{getCollectionsForBrand:{method:"GET",isArray:!0,params:{id:"",query:"query"}}})}),angular.module("gmall.services").service("anchorSmoothScroll",function(){this.scrollTo=function(eID,diff){var startY=function(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}(),stopY=function(eID){var elm=document.getElementById(eID);if(!elm)return 0;for(var y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return y}(eID)+(diff?diff:0),distance=stopY>startY?stopY-startY:startY-stopY;if(distance<100)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(var i=startY;i<stopY;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(var i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,leapY<stopY&&(leapY=stopY),timer++}}),angular.module("gmall.services").factory("CreateContent",["global","$timeout",function(global,$timeout){function getHeader(user){var s='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 20px 0 0 0" border="0"><tr width="100%" style="max-width:900px;"><td width="50%" style=" padding:5px 20px"><a href="'+global.get("store").val.link+'">';return global.get("store").val.logo&&(s+='<img  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></br>'),global.get("store").val.name&&(s+='<span  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.name+'"></span>'),s+="</a></td>",s+='<td width="50%"  style="text-align: right; padding:5px 20px">',global.get("store").val.seller.phone&&(s+="<p><span>"+global.get("langOrder").val.phone+'</span>: <a style="color:#666" href="tel:+'+global.get("store").val.seller.phone+'"><span>+'+global.get("store").val.seller.phone+"</span></a></p>"),global.get("store").val.feedbackEmail&&(s+='<p><span>e-mail</span>: <a style="color:#666" href="mailto:'+global.get("store").val.feedbackEmail+'"><span>'+global.get("store").val.feedbackEmail+"</span></a></p>"),s+="</td></tr>",global.get("sections")&&global.get("sections").val&&global.get("sections").val[0]&&(s+='<table width="860px" cellpadding="0" cellspacing="0" style="max-width:900px;background-color: #000;border-collapse:collapse; border:1px solid #000;table-layout: fixed; padding: 0;margin: 0px 20px"><td width="50%" style="background-color: #333;text-align: center; padding: 20px;border:1px solid #fff;"><a style="color: #fff; text-transform: uppercase" href="'+global.get("store").val.link+'/cabinet"><span>'+global.get("langOrder").val.mainCabinet+"</span></a></td>",s+='<td width="50%" style="background-color: #333;text-align: center; padding: 20px;border:1px solid #fff;"><a style="color: #fff; text-transform: uppercase" href="'+global.get("store").val.link+"/"+global.get("sections").val[0].url+'/category"><span>'+global.get("lang").val.catalog+"</span></a></td>",s+="</tr></table>",s+="</table>"),s}function getFooter(){var s='<style>.footer a</style><table class="footer" width="860px" cellpadding="0" cellspacing="0" style="margin: 20px;color: #000;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;" border="0"><tr><td colspan="2" align="center" style="vertical-align: top; padding: 10px 20px;background-color:#333"><span style="font-family:Tahoma; font-size:12px; color:#e8e8e8;">';if(global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&global.get("store").val.template.index&&global.get("store").val.template.index.icons&&global.get("store").val.template.index.icons[key+"white"]&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 0 10px" src="'+global.get("store").val.link+global.get("store").val.template.index.icons[key+"white"].img+'"></a>');return s+='</span></td></tr><tr style="background-color: #fff;color: #000"><td align="left" style="vertical-align: top; padding: 10px 20px"><span style="font-size:14px; ">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),s+="</span></td>",s+='<td align="right" style="vertical-align: top; padding: 10px 20px"><span style="font-size:14px;">',global.get("store").val.footer&&global.get("store").val.footer.text1&&(s+=global.get("store").val.footer.text1),s+="</span></td></tr></table>"}function empty(){return'<!DOCTYPE html><html><head><meta charset=utf-8/><style type="text/css">@media only screen and (max-device-width:660px){.table-mobile{display:none !important;}}</style></head><body onload="window.print()"><div style="max-width: 800px"><h1>информация  отсутствует</h1></div><body></html>'}function getLink(t,u){if(!t||!u)return null;var d=global.get("store").val.domain;switch(console.log("global.get('store').val.domain",global.get("store").val.domain),t){case"stuffs":return d+"/group/category/"+u;case"categories":return d+"/group/"+u;case"brandTags":return d+"/group/category?brandTag="+u;case"brands":return d+"/group/category?brand="+u;case"filterTags":return d+"/group/category?queryTag="+u;case"campaign":return d+"/camapign/"+u}}function emailFromNews(item){var s='<table width="100%" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr width="100%" style="max-width:900px;"><td style="text-align: center; padding: 5px"><a href="'+global.get("store").val.link+'"><img  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></a></td></tr><tr width="100%" style="max-width:900px;"><td style="text-align: center; padding: 5px; font-size: 20px;"><h3>usernameforreplace</h3></td></tr><tr width="100%"><td><h2 style="font-weight: 500; letter-spacing: 2px; text-transform: uppercase; text-align: center; color: #333333; font-family:  Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.name+"</h2></td></tr>";if(s+="</table>",s+='<table class="table-mobile" width="100%" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333; border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0 " border="0">',item.blocks&&item.blocks.length&&item.blocks.forEach(function(block){if(block.name&&(s+="text2"==block.type?'<tr width="100%" style="max-width:900px;"><td style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+(block.name?block.name:"")+'</h3></td><td style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+(block.name1?block.name1:"")+"</h3></td></tr>":'<tr width="100%" style="max-width:900px;"><td colspan="2" style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+block.name+"</h3></td></tr>"),block.img&&(s+='<tr width="100%" style="max-width:900px;"><td  colspan="2" width="100%" style=" padding: 5px" >',block.link&&(s+='<a href="'+global.get("store").val.link+block.link+'" style="cursor: pointer;">'),s+='<img alt="" style="width: 100%;margin-bottom: 10px; display: block" src="'+photoHostForFactory+"/"+block.img+'">',block.link&&(s+="</a>"),s+="</td></tr>"),block.desc&&(s+="text2"==block.type?'<tr width="100%" style="max-width:900px;"><td style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+(block.desc?block.desc:"")+'</span></td><td style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+(block.desc1?block.desc1:"")+"</span></td></tr>":'<tr width="100%" style="max-width:900px;"><td colspan="2" style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.desc+"</span></td></tr>"),block.imgs&&block.imgs.length)for(var i=0,l=block.imgs.length;i<l;i+=2){s+="<tr>";var link1;if(block.imgs[i].link?link1=block.imgs[i].link.indexOf("http")<0?global.get("store").val.link+block.imgs[i].link:block.imgs[i].link:block.imgs[i].url&&(link1=getLink(block.type,block.imgs[i].url)),s+='<td style="padding: 5px; text-align: center;vertical-align: top">',link1&&(s+='<a href="'+link1+'">'),s+='<img alt="" style="width: 100%; display: block" src="'+photoHostForFactory+"/"+block.imgs[i].img+'">',block.imgs[i].name&&(s+='<span style="font-weight: 700; color: #666666; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.imgs[i].name+"</span>"),link1&&(s+="</a>"),s+="</td>",block.imgs[i+1]){var link2;block.imgs[i+1].link?block.imgs[i].link.indexOf("http")<0?link2=global.get("store").val.link+block.imgs[i+1].link:block.imgs[i+1].link&&(link2=block.imgs[i+1].link):link1=getLink(block.type,block.imgs[i+1].url),s+='<td style="padding: 5px; text-align: center;vertical-align: top">',link2&&(s+='<a href="'+link2+'">'),s+='<img alt="" style="width: 100%; display: block" src="'+photoHostForFactory+"/"+block.imgs[i+1].img+'">',block.imgs[i+1].name&&(s+='<span style="font-weight: 700; color: #666666; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.imgs[i+1].name+"</span>"),link2&&(s+="</a>"),s+="</td>"}else s+='<td style="padding: 5px; text-align: center;vertical-align: top"></td>';s+="</tr>"}}),s+="</table>",s+='<table width="900px" cellpadding="0" cellspacing="0" style="color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr><td border="0" colspan="2" style="border:none; border-top:#cccccc 5px solid;"></td></tr><tr><td align="right" style="vertical-align: top"><span style="font-family:Tahoma; font-size:12px; color:#404040;">',global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 15px 5px" src="'+global.get("store").val.link+"/views/template/img/icon/sn_grey/"+key+'.png"></a>');return s+='</span><td align="right"><span style="font-family:Tahoma; font-size:14px; color:#404040;">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),s+="</span></td></tr></table>"}function emailBonus(stuffs){var item,s='<table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr width="100%" style="max-width:600px;"><td style="text-align: center; padding: 5px"><img alt="посмотреть на сайте" style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></td></tr><tr width="100%"><td><h2 style="font-weight: 500; letter-spacing: 2px; text-transform: uppercase; text-align: center; color: #333333; font-family:  Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">бонусы</h2></td></tr>';if(s+="</table>",stuffs.forEach(function(stuff){if(item=stuff,item.imgs&&item.imgs.length){s+='<table class="table-mobile" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;color: #333333; border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0">';for(var i=0,l=item.imgs.length;i<l;i++)item.imgs[i].name&&(s+='<tr width="100%" style="max-width:600px;"><td style=" padding: 5px"><p style="color: #333333; font: 16px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.imgs[i].name+"</p></td></tr>"),s+='<tr><td style="padding: 5px;"><img alt="бонусный купон"  style="width: 100%; display: block"   src="'+photoHostForFactory+"/"+item.imgs[i].img+'"></td>',s+="</tr>",item.imgs[i].desc&&(s+='<tr width="100%" style="max-width:600px;"><td style=" padding: 5px"><p style="color: #333333; font: 16px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.imgs[i].desc+"</p></td></tr>");s+="</table>"}}),s+='<table width="600px" cellpadding="0" cellspacing="0" style="color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr><td border="0" colspan="2" style="border:none; border-top:#cccccc 5px solid;"></td></tr><tr><td align="left" style="vertical-align: top"><span style="font-family:Tahoma; font-size:12px; color:#404040;">',global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 15px 5px" src="'+global.get("store").val.link+"/views/template/img/icon/sn_natur/"+key+'.png"></a>');return s+='</span><td align="right"><span style="font-family:Tahoma; font-size:16px; color:#404040;">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),'<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><div>'+(s+="</span></td></tr></table>")+"</div></html>"}function orderNote(order){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.order+" № "+order.num+"</h3> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),s+="<p>"+global.get("langOrder").val.sum+" "+order.paySum.toFixed(2)+" "+order.currency+"</p>"}function dateTimeNote(entry){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.dateTime+"</h3> "+global.get("langOrder").val.onn+" "+entry.dateForNote,s+="<p>"+global.get("store").val.texts.masterName[global.get("store").val.lang]+" - "+entry.masterName+"</p>",s+="<p>"+entry.service.name+"</p>"}function dateTimeCancelNote(entry){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.dateTime+'<span style="color:red"> '+global.get("langOrder").val.removed+"</span></h3> "+global.get("langOrder").val.onn+" "+entry.dateForNote,s+="<p>"+global.get("store").val.texts.masterName[global.get("store").val.lang]+" - "+entry.masterName+"</p>",s+="<p>"+entry.service.name+"</p>",s+="<p>"+entry.user.name+"- "+entry.user.phone+"</p>"}function order(order,invoice,commentPrint){var lang=global.get("store").val.lang,texts=global.get("store").val.texts,user=order.profile&&order.profile.admin?order.profile.admin:order.profile.fio;user||(user=order.user.name);var orderMailText=texts.orderMailText&&texts.orderMailText[lang]?texts.orderMailText[lang]:"";order.profile&&order.profile.admin&&(orderMailText="");var name=global.get("langOrder").val.order+" № "+order.num+"<small> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</small>",status=global.get("langOrder").val.entered.toUpperCase();2==order.status?status=global.get("langOrder").val.accepted.toUpperCase():3==order.status?status=global.get("langOrder").val.statuspaid.toUpperCase():4==order.status?status=global.get("langOrder").val.statussent.toUpperCase():5==order.status&&(status=global.get("langOrder").val.statusdelivered.toUpperCase()),user=global.get("langOrder").val.hello+", "+user+"!";var s=getHeader(name);s+='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr  width="100%"><td colspan="2" style="padding: 0 20px;"><h3 style="font-size: 24px">'+user+"</h3></td></tr>",1==order.status&&(s+='<tr  width="100%"><td colspan="2" style="padding: 0 20px"><p>'+orderMailText+"</p></td></tr>"),s+='<tr style="max-width:900px;"><td width="50%" style="max-width:900px;padding: 10px 20px;font-size: 16px;vertical-align: top"><h4 style="font-weight: bold">'+status+'</h4><h4 style="font-weight: bold">'+global.get("langOrder").val.order.toUpperCase()+" № "+order.num+'</h4><p style="margin-bottom: 30px">'+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</p>",commentPrint&&order.comment&&(s+='<div><h4 style="font-weight: bold">'+global.get("langOrder").val.comments+"</h4><p>"+order.comment+"</p></div>"),invoice&&order.payInfo&&(s+='<h4 style="font-weight: bold">'+global.get("langOrder").val.forpayment+"</h4>",s+="<p>"+order.payInfo+"</p>"),invoice&&order.checkOutLiqpayHtmlIs&&(s+="<p>"+order.checkOutLiqpayHtml+"</p>"),s+="</td>",s+='<td style=" padding: 10px 20px; font-size: 16px;vertical-align: top;">',s+='<h4 style="font-weight: bold">'+global.get("langOrder").val.customerdata+"</h4>",s+="<p> e-mail - "+order.user.email+"</p>",order.profile.fio&&(s+="<p> "+global.get("langOrder").val.name+"  - "+order.profile.fio+"</p>"),order.profile.phone&&(s+="<p> "+global.get("langOrder").val.phone+" - "+order.profile.phone+"</p>"),order.profile.city&&(s+="<p> "+global.get("langOrder").val.city+"  - "+order.profile.city+"</p></div>"),s+="</td></tr></table>",s+='<table style="margin: 20px" width="860px" cellspacing="0" cellpadding="5" border="1px">',s+='<thead><tr><th style="padding: 10px">#</th><th style="padding: 10px">'+global.get("langOrder").val.title+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.species+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.price+"</th>",s+='<th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.quantity+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.sum+"</th></tr></thead>",s+="<tbody>";for(var cart=order.cart.stuffs,j=0,lj=cart.length;j<lj;j++){var good=cart[j];s+='<tr><td style="padding: 10px">'+(j+1)+'</td><td style="padding: 10px"> '+good.name+" "+(good.artikul?good.artikul:"")+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(good.sortName?good.sortName:"")+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(order.kurs*good.cena).toFixed(2)+" "+order.currency+'</td><td class="text-center" style="padding: 10px; text-align: center">'+good.quantity+'</td><td class="text-center">'+(order.kurs*good.sum).toFixed(2)+" "+order.currency+"</td></tr>"}s+="</tbody>",s+='<tbody class="cart-item-total">',s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.sum+'</th><th class="text-center" style="padding: 10px; text-align: center">'+order.getTotalQuantity()+'</th><th style="padding: 10px; text-align: center" class="text-center">'+(order.kurs*(order.sum0?order.sum0:order.sum)).toFixed(2)+" "+order.currency+"</th></tr>",order.discount&&(s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.withdiscount+"</th>",s+=order.sum<order.sum0?'<th class="text-center"  style="padding: 10px; text-align: center">'+Math.round(100*(1-order.sum/order.sum0))+"%</th>":'<th class="text-center" style="padding: 10px; text-align: center"></th>',s+='<th class="text-center"  style="padding: 10px; text-align: center">'+(order.kurs*order.sum).toFixed(2)+" "+order.currency+"</th></tr>"),order.coupon&&order.coupon._id&&(s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.basedcoupon+'</th><th></th><th class="text-center"  style="padding: 10px; text-align: center">'+(order.kurs*order.getCouponSum()).toFixed(2)+" "+order.currency+"</th></tr>");order.getTotalDiscount();return order.shipCost&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.delivery+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.shipCost.toFixed(2)+" "+order.currency+"</th></tr>"),order.totalPay&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.paid+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.totalPay.toFixed(2)+" "+order.currency+"</th></tr>"),order.paySum!=order.getCouponSum()&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.totaltopay+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.paySum.toFixed(2)+" "+order.currency+"</th></tr>"),s+="</tbody></table></div></div></div>",'<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://gmall.io/bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+(s+=getFooter())+"</div></html>"}function orderShipInfo(order){var shipDetail=order.shipDetail,name=(global.get("store").val.lang,global.get("store").val.texts,global.get("langOrder").val.order+" № "+order.num+"<small> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</small>"),user=global.get("user").val.profile.fio||global.get("user").val.name,status=global.get("langOrder").val.entered.toUpperCase();2==order.status?status=global.get("langOrder").val.accepted.toUpperCase():3==order.status?status=global.get("langOrder").val.statuspaid.toUpperCase():4==order.status?status=global.get("langOrder").val.statussent.toUpperCase():5==order.status&&(status=global.get("langOrder").val.statusdelivered.toUpperCase()),user=global.get("langOrder").val.hello+", "+user+"!";var s=getHeader(name);return s+='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr  width="100%"><td colspan="2" style="padding: 20px;"><h3 style="font-size: 24px">'+user+"</h3></td></tr></table>",s+='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr style="max-width:900px;"><td width="50%" style="max-width:900px;padding: 10px 20px;font-size: 16px;vertical-align: top"><h4 style="font-weight: bold">'+global.get("langOrder").val.order.toUpperCase()+" № "+order.num+"</h4><p>"+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+'</p><h4 style="font-weight: bold;margin-bottom: 30px">'+status+'</h4><h4 style="font-weight: bold">'+global.get("langOrder").val.aboutdelivery+"</h4></td></tr></table>",shipDetail&&shipDetail.length?(s+='<table style="margin: 20px" width="860px" cellspacing="0" cellpadding="5" border="1px">',s+='<thead><tr><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.title+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.where+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.waybill+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.date+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.sum+"</th>",shipDetail.forEach(function(ship){s+='<tr><td style="padding: 10px">',ship.stuffs.forEach(function(stuff){s+='<div style="width:80%;float:left">'+stuff.name+'</div><div style="float:left">'+stuff.qty+(stuff.unitOfMeasure?" "+stuff.unitOfMeasure:"")+'</div><div style="clear: both"></div><hr/>'}),s+=ship.qty,s+='</td><td style="padding: 10px; vertical-align: top">'+(ship.info||"")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+(ship.ttn||"")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+moment(ship.date).format("LLL")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+(ship.sum||0).toFixed(2)+"&nbsp;"+order.currency+"</td></tr>"}),s+="</table></br></br>"):s+="<h1>"+global.get("langOrder").val.infisnot+"</h1>",'<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://gmall.io/bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+(s+=getFooter())+"</div></html>"}function shipInfoNote(order){var s="";return s+="<h3>"+global.get("langOrder").val.order+" № "+order.num+"</h3><br/> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),
s+="<p>"+global.get("langOrder").val.totaltopay+" <strong>"+order.paySum.toFixed(2)+" </strong>"+order.currency+"</p>",s+="<p>"+global.get("langOrder").val.sentshipinfo+"</p>"}function shipInfo(order,ship){if(ship.ttn&&ship.info){var s="<h3>"+global.get("langOrder").val.aboutdelivery+" </h3>";return global.get("langOrder").val.onawarrant,order.num,global.get("langOrder").val.from,moment(order.date).format("lll"),s+="<strong>"+global.get("langOrder").val.waybill+" - "+ship.ttn||"</strong> "+global.get("langOrder").val.from+" "+moment(ship.date).format("LL")+"</p>",ship.info&&(s+="<p>"+ship.info.substring(0,250)+"</p>"),ship.sum&&(s+="<strong>"+ship.sum.toFixed(2)+" "+order.currency+"</strong>"),ship.stuffs&&ship.stuffs.length&&(s+="<strong>  "+ship.stuffs.length+" ед.</strong>"),s}}function payInfo(order,pay){if(pay.sum){var s="<h3>"+global.get("langOrder").val.makepayment+" </h3>";return s+="<p>"+global.get("langOrder").val.onawarrant+" №"+order.num+"<br> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</p>",s+="<p><strong>"+pay.sum.toFixed(2)+" "+order.currency+"</strong></p> "+moment(pay.date).format("LL"),pay.info&&(s+="<p>"+pay.info.substring(0,150)+"</p>"),s}}function acceptedInfo(order){var s="<h3>"+global.get("langOrder").val.byorders+" №"+order.num+"</h3>";return s+=" "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+".",order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p><strong>"+global.get("langOrder").val.accepted+" </strong></p>"}function invoiceInfo(order){var s="";return s+="<h3>"+global.get("langOrder").val.order+" № "+order.num+"</h3><br/> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p>"+global.get("langOrder").val.totaltopay+" <strong>"+order.paySum.toFixed(2)+" </strong>"+order.currency+"</p>",s+="<p>"+global.get("langOrder").val.sentthepost+"</p>"}function call(number){var s="";return s+="<h3>"+number+"</h3>",s+="<p>"+global.get("langOrder").val.requestacallback+"</p>",s+="<p>"+moment().format("LLLL")+"</p>"}if(void 0===photoHost)var photoHost;var photoHostForFactory;return $timeout(function(){photoHostForFactory=photoHost?photoHost:global.get("store").val.link},1e3),{empty:empty,order:order,orderNote:orderNote,dateTimeNote:dateTimeNote,shipInfo:shipInfo,payInfo:payInfo,invoiceInfo:invoiceInfo,acceptedInfo:acceptedInfo,orderShipInfo:orderShipInfo,call:call,emailFromNews:emailFromNews,emailBonus:emailBonus,shipInfoNote:shipInfoNote,dateTimeCancelNote:dateTimeCancelNote}}]),angular.module("gmall.directives").directive("datePicker",["$window",function($window){return{scope:{onChange:"&",date:"="},link:function($scope,$element,$attrs){console.log("link");var options={format:"YYYY-MM-DD",time:!1};$attrs.minDate&&("today"===$attrs.minDate?options.minDate=$window.moment():options.minDate=$attrs.minDate),$scope.date&&(options.currentDate=$scope.date),$($element).bootstrapMaterialDatePicker(options),$element.on("change",function(event,date){$scope.$apply(function(){$scope.date=date.format("YYYY-MM-DD"),$scope.onChange({date:date})})}),$scope.$watch("date",function(newValue,oldValue){newValue!==oldValue&&$($element).bootstrapMaterialDatePicker("setDate",newValue)})}}}]),angular.module("gmall.directives").directive("editNote",[function(){return{scope:{obj:"=",lostFocus:"&",field:"@"},template:'<div class="form-group label-floating"><label class="control-label" for="comment">добавить заметку</label><textarea rows="2" class="form-control" style="width=100%" ng-model="obj.note"></textarea></div>',link:function(scope,element){setTimeout(function(){angular.element(element.children().children("textarea")[0])},100)}}}]),function(){function serviceBooking($resource,$uibModal,$q,global,$http,exception){function getCheckOutLiqpayHtml(entryM,user){return entry=angular.copy(entryM),user&&(entry.user=user),$q.when().then(function(){return $http.post("/api/orders/checkoutLiqpayEntry",entry)}).then(function(res){res&&res.data.html&&(entryM.checkOutLiqpayHtml=res.data.html,entryM.checkOutLiqpayHtmlIs=!0)}).then(function(res){}).catch(function(err){exception.catcher("error")(err)})}function getDatesForWeek(date,num){num||(num=7);var ds=[],d=new Date(date),dw=date.getDay();0==dw&&(dw=7);for(var i=1;i<=num;i++){d=new Date(date),d.setTime(d.getTime()+864e5*(i-dw)),d.setHours(0);var month=d.getMonth(),day=d.getDate(),year=d.getFullYear(),dayOfYear=getDayOfYear(month,day-1);month<10&&(month="0"+month),day<10&&(day="0"+day);var o={date:"date"+year+month+day,d:d,dayOfYear:dayOfYear,month:moment(d).format("MMMM")};ds.push(o)}return ds}function getDateFromEntry(entry){var hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10);try{return new Date(year,month,day,hour,minutes)}catch(err){return console.log(err),"error handle date"}}function getDateFromStrDateEntry(str){var year=str.substring(4,8),month=str.substring(8,10),day=str.substring(10);try{return new Date(year,month,day)}catch(err){return console.log(err),"error handle date"}}function getDateStringFromEntry(entry,format){var hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10);try{if(format)var date=new Date(year,month,day);else{var date=new Date(year,month,day,hour,minutes);date=moment(date).format("LLL")}return date}catch(err){return console.log(err),"error handle date"}}function sendMessage(entry,user){entry=JSON.parse(JSON.stringify(entry)),user&&(entry.user=user);var dataForSend={},hour=Math.floor(entry.start/4),minutes=entry.start%4*15,year=entry.date.substring(4,8),month=entry.date.substring(8,10),day=entry.date.substring(10);try{var date=new Date(year,month,day,hour,minutes);date=moment(date).format("lll"),dataForSend.name=entry.user.name,dataForSend.userId=entry.user._id,dataForSend.phone=entry.user.phone,dataForSend.text=global.get("langOrder").val.recordedOn+" "+entry.service.name.toUpperCase()+" "+global.get("langOrder").val.onn+" "+date,dataForSend.date=date}catch(err){console.log(err)}console.log(dataForSend),dataForSend&&dataForSend.date&&$q.when().then(function(){return $http.post("/api/users/sendMessageAboutDeal",dataForSend)}).catch(function(err){err&&exception.catcher("send message")(err)})}function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function newBooking(master,timePart,services,date,entryDate,start){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/newBooking.html",controller:function($uibModalInstance,global,$timeout,$user,exception,master,timePart,services,Booking,entryDate,start){function addingNewUser(){if(self.addingUser=!self.addingUser,self.addingUser&&self.cachePhone){var newVal=self.cachePhone.replace(pattern,"");if(console.log(newVal),console.log(newVal.length==self.cachePhone.length),newVal.length==self.cachePhone.length){for(var tempPhone=self.cachePhone.substring(0,10),i=tempPhone.length;i<10;i++)tempPhone+="0";self.oldPhone=tempPhone}else self.userName=self.cachePhone}}function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{"profile.phone":phone},{name:phone},{email:phone}]};$user.getList({page:0,rows:20},q).then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user})})}function clearUser(){self.user=null}function addUser(){console.log("add user");var user={name:self.userName,profile:{phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10),fio:self.userName},store:global.get("store").val._id};return $q.when().then(function(){return $user.checkPhoneForExist(user.profile.phone)}).then(function(res){if(res&&res.exist)throw"phone exist in base";if(user.email)return $user.checkEmailForExist(user.email);user.email=user.profile.phone+"@gmall.io"}).then(function(res){if(res&&res.exist)throw"email exist in base"}).then(function(){return $user.save(user).$promise}).then(function(res){user._id=res._id?res._id:res.id,self.addingUser=!1,self.userName="",self.user=user,console.log(user),self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function allFieldCheck(){return!self.services.length&&!self.reserved||!self.user&&!self.schedule&&!self.reserved}function checkNameNewUser(){return!self.userName||self.userName.length<3}function moveEtry(){for(var busy=!1,i=start;i<start+self.entryToMove.qty;i++)if(master.entryTimeTable[i].busy||master.entryTimeTable[i].out){busy=!0;break}if(busy)return void $uibModalInstance.dismiss("не достаточно времени");var o={_id:self.entryToMove._id};o.date=entryDate,o.start=start,o.move=!1;Booking.save({update:"start move date"},o,function(err){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)}),$uibModalInstance.close()}var self=this;self.global=global,self.date=moment(date).format("L"),self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",self.hour=parseInt(timePart/4),self.minutes=15*(timePart-4*self.hour)?15*(timePart-4*self.hour):"00",self.timeRemindArr=timeRemindArr,self.schedule=!0,self.mastersInEntry=[],master.services.forEach(function(s){s.used=!1,s.duration=15*s.timePart}),self.userName="",self.master=master,self.oldPhone="",self.services=services.length?services:[],self.entriesToMove=null,self.entryToMove=null;var pattern=/[^0-9]*/g;if(global.get("store").val.seller&&global.get("store").val.seller.minDurationForService&&Number(global.get("store").val.seller.minDurationForService/15)){var delta=Number(global.get("store").val.seller.minDurationForService/15);1==delta&&(delta=0,console.log(delta)),self.timeDurationdArr=timeDurationdArr.filter(function(p){return!(p.part%delta)})}else self.timeDurationdArr=timeDurationdArr;self.searchUser=searchUser,self.clearUser=clearUser,self.allFieldCheck=allFieldCheck,self.addUser=addUser,self.checkNameNewUser=checkNameNewUser,self.refreshUsers=refreshUsers,self.moveEtry=moveEtry,self.addingNewUser=addingNewUser,function(){var query={query:{master:master._id,move:!0}};Booking.query(query,function(res){res&&res.length&&(res.shift(),self.entriesToMove=res.map(function(e){return e.name=e.service.name+" "+Booking.getDateStringFromEntry(e),e}))}),self.masters=global.get("masters").val.filter(function(m){return m._id!=master._id})}(),self.ok=function(){var item={remind:self.remind,timeRemind:self.timeRemind,schedule:self.schedule,setColor:self.setColor};if(self.services.length)item.services=self.services;else{if(!self.reserved)return;item.services=[{_id:"reserved",name:"reserved",timePart:self.reserved}]}self.user&&self.user._id?(item.user={_id:self.user._id,name:self.user.name,email:self.user.email},self.user.profile&&self.user.profile.phone&&(item.user.phone=self.user.profile.phone)):self.schedule?item.user={_id:"schedule",name:"schedule"}:self.reserved&&(item.user={_id:"reserved",name:"reserved"}),self.mastersInEntry.length&&(item.masters=self.mastersInEntry),$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{master:function(){return master},timePart:function(){return timePart},services:function(){return services},entryDate:function(){return entryDate},start:function(){return start}}}).result.then(function(item){resolve(item)},function(err){reject(err)})})}function editBooking(entry,masters){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/editBooking.html",controller:function(global,$uibModalInstance,$user,Booking,$timeout,UserEntry,exception,entry,masters,Confirm){function _setTimeParts(){return timeTable15min.map(function(t,i){var busy=!1;if(self.master.entryTimeTable[i].out)busy=!0;else if(self.master.entryTimeTable[i].busy&&self.master.entryTimeTable[i].entry._id!=self.entry._id)busy=!0;else for(var j=i+1;j<i+self.qty;j++)(!self.master.entryTimeTable[j]||self.master.entryTimeTable[j].out||self.master.entryTimeTable[j].busy&&self.master.entryTimeTable[j].entry._id!=self.entry._id)&&(busy=!0);return{part:i,time:t,busy:busy}})}function addNewUser(user){if(user&&(self.newUser=user),!(self.entry.users&&self.entry.users.length&&self.entry.users.some(function(u){return u._id==self.newUser._id}))){var o={_id:self.newUser._id,phone:self.newUser.phone,name:self.newUser.name,email:self.newUser.email};self.entry.users.push(o),saveField("users")}}function deleteUser(i){Confirm("удалить?").then(function(){self.entry.users.splice(i,1),saveField("users")})}function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{"profile.phone":phone},{name:phone},{email:phone}]};$user.getList({page:0,rows:20},q).then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user})})}function addUser(){var user={name:self.userName,profile:{phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10),fio:self.userName},store:global.get("store").val._id};return $q.when().then(function(){return $user.checkPhoneForExist(user.profile.phone)}).then(function(res){if(res&&res.exist)throw"phone exist in base";if(user.email)return $user.checkEmailForExist(user.email);user.email=user.profile.phone+"@gmall.io"}).then(function(res){if(res&&res.exist)throw"email exist in base"}).then(function(){return $user.save(user).$promise}).then(function(res){user._id=res._id?res._id:res.id,self.user={_id:user._id,name:user.name,email:user.email,phone:user.profile.phone},addNewUser(self.user),self.addingUser=!1,self.userName="",self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function actived(){self.user=Object.assign({},entry.user),self.user.phone&&(self.splitPoint=self.user.phone.length-10,self.phoneCode="+"+self.user.phone.substring(0,self.splitPoint),self.user.phone=self.user.phone.substring(self.splitPoint)),self.mastersAdditional=global.get("masters").val.filter(function(m){return m._id!=self.entry.master._id})}function updateUser(){self.editingUser=!1;var o={_id:entry.user._id};return o["profile.phone"]=self.phoneCode.substring(1)+self.user.phone,o["profile.fio"]=self.user.name,o.email=self.user.email,update="profile.phone profile.fio email",$q.when().then(function(){if(o["profile.phone"])return $user.checkPhoneForExist(o["profile.phone"],entry.user._id);throw"phone is empty"}).then(function(res){if(res&&res.exist)throw"phone exist in base";if(o.email)return $user.checkEmailForExist(o.email,entry.user._id);o.email=o["profile.phone"]+"@gmall.io"}).then(function(res){if(res&&res.exist)throw"email exist in base"}).then(function(){return $user.save({update:update},o).$promise}).then(function(){entry.user=self.user,entry.user.phone=o["profile.phone"],saveField("user")}).catch(function(err){err&&exception.catcher("обновление данных")(err)})}function recordAgreed(user){delay||(delay=!0,$timeout(function(){delay=!1},2e3),entry.confirm=Date.now(),saveField("confirm"),Booking.sendMessage(entry,user))}function saveField(field){var o={_id:entry._id};o[field]=entry[field],Booking.save({update:field},o,function(err){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function changeDuration(){var delta=self.qty-self.entry.qty;if(delta<0){for(var i=self.entry.start+self.qty;i<self.entry.start+self.entry.qty;i++)self.master.entryTimeTable[i].busy=!1,delete self.master.entryTimeTable[i].entry,delete self.master.entryTimeTable[i].noBorder,console.log(i);self.entry.qty=self.qty,oldEntry.qty=self.qty,saveField("qty"),self.timeParts=_setTimeParts()}else{for(var start=self.entry.start+self.entry.qty,busy=!1,i=start;i<start+delta;i++)if(!self.master.entryTimeTable[i]||self.master.entryTimeTable[i].busy||self.master.entryTimeTable[i].out){busy=!0;break}if(busy)exception.catcher("изменение продолжительности")("недостаточно свободного времени"),self.qty=self.entry.qty;else{console.log(start,start+delta),self.master.entryTimeTable[start-1]&&(self.master.entryTimeTable[start-1].noBorder=!0);for(var i=start;i<start+delta;i++)console.log(i),self.master.entryTimeTable[i].busy=!0,self.master.entryTimeTable[i].entry=self.entry,self.master.entryTimeTable[i].noBorder=i<start+delta-1;self.entry.qty=self.qty,oldEntry.qty=self.qty,saveField("qty"),self.timeParts=_setTimeParts()}}}function changeStartPart(){var delta=self.entry.start-self.startPart,part={busy:!1,i:0,master:self.master._id};if(delta>0){for(var i=0;i<self.entry.qty;i++){var j=self.startPart+i;self.master.entryTimeTable[j]=self.master.entryTimeTable[j+delta],self.master.entryTimeTable[j].i=j}for(var i=self.startPart+self.entry.qty;i<self.startPart+self.entry.qty+delta;i++)self.master.entryTimeTable[i].busy&&self.master.entryTimeTable[i].entry&&self.master.entryTimeTable[i].entry._id==self.entry._id&&(self.master.entryTimeTable[i]=angular.copy(part),self.master.entryTimeTable[i].i=i)}else{for(var i=self.entry.qty;i>0;i--){var j=self.startPart+i-1;self.master.entryTimeTable[j]=self.master.entryTimeTable[j+delta],self.master.entryTimeTable[j].i=j}for(var i=self.entry.start;i<self.entry.start-delta;i++)self.master.entryTimeTable[i].busy&&self.master.entryTimeTable[i].entry&&self.master.entryTimeTable[i].entry._id==self.entry._id&&(self.master.entryTimeTable[i]=angular.copy(part),self.master.entryTimeTable[i].i=i)}self.entry.start=self.startPart,self.hour=parseInt(self.entry.start/4),self.minutes=15*(self.entry.start-4*self.hour),saveField("start")}function moveEntry(){self.entry.move=!self.entry.move,self.saveField("move"),self.entry.move&&$uibModalInstance.close()}function changeTimeFilter(p){return!(p.busy||p.part%delta)}function changeService(){self.service&&(entry.service={_id:self.service._id,name:self.service.name},self.service.backgroundcolor&&(entry.service.backgroundcolor=self.service.backgroundcolor),saveField("service"),entry.stuffName=self.service.name,saveField("name"),entry.stuffNameL=self.service.nameL,saveField("stuffNameL"),entry.stuffLink=self.service.link,saveField("stuffLink"))}var self=this;self.master=masters[entry.master],self.global=global,self.moment=moment,self.entry=entry;var currentDate=Booking.getDateStringFromEntry(entry,!0);self.dateEntry=moment(currentDate).format("LL")+","+moment(currentDate).format("dddd");var oldEntry=angular.copy(entry);self.qty=oldEntry.qty,self.remind=entry.remind,self.timeRemind=entry.timeRemind,self.hour=parseInt(entry.start/4),self.minutes=15*(entry.start-4*self.hour),self.timeRemindArr=timeRemindArr;var delta=0;if(global.get("store").val.seller&&global.get("store").val.seller.minDurationForService&&Number(global.get("store").val.seller.minDurationForService/15)){var delta=Number(global.get("store").val.seller.minDurationForService/15);1==delta&&(delta=0,console.log(delta)),self.timeDurationdArr=timeDurationdArr.filter(function(p){return!(p.part%delta)})}else self.timeDurationdArr=timeDurationdArr;self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38";var update="";self.updateUser=updateUser,self.recordAgreed=recordAgreed,self.saveField=saveField,self.changeDuration=changeDuration,self.changeStartPart=changeStartPart,self.moveEntry=moveEntry,self.timeParts=_setTimeParts(),self.changeTimeFilter=changeTimeFilter,self.addNewUser=addNewUser,self.refreshUsers=refreshUsers,self.deleteUser=deleteUser,self.addUser=addUser,self.changeService=changeService,self.startPart=oldEntry.start,actived();var delay;self.ok=function(){update="",$uibModalInstance.close({action:"save",update:update})},self.delete=function(){Confirm("удалить?").then(function(){$uibModalInstance.close({action:"delete"})})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{entry:function(){return entry},masters:function(){return masters}}}).result.then(function(action){resolve(action)},function(){reject()})})}function filterListServices(masters,items,selectedStuff){selectedStuff||(selectedStuff=[]),selectedStuff=selectedStuff.filter(function(s){return s});var stuffs=null,selectedMaster=masters.filter(function(m){return m.selected});stuffs=selectedMaster&&selectedMaster.length?selectedMaster[0].stuffs:masters.filter(function(m){return selectedStuff.length?(m.show=selectedStuff.every(function(s){return m.stuffs.indexOf(s._id)>-1}),m.show):(m.show=!0,!0)}).reduce(function(a,item){return Array.prototype.push.apply(a,item.stuffs),a},[]),selectedStuff&&selectedStuff.length&&masters.forEach(function(m){m.show=selectedStuff.every(function(s){return m.stuffs.indexOf(s._id)>-1})}),items.forEach(function(s){stuffs&&selectedMaster.length?stuffs.indexOf(s._id)>-1?s.show=!0:s.show=!1:s.show=!0})}function getDayOfYear(selectedMonth,day){return 1==selectedMonth?31+day:2==selectedMonth?60+day:3==selectedMonth?91+day:4==selectedMonth?121+day:5==selectedMonth?152+day:6==selectedMonth?182+day:7==selectedMonth?213+day:8==selectedMonth?244+day:9==selectedMonth?274+day:10==selectedMonth?305+day:11==selectedMonth?335+day:day}function getDaysOfMonth(x,y){return 28+(x+Math.floor(x/8))%2+2%x+Math.floor((1+(y%100+2)%(y%100+1)*(1-(y%4+2)%(y%4+1))+(1-(y%400+2)%(y%400+1)))/x)+Math.floor(1/x)-Math.floor(((y%100+2)%(y%100+1)*(1-(y%4+2)%(y%4+1))+(1-(y%400+2)%(y%400+1)))/x)}function selectService(items){return $uibModal.open({animation:!0,size:"lg",windowClass:"modalProject",templateUrl:"components/ORDERS/online/selectServiceInSite.html",controller:function($uibModalInstance,global,$timeout,items){var self=this;self.global=global,self.items=items,self.ok=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{items:function(){return items}}}).result}function getUsedTime(start,qty){var end=start+qty,h=Math.floor(start/4),m=15*(start-4*h)||"00",h1=Math.floor(end/4);return h+"."+m+" - "+h1+"."+(15*(end-4*h1)||"00")}function getBookingWeek(queryWeek,selectedMaster,datesOfWeeks,ngClickOnEntry,admin){var storeScheduleWeek=angular.copy(global.get("store").val.timeTable);return getList(paginate,queryWeek).then(function(data){selectedMaster.week={},datesOfWeeks.forEach(function(d,dayOfWeek){selectedMaster.week[d.date]={},selectedMaster.week[d.date].entryTimeTable=angular.copy(timeParts),selectedMaster.week[d.date].entryTimeTable.forEach(function(p,i){if(p.date=d.date,p.ngClickOnEntry=ngClickOnEntry,storeScheduleWeek){var j=dayOfWeek+1;6==dayOfWeek&&(j=0),(!storeScheduleWeek[j].is||p.i<4*storeScheduleWeek[j].start||p.i>=4*storeScheduleWeek[j].end)&&(p.out=!0)}selectedMaster.timeTable&&selectedMaster.timeTable[d.dayOfYear]&&(!selectedMaster.timeTable[d.dayOfYear].is||p.i<4*selectedMaster.timeTable[d.dayOfYear].s||p.i>=4*selectedMaster.timeTable[d.dayOfYear].e)&&(p.out=!0)})}),data.forEach(function(e){for(var master=selectedMaster,i=e.start;i<e.start+e.qty;i++)master.week[e.date].entryTimeTable[i].busy=!0,i==e.start&&(master.week[e.date].entryTimeTable[i].usedTime=getUsedTime(e.start,e.qty),master.week[e.date].entryTimeTable[i].userId=e.user._id,master.week[e.date].entryTimeTable[i].service=e.service.name,master.week[e.date].entryTimeTable[i].new=!0,master.week[e.date].entryTimeTable[i].qty=e.qty,master.week[e.date].entryTimeTable[i].used=e.used,master.week[e.date].entryTimeTable[i].confirm=e.confirm,admin&&(master.week[e.date].entryTimeTable[i].user=e.user)),master.week[e.date].entryTimeTable[i].setColor=e.setColor,i!=e.start&&(master.week[e.date].entryTimeTable[i].noBorder=!0),master.week[e.date].entryTimeTable[i].entry=e,!global.get("store").val.onlineReservation||e.status&&1==e.status||(master.week[e.date].entryTimeTable[i].reservation=!0),e.start})})}function getBookingWeekScheldule(queryWeek,selectedWorkplace,datesOfWeeks,services,masters,ngClickOnEntry){var storeScheduleWeek=angular.copy(global.get("store").val.timeTable);return getList(paginate,queryWeek).then(function(data){selectedWorkplace.week={},datesOfWeeks.forEach(function(d,dayOfWeek){selectedWorkplace.week[d.date]={},selectedWorkplace.week[d.date].entryTimeTable=angular.copy(timeParts),selectedWorkplace.week[d.date].entryTimeTable.forEach(function(p,i){if(p.date=d.date,p.ngClickOnEntry=ngClickOnEntry,storeScheduleWeek){var j=dayOfWeek+1;6==dayOfWeek&&(j=0),(!storeScheduleWeek[j].is||p.i<4*storeScheduleWeek[j].start||p.i>=4*storeScheduleWeek[j].end)&&(p.out=!0)}})}),data.forEach(function(e){var serviseLink=null;if(e.service&&e.service._id&&services){var sTemp=services.getOFA("_id",e.service._id);sTemp&&(serviseLink=sTemp.link)}var masterLink=null,masterName="";if(e.master&&masters){var mTemp=masters.getOFA("_id",e.master);mTemp&&(masterLink="/master/"+mTemp.url,masterName=mTemp.name)}for(var workplace=selectedWorkplace,i=e.start;i<e.start+e.qty;i++)workplace.week[e.date].entryTimeTable[i].busy=!0,i==e.start&&(workplace.week[e.date].entryTimeTable[i]._id=e._id,workplace.week[e.date].entryTimeTable[i].usedTime=getUsedTime(e.start,e.qty),workplace.week[e.date].entryTimeTable[i].userId=e.user._id,workplace.week[e.date].entryTimeTable[i].service=e.service.name,workplace.week[e.date].entryTimeTable[i].serviceLink=serviseLink,workplace.week[e.date].entryTimeTable[i].masterLink=masterLink,workplace.week[e.date].entryTimeTable[i].masterName=masterName,e.masters&&e.masters.length&&(workplace.week[e.date].entryTimeTable[i].masters=e.masters.map(function(m){return masters.getOFA("_id",m)})),workplace.week[e.date].entryTimeTable[i].new=!0,workplace.week[e.date].entryTimeTable[i].qty=e.qty,workplace.week[e.date].entryTimeTable[i].used=e.used,workplace.week[e.date].entryTimeTable[i].confirm=e.confirm,workplace.week[e.date].entryTimeTable[i].comment=e.comment,workplace.week[e.date].entryTimeTable[i].zIndex=1),workplace.week[e.date].entryTimeTable[i].setColor=e.setColor,e.service.backgroundcolor?workplace.week[e.date].entryTimeTable[i].backgroundcolor=e.service.backgroundcolor:workplace.week[e.date].entryTimeTable[i].backgroundcolor=null,i!=e.start&&(workplace.week[e.date].entryTimeTable[i].noBorder=!0),workplace.week[e.date].entryTimeTable[i].entry=e,!global.get("store").val.onlineReservation||e.status&&1==e.status||(workplace.week[e.date].entryTimeTable[i].reservation=!0)})})}function getWeeksRange(today){today||(today=new Date);var weeksRange=[{},{},{},{},{},{},{}];return weeksRange.forEach(function(el,i){if(i){var date=new Date(today);date.setTime(date.getTime()+7*i*864e5),date.setHours(0)}else var date=today;var datesOfWeeks=getDatesForWeek(date);el.startDate=datesOfWeeks[0].d,el.startDateString=moment(datesOfWeeks[0].d).format("DD MMM"),el.endDate=datesOfWeeks[6].d,el.endDateString=moment(datesOfWeeks[6].d).format("DD MMM")}),weeksRange}function scheduleTransfer(){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/scheduleTransfer.html",controller:function(global,$uibModalInstance,Booking,$timeout,exception){var self=this;self.global=global,self.moment=moment,self.paginate={};var startdate=moment().subtract(42,"days"),td=new Date(startdate);self.weeksFrom=getWeeksRange(td),self.weeksFrom.forEach(function(el){el.date=el.startDateString+"/"+el.endDateString});var addDate=moment().add(7,"days"),addDate=moment().add(0,"days"),tdAdd=new Date(addDate);self.weeksTo=getWeeksRange(tdAdd),self.weeksTo.forEach(function(el){el.date=el.startDateString+"/"+el.endDateString}),self.ok=function(){if(!self.weekFrom||!self.weekTo)return void exception.catcher("ошибка")("не выбрана неделя");self.disabled=!0;var date=new Date(self.weekFrom.startDate);self.datesOfWeeks=Booking.getDatesForWeek(date),self.queryWeek={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},"user.name":"schedule"};var dataFrom,dataTo;return Booking.getList(self.paginate,self.queryWeek).then(function(data){return data&&data.length&&data.shift(),dataFrom=data,date=new Date(self.weekTo.startDate),self.datesOfWeeks=Booking.getDatesForWeek(date),self.queryWeek={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},"user.name":"schedule"},Booking.getList(self.paginate,self.queryWeek)}).then(function(data){data&&data.length&&data.shift(),dataTo=data;var acts=[];return data.forEach(function(d){var delEntryPromise=Booking.delete({_id:d._id});acts.push(delEntryPromise.$promise)}),$q.all(acts)}).then(function(){var start=moment(self.weekFrom.startDate),end=moment(self.weekTo.startDate),daysDelta=end.diff(start,"days"),acts=[];return dataFrom.forEach(function(d){delete d._id,delete d.__v,d.users=[];var newDate=getDateFromEntry(d);newDate.setDate(newDate.getDate()+daysDelta);var month=newDate.getMonth(),day=newDate.getDate(),year=newDate.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),d.date="date"+year+month+day;var newEntryPromise=Booking.save(d);acts.push(newEntryPromise.$promise)}),$q.all(acts)}).then(function(res){$uibModalInstance.close()}).catch(function(err){$uibModalInstance.close(err)});var date,date},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(){resolve()},function(){reject()})})}for(var Items=$resource("/api/collections/Booking/:_id",{_id:"@_id"}),timeRemindArr=timeRemindArrLang.map(function(el){return{time:el[global.get("store").val.lang],part:el.part}}),timeDurationdArr=timeDurationArrLang.map(function(el){return{time:el[global.get("store").val.lang],part:el.part}}),timeParts=[],i=0;i<96;i++)timeParts.push({busy:!1,i:i})
;var timeTable=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],timeTable15min=["00:00","00:15","00:30","00:45","01:00","01:15","01:30","01:45","02:00","02:15","02:30","02:45","03:00","03:15","03:30","03:45","04:00","04:15","04:30","04:45","05:00","05:15","05:30","05:45","06:00","06:15","06:30","06:45","07:00","07:15","07:30","07:45","08:00","08:15","08:30","08:45","09:00","09:15","09:30","09:45","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30","13:45","14:00","14:15","14:30","14:45","15:00","15:15","15:30","15:45","16:00","16:15","16:30","16:45","17:00","17:15","17:30","17:45","18:00","18:15","18:30","18:45","19:00","19:15","19:30","19:45","20:00","20:15","20:30","20:45","21:00","21:15","21:30","21:45","22:00","22:15","22:30","22:45","23:00","23:15","23:30","23:45"],paginate={page:0,rows:500,totalItems:0};return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,timeTable:timeTable,timeTable15min:timeTable15min,timeParts:timeParts,startTimeParts:36,endTimeParts:72,newBooking:newBooking,editBooking:editBooking,filterListServices:filterListServices,timeRemindArr:timeRemindArr,getDayOfYear:getDayOfYear,getDaysOfMonth:getDaysOfMonth,sendMessage:sendMessage,getDateStringFromEntry:getDateStringFromEntry,getDateFromEntry:getDateFromEntry,getDateFromStrDateEntry:getDateFromStrDateEntry,getDatesForWeek:getDatesForWeek,selectService:selectService,getCheckOutLiqpayHtml:getCheckOutLiqpayHtml,getUsedTime:getUsedTime,getBookingWeek:getBookingWeek,getBookingWeekScheldule:getBookingWeekScheldule,getWeeksRange:getWeeksRange,scheduleTransfer:scheduleTransfer}}function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/createMaster.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}function selectService(master,timePart){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/selectService.html",controller:function($uibModalInstance,global,$user,UserEntry,exception,master,timePart){function selectUser(user){self.user=user,self.users=null}function refreshUsers(phone){phone.length<3||(self.oldPhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{phone:phone},{name:phone},{email:phone}]};UserEntry.getList({page:0,rows:20},q).then(function(res){self.users=res})}function clearUser(){self.user=null}function addUser(){console.log("add user");self.userName,self.userEmail,self.phoneCode.substring(1),self.oldPhone.substring(0,10)}function allFieldCheck(){return!self.services.length||!self.user}function checkNameNewUser(){return!self.userName||self.userName.length<3}var self=this;self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",self.hour=parseInt(timePart/4),self.minutes=15*(timePart-4*self.hour),self.timeRemindArr=timeRemindArr,master.services.forEach(function(s){s.used=!1}),self.userName="",self.master=master,self.oldPhone="",self.services=[];self.selectUser=selectUser,self.searchUser=searchUser,self.clearUser=clearUser,self.allFieldCheck=allFieldCheck,self.addUser=addUser,self.checkNameNewUser=checkNameNewUser,self.refreshUsers=refreshUsers,self.ok=function(){var item={services:self.services,user:{_id:self.user._id,name:self.user.name,phone:self.user.phone,email:self.user.email},remind:self.remind,timeRemind:self.timeRemind};$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{master:function(){return master},timePart:function(){return timePart}}}).result.then(function(item){resolve(item)},function(){reject()})})}function editEntry(master,entry,saveFoo){return $q(function(resolve,reject){$uibModal.open({animation:!0,size:"lg",templateUrl:"components/ORDERS/online/editOnline.html",controller:function($uibModalInstance,$user,UserEntry,master,entry){function actived(){self.user=Object.assign({},entry.user),self.splitPoint=self.user.phone.length-10,self.phoneCode="+"+self.user.phone.substring(0,self.splitPoint),self.user.phone=self.user.phone.substring(self.splitPoint)}function updateUser(){self.editingUser=!1;var o={_id:entry.user._id};o.phone=self.phoneCode.substring(1)+self.user.phone,o.name=self.user.name,o.email=self.user.email;var update="";"+"+entry.user.phone.substring(0,self.splitPoint)!=self.phoneCode?update="phone":entry.user.phone.substring(self.splitPoint)!=self.user.phone&&(update="phone"),entry.user.name!=self.user.name&&(update+=update?" name":"name"),entry.user.email!=self.user.email&&(update+=update?" email":"email"),UserEntry.save({update:update},o,function(){entry.user=o,actived()})}function changeDuration(){console.log(self.entry,master)}console.log(entry);var self=this;self.master=master,self.entry=entry,self.remind=entry.remind,self.timeRemind=entry.timeRemind,self.hour=parseInt(entry.start/4),self.minutes=15*(entry.start-4*self.hour),self.timeRemindArr=timeRemindArr,self.timeDuration=timeDuration,console.log(self.timeDuration),self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",self.updateUser=updateUser,self.changeDuration=changeDuration,actived(),self.ok=function(){entry.remind=self.remind,entry.timeRemind=self.timeRemind,$uibModalInstance.close("save")},self.delete=function(){$uibModalInstance.close("delete")},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{master:function(){return master},entry:function(){return entry}}}).result.then(function(action){resolve(action)},function(){reject()})})}function filterListServices(masters,items,selectedStuff){console.log(masters);var stuffs=null;stuffs=masters.filter(function(m){return selectedStuff.length?(m.show=selectedStuff.every(function(s){return m.stuffs.indexOf(s._id)>-1}),m.show):(m.show=!0,!0)}).reduce(function(a,item){return a.extend(item.stuffs),a},[]),console.log(stuffs),items.forEach(function(item){item.stuffs.forEach(function(s){stuffs?stuffs.indexOf(s._id)>-1?s.hide=!1:s.hide=!0:s.hide=!1}),console.log(item)})}for(var Items=$resource("/api/collections/Online/:_id",{_id:"@_id"}),timeRemindArr=[{time:"полчаса",part:2},{time:"час",part:4},{time:"два часа",part:8},{time:"три часа",part:12}],timeDuration=[{time:"15 мин",part:1},{time:"полчаса",part:2},{time:"45 мин",part:3},{time:"час",part:4},{time:"1 час 30 мин",part:6},{time:"два часа",part:8},{time:"два часа 30 мин",part:10},{time:"три часа",part:12},{time:"четыре часа",part:16}],timeParts=[],i=0;i<96;i++)timeParts.push({busy:!1,i:i});var timeTable=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],timeTable15min=["00:00","00:15","00:30","00:45","01:00","01:15","01:30","01:45","02:00","02:15","02:30","02:45","03:00","03:15","03:30","03:45","04:00","04:15","04:30","04:45","05:00","05:15","05:30","05:45","06:00","06:15","06:30","06:45","07:00","07:15","07:30","07:45","08:00","08:15","08:30","08:45","09:00","09:15","09:30","09:45","10:00","10:15","10:30","10:45","11:00","11:15","11:30","11:45","12:00","12:15","12:30","12:45","13:00","13:15","13:30","13:45","14:00","14:15","14:30","14:45","15:00","15:15","15:30","15:45","16:00","16:15","16:30","16:45","17:00","17:15","17:30","17:45","18:00","18:15","18:30","18:45","19:00","19:15","19:30","19:45","20:00","20:15","20:30","20:45","21:00","21:15","21:30","21:45","22:00","22:15","22:30","22:45","23:00","23:15","23:30","23:45"];return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create,editEntry:editEntry,selectService:selectService,timeTable:timeTable,timeTable15min:timeTable15min,timeParts:timeParts,startTimeParts:36,endTimeParts:72,filterListServices:filterListServices}}angular.module("gmall.services").service("Online",serviceFoo).service("Booking",serviceBooking).directive("reminderOnline",function(){return{templateUrl:"components/ORDERS/online/reminderOnline.html"}}),serviceBooking.$inject=["$resource","$uibModal","$q","global","$http","exception"],serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function listDirective(global){return{scope:{},bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:function(){return global.get("mobile").val?"components/ORDERS/online/onlineListMobile.html":"components/ORDERS/online/onlineList.html"}}}function sheduleDirective(global){return{scope:{},bindToController:!0,controller:scheduleCtrl,controllerAs:"$ctrl",templateUrl:function(){return global.get("mobile").val?"components/ORDERS/online/scheduleMobile.html":"components/ORDERS/online/schedule.html"}}}function sheduleEntryDirective(global){return{scope:{},bindToController:!0,controller:scheduleEntryCtrl,controllerAs:"$ctrl",templateUrl:function(){return global.get("mobile").val?"components/ORDERS/online/scheduleEntryMobile.html":"components/ORDERS/online/scheduleEntry.html"}}}function listCtrl($scope,Booking,Master,Stuff,$rootScope,global,Confirm,$q,exception,socket,$timeout,Label){function getMastersFilterList(item){return self.label?item.labels&&item.labels.length&&item.labels.indexOf(self.label._id)>-1?item:void 0:item}function changeLabel(label){self.label=label?label:null}function filterServices(item){return!item.hide}function selectStuff(item){self.selectedStuff=item?[item]:[],self.selectedMaster=null,Booking.filterListServices(self.masters,self.items,self.selectedStuff),$scope.mastersRepeatDone&&"function"==typeof $scope.mastersRepeatDone&&$scope.mastersRepeatDone()}function selectMaster(master){self.selectedStuff=[],self.selStuff=null,self.masters.forEach(function(m){master&&m._id!=master._id?m.show=!1:m.show=!0}),$scope.mastersRepeatDone&&"function"==typeof $scope.mastersRepeatDone&&$scope.mastersRepeatDone(),self.selectedMaster&&activateMasterWeek()}function getMasters(){return $q.when().then(function(){return Master.getList()}).then(function(data){self.masters=data.map(function(m){return m.stuffs||(m.stuffs=[]),m}).filter(function(m){return m.stuffs.length&&m.actived})}).catch(function(err){exception.catcher("получение списка мастеров")(err)})}function getBooking(){return self.Items.getList(self.paginate,self.query).then(function(data){console.log("data",data),self.mastersO={},self.masters.forEach(function(m){m.entryTimeTable=angular.copy(self.timeParts),m.entryTimeTable.forEach(function(p){p.master=m._id,self.dayOff?p.out=!0:m.timeTable&&m.timeTable[self.currentDayOfYear]&&(!m.timeTable[self.currentDayOfYear].is||p.i<4*m.timeTable[self.currentDayOfYear].s||p.i>=4*m.timeTable[self.currentDayOfYear].e)&&(p.out=!0)}),m.timeTable&&m.timeTable[self.currentDayOfYear]?(m.masterSchedule=angular.copy(m.timeTable[self.currentDayOfYear]),m.masterSchedule.s*=4,m.masterSchedule.e*=4):self.storeSchedule?m.masterSchedule=self.storeSchedule:m.masterSchedule={},self.mastersO[m._id]=m}),setBookingDataInMasters(data)})}function setBookingDataInMasters(booking){masters=self.masters.reduce(function(o,item){return o[item._id]=item,o},{}),booking.forEach(function(e){var master=masters[e.master];if(master)for(var i=e.start;i<e.start+e.qty;i++)master.entryTimeTable[i].busy=!0,i==e.start&&(master.entryTimeTable[i].user=e.user.name,master.entryTimeTable[i].phone=e.user.phone,master.entryTimeTable[i].email=e.user.email||"",master.entryTimeTable[i].service=e.service.name,master.entryTimeTable[i].new=!0,master.entryTimeTable[i].qty=e.qty,master.entryTimeTable[i].used=e.used,master.entryTimeTable[i].confirm=e.confirm,master.entryTimeTable[i].comment=e.comment),i!=e.start&&(master.entryTimeTable[i].noBorder=!0),master.entryTimeTable[i].entry=e,!global.get("store").val.onlineReservation||e.status&&1==e.status||(master.entryTimeTable[i].reservation=!0)})}function getServices(){return $q.when().then(function(){return Stuff.getServicesForOnlineEntry()}).then(function(res){return res.forEach(function(s){s.duration=15*s.timePart,s.currency||(s.currency=global.get("store").val.mainCurrency),s.currencyName=global.get("store").val.currency&&global.get("store").val.currency[s.currency]&&global.get("store").val.currency[s.currency][2]?global.get("store").val.currency[s.currency][2]:s.currency}),self.items=res}).catch(function(err){exception.catcher("получение списка услуг")(err)})}function setServicesInMasters(){self.masters.forEach(function(m){m.services=m.stuffs.map(function(s){for(var i=0;i<self.items.length;i++)if(self.items[i]._id==s)return self.items[i];return null},[]).filter(function(i){return i})})}function newBooking(master,part,week){function getPromise(e){return Booking.save(e).$promise}if(part.out)return void console.log("out");var entry,val=part.i,start=val,entries=[];if(week)var entryTimeTable=master.week[part.date].entryTimeTable;else var entryTimeTable=master.entryTimeTable;return entryTimeTable[val].busy?editBooking(entryTimeTable[val].entry,val):$q.when().then(function(){if(week){var dd=Booking.getDateFromStrDateEntry(part.date);return Booking.newBooking(master,val,self.selectedStuff,dd,part.date,start)}return Booking.newBooking(master,val,self.selectedStuff,self.date,self.query.date,start)}).then(function(entryLocal){if(console.log(entryLocal),entryLocal){entry=entryLocal;for(var timePart=entry.services.reduce(function(t,item){return t+item.timePart},0),i=0+val;i<timePart+val;i++)if(entryTimeTable[i].busy)throw"Не хватает времени";entry.services.forEach(function(s,i){var o={date:self.query.date,master:master._id,masterNameL:master.nameL,masterName:master.name,masterUrl:master.url,masters:entry.masters,start:val,qty:s.timePart,service:{_id:s._id,name:s.name},stuffName:s.name,stuffNameL:s.nameL,stuffLink:s.link,paySum:s.price||0,currency:s.currency||global.get("store").val.mainCurrency,user:entry.user,tz:tz,setColor:entry.setColor};s.backgroundcolor&&(o.service.backgroundcolor=s.backgroundcolor),week&&(o.date=part.date),s.priceSale&&(o.price=s.priceSale),0==i&&entry.remind&&entry.timeRemind&&(o.remind=entry.remind,o.timeRemind=entry.timeRemind),entries.push(o);for(var i=0+val;i<s.timePart+val;i++)entryTimeTable[i].busy=!0,i==val&&(entryTimeTable[i].service=s.name,entryTimeTable[i].user=entry.user.name,entryTimeTable[i].noBorder=!0);val+=s.timePart});var actions=[];return entries.forEach(function(e){actions.push(getPromise(e))}),$q.all(actions)}}).then(function(){if(console.log("getBooking"),console.log("self.selectedMaster",self.selectedMaster),self.selectedMaster)return Booking.getBookingWeek(self.queryWeek,self.selectedMaster,self.datesOfWeeks,ngClickOnEntry,!0);getBooking()}).catch(function(err){err&&exception.catcher("запись на время")(err)})}function editBooking(entry,val){return $q.when().then(function(){return Booking.editBooking(entry,masters)}).then(function(res){return console.log(res),res&&"delete"==res.action?Booking.delete({_id:entry._id}).$promise:res&&"save"==res.action&&res.update?Booking.save({update:res.update},entry).$promise:void 0}).then(function(){console.log("?????"),getBooking(),self.selectedMaster&&self.selectMaster(self.selectedMaster)}).catch(function(err){err&&exception.catcher(action)(err)})}function changeDate(){self.date||(self.date=new Date);var date=new Date(self.date);changeStartEndTimeParts(date);var month=date.getMonth(),day=date.getDate(),year=date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.query={date:"date"+year+month+day},getBooking(),self.selectedMaster&&(self.slideMasterWeekArry[0].active=!0,changeWeek(0))}function changeStartEndTimeParts(date){date||(date=self.date);var dayOfWeek=date.getDay(),month=date.getMonth(),day=date.getDate();self.currentDayOfYear=Booking.getDayOfYear(month,day-1),self.storeSchedule=angular.copy(global.get("store").val.timeTable[dayOfWeek]),self.dayOff=!self.storeSchedule||!self.storeSchedule.is;var start=self.storeSchedule&&self.storeSchedule.start?self.storeSchedule.start:6,end=self.storeSchedule&&self.storeSchedule.end?self.storeSchedule.end:20;if(self.startTimeParts=4*start,self.endTimeParts=4*end,self.startTimePartsWeek=self.startTimeParts,self.startTimePartsWeek=self.endTimeParts,global.get("store").val.timeTable){self.storeScheduleWeek=angular.copy(global.get("store").val.timeTable),start=10,end=15;for(var dayOfWeek in global.get("store").val.timeTable)global.get("store").val.timeTable[dayOfWeek].start<start&&(start=global.get("store").val.timeTable[dayOfWeek].start),global.get("store").val.timeTable[dayOfWeek].end>end&&(end=global.get("store").val.timeTable[dayOfWeek].end);self.startTimePartsWeek=4*start,self.endTimePartsWeek=4*end}}function filterTimePart(part){return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function filterTimePartForMaster(part){return partsArray.indexOf(part.i)>-1&&part.i>=self.startTimeParts&&part.i<self.endTimeParts}function changeActiveSlide(index,swipe){self.masters[index].active=!0,console.log(index,swipe)}function activateMasterWeek(){changeWeek(0)}function changeWeek(week){setWeekDates(week),self.tempEntry=null,$q.when().then(function(){return Booking.getBookingWeek(self.queryWeek,self.selectedMaster,self.datesOfWeeks,ngClickOnEntry,!0)}).then(function(){self.slideMasterWeekArry[0].active=!0})}function setWeekDates(week){if(self.week=week,week){var date=new Date(self.date);date.setTime(date.getTime()+7*week*864e5),date.setHours(0)}else var date=self.date;if(self.datesOfWeeks)for(var t=Booking.getDatesForWeek(date),i=0;i<t.length;i++)self.datesOfWeeks[i]=t[i];else self.datesOfWeeks=Booking.getDatesForWeek(date);try{self.currentMonth=moment(date).format("MMMM")}catch(err){}self.currentDayOfWeek=self.td.getDay(),0==self.currentDayOfWeek&&(self.currentDayOfWeek=7),self.currentDayOfWeek--,week&&self.currentDayOfWeek,self.queryWeek={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},master:self.selectedMaster._id},self.weeksRange=Booking.getWeeksRange(),console.log(self.weeksRange)}function getDateObj(dateStr){if(dateStr){var year=dateStr.substring(4,8),month=dateStr.substring(8,10),day=dateStr.substring(10);try{var date=new Date(year,month,day);return moment(date).format("ddd")+"/"+day}catch(err){return console.log(err),"error handle date"}}}function ngClickOnEntry(date,index){var item=this;$q.when().then(function(){return newBooking(self.selectedMaster,item,!0)}).then(function(){}).catch(function(){getBooking()})}function filterTimePartWeek(part){return part.i>=self.startTimePartsWeek&&part.i<self.endTimePartsWeek}function filterTimePartForMasterWeek(part){return partsArray.indexOf(part.i)>-1&&part.i>=self.startTimePartsWeek&&part.i<self.endTimePartsWeek}function scheduleTransfer(){Booking.scheduleTransfer().then(function(err){err?exception.catcher("перенос расписания")(err):exception.showToaster("info","перенос расписания","Ok"),getBooking()})}var self=this;self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.$state=$rootScope.$state,self.Items=Booking,self.onlineEntr={},self.date=new Date,self.td=new Date;var tz=self.date.getTimezoneOffset()/60,month=self.date.getMonth(),day=self.date.getDate(),year=self.date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.query={date:"date"+year+month+day},self.paginate={page:0,rows:500,totalItems:0},self.timeParts=Booking.timeParts,self.startTimeParts=Booking.startTimeParts,self.endTimeParts=Booking.endTimeParts,self.timeTable=Booking.timeTable,self.timeTable15min=Booking.timeTable15min,self.minDurationForService=global.get("store").val.seller.minDurationForService||15;var delta=0;switch(self.minDurationForService){case 30:delta=1;break;case 60:delta=3;break;case 90:delta=5;break;case 120:delta=7;break;default:delta=0}self.timePartsForTable=[];for(var partsArray=[],i=0;i<96;i=i+1+delta)self.timePartsForTable.push(Booking.timeParts[i]),partsArray.push(i);self.slideMasterWeekArry=[{id:0,active:!1},{id:1,active:!1},{id:2,active:!1},{id:3,active:!1},{id:4,active:!1},{id:5,active:!1},{id:6,active:!1}],self.items=[],self.selectedStuff=[],self.selectedMaster,self.newItem={};var masters;self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD.MM.YY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,autoUpdateInput:!0,autoapply:!0,eventHandlers:{"apply.daterangepicker":function(ev,picker){changeDate()}}};var dtt=new Date;self.datePickerOptions={formatYear:"yy",maxDate:dtt.setDate(dtt.getDate()+90),startingDay:1},self.newBooking=newBooking,self.changeDate=changeDate,self.filterServices=filterServices,self.selectStuff=selectStuff,self.selectMaster=selectMaster,self.filterTimePart=filterTimePart,self.filterTimePartForMaster=filterTimePartForMaster,self.changeActiveSlide=changeActiveSlide,self.changeWeek=changeWeek,self.setWeekDates=setWeekDates,self.getDateObj=getDateObj,self.filterTimePartWeek=filterTimePartWeek,self.filterTimePartForMasterWeek=filterTimePartForMasterWeek,self.scheduleTransfer=scheduleTransfer,self.changeLabel=changeLabel,self.getMastersFilterList=getMastersFilterList,function(){socket.on("newRecordOnSite",function(){console.log("newRecordOnSite"),$timeout(function(){getBooking()},1e3)}),$scope.$on("time_is_buzy",function(){console.log("time_is_buzy"),getBooking()}),changeStartEndTimeParts(),$q.when().then(function(){return getMasters()}).then(function(){return Label.getList({},{})}).then(function(labels){if(self.labels=labels.filter(function(l){return"master"==l.list}),console.log(self.labels),$rootScope.$stateParams&&$rootScope.$stateParams.id){var m=self.masters.getOFA("_id",$rootScope.$stateParams.id);if(!m)throw self.masters=null,"master doesn't match";self.hideMastersList=m}return getBooking()}).then(function(){return getServices()}).then(function(){return Booking.filterListServices(self.masters,self.items,self.selectedStuff)}).then(function(){setServicesInMasters()}).then(function(){self.hideMastersList&&selectMaster(self.hideMastersList),$rootScope.$stateParams.type&&"master"===$rootScope.$stateParams.type&&self.masters&&self.masters[0]&&(self.selectedMaster=self.masters[0],self.selectMaster(self.selectedMaster))}).catch(function(err){exception.catcher("инициализация")(err)})}()}function scheduleCtrl($scope,Booking,Master,Stuff,$rootScope,global,Confirm,$q,exception,socket,$state,Workplace,$timeout){function setWeekDates(week){if(self.week=week,week){var date=new Date(self.td);date.setTime(date.getTime()+7*week*864e5),date.setHours(0)}else var date=self.td;self.datesOfWeeks=Booking.getDatesForWeek(date);try{self.currentMonth=moment(date).format("MMMM")}catch(err){}self.currentDayOfWeek=self.date.getDay(),0==self.currentDayOfWeek&&(self.currentDayOfWeek=7),self.currentDayOfWeek--,week&&self.currentDayOfWeek,self.query={date:{$in:self.datesOfWeeks.map(function(item){return item.date})},master:self.masterId}}function changeWeek(week){setWeekDates(week),self.tempEntry=null,$q.when().then(function(){return getBooking()})}function getWorkplaces(){return $q.when().then(function(){return Workplace.getList(null,{})}).then(function(data){self.workplaces=data}).catch(function(err){exception.catcher("получение списка рабочих мест")(err)})}function getMasters(){return $q.when().then(function(){return global.get("masters").val}).then(function(data){self.masters=data}).catch(function(err){exception.catcher("получение списка мастеров")(err)})}function getBooking(){Booking.getBookingWeekScheldule(self.query,self.selectedWorkplace,self.datesOfWeeks,self.items,self.masters,ngClickOnEntry).then(function(data){})}function getServices(){return $q.when().then(function(){return Stuff.getServicesForOnlineEntry()}).then(function(res){return global.set("services",res),self.items=res.map(function(s){return s.duration=15*s.timePart,s.currency||(s.currency=global.get("store").val.mainCurrency),s.currencyName=global.get("store").val.currency&&global.get("store").val.currency[s.currency]&&global.get("store").val.currency[s.currency][2]?global.get("store").val.currency[s.currency][2]:s.currency,s})}).catch(function(err){console.log(err),exception.catcher("получение списка услуг")(err)})}function changeDate(){self.date||(self.date=new Date);var date=new Date(self.date);changeStartEndTimeParts(date);var month=date.getMonth(),day=date.getDate(),year=date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.query={date:"date"+year+month+day},getBooking()}function changeStartEndTimeParts(date){date||(date=self.date);var dayOfWeek=date.getDay(),month=date.getMonth(),day=date.getDate();if(self.currentDayOfYear=Booking.getDayOfYear(month,day-1),global.get("store").val.timeTable){self.storeSchedule=angular.copy(global.get("store").val.timeTable),self.dayoff=!self.storeSchedule[dayOfWeek]||!self.storeSchedule[dayOfWeek].is;var start=self.storeSchedule[dayOfWeek]&&self.storeSchedule[dayOfWeek].start?self.storeSchedule[dayOfWeek].start:6,end=self.storeSchedule[dayOfWeek]&&self.storeSchedule[dayOfWeek].end?self.storeSchedule[dayOfWeek].end:20;self.startTimeParts=4*start,self.endTimeParts=4*end;for(dayOfWeek in global.get("store").val.timeTable)global.get("store").val.timeTable[dayOfWeek].start<start&&(start=global.get("store").val.timeTable[dayOfWeek].start),global.get("store").val.timeTable[dayOfWeek].end>end&&(end=global.get("store").val.timeTable[dayOfWeek].end);self.startTimeParts=4*start,self.endTimeParts=4*end}}function filterTimePart(part){return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function filterTimePartForMaster(part){if(!(self.timePartsI.indexOf(part.i)<0))return part.i>=self.startTimeParts&&part.i<self.endTimeParts}function getDateObj(dateStr){var year=dateStr.substring(4,8),month=dateStr.substring(8,10),day=dateStr.substring(10);try{var date=new Date(year,month,day);return moment(date).format("ddd")+"/"+day}catch(err){return console.log(err),"error handle date"}}function disabledTimePart(part,index){if(!self.week&&index==self.currentDayOfWeek){var d=new Date,h=d.getHours(),p=Math.ceil(d.getMinutes()/15)-1;if(part.i-4*h+p<4)return!0}}function scheduleTransfer(){Booking.scheduleTransfer().then(function(err){err?exception.catcher("перенос расписания")(err):exception.showToaster("info","перенос расписания","Ok"),getBooking()})}function ngClickOnEntry(date){return void console.log("data",date)}var self=this;self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.$state=$rootScope.$state,self.Items=Booking,self.onlineEntr={},self.date=new Date,self.td=new Date,self.td.setTime(self.td.getTime()-18144e5),self.td.setHours(0);var d;self.datesFoeWeeks=[];for(var i=0;i<=7;i++)d=new Date(self.date),d.setTime(d.getTime()+7*i*864e5),d.setHours(0),self.datesFoeWeeks.push(d);var month=(self.date.getTimezoneOffset(),self.date.getMonth()),day=self.date.getDate();self.date.getFullYear();month<10&&(month="0"+month),day<10&&(day="0"+day),self.week=3,self.noWrapSlides=!0,self.minDurationForService=global.get("store").val.seller.minDurationForService||15;var delta=0;switch(self.minDurationForService){case 30:delta=1;break;case 60:delta=3;break;case 90:delta=5;break;case 120:delta=7;break;default:delta=0}self.timeParts=Booking.timeParts,self.timePartsForTable=[],self.timePartsI=[];for(var i=0;i<96;i=i+1+delta)self.timePartsForTable.push(Booking.timeParts[i]),self.timePartsI.push(i);self.startTimeParts=Booking.startTimeParts,self.endTimeParts=Booking.endTimeParts,self.timeTable=Booking.timeTable,self.timeTable15min=Booking.timeTable15min,self.paginate={page:0,rows:100,totalItems:0},self.items=[],self.selectedStuff=[],self.selectedMaster,self.newItem={};var dtt=new Date;self.datePickerOptions={formatYear:"yy",maxDate:dtt.setDate(dtt.getDate()+30),startingDay:1},self.slides=[{i:0},{i:1},{i:2},{i:3},{i:4},{i:5},{i:6},{i:7},{i:8},{i:9},{i:10},{i:11}],self.changeDate=changeDate,self.filterTimePart=filterTimePart,self.filterTimePartForMaster=filterTimePartForMaster,self.getDateObj=getDateObj,self.changeWeek=changeWeek,self.disabledTimePart=disabledTimePart,self.scheduleTransfer=scheduleTransfer,function(){socket.on("newRecordOnSite",function(){console.log("newRecordOnSite"),$timeout(function(){getBooking()},1e3)}),changeStartEndTimeParts(),setWeekDates(0),self.weeksRange=Booking.getWeeksRange(self.td),$q.when().then(function(){return getWorkplaces()}).then(function(){return getMasters()}).then(function(){return getServices()}).then(function(){return self.placeId&&(self.selectedWorkplace=angular.copy(self.workplaces.getOFA("_id",self.placeId))),self.selectedWorkplace?self.query.workplace=self.selectedWorkplace._id:self.selectedWorkplace={},self.query["user._id"]="schedule",getBooking()}).then(function(){$timeout(function(){self.slides[3].active=!0},1e3)}).catch(function(err){console.log(err),exception.catcher("инициализация")(err)})}(),$scope.$watch(function(){for(var i=0;i<self.slides.length;i++)if(self.slides[i].active)return self.slides[i]},function(currentWeek,previousWeek){currentWeek&&previousWeek&&(console.log("getBooking"),changeWeek(currentWeek.i))})}function scheduleEntryCtrl($scope,Booking,Master,Stuff,$rootScope,global,Confirm,$q,exception,socket,$state,Workplace,$timeout){function recordAgreed(user){delay||(delay=!0,$timeout(function(){delay=!1},2e3),user.confirm=Date.now(),saveField("users",self.entry.users),Booking.sendMessage(self.entry,user))}function saveField(field,data){var o={_id:self.entry._id};o[field]=data?data:self.entry[field],Booking.save({update:field},o,function(err){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function deleteItem(item){$q.when().then(function(){return Booking.delete({_id:item._id}).$promise}).then(function(){$state.go("frame.schedule")})}var self=this;self.moment=moment,self.mobile=global.get("mobile").val,self.global=global,self.$state=$rootScope.$state,self.Items=Booking;var entryId=$rootScope.$stateParams.id;self.recordAgreed=recordAgreed,self.saveField=saveField,self.deleteItem=deleteItem,function(id){self.Items.getItem(id).then(function(data){data.user&&"schedule"!=data.user._id&&(data.user.pay=data.pay,data.user.confirm=data.confirm,data.users=[data.user]),console.log(data),self.entry=data}).then(function(){return global.get("masters").val}).then(function(data){console.log(data),self.masters=data.filter(function(m){return m._id!=self.entry.master}),console.log(self.masters)})}(entryId);var delay}
angular.module("gmall.services").directive("onlineBooking",listDirective).directive("weekSchedule",sheduleDirective).directive("scheduleEntry",sheduleEntryDirective).directive("ngRepeatEndWatch",function(){return{restrict:"A",scope:{},link:function(scope,element,attrs){if(!attrs.ngRepeat)throw"ngRepeatEndWatch: `ngRepeat` Directive required to use this Directive";scope.$parent.$last&&(""!==attrs.ngRepeatEndWatch?"function"==typeof scope.$parent.$parent[attrs.ngRepeatEndWatch]?scope.$parent.$parent[attrs.ngRepeatEndWatch]():scope.$parent.$parent[attrs.ngRepeatEndWatch]=!0:scope.$parent.$parent.ngRepeatEnd=!0)}}}).directive("setClassWhenAtTop",function($window,$timeout){var $win=angular.element($window);return{restrict:"A",link:function(scope,element,attrs){function mastersRepeatDone(){first?delay=500:first=!0,$timeout(function(){init()},delay)}function init(){var w=0,outerW=1;try{w=element.width(),outerW=element.parent().parent().width()}catch(err){}outerW>=w?$(window).scroll(scrollHandler):$(window).off("scroll",scrollHandler)}var topClass=attrs.setClassWhenAtTop,offsetTop=element.offset().top-60;scope.mastersRepeatDone=mastersRepeatDone;var first,delay=1e3,scrollHandler=function(e){$win.scrollTop()>=offsetTop?element.addClass(topClass):element.removeClass(topClass)}}}}),listCtrl.$inject=["$scope","Booking","Master","Stuff","$rootScope","global","Confirm","$q","exception","socket","$timeout","Label"],scheduleCtrl.$inject=["$scope","Booking","Master","Stuff","$rootScope","global","Confirm","$q","exception","socket","$state","Workplace","$timeout"],scheduleEntryCtrl.$inject=["$scope","Booking","Master","Stuff","$rootScope","global","Confirm","$q","exception","socket","$state","Workplace","$timeout"]}(),function(){function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/createMaster.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/Master/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Master",serviceFoo),serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function serviceFunction($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return console.log(id),Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/PROMO/coupon/createCoupon.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Coupon/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Coupon",serviceFunction),serviceFunction.$inject=["$resource","$uibModal","$q"]}(),angular.module("gmall.directives").directive("callFromStore",[function(){return{scope:{modalClose:"&",stuff:"@"},restrict:"E",bindToController:!0,controllerAs:"$ctrl",controller:"callCtrl",templateUrl:"components/call/call.html"}}]).directive("enterPhoneNumder",[function(){return{scope:{enterPhoneNumder:"=",changeFoo:"&",submitted:"="},restrict:"A",bindToController:!0,controllerAs:"$ctrl",controller:enterPhoneNumderCtrl,templateUrl:"components/call/phoneNumber.html"}}]),enterPhoneNumderCtrl.$inject=["$scope","global"],angular.module("gmall.directives").directive("externalCatalog",externalCatalogComponent).directive("externalCatalogDownload",externalCatalogDownload),externalCatalogDownloadCtrl.$inject=["ExternalCatalog","$q","Confirm","exception","global","$timeout","$http","$resource","Sections","Brands","$uibModal"],externalCatalogCtrl.$inject=["ExternalCatalog","$q","Confirm","exception","global","$timeout"],angular.module("gmall.services").service("ExternalCatalog",function($resource,$q,$uibModal){function getItems(reload){return!items||reload?getList():items}function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),items=response,response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/externalCatalog/createExternalCatalog.html",controllerAs:"$ctrl",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){if(!self.name)return void exception.catcher("создание объекта")("нужено название");$uibModalInstance.close({name:self.name})},self.cancel=function(){$uibModalInstance.dismiss()}}}).result.then(function(item){item.name?(item.name=item.name.substring(0,25),resolve(item)):reject("empty")},function(err){reject(err)})})}var items,Items=$resource("/api/collections/ExternalCatalog/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create,getItems:getItems}});for(var minTimePart=15,timeRemindArrLang=[{ru:"за 1 час",uk:"",en:"",de:"",part:4},{ru:"за 2 часа",uk:"",en:"",de:"",part:8},{ru:"за 3 часа",uk:"",en:"",de:"",part:12},{ru:"за 4 часа",uk:"",en:"",de:"",part:16},{ru:"за 5 часов",uk:"",en:"",de:"",part:20},{ru:"за 6 часов",uk:"",en:"",de:"",part:24},{ru:"за 12 часов",uk:"",en:"",de:"",part:48},{ru:"за 1 день",uk:"",en:"",de:"",part:96}],timeDurationArrLang=[{ru:"15 мин",uk:"",en:"",de:"",part:1},{ru:"30 мин",uk:"",en:"",de:"",part:2},{ru:"45 мин",uk:"",en:"",de:"",part:3},{ru:"1 час",uk:"",en:"",de:"",part:4},{ru:"1 час 15 мин",uk:"",en:"",de:"",part:5},{ru:"1 час 30 мин",uk:"",en:"",de:"",part:6},{ru:"1 час 45 мин",uk:"",en:"",de:"",part:7},{ru:"2 часа",uk:"",en:"",de:"",part:8},{ru:"2 часа 15 мин",uk:"",en:"",de:"",part:9},{ru:"2 часа 30 мин",uk:"",en:"",de:"",part:10},{ru:"3 часа",uk:"",en:"",de:"",part:12},{ru:"3 часа 30 мин",uk:"",en:"",de:"",part:14},{ru:"4 часа",uk:"",en:"",de:"",part:16}],weekDays=[{ru:"Воскресенье",uk:"Неділя",en:"Sunday",de:"gdsdfsdf"},{ru:"Понедельник",uk:"Понеділок",en:"Monday",de:"gdsdfsdf"},{ru:"Вторник",uk:"Вівторок",en:"Tuesday",de:"gdsdfsdf"},{ru:"Среда",uk:"Середа",en:"Wednesday",de:"gdsdfsdf"},{ru:"Четверг",uk:"Четвер",en:"Thursday",de:"gdsdfsdf"},{ru:"Пятница",uk:"П*ятниця",en:"Friday",de:"gdsdfsdf"},{ru:"Суббота",uk:"Субота",en:"Saturday",de:"gdsdfsdf"}],reservedFirstParamsForAdmin=["manage","promo","seo","setting","content","translate","admin123","bookkeep"],reservedFirstParams=["manage","promo","seo","setting","content","translate","news","lookbook","stat","master","campaign","info","additional","workplace","cabinet","pricegoods","priceservices","home","search","cart","cabinet","bookkeep","likes"],languagesOfPlatform=["ru","uk","en","de","es"],propertiesOfConfigData=[{key:"unitOfMeasure",name:"единицы измерения"}],phoneCodes=[{code:"+38",country:"Ukraine"},{code:"+7",country:"Russia"},{code:"+501",country:"Moldova"},{code:"+44",country:"United Kingdom"},{code:"+93",country:"Afghanistan"},{code:"+355",country:"Albania"},{code:"+213",country:"Algeria"},{code:"+1-684",country:"American Samoa"},{code:"+376",country:"Andorra"},{code:"+244",country:"Angola"},{code:"+1-264",country:"Anguilla"},{code:"+672",country:"Antarctica"},{code:"+1-268",country:"Antigua and Barbuda"},{code:"+54",country:"Argentina"},{code:"+374",country:"Armenia"},{code:"+297",country:"Aruba"},{code:"+61",country:"Australia"},{code:"+43",country:"Austria"},{code:"+994",country:"Azerbaijan"},{code:"+1-242",country:"Bahamas"},{code:"+973",country:"Bahrain"},{code:"+880",country:"Bangladesh"},{code:"+1-246",country:"Barbados"},{code:"+375",country:"Belarus"},{code:"+32",country:"Belgium"},{code:"+1-246",country:"Belize"},{code:"+229",country:"Benin"},{code:"+1-441",country:"Bermuda"},{code:"+975",country:"Bhutan"},{code:"+591",country:"Bolivia"},{code:"+246",country:"British Indian Ocean Territory"},{code:"+267",country:"Botswana"},{code:"+55",country:"Brazil"},{code:"+387",country:"Bosnia and Herzegovina"},{code:"+1-284",country:"British Virgin Islands"},{code:"+673",country:"Brunei"},{code:"+359",country:"Bulgaria"},{code:"+226",country:"Burkina Faso"},{code:"+257",country:"Burundi"},{code:"+855",country:"Cambodia"},{code:"+237",country:"Cameroon"},{code:"+1",country:"Canada"},{code:"+238",country:"Cape Verde"},{code:"+1-345",country:"Cayman Islands"},{code:"+236",country:"Central African Republic"},{code:"+235",country:"Chad"},{code:"+56",country:"Chile"},{code:"+86",country:"China"},{code:"+57",country:"Colombia"},{code:"+269",country:"Comoros"},{code:"+506",country:"Costa Rica"},{code:"+385",country:"Croatia"},{code:"+53",country:"Cuba"},{code:"+599",country:"Curacao"},{code:"+357",country:"Cyprus"},{code:"+420",country:"Czech Republic"},{code:"+45",country:"Denmark"},{code:"+1-767",country:"Dominica"},{code:"+593",country:"Ecuador"},{code:"+995",country:"Georgia"},{code:"+49",country:"Germany"},{code:"+30",country:"Greece"},{code:"+852",country:"Hong Kong"},{code:"+36",country:"Hungary"},{code:"+354",country:"Iceland"},{code:"+852",country:"Hong Kong"},{code:"+36",country:"Hungary"},{code:"+30",country:"Greece"},{code:"+91",country:"India"},{code:"+62",country:"Indonesia"},{code:"+98",country:"Iran"},{code:"+964",country:"Iraq"},{code:"+353",country:"Ireland"},{code:"+972",country:"Israel"},{code:"+39",country:"Italy"},{code:"+81",country:"Japan"},{code:"+962",country:"Jordan"},{code:"+7",country:"Kazakhstan"},{code:"+383",country:"Kosovo"},{code:"+965",country:"Kuwait"},{code:"+996",country:"Kyrgyzstan"},{code:"+856",country:"Laos"},{code:"+371",country:"Latvia"},{code:"+961",country:"Lebanon"},{code:"+218",country:"Libya"},{code:"+423",country:"Liechtenstein"},{code:"+370",country:"Lithuania"},{code:"+352",country:"Luxembourg"},{code:"+853",country:"Macau"},{code:"+389",country:"Macedonia"},{code:"+261",country:"Madagascar"},{code:"+60",country:"Malaysia"},{code:"+356",country:"Malta"},{code:"+222",country:"Mauritania"},{code:"+230",country:"Mauritius"},{code:"+52",country:"Mexico"},{code:"+373",country:"Moldova"},{code:"+377",country:"Monaco"},{code:"+976",country:"Mongolia"},{code:"+382",country:"Montenegro"},{code:"+212",country:"Morocco"},{code:"+977",country:"Nepal"},{code:"+31",country:"Netherlands"},{code:"+507",country:"Panama"},{code:"+595",country:"Paraguay"},{code:"+382",country:"Montenegro"},{code:"+377",country:"Monaco"},{code:"+51",country:"Peru"},{code:"+63",country:"Philippines"},{code:"+48",country:"Poland"},{code:"+351",country:"Portugal"},{code:"+974",country:"Qatar"},{code:"+40",country:"Romania"},{code:"+378",country:"San Marino"},{code:"+966",country:"Saudi Arabia"},{code:"+381",country:"Serbia"},{code:"+65",country:"Singapore"},{code:"+421",country:"Slovakia"},{code:"+386",country:"Slovenia"},{code:"+27",country:"South Africa"},{code:"+82",country:"South Korea"},{code:"+34",country:"Spain"},{code:"+94",country:"Sri Lanka"},{code:"+46",country:"Sweden"},{code:"+41",country:"Switzerland"},{code:"+886",country:"Taiwan"},{code:"+992",country:"Tajikistan"},{code:"+66",country:"Thailand"},{code:"+216",country:"Tunisia"},{code:"+90",country:"Turkey"},{code:"+993",country:"Turkmenistan"},{code:"+971",country:"United Arab Emirates"},{code:"+44",country:"United Kingdom"},{code:"+1",country:"United States"},{code:"+598",country:"Uruguay"},{code:"+998",country:"Uzbekistan"},{code:"+379",country:"Vatican"},{code:"+58",country:"Venezuela"},{code:"+84",country:"Vietnam"},{code:"+967",country:"Yemen"}],modelsName={stat:{ru:"страницы",uk:"сторінки",en:"pages",de:"pages"},stuff:{ru:"товары и услуги",uk:"товари та послуги",en:"goods and services",de:"goods and services"},news:{ru:"новости",uk:"новини",en:"news",de:"news"},info:{ru:"информация",uk:"інформація",en:"information",de:"information"},workplace:{ru:"локации",uk:"локации",en:"locations",de:"locations"}},lengthStyleBlock=61,arrEmptyForProperties=[],i=0;i<lengthStyleBlock;i++)arrEmptyForProperties.push("");var listOfBlocksForMainPage={slider:"слайдер",video:"видео",videoLink:"внешнее видео",banner:"баннер",bannerOne:"баннер в два потока",mission:"миссия",text:"текстовый блок",textTwo:"текстовый блок 2 потока",campaign:"акции",filterTags:"тематические группы (признаки из хар-тик)",filters:"характеристики",brandTags:"коллекции",brands:"бренды",categories:"категории",stuffs:"товары",news:"новости",info:"информационный раздел",pricegoods:"прайс товаров",priceservices:"прайс услуг",map:"карта",review:"отзывы гугл",subscription:"подписка",subscriptionAdd:"подписка с доп полями",call:"заказ звонка",feedback:"форма обратной связи",calendar:"гугл календарь",scheduleplace:"расписание для рабочего места"},animationTypes=[{type:null,name:"отсутстует"},{type:"animated1",name:"fadeInLeftBig"},{type:"animated2",name:"fadeInLeft"},{type:"animated3",name:"fadeInLeftMiddle"},{type:"animated4",name:"fadeInRight"},{type:"animated5",name:"fadeInRightMiddle"},{type:"animated6",name:"fadeInRightBig"},{type:"animated7",name:"bounce"},{type:"animated8",name:"fadeInDown"},{type:"animated9",name:"fadeOut"},{type:"animated10",name:"bounceIn"},{type:"animated11",name:"при наведении контур1"},{type:"animated12",name:"при наведении контур2"},{type:"animated13",name:"SweepToTop"},{type:"animated14",name:"SweepToBottom"},{type:"animated15",name:"LineCenterBottom"},{type:"animated16",name:"scale-block"},{type:"animated17",name:"SweepToRight"},{type:"animated18",name:"SweepToLeft"},{type:"animated19",name:"underlineLRL"},{type:"animated20",name:"underline RLR"},{type:"animated21",name:"line-through LRL"},{type:"animated22",name:"underline RLR 5px"},{type:"animated23",name:"test"},{type:"animated24",name:"test"},{type:"animated25",name:"test"},{type:"animated26",name:"test"},{type:"animated27",name:"test"},{type:"animated28",name:"test"},{type:"animated29",name:"test"},{type:"animated30",name:"shake"},{type:"animated31",name:"fadeInUpBig"}],listOfListName=["news","master","stat","info","campaign","lookbook","additional","workplace"],listOfStuffDetailKind=["good","service","info","media"],listOfBlocksForAll={banner:"баннер",bannerOne:"баннер в два потока",brands:"бренды",brandTags:"коллекции",button:"кнопка",calendar:"гугл календарь",call:"заказ звонка",campaign:"акции",categories:"категории",date:"дата",feedback:"форма обратной связи",filterTags:"тематические группы (признаки из хар-тик)",filters:"характеристики",info:"информационный раздел",map:"карта",name:"название",news:"новости",position:"должность",pricegoods:"прайс товаров",priceservices:"прайс услуг",review:"отзывы гугл",schedule:"расписание для специалиста",scheduleplace:"расписание для рабочего места",slider:"слайдер",sn:"кнопки социальных сетей",stuffs:"товары",subscription:"подписка",subscriptionAdd:"подписка с доп полями",text:"текстовый блок",textTwo:"текстовый блок 2 потока",video:"видео",videoLink:"внешнее видео",fbpage:"страница фейсбука",comment:"комментарии дискус"},listOfBlocksForStaticPage={name:"название",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",videoLink:"внешнее видео",video:"видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",masters:"сотрудники",feedback:"обратная связь",feedback1:"обратная связь + фото",feedback2:"фото + обратная связь",stuffs:"товары",filterTags:"группы(признаки из хар-тик)",brandTags:"коллекции",brands:"бренды",categories:"категории",campaign:"акции",call:"заказ звонка",button:"кнопка"},listOfBlocksForNewsDetailPage={name:"название",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",videoLink:"внешнее видео",video:"видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",campaign:"акции",filterTags:"группы(признаки из хар-тик)",brandTags:"коллекции",brands:"бренды",categories:"категории",date:"дата",sn:"социальные сети"},listOfBlocksForMasterPage={name:"имя",position:"должность",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",schedule:"расписание"},listOfBlocksForWorkplacePage={name:"имя",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",schedule:"расписание"},listOfBlocksForAddPage={name:"имя",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",news:"новости"},listOfBlocksForHeader={logo:"логотип",name:"название",cart:"корзина",enter:"вход",info:"инфо",currency:"валюта",news:"новости",lookbook:"галлерея",search:"поиск",catalog:"каталог",new:"новинки",additional:"дополнительный список",schedule:"расписание",sale:"распродажа",campaign:"акции",master:"мастера",brands:"бренды",collection:"коллекции",phone:"телефон",sn:"социальные сети",lang:"языки",humburger:"humburger",pricegoods:"pricegoods",priceservices:"priceservices",text:"текст",icon:"иконка",likes:"избранное"},listBlocksForFooter={text:"текст",textOne:"текст 1",sn:"соц.сети",subscription:"подписка",feedback:"обратная связь",stat:"статические страницы",catalog:"каталог",infoline:"ииформационная строка",copyright:"правообладание",news:"новости",campaign:"акции",lang:"языки"},listOfBlocksForStats={name:"название",banner:"баннер",gallery:"галлерея",desc:"описание1",desc1:"описание2",desc2:"описание3",map:"карта",video:"видео",masters:"мастера"},listOfBlocksForStuffDetail={name:"название",gallery:"галлерея",desc:"описание",comments:"комментарии",lastViewed:"последние просмотренные",sort:"разновидности",group:"группа товаров",addInfo:"доп.информация",addToCart:"в корзину(действие)",price:"цены",qty:"количество",sn:"соц.сети",feedback:"обратная связь",params:"параметры",tags:"характеристики",blocks:"медиа блоки",back:"кнопка назад в список"},listOfBlocksForStuffDetailBlocks={banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",calendar:"календарь",date:"дата",feedback:"обратная связь",feedbackOne:"текст + обратная связь",feedbackTwo:"обратная связь + текст",imgs:"фото",map:"карта",mapOne:"карта + текстовый блок",mapTwo:"текстовый блок + карта",masters:"блок мастеров",name:"имя",position:"должность",slider:"слайдер",sn:"соцсети",text:"текстовый блок",text2:"текстовый блок в две колонки",video:"видео",videoOne:"видео + текстовый блок",videoTwo:"текстовый блок + видео",videoLink:"внешнее видео",file:"file"},listOfBlocksForStuffList={list:"список",filters:"фильтры",categories:"категории",paginate:"пагинация",search:"поиск",call:"звонок",subscription:"подписка",desc:"описание",seoDesc:"seo описание",blocks:"медиа блоки"},tableOfColorsForButton={0:"black-white",1:"pink-white",2:"turquoise-white",3:"yellow-white",4:"bordo-white",5:"braun-white",6:"powder-white",7:"pinklight-white",8:"white-black",9:"black-white"},tableOfButtonsFile={0:"standart",1:"border-radius",2:"no border",3:"inverse",4:"border",5:"transparent"},listOfIcons=["addcart","back","cart","cartin","cartplus","cancelmenu","cancel","cancelzoom","call","caret","categories","change","dialog","down","dot","delete","downslide","gif","envelope","envelopewhite","edit","eur","fb","fbwhite","filters","header","google","googlewhite","humbmobile","chat","inst","instwhite","left","likes","menu","messageme","messagehe","next","nextgallery","ok","okwhite","pin","pinwhite","plus","prev","prevgallery","right","rub","search","send","setting","spinner","subscription","time","tw","twwhite","uah","up","upslide","user","userhe","userme","usd","vk","vkwhite","see","enter","zoom","yt","ytwhite"],notificationsTypeLang={invoice:{ru:"счет",ua:"рахунок",en:"invoice",de:""},accepted:{ru:"заказ принят",ua:"замовлення прийнято",en:"accepted",de:""},shipOrder:{ru:"данные о доставке",ua:"дані про доставку",en:"shipOrder",de:""},order:{ru:"поступил заказ",ua:"поступило замовлення",en:"order",de:""},pay:{ru:"оплата",ua:"оплата",en:"pay",de:""},feedBack:{ru:"обратная связь",ua:"зворотній зв*язок",en:"feedback",de:""},comment:{ru:"комментарий",ua:"коментар",en:"comments",de:""},call:{ru:"заказ звонка",ua:"замовлення дзвінка",en:"call",de:""},subscription:{ru:"подписка",ua:"підписка",en:"subscription",de:""}},updateExternalCatalogList={everyMon10:{ru:"каждый понедельник в 10.00",ua:"",en:"",de:""},everyMon12:{ru:"каждый понедельник в 12.00",ua:"",en:"",de:""},everyFri10:{ru:"каждую пятницу в 10.00",ua:"",en:"",de:""},everyFri12:{ru:"каждую пятницу в 12.00",ua:"",en:"",de:""},everyDay10:{ru:"каждый день в 10.00",ua:"",en:"",de:""},everyDay12:{ru:"каждый день в 12.00",ua:"",en:"",de:""},everyDay101418:{ru:"каждый день в 10.00,14.00,18.00",ua:"",en:"",de:""}},ratioClassStuffDetail={0:{left:"left-block col-lg-6 col-md-6 col-sm-12 col-xs-12",right:"right-block col-lg-6 col-md-6 col-sm-12 col-xs-12"},1:{left:"left-block vertical-left3 col-lg-5 col-md-5 col-sm-12 col-xs-12",right:"right-block horizontal-right2 col-lg-7 col-md-7 col-sm-12 col-xs-12"},2:{left:"left-block vertical-left2 col-lg-4 col-md-4 col-sm-12 col-xs-12",right:"right-block horizontal-right1 col-lg-8 col-md-8 col-sm-12 col-xs-12"},3:{left:"left-block horizontal-left1 col-lg-7 col-md-7 col-sm-12 col-xs-12",right:"right-block vertical-right1  col-lg-5 col-md-5 col-sm-12 col-xs-12"},4:{left:"left-block horizontal-left2 col-lg-8 col-md-8 col-sm-12 col-xs-12",right:"right-block vertical-right2 col-lg-4 col-md-4 col-sm-12 col-xs-12"},5:{left:"left-block col-lg-12 col-md-12 col-sm-12 col-xs-12",right:"right-block col-lg-12 col-md-12 col-sm-12 col-xs-12"}},elementsList=["a","p","div","h1","h2","h3","h4","ol","ul","li","span","img","hr","iframe","table","tr","th","td"],getNamePropertyCSS=function(i,item,k){if(item)switch(i){case 0:return["color",item];case 1:return["background-color",item];case 2:return["margin-top",item];case 3:return["margin-right",item];case 4:return["margin-bottom",item];case 5:return["margin-left",item];case 6:return["padding-top",item];case 7:return["padding-right",item];case 8:return["padding-bottom",item];case 9:return["padding-left",item];case 10:return["display",item];case 11:return["font-family",item];case 12:return["font-size",item];case 13:return["font-weight",item];case 14:return["letter-spacing",item];case 15:return["text-transform",item];case 16:return["width",item];case 17:return["height",item];case 18:return["float",item];case 19:return["top",item];case 20:return["left",item];case 21:return["right",item];case 22:return["bottom",item];case 23:return["text-decoration",item];case 24:return["text-align",item];case 25:return["position",item];case 26:return["border",item];case 27:return["border-left",item];case 28:return["border-right",item];case 29:return["border-top",item];case 30:return["border-bottom",item];case 31:return["border-radius",item];case 32:return["z-index",item];case 33:return["opacity",item];case 34:return["border-width",item];case 35:return["list-style",item];case 36:return["vertical-align",item];case 37:return["background-size",item];case 38:return["background-position",item];case 39:return["text-shadow",item];case 40:return["cursor",item];case 41:return["transition",item];case 42:return["box-shadow",item];case 43:return["transform",item];case 44:return["background",item];case 45:return["clear",item];case 46:return["max-width",item];case 47:return["min-width",item];case 48:return["max-height",item];case 49:return["min-height",item];case 50:return["line-height",item];case 51:return["object-fit",item];case 52:return["object-position",item];case 53:return["overflow",item];case 54:return["background-attachment",item];case 55:return["background-repeat",item];case 56:return["padding",item];case 57:return["margin",item];case 58:return["word-break",item];case 59:return["word-wrap",item];case 60:return["word-spacing",item]}else switch(i){case 0:return"color";case 1:return"background-color";case 2:return"margin-top";case 3:return"margin-right";case 4:return"margin-bottom";case 5:return"margin-left";case 6:return"padding-top";case 7:return"padding-right";case 8:return"padding-bottom";case 9:return"padding-left";case 10:return"display";case 11:return"font-family";case 12:return"font-size";case 13:return"font-weight";case 14:return"letter-spacing";case 15:return"text-transform";case 16:return"width";case 17:return"height";case 18:return"float";case 19:return"top";case 20:return"left";case 21:return"right";case 22:return"bottom";case 23:return"text-decoration";case 24:return"text-align";case 25:return"position";case 26:return"border";case 27:return"border-left";case 28:return"border-right";case 29:return"border-top";case 30:return"border-bottom";case 31:return"border-radius";case 32:return"z-index";case 33:return"opacity";case 34:return"border-width";case 35:return"list-style";case 36:return"vertical-align";case 37:return"background-size";case 38:return"background-position";case 39:return"text-shadow";case 40:return"cursor";case 41:return"transition";case 42:return"box-shadow";case 43:return"transform";case 44:return"background";case 45:return"clear";case 46:return"max-width";case 47:return"min-width";case 48:return"max-height";case 49:return"min-height";case 50:return"line-height";case 51:return"object-fit";case 52:return"object-position";case 53:return"overflow";case 54:return"background-attachment";case 55:return"background-repeat";case 56:return"padding";case 57:return"margin";case 58:return"word-break";case 59:return"word-wrap";case 60:return"word-spacing"}};"undefined"==typeof window&&(exports.listOfBlocksForMainPage=listOfBlocksForMainPage,exports.listOfBlocksForHeader=listOfBlocksForHeader,exports.listBlocksForFooter=listBlocksForFooter,exports.listOfBlocksForStats=listOfBlocksForStats,exports.listOfBlocksForStuffDetail=listOfBlocksForStuffDetail,exports.listOfBlocksForStuffList=listOfBlocksForStuffList,exports.lengthStyleBlock=lengthStyleBlock,exports.arrEmptyForProperties=arrEmptyForProperties,exports.listOfBlocksForNewsDetailPage=listOfBlocksForNewsDetailPage,exports.listOfBlocksForStaticPage=listOfBlocksForStaticPage,exports.modelsName=modelsName,exports.getNamePropertyCSS=getNamePropertyCSS,exports.listOfListName=listOfListName,exports.ratioClassStuffDetail=ratioClassStuffDetail,exports.elementsList=elementsList,exports.reservedFirstParams=reservedFirstParams,exports.reservedFirstParamsForAdmin=reservedFirstParamsForAdmin,exports.minTimePart=minTimePart,exports.listOfBlocksForStuffDetailBlocks=listOfBlocksForStuffDetailBlocks),function(){function itemListDirective(){return{scope:{},bindToController:!0,controller:itemListCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/workplace/workplaceList.html"}}function workplaceItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:ItemCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/workplace/workplaceItem.html"}}function itemListCtrl(Items,$state,global,Confirm,$q,exception,Photo,$timeout){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){self.Items.create().then(function(res){return self.newItem={},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.workplace.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function cloneItem(item){var name;self.Items.create().then(function(res){return name=res,self.Items.getItem(item._id)}).then(function(master){return self.newItem=angular.copy(master),self.newItem.name=name,self.newItem.nameL={},delete self.newItem._id,delete self.newItem.__v,delete self.newItem.url,console.log(self.newItem),self.newItem.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id})),block.imgs=[]}),self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.workplace.item",{id:id})},100)}).catch(function(err){
err&&exception.catcher("создание объекта")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Workplace/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Workplace",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объекта")(err)})}function dropCallback(item){var i=0;return setTimeout(function(){self.items.reduce(function(p,item){return p.then(function(){return i++,item.index=i,saveField(item,"index")})},$q.when(!0)).then(function(){console.log(self.items.map(function(el){return el.index}))})},50),item}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:20,totalItems:0},self.newItem={name:"наименование"},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.deleteItem=deleteItem,self.createItem=createItem,self.dropCallback=dropCallback,self.cloneItem=cloneItem,function(){getList().then(function(){})}()}function ItemCtrl(Items,$stateParams,$q,$uibModal,global,exception,Stuff,Photo,$scope,$timeout,Confirm,SetCSS){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){data&&!data.blocks&&(data.blocks=[],saveField("blocks",[]));var bl=data.blocks.filter(function(b){return b});return bl.length!=data.blocks.length&&(saveField("blocks",bl),data.blocks=bl),data.blocks.forEach(function(b,i){"stuffs"==b.type&&b.stuffs.length&&(b.stuffs=b.stuffs.map(function(s){return s._is||s})),b.i=i}),data.blocks.sort(function(a,b){return a.index-b.index}),self.item=data,self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){block.elements&&saveField("blocks."+block.i+".elements",block.elements),block.blockStyle&&saveField("blocks."+block.i+".blockStyle",block.blockStyle)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){if(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}}function deleteBlock(block,index){var o={_id:self.item._id},update={update:"_id_id",embeddedName:"blocks"};o.id=block.id,update.embeddedPull=!0,Confirm("потверждаете?").then(function(){return self.item.blocks.splice(index,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Workplace",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/workplace/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){if("stuffs"==block.type&&block.stuffs&&block.stuffs.length&&block.stuffs.some(function(s){return s&&s._id?s._id==item._id:s==item._id}))throw"такой объект уже есть";block[block.type]||(block[block.type]=[]);var img,link;switch(name=item.name,block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,_id:item._id}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,_id:item._id})),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}).catch(function(err){err&&exception.catcher("добавление")(err)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}function changeItem(block,$index){addItemInBlock(block,$index)}var self=this;self.Items=Items,self.type="Workplace",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForWorkplacePage=listOfBlocksForWorkplacePage,self.listOfBlocks=listOfBlocksForWorkplacePage,console.log(self.listOfBlocksForWorkplacePage),console.log(self.listOfBlocks),self.moment=moment,self.saveField=saveField,self.setStyles=setStyles,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,activate(),$scope.$on("changeLang",function(){activate()}),global.get("store").val.template.workplace||(global.get("store").val.template.workplace={parts:[]});global.get("store").val.template.workplace.parts.filter(function(el){return el.is}).map(function(el){return el.name})}function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/workplace/createItem.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/Workplace/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Workplace",serviceFoo),angular.module("gmall.directives").directive("workplaceList",itemListDirective).directive("workplaceItem",workplaceItemDirective),itemListCtrl.$inject=["Workplace","$state","global","Confirm","$q","exception","Photo","$timeout"],ItemCtrl.$inject=["Workplace","$stateParams","$q","$uibModal","global","exception","Stuff","Photo","$scope","$timeout","Confirm","SetCSS"],serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function labelsService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/CONTENT/label/createItem.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Label/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create}}angular.module("gmall.services").service("Label",labelsService),labelsService.$inject=["$resource","$uibModal","$q"]}();