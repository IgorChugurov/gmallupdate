"use strict";function validateEmail(email){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)}function md5www(str){var k,AA,BB,CC,DD,a,b,c,d,RotateLeft=function(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits},AddUnsigned=function(lX,lY){var lX4,lY4,lX8,lY8,lResult;return lX8=2147483648&lX,lY8=2147483648&lY,lX4=1073741824&lX,lY4=1073741824&lY,lResult=(1073741823&lX)+(1073741823&lY),lX4&lY4?2147483648^lResult^lX8^lY8:lX4|lY4?1073741824&lResult?3221225472^lResult^lX8^lY8:1073741824^lResult^lX8^lY8:lResult^lX8^lY8},F=function(x,y,z){return x&y|~x&z},G=function(x,y,z){return x&z|y&~z},H=function(x,y,z){return x^y^z},I=function(x,y,z){return y^(x|~z)},FF=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},GG=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},HH=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},II=function(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)},WordToHex=function(lValue){var lByte,lCount,WordToHexValue="",WordToHexValue_temp="";for(lCount=0;lCount<=3;lCount++)lByte=lValue>>>8*lCount&255,WordToHexValue_temp="0"+lByte.toString(16),WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);return WordToHexValue},x=Array();for(str=unescape(encodeURIComponent(str)),x=function(str){for(var lWordCount,lMessageLength=str.length,lNumberOfWords_temp1=lMessageLength+8,lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64,lNumberOfWords=16*(lNumberOfWords_temp2+1),lWordArray=Array(lNumberOfWords-1),lBytePosition=0,lByteCount=0;lByteCount<lMessageLength;)lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|str.charCodeAt(lByteCount)<<lBytePosition,lByteCount++;return lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition,lWordArray[lNumberOfWords-2]=lMessageLength<<3,lWordArray[lNumberOfWords-1]=lMessageLength>>>29,lWordArray}(str),a=1732584193,b=4023233417,c=2562383102,d=271733878,k=0;k<x.length;k+=16)AA=a,BB=b,CC=c,DD=d,a=FF(a,b,c,d,x[k+0],7,3614090360),d=FF(d,a,b,c,x[k+1],12,3905402710),c=FF(c,d,a,b,x[k+2],17,606105819),b=FF(b,c,d,a,x[k+3],22,3250441966),a=FF(a,b,c,d,x[k+4],7,4118548399),d=FF(d,a,b,c,x[k+5],12,1200080426),c=FF(c,d,a,b,x[k+6],17,2821735955),b=FF(b,c,d,a,x[k+7],22,4249261313),a=FF(a,b,c,d,x[k+8],7,1770035416),d=FF(d,a,b,c,x[k+9],12,2336552879),c=FF(c,d,a,b,x[k+10],17,4294925233),b=FF(b,c,d,a,x[k+11],22,2304563134),a=FF(a,b,c,d,x[k+12],7,1804603682),d=FF(d,a,b,c,x[k+13],12,4254626195),c=FF(c,d,a,b,x[k+14],17,2792965006),b=FF(b,c,d,a,x[k+15],22,1236535329),a=GG(a,b,c,d,x[k+1],5,4129170786),d=GG(d,a,b,c,x[k+6],9,3225465664),c=GG(c,d,a,b,x[k+11],14,643717713),b=GG(b,c,d,a,x[k+0],20,3921069994),a=GG(a,b,c,d,x[k+5],5,3593408605),d=GG(d,a,b,c,x[k+10],9,38016083),c=GG(c,d,a,b,x[k+15],14,3634488961),b=GG(b,c,d,a,x[k+4],20,3889429448),a=GG(a,b,c,d,x[k+9],5,568446438),d=GG(d,a,b,c,x[k+14],9,3275163606),c=GG(c,d,a,b,x[k+3],14,4107603335),b=GG(b,c,d,a,x[k+8],20,1163531501),a=GG(a,b,c,d,x[k+13],5,2850285829),d=GG(d,a,b,c,x[k+2],9,4243563512),c=GG(c,d,a,b,x[k+7],14,1735328473),b=GG(b,c,d,a,x[k+12],20,2368359562),a=HH(a,b,c,d,x[k+5],4,4294588738),d=HH(d,a,b,c,x[k+8],11,2272392833),c=HH(c,d,a,b,x[k+11],16,1839030562),b=HH(b,c,d,a,x[k+14],23,4259657740),a=HH(a,b,c,d,x[k+1],4,2763975236),d=HH(d,a,b,c,x[k+4],11,1272893353),c=HH(c,d,a,b,x[k+7],16,4139469664),b=HH(b,c,d,a,x[k+10],23,3200236656),a=HH(a,b,c,d,x[k+13],4,681279174),d=HH(d,a,b,c,x[k+0],11,3936430074),c=HH(c,d,a,b,x[k+3],16,3572445317),b=HH(b,c,d,a,x[k+6],23,76029189),a=HH(a,b,c,d,x[k+9],4,3654602809),d=HH(d,a,b,c,x[k+12],11,3873151461),c=HH(c,d,a,b,x[k+15],16,530742520),b=HH(b,c,d,a,x[k+2],23,3299628645),a=II(a,b,c,d,x[k+0],6,4096336452),d=II(d,a,b,c,x[k+7],10,1126891415),c=II(c,d,a,b,x[k+14],15,2878612391),b=II(b,c,d,a,x[k+5],21,4237533241),a=II(a,b,c,d,x[k+12],6,1700485571),d=II(d,a,b,c,x[k+3],10,2399980690),c=II(c,d,a,b,x[k+10],15,4293915773),b=II(b,c,d,a,x[k+1],21,2240044497),a=II(a,b,c,d,x[k+8],6,1873313359),d=II(d,a,b,c,x[k+15],10,4264355552),c=II(c,d,a,b,x[k+6],15,2734768916),b=II(b,c,d,a,x[k+13],21,1309151649),a=II(a,b,c,d,x[k+4],6,4149444226),d=II(d,a,b,c,x[k+11],10,3174756917),c=II(c,d,a,b,x[k+2],15,718787259),b=II(b,c,d,a,x[k+9],21,3951481745),a=AddUnsigned(a,AA),b=AddUnsigned(b,BB),c=AddUnsigned(c,CC),d=AddUnsigned(d,DD);return(WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d)).toLowerCase()}function url_slug(s,opt){s=String(s),opt=Object(opt);var defaults={delimiter:"-",limit:void 0,lowercase:!0,replacements:{},transliterate:"undefined"==typeof XRegExp};for(var k in defaults)opt.hasOwnProperty(k)||(opt[k]=defaults[k]);var char_map={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ő":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ű":"U","Ý":"Y","Þ":"TH","ß":"ss","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ð":"d","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ő":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ű":"u","ý":"y","þ":"th","ÿ":"y","©":"(c)","Α":"A","Β":"B","Γ":"G","Δ":"D","Ε":"E","Ζ":"Z","Η":"H","Θ":"8","Ι":"I","Κ":"K","Λ":"L","Μ":"M","Ν":"N","Ξ":"3","Ο":"O","Π":"P","Ρ":"R","Σ":"S","Τ":"T","Υ":"Y","Φ":"F","Χ":"X","Ψ":"PS","Ω":"W","Ά":"A","Έ":"E","Ί":"I","Ό":"O","Ύ":"Y","Ή":"H","Ώ":"W","Ϊ":"I","Ϋ":"Y","α":"a","β":"b","γ":"g","δ":"d","ε":"e","ζ":"z","η":"h","θ":"8","ι":"i","κ":"k","λ":"l","μ":"m","ν":"n","ξ":"3","ο":"o","π":"p","ρ":"r","σ":"s","τ":"t","υ":"y","φ":"f","χ":"x","ψ":"ps","ω":"w","ά":"a","έ":"e","ί":"i","ό":"o","ύ":"y","ή":"h","ώ":"w","ς":"s","ϊ":"i","ΰ":"y","ϋ":"y","ΐ":"i","Ş":"S","İ":"I","Ç":"C","Ü":"U","Ö":"O","Ğ":"G","ş":"s","ı":"i","ç":"c","ü":"u","ö":"o","ğ":"g","А":"A","Б":"B","В":"V","Г":"G","Д":"D","Е":"E","Ё":"Yo","Ж":"Zh","З":"Z","И":"I","Й":"J","К":"K","Л":"L","М":"M","Н":"N","О":"O","П":"P","Р":"R","С":"S","Т":"T","У":"U","Ф":"F","Х":"H","Ц":"C","Ч":"Ch","Ш":"Sh","Щ":"Sh","Ъ":"","Ы":"Y","Ь":"","Э":"E","Ю":"Yu","Я":"Ya","а":"a","б":"b","в":"v","г":"g","д":"d","е":"e","ё":"yo","ж":"zh","з":"z","и":"i","й":"j","к":"k","л":"l","м":"m","н":"n","о":"o","п":"p","р":"r","с":"s","т":"t","у":"u","ф":"f","х":"h","ц":"c","ч":"ch","ш":"sh","щ":"sh","ъ":"","ы":"y","ь":"","э":"e","ю":"yu","я":"ya","Є":"Ye","І":"I","Ї":"Yi","Ґ":"G","є":"ye","і":"i","ї":"yi","ґ":"g","Č":"C","Ď":"D","Ě":"E","Ň":"N","Ř":"R","Š":"S","Ť":"T","Ů":"U","Ž":"Z","č":"c","ď":"d","ě":"e","ň":"n","ř":"r","š":"s","ť":"t","ů":"u","ž":"z","Ą":"A","Ć":"C","Ę":"e","Ł":"L","Ń":"N","Ó":"o","Ś":"S","Ź":"Z","Ż":"Z","ą":"a","ć":"c","ę":"e","ł":"l","ń":"n","ó":"o","ś":"s","ź":"z","ż":"z","Ā":"A","Č":"C","Ē":"E","Ģ":"G","Ī":"i","Ķ":"k","Ļ":"L","Ņ":"N","Š":"S","Ū":"u","Ž":"Z","ā":"a","č":"c","ē":"e","ģ":"g","ī":"i","ķ":"k","ļ":"l","ņ":"n","š":"s","ū":"u","ž":"z"};for(var k in opt.replacements)s=s.replace(RegExp(k,"g"),opt.replacements[k]);if(opt.transliterate)for(var k in char_map)s=s.replace(RegExp(k,"g"),char_map[k]);var alnum="undefined"==typeof XRegExp?RegExp("[^a-z0-9]+","ig"):XRegExp("[^\\p{L}\\p{N}]+","ig");return s=s.replace(alnum,opt.delimiter),s=s.replace(RegExp("["+opt.delimiter+"]{2,}","g"),opt.delimiter),s=s.substring(0,opt.limit),s=s.replace(RegExp("(^"+opt.delimiter+"|"+opt.delimiter+"$)","g"),""),opt.lowercase?s.toLowerCase():s}function exception(toaster){function catcher(header){return function(err){err?"object"==typeof err&&(err.data&&(err=err.data),err.message?err=err.message:err.error&&(err=err.error)):err="ошибка",toaster.pop("error",header,err)}}function showToaster(type,title,content){"object"==typeof content&&(content.message?content=content.message:content.error&&(content=content.error)),toaster.pop({type:type,title:title,body:content,bodyOutputType:"trustedHtml",showCloseButton:!0,delay:15e3,closeHtml:"<button>Close</button>"})}return{catcher:catcher,showToaster:showToaster}}function confirmFactory($q,$uibModal){function service(question){return $q(function(resolve,reject){var options={animation:!0,template:['<div class="modal-header">','<h3 class="modal-title text-center" ng-bind="$ctrl.question"></h3>',"<span class='icon-cancel-img' ng-click='$ctrl.cancel()'></span>","</div>",'<div class="modal-body confirm">','<form ng-submit="$ctrl.ok()"><button autofocus class="btn btn-project btn-border  btn-modal pull-right" type="reset" ng-click="$ctrl.cancel()">{{global.get("langOrder").val.noo}}</button>','<button class="btn btn-project btn-modal pull-left" type="submit">{{global.get("langOrder").val.yes}}</button>','</form><div class="clearfix"></div>',"</div>"].join(""),controller:function($uibModalInstance,question){var self=this;self.question=question,self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"sm",resolve:{question:function(){return question}}};$uibModal.open(options).result.then(function(){resolve()},function(){reject()})})}return service}function sectionServiceFunction($resource,$q,global,$uibModal,$timeout){function init(){Items.query(function(res){res.shift(),sections=res,setCategoriesFromSections(sections),pending=!1})}function reloadItems(){pending=!0,init()}function save(){return Items.save.apply(this,arguments).$promise.then(function(){})}function _getParentSection(sections,sectionUrl,id){if(!sections)return null;for(var i=0,l=sections.length;i<l;i++){if(id){if(sections[i]._id==sectionUrl)return sections[i]}else if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length){var categories;if(categories=_getParentSection(sections[i].child,sectionUrl,id))return categories}}return null}function _getEmbededCategories(section,arr){return section.categories&&section.categories.length&&arr.push.apply(arr,section.categories),section.child&&section.child.length&&section.child.forEach(function(section){getEmbededCategories(section,arr)}),arr}function returnSections(resolve){pending?setTimeout(function(){returnSections(resolve)},100):resolve(sections)}function getSections(){return $q(function(resolve,reject){global.get("sections")&&global.get("sections").val?(sections||(sections=global.get("sections").val),resolve(global.get("sections").val)):pending?setTimeout(function(){returnSections(resolve)},100):sections?resolve(sections):(pending=!0,Items.query(function(res){res.shift(),sections=res,pending=!1,setCategoriesFromSections(sections),resolve(sections)},function(err){pending=!1,reject(err)}))})}function setSections(newSections){sections=newSections,setCategoriesFromSections(sections?sections:[])}function getSection(sections,sectionUrl){sections||(sections=getSections());for(var i=0,l=sections.length;i<l;i++){if(sections[i].url&&sections[i].url==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length)for(var j=0,ll=sections[i].child.length;j<ll;j++)if(sections[i].child[j].url&&sections[i].child[j].url==sectionUrl)return sections[i].child[j]}return null}function getParentSection(sectionUrl,id){return _getParentSection(sections,sectionUrl,id)}function getEmbededCategories(section,arr){return _getEmbededCategories(section,arr)}function setCategoriesFromSections(sections){var categories=[],categoriesO={};sections.forEach(function(section){section.categories&&section.categories.length&&(section.categories.forEach(function(c){c.section={url:section.url},c.linkData={groupUrl:section.url,categoryUrl:c.url},categoriesO[c._id]=c}),categories.push.apply(categories,section.categories)),section.child&&section.child.length&&section.child.forEach(function(subSection){subSection.categories&&subSection.categories.length&&(subSection.categories.forEach(function(c){c.section={url:section.url},c.linkData={groupUrl:section.url,categoryUrl:c.url,parentGroup:subSection.url},categoriesO[c._id]=c}),categories.push.apply(categories,subSection.categories))})}),global.set("categories",categories),global.set("categoriesO",categoriesO)}function select(){var that=this;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectSubsectionModal.html",controller:selectSubsectionCtrl,size:"lg",resolve:{sections:function(){return that.getSections()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectSubsectionCtrl($q,$uibModalInstance,sections){var self=this;self.sections=sections,console.log(sections),self.ok=function(section){$uibModalInstance.close(section)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Group/:id",{id:"@_id"}),sections=null,pending=!0;return function(){$timeout(function(){global.get("sections")&&global.get("sections").val||init()})}(),{query:Items.query,get:Items.get,delete:Items.delete,save:save,savePure:Items.save,getSections:getSections,getSection:getSection,getParentSection:getParentSection,getEmbededCategories:getEmbededCategories,setCategoriesFromSections:setCategoriesFromSections,select:select,setSections:setSections,reloadItems:reloadItems}}function brandEditCtrl($anchorScroll,Brands,global,$q,exception,$stateParams,$scope,$timeout){function activate(){$q.when().then(function(){return self.Items.get({id:$stateParams.id}).$promise}).then(function(res){self.item=res,console.log(self.item)}).catch(function(err){err&&exception.catch("получение данных")(err)})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}var self=this;self.Items=Brands,self.global=global,self.saveField=saveField,activate(),$scope.$on("changeLang",function(){activate()})}function brandTagEdit(){return{scope:{min:"="},bindToController:!0,controller:brandTagEditCtrl,controllerAs:"$ctrl",templateUrl:"components/brand/collectionEdit.html",restrict:"EA"}}function brandTagEditCtrl(BrandTags,$q,$state,global,$stateParams,$scope,$timeout){function activate(id){return getItem(id).then(function(){})}function getItem(id){return vm.Items.get({id:$stateParams.id}).$promise.then(function(res){vm.item=res},function(err){})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:vm.item._id};o[field]=vm.item[field],vm.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}var vm=this;vm.Items=BrandTags,self.global=global,vm.saveField=saveField,activate($stateParams.id),$scope.$on("changeLang",function(){activate($stateParams.id)})}function driveSaleDirective(){return{restrict:"E",bindToController:!0,controllerAs:"$ctrl",controller:driveSaleCtrl}}function driveSaleCtrl($scope,$element,$uibModal){function editPriceSetting(data,field){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/editPriceSetting.html",controller:editPriceSettingModalCtrl,controllerAs:"$ctrl",resolve:{data:function(){return data},field:function(){return field}}}).result.then(function(data){console.log(data),$scope.saveField($scope.item,"driveSalePrice")},function(){})}$element.bind("click",function(){$scope.item.driveSalePrice||($scope.item.driveSalePrice={type:0,condition:!0,percent:0,sum:0}),editPriceSetting($scope.item.driveSalePrice,"driveSalePrice")})}function driveRetailDirective(){return{restrict:"E",bindToController:!0,controllerAs:"$ctrl",controller:driveRetailCtrl}}function driveRetailCtrl($scope,$element,$uibModal){function editPriceSetting(data,field){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/editPriceSetting.html",controller:editPriceSettingModalCtrl,controllerAs:"$ctrl",resolve:{data:function(){return data},field:function(){return field}}}).result.then(function(data){console.log(data),$scope.saveField($scope.item,"driveRetailPrice")},function(){})}$element.bind("click",function(){$scope.item.driveRetailPrice||($scope.item.driveRetailPrice={type:0,condition:!0,percent:0,sum:0}),editPriceSetting($scope.item.driveRetailPrice,"driveRetailPrice")})}function editPriceSettingModalCtrl(data,field,$uibModalInstance){var self=this;self.header="","driveSalePrice"==field?self.header="sale":"driveRetailPrice"==field&&(self.header="розница"),self.item=data,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss()}}function filterTagsService($resource,$uibModal,$q,global,$timeout,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function getFilterTags(){return $q(function(resolve,reject){return global.get("filterTags")&&global.get("filterTags").val?(filterTags||(filterTags=global.get("filterTags").val),resolve(global.get("filterTags").val)):pending?$timeout(function(){return resolve(filterTags)},400):void(filterTags?resolve(filterTags):(pending=!0,Items.query(function(res){res.shift(),filterTags=res?res:[],pending=!1,resolve(filterTags)},function(err){pending=!1,reject(err)})))})}function getTagsByUrl(queryTags,cb){$q.when().then(function(){return getFilterTags()}).then(function(){queryTags=queryTags.map(function(url){return filterTags.getOFA("url",url)}),cb(queryTags)})}function selectFilterTag(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/bindFilterTagToModel.html",controller:selectFilterTagCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectFilterTagCtrl(Filters,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),$uibModalInstance.close(filterTag)}}function init(){Items.query(qu,function(res){res.shift(),filterTags=res,filterTags.forEach(function(t){_filterTagsO[t._id]=t}),pending=!1})}function reloadItems(){pending=!0,init()}function getSticker(tags){if(tags&&tags.length&&filterTags&&filterTags.length)for(var i=0;i<tags.length;i++)if(__filterTagsO[tags[i]]&&__filterTagsO[tags[i]].sticker)return __filterTagsO[tags[i]].sticker}var qu,Items=$resource("/api/collections/FilterTags/:_id",{_id:"@_id"}),filterTags=null,pending=!0;return filterTags=__filterTags,$timeout(function(){qu={query:JSON.stringify({store:global.get("store").val._id})},global.get("filterTags")&&global.get("filterTags").val?filterTags=global.get("filterTags").val:init()},50),{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,getFilterTags:getFilterTags,getTagsByUrl:getTagsByUrl,selectFilterTag:selectFilterTag,select:selectFilterTag,reloadItems:reloadItems,getSticker:getSticker,reloadItems:reloadItems}}function externalCatalogComponent(){return{scope:{},restrict:"E",bindToController:!0,controller:externalCatalogCtrl,controllerAs:"$ctrl",templateUrl:"components/externalCatalog/externalCatalog.html"}}function externalCatalogDownload(){return{scope:{},restrict:"E",bindToController:!0,controller:externalCatalogDownloadCtrl,controllerAs:"$ctrl",templateUrl:"components/externalCatalog/externalCatalogDownload.html"}}function externalCatalogDownloadCtrl(Items,$q,Confirm,exception,global,$timeout,$http,$resource,Sections,Brands,$uibModal){function getList(){var query={};return $q.when().then(function(){return Items.getList(null,query)}).then(function(res){res.forEach(function(item){item.brand&&(item.brand=self.brands.find(function(b){return b._id==item.brand})),item.group&&(item.group=self.sections.find(function(s){return s._id==item.group}))}),self.items=res})}function downloadCatalog(item){$q.when().then(function(){self.myFile;$uibModal.open({animation:!0,templateUrl:"components/externalCatalog/modal/uploadExternalCatalog.html",controller:function($uibModalInstance,$q,$resource,item){function confirmUpload(){fdata.append("confirm",!0),$resource(uploadUrl,{},{postWithFile:{method:"POST",params:fdata,transformRequest:angular.identity,headers:{"Content-Type":void 0}}}).postWithFile(fdata),$uibModalInstance.close()}var self=this;self.disabledUpload=!0;var uploadUrl=stuffHost+"/api/downLoadExternalCatalog";self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()},self.catalogName=item.name,self.confirmUpload=confirmUpload,console.log(item);var fdata=new FormData;item.file&&fdata.append("file",item.file),fdata.append("_id",item._id),fdata.append("url",item.url),fdata.append("link",item.link),fdata.append("index",item.index),item.group&&fdata.append("group",item.group._id),item.brand&&fdata.append("brand",item.brand._id),item.name&&fdata.append("name",item.name),item.desc&&fdata.append("desc",item.desc),item.price&&fdata.append("price",item.price),item.qty&&fdata.append("qty",item.qty),item.artikul&&fdata.append("artikul",item.artikul),item.tags&&fdata.append("tags",item.tags),$q.when().then(function(){return $http.post(uploadUrl,fdata,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}).then(function(res){console.log(res),res.err?(self.errText=JSON.stringify(res.err),"{}"==self.errText&&(self.errText="произошла ошибка при обработке файла")):(self.disabledUpload=!1,self.disableSpinner=!0,self.updateStuffs=res.updateStuffs,self.newStuffs=res.newStuffs,self.newCategories=res.newCategories,self.newBrands=res.newBrands,self.newBrandTags=res.newBrandTags,self.newFilters=res.newFilters,self.newFilterTags=res.newFilterTags)})},controllerAs:"$ctrl",size:"lg",resolve:{item:function(){return item}}}).result}).catch(function(error){console.log(error)})}function setGroup(item){$q.when().then(function(){return Sections.select()}).then(function(group){item.group=group,saveField(item,"group",group._id)})}function setBrand(item){$q.when().then(function(){return Brands.select()}).then(function(brand){item.brand=brand,saveField(item,"brand",brand._id)})}function clearField(item,field){item[field]=null,saveField(item,field)}function saveField(item,field,value){console.log(item);var o={_id:item._id};o[field]="undefined"!=value?item[field]:value,Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500);var url=stuffHost+"/api/changeTaskSchedule",i=angular.copy(item);i.brand&&(i.brand=i.brand._id),i.group&&(i.group=i.group._id),$http.post(url,i).success(function(res){exception.showToaster("info","schedule","was changed")}).error(function(err){exception.catcher("error")(err),console.log(err)})})}function viewLogFile(){$uibModal.open({animation:!0,templateUrl:"components/externalCatalog/modal/viewLog.html",controller:function($uibModalInstance,$q,$http,global,$sce){var self=this;self.$sce,self.url=stuffHost+"/log/"+global.get("store").val.subDomain+"_externalCatalog.log",self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()},$http.get(self.url).success(function(res){console.log(res.replace(/[\r\n]/g,"<br />")),self.loaded,self.logFile=$sce.getTrustedHtml(res.replace(/[\r\n]/g,"<br />"))}).error(function(err){self.loaded,console.log(err)})},controllerAs:"$ctrl",size:"lg"})}var self=this;self.downloadCatalog=downloadCatalog,self.setGroup=setGroup,self.setBrand=setBrand,self.viewLogFile=viewLogFile,self.clearField=clearField,self.saveField=saveField,self.updateList=updateExternalCatalogList,self.lang=global.get("store").val.lang,function(){$q.when().then(function(){return Brands.getBrands()}).then(function(brands){return self.brands=brands,Sections.getSections()}).then(function(sections){self.sections=sections}).then(function(){getList()})}()}function externalCatalogCtrl(Items,$q,Confirm,exception,global,$timeout){function getList(){var query={};return $q.when().then(function(){return Items.getList(null,query)}).then(function(res){console.log(res),self.items=res}).then(function(){var d=new Date;self.items.forEach(function(item){item.timezoneOffset||0==item.timezoneOffset||(item.timezoneOffset=Math.ceil(d.getTimezoneOffset()/60),saveField(item,"timezoneOffset"))})})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){$q.when().then(function(){return Items.create()}).then(function(item){var d=new Date;return item.timezoneOffset=d.getTimezoneOffset(),Items.save(item).$promise}).then(function(){return getList()}).catch(function(err){err&&exception.catcher("создание внешнего каталога")(err)})}function deleteItem(item){Confirm("удалить?").then(function(){item.actived=!1,saveField(item,"actived")}).then(function(){}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление внешнего каталога")(err)})}var self=this;self.saveField=saveField,self.createItem=createItem,self.deleteItem=deleteItem,function(){getList()}()}function photoFactory($http){return{deleteFolder:function(model,folder){return $http.post("/api/collections/Photo/deleteFolder",{folder:folder})},deleteFolders:function(model,folders){return $http.post("/api/collections/Photo/deleteFolders",{folders:folders})},deleteFiles:function(model,files){return $http.post("/api/collections/Photo/deleteFiles",{files:files})}}}function sortsOfStuffctrlCtrl($uibModal,$resource,Stuff,$q,createStuffService,exception,global,$timeout){function setFilterInSort(filter){return $q(function(resolve,reject){self.stuff.sortsOfStuff.filter=filter,Items.save({update:"filter"},{_id:self.stuff.sortsOfStuff._id,filter:filter&&filter._id?filter._id:null},function(){resolve()},function(err){reject(err)})})}function setFilterGroupInSort(filter){return $q(function(resolve,reject){self.stuff.sortsOfStuff.filterGroup=filter,Items.save({update:"filterGroup"},{_id:self.stuff.sortsOfStuff._id,filterGroup:filter&&filter._id?filter._id:null},function(){resolve()},function(err){reject(err)})})}function getStuffPromise(stuff){return $q(function(resovle,reject){stuff&&stuff._id?resovle(stuff):stuff&&!stuff._id&&Stuff.get({_id:stuff}).$promise.then(function(res){resolve(res)},function(err){reject(err)})})}function addStuffInSorts(stuff){if(self.stuff.sortsOfStuff.stuffs.some(function(el){return el._id==stuff._id}))return void console.log("stuff already exist in sort");$q.when().then(function(){return $q(function(resolve,reject){stuff.sortsOfStuff?Items.get({id:stuff.sortsOfStuff._id}).$promise.then(function(megreSorts){stuff.sortsOfStuff=megreSorts,resolve()},function(err){reject(err)}):resolve(null)})}).then(function(){return $q(function(resolve,reject){stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&!self.stuff.sortsOfStuff.filter?Items.save({update:"filter"},{_id:self.stuff.sortsOfStuff._id,filter:stuff.sortsOfStuff.filter}).$promise.then(function(){resolve()},function(err){reject(err)}):resolve()})}).then(function(){return $q(function(resolve,reject){if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&!self.stuff.sortsOfStuff.filter)self.stuff.sortsOfStuff.filter=self.stuff.category.filters.getOFA("_id",stuff.sortsOfStuff.filter),self.stuff.sortsOfStuff.filter?self.setStockTableForSorts(self.stuff.sortsOfStuff.filter,self.stuff.sortsOfStuff.stuffs).then(function(){resolve()},function(err){reject(err)}):resolve();else{var stuffs=stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs?stuff.sortsOfStuff.stuffs:[stuff];self.setStockTableForSorts(self.stuff.sortsOfStuff.filter,stuffs).then(function(){resolve()},function(err){reject(err)})}})}).then(function(){return $q(function(resolve,reject){stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs?self.stuff.sortsOfStuff.stuffs.push.apply(self.stuff.sortsOfStuff.stuffs,stuff.sortsOfStuff.stuffs):self.stuff.sortsOfStuff.stuffs.push(stuff);var o={_id:self.stuff.sortsOfStuff._id};o.stuffs=self.stuff.sortsOfStuff.stuffs.filter(function(el){return el}).map(function(el){return el._id}),Items.save({update:"stuffs"},o).$promise.then(function(){resolve()},function(err){reject(err)})})}).then(function(){stuff.sortsOfStuff&&Items.delete({id:stuff.sortsOfStuff._id})}).then(function(){self.stuff.sortsOfStuff.stuffs.filter(function(el){return el.sortsOfStuff!=self.stuff.sortsOfStuff._id}).map(function(el){Stuff.Items.save({update:"sortsOfStuff"},{_id:el._id,sortsOfStuff:self.stuff.sortsOfStuff._id})})}).catch(function(){})}var Items=$resource("/api/collections/SortsOfStuff/:id",{id:"@_id"}),self=this;self.saveField=function(stuff,field){if(stuff._id==self.stuff._id){field.split(" ").forEach(function(el){"undefined"!=stuff[el]&&(self.stuff[el]=stuff[el])})}$q.when().then(function(){return Stuff.saveField(stuff,field)}).then(function(){$timeout(function(){global.set("saving",!1)},1500)}).catch(function(err){console.log(err),err&&exception.catcher("сохранение")(err)})},self.saveFieldsortsOfStuff=function(field){var o={_id:self.stuff.sortsOfStuff._id};self.stuff.sortsOfStuff[field]?o[field]=self.stuff.sortsOfStuff[field]:o[field]=null,Items.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},self.changeDifferentPrice=function(){Items.save({update:"differentPrice"},{_id:self.stuff.sortsOfStuff._id,differentPrice:self.stuff.sortsOfStuff.differentPrice},function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},self.changeStock=function(stuff,tag,value){stuff.priceForFilter=[];for(var key in stuff.stock)if(key!=stuff.sort||stuff.stock[key].quantity||(stuff.sort=null),stuff.stock[key].quantity){var c=stuff.currency?stuff.currency:global.get("store").val.mainCurrency,price=c==global.get("store").val.mainCurrency?stuff.stock[key].price:Math.ceil10(stuff.stock[key].price/global.get("store").val.currency[c][0],-2);stuff.priceForFilter.push(price)}if(tag&&tag._id){var i=stuff.tags.indexOf(tag._id);value&&i<0?(console.log("add"),stuff.tags.push(tag._id)):!value&&i>-1&&stuff.tags.splice(i,1),stuff.setTagsValue&&stuff.setTagsValue(),self.saveField(stuff,"stock tags sort priceForFilter")}else self.saveField(stuff,"stock sort priceForFilter")},self.getNameTag=function(tag){if(self.stuff.category&&self.stuff.category.filters&&self.stuff.category.filters.length)for(var i=0,l=self.stuff.category.filters.length;i<l;i++)for(var ii=0,ll=self.stuff.category.filters[i].tags.length;ii<ll;ii++)if(self.stuff.category.filters[i].tags[ii]._id==tag)return self.stuff.category.filters[i].tags[ii].name},self.createSort=function(filter){return $q(function(resolve,reject){
self.stuff.sortsOfStuff={stuffs:[self.stuff._id]},filter&&(self.stuff.sortsOfStuff.filter=filter._id),Items.save(self.stuff.sortsOfStuff,function(res){self.stuff.sortsOfStuff._id=res.id,self.stuff.sortsOfStuff.stuffs[0]=self.stuff,filter&&(self.stuff.sortsOfStuff.filter=filter),Stuff.Items.save({update:"sortsOfStuff"},{_id:self.stuff._id,sortsOfStuff:self.stuff.sortsOfStuff._id},function(){resolve()},function(err){reject(err)})},function(err){reject(err)})})},self.setStockTableForSort=function(stuff,stockTemplate){return $q(function(resolve,reject){getStuffPromise(stuff).then(function(stuff){var fields="stock";if(stuff.sortsOfStuff&&self.stuff.sortsOfStuff._id!=stuff.sortsOfStuff._id&&(stuff.sortsOfStuff=self.stuff.sortsOfStuff._id,fields+=" sortsOfStuff"),stockTemplate){var stock=angular.copy(stockTemplate);for(var key in stock)if(stuff.stock&&stuff.stock[key]&&(stock[key].quantity=stuff.stock[key].quantity),stock[key].price=stuff.price,stock[key].priceSale=stuff.priceSale,stock[key].retail=stuff.retail,"notag"!=key){var i=stuff.tags.indexOf(key);i<0&&stuff.tags.push(key)}stuff.stock=stock,stuff.setTagsValue&&stuff.setTagsValue(),fields+=" tags"}else stock={notag:{quantity:1}};Stuff.saveField(stuff,fields).then(function(){resolve()},function(err){reject(err)})},function(err){reject(err)})})},self.setStockTableForSorts=function(filter,stuffs){var stock,qty=global.get("store").val.settingContent&&global.get("store").val.settingContent.admin&&global.get("store").val.settingContent.admin.sortsDisable?0:1;filter&&filter.tags.forEach(function(tag){stock||(stock={}),stock[tag._id]={quantity:qty}});var actions=stuffs.map(function(stuff){return self.setStockTableForSort(stuff,stock)});return $q.all(actions)},self.changeFilter=function(filter){return $q.when().then(function(){return self.stuff.sortsOfStuff?setFilterInSort(filter):self.createSort(filter)}).then(function(newSort){$q(function(resolve,reject){self.setStockTableForSorts(filter,self.stuff.sortsOfStuff.stuffs).then(function(){resolve()},function(err){reject(err)})})}).catch(function(err){console.log(err)})},self.changeFilterGroup=function(filter){return $q.when().then(function(){return setFilterGroupInSort(filter)}).catch(function(err){console.log(err)})},self.selectFilter=function(){$uibModal.open({animation:!0,templateUrl:"components/sortsOfStuff/selectFilter.html",controller:function(filters,sortsOfStuff,$uibModalInstance){var self=this;self.filters=filters,self.selectFilter=function(filter){$uibModalInstance.close(filter)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",resolve:{filters:function(){return self.stuff.category&&self.stuff.category[0].filters?self.stuff.category[0].filters:[]},sortsOfStuff:function(){return self.sortsOfStuff}}}).result.then(function(selectedfilter){self.changeFilter(selectedfilter)},function(){})},self.selectFilterGroup=function(){$uibModal.open({animation:!0,templateUrl:"components/sortsOfStuff/selectFilter.html",controller:function(filters,sortsOfStuff,$uibModalInstance){var self=this;self.filters=filters,self.selectFilter=function(filter){$uibModalInstance.close(filter)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",resolve:{filters:function(){return self.stuff.category&&self.stuff.category[0]&&self.stuff.category[0].filters?self.stuff.category[0].filters:[]},sortsOfStuff:function(){return self.sortsOfStuff}}}).result.then(function(selectedfilter){self.changeFilterGroup(selectedfilter)},function(){})},self.clearFilterGroup=function(){self.changeFilterGroup(null)},self.selectStuff=function(){$q.when().then(function(){var query={category:self.stuff.category._id};return Stuff.selectItem(query)}).then(function(stuff){if(stuff&&stuff.sortsOfStuff&&self.stuff.sortsOfStuff.filter&&stuff.sortsOfStuff.filter!=self.stuff.sortsOfStuff.filter._id)throw"признаки разновидностей не совподают";addStuffInSorts(stuff)}).catch(function(err){(err=err.data||err)&&exception.catcher("добавление товара")(err)})},self.createAndAddStuff=function(){var newStuff=angular.copy(self.stuff);return void $q.when().then(function(){return Stuff.cloneStuff(newStuff,!0)}).then(function(stuffFromResolve){addStuffInSorts(stuffFromResolve)}).catch(function(err){console.log(err)})},self.deleteStuffFromSort=function(stuff,index){$q.when().then(function(){return $q(function(resolve,reject){if(1==self.stuff.sortsOfStuff.stuffs.length&&self.stuff.sortsOfStuff.stuffs[0]._id==stuff._id)Items.delete({id:self.stuff.sortsOfStuff._id},function(err){self.stuff.sortsOfStuff=null,resolve()},function(err){reject(err)});else{self.stuff.sortsOfStuff.stuffs.splice(index,1);var o={_id:self.stuff.sortsOfStuff._id};o.stuffs=self.stuff.sortsOfStuff.stuffs.map(function(el){return el._id}),Items.save({update:"stuffs"},o,function(res){resolve()},function(err){reject(err)})}})}).then(function(){return $q(function(resolve,reject){if(self.stuff.sortsOfStuff&&self.stuff.sortsOfStuff.filter){var o={filter:self.stuff.sortsOfStuff.filter._id,stuffs:[stuff._id]};Items.save(o,function(res){resolve(res.id)},function(err){reject(err)})}else resolve(null)})}).then(function(sort){return $q(function(resolve,reject){sort||(stuff.stock={notag:{quantity:1}}),Stuff.Items.save({update:"sortsOfStuff stock"},{_id:stuff._id,sortsOfStuff:sort,stock:stuff.stock},function(){resolve(sort)},function(err){reject(err)})})}).then(function(sort){return $q(function(resolve,reject){sort?Items.get({id:sort},function(res){self.stuff.sortsOfStuff=res,self.stuff.sortsOfStuff.filter=self.stuff.category.filters.getOFA("_id",self.stuff.sortsOfStuff.filter),resolve()},function(err){reject(err)}):resolve()})}).catch(function(err){console.log(err)})},self.additionalInfo=function(){$uibModal.open({animation:!0,templateUrl:"components/sortsOfStuff/additionalInfo.html",controller:function(filter,carrentAddInfo,AddInfo,$uibModalInstance,global){function initItem(){if(self.item={header:{},table:{},name:"",filter:filter._id},filter.tags.forEach(function(tag){self.item.table[tag._id]={}}),langArr&&langArr.forEach)langArr.forEach(function(lang){self.item.header[lang]=[""];for(var key in self.item.table)self.item.table[key][lang]=[""]});else{self.item.header[self.lang]=[""];for(var key in self.item.table)self.item.table[key][self.lang]=[""]}}var self=this;self.global=self.lang=global.get("store").val.lang;var langArr=global.get("store").val.langArr;console.log(langArr),filter?self.filter=filter:$uibModalInstance.dismiss("cancel");var query={filter:filter._id};self.items=[],initItem(),self.getTagName=function(id){for(var i=1,l=self.filter.tags.length;i<l;i++)if(self.filter.tags[i]._id==id)return self.filter.tags[i].name;return"noname"},function(){AddInfo.query({query:query},function(res){if(res.shift(),self.items=res,carrentAddInfo)for(var i=1,l=self.items.length;i<l;i++)if(self.items[i]._id==carrentAddInfo){self.item=self.items[i];break}},function(err){console.log(err)})}(),self.selectAddInfo=function(addInfo){$uibModalInstance.close(addInfo)},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.saveTable=function(){1!=self.item.header.length&&(self.item.header.pop(),filter.tags.forEach(function(tag){self.item.table[tag._id].pop()}),self.item.name||(self.item.name=filter.name),self.item._id?AddInfo.save({update:"header table name"},self.item,function(res){AddInfo.query({query:query},function(res){res.shift(),self.items=res}),initItem()}):AddInfo.save(self.item,function(res){AddInfo.query({query:query},function(res){res.shift(),self.items=res}),initItem()}))},self.addRow=function(){if(langArr&&langArr.forEach)langArr.forEach(function(lang){self.item.header[lang].push("");for(var key in self.item.table)self.item.table[key][lang].push("")});else{self.item.header[self.lang].push("");for(var key in self.item.table)self.item.table[key][self.lang].push("")}console.log(self.item)},self.deleteRow=function(i){if(langArr&&langArr.forEach)langArr.forEach(function(lang){self.item.header[lang].splice(i,1);for(var key in self.item.table)self.item.table[key][lang].splice(i,1)});else{self.item.header[self.lang].splice(i,1);for(var key in self.item.table)self.item.table[key][self.lang].splice(i,1)}},self.editTable=function(item){if(console.log(item),self.item=item,langArr&&langArr.forEach)langArr.forEach(function(lang){self.item.header[lang].push("");for(var key in self.item.table)self.item.table[key][lang].push("")});else{self.item.header[self.lang].push("");for(var key in self.item.table)self.item.table[key][self.lang].push("")}},self.setTable=function(item){}},controllerAs:"$ctrl",size:"lg",resolve:{filter:function(){return self.stuff.sortsOfStuff.filter},carrentAddInfo:function(){return self.stuff.sortsOfStuff.addInfo}}}).result.then(function(addInfo){self.stuff.sortsOfStuff.addInfo=addInfo._id,console.log(addInfo)},function(){})}}function HPtransform(HP,template){function setData(e){var o={type:e.name};return e.templ&&(o.templ=e.templ),e.style&&(o.style=e.style),"stuffs"==e.name?(HP.stuffs&&HP.stuffs.length&&(o.stuffs=HP.stuffs),e.namebox&&(o.name=e.namebox)):"brands"==e.name?(HP.brands&&HP.brands.length&&(o.brands=HP.brands),e.namebox&&(o.name=e.namebox)):"brandTags"==e.name?(HP.brandTags&&HP.brandTags.length&&(o.brandTags=HP.brandTags),e.namebox&&(o.name=e.namebox)):"filterTags"==e.name?(HP.filterTags&&HP.filterTags.length&&(o.filterTags=HP.filterTags),e.namebox&&(o.name=e.namebox)):"filters"==e.name?(HP.filters&&HP.filters.length&&(o.filters=HP.filters),e.namebox&&(o.name=e.namebox)):"categories"==e.name?(HP.categories&&HP.categories.length&&(o.categories=HP.categories),e.namebox&&(o.name=e.namebox)):"campaign"==e.name?(HP.campaign&&HP.campaign.length&&(o.campaign=HP.campaign),e.namebox&&(o.name=e.namebox)):"news"==e.name?(HP.news&&HP.news.length&&(o.news=HP.news),e.namebox&&(o.name=e.namebox)):"text"==e.name?(o.name=HP.textName,o.desc=HP.textDesc,HP.textButton&&(o.button={is:HP.textButton.button,link:HP.textButton.link,text:HP.textButton.text})):"mission"==e.name?(o.name=HP.name,o.desc=HP.desc,HP.descButton&&(o.button={is:HP.descButton.button,link:HP.descButton.link,text:HP.descButton.text})):"banner"==e.name?(o.img=HP.bannerSrc,HP.banner&&(o.desc=HP.banner.desc,o.button={is:HP.banner.button,link:HP.banner.link,text:HP.banner.text})):"video"==e.name?(o.video=HP.videoSrc,HP.video&&(o.audio=HP.video.audio,o.desc=HP.video.desc,o.button={is:HP.video.button,link:HP.video.link,text:HP.video.text})):"slider"==e.name?HP.imgs&&(o.imgs=HP.imgs):"info"==e.name&&(o.img=HP.infoImg,HP.info&&(o.name=HP.info.name,o.button={link:HP.info.link})),o}if(HP.url)var hp=HP;else{var hp={header:[],left:[],right:[]};template.left.forEach(function(e){hp.left.push(setData(e))}),template.right.forEach(function(e){hp.right.push(setData(e))})}return hp}function googlePlaceReviews(global){return{restrict:"C",scope:!0,link:function(scope,element){global.get("store").val.glPlaceId&&(console.log("global.get('store').val.glPlaceId",global.get("store").val.glPlaceId),$(element).googlePlaces({placeId:global.get("store").val.glPlaceId,render:["reviews"],min_rating:1,max_rows:4}))}}}function undefinedhpBlock(){return{templateUrl:"components/homePage/blocks/undefinedBlock.html"}}function styleBlock(){return{templateUrl:"components/homePage/blocks/styleBlock.html"}}function bannerHPBlock(){return{templateUrl:"components/homePage/blocks/bannerBlock.html"}}function banneroneHPBlock(){return{templateUrl:"components/homePage/blocks/banneroneBlock.html"}}function infohpBlock(){return{templateUrl:"components/homePage/blocks/infoBlock.html"}}function sliderhpBlock(){return{templateUrl:"components/homePage/blocks/sliderBlock.html"}}function texthpBlock(){return{templateUrl:"components/homePage/blocks/textBlock.html"}}function texttwohpBlock(){return{templateUrl:"components/homePage/blocks/texttwoBlock.html"}}function videohpBlock(){return{templateUrl:"components/homePage/blocks/videoBlock.html"}}function missionhpBlock(){return{templateUrl:"components/homePage/blocks/missionBlock.html"}}function brandshpBlock(){return{templateUrl:"components/homePage/blocks/brandsBlock.html"}}function stuffshpBlock(){return{templateUrl:"components/homePage/blocks/stuffsBlock.html"}}function newshpBlock(){return{templateUrl:"components/homePage/blocks/newsBlock.html"}}function campaignhpBlock(){return{templateUrl:"components/homePage/blocks/campaignBlock.html"}}function maphpBlock(){return{templateUrl:"components/homePage/blocks/mapBlock.html"}}function reviewhpBlock(){return{templateUrl:"components/homePage/blocks/reviewBlock.html"}}function subscriptionhpBlock(){return{templateUrl:"components/homePage/blocks/subscriptionBlock.html"}}function callhpBlock(){return{templateUrl:"components/homePage/blocks/callBlock.html"}}function feedbackhpBlock(){return{templateUrl:"components/homePage/blocks/feedbackBlock.html"}}function brandTagshpBlock(){return{templateUrl:"components/homePage/blocks/brandTagsBlock.html"}}function subscriptionAddhpBlock(){return{templateUrl:"components/homePage/blocks/subscriptionAddBlock.html"}}function filterTagshpBlock(){return{templateUrl:"components/homePage/blocks/filterTagsBlock.html"}}function filtershpBlock(){return{templateUrl:"components/homePage/blocks/filtersBlock.html"}}function categorieshpBlock(){return{templateUrl:"components/homePage/blocks/categoriesBlock.html"}}function calendarhpBlock(){return{templateUrl:"components/homePage/blocks/calendarBlock.html"}}function videolinkhpBlock(){return{templateUrl:"components/homePage/blocks/videolinkhpBlock.html"}}function pricegoodshpBlock(){return{templateUrl:"components/homePage/blocks/pricegoodsBlock.html"}}function priceserviceshpBlock(){return{templateUrl:"components/homePage/blocks/priceservicesBlock.html"}}function scheduleplacehpBlock(){return{templateUrl:"components/homePage/blocks/scheduleplaceBlock.html"}}function enterPhoneNumderCtrl($scope,global){function changePhone(){self.phone?self.enterPhoneNumder=self.phoneCode.substring(1)+self.phone.substring(0,10):self.enterPhoneNumder="",self.changeFoo&&"function"==typeof self.changeFoo&&self.changeFoo({phone:self.enterPhoneNumder})}function changeCode(){}var self=this;self.global=global,self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38",$scope.$watch(function(){return self.enterPhoneNumder},function(enterPhoneNumder,old){if(enterPhoneNumder){var phoneCode="+"+enterPhoneNumder.substring(0,enterPhoneNumder.length-10);self.phoneCodes.getOFA("code",phoneCode)&&(self.phoneCode=phoneCode),self.phone=enterPhoneNumder.substring(enterPhoneNumder.length-10)}}),self.changePhone=changePhone,self.changeCode=changeCode}function compileStyleForBlock(block){var elements=[],el="";if(block.blockStyle)for(var i=0;i<lengthStyleBlock;i++){var n;block.blockStyle[i]&&(n=getNamePropertyCSS(i,block.blockStyle[i]))&&(el+="\n"+n[0]+":"+n[1]+";")}if(el&&(el&&(el="{"+el+"}\n"),elements.push(el)),block.elements&&"object"==typeof block.elements)for(var key in block.elements){el="";for(var i=0;i<lengthStyleBlock;i++)if("a"!=key||1!=i){var n;block.elements[key][i]&&(n=getNamePropertyCSS(i,block.elements[key][i]))&&(el+="\n"+n[0]+":"+n[1]+";")}el&&(el=key.replace("@",".")+"{"+el+"}\n"),"a"==key&&block.elements.a[1]&&(el+="a:hover {color:"+block.elements.a[1]+"}"),el&&elements.push(el)}return elements}angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. H:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"H:mm:ss",short:"dd.MM.yy H:mm",shortDate:"dd.MM.yy",shortTime:"H:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"₽",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru",localeID:"ru",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]),angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. H:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"H:mm:ss",short:"dd.MM.yy H:mm",shortDate:"dd.MM.yy",shortTime:"H:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"₽",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru-ru",localeID:"ru_RU",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]),angular.module("ngLocale",[],["$provide",function($provide){function getDecimals(n){n+="";var i=n.indexOf(".");return i==-1?0:n.length-i-1}function getVF(n,opt_precision){var v=opt_precision;void 0===v&&(v=Math.min(getDecimals(n),3));var base=Math.pow(10,v);return{v:v,f:(n*base|0)%base}}var PLURAL_CATEGORY={ZERO:"zero",ONE:"one",TWO:"two",FEW:"few",MANY:"many",OTHER:"other"};$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["ДП","ПП"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до Рождества Христова","от Рождества Христова"],ERAS:["до н. э.","н. э."],FIRSTDAYOFWEEK:0,MONTH:["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","мар.","апр.","мая","июн.","июл.","авг.","сент.","окт.","нояб.","дек."],STANDALONEMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],WEEKENDRANGE:[5,6],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. HH:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"HH:mm:ss",short:"dd.MM.yy HH:mm",shortDate:"dd.MM.yy",shortTime:"HH:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"грн.",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru-ua",localeID:"ru_UA",pluralCat:function(n,opt_precision){var i=0|n,vf=getVF(n,opt_precision);return 0==vf.v&&i%10==1&&i%100!=11?PLURAL_CATEGORY.ONE:0==vf.v&&i%10>=2&&i%10<=4&&(i%100<12||i%100>14)?PLURAL_CATEGORY.FEW:0==vf.v&&i%10==0||0==vf.v&&i%10>=5&&i%10<=9||0==vf.v&&i%100>=11&&i%100<=14?PLURAL_CATEGORY.MANY:PLURAL_CATEGORY.OTHER}})}]),function(){function url_slug(s,opt){s=String(s),opt=Object(opt);var defaults={delimiter:"-",limit:void 0,lowercase:!0,replacements:{},transliterate:"undefined"==typeof XRegExp};for(var k in defaults)opt.hasOwnProperty(k)||(opt[k]=defaults[k]);var char_map={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Æ":"AE","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ð":"D","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ő":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ű":"U","Ý":"Y","Þ":"TH","ß":"ss","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","æ":"ae","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ð":"d","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ő":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ű":"u","ý":"y","þ":"th","ÿ":"y","©":"(c)","Α":"A","Β":"B","Γ":"G","Δ":"D","Ε":"E","Ζ":"Z","Η":"H","Θ":"8","Ι":"I","Κ":"K","Λ":"L","Μ":"M","Ν":"N","Ξ":"3","Ο":"O","Π":"P","Ρ":"R","Σ":"S","Τ":"T","Υ":"Y","Φ":"F","Χ":"X","Ψ":"PS","Ω":"W","Ά":"A","Έ":"E","Ί":"I","Ό":"O","Ύ":"Y","Ή":"H","Ώ":"W","Ϊ":"I","Ϋ":"Y","α":"a","β":"b","γ":"g","δ":"d","ε":"e","ζ":"z","η":"h","θ":"8","ι":"i","κ":"k","λ":"l","μ":"m","ν":"n","ξ":"3","ο":"o","π":"p","ρ":"r","σ":"s","τ":"t","υ":"y","φ":"f","χ":"x","ψ":"ps","ω":"w","ά":"a","έ":"e","ί":"i","ό":"o","ύ":"y","ή":"h","ώ":"w","ς":"s","ϊ":"i","ΰ":"y","ϋ":"y","ΐ":"i","А":"A","Б":"B","В":"V","Г":"G","Д":"D","Е":"E","Ё":"Yo","Ж":"Zh","З":"Z","И":"I","Й":"J","К":"K","Л":"L","М":"M","Н":"N","О":"O","П":"P","Р":"R","С":"S","Т":"T","У":"U","Ф":"F","Х":"H","Ц":"C","Ч":"Ch","Ш":"Sh","Щ":"Sh","Ъ":"","Ы":"Y","Ь":"","Э":"E","Ю":"Yu","Я":"Ya","а":"a","б":"b","в":"v","г":"g","д":"d","е":"e","ё":"yo","ж":"zh","з":"z","и":"i","й":"j","к":"k","л":"l","м":"m","н":"n","о":"o","п":"p","р":"r","с":"s","т":"t","у":"u","ф":"f","х":"h","ц":"c","ч":"ch","ш":"sh","щ":"sh","ъ":"","ы":"y","ь":"","э":"e","ю":"yu","я":"ya","Є":"Ye","І":"I","Ї":"Yi","Ґ":"G","є":"ye","і":"i","ї":"yi","ґ":"g","Č":"C","Ď":"D","Ě":"E","Ň":"N","Ř":"R","Š":"S","Ť":"T","Ů":"U","Ž":"Z","č":"c","ď":"d","ě":"e","ň":"n","ř":"r","š":"s","ť":"t","ů":"u","ž":"z"};for(var k in opt.replacements)s=s.replace(RegExp(k,"g"),opt.replacements[k]);if(opt.transliterate)for(var k in char_map)s=s.replace(RegExp(k,"g"),char_map[k]);var alnum="undefined"==typeof XRegExp?RegExp("[^a-z0-9]+","ig"):XRegExp("[^\\p{L}\\p{N}]+","ig");return s=s.replace(alnum,opt.delimiter),s=s.replace(RegExp("["+opt.delimiter+"]{2,}","g"),opt.delimiter),s=s.substring(0,opt.limit),s=s.replace(RegExp("(^"+opt.delimiter+"|"+opt.delimiter+"$)","g"),""),opt.lowercase?s.toLowerCase():s}function decimalAdjust(type,value,exp){return void 0===exp||0==+exp?Math[type](value):(value=+value,exp=+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp))),value=value.toString().split("e"),+(value[0]+"e"+(value[1]?+value[1]+exp:exp))))}Math.round10||(Math.round10=function(value,exp){return decimalAdjust("round",value,exp)}),Math.floor10||(Math.floor10=function(value,exp){return decimalAdjust("floor",value,exp)}),Math.ceil10||(Math.ceil10=function(value,exp){return decimalAdjust("ceil",value,exp)}),Array.prototype.getObjectFromArray=function(prop,value,a,filter){for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].toString&&"function"==typeof this[i][prop].toString&&(this[i][prop]=this[i][prop].toString()),this[i][prop]&&this[i][prop]==value){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.getOFA=function(prop,value,a,filter){prop=prop.split("."),1==prop.length&&(prop=prop[0]);for(var ar=[],i=0,l=this.length;i<l;i++)if(this[i]&&(this[i][prop]&&this[i][prop].toString&&"function"==typeof this[i][prop].toString&&(this[i][prop]=this[i][prop].toString()),this[i][prop]&&this[i][prop]==value||prop.length&&this[i][prop[0]]&&this[i][prop[0]][prop[1]]&&this[i][prop[0]][prop[1]]==value)){if(!a)return this[i];filter?this[i][filter]&&ar.push(this[i]):ar.push(this[i])}return a?ar:void 0},Array.prototype.removeOFA=function(prop,value){for(var i=this.length;i--;)this[i]&&this[i].hasOwnProperty(prop)&&arguments.length>1&&this[i][prop]===value&&this.splice(i,1);return this},Array.prototype.getArrayObjects=function(prop,value){for(var arr=[],i=0,l=this.length;i<l;i++)if(this[i][prop]&&this[i][prop].length){var _arr=this[i][prop].map(function(item){return"object"==typeof item?item._id:item});_arr.indexOf(value)>-1&&arr.push(this[i])}return arr},Array.prototype.diff=function(a){return this.filter(function(i){return a.indexOf(i)<0})},Array.prototype.divideArrayWithChunk=function(chunk,fillArrayToEquil){if(!chunk)return[[],[],[],[],[]];if((chunk=Number(chunk))<2)return this;for(var data=this,arr=[],j=0;j<chunk;j++){arr[j]=[];for(var i=j,l=data.length;i<l;i+=chunk)arr[j].push(data[i])}if(fillArrayToEquil)for(var i=1,l=arr.length;i<l;i++)arr[i].length<arr[0].length&&arr[i].push({});return arr},Array.prototype.extend=function(other_array){other_array.forEach(function(v){this.push(v)},this)},String.prototype.clearTag=function(num){return num?this.replace(/<\/?[^>]+(>|$)/g,"").substring(0,num):this.replace(/<\/?[^>]+(>|$)/g,"")},String.prototype.myTrim=function(){return this.trim().split("\n").filter(function(str){return str}).map(function(str){return str.replace(/&nbsp;/g," ").trim()}).filter(function(str){return str}).join("")},String.prototype.clearFirstTag=function(tag){var i=tag.length;return this.substring(2+i,this.length-(3+i))},String.prototype.replaceBlanks=function(){if(this)return this.replace(/(["',.\/\s])/g,"-")},String.prototype.getFormatedDate=function(){var d=new Date(this);return d.getDate()+"-"+(d.getMonth()+1)+"-"+d.getFullYear()},String.prototype.splice||(String.prototype.splice=function(start,delCount,newSubStr){return this.slice(0,start)+newSubStr+this.slice(start+Math.abs(delCount))});new Array("Я","я","Ю","ю","Ч","ч","Ш","ш","Щ","щ","Ж","ж","А","а","Б","б","В","в","Г","г","Д","д","Е","е","Ё","ё","З","з","И","и","Й","й","К","к","Л","л","М","м","Н","н","О","о","П","п","Р","р","С","с","Т","т","У","у","Ф","ф","Х","х","Ц","ц","Ы","ы","Ь","ь","Ъ","ъ","Э","э","/","&"),new Array("Ya","ya","Yu","yu","Ch","ch","Sh","sh","Sh","sh","Zh","zh","A","a","B","b","V","v","G","g","D","d","E","e","E","e","Z","z","I","i","J","j","K","k","L","l","M","m","N","n","O","o","P","p","R","r","S","s","T","t","U","u","F","f","H","h","C","c","Y","y","","","'","'","E","e","-","-");String.prototype.getUrl=function(){return url_slug(this)},String.prototype.shuffle=function(len){len||(len=this.length);for(var parts=this.split(""),i=parts.length;i>0;){var random=parseInt(Math.random()*i),temp=parts[--i];parts[i]=parts[random],parts[random]=temp}return parts.join("").substring(0,len)}}(),function(){function checkMaxDiscount(stuff,price){stuff.maxDiscount&&100*(1-price/stuff.price)>stuff.maxDiscount&&(stuff.maxDiscountOver=!0)}function getOrder(){return new order}var order=function(){function _checkInCondition(__campaign,stuff){var stuffBrand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,stuffCategory="object"==typeof stuff.category&&stuff.category.length?stuff.category[0]:stuff.category;return!!(__campaign.conditionStuffs&&__campaign.conditionStuffs.length&&__campaign.conditionStuffs.indexOf(stuff._id)>-1)||(!!(__campaign.conditionTags&&__campaign.conditionTags.length&&__campaign.conditionTags.some(function(tag){return stuff.tags.indexOf(tag)>-1}))||(!!(__campaign.conditionBrandTags&&__campaign.conditionBrandTags.length&&__campaign.conditionBrandTags.indexOf(stuff.brandTag)>-1)||(!!(__campaign.conditionBrands&&__campaign.conditionBrands.length&&__campaign.conditionBrands.indexOf(stuffBrand)>-1)||(!!(__campaign.conditionCategories&&__campaign.conditionCategories.length&&__campaign.conditionCategories.indexOf(stuffCategory)>-1)||void 0))))}var self=this;this.cart={stuffs:[]},this.seller=null,this.cascade=[],this.opt={},this.campaign=[],this.coupon={},this.totalCount=0,this.sum=0,this.price,this.priceSale,this.retail,this.discount=null,this.currency,this.mainCurrency,this.currencyStore,this.messageForCampaign={},this.type,this.user,this.paySum,this._cartCount=function(campaign,cam){var i=0;return this.cart.stuffs.forEach(function(item){campaign?"withoutcampaign"==campaign?item.campaignId||(cam?_checkInCondition(cam,item)&&(i+=Number(item.quantity)):i+=Number(item.quantity)):item.campaignId==campaign&&(i+=Number(item.quantity)):item.quantity&&(i+=Number(item.quantity))}),i},this._checkDiscount=function(){var dis=this.discount;if(dis)return dis.value||(dis.value=0),1==dis.type||3==dis.type?self.price:2==dis.type||4==dis.type||5==dis.type?self.priceSale?self.priceSale:self.price:void 0},this._getDiscountPrice=function(dis,s){if(dis){if(dis.value||(dis.value=0),1==dis.type)return s.price;if(2==dis.type)return s.priceSale?s.priceSale:s.price;if(3==dis.type)return Math.ceil10(s.price-s.price/100*dis.value,-5);if(4==dis.type)return s.priceSale?s.priceSale:Math.ceil10(s.price-s.price/100*dis.value,-5);if(5==dis.type){var cena;return cena=s.priceSale?s.priceSale:s.price,Math.ceil10(cena-cena/100*dis.value,-5)}}},this._checkDiscount2302=function(){var dis=this.discount;if(dis){if(dis.value||(dis.value=0),1==dis.type)return self.price;if(2==dis.type)return self.priceSale?self.priceSale:self.price;if(3==dis.type)return Math.ceil10(self.price-self.price/100*dis.value,-5);if(4==dis.type)return self.priceSale?self.priceSale:Math.ceil10(self.price-self.price/100*dis.value,-5);if(5==dis.type){var cena;return cena=self.priceSale?self.priceSale:self.price,Math.ceil10(cena-cena/100*dis.value,-5)}}},this._isStuffInCampaign=function(stuff,campaign){function check(__campaign){return!!(__campaign.stuffs&&__campaign.stuffs.length&&__campaign.stuffs.indexOf(stuff._id)>-1)||(!!(__campaign.tags&&__campaign.tags.length&&stuff.tags&&__campaign.tags.some(function(tag){return stuff.tags.indexOf(tag)>-1}))||(!!(__campaign.brandTags&&__campaign.brandTags.length&&__campaign.brandTags.indexOf(stuff.brandTag)>-1)||(!!(__campaign.brands&&__campaign.brands.length&&__campaign.brands.indexOf(stuffBrand)>-1)||(!!(__campaign.categories&&__campaign.categories.length&&__campaign.categories.indexOf(stuffCategory)>-1)||void 0))))}function setCampaignPrice(__campaign){stuff.sticker=__campaign.sticker,stuff.campaignUrl=__campaign.url,stuff.campaignId=__campaign._id;var i=0;for(var key in stuff.stock){var price=Number(stuff.stock[key].price);stuff.stock[key].priceCampaign="percent"==__campaign.condition?Math.ceil10(price-Number(__campaign.percent)/100*price,-2):Math.ceil10(price-Number(__campaign.sum),-2),i||(i++,stuff.priceCampaign=stuff.stock[key].priceCampaign)}}var stuffCategory="object"==typeof stuff.category&&stuff.category.length?stuff.category[0]:stuff.category,stuffBrand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand;if(!self.campaign||!self.campaign.length)return!1;if(campaign){var __campaign=self.campaign.getObjectFromArray("_id",campaign);if(__campaign){var is=check(__campaign)
;if(is&&!__campaign.revers||!is&&__campaign.revers)return setCampaignPrice(__campaign),__campaign}}else for(var j=0,ll=self.campaign.length;j<ll;j++){var is=check(self.campaign[j]);if(is&&!self.campaign[j].revers||!is&&self.campaign[j].revers)return setCampaignPrice(self.campaign[j]),self.campaign[j]}return!1},this._getCountForBaseStuffs=function(campaign){var q=0;return this.cart.stuffs.forEach(function(item){campaign.forGroupBase?campaign.groupBaseTag&&item.tags&&item.tags.indexOf(campaign.groupBaseTag)>-1?q+=Number(item.quantity):campaign.groupBaseCollection&&campaign.groupBaseCollection==stuff.brandTag&&(q+=Number(item.quantity)):campaign.baseStuffs.indexOf(item._id)>-1&&(q+=Number(item.quantity))}),q},this._checkCompaignCondition=function(id){if(self.campaign){var __campaign=self.campaign.getOFA("_id",id);if(!__campaign||__campaign.forAll||__campaign.revers)return!0;var countConditionStuffs=self._cartCount("withoutcampaign",__campaign);if(!__campaign.ratio)return!0;var countStuff=self._cartCount(__campaign._id);return parseInt(countConditionStuffs/__campaign.ratio)>=countStuff||void 0}},this._checkCompaignConditionForBase=function(id){var campaign=self.campaign.getObjectFromArray("_id",id);if(campaign.useBase&&self._getCountForBaseStuffs(campaign)>=campaign.condition&&!self._cartCount(campaign._id))return!0},this._getUnitOfMeasure=function(){var a=this.cart.stuffs.reduce(function(arr,i){return i.unitOfMeasure&&arr.indexOf(i.unitOfMeasure)<0&&arr.push(i.unitOfMeasure),arr},[]);return 1==a.length?a[0]:null}},_getCascadePrice=function(self){var newPrice=self.price,cascade=self.cascade;if(cascade&&cascade.length){for(var i=0,l=cascade.length;i<l;i++)self.totalCount>=cascade[i][0]&&(newPrice=Math.ceil10(self.price-self.price/100*cascade[i][1],-2));return newPrice}return self.price};order.prototype.init=function(campaign,mainCurrency,currencyStore){this.campaign=campaign,this.mainCurrency=mainCurrency,this.currencyStore=currencyStore},order.prototype.setCamapign=function(campaign){this.campaign=campaign;for(var i=0,l=campaign.length;i<l;i++)this.messageForCampaign[campaign[i].url]={base:null,stuff:null}},order.prototype.setCart=function(stuffs){this.cart.stuffs=stuffs,this.sortCart()},order.prototype.setSellerData=function(seller,cascade,opt){this.seller=seller,this.cascade=cascade,this.opt=opt},order.prototype.setCoupon=function(coupon){this.coupon=coupon},order.prototype.setDiscount=function(discount){this.discount=discount},order.prototype.setCurrency=function(currency){this.currency=currency},order.prototype.changeCurrency=function(currency){this.currency=currency,this.kurs=this.currencyStore[this.currency][0]},order.prototype.getPrice=function(i){var stuff=this.cart.stuffs[i];this.totalCount=this._cartCount(),this.price=stuff.price,this.priceSale=stuff.priceSale,this.retail=stuff.retail,this.priceCampaign=stuff.priceCampaign,stuff.maxDiscountOver=!1;var optIs=!1;(!this.opt||!this.opt.quantity||this.totalCount>=this.opt.quantity)&&(optIs=!0);var cena;return(cena=this._checkDiscount())?(this.discount&&this.discount.value&&stuff.maxDiscount&&this.discount.value>stuff.maxDiscount?stuff.maxDiscountOver=!0:checkMaxDiscount(stuff,cena),cena):stuff.priceCampaign&&optIs&&this._checkCompaignCondition(stuff.campaignId)?stuff.priceCampaign:optIs?this.priceSale?(checkMaxDiscount(stuff,this.priceSale),this.priceSale):_getCascadePrice(this):this.retail||this.price},order.prototype.getTotalSum=function(discount){var sum=0,self=this;if(this.cart.stuffs.forEach(function(c){var s=c.sum?c.sum:c.price;if(discount){var p=self._getDiscountPrice(self.discount,c);p&&(s=p*c.quantity)}sum+=s}),discount){var dis=this.discount;dis&&(6==dis.type?sum=Math.ceil10(sum-sum/100*dis.value,-5):7==dis.type&&(sum-=dis.value))}return sum},order.prototype.getTotalQuantity=function(){var q=0;return this.cart.stuffs.forEach(function(c){q+=Number(c.quantity)}),q},order.prototype.getCampaignQuantity=function(){return this._cartCount("campaign")},order.prototype.getConditionForDisplayMsg=function(){return this.messageForCampaign},order.prototype.getCouponSum=function(){if(!this.coupon||!Object.keys(this.coupon).length)return this.sum;if(!this.coupon.condition)return Math.ceil10(this.sum-this.sum/100*Number(this.coupon.val),-5);if(this.coupon.condition){var val=this.coupon.val;return this.coupon.currency&&this.currencyStore[this.coupon.currency]&&this.currencyStore[this.coupon.currency][0]&&(val=Math.round(val/this.currencyStore[this.coupon.currency][0])),this.sum-Number(val)}},order.prototype.clearOrder=function(){this.cart.stuffs.length=0,this.coupon={},this.totalCount=0,this.sum=0},order.prototype.checkInCart=function(itemTo){return this.cart.stuffs.some(function(c){return itemTo._id==c._id&&itemTo.sort==c.sort})},order.prototype.addStuffToOrder=function(itemTo){if(this.cart.stuffs.length>=150)return!1;if(this.cart.stuffs.some(function(c){return itemTo._id==c._id&&itemTo.sort==c.sort}))return!1;var itemToCart=angular.copy(itemTo);for(var key in itemToCart)"function"==typeof itemToCart[key]&&delete itemToCart[key];return delete itemToCart.comments,delete itemToCart.desc,delete itemToCart.gallery,delete itemToCart.imgs,delete itemToCart.nameL,delete itemToCart.checkInCart,delete itemToCart.addItemToOrder,delete itemToCart.addInfo,delete itemToCart.getDataForBooking,delete itemToCart.FullTags,delete itemToCart.changeSortOfStuff,delete itemToCart.checkInCart,delete itemToCart.driveRetailPrice,delete itemToCart.getBonus,delete itemToCart.zoomImg,delete itemToCart.stockKeysArray,delete itemToCart.sortsOfStuff,delete itemToCart.setPrice,this.cart.stuffs.push(itemToCart),this.sortCart(),!0},order.prototype.getShipCost=function(){return this.shipDetail.reduce(function(s,c){return isNaN(c.sum)?s:s+Number(c.sum)},0)},order.prototype.getTotalPay=function(){return this.pay||(this.pay=[]),this.pay.reduce(function(s,c){return isNaN(c.sum)?s:s+Number(c.sum)},0)},order.prototype.getTotalDiscount=function(){if(this.sum&&this.sum0)return this.sum>this.sum0?0:100-Math.round(100*this.sum/this.sum0)},order.prototype.checkCampaign=function(stuff){return this._isStuffInCampaign(stuff)},order.prototype.sortCart=function(){this.cart.stuffs.sort(function(a,b){if(!a.extCatalog&&!b.extCatalog)return a.category<b.category?-1:a.category>b.category?1:0;if(a.extCatalog&&!b.extCatalog)return 1;if(!a.extCatalog&&b.extCatalog)return-1;if(a.extCatalog&&b.extCatalog&&a.extCatalog!=b.extCatalog){if(a.category<b.category)return-1;if(a.category>b.category)return 1}else if(a.extCatalog&&b.extCatalog&&a.extCatalog==b.extCatalog)return a.category<b.category?-1:a.category>b.category?1:0})};var myShareData={getOrder:getOrder};"undefined"!=typeof window?(window.myShareData=myShareData,window.OrderModel=order):module.exports=myShareData}();var _filterTags=[],_filterTagsO={},myApp=angular.module("gmall",["ngRoute","ui.router","ngResource","ngCookies","ui.bootstrap","ngAnimate","gmall.controllers","gmall.services","gmall.directives","gmall.filters","ui.select","dndLists","daterangepicker","toaster","textAngular","angularCircularNavigation","gmall.exception","angular-intro","satellizer","ngMessages","pageslide-directive","angular-click-outside","rzModule","ui.mask","colorpicker.module","ui.tinymce"]).run(["$rootScope","$state","$stateParams","globalSrv","global","$timeout","$window","$location","$templateCache","Helper","$q","$order","$filter","$route","Stuff","Filters","FilterTags","Sections","Brands","BrandTags",function($rootScope,$state,$stateParams,globalSrv,global,$timeout,$window,$location,$templateCache,Helper,$q,$order,$filter,$route,Stuff,Filters,FilterTags,Sections,Brands,BrandTags){function _changeLocation(url){$window.location.href=url}function _logout(){$rootScope.$broadcast("logout"),$auth.logout(),global.set("user",null),location.reload()}function _logged(){$rootScope.$broadcast("logged")}function _taPaste($html){return $filter("htmlToPlaintextWithBr")($html)}function _getSection(sectionUrl,id){var sections=global.get("groups").val;if(!sections)return null;for(var field=id?"_id":"url",i=0,l=sections.length;i<l;i++){if(sections[i][field]&&sections[i][field]==sectionUrl)return sections[i];if(sections[i].child&&sections[i].child.length)for(var j=0,ll=sections[i].child.length;j<ll;j++)if(sections[i].child[j][field]&&sections[i].child[j][field]==sectionUrl)return sections[i].child[j]}return null}global.set("store",storeTemp),mobileFromServer&&global.set("mobile",mobileFromServer),moment.locale("ru"),$rootScope.displaySlideMenu=!1,$timeout(function(){$.material.togglebutton=function(selector){$(selector?selector:this.options.togglebuttonElements).filter(":notmdproc").filter(function(){return 0===$(this).parent().find(".toggle").length}).data("mdproc",!0).after("<span class=toggle></span>")},$.material.init()}),$rootScope.moment=moment,$rootScope.$state=$state,$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.global=global;$rootScope.$watch(function(){return $location.path()},function(newLocation,oldLocation){if($rootScope.actualLocation===newLocation){$rootScope.$emit("$stateChangeEndToStuff");var back,historyState=$window.history.state;back=!!(historyState&&historyState.position<=$rootScope.stackPosition),back?$rootScope.stackPosition--:$rootScope.stackPosition++}else $route.current&&($window.history.replaceState({position:$rootScope.stackPosition}),$rootScope.stackPosition++)}),$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState){"frame.sections"==fromState.name&&Sections.reloadItems(),"frame.filters"==fromState.name&&(Filters.reloadItems(),FilterTags.reloadItems(),Sections.reloadItems()),"frame.brands"==fromState.name&&(Brands.reloadItems(),Sections.reloadItems()),"frame.stuffs"==fromState.name&&"frame.stuffs.stuff"==toState.name&&($rootScope.srollPosition=$(window).scrollTop()),"frame.stuffs.stuff"==fromState.name&&"frame.stuffs"==toState.name&&(console.log("fromState.name=='frame.stuffs.stuff' && toState.name=='frame.stuffs'"),$rootScope.$broadcast("fromStuffToStuffs")),"frame.stuffs"==toState.name||"frame.stuffs.stuff"==toState.name?$rootScope.$emit("$stateChangeStartToStuff"):$rootScope.endLoadStuffs=!0,$rootScope.slideMenu=!1}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState){$timeout(function(){if(!global.get("user").val)return void $state.go("frame")},4e3),$rootScope.actualLocation=$location.path(),"frame.stuffs.stuff"!=fromState.name||"frame.stuffs"!=toState.name||!$rootScope.srollPosition&&0!=$rootScope.srollPosition||$timeout(function(){window.scrollTo(0,$rootScope.srollPosition)},500),"frame"==toState.name&&$q.when().then(function(){return Sections.getSections()}).then(function(sections){$rootScope.sectopnsForMenu=sections})}),$rootScope.getIntro=function(){var intro=introJs();console.log($rootScope.IntroOptions.steps),intro.setOptions({steps:$rootScope.IntroOptions.steps}),$timeout(function(){intro.start()},300)},$rootScope.setInitData=function(store,mobile){console.log("start2"),global.set("store",store),mobile&&global.set("mobile",mobile)},$rootScope.changeLang=function(lang){global.get("store").val.lang=lang,$rootScope.$broadcast("changeLang",lang)},$rootScope.changeLocation=function(url){$window.location.href=url};var functions={changeLocation:_changeLocation,logout:_logout,logged:_logged,taPaste:_taPaste,getSection:_getSection};global.set("functions",functions);var lang,langError,langOrder,langForm,langNote;globalSrv.getData("lang").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){lang=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("lang",d)}),globalSrv.getData("langError").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langError=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langError",d)}),globalSrv.getData("langNote").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langNote=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langNote",d)}),globalSrv.getData("langOrder").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langOrder=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langOrder",d)}),globalSrv.getData("langForm").then(function(response){var d={};if(response.data&&response.data.length&&response.data[1].tags){langForm=response.data[1].tags;for(var k in response.data[1].tags)d[k]=response.data[1].tags[k][global.get("store").val.lang]}global.set("langForm",d)})}]).config(function($provide){$provide.decorator("$q",["$delegate",function($delegate){function whenFn(){$q.when("function"==typeof obj?obj():obj)}return $delegate.whenFn=whenFn,$delegate}]),$provide.decorator("$resource",["$delegate",function($delegate){return $delegate.updateFiled=function(){console.log(this)},$delegate}])}).config(["$stateProvider","$urlRouterProvider","$locationProvider","globalProvider","$authProvider","$httpProvider",function($stateProvider,$urlRouterProvider,$locationProvider,globalProvider,$authProvider,$httpProvider){$httpProvider.interceptors.push("myInterceptorService"),$authProvider.baseUrl=userHost,$locationProvider.html5Mode(!0),$locationProvider.hashPrefix("!"),globalProvider.setUrl({groups:"/api/collections/Group/",categories:"/api/collections/Category/",brands:"/api/collections/Brand/",campaign:'/api/collections/Campaign?query={"dateEnd":"dateEnd"}',notifications:"/api/notificationList",chatMessages:"/api/chatMessagesList",lang:'/api/collections/Lang?query={"name":"gmall.home"}',langError:'/api/collections/Lang?query={"name":"index.error"}',langNote:'/api/collections/Lang?query={"name":"index.note"}',langOrder:'/api/collections/Lang?query={"name":"index.order"}',langForm:'/api/collections/Lang?query={"name":"index.form"}'}),globalProvider.set("groups"),globalProvider.set("sections"),globalProvider.set("categories"),globalProvider.set("categoriesO"),globalProvider.set("campaign"),globalProvider.set("brands"),globalProvider.set("filters"),globalProvider.set("store"),globalProvider.set("user"),globalProvider.set("admin"),globalProvider.set("mobile"),globalProvider.set("nostore"),globalProvider.set("filterTagsSticker"),globalProvider.set("coupon"),globalProvider.set("sellers"),globalProvider.set("seller"),globalProvider.set("functions"),globalProvider.set("buff_stuffs"),globalProvider.set("lang"),globalProvider.set("langError"),globalProvider.set("langNote"),globalProvider.set("langOrder"),globalProvider.set("langForm"),$stateProvider.state("frame",{url:"/content?token",controller:"mainFrameCtrl",templateUrl:"modules/content/views/index.html"}).state("frame.schedule",{url:"/schedule",template:"<schedule-list></schedule-list>"}).state("frame.labels",{url:"/labels",template:"<labels></labels>"}).state("frame.sections",{url:"/sections",template:"<sections-list></sections-list>"}).state("frame.sections.category",{url:"/:id",template:"<category-edit></category-edit>"}).state("frame.filterEdit",{url:"/filterEdit",template:'<div ui-view=""></div>'}).state("frame.filterEdit.item",{url:"/:id",template:"<filter-item-edit></filter-item-edit>"}).state("frame.filters",{url:"/filters",templateUrl:function(){return"modules/content/views/filters.html"}}).state("frame.filters.tag",{url:"/:id",template:"<filter-tag-edit></filter-tag-edit>"}).state("frame.stuffs",{url:"/stuffs/:groupUrl/:categoryUrl?searchStr&queryTag&brand&brandTag&msg&filters",templateUrl:function(){return"modules/content/views/stuffs.html"},controller:function($scope){$scope.rate={val:1}}}).state("frame.stuffs.stuff",{url:"/:stuffUrl",template:'<stuff-edit back-state="frame.stuffs"></stuff-edit>'}).state("frame.brands",{url:"/brands",templateUrl:function(){return"modules/content/views/brands.html"}}).state("frame.brands.brand",{url:"/brand/:id",template:"<brand-edit></brand-edit>"}).state("frame.brands.category",{url:"/category/:id",resolve:{field:function(){return"brands"}},template:'<bind-model-to-category id="{{id}}" field="brands" backstate="frame.brands"></bind-model-to-category>',controller:function($scope,$stateParams,field){$scope.field=field,$scope.id=$stateParams.id}}).state("frame.brands.categoryTag",{url:"/categoryTag/:id",resolve:{field:function(){return"brandTags"}},template:'<bind-model-to-category id="{{id}}" revers="true" model="BrandTags" field="categories" backstate="frame.brands"></bind-model-to-category>',controller:function($scope,$stateParams,field){$scope.field=field,$scope.id=$stateParams.id}}).state("frame.brands.tag",{url:"/tag/:id",resolve:{item:function(BrandTags,$stateParams){}},template:"<brand-tag-edit ></brand-tag-edit>"}).state("frame.stats",{url:"/stats",template:"<static-pages></static-pages>"}).state("frame.stats.stat",{url:"/:id",template:"<static-page></static-page>"}).state("frame.additionals",{url:"/additionals",template:"<additional-pages></additional-pages>"}).state("frame.additionals.additional",{url:"/:id",template:"<additional-page></additional-page>"}).state("frame.homePage",{url:"/homePage",template:"<home-page></home-page>"}).state("frame.news",{url:"/news",template:"<news-list></news-list>"}).state("frame.news.item",{url:"/:id",template:"<news-item></news-item>"}).state("frame.lookbook",{url:"/lookbook",template:"<lookbook-list></lookbook-list>"}).state("frame.lookbook.item",{url:"/:id",template:"<lookbook-item></lookbook-item>"}).state("frame.master",{url:"/master",template:"<master-list></master-list>"}).state("frame.master.item",{url:"/:id",template:"<master-item></master-item>"}).state("frame.workplace",{url:"/workplace",template:"<workplace-list></workplace-list>"}).state("frame.workplace.item",{url:"/:id",template:"<workplace-item></workplace-item>"}).state("frame.groupStuffs",{url:"/groupStuffs",template:"<group-stuffs-list></group-stuffs-list>"}).state("frame.groupStuffs.item",{url:"/:id",template:"<group-stuffs-item></group-stuffs-item>"}).state("frame.paps",{url:"/paps",template:"<paps-list></paps-list>"}).state("frame.paps.item",{url:"/:id",template:"<paps-item></paps-item>"}).state("frame.info",{url:"/info",template:"<info-list></info-list>"}).state("frame.info.item",{url:"/:id",template:"<info-item></info-item>"}).state("frame.cart",{url:"/cart",template:"<cart-item></cart-item>"}).state("frame.externalCatalog",{url:"/externalCatalog",template:"<external-catalog-download></external-catalog-download>"}).state("frame.help",{url:"/help",template:"<help-component></help-component>"}).state("frame.help.category",{url:"/:category?store",template:"<help-category></help-category>"}).state("frame.help.category.stuff",{url:"/:stuff",template:"<help-stuff></help-stuff>"})}]).config(function($provide){function getExpressions(str){for(var left,right,offset=0,parts=[];(left=str.indexOf("{{",offset))>-1&&(right=str.indexOf("}}",offset))>-1;)parts.push(str.substr(left+2,right-left-2)),offset=right+1;return parts}$provide.decorator("ngSrcDirective",function($delegate,$parse){var ngSrc=$delegate[0];return ngSrc.compile=function(element,attrs){var expressions=getExpressions(attrs.ngSrc),getters=expressions.map($parse);return function(scope,element,attr){attr.$observe("ngSrc",function(value){getters.every(function(getter){return getter(scope)}),value&&value.indexOf("images/")>-1&&value.indexOf("http")<0&&photoHost?attr.$set("src",photoHost+"/"+value):attr.$set("src",value)})}},delete ngSrc.link,$delegate})});angular.module("gmall.directives",[]).directive("emptyList",["$timeout",function($timeout){return{restrict:"E",scope:{items:"=items",message:"@"},template:'<div ng-if="show" class="alert alert-dismissible alert-warning"><h3 ng-bind="message"></h3></div>',link:function(scope,element){scope.$watch("items",function(n,o){scope.show=0===n})}}}]).directive("contentLoaded",["$timeout","$rootScope","anchorSmoothScroll",function($timeout,$rootScope,anchorSmoothScroll){return{restrict:"AC",link:function(scope,element,attr){$rootScope.$on("$stateChangeStartToStuff",function(){console.log("$stateChangeStartToStuff"),$(element).fadeIn()}),$rootScope.$on("$stateChangeEndToStuff",function(){console.log("$stateChangeEndToStuff"),$(element).fadeOut()})}}}]),angular.module("gmall.controllers",[]).controller("mainFrameCtrl",["$rootScope","$auth","$location","Account","toaster","global","$user","$q",function($rootScope,$auth,$location,Account,toaster,global,$user,$q){function activate(){$q.when($auth.isAuthenticated()).then(function(auth){if(!auth)return $user.login()}).then(function(){return Account.getPermission()}).then(function(res){res?(global.set("user",res.data),global.set("seller",res.data.seller)):(toaster.error("у данного аккаунта нет прав"),logout())}).catch(function(error){return error&&error.data&&toaster.error(error.data.message,error.status),logout()})}function logout(){$q.when($auth.isAuthenticated()).then(function(auth){if(auth)return $auth.logout()}).then(function(){global.set("user",null),global.set("seller",null),activate()})}$rootScope.$stateParams.token&&($auth.setToken({data:{token:$rootScope.$stateParams.token}}),$location.search("token",null)),activate(),$rootScope.logout=logout}]),angular.module("gmall.services",[]).factory("socket",function(socketFactory){return socketFactory()}),angular.module("gmall.filters",[]).filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}}).filter("trustUrl",["$sce",function($sce){return function(recordingUrl){return $sce.trustAsResourceUrl(recordingUrl)}}]).filter("htmlToPlaintext",function(){return function(text){if(text){var s=text.replace(/(<[^>]+) style=".*?"/i,"");return s?String(s).replace(/<[^>]+>/gm,""):""}}}).filter("htmlToPlaintextWithBr",function(){var walk_the_DOM=function walk(node,func){for(func(node),node=node.firstChild;node;)walk(node,func),node=node.nextSibling};return function(markup){var wrapper=document.createElement("div");wrapper.innerHTML=markup,walk_the_DOM(wrapper,function(el){el.removeAttribute&&(el.removeAttribute("id"),el.removeAttribute("style"),el.removeAttribute("class"))});var result=wrapper.innerHTML,arr=result.split("<br>");return arr.forEach(function(s,i){arr[i]=s.replace(/<[^>]+>/gm,"")}),result}}),function(){function userSign(){return{scope:{closeModal:"&",toaster:"@",social:"="},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/sign.html",restrict:"AE"}}function subscriptionAdd(){return{scope:{closeModal:"&",toaster:"@"},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/subscriptionAdd.html",restrict:"AE"}}function userSignShort(){return{scope:{toaster:"@",buttonName:"@"},bindToController:!0,controller:signupCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/sign-short.html",restrict:"AE"}}function userLogin(){return{scope:{closeModal:"&",modalClose:"&",toaster:"@",social:"=",successFoo:"&"},bindings:{toaster:"<",social:"=",successFoo:"&"},bindToController:!0,controller:loginCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/login.html",restrict:"AE"}}function userLoginPhone(){return{scope:{closeModal:"&",modalClose:"&",toaster:"@",social:"=",successFoo:"&"},bindings:{toaster:"<",social:"=",successFoo:"&"},bindToController:!0,controller:loginPhoneCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/loginPhone.html",restrict:"AE"}}function enterButton(){return{scope:{toaster:"@"},bindToController:!0,controller:enterButtonCtrl,controllerAs:"$ctrl",templateUrl:"/components/sign-login/enter-button.html",restrict:"AE"}}function signupCtrl($scope,$auth,toaster,$q,global,Account,$state,Stuff,CreateContent,$email,exception){function signup(form){form.$valid&&(self.user.store=global.get("store").val._id,$auth.signup(self.user).then(function(response){if(response&&response.data&&response.data.token){if("update"==response.data.token)throw $scope.$emit("closeWitget"),toaster.info(response.data.message),null;$auth.setToken(response);var msg=global.get("langNote").val.subscriptionSuccess;return toaster.info(msg),Account.getProfile()}throw response}).then(function(response){if($scope.$emit("closeWitget"),response){if(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}),"cart"==$state.current.name||"stuffs.stuff"==$state.current.name)return;var states=$state.get();if(global.get("paps")&&global.get("paps").val&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","subscription");pap&&pap.url&&$state.go("thanksPage",{id:pap.url})}}}).then(function(){if("subscription"==self.user.type){if(global.get("coupons")&&global.get("coupons").val&&global.get("coupons").val.length)return[{imgs:global.get("coupons").val}]}else if("subscriptionAdd"==self.user.type){var p={page:0,rows:100},query={$and:[{orderType:4},{actived:!0}]};return Stuff.getList(p,query)}}).then(function(stuffs){if(stuffs&&stuffs.length){if(!self.user||!self.user.email)throw"нет email";var content=CreateContent.emailBonus(stuffs),bonus=global.get("langNote").val.getBonus,domain=global.get("store").val.domain,o={email:self.user.email,content:content,subject:bonus+" ✔",from:"<promo@"+domain+">"};return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note","",global.get("langNote").val.emailSent),resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).catch(function(err){err&&exception.catcher("signup")(err)}))}function authenticate(provider){$auth.authenticate(provider).then(function(response){$scope.$emit("closeWitget"),$auth.setToken(response);var msg=global.get("langNote").val.subscriptionSuccess;toaster.info(msg)}).then(function(){return Account.getProfile()}).then(function(response){console.log(response),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(error){self.toaster&&(error.error?toaster.error(error.error):error.data?toaster.error(error.data.message,error.status):toaster.error(error))})}var self=this;self.global=global,self.formData=global.get("store").val.bonusForm?global.get("store").val.bonusForm:{phone:!0,fields:[]},self.user={email:"",profile:{},addInfo:{},subscription:!0},self.buttonName||self.buttonName,self.signup=signup,self.authenticate=authenticate}function loginCtrl($scope,$auth,toaster,$q,global,Account,exception,sendPhoneFactory,$timeout){function login(form){form.$valid||retrun,self.user.store=global.get("store").val._id,$auth.login(self.user).then(function(data){console.log(data),self.successFoo?self.successFoo():$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite)}).then(function(){return Account.getProfile()}).then(function(response){response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"})),$timeout(function(){$scope.$emit("closeWitget")},50)}).catch(function(err){global.set("user",null),self.toaster&&exception.catcher("login")(err)})}function authenticate(provider){$auth.authenticate(provider).then(function(response){$scope.$emit("closeWitget"),self.successFoo&&"function"==typeof self.successFoo?self.successFoo():$scope.$emit("closeWitget");var msg=global.get("langNote").val.authComplite;toaster.info(msg)}).then(function(){return Account.getProfile()}).then(function(response){response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(error){self.toaster&&(error.error?toaster.error(error.error):error.data?toaster.error(error.data.message,error.status):toaster.error(error))})}function sendCodeToPhone(){self.sendCodeDisable||(self.sendCodeDisable=!0,console.log(self.phone),self.phone&&$q.when().then(function(){return sendPhoneFactory.sendCodeToPhone(self.phone)}).then(function(){self.codeSent=!0,exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)}))}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){self.successFoo?self.successFoo():$scope.$emit("closeWitget"),$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}var self=this;self.$onInit=function(){},self.login=login,self.authenticate=authenticate,self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.global=global,self.phone=null,self.codeSent,self.sendCodeDisable,self.sendVerifyCodeDisable}function enterButtonCtrl(toaster,$q,Account,global,exception){function getEnterButton(form){form.$invalid||$q.when().then(function(){return self.blockButton=!0,setTimeout(function(){self.blockButton=!1},1e3),Account.getEnterButton(self.user)}).then(function(response){self.toaster&&toaster.info(response.data.message)}).catch(function(err){err&&exception.catcher(global.get("langNote").val.error)(err)})}var self=this;self.global=global,self.getEnterButton=getEnterButton}function loginPhoneCtrl($scope,$auth,toaster,$q,global,Account,exception,sendPhoneFactory,$timeout,$user){function sendCodeToPhone(){self.sendCodeDisable||(self.sendCodeDisable=!0,self.phone&&$q.when().then(function(){return sendPhoneFactory.checkPhone(self.phone)}).then(function(res){if(!res||!res._id)return $user.newUserByPhone(self.name,self.phone)}).then(function(){return console.log("sendPhoneFactory.sendCodeToPhone(self.phone)"),sendPhoneFactory.sendCodeToPhone(self.phone)}).then(function(){self.codeSent=!0,exception.showToaster("info","send code","success"),$timeout(function(){self.sendCodeDisable=!1},1e4)}).catch(function(err){err&&exception.catcher("send code")(err),$timeout(function(){self.sendCodeDisable=!1},1e4)}))}function verifyCode(form){self.sendVerifyCodeDisable||form.$invalid||self.code&&self.phone&&(self.sendVerifyCodeDisable=!0,$q.when().then(function(){return sendPhoneFactory.verifyCode(self.code,self.phone)}).then(function(response){if(exception.showToaster("info","verify code","success"),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3),response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();throw"wrong response"}).then(function(response){self.successFoo?self.successFoo():$scope.$emit("closeWitget"),$scope.$emit("closeWitget"),self.toaster&&toaster.info(global.get("langNote").val.authComplite),response&&(global.set("user",response.data),global.get("functions").val.logged(),$scope.$emit("cartslide",{event:"signLogin"}))}).catch(function(err){self.wrongCode=!0,global.set("user",null),err&&exception.catcher("verify code")(err),$timeout(function(){self.sendVerifyCodeDisable=!1},5e3)}))}var self=this;self.$onInit=function(){},self.sendCodeToPhone=sendCodeToPhone,self.verifyCode=verifyCode,self.global=global,self.phone=null,self.name="",self.codeSent,self.sendCodeDisable,
self.sendVerifyCodeDisable}angular.module("gmall.directives").directive("userSign",userSign).directive("subscriptionAdd",subscriptionAdd).directive("userSignShort",userSignShort).directive("userLogin",userLogin).directive("userLoginPhone",userLoginPhone).directive("enterButton",enterButton),signupCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","$state","Stuff","CreateContent","$email","exception"],loginCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","exception","sendPhoneFactory","$timeout"],loginPhoneCtrl.$inject=["$scope","$auth","toaster","$q","global","Account","exception","sendPhoneFactory","$timeout","$user"]}(),function(){angular.module("gmall.directives").directive("pswdCheck",["$timeout",function($timeout){return{require:"ngModel",link:function(scope,elem,attrs,ctrl){var firstPassword="#"+attrs.pswdCheck;$timeout(function(){elem.on("keyup",function(){scope.$apply(function(){var v=elem.val()===$(firstPassword).val();console.log(v),ctrl.$setValidity("pswdmatch",v)})})},100)}}}]).directive("passwordMatch",function(){return{require:"ngModel",scope:{otherModelValue:"=passwordMatch"},link:function(scope,element,attributes,ngModel){ngModel.$validators.compareTo=function(modelValue){return!("undefined"!==modelValue&&""!==modelValue&&modelValue||"undefined"!==scope.otherModelValue&&""!==scope.otherModelValue&&scope.otherModelValue)||modelValue===scope.otherModelValue},scope.$watch("otherModelValue",function(){ngModel.$validate()})}}}).directive("passwordStrength",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){var indicator=element.children(),dots=Array.prototype.slice.call(indicator.children()),weakest=dots.slice(-1)[0],weak=dots.slice(-2),strong=dots.slice(-3),strongest=dots.slice(-4);element.after(indicator),element.bind("keyup",function(){var tmp,matches={positive:{},negative:{}},counts={positive:{},negative:{}},strength=0;angular.forEach(dots,function(el){el.style.backgroundColor="#ebeef1"}),ngModel.$viewValue&&(matches.positive.lower=ngModel.$viewValue.match(/[a-z]/g),matches.positive.upper=ngModel.$viewValue.match(/[A-Z]/g),matches.positive.numbers=ngModel.$viewValue.match(/\d/g),matches.positive.symbols=ngModel.$viewValue.match(/[$-\/:-?{-~!^_`\[\]]/g),matches.positive.middleNumber=ngModel.$viewValue.slice(1,-1).match(/\d/g),matches.positive.middleSymbol=ngModel.$viewValue.slice(1,-1).match(/[$-\/:-?{-~!^_`\[\]]/g),counts.positive.lower=matches.positive.lower?matches.positive.lower.length:0,counts.positive.upper=matches.positive.upper?matches.positive.upper.length:0,counts.positive.numbers=matches.positive.numbers?matches.positive.numbers.length:0,counts.positive.symbols=matches.positive.symbols?matches.positive.symbols.length:0,counts.positive.numChars=ngModel.$viewValue.length,tmp+=counts.positive.numChars>=8?1:0,counts.positive.requirements=tmp>=3?tmp:0,counts.positive.middleNumber=matches.positive.middleNumber?matches.positive.middleNumber.length:0,counts.positive.middleSymbol=matches.positive.middleSymbol?matches.positive.middleSymbol.length:0,matches.negative.consecLower=ngModel.$viewValue.match(/(?=([a-z]{2}))/g),matches.negative.consecUpper=ngModel.$viewValue.match(/(?=([A-Z]{2}))/g),matches.negative.consecNumbers=ngModel.$viewValue.match(/(?=(\d{2}))/g),matches.negative.onlyNumbers=ngModel.$viewValue.match(/^[0-9]*$/g),matches.negative.onlyLetters=ngModel.$viewValue.match(/^([a-z]|[A-Z])*$/g),counts.negative.consecLower=matches.negative.consecLower?matches.negative.consecLower.length:0,counts.negative.consecUpper=matches.negative.consecUpper?matches.negative.consecUpper.length:0,counts.negative.consecNumbers=matches.negative.consecNumbers?matches.negative.consecNumbers.length:0,strength+=4*counts.positive.numChars,counts.positive.upper&&(strength+=2*(counts.positive.numChars-counts.positive.upper)),counts.positive.lower&&(strength+=2*(counts.positive.numChars-counts.positive.lower)),(counts.positive.upper||counts.positive.lower)&&(strength+=4*counts.positive.numbers),strength+=6*counts.positive.symbols,strength+=2*(counts.positive.middleSymbol+counts.positive.middleNumber),strength+=2*counts.positive.requirements,strength-=2*counts.negative.consecLower,strength-=2*counts.negative.consecUpper,strength-=2*counts.negative.consecNumbers,matches.negative.onlyNumbers&&(strength-=counts.positive.numChars),matches.negative.onlyLetters&&(strength-=counts.positive.numChars),strength=Math.max(0,Math.min(100,Math.round(strength))),strength>85?angular.forEach(strongest,function(el){el.style.backgroundColor="#008cdd"}):strength>65?angular.forEach(strong,function(el){el.style.backgroundColor="#6ead09"}):strength>30?angular.forEach(weak,function(el){el.style.backgroundColor="#e09115"}):weakest.style.backgroundColor="#e01414")})},template:'<span class="password-strength-indicator"><span></span><span></span><span></span><span></span></span>'}})}(),angular.module("gmall.exception",[]).factory("exception",exception),exception.$inject=["toaster"],angular.module("gmall.services").factory("Confirm",confirmFactory),confirmFactory.$inject=["$q","$uibModal"],angular.module("gmall.services").factory("myInterceptorService",function($q,$rootScope,$templateCache){var keys=$templateCache.getKeys(),store=globalStoreId;try{globalCrawler&&globalCrawler}catch(err){}return{request:function(config){return keys.indexOf(config.url)>-1?config:(config.params=config.params||{},config.params.store||(config.params.store=store),$rootScope.global&&$rootScope.global.get("store")&&$rootScope.global.get("store").val&&$rootScope.global.get("store").val.lang&&(config.params.lang=$rootScope.global.get("store").val.lang),config)},response:function(response){return response.status,response}}}),angular.module("gmall").config(["$provide",function($provide){$provide.decorator("$templateCache",["$delegate",function($delegate){var keys=[],origPut=$delegate.put;return $delegate.put=function(key,value){origPut(key,value),keys.push(key)},$delegate.getKeys=function(){return keys},$delegate}])}]),angular.module("gmall.services").service("Store",function($resource,$q,$uibModal,$http){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}return Items.get({_id:id}).$promise.then(getItemComplete)}function upload(item){var url=storeHost?"http://"+storeHost+"/api/upload/"+item._id:"/api/upload/"+item._id;return $http.get(url)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/storeSetting/createStore.html",controller:createStoreCtrl,controllerAs:"$ctrl"}).result.then(function(store){store.name?(store.name=store.name.substring(0,25),resolve(store)):reject("empty")},function(err){reject(err)})})}function selectPartOfTemplate(stores){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/selectStore.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,stores){function selectStore(store){$uibModalInstance.close(store)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.stores=stores,self.selectStore=selectStore,self.cancel=cancel},resolve:{stores:function(){return stores}}}).result}function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/selectItem.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}function createStoreCtrl($uibModalInstance,exception,$user){function addOwner(){$user.selectItem().then(function(user){self.user=user})}var self=this;self.name="",self.addOwner=addOwner,self.ok=function(){if(!self.name)return void exception.catcher("создание магазина")("нужено название");$uibModalInstance.close({name:self.name})},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Store/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,upload:upload,create:create,selectPartOfTemplate:selectPartOfTemplate,selectItemFromList:selectItemFromList}}).service("Template",function($resource,$q,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/storeSetting/createTemplate.html",controller:createTemplateCtrl,controllerAs:"$ctrl"}).result.then(function(o){o.name?(o.name=o.name.substring(0,25),resolve(o)):reject("empty")},function(err){reject(err)})})}function createTemplateCtrl($uibModalInstance,exception){var self=this;self.name="",self.folder="",self.ok=function(){if(!self.name||!self.folder)return void exception.catcher("создание шаблона")("нужено имя и папка");$uibModalInstance.close({name:self.name,folder:self.folder})},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}var Items=$resource("/api/collections/Template/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}).service("BlocksConfig",function($resource,$q,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0,rows:500}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/selectItemForBlocks.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}var Items=$resource("/api/collections/BlocksConfig/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,selectItemFromList:selectItemFromList}}).service("Config",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Config/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}).service("ConfigData",function($resource,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/ConfigData/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}).service("Seller",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}function getItem(id,param){function getItemComplete(response){return response}return Items.get({_id:id,param:param}).$promise.then(getItemComplete)}var Items=$resource("/api/collections/Seller/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete}}).service("siteName",function($uibModal){function choiceName(data){return $uibModal.open({animation:!0,templateUrl:"components/storeSetting/modal/websiteName.html",controller:function($uibModalInstance,global,Store,data){function checkSubDomain(name){if(name&&!(name.length>20)){var o={};o[self.field]=name.toLowerCase(),Store.query({query:o},function(res){res&&res.length?(console.log(!0),self.exist=!0):self.exist=!1},function(err){self.exist=!0})}}var self=this;self.global=global,self.item="",self.focus=!0,self.windowName="Выберите поддомен",self.field="subDomain",data&&(data.windowName&&(self.windowName=data.windowName),data.field&&(self.field=data.field)),self.checkSubDomain=checkSubDomain,self.exist=!1,self.re=/^[a-zA-Z0-9][a-zA-Z0-9-_\.]{1,20}$/,self.ok=function(websiteNameForm){websiteNameForm.$invalid||self.exist||$uibModalInstance.close(self.item.toLowerCase())},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{data:function(){return data}}}).result}return{choiceName:choiceName}}),angular.module("gmall.services").service("Sections",sectionServiceFunction).service("selectCategoryFromModal",function($q,$uibModal){this.bind=function(categoryId){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/selectCategoryModal/selectCategoryModal.html",controller:"selectCategoryModalCtrl",size:"lg",resolve:{categoryId:function(){return categoryId}}};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}}),sectionServiceFunction.$inject=["$resource","$q","global","$uibModal","$timeout"],function(){function categoryService($resource,$uibModal,$q){function save(){return Items.save.apply(this,arguments).$promise.then(function(){})}function select(categoryId,selectSection,sections,forGroupStuffs){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectCategoryModal.html",controller:selectCategoryCtrl,size:"lg",resolve:{categoryId:function(){return categoryId},selectSection:function(){return selectSection},sections:function(){return sections?sections:null},forGroupStuffs:function(){return forGroupStuffs?forGroupStuffs:null}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){reject()})})}function selectWithSection(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/sections/selectCategoryWithSectionModal.html",controller:selectCategoryWithSectionCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){reject()})})}var Items=$resource("/api/collections/Category/:_id",{_id:"@_id"});return{get:Items.get,query:Items.query,save:save,delete:Items.delete,select:select,selectWithSection:selectWithSection}}function selectCategoryCtrl($q,$uibModalInstance,Sections,categoryId,selectSection,sections,forGroupStuffs){var self=this;self.categoryId=categoryId,self.selectSection=selectSection,$q.when().then(function(){return sections?sections:Sections.getSections()}).then(function(sections){self.sections=sections.filter(function(s){return forGroupStuffs?s.groupStuffs:!s.groupStuffs})}),self.ok=function(selectedCategory){$uibModalInstance.close(selectedCategory)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}function selectCategoryWithSectionCtrl($q,$uibModalInstance,Sections){var self=this;$q.when().then(function(){return Sections.getSections()}).then(function(sections){self.sections=sections}),self.ok=function(selectedCategory){$uibModalInstance.close(selectedCategory)},self.okSection=function(section){var categories=section.categories;$uibModalInstance.close(categories)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}angular.module("gmall.services").service("Category",categoryService),categoryService.$inject=["$resource","$uibModal","$q"],selectCategoryCtrl.$inject=["$q","$uibModalInstance","Sections","categoryId","selectSection","sections","forGroupStuffs"],selectCategoryWithSectionCtrl.$inject=["$q","$uibModalInstance","Sections"]}(),angular.module("gmall.directives").directive("categoryTree",[function(){return{restrict:"E",templateUrl:"components/sections/categoryTree.html"}}]).directive("categoryHtml",[function(){return{restrict:"E",templateUrl:"components/sections/categoryHtml.html"}}]).directive("sectionsList",[function(){function sectionCtrl($state,global,$anchorScroll,Sections,Category,$q,$timeout,$scope){function activate(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){self.sections=sections.filter(function(el){return!el.parent&&0===el.level}),self.sectionsList.sections=self.sections})}function timoutForShow(){return self.showRadio||$timeout(function(){self.showRadio=!0},300),self.showRadio}var self=this;self.$state=$state,self.global=global,self.sectionsList={},self.sectionTypes={good:"товар",service:"услуга",infp:"инфо",media:"медиа"},$scope.$on("changeLang",function(){Sections.setSections(null),activate()}),activate(),self.setTimeout=timoutForShow,self.showRadio;self.newSection=function(section){if(section.name){var index=0;self.sections.forEach(function(s){s.index>=index&&(index=s.index+1)});var newSection={name:section.name,child:[],categories:[],level:0,parent:null,index:index};Sections.save(newSection,function(res){section.name="",newSection._id=res.id,self.sections.push(newSection)})}},self.dragoverCallback=function(event){return!0},self.addSection=function(section){if(section.sectionNewName){var newSection={name:section.sectionNewName,child:[],categories:[],level:section.level+1,parent:section._id};section.child.push(newSection),Sections.save(newSection,function(res){newSection._id=res.id,newSection.url=res.url,newSection.section={url:section.url},console.log(section),section.sectionNewName="";var child=section.child.map(function(el){return el._id});Sections.save({update:"child"},{_id:section._id,child:child},function(res){})})}},self.saveSection=function(section,field){section.name||(section.name="раздел без названия");var o={_id:section._id};o[field]=section[field],Sections.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){})},self.deleteSection=function(parentSection,section){if(parentSection){var i=parentSection.child.indexOf(section);if(i>-1)return parentSection.child.splice(i,1),Sections.delete({id:section._id},function(res){console.log(res)}),void Sections.save(parentSection,function(res){console.log(res)})}else if(!section.child.length&&!section.categories.length){var i=self.sections.indexOf(section);i>-1&&(self.sections.splice(i,1),Sections.delete({id:section._id},function(res){console.log(res)}))}};var findSection=function(id,sections){for(var i=0,l=sections.length;i<l;i++)if(sections[i]._id==id)return sections[i];for(var res,i=0,l=sections.length;i<l;i++)if(sections[i].child&&sections[i].child.length&&(res=findSection(id,sections[i].child)))return res};self.dropSectionCallback=function(section,parentSection){return setTimeout(function(){var oldParent=findSection(section.parent,self.sections);Sections.save({update:"child"},{_id:parentSection._id,child:parentSection.child.map(function(el){return el._id})},function(res){console.log(res)}),oldParent._id!=parentSection._id&&(section.parent=parentSection._id,Sections.save({update:"parent"},{id:section._id},function(res){console.log(res)}),Sections.save({update:"child"},{_id:oldParent._id,child:oldParent.child.map(function(el){return el._id})},function(res){console.log(res)}))},50),section},self.dropMainSectionCallback=function(section){return setTimeout(function(){self.sections.forEach(function(section,i){section.index=i,Sections.save({update:"index"},{_id:section._id,index:section.index})})},50),section},self.addCategory=function(section,name){if(section.newCategoryName){var category={name:section.newCategoryName,group:section._id};section.categories.push(category),category.focus=!0,Category.save(category,function(res){section.newCategoryName="",category._id=res.id,category.url=res.url;var categories=section.categories.map(function(el){return el._id});Sections.save({update:"categories"},{_id:section._id,categories:categories})})}},self.saveCategoryName=function(c,section){c.name||(c.name="категория без названия"),Category.save({update:"name"},{_id:c._id,name:c.name},function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){})},self.saveCategoryActive=function(c){console.log(c.name),Category.save({update:"notActive"},{_id:c._id,notActive:c.notActive},function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){})},self.deleteCategory=function(section,idx){Category.delete({_id:section.categories[idx]._id},function(res){section.categories.splice(idx,1);Sections.save({update:"categories"},{_id:section._id,categories:section.categories.map(function(el){return el._id})},function(res){})},function(err){console.log(err)})},self.dropCategoryCallback=function(category,section){return setTimeout(function(){if(section.categories.forEach(function(c,i){c.index=i}),Sections.save({update:"categories"},{_id:section._id,categories:section.categories.map(function(el){return el._id})},function(res){}),category.group!=section._id){var oldSection=findSection(category.group,self.sections);oldSection.categories.forEach(function(c,i){c.index=i}),Sections.save({update:"categories"},{_id:oldSection._id,categories:oldSection.categories.map(function(el){return el._id})},function(res){})}category.group=section._id,Category.save({update:"group"},{_id:category._id,group:category.group},function(res){})},50),category},self.movedCategory=function(section,index){index!=section.categories[index].index&&index++,section.categories.splice(index,1)}}return{scope:{},bindToController:!0,controller:sectionCtrl,controllerAs:"$ctrl",restrict:"E",templateUrl:"components/sections/sections.html"}}]).directive("categoryEdit",[function(){function categoryCtrl($scope,Category,$q,$stateParams,Filters,Brands,global,$timeout,Sections,$http,Photo){function selectCategoryFromMP(mpId,data){var categoryId=data&&data._id?data._id:null;$q.when().then(function(){return Category.select(categoryId,null,self.mps[mpId])}).then(function(category){self.item.mp||(self.item.mp={}),self.item.mp[mpId]=category;var o={},categoriesMP=[];for(var key in self.item.mp)o[key]=self.item.mp[key]._id,categoriesMP.push(self.item.mp[key]._id);saveField("mp",o),changeCategoryForStuffs(self.item._id,categoriesMP)}).catch(function(err){console.log(err)})}function deleteCategoryFromMP(mp){self.item.mp[mp]._id;delete self.item.mp[mp];var o={};for(var key in self.item.mp)o[key]=self.item.mp[key]._id;saveField("mp",o)}function getPromiseForMPCategories(store){return Sections.query({store:store}).$promise}function changeCategoryForStuffs(category,categoriesMP){var o={category:category,categoriesMP:categoriesMP};$http.post("/api/stuffs/changeMPCategory",o)}function saveField(field,data){var o={_id:self.item._id};o[field]=data,Category.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function refreshBlocks(){return Category.get({_id:$stateParams.id}).$promise.then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){type&&($scope.$broadcast("addNewBlock",{type:type}),self.newBlock=null)}function deleteBlock(block){console.log(block);var o={_id:self.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("удалить?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.item.blocks.splice(block.i,1),self.item.blocks.forEach(function(b,i){b.i=i});var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stuff",images)})}var self=this;self.Items=Category,self.global=global,self.block="desc",self.listOfBlocks=angular.copy(listOfBlocksForAll),self.selectCategoryFromMP=selectCategoryFromMP,self.deleteCategoryFromMP=deleteCategoryFromMP,self.addBlock=addBlock,self.deleteBlock=deleteBlock,self.refreshBlocks=refreshBlocks,self.type="Category";var mps;$q.when().then(function(){return Category.get({_id:$stateParams.id}).$promise}).then(function(res){res.blocks||(res.blocks=[]),res.blocks.forEach(function(b,i){b.i=i}),res.filters=res.filters.map(function(el){return el._id}),self.item=res}).then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){return Brands.getBrands()}).then(function(brands){self.brands=brands}).then(function(){if(global.get("store").val.mp&&global.get("store").val.mp.mps&&global.get("store").val.mp.mps.length&&(mps=global.get("store").val.mp.mps.map(function(mp){return mp._id}))&&mps.length){var acts=[];return mps.forEach(function(mp){acts.push(getPromiseForMPCategories(mp))}),$q.all(acts)}}).then(function(results){results&&results.length&&(self.mps={},self.mpsCategories={},mps.forEach(function(mp,i){results[i].shift(),self.mps[mp]=results[i],self.mpsCategories[mp]=results[i].reduce(function(o,sec){return sec.categories&&sec.categories.length&&sec.categories.forEach(function(c){o[c._id]=c}),sec.child&&sec.child.length&&sec.child.forEach(function(ch){ch.categories&&ch.categories.length&&ch.categories.forEach(function(c){o[c._id]=c})}),o},{}),self.item.mp&&self.item.mp[mp]&&(self.item.mp[mp]=self.mpsCategories[mp][self.item.mp[mp]])}))}).catch(function(err){self.edit=!1}),self.saveField=function(field,defer){console.log("field"),defer=defer||0,$timeout(function(){var o={_id:self.item._id};o[field]=self.item[field],Category.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)},$scope.$on("changeLang",function(){$q.when().then(function(){return Category.get({_id:$stateParams.id}).$promise}).then(function(res){res.blocks||(res.blocks=[]),res.blocks.forEach(function(b,i){b.i=i}),res.filters=res.filters.map(function(el){return el._id}),self.item=res})})}return{scope:{},bindToController:!0,controller:categoryCtrl,controllerAs:"$ctrl",templateUrl:"components/sections/category.html"}}]).directive("fixSection",[function(){return{link:function(scope,element,attrs){function getOffsetTop(){return $(element).offset().top-$(window).scrollTop()}function getOffsetBorderElement(){return element.offset().top-$(window).scrollTop()+borderElement.height()}function setScrollBlock(){var posY=getOffsetTop(),posBottonBorderElement=getOffsetBorderElement();posY<70&&!clonedBlockDisplay&&posBottonBorderElement>150&&(clonedBlockDisplay=!0,clonedBlock.show(),$(element).css("opacity",0)),posY>70&&clonedBlockDisplay&&(clonedBlockDisplay=!1,$(element).css("opacity",1),clonedBlock.hide()),posBottonBorderElement<150&&clonedBlockDisplay&&(clonedBlockDisplay=!1,$(element).css("opacity",1),clonedBlock.hide())}function init(reload){setTimeout(function(){reload||(clonedBlock=element.clone().hide(),clonedBlock.css("position","fixed").css("top",43).css("height",element.height())),clonedBlock.css("left",$(element).offset().left).css("width",element.width()+15+sdvig),reload||(mainDiv.append(clonedBlock),borderElement=$("#borderBox"+attrs.fixSection),setScrollBlock())},200)}var delay,visible;if(scope.$on("changeMenuStatus",function(event,reload){delay||(delay=!0,clonedBlock.is(":visible")&&(visible=!0,clonedBlock.hide()),init("reload"),setTimeout(function(){delay=!1,visible&&(visible=!1,clonedBlock.fadeIn(200))},400))}),$(window).resize(function(){}),!($(window).width()<1200)){var borderElement,clonedBlock,mainDiv=$("#sectionsTree"),clonedBlockDisplay=!1,sdvig=attrs.subSection?15:0;init(),$(window).scroll(setScrollBlock)}}}}]),function(){function brandTagsService($resource,$uibModal,$q,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function selectBrandTag(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/brand/selectBrandTag.html",controller:selectBrandTagCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectBrandTagCtrl(Brands,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Brands.getBrands()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),filterTag.brand=self.filters.find(function(b){
return b._id==filterTag.brand}),$uibModalInstance.close(filterTag)}}var Items=$resource("/api/collections/BrandTags/:id",{id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,selectBrandTag:selectBrandTag,select:selectBrandTag}}angular.module("gmall.services").service("Brands",function($resource,$q,global,$uibModal,Sections){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function returnBrands(resolve){pending?setTimeout(function(){returnBrands(resolve)},300):resolve(brands)}function reloadItems(){pending=!0,Items.query(function(res){res.shift(),brands=res,global.set("brands",brands),pending=!1})}function selectBrand(data){var sections=data&&data.section?Sections.getSections():null;return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/brand/selectBrand.html",controller:selectBrandCtrl,size:"lg",controllerAs:"$ctrl",resolve:{sections:function(){return sections}}};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectBrandCtrl(Brands,$uibModalInstance,$q,global,sections){var self=this;self.global=global,self.sections=sections,self.sections&&(self.section=self.sections[0].url),$q.when().then(function(){return Brands.getBrands()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){self.section&&(filterTag.section=self.section),$uibModalInstance.close(filterTag)}}var Items=$resource("/api/collections/Brand/:id",{id:"@_id"}),brands=null,pending=!0;this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.reloadItems=reloadItems,this.select=selectBrand,this.getList=getList,this.getItem=getItem,this.getBrands=function(){return $q(function(resolve,reject){if(global.get("brands")&&global.get("brands").val)return brands||(brands=global.get("brands").val),resolve(global.get("brands").val);pending?setTimeout(function(){returnBrands(resolve)},300):brands?resolve(brands):(pending=!0,Items.query(function(res){res.shift(),brands=res?res:[],pending=!1,resolve(brands)},function(err){pending=!1,reject(err)}))})},global.get("brands")&&global.get("brands").val||Items.query(function(res){res.shift(),brands=res,global.get("brands")&&!global.get("brands").val&&global.set("brands",brands),pending=!1}),selectBrandCtrl.$inject=["Brands","$uibModalInstance","$q","global","sections"]}).service("BrandTags",brandTagsService),brandTagsService.$inject=["$resource","$uibModal","$q","Sections"]}(),angular.module("gmall.directives").directive("brandsList",["$anchorScroll","Brands","BrandTags","$q","SelectCategory","$timeout","global","$http","Confirm","exception","Stuff",function($anchorScroll,Brands,BrandTags,$q,SelectCategory,$timeout,global,$http,Confirm,exception,Stuff){return{restrict:"E",templateUrl:"components/brand/brands.html",link:function($scope,element,attrs){function activate(){$q.when().then(function(){var q=$q.defer();return Brands.query(function(res){res.shift(),$scope.brands=res,q.resolve()},function(err){q.reject(err)}),q.promise}).then(function(){var q=$q.defer();return BrandTags.query(function(res){res.shift(),$scope.brandTags=res,q.resolve()},function(err){q.reject(err)}),q.promise}).then(function(){})}$scope.$on("changeLang",function(){activate()}),activate(),$scope.fixBrands=function(){Confirm("Подтверждаете?").then(function(){$scope.fixBrandsDesable=!0;var data={};return $http({method:"post",url:"/api/fixedDB/brand",data:data})}).then(function(){activate(),exception.showToaster("info","fix stucture","Ok")}).catch(function(err){exception.catcher("fix stucture")(err)})},$scope.addNewBrand=function(newBrand){if(newBrand.name){var brand={name:newBrand.name.substring(0,25),index:0,tags:[]};newBrand.name="",$scope.brands.unshift(brand),Brands.save(brand,function(res){console.log(res),brand._id=res.id})}},$scope.deleteBrand=function(brand,idx){Brands.delete({id:brand._id},function(res){$scope.brands.splice(idx,1)},function(err){console.log(err)})},$scope.saveBrand=function(brand,field){if(brand.name){var o={_id:brand._id};o[field]=brand[field],Brands.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}},$scope.dropBrandCallback=function(brand){return console.log(brand),$timeout(function(){$scope.brands.forEach(function(brand,idx){brand.index=idx+1,Brands.save({update:"index"},brand)})},200),brand},$scope.addTag=function(brand,newTag){if(newTag.name){var tag={name:newTag.name.substring(0,25),brand:brand._id,actived:!0};newTag.name="",brand.tags.unshift(tag),BrandTags.save(tag,function(res){tag._id=res.id,Brands.save({update:"tags"},{_id:brand._id,tags:brand.tags.map(function(el){return el._id})},function(res){})})}},$scope.saveTag=function(tag,field){if(tag.name){var o={_id:tag._id};o[field]=tag[field],BrandTags.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){})}},$scope.deleteTag=function(brand,idx){Confirm("Delete?").then(function(){return Stuff.getList({page:0,row:100},{brandTag:brand.tags[idx]._id})}).then(function(stuffs){if(stuffs&&stuffs.length){var s="привязаны товары";throw stuffs.forEach(function(st){s+=" "+st.name+" "+(st.artikul?st.artikul:"")+"|"}),s}}).then(function(){BrandTags.delete({id:brand.tags[idx]._id},function(res){brand.tags.splice(idx,1);Brands.save({update:"tags"},{_id:brand._id,tags:brand.tags.map(function(el){return el._id})},function(res){})},function(err){console.log(err)})}).catch(function(err){err&&exception.catcher("удаление")(err)})},$scope.dropTagCallback=function(tag,index,brand){return console.log(brand.tags.map(function(e){return e.name})),$timeout(function(){if(Brands.save({update:"tags"},{_id:brand._id,tags:brand.tags.map(function(el){return el._id})},function(res){}),tag.brand!=brand._id){brand.tags.forEach(function(tag,i){tag.index=i});var oldBrand=$scope.brands.getObjectFromArray("_id",tag.brand);Brands.save({update:"tags"},{_id:oldBrand._id,tags:oldBrand.tags.map(function(el){return el._id})},function(res){}),tag.brand=brand._id,BrandTags.save({update:"brand"},tag,function(res){})}},450),tag},$scope.tagMoved=function(brand,tag,idx){idx==tag.index?brand.tags.splice(idx,1):brand.tags.splice(idx+1,1),brand.tags.forEach(function(tag,i){tag.index=i})},$scope.selectCategory=function(id,revers){revers?SelectCategory.bindCategoryForFilterBrandCol(id,"categories",revers):SelectCategory.bindCategoryForFilterBrandCol(id,"brands")}}}}]).directive("brandEdit",function(){return{restrict:"E",templateUrl:"components/brand/brandEdit.html",scope:{},bindToController:!0,controller:brandEditCtrl,controllerAs:"$ctrl"}}).directive("brandTagEdit",brandTagEdit),brandEditCtrl.$inject=["$anchorScroll","Brands","global","$q","exception","$stateParams","$scope","$timeout"],brandTagEditCtrl.$inject=["BrandTags","$q","$state","global","$stateParams","$scope","$timeout"],angular.module("gmall.controllers").controller("stuffsFilterCtrl",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll","$timeout",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll,$timeout){function _getCollections(){var query={brand:$scope.stuffsFilterCtrl.query.brand,group:$scope.stuffsFilterCtrl.query.section};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffsFilterCtrl.brandCollections=res,$scope.stuffsFilterCtrl.brandCollections&&$stateParams.brandTag){var brandTag=$scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffsFilterCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}})}function _getQueryTag(){var arr=[];return $scope.stuffsFilterCtrl.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr.length?arr.map(function(tag){return global.get("filterTags").val.getObjectFromArray("_id",tag).url}).join("+"):void 0}function _getBrand(){if($scope.stuffsFilterCtrl.query.brand)return global.get("brands").val.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.brand).url}function _getBrandTag(){if($scope.stuffsFilterCtrl.query.brandTag)return $scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.brandTag).url}var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.stuffsFilterCtrl=this,$scope.stuffsFilterCtrl.paginate={page:0,rows:50,totalItems:0},$scope.stuffsFilterCtrl.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$scope.stuffsFilterCtrl.categories=[];var queryTags,category;$scope.stuffsFilterCtrl.brands=[],$scope.stuffsFilterCtrl.brandCollections=[],$scope.stuffsFilterCtrl.filters=[],function(){var q=$q.defer();return q.resolve(),q.promise}().then(function(){var q=$q.defer();if("brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl){var group=global.get("groups").val.getObjectFromArray("url",$stateParams.groupUrl);if(group){if($scope.stuffsFilterCtrl.query.section=group._id,$stateParams.parentGroup){var categories=$section.getCategories($stateParams.parentGroup).map(function(i){return i._id?i._id:i});categories&&($scope.stuffsFilterCtrl.categories=global.get("categories").val.filter(function(item){return categories.indexOf(item._id)>-1}))}q.resolve($scope.stuffsFilterCtrl.categories)}else $state.go("404")}else q.resolve(1);return q.promise}).then(function(r){var q=$q.defer();return $scope.stuffsFilterCtrl.categories.length&&$stateParams.categoryUrl?"id"!=$stateParams.categoryUrl&&(category=$scope.stuffsFilterCtrl.categories.getObjectFromArray("url",$stateParams.categoryUrl),category?$scope.stuffsFilterCtrl.query.category=category._id:$state.go("404")):"id"!=$stateParams.categoryUrl&&(category=global.get("categories").val.getObjectFromArray("url",$stateParams.categoryUrl))&&($scope.stuffsFilterCtrl.query.category=category._id,$scope.stuffsFilterCtrl.categories=$section.getCategories(category.group.url)),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.category&&($scope.stuffsFilterCtrl.brands=global.get("brands").val.getArrayObjects("categories",$scope.stuffsFilterCtrl.query.category)),1===$scope.stuffsFilterCtrl.brands.length)$scope.stuffsFilterCtrl.query.brand=$scope.stuffsFilterCtrl.brands[0]._id;else if($stateParams.brand){var brand=$scope.stuffsFilterCtrl.brands.getObjectFromArray("url",$stateParams.brand);brand&&($scope.stuffsFilterCtrl.query.brand=brand._id,$location.search("brand",brand.url))}return $scope.stuffsFilterCtrl.query.brand||$location.search("brand",null),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.brand){var query={brand:$scope.stuffsFilterCtrl.query.brand,group:$scope.stuffsFilterCtrl.query.section};Collection.getCollectionsForBrand({query:query},function(res){if(res.shift(),$scope.stuffsFilterCtrl.brandCollections=res,$stateParams.brandTag){var brandTag=$scope.stuffsFilterCtrl.brandCollections.getObjectFromArray("url",$stateParams.brandTag);brandTag?($scope.stuffsFilterCtrl.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}q.resolve(1)},function(){q.resolve(3)})}else q.resolve(2);return q.promise}).then(function(){var q=$q.defer();return $stateParams.queryTag&&(queryTags=$stateParams.queryTag.split("+"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),queryTags=queryTags.reduce(function(tags,tag){var t;return(t=global.get("filterTags").val.getObjectFromArray("url",tag))&&tags.push(t),tags},[])),q.resolve(),q.promise}).then(function(){var q=$q.defer();if($scope.stuffsFilterCtrl.query.category){var filters=global.get("filters").val.filter(function(item){return!item.dontshow&&category.filters.indexOf(item._id)>-1});filters.forEach(function(item,i){item.tags=[],global.get("filterTags").val.forEach(function(tag){tag.filter==item._id&&item.tags.push(tag)}),queryTags&&queryTags.length&&queryTags.forEach(function(tag){tag.filter==item._id&&($scope.stuffsFilterCtrl.query.tags[i]||($scope.stuffsFilterCtrl.query.tags[i]=[]),$scope.stuffsFilterCtrl.query.tags[i].push(tag._id))})}),$scope.stuffsFilterCtrl.filters=filters}else queryTags&&queryTags.length&&($scope.stuffsFilterCtrl.query.tags[0]=[queryTags[0]._id],$location.search("queryTag",queryTags[0].url));return q.resolve("finsh"),q.promise}).then(function(r){$scope.stuffsFilterCtrl.getList($scope.stuffsFilterCtrl.paginate.page,$scope.stuffsFilterCtrl.paginate.rows)});var prevBrand;$scope.stuffsFilterCtrl.getList=function(page,rows){prevBrand=$scope.stuffsFilterCtrl.query.brand;var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});var queryTag=[];for(var key in $scope.stuffsFilterCtrl.query)if($scope.stuffsFilterCtrl.query[key])if("tags"==key){var qu=[];$scope.stuffsFilterCtrl.query[key].filter(function(){return!0});$scope.stuffsFilterCtrl.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.stuffsFilterCtrl.query[key],query.push(obj)}query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):"";var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand(),queryTagsForSEO="";queryTag&&(queryTagsForSEO+="queryTag="+queryTag),brand&&(queryTagsForSEO&&(queryTagsForSEO+="&"),queryTagsForSEO+="brand="+brand),brandTag&&(queryTagsForSEO&&(queryTagsForSEO+="&"),queryTagsForSEO+="brandTag="+brandTag),console.log(queryTagsForSEO),$rootScope.$broadcast("$allDataLoaded",{state:$state.current.name,data:queryTagsForSEO}),$scope.stuffsFilterCtrl.queryForDirective=query},$scope.stuffsFilterCtrl.changeFilter=function(c){$anchorScroll();var category=$scope.stuffsFilterCtrl.query.category?$scope.stuffsFilterCtrl.categories.getObjectFromArray("_id",$scope.stuffsFilterCtrl.query.category):{name:"category",url:"id"};if(c){$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:category.url,categoryName:category.name,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else{$location.search(""),$scope.stuffsFilterCtrl.query.artikul="",!$scope.stuffsFilterCtrl.query.brand||$scope.stuffsFilterCtrl.brandCollections&&prevBrand==$scope.stuffsFilterCtrl.query.brand?$scope.stuffsFilterCtrl.query.brand||($scope.stuffsFilterCtrl.brandCollections=null,$scope.stuffsFilterCtrl.query.brandTag=""):(_getCollections($scope.stuffsFilterCtrl.query.brand),$scope.stuffsFilterCtrl.query.brandTag=""),$scope.stuffsFilterCtrl.paginate.page=0,$scope.stuffsFilterCtrl.getList($scope.stuffsFilterCtrl.paginate.page,$scope.stuffsFilterCtrl.paginate.rows);var queryTag=_getQueryTag(),brandTag=_getBrandTag(),brand=_getBrand();queryTag&&$location.search("queryTag",queryTag),brandTag&&$location.search("brandTag",brandTag),brand&&$location.search("brand",brand),$stateParams.brandTag&&$location.search("brandTag",$stateParams.brandTag)}},$scope.stuffsFilterCtrl.clearFilter=function(){console.log("clear filetrs"),$scope.stuffsFilterCtrl.query.tags=[],$scope.stuffsFilterCtrl.changeFilter()}}]).controller("stuffsLWPCtrl",["$scope","$resource","$rootScope","global","Stuff","$section","$location","$q","Collection","$anchorScroll","$timeout",function($scope,$resource,$rootScope,global,Stuff,$section,$location,$q,Collection,$anchorScroll,$timeout){var $state=$rootScope.$state;$rootScope.$stateParams;$scope.stuffsLWPCtrl=this,$scope.stuffsLWPCtrl.query=null,$scope.stuffsLWPCtrl.paginate={page:0,rows:20,totalItems:0},$scope.stuffsLWPCtrl.query=null,$scope.stuffsLWPCtrl.getList=function(page,rows){Stuff.getList($scope.stuffsLWPCtrl.query,null,page,rows,$scope.stuffsLWPCtrl.paginate).then(function(res){$scope.stuffsLWPCtrl.items=res,$scope.stuffsLWPCtrl.query=null},function(err){$state.go("404")})},$scope.$watch(function(){return $scope.stuffsLWPCtrl.query},function(n){n&&($scope.stuffsLWPCtrl.paginate.page=0,$scope.stuffsLWPCtrl.getList($scope.stuffsLWPCtrl.paginate.page,$scope.stuffsLWPCtrl.paginate.rows))}),$timeout(function(){$scope.stuffsLWPCtrl.getList($scope.stuffsLWPCtrl.paginate.page,$scope.stuffsLWPCtrl.paginate.rows)}),$scope.getUrlParams=Stuff.getUrlParams,$scope.getCategoryName=Stuff.getCategoryName,$scope.getBrandName=Stuff.getBrandName}]),function(){function stuffService($resource,$uibModal,$q,Sections,$stateParams,$state,$location,Brands,FilterTags,global,$order,exception,$user,$email,CreateContent,$rootScope,Filters,$timeout){function _salePrice(doc,sale){if(doc.driveSalePrice&&doc.driveSalePrice.maxDiscount&&(doc.maxDiscount=doc.driveSalePrice.maxDiscount),doc.driveSalePrice&&0!=doc.driveSalePrice.type){if(2==doc.driveSalePrice.type){doc.priceSale=Math.ceil10(Number(doc.price)-sale*doc.price,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale*doc.stock[key].price,-2)}else if(1==doc.driveSalePrice.type)if(doc.driveSalePrice.condition){sale=doc.driveSalePrice.percent/100,doc.priceSale=Math.ceil10(Number(doc.price)-sale*doc.price,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale*doc.stock[key].price,-2)}else{sale=Number(doc.driveSalePrice.sum),doc.priceSale=Math.ceil10(Number(doc.price)-sale,-2);for(var key in doc.stock)doc.stock[key].priceSale=Math.ceil10(Number(doc.stock[key].price)-sale,-2)}}else{doc.priceSale=0;for(var key in doc.stock)doc.stock[key].priceSale=0}}function _retailPrice(doc,retail){if(doc.driveRetailPrice||(global.get("store").val.seller.retail?doc.driveRetailPrice={type:2}:doc.driveRetailPrice={type:0}),0==doc.driveRetailPrice.type){doc.retail=0;for(var key in doc.stock)doc.stock[key].retail=0}else if(2==doc.driveRetailPrice.type){doc.retail=Math.ceil10(Number(doc.price)+retail*Number(doc.price),-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail*doc.stock[key].price,-2)}else if(1==doc.driveRetailPrice.type)if(doc.driveRetailPrice.condition){retail=doc.driveRetailPrice.percent/100,doc.retail=Math.ceil10(Number(doc.price)+retail*doc.price,-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail*doc.stock[key].price,-2)}else{retail=Number(doc.driveRetailPrice.sum),doc.retail=Math.ceil10(Number(doc.price)+retail,-2);for(var key in doc.stock)doc.stock[key].retail=Math.ceil10(Number(doc.stock[key].price)+retail,-2)}}function _setPrice(doc){doc||(doc=this),doc.price<0&&(doc.price=0),doc.sort=null;var sale=(global.get("store").val.seller.sale||0)/100,retail=(global.get("store").val.seller.retail||0)/100,el=doc?doc:this;if(el.stock&&"object"==typeof el.stock?el.stock.notag&&(el.stock.notag.price=el.price):(el.stock={notag:{quantity:1,price:el.price}},el.sort="notag"),global.get("currency")&&el.currency&&global.get("store").val.mainCurrency!=el.currency){el.price=Math.ceil10(Number(el.price)/Number(global.get("store").val.currency[el.currency][0]),-2);for(var tag in el.stock)el.stock[tag].price=Math.ceil10(Number(el.stock[tag].price)/Number(global.get("store").val.currency[el.currency][0]),-2)}return _salePrice(el,sale),_retailPrice(el,retail),el}function _changeSortOfStuff(sort){if(!(this.stock&&sort&&this.stock[sort])||this.stock[sort].quantity)if(sort&&(this.sort=sort),this.sort){var sort=this.stock[this.sort];this.sortName=sort.name,this.price=sort.price,this.priceSale=sort.priceSale,this.retail=sort.retail,this.priceCampaign=sort.priceCampaign}else this.sortName=null,this.stock&&this.stock.notag||(this.price=0,this.priceSale=0,this.retail=0)}function _addItemToOrder(){var self=this;if(!this.sort)return this.unableToOrder=!0,$timeout(function(){self.unableToOrder=!1},2500),"nosort";this.sortsOfStuff&&this.sortsOfStuff.filter&&!this.sort?exception.catcher("ошибка")("выберите разновидность"):(this.stock[this.sort].name&&(this.sortName=this.stock[this.sort].name),$order.addItemToCart(this)),$rootScope.$emit("AddToCart")}function _dateTime(){var self=this;if(!this.sort)return this.unableToOrder=!0,$timeout(function(){self.unableToOrder=!1},2500),"nosort";global.get("functions").val.witget("dateTime",{stuff:this})}function _setSticker(stuff){return FilterTags.getSticker(stuff.tags)}function _checkInCart(){return $order.checkInCart(this)}function zoomImgGlobal(i,images,home){var img,horizontalOrient,imgs=$("img[src$='"+images[i].img+"']");if(imgs&&imgs[0]?(img=$(imgs[0]),img.width()&&img.height()&&img.width()>img.height()&&(horizontalOrient=!0)):(imgs=$("img[src$='"+images[i].thumb+"']"),imgs&&imgs[0]?(img=$(imgs[0]),img.width()&&img.height()&&img.width()>img.height()&&(horizontalOrient=!0)):images[i].el&&images[i].el.width&&images[i].el.height&&images[i].el.width>images[i].el.height&&(horizontalOrient=!0)),!delay){delay=!0,$timeout(function(){delay=!1},1e3);var content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no",viewPort=document.getElementById("viewport"),templ=global.get("store").val.template.addcomponents&&global.get("store").val.template.addcomponents.zoom&&global.get("store").val.template.addcomponents.zoom.templ?global.get("store").val.template.addcomponents.zoom.templ:"",templateUrl="views/template/partials/stuffDetail/modal/zoom"+templ+".html";viewPort.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=3"),$rootScope.$emit("modalOpened");var options={animation:!0,bindToController:!0,controllerAs:"$ctrl",windowClass:function(){return horizontalOrient?"zoom zoom-modal-horizontal":"zoom zoom-modal-vertical"},templateUrl:templateUrl,controller:function($uibModalInstance,global,gallery,i,home,horizontalOrient){function next(i){delay||(delay=!0,i+1==self.gallery.length?(self.gallery[0].active=!0,self.idx=0):(self.gallery[i+1].active=!0,self.idx=i+1),$timeout(function(){delay=!1},500))}function prev(i){delay||(delay=!0,0==i?(self.gallery[self.gallery.length-1].active=!0,self.idx=self.gallery.length-1):(self.gallery[i-1].active=!0,self.idx=i-1),$timeout(function(){delay=!1},500))}function chancheActiveSlide(i){self.gallery[i].active=!0,self.idx=i}var self=this;self.style=home?horizontalOrient?"width:98vw;height:auto":"height:93vh;width:auto":"width:100%",self.modal=global.get("mobile").val,self.idx=i,self.gallery=angular.copy(gallery),self.gallery[i].active=!0,self.next=next,self.prev=prev,self.chancheActiveSlide=chancheActiveSlide;var delay=!1;self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{gallery:function(){return images},i:function(){return i},home:function(){return home},horizontalOrient:horizontalOrient}};home||(options.size="lg"),$q.when().then(function(){return $uibModal.open(options).result}).then(function(res){viewPort.setAttribute("content",content),$rootScope.$emit("modalClosed")}).catch(function(err){viewPort.setAttribute("content",content),$rootScope.$emit("modalClosed"),err&&"backdrop click"!=err&&(err=err.data||err,exception.catcher("zoom")(err))})}}function _zoomImg(i){zoomImgGlobal(i,this.gallery)}function _setCategoryName(item){if(item.category&&item.category._id&&(item.category=[item.category]),item.category&&item.category.length)for(var i=0,c=null;i<item.category.length&&!c;)"object"==typeof item.category[i]&&(item.category[i]=item.category[i]._id),global.get("categoriesO").val[item.category[i]]&&(c=global.get("categoriesO").val[item.category[i]]),i++;if(global.get("categories").val&&(c||(c=categoriesLink[item.category]?categoriesLink[item.category]:global.get("categories").val.getOFA("_id",item.category)),c?(item.categoryUrl=c.url,item.categoryName=c.name,c.linkData?(item.groupUrl=c.linkData.groupUrl,item.parentGroup=c.linkData.parentGroup||null):(item.groupUrl="group",item.categoryUrl="category",item.parentGroup=null)):(item.groupUrl="group",item.categoryUrl="category")),item.brand&&global.get("brands")&&global.get("brands").val){"object"==typeof item.brand&&(item.brand=item.brand._id);var b=global.get("brands").val.getOFA("_id",item.brand);if(b&&(item.brandUrl=b.url,item.brandName=b.name,item.brandTag)){var bt=b.tags.getOFA("_id",item.brandTag);bt&&(item.brandTagUrl=bt.url,item.brandTagName=bt.name)}}}function _setDataForStuff(stuff,filterTags,stuffsState){if(stuff.changeSortOfStuff=_changeSortOfStuff,stuff.addItemToOrder=_addItemToOrder,stuff.dateTime=_dateTime,stuff.onSelected=_onSelectedSort,stuff.order=_orderStuff,stuff.getBonus=_getBonus,stuff.zoomImg=_zoomImg,stuff.checkInCart=_checkInCart,stuff.getDataForBooking=_getDataForBooking,_setCategoryName(stuff),_setPrice(stuff),stuff.setPrice=_setPrice,stuff.multiple&&stuff.minQty?stuff.quantity=Number(stuff.minQty):(stuff.quantity=1,stuff.minQty=1),stuff.single||(stuff.maxQty=150),stuff.sale||_checkCamapign(stuff),stuff.expected=!0,stuff.stock&&"object"==typeof stuff.stock&&!stuff.stock.notag){if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filterGroup&&global.get("filtersO")&&global.get("filtersO").val&&global.get("filtersO").val[stuff.sortsOfStuff.filterGroup]){var filterGroupTags,filterGroup=global.get("filtersO").val[stuff.sortsOfStuff.filterGroup];if(filterGroup){stuff.sortsOfStuff.name=filterGroup.name.charAt(0).toUpperCase()+filterGroup.name.slice(1).toLowerCase(),stuff.groupName=stuff.sortsOfStuff.name,filterGroupTags=filterGroup.tags.map(function(t){return t._id});for(var ii=0;ii<stuff.tags.length;ii++){var idx=filterGroupTags.indexOf(stuff.tags[ii]);if(idx>-1){stuff.groupTagName=filterGroup.tags[idx].name.charAt(0).toUpperCase()+filterGroup.tags[idx].name.slice(1).toLowerCase();break}}}}if(stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&global.get("filtersO")&&global.get("filtersO").val&&global.get("filtersO").val[stuff.sortsOfStuff.filter]&&(stuff.filterName=global.get("filtersO").val[stuff.sortsOfStuff.filter].name.toLowerCase(),stuff.filterName=stuff.filterName.charAt(0).toUpperCase()+stuff.filterName.slice(1).toLowerCase()),stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs)for(var i21=0;i21<stuff.sortsOfStuff.stuffs.length;i21++)if(stuff.sortsOfStuff.stuffs[i21]._id!=stuff._id&&stuff.sortsOfStuff.stuffs[i21].archived)stuff.sortsOfStuff.stuffs.splice(i21,1),i21--;else if(stuff.sortsOfStuff.stuffs[i21].stock&&"object"==typeof stuff.sortsOfStuff.stuffs[i21].stock)for(var k in stuff.sortsOfStuff.stuffs[i21].stock)stuff.sortsOfStuff.stuffs[i21].stock[k].quantity&&(stuff.sortsOfStuff.stuffs[i21].stock[k].quantity=Number(stuff.sortsOfStuff.stuffs[i21].stock[k].quantity));var keys=Object.keys(stuff.stock);stuff.stockKeysArray=keys.map(function(k){if(stuff.stock[k].quantity=Number(stuff.stock[k].quantity),global.get("filterTagsO")&&global.get("filterTagsO").val&&global.get("filterTagsO").val[k])var tag=global.get("filterTagsO").val[k];else var tag=filterTags.getOFA("_id",k);return tag?{_id:k,index:tag.index,name:tag.name,quantity:Number(stuff.stock[k].quantity)}:null}).filter(function(key){return key}).sort(function(a,b){return a&&b?a.index-b.index:1});var sort_Id=null;stuff.stockKeysArray.forEach(function(key){stuff.sort||global.get("sectionType")&&global.get("sectionType").val&&global.get("store").val.template.stuffListType[global.get("sectionType").val].unsetSort&&"stuffs.stuff"==$state.current.name&&!stuffsState||!sort_Id&&stuff.stock[key._id].quantity&&(sort_Id=key._id,stuff.sort=sort_Id),key.quantity=Number(stuff.stock[key._id].quantity),key.quantity&&stuff.expected&&(stuff.expected=!1),key.quantity&&(stuff.multiple&&stuff.minQty?key.quantity=Number(stuff.minQty):(key.quantity=1,stuff.minQty=1)),stuff.stock[key._id].name=key.name}),stuff.stockKeysArray.length&&sort_Id&&_changeSortOfStuff.call(stuff,sort_Id)}else stuff.stock&&"object"==typeof stuff.stock&&stuff.stock.notag&&(stuff.stock.notag.quantity&&(stuff.sort="notag",stuff.expected=!1),stuff.stockKeysArray=[{name:"notag",_id:"notag",quantity:stuff.stock.notag.quantity}]);if(stuff.campaignId||(stuff.sticker=_setSticker(stuff)),stuff.gallery&&stuff.gallery.length&&stuff.gallery.sort(function(a,b){return a.index-b.index}),!stuffsState&&"undefined"!=typeof _filtersO&&stuff.sortsOfStuff&&stuff.sortsOfStuff.stuffs&&stuff.sortsOfStuff.stuffs.length){var filterGroup,filterGroupTags=[];stuff.sortsOfStuff.filterGroup&&(filterGroup=_filtersO[stuff.sortsOfStuff.filterGroup])&&(filterGroupTags=filterGroup.tags.map(function(t){return t._id})),stuff.sortsOfStuff.stuffs.forEach(function(itemS,i){itemS.gallery.forEach(function(s,ii){s.active=!ii});for(var ii=0;ii<itemS.tags.length;ii++){var idx=filterGroupTags.indexOf(itemS.tags[ii]);if(idx>-1){filterGroup.tags[idx].img&&(stuff.sortsOfStuff.stuffs[i].gallery[0].thumbSmallTag=filterGroup.tags[idx].img);break}}})}return stuff}function _onSelectedSort(){setTimeout(function(){$(":focus").blur()},50)}function _orderStuff(){var stuff=this;$order.clearCart(),stuff.cena=stuff.price,stuff.sum=stuff.cena*stuff.quantity,"nosort"!=stuff.addItemToOrder()&&$q.when().then(function(){return $user.getInfo(stuff.service)}).then(function(user){return $order.checkOutFromList(user)}).then(function(){$order.clearCart()}).catch(function(err){$order.clearCart(),err&&exception.catcher("заказ")(err)})}function getAllBonus(){return _getBonus(!0)}function _getBonus(all){var stuffs,stuff=this;return $q.when().then(function(){if(all){return getList({page:0,rows:100},{$and:[{orderType:4},{actived:!0}]})}return[stuff]}).then(function(sts){stuffs=sts}).then(function(){return $user.getInfoBonus()}).then(function(user){if(!user||!user.email)throw"нет email";var content=CreateContent.emailBonus(stuffs),bonus=stuffs&&stuffs[0]&&stuffs[0].imgs&&stuffs[0].imgs[0]&&stuffs[0].imgs[0].name?stuffs[0].imgs[0].name:"получение контента",domain=global.get("store").val.domain,o={email:user.email,content:content,subject:bonus+" ✔",from:"<promo@"+domain+">"};return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note","Сообщение","На Ваш email отправлено письмо"),resolve()},function(err){exception.showToaster("warning","отправка уведомления",err.data),resolve()})})}).then(function(){var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","bonus");pap&&pap.url?$state.go("thanksPage",{id:pap.url}):exception.showToaster("note","Заказ","Все прошло успешно.")}else exception.showToaster("note","Заказ","Все прошло успешно.")}).catch(function(err){err&&exception.catcher("получение бонуса")(err)})}function _checkCamapign(stuff){return $order.checkCampaign(stuff)}function _getDataForBooking(){var el=this,stuff={_id:this._id,artikul:this.artikul,name:this.name,nameL:this.nameL,link:this.link,backgroundcolor:this.backgroundcolor,timePart:el.timePart?el.timePart:4,price:this.price,priceSale:this.priceSale,currency:this.currency}
;return el.sort&&(stuff.price=el.stock[el.sort].price,stuff.priceSale=el.stock[el.sort].priceSale,stuff.timePart=el.stock[el.sort].timePart?el.stock[el.sort].timePart:4),el.sortName&&(stuff.name=el.name+" "+el.sortName),stuff}function getList(paginate,query,search){function getListComplete(response){0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0);var maxIndex;return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){response.forEach(function(el){99999==el.index&&maxIndex&&el.index--,99999==el.index&&(maxIndex=!0),_setDataForStuff(el,ft)})}).then(function(){return response})}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query,search:search};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function search(search,setData){function getListComplete(response){return setData?$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){response.forEach(function(el){99999==el.index&&maxIndex&&el.index--,99999==el.index&&(maxIndex=!0),_setDataForStuff(el,ft)})}).then(function(){return response}):response}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}var data={search:search,setData:setData};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,o){function getItemComplete(res){return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(ft){return _setDataForStuff(res,ft),res})}function getItemFailed(error){return $q.reject(error)}var query={_id:id};if(o)for(var k in o)query[k]=o[k];return Items.get(query).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/createStuff.html",controller:function($uibModalInstance){var self=this;self.item="",self.ok=function(){$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){item.name?resolve(item):reject()},function(err){reject(err)})})}function getQueryFromUrl(campaignCondition){function setQueryForCampaign(campaign,campaignCondition){var query={};return $q.when().then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){campaignCondition?(campaign.conditionTags&&campaign.conditionTags.length&&(query.queryTags={},campaign.conditionTags.forEach(function(tag){var t=filterTags.getOFA("_id",tag);t&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})),campaign.conditionBrandTags&&campaign.conditionBrandTags.length&&(query.brandTag={$in:campaign.conditionBrandTags}),campaign.conditionBrands&&campaign.conditionBrands.length&&(query.brand={$in:campaign.conditionBrands}),campaign.conditionCategories&&campaign.conditionCategories.length&&(query.category={$in:campaign.conditionCategories}),campaign.conditionStuffs&&campaign.conditionStuffs.length&&(query._id={$in:campaign.conditionStuffs})):(campaign.tags&&campaign.tags.length&&(query.queryTags={},campaign.conditionTags.forEach(function(tag){var t=filterTags.getOFA("_id",tag);t&&(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id))})),campaign.brandTags&&campaign.brandTags.length&&(query.brandTag={$in:campaign.brandTags}),campaign.brands&&campaign.brands.length&&(query.brand={$in:campaign.brands}),campaign.categories&&campaign.categories.length&&(query.category={$in:campaign.categories}),campaign.stuffs&&campaign.stuffs.length&&(query._id={$in:campaign.stuffs})),_setQueryForTags(query);var keys=Object.keys(query),q={};if(1==keys.length)q=query;else if(keys.length>1){q.$or=[];for(var k in query){var o={};o[k]=query[k],q.$or.push(o)}}return q.actived=!0,q})}return"campaign.detail"==$state.current.name?$q.when().then(function(){return global.get("campaign").val}).then(function(campaigns){var campaign=campaigns.getOFA("url",$stateParams.id);if(campaign)return setQueryForCampaign(campaign,campaignCondition)}):queryData}function getQuery(stateParams,to){return _setQuery(stateParams,to)}function _setQueryForTags(query,filters){if(query.queryTags&&"object"==typeof query.queryTags){try{var keys=Object.keys(query.queryTags)}catch(err){keys=[]}1==keys.length?query.tags={$in:query.queryTags[keys[0]]}:keys.length>1&&(query.$and=[],keys.forEach(function(k){query.$and.push({tags:{$in:query.queryTags[k]}})}))}if(delete query.queryTags,query.filters&&"object"==typeof query.filters){try{var keys=Object.keys(query.filters)}catch(err){keys=[]}if(1==keys.length){var filter;filters&&(filter=filters.getOFA("_id",keys[0])),filter&&filter.price?(query.priceForFilter=query.filters[keys[0]],console.log("query.filters[keys[0]]",query.filters[keys[0]])):query["filters."+keys[0]]=query.filters[keys[0]]}else if(keys.length>1&&(query.$and||(query.$and=[]),keys.forEach(function(k){var filter;if(filters&&(filter=filters.getOFA("_id",k)),filter&&filter.price)query.priceForFilter=query.filters[k];else{var o={};o["filters."+k]=query.filters[k],query.$and.push(o)}}),1==query.$and.length)){for(var k in query.$and[0])query[k]=query.$and[0][k];delete query.$and}}delete query.filters}function _setQuery(stateParams,to){global.set("category",null);var parentSection,sectionCategories,categoryBrands=[],categoryFilters=[],query={},breadcrumbs=[];return $q(function(resolve,reject){$q.when().then(function(){return $q.all([Sections.getSections(),Brands.getBrands(),Filters.getFilters()])}).then(function(data){var sections=data[0],brands=data[1],filters=data[2];if(parentSection=Sections.getSection(sections,stateParams.groupUrl),global.set("parentSection",parentSection),parentSection)if("category"!=stateParams.categoryUrl){if(!parentSection.categories||!parentSection.categories.length)throw 404;var categorySet;if(parentSection.categories.forEach(function(c){c.url==stateParams.categoryUrl?(global.set("category",c),categorySet=!0,c.set=!0,query.category=c._id,categoryBrands=c.brands,categoryFilters=c.filters):c.set=!1}),!query.category)throw 404}else sectionCategories=Sections.getEmbededCategories(parentSection,[]).map(function(el){return el._id}),sectionCategories.length?(query.category={$in:sectionCategories},sectionCategories.forEach(function(cat){var c=global.get("categoriesO").val[cat];c.filters.forEach(function(f){categoryFilters.indexOf(f)<0&&categoryFilters.push(f)}),c.brands.forEach(function(b){categoryBrands.indexOf(b)<0&&categoryBrands.push(b)})})):query.category=null;var brandSet,brandTagSet,brandsArr,brandTagsArr;stateParams.brand&&(brandsArr=stateParams.brand.split("__")),stateParams.brandTag&&(brandTagsArr=stateParams.brandTag.split("__")),query.brand=[],query.brandTag=[],brands.forEach(function(b){b.inList=!1,b.showCollections=!1,"stuffs"==to.name||"stuffs.stuff"==to.name?categoryBrands&&categoryBrands.length&&categoryBrands.indexOf(b._id)>-1&&(b.inList=!0):b.inList=!0,brandsArr&&brandsArr.indexOf(b.url)>-1?(query.brand.push(b._id),b.set=!0,breadcrumbs.push({type:"brand",name:b.name,url:b.url}),brandSet=!0):b.set=!1,b.tags.forEach(function(t){brandTagsArr&&brandTagsArr.indexOf(t.url)>-1?(query.brandTag.push(t._id),t.set=!0,breadcrumbs.push({type:"brandTag",name:t.name,url:t.url}),b.showCollections=!0,brandTagSet=!0):t.set=!1})}),query.brand.length?1==query.brand.length?query.brand=query.brand[0]:query.brand={$in:query.brand}:query.brand=null,query.brandTag.length?1==query.brandTag.length?query.brandTag=query.brandTag[0]:query.brandTag={$in:query.brandTag}:query.brandTag=null,query.brandTag||delete query.brandTag,query.brand||delete query.brand,brandSet||$location.search("brand",null),brandTagSet||$location.search("brandTag",null);var queryTags;stateParams.queryTag&&(queryTags=stateParams.queryTag.split("__"),queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos})),query.filters={};var filterTags;if(stateParams.filterTag&&(filterTags=stateParams.filterTag.split("__"),filterTags=filterTags.filter(function(item,pos){return filterTags.indexOf(item)==pos}),filterTags=filterTags.map(function(f){return f.split("_")}).filter(function(f){return 3==f.length}).forEach(function(f){query.filters[f[0]]={$gte:Number(f[1]),$lte:Number(f[2])}})),query.queryTags={},filters.forEach(function(f){f.inList=!1,"stuffs"==to.name||"stuffs.stuff"==to.name?categoryFilters.indexOf(f._id)>-1&&(f.inList=!0,f.open=!1):f.inList=!0,categoryFilters&&categoryFilters.length&&categoryFilters.indexOf(f._id)>-1&&(f.inList=!0,f.open=!1),f.count?query.filters[f._id]?(f.open=!0,f.set=!0,f.minValue=query.filters[f._id].$gte,f.maxValue=query.filters[f._id].$lte):(f.minValue=f.min,f.maxValue=f.max):f.tags.forEach(function(t){queryTags&&queryTags.indexOf(t.url)>-1?(query.queryTags[t.filter]||(query.queryTags[t.filter]=[]),query.queryTags[t.filter].push(t._id),f.open=!0,t.set=!0,breadcrumbs.push({type:"queryTag",name:t.name,url:t.url})):t.set=!1})}),_setQueryForTags(query,filters),global.set("breadcrumbs",breadcrumbs),"stuffs"!=to.name&&"stuffs.stuff"!=to.name||(query.actived=!0),stateParams.searchStr){var search=stateParams.searchStr.substring(0,20);query["keywords."+global.get("store").val.lang]=search}resolve(query)}).catch(function(err){reject(err)})})}function setFilters(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/filterStuffsList.html",controller:setFiltersCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"}).result.then(function(){resolve()},function(){reject()})})}function cloneStuff(stuff,clone){if(global.get("seller").val)return $q.when().then(function(){if(stuff&&stuff._id)return Items.get({_id:stuff._id,clone:"clone"}).$promise;if($stateParams&&"category"!=$stateParams.categoryUrl){var category=global.get("categories").val.getOFA("url",$stateParams.categoryUrl);category&&category._id&&(stuff.category=category)}return stuff}).then(function(st){return console.log(st),stuff=angular.copy(st),stuff.category&&!stuff.category.length&&(stuff.category=[stuff.category]),stuff.index||(stuff.index=0),stuff.index++,delete stuff._id,delete stuff.url,delete stuff.link,delete stuff.__v,delete stuff.nameL,delete stuff.artikulL,delete stuff.gallery,delete stuff.sort,delete stuff.sortsOfStuff,delete stuff.keywords,stuff.blocks&&stuff.blocks.length&&stuff.blocks.forEach(function(b){delete b._id,b.template=null,b.templateName=null,b.img&&(b.img=null),b.video&&(b.video=null),b.imgs&&b.imgs.length&&b.imgs.forEach(function(slide){slide.img&&(slide.img=null)})}),stuff.stock={notag:{price:stuff.price}},stuff.actived=!1,$q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/cloneStuffModal.html",controller:cloneStuffCtrl,controllerAs:"$ctrl",size:"lg",resolve:{stuff:function(){return stuff},clone:function(){return clone}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})})}function saveField(stuff,field){var f=field.split(" "),o={_id:stuff._id};return f.forEach(function(el){o[el]=stuff[el]}),Items.save({update:field},o).$promise}function selectItem(query){return console.log("внимание - сделать так же как и  selectItemWithSort"),$q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffModal.html",controller:selectStuffCtrl,controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}function selectItemWithSort(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/selectStuffWithSortModal.html",controller:selectItemWithSortCtrl,controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}function getServicesForOnlineEntry(){function getListComplete(data){data.shift();var items=[];return data.forEach(function(el){_setPrice(el),el.sort=null;var category=el.category&&el.category.length?el.category[0]:el.category;if(global.get("categoriesO")&&global.get("categoriesO").val)var c=global.get("categoriesO").val[category];else var c=global.get("categories").val.getOFA("_id",category);c||(c={name:"Категория"}),el.category=c.name,el.timePart||(el.timePart=4);try{if(el.sortsOfStuff&&el.sortsOfStuff.differentPrice)for(var sort in el.stock){var s={_id:el._id,name:el.name+" "+_getTagName(sort),nameL:el.nameL,link:el.link,artikul:el.artikul,price:el.stock[sort].price,category:el.category,timePart:el.timePart};items.push(s)}else{if(el.stock.notag)el.price=el.stock.notag.price;else try{el.price=el.stock[Object.keys(el.stock)[0]].price}catch(err){console.log(err)}items.push(el)}}catch(err){console.log(err)}}),stuffsService=items,items}function getListFailed(error){return console.log("XHR Failed for getStuffs."+error),$q.reject(error)}function _getTagName(_id){return _id&&filterTags&&"notag"!=_id&&_filterTagsO[_id]?_filterTagsO[_id].name:""}if(stuffsService&&stuffsService.length)return stuffsService;var data={query:{orderType:{$in:[2,7]},actived:!0}},filterTags=[];return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),$q.when().then(function(){return FilterTags.getFilterTags()}).then(function(fts){filterTags=fts}).then(function(){return Items.query(data).$promise}).then(getListComplete).catch(getListFailed)}var Items=$resource("/api/collections/Stuff/:_id",{_id:"@_id"}),categoriesLink={},queryData={},stuffsService=[];return $rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){"stuffs"!=to.name&&"stuffs.stuff"!=to.name&&"frame.stuffs"!=to.name&&"frame.stuffs.stuff"!=to.name||$q.when().then(function(){return getQuery(toParams,to)}).then(function(query){queryData=query})}),{Items:Items,query:Items.query,get:Items.get,getList:getList,search:search,getItem:getItem,save:Items.save,delete:Items.delete,create:create,getQuery:getQuery,getQueryFromUrl:getQueryFromUrl,setFilters:setFilters,cloneStuff:cloneStuff,saveField:saveField,selectItem:selectItem,select:selectItem,selectItemWithSort:selectItemWithSort,getServicesForOnlineEntry:getServicesForOnlineEntry,getAllBonus:getAllBonus,zoomImg:zoomImgGlobal,setDataForStuff:_setDataForStuff,getDataForBooking:_getDataForBooking};var delay}function setFiltersCtrl(global,$uibModalInstance){var self=this;self.global=global,self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(){$uibModalInstance.close()}}function cloneStuffCtrl($q,global,Stuff,stuff,$uibModalInstance,Category,clone){var self=this;self.Items=Stuff;self.stuff=stuff,self.clone=clone,self.categoryDisabled=!0,self.selectCategory=function(){$q.when().then(function(){return Category.select()}).then(function(selectedCategory){self.stuff.category||(self.categoryDisabled=!1,setTimeout(function(){$("#createStuffCategory").trigger("change"),self.categoryDisabled=!0},100)),self.stuff.category=selectedCategory}).catch(function(err){console.log(err)})},self.createNewStuff=function(){return self.stuff.category?self.stuff.name?(self.stuff.name=self.stuff.name.substring(0,100),self.stuff.artikul&&(self.stuff.artikul=self.stuff.artikul.substring(0,100)),!self.clone&&self.stuff.category&&self.stuff.category._id&&(self.stuff.category=self.stuff.category._id),stuff.stock&&stuff.stock.notag&&stuff.stock.notag.price!=stuff.price&&(stuff.stock.notag.price=stuff.price),void $q.when().then(function(){self.stuff.keywords={};var k=self.stuff.name;if(self.stuff.artikul&&(k+=" "+self.stuff.artikul),self.stuff.category){var c;if("object"==typeof self.stuff.category){var cc="object"==typeof self.stuff.category[0]?self.stuff.category[0]._id:self.stuff.category[0];c=global.get("categories").val.getOFA("_id",cc)}else c=global.get("categories").val.getOFA("_id",self.stuff.category);k+=" "+(c.nameL&&c.nameL[global.get("store").val.lang]?c.nameL[global.get("store").val.lang]:c.name)}if(self.stuff.brand){var bb="object"==typeof self.stuff.brand?self.stuff.brand._id:self.stuff.brand,b=global.get("brands").val.getOFA("_id",bb);if(k+=" "+(b.nameL&&b.nameL[global.get("store").val.lang]?b.nameL[global.get("store").val.lang]:b.name),self.stuff.brandTag){var bt=b.tags.getOFA("_id",self.stuff.brandTag);bt&&bt.nameL&&bt.nameL[global.get("store").val.lang]&&(k+=" "+bt.nameL[global.get("store").val.lang])}}return stuff.keywords[global.get("store").val.lang]=k,self.Items.save(self.stuff).$promise}).then(function(res){self.stuff._id=res.id,self.stuff.url=res.url;var c;if("object"==typeof self.stuff.category){var cc="object"==typeof self.stuff.category[0]?self.stuff.category[0]._id:self.stuff.category[0];c=global.get("categories").val.getOFA("_id",cc)}else c=global.get("categories").val.getOFA("_id",self.stuff.category);self.stuff.link="/"+c.linkData.groupUrl+"/"+c.linkData.categoryUrl+"/"+res.url,self.Items.save({update:"link"},{_id:self.stuff._id,link:self.stuff.link}),$uibModalInstance.close(self.stuff)}).catch(function(err){return $q.reject(err)})):(self.alertMessage2=!0,void setTimeout(function(){self.alertMessage2=!1},3e3)):(self.alertMessage2=!0,void setTimeout(function(){console.log("))))"),self.alertMessage2=!1},3e3))},self.cancel=function(){$uibModalInstance.dismiss("cancel")}}function selectStuffCtrl($q,Stuff,$uibModalInstance,query){var self=(angular.copy(query),this);self.stuffs=[],self.name="";self.search=function(name){name.length<3||(query?(query.$and||(query={$and:[query]}),query.$and.push({$or:[{name:name},{artikul:name}]})):query={$or:[{name:name},{artikul:name}]},$q.when().then(function(){return Stuff.search(name,!0)}).then(function(res){self.stuffs=res}))},self.selectStuff=function(stuff){stuff.imgThumb&&(stuff.img=stuff.imgThumb),stuff.link="/"+stuff.groupUrl+"/"+stuff.categoryUrl+"/"+stuff.url,$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss()}}function selectItemWithSortCtrl($q,Stuff,$uibModalInstance,Filters,FilterTags,exception,query,global){function getFilterName(_id){return self.filters.getOFA("_id",_id).name||null}var self=(angular.copy(query),this);self.global=global,self.stuffs=[],self.name="";self.getFilterName=getFilterName,self.search=function(name){name.length<3||$q.when().then(function(){return Stuff.search(name,!0)}).then(function(res){global.get("seller")&&global.get("seller").val?self.stuffs=res:self.stuffs=res.map(function(s){for(var i=0;i<s.stockKeysArray.length;i++)s.stockKeysArray[i].quantity||(s.stockKeysArray.splice(i,1),i--);return s}).filter(function(s){return s.actived&&s.stockKeysArray.length})})},self.selectStuff=function(stuff){stuff.sortsOfStuff&&stuff.sortsOfStuff.filter&&!stuff.sort?exception.catcher("ошибка")("выберите разновидность"):$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss()},function(){$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){self.filterTags=filterTags}).catch(function(err){console.log(err)})}()}function commentService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/createComment.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Comment/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Stuff",stuffService).service("Comments",commentService),stuffService.$inject=["$resource","$uibModal","$q","Sections","$stateParams","$state","$location","Brands","FilterTags","global","$order","exception","$user","$email","CreateContent","$rootScope","Filters","$timeout"],setFiltersCtrl.$inject=["global","$uibModalInstance"],cloneStuffCtrl.$inject=["$q","global","Stuff","stuff","$uibModalInstance","Category","clone"],selectStuffCtrl.$inject=["$q","Stuff","$uibModalInstance","query"],selectItemWithSortCtrl.$inject=["$q","Stuff","$uibModalInstance","Filters","FilterTags","exception","query","global"],commentService.$inject=["$resource","$uibModal","$q"]}(),function(){function likesItem(){return{scope:{},bindToController:!0,controller:likesItemCtrl,controllerAs:"$ctrl",templateUrl:"",restrict:"E"}}function likesItemCtrl($compile,$timeout,localStorage,Stuff,global){return{restrict:"EA",scope:{current:"=",header:"@",mobile:"@",blockElement:"@"},template:'<h3 class="text-center" ng-bind="header"></h3><div id="lastViewedWrapper" class="owl-carousel owl-theme"><div ng-repeat="s in stuffs track by $index" class="item"><a ui-sref="stuffs.stuff(s.linkData)"><img style="max-width: 200px; border-color: transparent" ng-src="{{s.img}}" ></a></div></div>',link:function(scope,element,attrs){function activate(){scope.position=JSON.parse(scope.blockElement).position,scope.mobile?scope.itemsInList=3:scope.position&&"bottom"==scope.position&&(scope.itemsInList=6),setViewed(angular.copy(scope.current)),viewedStuffs.length>2?(scope.stuffs=viewedStuffs,scope.stuffs.forEach(function(el){el.getUrlParams=Stuff.getUrlParams}),$timeout(function(){$("#lastViewedWrapper").owlCarousel({items:scope.itemsInList,itemsMobile:[479,3],itemsTablet:[768,scope.itemsInList],itemsDesktop:[1199,scope.itemsInList],itemsDesktopSmall:[979,scope.itemsInList]})},150)):scope.stuffs=[],scope.header||(scope.header="Последние просмотренные.")}function setViewed(stuff){for(var posItem=-1,i=0,l=viewedStuffs.length;i<l;i++)if(viewedStuffs[i]._id==stuff._id){posItem=i;break}if(posItem>-1&&viewedStuffs.splice(posItem,1),stuff.gallery[0])var img=stuff.gallery[0].thumbSmall?stuff.gallery[0].thumbSmall:stuff.gallery[0].thumb;else var img=null;var linkData=global.get("categories").val.getOFA("_id",stuff.category).linkData;linkData.stuffUrl=stuff.url,viewedStuffs.unshift({_id:stuff._id,linkData:linkData,url:stuff.url,img:img}),viewedStuffs.length>15&&viewedStuffs.splice(15,1),localStorage.set(subDomain+"-viewed",viewedStuffs)}var subDomain=global.get("store").val.subDomain;scope.localId=Date.now();var viewedStuffs=localStorage.get(subDomain+"-viewed");viewedStuffs||(viewedStuffs=[]),scope.itemsInList=4,scope.$watch("current",function(n){n&&activate()}),scope.$on("$destroy",function(){$("#carouse"+scope.localId).remove()})}}}function homePageHtmlCtrl($scope,$rootScope,$timeout,$element,$compile,global,$q,$http){function getHomePageHtml(){console.log("getHomePageHtml"),$q.when().then(function(){return $http.get("homepageHTML.html")}).then(function(response){var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content),loaded=!0}).catch(function(err){})}var loaded=null;$rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){"home"!=to.name||loaded||getHomePageHtml()})}function homePageStuffOwlCtrl($scope,$timeout,$element,$compile,global){function prev(){self.$owl.trigger("prev.owl.carousel",[self.selectedDay-3,300])}function next(){self.$owl.trigger("next.owl.carousel",[self.selectedDay+3,300])}function zoomSliderImg(i){$rootScope.zoomSliderImg(i,imgs)}var self=this;self.prev=prev,self.next=next,self.moment=moment,self.global=global;var imgs;self.zoomSliderImg=zoomSliderImg;var items=4,items3=3,items2=2,autoplay=!1,autoplayTimeout=4e3;this.$onInit=function(){$timeout(function(){if(self.items&&(items=self.items),2==items?items3=2:1==items&&(items3=1,items2=1),self.autoplay&&(autoplay=!0),self.duration)try{var duration=Number(self.duration);duration>0&&duration<10&&(autoplayTimeout=1e3*duration)}catch(err){console.log(err)}self.$owl=$("body").find("#"+self.homePageStuffOwl),self.$owl.on("initialized.owl.carousel",function(event){});var navLeft=$element.find(".nav-left");$(navLeft).click(function(){prev()});var navRight=$element.find(".nav-right");$(navRight).click(function(){next()}),activate()},100)},$scope.$watch(function(){return self.gallery},function(n,o){if(n&&n.length){var html="";imgs=[],n.forEach(function(item,i){photoHost?item.src=photoHost+"/"+item.img:item.src=item.img,html+='<a><span class="zoom-plus" data-i="'+i+'"><span class="icon-zoom-img"></span><span class="icon-zoom-inverse"></span></span><img class="img-responsive2" src="'+item.src+'"></a>'+imgs.push({index:i,img:item.src})}),self.$owl.trigger("replace.owl.carousel",html).trigger("to.owl.carousel",0).trigger("refresh.owl.carousel"),$timeout(function(){self.$owl.trigger("refresh.owl.carousel")},10),$timeout(function(){if(self.zoomImg){self.$owl.find("span.zoom-plus").each(function(i,img){$(img).click(function(event){var ii=$(img).data("i")>=0?$(img).data("i"):0;global.get("functions").val.zoomImg(ii,imgs,"home")})})}},400)}});var items=self.items?self.items:4,activate=function(){$timeout(function(){var carousel_Settings={loop:!0,margin:10,responsiveClass:!0,autoplay:autoplay,autoplayHoverPause:!0,autoplayTimeout:autoplayTimeout,responsive:{0:{items:1,nav:!1,dots:!0},380:{items:items2,nav:!1,dots:!0},1068:{items:items3,nav:!1,dots:!0},1400:{items:items,nav:!1,dots:!0}}};self.$owl.owlCarousel(carousel_Settings);var imgsEl=self.$owl.find("img");if(imgsEl&&imgsEl.each&&(imgs=[],imgsEl.each(function(i,img){imgs.push({index:i,img:img.src,el:imgsEl[i]})})),self.zoomImg){self.$owl.find("span.zoom-plus").each(function(i,img){$(img).click(function(event){for(var imgTemp=imgs[i].img,imgsTemp=imgs.reduce(function(o,item){return o.getOFA("img",item.img)||o.push(item),o},[]),ii=0,j=0;j<imgsTemp.length;j++)if(imgsTemp[j].img==imgTemp){ii=j;break}global.get("functions").val.zoomImg(ii,imgsTemp,"home")})})}},200)}}function emptyList(){return{templateUrl:"views/template/partials/stuffs/emptyList.html",restrict:"E"}}function stuffListDirective(){return{scope:{},bindToController:!0,controller:stuffListCtrl,controllerAs:"$ctrl",templateUrl:"components/stuff/stuffsAdminList.html",restrict:"E"}}function stuffListTemplateDirective(global){return{scope:{filtersBlock:"@"},bindToController:!0,controller:stuffListCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/stuffs/stuffs-block.html",restrict:"E"}}function stuffListTemplateDirectiveList(global){return{scope:{},bindToController:!0,controller:stuffListCtrl,controllerAs:"$ctrl",templateUrl:function(){return"views/template/partials/stuffs/stuffs-list/"+global.get("sectionType").val},restrict:"E"}}function stuffInList(global,$timeout){return{scope:{stuffInList:"@"},bindToController:!0,controllerAs:"$ctrl",restrict:"A",controller:function($scope,Stuff,global,$attrs,$stateParams,$rootScope,localStorage){function getAveragePrice(price){if(price){var p=price*global.get("rate").val;return p=Math.round(100*p)/100,formatAverage&&(4==formatAverage?p=100*Math.round(p/100):3==formatAverage?p=10*Math.round(p/10):2==formatAverage?p=Math.round(p):1==formatAverage&&(p=Math.round(10*p)/10)),p}}function getMastersName(){self.stuff.masters=[],global.get("masters").val.forEach(function(m){if(m.stuffs&&m.stuffs.length&&m.stuffs.indexOf(self.stuff._id)>-1){var o={name:m.name,url:m.url};self.stuff.masters.push(o)}})}function addToLikes($event){$event.stopPropagation(),console.log("addToLikes"),(likes=localStorage.get(subDomain+"-likes"))||(likes=[]);var i=likes.indexOf($scope.stuff._id);i>-1?($scope.stuff.inLikes=!1,likes.splice(i,1)):($scope.stuff.inLikes=!0,likes.push($scope.stuff._id)),localStorage.set(subDomain+"-likes",likes),$rootScope.likes.totalCount=likes.length}var self=this;self.global=global,$scope.global=global;var subDomain=global.get("store").val.subDomain;$scope.stuff=JSON.parse($attrs.stuffInList),$scope.stuff=Stuff.setDataForStuff($scope.stuff,global.get("filterTags").val,"stuffs"),$scope.stuff.stateObj=angular.copy($stateParams),$scope.stuff.stateObj.stuffUrl=$scope.stuff.url,self.stuff=$scope.stuff,self.getMastersName=getMastersName,self.getAveragePrice=getAveragePrice,self.addToLikes=addToLikes;var currency=global.get("currency").val,formatAverage=global.get("store").val.currency[currency][4],del=-1;1==formatAverage?del=-1:2==formatAverage?del=0:3==formatAverage?del=1:4==formatAverage&&(del=2),self.formatPrice=global.get("store").val.currency[currency][5],void 0===self.formatPrice&&(self.formatPrice=2),self.stuff.currencySymbol=global.get("store").val.currency[global.get("currency").val]&&global.get("store").val.currency[global.get("currency").val][2]?global.get("store").val.currency[global.get("currency").val][2]:"",$rootScope.$on("changeCurrency",function(){currency=global.get("currency").val,formatAverage=global.get("store").val.currency[currency][4],self.formatPrice=global.get("store").val.currency[currency][5],void 0===self.formatPrice&&(self.formatPrice=2),del=-1,1==formatAverage?del=-1:2==formatAverage?del=0:3==formatAverage?del=1:4==formatAverage&&(del=2),self.stuff.currencySymbol=global.get("store").val.currency[global.get("currency").val]&&global.get("store").val.currency[global.get("currency").val][2]?global.get("store").val.currency[global.get("currency").val][2]:global.get("currency").val}),getMastersName();var likes=localStorage.get(subDomain+"-likes");likes&&likes.length&&likes.some(function(s){return s===$scope.stuff._id})&&($scope.stuff.inLikes=!0)},transclude:!0,link:function(scope,element,attrs,ctrl,transclude){$timeout(function(){global.get("stuffsInList").val&&element[0].parentElement&&element[0].parentElement.parentElement&&element[0].parentElement.parentElement.id&&global.get("stuffsInList").val[element[0].parentElement.parentElement.id]&&global.get("stuffsInList").val[element[0].parentElement.parentElement.id].push(scope.stuff)},200),transclude(scope,function(clone){element.append(clone)})}}}function stuffListTemplateServer(){return{scope:{},bindToController:!0,controllerAs:"$ctrl",template:"<div></div>",controller:stuffListFromServerCtrl,restrict:"E"}}function stuffListFromServerCtrl($scope,$state,$compile,$element,$window,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,Helper,anchorSmoothScroll,Photo,$timeout,$anchorScroll,Category,Brands,BrandTags,seoContent,AddInfo,$http,$location,$sce){function filterList(){console.log("filterList22"),$q.when().then(function(){return self.Items.setFilters()}).catch(function(err){})}function setDataForStuff(stuff){return stuff=Stuff.setDataForStuff(stuff,global.get("filterTags").val),stuff=angular.copy(stuff),console.log(stuff.name+" "+stuff.artikul,stuff.sticker),stuff}function getList(){$q.when().then(function(){return $http.get(url.trim()+".html",{params:{pages:[self.paginate.page],perPage:perPage,rows:rows,query:self.query,url:$location.url()}})}).then(function(response){if(response){$anchorScroll(),lastElement=null;var addHtml=angular.element(response.data.html);if(addHtml.find("#td-list-1").html()){var atd1=$compile(addHtml.find("#td-list-1").html())($scope);td1.html(atd1)}if(addHtml.find("#td-list-2").html()){
var atd2=$compile(addHtml.find("#td-list-2").html())($scope);td2.html(atd2)}if(addHtml.find("#td-list-3").html()){var atd3=$compile(addHtml.find("#td-list-3").html())($scope);td3.html(atd3)}if(addHtml.find("#td-list-4").html()){var atd4=$compile(addHtml.find("#td-list-4").html())($scope);td4.html(atd4)}self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null},200)}})}var stuffsInList={"td-list-1":[],"td-list-2":[],"td-list-3":[],"td-list-4":[],"td-list-5":[],"td-list-6":[]};global.set("stuffsInList",stuffsInList);var self=this;$scope.global=global,self.stuffs={},self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.globalProperty=$rootScope.globalProperty,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.paginate={page:0,rows:20,items:0},self.filterList=filterList,self.initStuff=setDataForStuff,self.getList=getList,$scope.$on("addBlockAfterScroll",function(){$scope.addBlockAfterScroll()});var pages=[0],perPage=20,rows=global.get("functions").val.setRows();global.get("store").val.template.stuffListType[global.get("sectionType").val]&&global.get("store").val.template.stuffListType[global.get("sectionType").val].perPage&&(perPage=global.get("store").val.template.stuffListType[global.get("sectionType").val].perPage,self.paginate.rows=perPage);var waiting,lastElement,waitingDiv,td1,td2,td3,td4,td5,url="views/template/partials/stuffs/stuffs-list/"+global.get("sectionType").val+"/"+$rootScope.$stateParams.groupUrl+"/"+$rootScope.$stateParams.categoryUrl,page=0,color=global.get("store").val.template.dimScreenColor?global.get("store").val.template.dimScreenColor:"#000000",BGcolor=global.get("store").val.template.dimScreenBGColor?global.get("store").val.template.dimScreenBGColor:"#F5F5F5",innerWaitingDiv=['<div class="spinner-box clearfix text-center" style="width:100%;height:200px;background-color:'+BGcolor+";color:"+color+'">','<span class="icon-spinner-img"></span>',"</div>"].join("");$q.when().then(function(){var params={group:self.$stateParams.groupUrl,category:self.$stateParams.categoryUrl};self.$stateParams.brand,self.$stateParams.brandTag;for(var k in self.$stateParams)params[k]=self.$stateParams[k];if(self.query=dQ.getQuery(params),self.query&&self.query.priceForFilter&&1!=global.get("rate").val&&(self.query.priceForFilter.$gte=Math.ceil10(self.query.priceForFilter.$gte/global.get("rate").val,0),self.query.priceForFilter.$lte=Math.ceil10(self.query.priceForFilter.$lte/global.get("rate").val,0)),global.get("tempContent").val){if($state.current.name.indexOf(".stuff")<0){var html=$("#tempContent").detach().html(),o={data:{html:html}};return tempTitles&&(o.data.titles=tempTitles),o}return null}return $q.when(self.query).then(function(query){return $http.get(url.trim()+".html",{params:{pages:pages,perPage:perPage,rows:rows,query:query,url:$location.url()}})})}).then(function(response){if(!response)return void $rootScope.$emit("$stateChangeEndToStuff");if(global.get("tempContent").val){global.set("tempContent",null);var linkFn=$compile(response.data.html),content=linkFn($scope)}else{console.log("ldldldl");var linkFn=$compile(response.data.html),content=linkFn($scope)}$element.append(content);var style=$element.find("style");style&&style[0];var titles={};if(response.data.titles&&response.data.titles.title){for(var k in response.data.titles)response.data.titles[k]&&("canonical"==k?titles[k]=$sce.trustAsResourceUrl(response.data.titles[k]):"desc"!=k&&(titles[k]=response.data.titles[k]));global.set("titles",titles)}else seoContent.setSeopageData();waitingDiv=$("#paginateData"+page),self.totalQty=waitingDiv.data("total"),self.paginate.items=self.totalQty,self.currentQty=waitingDiv.data("qty"),self.page=waitingDiv.data("page"),self.lastItemId=waitingDiv.data("lastItemId"),td1=$("#td-list-1 .td-wrapper"),td2=$("#td-list-2 .td-wrapper"),td3=$("#td-list-3 .td-wrapper"),td4=$("#td-list-4 .td-wrapper"),td5=$("#td-list-5 .td-wrapper"),$timeout(function(){$anchorScroll(),lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null}),$timeout(function(){$scope.$broadcast("rzSliderForceRender")},500);var addBlockAfterScroll=function(){"stuffs"==$state.current.name&&!waiting&&lastElement&&$(lastElement).isOnScreen()&&self.currentQty<self.totalQty&&(waiting=!0,page++,$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url.trim()+".html",{params:{pages:[page],perPage:perPage,rows:rows,query:self.query,url:$location.url()}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200)}}))};global.get("store").val.template.stuffListType[global.get("sectionType").val]&&global.get("store").val.template.stuffListType[global.get("sectionType").val].paginate||angular.element($window).on("scroll",addBlockAfterScroll),$scope.$on("$destroy",function(){angular.element($window).off("scroll",addBlockAfterScroll)}),$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")})}),$scope.addBlockAfterScroll=function(){!waiting&&lastElement&&self.currentQty<self.totalQty?(waiting=!0,page++,$rootScope.$emit("$stateChangeStartToStuff"),$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url.trim()+".html",{params:{pages:[page],perPage:perPage,rows:rows,query:self.query,url:$location.url()}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200),$timeout(function(){$rootScope.$broadcast("addBlockAfterScrollDone"),$rootScope.$emit("$stateChangeEndToStuff")},300)}}).catch(function(){$rootScope.$emit("$stateChangeEndToStuff")})):$timeout(function(){$rootScope.$broadcast("addBlockAfterScrollDone")},200)}}function stuffListTemplateDirectiveCampaignList(){return{scope:{campaignCondition:"@"},bindToController:!0,controller:campaignStuffListCtrl,controllerAs:"$ctrl",template:"<div></div>",restrict:"E"}}function campaignStuffListCtrl($scope,$state,$compile,$element,$window,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,Helper,anchorSmoothScroll,Photo,$timeout,$anchorScroll,Category,Brands,BrandTags,seoContent,AddInfo,$http,$location,localStorage){function filterList(){$q.when().then(function(){return self.Items.setFilters()}).catch(function(err){})}function setDataForStuff(stuff){return console.log(stuff.name),stuff=Stuff.setDataForStuff(stuff,global.get("filterTags").val),stuff=angular.copy(stuff),console.log(stuff.name+" "+stuff.artikul,stuff.sticker),stuff}function getList(){$q.when().then(function(){return $http.get(url,{params:{pages:[self.paginate.page],perPage:self.paginate.rows,rows:rows}})}).then(function(response){if(response){$anchorScroll(),lastElement=null;var addHtml=angular.element(response.data.html);if(addHtml.find("#td-list-1").html()){var atd1=$compile(addHtml.find("#td-list-1").html())($scope);td1.html(atd1)}if(addHtml.find("#td-list-2").html()){var atd2=$compile(addHtml.find("#td-list-2").html())($scope);td2.html(atd2)}if(addHtml.find("#td-list-3").html()){var atd3=$compile(addHtml.find("#td-list-3").html())($scope);td3.html(atd3)}if(addHtml.find("#td-list-4").html()){var atd4=$compile(addHtml.find("#td-list-4").html())($scope);td4.html(atd4)}self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null},200)}})}anchorSmoothScroll.scrollTo("topPage");var stuffsInList={"td-list-1":[],"td-list-2":[],"td-list-3":[],"td-list-4":[],"td-list-5":[],"td-list-6":[]};global.set("stuffsInList",stuffsInList);var self=this;self.stuffs={},self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.globalProperty=$rootScope.globalProperty,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.paginate={page:0,rows:20,items:0};var cartType=$element.data("cart")?$element.data("cart"):"good",campaignCondition=$element.data("condition")?$element.data("condition"):"stuffs";self.filterList=filterList,self.initStuff=setDataForStuff,self.getList=getList,$scope.$on("addBlockAfterScroll",function(){$scope.addBlockAfterScroll()});var pages=[0],perPage=20,rows=global.get("functions").val.setRows();global.get("store").val.template.stuffListType[cartType]&&global.get("store").val.template.stuffListType[cartType].perPage&&(perPage=global.get("store").val.template.stuffListType[cartType].perPage,self.paginate.rows=perPage);var waiting,lastElement,waitingDiv,td1,td2,td3,td4,td5,page=0,color=global.get("store").val.template.dimScreenColor?global.get("store").val.template.dimScreenColor:"#000000",BGcolor=global.get("store").val.template.dimScreenBGColor?global.get("store").val.template.dimScreenBGColor:"#F5F5F5",innerWaitingDiv=['<div class="spinner-box clearfix text-center" style="width:100%;height:200px;background-color:'+BGcolor+";color:"+color+'">','<span class="icon-spinner-img"></span>',"</div>"].join(""),campaign=$element.data("campaign");if("likes"===$rootScope.$state.current.name){campaign="likes";var likes=localStorage.get(global.get("store").val.subDomain+"-likes");campaignCondition=likes&&likes.length?likes.join("_"):"_"}var url="views/template/partials/"+campaign+"/"+campaignCondition;console.log(url),$q.when().then(function(){return $http.get(url,{params:{pages:pages,perPage:perPage,rows:rows}})}).then(function(response){if(!response)return void $rootScope.$emit("$stateChangeEndToStuff");var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content);var style=$element.find("style");style&&style[0],waitingDiv=$("#paginateData"+page),self.totalQty=waitingDiv.data("total"),self.paginate.items=self.totalQty,self.currentQty=waitingDiv.data("qty"),self.page=waitingDiv.data("page"),self.lastItemId=waitingDiv.data("lastItemId"),td1=$("#td-list-1 .td-wrapper"),td2=$("#td-list-2 .td-wrapper"),td3=$("#td-list-3 .td-wrapper"),td4=$("#td-list-4 .td-wrapper"),td5=$("#td-list-5 .td-wrapper"),$timeout(function(){$anchorScroll(),lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null});var addBlockAfterScroll=function(){!waiting&&lastElement&&$(lastElement).isOnScreen()&&self.currentQty<self.totalQty&&(waiting=!0,page++,$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url,{params:{pages:[page],perPage:perPage,rows:rows}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200)}}))};global.get("store").val.template.stuffListType[cartType]&&global.get("store").val.template.stuffListType[cartType].paginate||angular.element($window).on("scroll",addBlockAfterScroll),$scope.$on("$destroy",function(){angular.element($window).off("scroll",addBlockAfterScroll)}),$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")})}),$scope.addBlockAfterScroll=function(){!waiting&&lastElement&&self.currentQty<self.totalQty&&(waiting=!0,page++,$rootScope.$emit("$stateChangeStartToStuff"),$q.when().then(function(){return waitingDiv.html(innerWaitingDiv),$http.get(url,{params:{pages:[page],perPage:perPage,rows:rows}})}).then(function(response){if(response){lastElement=null,waitingDiv.html("");var atd1,atd2,atd3,atd4,atd5,addHtml=angular.element(response.data.html);addHtml.find("#td-list-1 .td-wrapper").html()&&(atd1=$compile(addHtml.find("#td-list-1 .td-wrapper").html())($scope)),addHtml.find("#td-list-2 .td-wrapper").html()&&(atd2=$compile(addHtml.find("#td-list-2 .td-wrapper").html())($scope)),addHtml.find("#td-list-3 .td-wrapper").html()&&(atd3=$compile(addHtml.find("#td-list-3 .td-wrapper").html())($scope)),addHtml.find("#td-list-4 .td-wrapper").html()&&(atd4=$compile(addHtml.find("#td-list-4 .td-wrapper").html())($scope)),addHtml.find("#td-list-5 .td-wrapper").html()&&(atd5=$compile(addHtml.find("#td-list-5 .td-wrapper").html())($scope)),atd5&&td5.append(atd5),atd4&&td4.append(atd4),atd3&&td3.append(atd3),atd2&&td2.append(atd2),atd1&&td1.append(atd1),self.lastItemId=addHtml.find("#paginateData"+page).data("lastItemId"),self.currentQty+=addHtml.find("#paginateData"+page).data("qty"),$timeout(function(){lastElement=null!=self.lastItemId?$("#list"+self.lastItemId):null,waiting=!1},200),$timeout(function(){$rootScope.$broadcast("addBlockAfterScrollDone"),$rootScope.$emit("$stateChangeEndToStuff")},300)}}).catch(function(){$rootScope.$emit("$stateChangeEndToStuff")}))}}function stuffListCtrl($scope,Stuff,$rootScope,$q,$uibModal,global,exception,FilterTags,Filters,Confirm,Helper,anchorSmoothScroll,Photo,$timeout,$anchorScroll,Category,Brands,BrandTags,seoContent,AddInfo,$http,$location,$element){function getList(reload){if(reload&&$rootScope.$emit("$stateChangeStartToStuff"),self.listCriteria&&!$rootScope.$stateParams.searchStr)for(var k in self.listCriteria)null!==self.listCriteria[k]?self.query[k]=self.listCriteria[k]:delete self.query[k];return self.Items.getList(self.paginate,self.query).then(function(data){return $anchorScroll(),self.items=data,data.length&&(self.maxIndex=data[0].index,data.forEach(function(el,i){el.index>self.maxIndex&&(self.maxIndex=el.index)})),"stuffs.stuff"==self.$state.current.name&&self.paginate.page&&(console.log(":::::"),self.$state.go("stuffs",self.$stateParams)),self.items}).then(function(items){items&&items.length?$timeout(function(){$rootScope.$emit("$stateChangeEndToStuff")},100):(self.stateComplite=!0,$rootScope.$emit("$stateChangeEndToStuff"))}).catch(function(err){err=err.data||err,exception.catcher("получение списка")(err)})}function setRows(){return global.get("functions").val.setRows?global.get("functions").val.setRows():2}function filteringList(item){return!self.filterStr||item.name.toLowerCase().indexOf(self.filterStr.toLowerCase())!=-1||item.artikul.toLowerCase().indexOf(self.filterStr.toLowerCase())!=-1}function searchItem(artikul){if(artikul&&!(artikul.length<3)){artikul=artikul.substring(0,20),self.$state.current.reloadOnSearch=!0;var o={groupUrl:"group",categoryUrl:"category",searchStr:artikul.substring(0,20),queryTag:null,brand:null,brandTag:null,categoryList:null};self.$state.go(self.$state.current.name,o,{reload:!0})}}function saveField(item,field,defer){var o={_id:item._id};if(o[field]=item[field],"name"==field||"artikul"==field){var lang=global.get("store").val.lang,k=item.name;if(item.artikul&&(k+=" "+item.artikul),item.category&&item.category[0]&&global.get("categoriesO").val&&global.get("categoriesO").val[item.category[0]]&&global.get("categoriesO").val[item.category[0]].nameL&&(k+=" "+global.get("categoriesO").val[item.category[0]].nameL[lang]),item.brand&&global.get("brands").val){var id=item.brand._id?item.brand._id:item.brand,b=global.get("brands").val.getOFA("_id",id);if(k+=" "+(b.nameL&&b.nameL[lang]?b.nameL[lang]:b.name),item.brandTag){var bt=b.tags.getOFA("_id",item.brandTag);bt&&bt.nameL&&bt.nameL[lang]&&(k+=" "+bt.nameL[lang])}}item.keywords||(item.keywords={}),item.keywords[lang]=k,field+=" keywords."+lang,o["keywords."+lang]=k}return"archived"==field&&item[field]&&(field+=" actived",o.actived=!1,item.actived=!1),self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}function createItem(stuff,clone){stuff||(stuff={name:""},stuff.index=self.items&&self.items[0]&&self.items[0].index?self.items[0].index:0),$q.when().then(function(){return self.Items.cloneStuff(stuff,clone)}).then(function(stuff){self.newStuff=stuff}).then(function(){var url=self.newStuff.url;global.get("categoriesO").val[self.newStuff.category];self.$state.go("frame.stuffs.stuff",{groupUrl:self.$stateParams.groupUrl,categoryUrl:self.$stateParams.categoryUrl,stuffUrl:url})}).catch(function(err){err&&(err=err.data||err,exception.catcher("создание товара")(err),console.log(err))})}function filterList(){$q.when().then(function(){return self.Items.setFilters()}).catch(function(err){})}function getTagName(_id){if(_id&&self.filterTags&&"notag"!=_id&&self.filterTags.length)return self.filterTags.getOFA("_id",_id).name||null}function getFilterName(_id){if(_id&&self.filters){var filter=self.filters.getOFA("_id",_id);return filter?filter.name:""}}function deleteItem(stuff){var folder="images/"+global.get("store").val.subDomain+"/Stuff/"+stuff.url;Confirm("Удалить?").then(function(){return self.whileActions=!0,Stuff.delete({_id:stuff._id}).$promise}).then(function(){return self.getList(!0)}).then(function(){return self.whileActions=null,Photo.deleteFolder("Stuff",folder)}).catch(function(err){self.whileActions=null,(err=err&&err.data||err)&&exception.catcher("удаление товара")(err)})}function zoomImg(stuff){if(stuff.gallery&&stuff.gallery.length){var options={animation:!0,bindToController:!0,controllerAs:"$ctrl",templateUrl:"views/template/partials/stuffDetail/modal/zoom.html",controller:function($uibModalInstance,gallery,i){var self=this;self.gallery=gallery,self.idx=i,self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}},resolve:{gallery:function(){return stuff.gallery},i:function(){return 0}}};$uibModal.open(options)}}function markAllStuffs(m){self.items.forEach(function(el){el.select=m})}function selectCategory(){var acts=[];return $q.when().then(function(){return Category.select()}).then(function(item){return self.items.forEach(function(el){el.select&&("object"==typeof el.category?el.category[0]=item._id:el.category=[item._id],acts.push(saveField(el,"category")))}),$q.all(acts)}).then(function(){getList(0)})}function selectBrand(){return $q.when().then(function(){return Brands.select()}).then(function(item){var o={};o.brand=item._id,o.brandTag=null,massSaveField(o)})}function selectBrandTag(){return $q.when().then(function(){return BrandTags.select()}).then(function(item){var o={};o.brand=item.brand._id,o.brandTag=item._id,massSaveField(o)})}function selectFilterTag(){var acts=[];return $q.when().then(function(){return FilterTags.select()}).then(function(item){var tag=item._id;self.items.forEach(function(el){if(el.select){el.select=!1;el.tags.indexOf(tag)<0&&(el.tags.push(tag),acts.push(saveField(el,"tags")))}})}).then(function(){return $q.all(acts)})}function unSelectFilterTag(){var acts=[];return $q.when().then(function(){return FilterTags.select()}).then(function(item){var tag=item._id;self.items.forEach(function(el){if(el.select){el.select=!1;var k=el.tags.indexOf(tag);k>-1&&(el.tags.splice(k,1),acts.push(saveField(el,"tags")))}})}).then(function(){return $q.all(acts)})}function selectAddInfo(){return $q.when().then(function(){return AddInfo.select()}).then(function(item){massSaveField({addInfo:item._id})})}function selectActived(){var options={animation:!0,templateUrl:"components/stuff/modal/selectActivedModal.html",bindToController:!0,controller:selectActivedCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(actived){massSaveField({actived:actived}).then(function(){getList(0)})})}function selectActivedCtrl($uibModalInstance){var self=this;self.actived=!1,self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.actived)}}function selectPosition(){if(self.items.length){var options={animation:!0,templateUrl:"components/stuff/modal/selectPositionModal.html",bindToController:!0,controller:selectPositionCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(position){if("down"==position){var minIndex=Number(self.items[self.items.length-1].index)-1;self.items.forEach(function(el){if(el.select){var i=minIndex--;el.index=i,saveField(el,"index")}})}else if("up"==position){var minIndex=Number(self.items[0].index)+1;self.items.forEach(function(el){if(el.select){var i=minIndex++;el.index=i,saveField(el,"index")}})}self.items.sort(function(a,b){return b.index-a.index})})}}function selectPositionCtrl($uibModalInstance){var self=this;self.position="up",self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.position)}}function changeOrderType(){var options={animation:!0,templateUrl:"components/stuff/modal/orderTypeModal.html",bindToController:!0,controller:orderTypeCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(orderType){massSaveField({orderType:orderType})})}function orderTypeCtrl($uibModalInstance){var self=this;self.orderType=0,self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.orderType)}}function changeMinMax(){var options={animation:!0,templateUrl:"components/stuff/modal/changeMinMaxModal.html",bindToController:!0,controller:changeMinMaxCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(item){massSaveField(item)})}function changeMinMaxCtrl($uibModalInstance){var self=this;self.item={minQty:1,maxQty:1,single:!1,multiple:!1},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.item)}}function changePrice(){var options={animation:!0,templateUrl:"components/stuff/modal/changePriceModal.html",bindToController:!0,controller:changePriceCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(item){item.ids=self.items.filter(function(el){return el.select}).map(function(el){return el._id}),item.price=Number(item.value),delete item.value;try{if(item.price)if(item.sum)item.$inc=!0,item.price<0&&self.items.forEach(function(el){if(el.select&&el.price+item.price<0)throw el.name+" price below 0"});else{if(item.$mul=!0,item.price<-99)throw"percent value -99 - ~";item.price+=100,item.price>0&&(item.price=item.price/100)}return delete item.sum,self.Items.save({update:"price"},item).$promise.then(function(){global.set("saving",!0),getList(!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}catch(err){exception.catcher("error")(err)}})}function changePriceCtrl($uibModalInstance){var self=this;self.item={value:0,sum:!1},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){$uibModalInstance.close(self.item)}}function deleteStuffs(){Confirm("потверждаете?").then(function(){var ids=self.items.filter(function(el){return el.select}).map(function(el){return el._id}).join("_"),folders=self.items.filter(function(el){return el.select}).map(function(el){return"images/"+global.get("store").val.subDomain+"/Stuff/"+el.url});$q.when().then(function(){return self.Items.delete({ids:ids}).$promise.then(function(){global.set("saving",!0),getList(!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}).then(function(){Photo.deleteFolders("Stuff",folders)})})}function massSaveField(item){var fields=Object.keys(item).join(" ");return item.ids=self.items.filter(function(el){return el.select}).map(function(el){return el._id}),self.Items.save({update:fields},item).$promise.then(function(){global.set("saving",!0),(item.actived||item.category)&&getList(!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})}function changeAction(){Confirm("подтвердите действие").then(function(){if(self.action){var a=angular.copy(self.action);switch(self.action=null,self.mark=!1,a){case"category":return selectCategory();case"brand":return selectBrand();case"brandTag":return selectBrandTag();case"filterTag":return selectFilterTag();case"unfilterTag":return unSelectFilterTag();case"addInfo":return selectAddInfo();case"actived":return selectActived();case"index":return selectPosition();case"order":return changeOrderType();case"changePrice":return changePrice();case"changeMinMax":return changeMinMax();case"deleteStuffs":return deleteStuffs()}}})}function dropCallback(item){return item}function alignmentIndex(){Confirm("Подтверждаете?").then(function(){self.alignmentIndexDisable=!0;var data={};return $http({method:"post",url:"/api/alignmentIndex",data:data})}).then(function(){}).catch(function(err){console.log(err)})}function fixData(){Confirm("Подтверждаете?").then(function(){self.fixDesable=!0;var data={};return $http({method:"post",url:"/api/fixedDB/stuff",data:data})}).then(function(){self.fixDesable=!1,exception.showToaster("info","fix stucture","Ok")}).catch(function(err){exception.catcher("fix stucture")(err)})}function reNewKeyWords(){Confirm("Подтверждаете?").then(function(){self.reNewKeyWordsDisable=!0;var data={};return $http({method:"GET",url:"/api/reNewKeyWords",data:data})}).then(function(){self.reNewKeyWordsDisable=!1,exception.showToaster("info","reNewKeyWords","Ok")}).catch(function(err){exception.catcher("reNewKeyWords")(err)})}function changeRows(rows){if(self.paginate.rows!=rows){self.paginate.rows=rows,self.paginate.page=0,self.paginate.items=0;getList(!0)}}function clearSearch(){$location.search("searchStr",null)}function changeListCriteria(field,val){self.listCriteria&&(self.listCriteria.actived=null,self.listCriteria.archived=null),field&&(self.listCriteria[field]=val),"actived"!=field||val||(self.listCriteria.archived=!1),self.paginate.page=0,getList(!0)}function changeStock(stuff,tag){stuff.stock&&stuff.stock[tag._id]&&(stuff.stock[tag._id].quantity=tag.quantity,saveField(stuff,"stock"))}function deleteIndexPageHtml(){Confirm("перезаписать страницу?").then(function(){return $http.get("/api/deleteIndexPageHtml?catalog="+$rootScope.$stateParams.groupUrl+"_"+$rootScope.$stateParams.categoryUrl)}).then(function(res){exception.showToaster("info","все OK")}).catch(function(err){exception.catcher("сброс страницы")(err)})}anchorSmoothScroll.scrollTo("topPage"),$element.on("$destroy",function(){});var stamp=Date.now();console.log("stuffListCtrl from admin ",stamp);var self=this;self.Items=Stuff,self.mobile=global.get("mobile").val,self.global=global,self.globalProperty=$rootScope.globalProperty,self.$state=$rootScope.$state,self.$stateParams=$rootScope.$stateParams,self.query={},self.data={rows:2},self.itemsArr2=[[],[]],self.itemsArr3=[[],[],[]],self.itemsArr4=[[],[],[],[]],self.itemsArr5=[[],[],[],[],[]];self.paginate={page:0,rows:100,items:0},setTimeout(function(){$rootScope.displaySlideMenu=!0},400),self.newStuff={name:"",actived:!1},self.listOfActions={filterTag:"добавить характеристику",unfilterTag:"снять характеристику",addInfo:"таблица доп. параметров",category:"смена категории",brand:"смена бренда",order:"способ заказа",brandTag:"смена коллекции",changePrice:"смена цены",changeMinMax:"смена min max кол-ва для заказа",deleteStuffs:"удаление товаров",actived:"смена видимости",index:"смена позиции"},self.maxIndex=0,self.listCriteria={actived:!0},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.createItem=createItem,self.filterList=filterList,self.getTagName=getTagName,self.getFilterName=getFilterName,self.deleteItem=deleteItem,self.zoomImg=zoomImg,self.markAllStuffs=markAllStuffs,self.changeAction=changeAction,self.dropCallback=dropCallback,self.filteringList=filteringList,self.alignmentIndex=alignmentIndex,self.fixData=fixData,self.reNewKeyWords=reNewKeyWords,self.changeRows=changeRows,self.clearSearch=clearSearch,self.changeListCriteria=changeListCriteria,self.changeStock=changeStock,self.deleteIndexPageHtml=deleteIndexPageHtml,function(){global.get("tempContent")&&global.get("tempContent").val&&($("#tempContent").empty(),global.set("tempContent",null)),self.data.rows=setRows(),global.get("crawler")&&global.get("crawler").val&&"stuffs.stuff"==self.$state.current.name||$q.when().then(function(){return self.Items.getQueryFromUrl(self.campaignCondition)}).then(function(query){return self.query=query,getList()}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){self.filterTags=filterTags}).then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){$rootScope.reloadStuffId&&$timeout(function(){anchorSmoothScroll.scrollTo("stuff"+$rootScope.reloadStuffId,-150),$rootScope.reloadStuffId=null},1300)}).then(function(helper){helper&&(self.helper=helper,global.get("store").val.helper||(self.helper.popover=null))}).then(function(){seoContent.setDataCatalog()}).catch(function(err){console.log(err)})}(),$scope.$on("fromStuffToStuffs",function(){console.log("$rootScope.$on('fromStuffToStuffs'",stamp),getList(!0)}),$(window).resize(function(){$timeout(function(){self.data.rows=setRows()})}),selectActivedCtrl.$inject=["$uibModalInstance"],selectPositionCtrl.$inject=["$uibModalInstance"],orderTypeCtrl.$inject=["$uibModalInstance"],changeMinMaxCtrl.$inject=["$uibModalInstance"],changePriceCtrl.$inject=["$uibModalInstance"],console.log($rootScope.$stateParams)}function filtersWrapDirective(global){return{scope:{},restrict:"C",bindToController:!0,controller:filtersWrapCtrl,controllerAs:"$ctrl",templateUrl:function(){var s="";if(global.get("store").val){
var type=global.get("sectionType")&&global.get("sectionType").val?global.get("sectionType").val:"good",sec=global.get("store").val.template.stuffListType[type];if(sec.filters)for(var i=0;i<sec.parts.length;i++)if("filters"==sec.parts[i].name){sec.parts[i].templ&&(s=sec.parts[i].templ);break}}return"views/template/partials/stuffs/filters/filtersWrap"+s+".html"}}}function filtersWrapCtrl($element,$timeout,$q,$stateParams,Sections,$location,Filters,global,Brands,Stuff,$scope,$rootScope,$state){function changeTag(){var queryTag="",brandTag="",brand="",filterTag="";self.filters.forEach(function(filter){filter.count?filter.set&&(filterTag&&(filterTag+="__"),filterTag+=filter._id+"_"+filter.minValue+"_"+filter.maxValue):filter.tags.forEach(function(tag){tag.set&&(queryTag&&(queryTag+="__"),queryTag+=tag.url)})}),self.brands.forEach(function(b){b.set&&(brand&&(brand+="__"),brand+=b.url),b.tags.forEach(function(tag){tag.set&&(brandTag&&(brandTag+="__"),brandTag+=tag.url)})}),brand.split("__").length>1&&(brandTag=null),queryTag?$location.search("queryTag",queryTag):$location.search("queryTag",null),brandTag?$location.search("brandTag",brandTag):$location.search("brandTag",null),brand?$location.search("brand",brand):$location.search("brand",null),filterTag?$location.search("filterTag",filterTag):$location.search("filterTag",null);$stateParams.groupUrl,$stateParams.categoryUrl,self.brand}function clearAllBrands(){self.brands.forEach(function(b){b.set=!1,b.tags&&b.tags.length&&b.tags.forEach(function(t){t.set=!1})})}function changeAllBrands(){clearAllBrands(),changeTag()}function clearFilter(filter){filter.set=null,filter.tags&&filter.tags.length&&filter.tags.forEach(function(t){t.set=!1})}function changeAllTags(filter){clearFilter(filter),changeTag()}function clearAll(){clearAllBrands(),self.filters.forEach(function(filter){clearFilter(filter)}),changeTag()}function setCountFilter(filter){filter.set=!0,changeTag()}function clearCountFilter(filter){filter.set=null,changeTag()}function openFilterForBrands(){if(self.brands&&self.brands.length)return self.brands.some(function(b){return b.open})}function setCharForBrands(char){self.char=char}function filterBrands(item){return item.name.toUpperCase()[0]==self.char}var self=this;self.global=global,self.chars=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],self.char=self.chars[0],self.changeAllBrands=changeAllBrands,self.changeAllTags=changeAllTags,self.clearAll=clearAll,self.setCountFilter=setCountFilter,self.clearCountFilter=clearCountFilter,self.openFilterForBrands=openFilterForBrands,self.filterBrands=filterBrands,self.setCharForBrands=setCharForBrands,$rootScope.$on("changeCurrency",function(){console.log("changeCurrency",global.get("rate").val),self.filters.forEach(function(f){f.count&&f.price&&(console.log(f.mixSave,global.get("rate").val),f.min=Math.ceil10(f.mixSave*global.get("rate").val,0),console.log(f.min),f.max=Math.ceil10(f.maxSave*global.get("rate").val,0),f.maxValue=f.max,f.minValue=f.min,console.log(f))}),$timeout(function(){$scope.$broadcast("rzSliderForceRender")},500)}),function(){$q.when().then(function(){return Brands.getBrands()}).then(function(brands){self.brands=brands,self.checkedBrand=0,self.brands&&self.brands.forEach(function(b){b.set&&self.checkedBrand++})}).then(function(){return Filters.getFilters()}).then(function(filters){filters.forEach(function(f){f.count&&f.price&&(f.maxSave||(f.maxSave=f.max),f.mixSave||(f.mixSave=f.min),f.min=Math.ceil10(f.mixSave*global.get("rate").val,0),f.max=Math.ceil10(f.maxSave*global.get("rate").val,0))}),self.filters=filters})}(),self.changeTag=changeTag;$element.offsetParent(),$element.find("div")[0];$timeout(function(){function filtersForScroll(event){if(list&&"stuffs"==$state.current.name){var docViewTop=win.scrollTop(),docViewBottom=docViewTop+win.height(),elemTop=$(filtersBox).offset().top,elemBottom=elemTop+$(filtersBox).height(),elemWidth=$(filtersBox).width(),listTop=$(list).offset().top,listBottom=listTop+$(list).height(),st=$(this).scrollTop();st>lastScrollTop?function(){if(elemBottom)if("fixed"==$(filtersBox).css("position"))if($(filtersBox).css("top")==sdvig+"px")if(elemBottom<docViewBottom);else{var t=elemTop-$(filtersFirstBox).offset().top;$(filtersFirstBox).css("height",t+"px"),$(filtersBox).css("position","absolute"),$(filtersBox).css("top",t+"px"),$(filtersBox).css("bottom","auto")}else"0px"==$(filtersBox).css("bottom")&&listBottom<=elemBottom&&($(filtersFirstBox).css("height",$(list).height()),$(filtersBox).css("position","absolute"),$(filtersBox).css("bottom","0px"),$(filtersBox).css("top","auto"));else"absolute"==$(filtersBox).css("position")&&(docViewTop-sdvig>=elemTop&&elemBottom<docViewBottom&&$(filtersBox).height()<docViewBottom-docViewTop-sdvig?($(filtersBox).css("position","fixed"),$(filtersBox).css("bottom","auto"),$(filtersBox).css("top",sdvig+"px"),$(filtersBox).css("width",elemWidth+"px")):elemBottom<=docViewBottom&&elemBottom<listBottom&&!($(filtersBox).height()<docViewBottom-docViewTop-sdvig)&&($(filtersBox).css("position","fixed"),$(filtersBox).css("bottom","0px"),$(filtersBox).css("top","auto"),$(filtersBox).css("width",elemWidth+"px")))}():function(){elemBottom&&("fixed"==$(filtersBox).css("position")?"0px"==$(filtersBox).css("bottom")?($(filtersFirstBox).css("height",docViewBottom-$(filtersFirstBox).offset().top),$(filtersBox).css("position","absolute"),$(filtersBox).css("bottom","0px"),$(filtersBox).css("top","auto"),$(filtersBox).css("width",elemWidth+"px"),$(filtersFirstBox).height()<$(filtersBox).height()&&$(filtersFirstBox).height($(filtersBox).height())):$(filtersBox).css("top")==sdvig+"px"?docViewTop+sdvig<=listTop&&($(filtersBox).css("position","absolute"),$(filtersBox).css("bottom","auto"),$(filtersBox).css("top","0px"),$(filtersBox).css("width",elemWidth+"px")):console.log("?????????????"):"absolute"==$(filtersBox).css("position")&&elemTop>docViewTop+sdvig&&elemTop>listTop&&($(filtersBox).css("position","fixed"),$(filtersBox).css("top",sdvig+"px"),$(filtersBox).css("bottom","auto"),$(filtersBox).css("width",elemWidth+"px")))}(),lastScrollTop=st}}var w=$element.parent().width(),list=(Math.round(w/5),$element.parent().children()[1]),nav=$(".navbar-fixed-top"),sdvig=0;nav.each(function(i,n){sdvig+=$(n).outerHeight()});var filtersFirstBox=$element.find(".filters-first-box")[0],filtersBox=$element.find(".filter-box")[0],win=$(window);win.scroll(filtersForScroll);var lastScrollTop=0;$(filtersFirstBox).height($(filtersBox).height()),$scope.$watch(function(){return $(filtersBox).height()},function(n,o){$(filtersFirstBox).height(n+"px")}),$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){"stuffs"==to.name&&filtersForScroll()}),$scope.$on("$destroy",function(){angular.element(window).off("scroll",filtersForScroll)})},150)}angular.module("gmall.controllers").controller("stuffListFromServerCtrl",stuffListFromServerCtrl),angular.module("gmall.services").directive("stuffList",stuffListDirective).directive("stuffListTemplate",stuffListTemplateDirective).directive("stuffListTemplateList",stuffListTemplateDirectiveList).directive("stuffListTemplateServer",stuffListTemplateServer).directive("stuffListTemplateCampaignList",stuffListTemplateDirectiveCampaignList).directive("emptyList",emptyList).directive("stuffInList",stuffInList).directive("homePageStuffOwl",function(){return{scope:{homePageStuffOwl:"@",zoomImg:"@",stuffs:"@",items:"@",autoplay:"@",duration:"@",gallery:"="},bindToController:!0,controllerAs:"$ctrl",controller:homePageStuffOwlCtrl}}).directive("homePageHtml",function(){return{restrict:"C",scope:!0,bindToController:!0,controllerAs:"$ctrl",controller:homePageHtmlCtrl}}).directive("likesItem",likesItem),likesItemCtrl.$inject=["$compile","$timeout","localStorage","Stuff","global"],homePageHtmlCtrl.$inject=["$scope","$rootScope","$timeout","$element","$compile","global","$q","$http"],homePageStuffOwlCtrl.$inject=["$scope","$timeout","$element","$compile","global"],stuffListFromServerCtrl.$inject=["$scope","$state","$compile","$element","$window","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","Helper","anchorSmoothScroll","Photo","$timeout","$anchorScroll","Category","Brands","BrandTags","seoContent","AddInfo","$http","$location","$sce"],campaignStuffListCtrl.$inject=["$scope","$state","$compile","$element","$window","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","Helper","anchorSmoothScroll","Photo","$timeout","$anchorScroll","Category","Brands","BrandTags","seoContent","AddInfo","$http","$location","localStorage"],stuffListCtrl.$inject=["$scope","Stuff","$rootScope","$q","$uibModal","global","exception","FilterTags","Filters","Confirm","Helper","anchorSmoothScroll","Photo","$timeout","$anchorScroll","Category","Brands","BrandTags","seoContent","AddInfo","$http","$location","$element"],angular.module("gmall.directives").directive("filtersWrap",filtersWrapDirective),filtersWrapCtrl.$inject=["$element","$timeout","$q","$stateParams","Sections","$location","Filters","global","Brands","Stuff","$scope","$rootScope","$state"]}(),angular.module("gmall.directives").directive("driveSale",driveSaleDirective).directive("driveRetail",driveRetailDirective).directive("stuffEdit",["$anchorScroll","global","Stuff","$stateParams","$window","$q","$http","Category","Filters","Brands","$uibModal","$document","$location","AddInfo","Comments","exception","Photo","$timeout","$rootScope","Confirm","SetCSS","Blocks",function($anchorScroll,global,Stuff,$stateParams,$window,$q,$http,Category,Filters,Brands,$uibModal,$document,$location,AddInfo,Comments,exception,Photo,$timeout,$rootScope,Confirm,SetCSS,Blocks){return{restrict:"E",scope:{},templateUrl:"components/stuff/stuffEdit.html",link:function($scope,element,attrs){function saveFieldBlocks(field,value,defer,indexImgs){console.log(field,value),defer=defer?defer:100,setTimeout(function(){var o={_id:$scope.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),$scope.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){field.indexOf("desc1")>-1&&(o[field+"L"]={},$scope.Items.save({update:field+"L"},o,function(){o[field]=value,$scope.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}))})},defer)}function refreshBlocks(){return Stuff.getItem($stateParams.stuffUrl).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),$scope.item.blocks=data.blocks})}function addBlock(type){if(type){return $scope.$broadcast("addNewBlock",{type:type}),void($scope.$ctrl.newBlock=null)}}function deleteBlock(block){console.log(block);var o={_id:$scope.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("удалить?").then(function(){return $scope.Items.save(update,o).$promise}).then(function(res){$scope.item.blocks.splice(block.i,1),$scope.item.blocks.forEach(function(b,i){b.i=i});var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stuff",images)})}function getAddInfos(){return $q(function(resolve,reject){var query=$scope.item.category[0].filters.map(function(filter){return filter._id});query={filter:{$in:query}},AddInfo.query({query:query},function(res){res.shift(),$scope.item.addInfos=res,resolve()},function(err){reject(err)})})}function _setTagsValue(){if(this.category){!this.category[0]||this.category[0].filters&&this.category[0].filters.length||(this.category[0].filters=$scope.filters);var tags=this.tags;this.category[0].filters.length&&this.category[0].filters.forEach(function(filter){filter.tags.forEach(function(tag){tags.indexOf(tag._id)>-1?tag.set=!0:tag.set=!1})})}}function activate(){$q.when().then(function(){return Filters.getFilters()}).then(function(filters){$scope.filters=filters}).then(function(){return Stuff.getItem($stateParams.stuffUrl)}).then(function(item){item.addInfo&&item.addInfo._id&&(item.addInfo=item.addInfo._id),item.blocks||(item.blocks=[],saveField(item,"blocks")),item.blocks.forEach(function(b,i){b.i=i}),item.timePart||(item.timePart=0),$scope.slider.value=item.timePart/$scope.deltaTimePart;for(var key in item)item.hasOwnProperty(key)&&($scope.item[key]=item[key]);$scope.item.setTagsValue=_setTagsValue,$scope.$ctrl.checked=99999==item.index,$scope.$ctrl.getComments(),$scope.$ctrl.item=$scope.item}).then(function(){if($scope.item.category){"object"!=typeof $scope.item.category&&($scope.item.category=[$scope.item.category]);var q=$q.defer();return Category.get({_id:$scope.item.category[0]},function(res){$scope.item.category[0]=res,$scope.item.setTagsValue(),q.resolve()},function(err){q.reject(err)}),q.promise}}).then(function(){$timeout(function(){$scope.item.ready=!0},2e3),$rootScope.$emit("$stateChangeEndToStuff");var q=$q.defer();return $scope.item.brand?Brands.get({id:$scope.item.brand},function(res){$scope.item.brand=res,q.resolve()},function(err){q.reject(err)}):q.resolve(),q.promise}).then(function(){$scope.item.sortsOfStuff&&($scope.item.sortsOfStuff.filter&&($scope.item.sortsOfStuff.filter=angular.copy($scope.item.category[0].filters.getOFA("_id",$scope.item.sortsOfStuff.filter))),$scope.item.sortsOfStuff.filterGroup&&($scope.item.sortsOfStuff.filterGroup=angular.copy($scope.item.category[0].filters.getOFA("_id",$scope.item.sortsOfStuff.filterGroup))),$scope.item.sortsOfStuff.stuffs&&$scope.item.sortsOfStuff.stuffs.length&&$scope.item.sortsOfStuff.stuffs.forEach(function(stuff){if(stuff.stock&&"object"==typeof stuff.stock)for(var k21 in stuff.stock)stuff.stock[k21].quantity=Number(stuff.stock[k21].quantity)}))}).then(function(){return $anchorScroll(),getAddInfos()}).catch(function(err){console.log(err)})}function calculatePriceSale(price){return Math.ceil10(Number(price)-global.get("store").val.seller.sale/100*price,-2)}function calculatePriceRetail(price){return Math.ceil10(Number(price)+global.get("store").val.seller.retail/100*price,-2)}function saveField(stuff,field){if("name"==field||"artikul"==field||"category"==field||"brand"==field||"brandTag"==field){var lang=global.get("store").val.lang,k=$scope.item.name;if($scope.item.artikul&&(k+=" "+$scope.item.artikul),$scope.item.category&&$scope.item.category[0]&&$scope.item.category[0].nameL&&$scope.item.category[0].nameL[lang]&&(k+=" "+$scope.item.category[0].nameL[lang]),$scope.item.brand&&$scope.item.brand.nameL&&$scope.item.brand.nameL[lang]&&(k+=" "+$scope.item.brand.nameL[lang],$scope.item.brandTag)){var bt=$scope.item.brand.tags.getOFA("_id",$scope.item.brandTag);bt&&bt.nameL&&bt.nameL[lang]&&(k+=" "+bt.nameL[lang])}$scope.item.keywords||($scope.item.keywords={}),$scope.item.keywords[lang]=k,field+=" keywords."+lang}if("price"!=field&&"name"!=field&&"artikul"!=field&&"actived"!=field&&"category"!=field&&"index"!=field||(reload=!0),"price"===field||"driveSalePrice"===field||"driveRetailPrice"===field){for(var key in stuff.stock)stuff.stock[key].price=stuff.price;stuff.setPrice(),field+=" stock"}if("stock"===field)if(stuff.sortsOfStuff&&stuff.sortsOfStuff.differentPrice&&stuff.store)for(var key in stuff.stock)key!=stuff.sort||stuff.stock[key].quantity||(stuff.sort=null,field+=" sort"),stuff.stock[key].priceSale=calculatePriceSale(stuff.stock[key].price),stuff.stock[key].retail=calculatePriceRetail(stuff.stock[key].price);else for(var key in stuff.stock)key!=stuff.sort||stuff.stock[key].quantity||(stuff.sort=null,field+=" sort");if("stock"===field||"price"===field){stuff.priceForFilter=[];for(var key in stuff.stock)if(stuff.stock[key].quantity){var c=stuff.currency?stuff.currency:global.get("store").val.mainCurrency,price=c==global.get("store").val.mainCurrency?stuff.stock[key].price:Math.ceil10(stuff.stock[key].price/global.get("store").val.currency[c][0],-2);stuff.priceForFilter.push(price)}field+=" priceForFilter"}var o={_id:stuff._id};field.split(" ").forEach(function(el){if(el.indexOf(".")>-1){var ks=el.split(".");if(ks.length){for(var d=$scope.item,i=0;i<ks.length;i++)d[ks[i]]&&(d=d[ks[i]]);d&&!d._id&&(o[el]=d)}}else o[el]=stuff[el]}),"archived"==field&&(stuff.archived?o.archivedDate=Date.now():o.archivedDate=null,field+=" archivedDate"),Stuff.Items.save({update:field},o,function(res){$scope.growlNotification="сохранено",global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function deleteSlideStuff(image,index){Photo.deleteFiles("Stuff",[image.img]).then(function(response){$scope.item.imgs.splice(index,1),$scope.saveField($scope.item,"imgs")},function(err){console.log(err)})}function editSlideStuff(slide,index){$uibModal.open({animation:!0,templateUrl:"components/stuff/modal/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",resolve:{slide:function(){return slide}}}).result.then(function(slide){console.log(slide),$scope.saveField($scope.item,"imgs")},function(){})}function changeStock(stuff,tag){stuff.stock&&stuff.stock[tag._id]&&(stuff.stock[tag._id].quantity=tag.quantity,saveField(stuff,"stock"))}$scope.$ctrl={},$scope.$ctrl.lang=global.get("store").val.lang,$scope.$ctrl.deleteSlideStuff=deleteSlideStuff,$scope.$ctrl.editSlideStuff=editSlideStuff,$scope.Items=Stuff.Items,$scope.$ctrl.Items=Stuff.Items,$scope.global=global,$scope.$stateParams=$stateParams,$scope.item={name:"name",artikul:"",index:0,price:0,minQty:0,maxQty:0},$scope.unitOfMeasure=global.get("store").val.unitOfMeasure,$scope.$ctrl.listOfBlocksForStuffDetailBlocks=listOfBlocksForStuffDetailBlocks,$scope.$ctrl.listOfBlocks=angular.copy(listOfBlocksForAll),$scope.$ctrl.addBlock=addBlock,$scope.$ctrl.deleteBlock=deleteBlock,$scope.$ctrl.saveField=saveFieldBlocks,$scope.$ctrl.type="Stuff",$scope.$ctrl.changeStock=changeStock,$scope.$ctrl.refreshBlocks=refreshBlocks,$scope.$ctrl.animationTypes=animationTypes,$scope.$ctrl.tinymceOption={plugins:"code print preview fullpage searchreplace autolink directionality  visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists textcolor wordcount  imagetools  contextmenu colorpicker textpattern help",toolbar:"code | formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat | code "};var reload=!1;switch($stateParams.block?$scope.block=$stateParams.block:$scope.block="mainInfo",$scope.cnahgeBlock=function(block){$scope.block=block,$location.search("block",block)},$scope.textAngularToolBar="[['h1','h2','h3'],['bold','italics']]",self.minDurationForService=global.get("store").val.seller.minDurationForService||15,$scope.deltaTimePart=1,self.minDurationForService){case 30:$scope.deltaTimePart=2;break;case 60:$scope.deltaTimePart=4;break;case 90:$scope.deltaTimePart=6;break;case 120:$scope.deltaTimePart=8;break;default:$scope.deltaTimePart=1}$scope.slider={value:0,options:{ceil:12,floor:0,showSelectionBar:!0,showTicks:!0,getTickColor:function(value){return value<3?"red":value<6?"orange":value<9?"yellow":"#2AE02A"},onChange:function(){$scope.item.timePart=$scope.slider.value*$scope.deltaTimePart,saveField($scope.item,"timePart")}}},$scope.$on("changeLang",function(){activate()}),$scope.$ctrl.paginate1={rows:5,page:0,items:0},activate(),$scope.saveField=saveField,$scope.selectCategory=function(){$q.when().then(function(){return Category.select()}).then(function(selectedCategory){(!$scope.item.category||$scope.item.category[0]&&selectedCategory._id!=$scope.item.category[0]._id)&&Category.get({_id:selectedCategory._id},function(res){if($scope.item.category=[res],res.mp&&"object"==typeof res.mp)for(var key in res.mp)$scope.item.category.push(res.mp[key]);console.log($scope.item.category),$scope.item.setTagsValue();var brandsArr=$scope.item.category[0].brands.map(function(el){return el._id}),tagsArr=$scope.item.category[0].filters.reduce(function(tags,el){return el.tags.forEach(function(t){tags.push(t._id)}),tags},[]),link="/"+selectedCategory.linkData.groupUrl+"/"+selectedCategory.linkData.categoryUrl+"/"+$scope.item.url,o={_id:$scope.item._id,category:$scope.item.category.map(function(c){return c._id||c}),link:link},field="category link";$scope.item.brand&&$scope.item.brand._id&&brandsArr.indexOf($scope.item.brand._id)<0&&($scope.item.brand=null,$scope.item.brandTag=null,field+=" brand brandTag",o.brnad=null,o.brandTag=null);for(var oldLength=$scope.item.tags.length,i=0;i<$scope.item.tags.length;i++)tagsArr.indexOf($scope.item.tags[i])<0&&(console.log($scope.item.tags[i]),$scope.item.tags.splice(i,1),i--);oldLength!=$scope.item.tags.length&&(field+=" tags",o.tags=$scope.item.tags),$scope.saveField(o,field)})})};var editBody=$document.find("#filterBlock").eq(0);$scope.selectFilter=function(filter,tags){$uibModal.open({animation:!0,templateUrl:"components/selectCategoryModal/selectFilterModal.html",controller:"selectFilterModalCtrl",size:"sm",appendTo:editBody,resolve:{filter:function(){return filter},tags:function(){return tags}}}).result.then(function(selectedTags){},function(){$scope.item.tags=[],$scope.item.category[0].filters.length&&$scope.item.category[0].filters.forEach(function(filter){filter.tags.forEach(function(tag){tag.set&&$scope.item.tags.push(tag._id)})}),$scope.saveField($scope.item,"tags")})},$scope.selectBrand=function(){$uibModal.open({animation:!0,templateUrl:"components/selectCategoryModal/selectBrandModal.html",controller:function($scope,$uibModalInstance,brandItem,brands){$scope.brandItem=brandItem,$scope.brands=brands,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.ok=function(brandItem){$uibModalInstance.close(brandItem)}},size:"sm",resolve:{brandItem:function(){return $scope.item.brand&&$scope.item.brand._id?$scope.item.brand._id:null},brands:function(){return $scope.item.category[0]&&$scope.item.category[0].brands?$scope.item.category[0].brands:[]}}}).result.then(function(selectedBrand){(!$scope.item.brand||$scope.item.brand&&selectedBrand!=$scope.item.brand._id)&&($scope.item.brandTag=null,selectedBrand?Brands.get({id:selectedBrand},function(res){$scope.item.brand=res}):$scope.item.brand=selectedBrand,$scope.saveField({_id:$scope.item._id,brand:selectedBrand,brandTag:$scope.item.brandTag},"brand brandTag"))},function(){})},$scope.selectBrandTag=function(){$uibModal.open({animation:!0,templateUrl:"components/selectCategoryModal/selectBrandTagModal.html",controller:"selectBrandTagModalCtrl",size:"sm",resolve:{brandTag:function(){return $scope.item.brandTag||null},brandTags:function(){return $scope.item.brand.tags||null}}}).result.then(function(selectedBrandTag){selectedBrandTag!=$scope.item.brandTag&&($scope.item.brandTag=selectedBrandTag,$scope.saveField({_id:$scope.item._id,brandTag:$scope.item.brandTag},"brandTag"))},function(){})},$scope.setAddInfos=function(filter,currentAddInfo){$q.when().then(function(){return AddInfo.editTable(filter)}).then(function(){getAddInfos()}).catch(function(){getAddInfos()})},$scope.backState=function(){reload&&($rootScope.reloadStuffId=$scope.item._id),$rootScope.$state.go("frame.stuffs",$rootScope.$stateParams,{reload:reload})},$scope.getUrlParams=function(stuff){return $scope.stuff.getUrlParams.call(stuff)},$scope.movedImage=function(){$timeout(function(){$scope.item.gallery.forEach(function(el,i){el.index=i}),$scope.Items.save({update:"gallery"},{_id:$scope.item._id,gallery:$scope.item.gallery})},100)},$scope.deleteImage=function(images,index){var files=[];images&&(images.img&&files.push(images.img),images.thumb&&files.push(images.thumb),images.thumbSmall&&files.push(images.thumbSmall));$scope.item._id;$q.when().then(function(){return Photo.deleteFiles("Stuff",files)}).then(function(){$scope.item.gallery.splice(index,1),$scope.Items.save({update:"gallery"},{_id:$scope.item._id,gallery:$scope.item.gallery})}).catch(function(err){err=err.data||err,exception.catcher("удаление файла")(err)})},$scope.$ctrl.moment=moment,$scope.$ctrl.createNewComment=function(){$q.when().then(function(){return Comments.create()}).then(function(res){var newComment={text:res,stuff:$scope.item._id,user:global.get("user").val._id};return Comments.save(newComment).$promise}).then(function(){return $scope.$ctrl.getComments(0)}).catch(function(err){err=err.data||err,exception.catcher("создание комментария")(err)})},$scope.$ctrl.getComments=function(page){0===page&&($scope.$ctrl.paginate1.page=page);var query={stuff:$scope.item._id};return Comments.getList($scope.$ctrl.paginate1,query).then(function(data){return $scope.$ctrl.comments=data,$scope.$ctrl.comments}).catch(function(err){err=err.data||err,exception.catcher("получение списка")(err)})},$scope.$ctrl.deleteComment=function(id){$q.when().then(function(){return Comments.delete({_id:id}).$promise}).then(function(){return $scope.$ctrl.getComments(0)}).catch(function(err){err=err.data||err,exception.catcher("удаление комментария")(err)})},$scope.$ctrl.saveCommentField=function(item,field){$q.when().then(function(){var o={_id:item._id};return o[field]=item[field],Comments.save({update:field},o).$promise}).catch(function(err){err=err.data||err,exception.catcher("схранение комментария")(err)})},$scope.$ctrl.setBigIndex=function(checked){$scope.item.index=checked?99999:1,$scope.saveField($scope.item,"index")}}}}]),driveSaleCtrl.$inject=["$scope","$element","$uibModal"],driveRetailCtrl.$inject=["$scope","$element","$uibModal"],editPriceSettingModalCtrl.$inject=["data","field","$uibModalInstance"],angular.module("gmall.directives").directive("stuffsAdminListWithPaginate",["$rootScope","Stuff","$timeout","$q","Sections","createStuffService","queryFromUrlService","filterStuffsListService","FilterTags","Filters",function($rootScope,Stuff,$timeout,$q,Sections,createStuffService,queryFromUrlService,filterStuffsListService,FilterTags,Filters){return{restrict:"E",scope:{query:"=",rate:"=",mobile:"@"},templateUrl:"components/stuff/stuffsAdminListWithPaginate.html",link:function($scope,element,attrs,ctrl){function prepareQueryForRequest(queryStart){var query=[];for(var key in queryStart)if(queryStart[key])if("tags"==key){var qu=[];for(var key2 in queryStart[key]){var obj=queryStart[key][key2],q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=queryStart[key],query.push(obj)}return query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):{}}var $state=$rootScope.$state;$rootScope.$stateParams;$scope.global=$rootScope.global,setTimeout(function(){$rootScope.displaySlideMenu=!0},400);var query,queryForFilter;$scope.paginate={page:0,rows:20,totalItems:0},$scope.newStuff={name:"",actived:!1},$scope.saveStuff=function(stuff,field){var f=field.split(" "),o={_id:stuff._id};f.forEach(function(el){o[el]=stuff[el]}),Stuff.Items.save({update:field},o,function(res){console.log(res),"index"==f[0]&&$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")})},$scope.getList=function(page,rows,reload){return $scope.paginate.page!=page&&($scope.paginate.page=page),$q(function(resolve,reject){var queryString;queryString=reload?query:$scope.query,Stuff.getList(queryString,null,page,rows,$scope.paginate).then(function(res){if($scope.items=res,$scope.newStuff.index=$scope.items&&$scope.items[0]?$scope.items[0].index:1,!reload){try{query=JSON.parse($scope.query)}catch(err){query={}}$scope.query=null}resolve()},function(err){reject(err)})})};$scope.getUrlParams=Stuff.getUrlParams,$scope.getCategoryName=Stuff.getCategoryName,$scope.getBrandName=Stuff.getBrandName,$scope.reloadList=function(){$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")},$scope.searchStuff=function(artikul){if(artikul&&!(artikul.length<3)){artikul=artikul.substring(0,20),$state.current.reloadOnSearch=!0;var o={groupUrl:"group",categoryUrl:"category",searchStr:artikul.substring(0,20),queryTag:null,brand:null,brandTag:null,categoryList:null};$state.go($state.current.name,o,{reload:!0})}},$scope.filterList=function(){$q.when().then(function(){return filterStuffsListService.setFilters(queryForFilter)}).then(function(query){return queryForFilter=query,$scope.query=prepareQueryForRequest(query),$scope.getList($scope.paginate.page,$scope.paginate.rows)}).then(function(){}).catch(function(err){console.log(err)})},$scope.cloneStuff=function(stuff){var newStuff=angular.copy(stuff);$q.when().then(function(){return createStuffService.cloneStuff(newStuff,!0)}).then(function(stuff){return console.log($scope.newStuff==stuff),$scope.newStuff=stuff,$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")}).then(function(){var url=newStuff.url;$state.go("frame.stuffs.stuff",{groupUrl:"group",categoryUrl:"category",stuffUrl:url})}).catch(function(err){console.log(err)})},$scope.createNewStuff=function(){$q.when().then(function(){return createStuffService.cloneStuff($scope.newStuff)}).then(function(stuff){return console.log($scope.newStuff==stuff),$scope.newStuff=stuff,$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")}).then(function(){var url=$scope.newStuff.url;$scope.newStuff={name:"",actived:!1},$state.go("frame.stuffs.stuff",{groupUrl:"group",categoryUrl:"category",stuffUrl:url})}).catch(function(err){console.log(err)})},$scope.deleteStuff=function(stuff){confirm("удалить???")&&Stuff.Items.delete({_id:stuff._id},function(res){$scope.getList($scope.paginate.page,$scope.paginate.rows,"reload")})},$q.when().then(function(){return queryFromUrlService.get()}).then(function(query){return queryForFilter=query,$scope.query=prepareQueryForRequest(query),$scope.getList($scope.paginate.page,$scope.paginate.rows)}).then(function(){return FilterTags.getFilterTags()}).then(function(filterTags){$scope.filterTags=filterTags}).then(function(){return Filters.getFilters()}).then(function(filters){$scope.filters=filters}).catch(function(err){console.log(err)}),$scope.getTagName=function(_id){if(_id)return $scope.filterTags.getOFA("_id",_id).name||null},$scope.getFilterName=function(_id){return $scope.filters.getOFA("_id",_id).name||null},$scope.changeSortOfStuff=function(stuff){var sort=stuff.stock[stuff.sort];stuff.price=sort.price,stuff.priceSale=sort.priceSale,stuff.retail=sort.retail},$scope.filterSorts=function(sort){return sort.value.quantity},$scope.onSelected=function(){setTimeout(function(){$(":focus").blur()})}}}}]),angular.module("gmall.directives").directive("filterForStuffs",["$rootScope","global","$q","$location","$section","Collection","Sections","Filter","FilterTags","Brands","Category",function($rootScope,global,$q,$location,$section,Collection,Sections,Filter,FilterTags,Brands,Category){return{scope:{query:"=",section:"=",admin:"@"},restrict:"E",templateUrl:"components/stuff/filterForStuffs.html",link:function($scope,element,attrs){function getTagFromCategoriesList(tag,field){var category=$scope.filterDirective.category;if(category&&category.filters&&category.filters.length)for(var ii=0,ll=category.filters.length;ii<ll;ii++){var filter=category.filters[ii];if(filter&&filter.tags&&filter.tags.length)for(var iii=0,lll=filter.tags.length;iii<lll;iii++)if(filter.tags[iii][field]==tag)return filter.tags[iii]}}
function _setBrand(brandId,filed){brandId&&$scope.filterDirective.brands?($scope.filterDirective.brand=$scope.filterDirective.brands.getObjectFromArray(filed,brandId),$scope.filterDirective.brand?($scope.filterDirective.query.brand=$scope.filterDirective.brand._id,$location.search("brand",$scope.filterDirective.brand.url),$scope.filterDirective.brandCollections=$scope.filterDirective.brand.tags):($scope.filterDirective.brandCollections=[],$location.search("brand",null))):($scope.filterDirective.brandCollections=[],$location.search("brand",null))}function _setBrandTag(brandTagId,filed){if(brandTagId&&$scope.filterDirective.brandCollections){var brandTag=$scope.filterDirective.brandCollections.getObjectFromArray(filed,brandTagId);brandTag?($scope.filterDirective.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}else $location.search("brandTag",null)}function _setFilterTagsUrl(){if($scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length){var queryTag=$scope.filterDirective.filterTags.map(function(tag){return tag.url}).join("+");$location.search("queryTag",queryTag||null)}else $location.search("queryTag",null)}function _getQueryTag(){var arr=[];return $scope.filterDirective.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr}console.log("??????????????");var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.filterDirective={},$scope.filterDirective.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$q.when().then(function(){return Sections.getSections()}).then(function(sections){var q=$q.defer();return"brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl?($stateParams.parentGroup?$scope.parentSection=Sections.getParentSection($stateParams.parentGroup):$scope.parentSection=Sections.getParentSection($stateParams.groupUrl),"allCategories"==$stateParams.categoryList||"category"!=$stateParams.categoryUrl?($scope.filterDirective.categories=$scope.parentSection.categories,$scope.filterDirective.sectionCategories=$scope.filterDirective.categories.map(function(el){return el._id}),"category"!=$stateParams.categoryUrl?Category.get({id:$stateParams.categoryUrl},function(res){$scope.filterDirective.query.category=res._id,$scope.filterDirective.category=res,$scope.filterDirective.category.brands&&$scope.filterDirective.category.brands.length&&($scope.filterDirective.brands=$scope.filterDirective.category.brands),q.resolve()}):q.resolve()):($scope.filterDirective.sectionCategories=Sections.getEmbededCategories($scope.parentSection,[]).map(function(el){return el._id}),$scope.filterDirective.sectionCategories.length||($scope.filterDirective.sectionCategories=[null]),q.resolve())):q.resolve(),q.promise}).then(function(){console.log($scope.filterDirective.brands);var q=$q.defer();return $stateParams.brand&&!$scope.filterDirective.brands?Brands.query(function(res){res.shift(),$scope.filterDirective.brands=res,q.resolve()}):q.resolve(),q.promise}).then(function(){_setBrand($stateParams.brand,"url"),_setBrandTag($stateParams.brandTag,"url")}).then(function(){var q=$q.defer();if($stateParams.queryTag){var queryTags=$stateParams.queryTag.split("+");queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),$scope.filterDirective.categories?($scope.filterDirective.filterTags=queryTags.map(function(tag){return getTagFromCategoriesList(tag,"url")}).filter(function(tag){return tag}),q.resolve()):FilterTags.getTagsByUrl(queryTags,function(res){$scope.filterDirective.filterTags=res,q.resolve()})}else q.resolve();return q.promise}).then(function(){_setFilterTagsUrl()}).then(function(){$scope.filterDirective.query.category&&$scope.filterDirective.category?$scope.filterDirective.category.filters&&$scope.filterDirective.category.filters.length&&($scope.filterDirective.category.filters.forEach(function(item,i){$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&$scope.filterDirective.filterTags.forEach(function(tag){tag.filter==item._id&&($scope.filterDirective.query.tags[i]||($scope.filterDirective.query.tags[i]=[]),$scope.filterDirective.query.tags[i].push(tag._id))})}),$scope.filterDirective.filters=$scope.filterDirective.category.filters):$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&($scope.filterDirective.query.tags[0]=[],$scope.filterDirective.filterTags.forEach(function(tag){$scope.filterDirective.query.tags[0].push(tag._id)}))}).then(function(){$scope.filterDirective.getQuery()}).catch(function(err){console.log(err)}),$scope.filterDirective.getQuery=function(){var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});for(var key in $scope.filterDirective.query)if($scope.filterDirective.query[key])if("tags"==key){var qu=[];$scope.filterDirective.query[key].filter(function(){return!0});$scope.filterDirective.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.filterDirective.query[key],query.push(obj)}else if("category"==key&&$scope.filterDirective.sectionCategories&&$scope.filterDirective.sectionCategories.length){var obj={};obj.category={$in:$scope.filterDirective.sectionCategories},query.push(obj)}return query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):{},void($scope.query=query)},$scope.filterDirective.changeFilter=function(reloadController){if(reloadController){if($scope.filterDirective.category&&$scope.filterDirective.query.category==$scope.filterDirective.category._id)return;if($scope.filterDirective.query.category){var categoryUrl=$scope.filterDirective.categories.getObjectFromArray("_id",$scope.filterDirective.query.category);categoryUrl=categoryUrl?categoryUrl.url:"category",$location.search("categoryList",null)}else{var categoryUrl="category";$location.search("categoryList","allCategories")}$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:categoryUrl,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else $scope.filterDirective.query.artikul="",_setBrand($scope.filterDirective.query.brand,"_id"),_setBrandTag($scope.filterDirective.query.brandTag,"_id"),$scope.filterDirective.filterTags=_getQueryTag().map(function(tag){return getTagFromCategoriesList(tag,"_id")}).filter(function(tag){return tag}),_setFilterTagsUrl(),$scope.filterDirective.getQuery()},$scope.filterDirective.clearFilter=function(){console.log("clear filetrs"),$scope.filterDirective.query.tags=[],$scope.filterDirective.changeFilter()}}}}]).directive("filterForStuffsClinic",["$rootScope","global","$q","$location","$section","Collection","Sections","Filter","FilterTags","Brands","Category",function($rootScope,global,$q,$location,$section,Collection,Sections,Filter,FilterTags,Brands,Category){return{scope:{query:"=",section:"=",admin:"@"},restrict:"E",templateUrl:"views/clinic/partials/stuff/filterForStuffs.html",link:function($scope,element,attrs){function getTagFromCategoriesList(tag,field){var category=$scope.filterDirective.category;if(category&&category.filters&&category.filters.length)for(var ii=0,ll=category.filters.length;ii<ll;ii++){var filter=category.filters[ii];if(filter&&filter.tags&&filter.tags.length)for(var iii=0,lll=filter.tags.length;iii<lll;iii++)if(filter.tags[iii][field]==tag)return filter.tags[iii]}}function _setBrand(brandId,filed){brandId&&$scope.filterDirective.brands?($scope.filterDirective.brand=$scope.filterDirective.brands.getObjectFromArray(filed,brandId),$scope.filterDirective.brand?($scope.filterDirective.query.brand=$scope.filterDirective.brand._id,$location.search("brand",$scope.filterDirective.brand.url),$scope.filterDirective.brandCollections=$scope.filterDirective.brand.tags):($scope.filterDirective.brandCollections=[],$location.search("brand",null))):($scope.filterDirective.brandCollections=[],$location.search("brand",null))}function _setBrandTag(brandTagId,filed){if(brandTagId&&$scope.filterDirective.brandCollections){var brandTag=$scope.filterDirective.brandCollections.getObjectFromArray(filed,brandTagId);brandTag?($scope.filterDirective.query.brandTag=brandTag._id,$location.search("brandTag",brandTag.url)):$location.search("brandTag",null)}else $location.search("brandTag",null)}function _setFilterTagsUrl(){if($scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length){var queryTag=$scope.filterDirective.filterTags.map(function(tag){return tag.url}).join("+");$location.search("queryTag",queryTag||null)}else $location.search("queryTag",null)}function _getQueryTag(){var arr=[];return $scope.filterDirective.query.tags.forEach(function(tags){tags.length&&tags.forEach(function(tag){arr.push(tag)})}),arr}var $state=$rootScope.$state,$stateParams=$rootScope.$stateParams;$scope.filterDirective={},$scope.filterDirective.query={section:"",brand:"",category:"",tags:[],artikul:$stateParams.searchStr?$stateParams.searchStr.clearTag(20):"",brandTag:""},$q.when().then(function(){return Sections.getSections()}).then(function(sections){var q=$q.defer();return"brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl?($stateParams.parentGroup?$scope.parentSection=Sections.getParentSection($stateParams.parentGroup):$scope.parentSection=Sections.getParentSection($stateParams.groupUrl),"allCategories"==$stateParams.categoryList||"category"!=$stateParams.categoryUrl?($scope.filterDirective.categories=$scope.parentSection.categories,$scope.filterDirective.sectionCategories=$scope.filterDirective.categories.map(function(el){return el._id}),"category"!=$stateParams.categoryUrl?Category.get({id:$stateParams.categoryUrl},function(res){$scope.filterDirective.query.category=res._id,$scope.filterDirective.category=res,$scope.filterDirective.category.brands&&$scope.filterDirective.category.brands.length&&($scope.filterDirective.brands=$scope.filterDirective.category.brands),console.log($scope.filterDirective.brands),q.resolve()}):q.resolve()):($scope.filterDirective.sectionCategories=Sections.getEmbededCategories($scope.parentSection,[]).map(function(el){return el._id}),$scope.filterDirective.sectionCategories.length||($scope.filterDirective.sectionCategories=[null]),q.resolve())):q.resolve(),q.promise}).then(function(){var q=$q.defer();return $stateParams.brand&&!$scope.filterDirective.brands?Brands.query(function(res){res.shift(),$scope.filterDirective.brands=res,q.resolve()}):q.resolve(),q.promise}).then(function(){_setBrand($stateParams.brand,"url"),_setBrandTag($stateParams.brandTag,"url")}).then(function(){var q=$q.defer();if($stateParams.queryTag){var queryTags=$stateParams.queryTag.split("+");queryTags=queryTags.filter(function(item,pos){return queryTags.indexOf(item)==pos}),$scope.filterDirective.categories?($scope.filterDirective.filterTags=queryTags.map(function(tag){return getTagFromCategoriesList(tag,"url")}).filter(function(tag){return tag}),q.resolve()):FilterTags.getTagsByUrl(queryTags,function(res){$scope.filterDirective.filterTags=res,q.resolve()})}else q.resolve();return q.promise}).then(function(){_setFilterTagsUrl()}).then(function(){$scope.filterDirective.query.category&&$scope.filterDirective.category?$scope.filterDirective.category.filters&&$scope.filterDirective.category.filters.length&&($scope.filterDirective.category.filters.forEach(function(item,i){$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&$scope.filterDirective.filterTags.forEach(function(tag){tag.filter==item._id&&($scope.filterDirective.query.tags[i]||($scope.filterDirective.query.tags[i]=[]),$scope.filterDirective.query.tags[i].push(tag._id))})}),$scope.filterDirective.filters=$scope.filterDirective.category.filters):$scope.filterDirective.filterTags&&$scope.filterDirective.filterTags.length&&($scope.filterDirective.query.tags[0]=[],$scope.filterDirective.filterTags.forEach(function(tag){$scope.filterDirective.query.tags[0].push(tag._id)}))}).then(function(){$scope.filterDirective.getQuery()}).catch(function(err){console.log(err)}),$scope.filterDirective.getQuery=function(){var query=[];global.get("nostore").val&&query.push({tags:{$nin:[global.get("nostore").val._id]}});for(var key in $scope.filterDirective.query)if($scope.filterDirective.query[key])if("tags"==key){var qu=[];$scope.filterDirective.query[key].filter(function(){return!0});$scope.filterDirective.query[key].forEach(function(obj,i){var q=[];obj&&obj.length&&(obj.forEach(function(objT){q.push({tags:objT})}),q.length>1?(q={$or:q},qu.push(q)):(q=q[0],qu.push(q)))}),qu.length&&(1==qu.length?query.push(qu[0]):query.push({$and:qu}))}else{var obj={};obj[key]=$scope.filterDirective.query[key],query.push(obj)}else if("category"==key&&$scope.filterDirective.sectionCategories&&$scope.filterDirective.sectionCategories.length){var obj={};obj.category={$in:$scope.filterDirective.sectionCategories},query.push(obj)}return query=1==query.length?JSON.stringify(query[0]):query.length>1?JSON.stringify({$and:query}):{},void($scope.query=query)},$scope.filterDirective.changeFilter=function(reloadController){if(reloadController){if($scope.filterDirective.category&&$scope.filterDirective.query.category==$scope.filterDirective.category._id)return;if($scope.filterDirective.query.category){var categoryUrl=$scope.filterDirective.categories.getObjectFromArray("_id",$scope.filterDirective.query.category);categoryUrl=categoryUrl?categoryUrl.url:"category",$location.search("categoryList",null)}else{var categoryUrl="category";$location.search("categoryList","allCategories")}$state.current.reloadOnSearch=!0;var o={groupUrl:$stateParams.groupUrl,categoryUrl:categoryUrl,queryTag:void 0,brand:void 0,brandTag:void 0};$state.go($state.current.name,o,{reload:!0}),$state.current.reloadOnSearch=!1}else $scope.filterDirective.query.artikul="",_setBrand($scope.filterDirective.query.brand,"_id"),_setBrandTag($scope.filterDirective.query.brandTag,"_id"),$scope.filterDirective.filterTags=_getQueryTag().map(function(tag){return getTagFromCategoriesList(tag,"_id")}).filter(function(tag){return tag}),_setFilterTagsUrl(),$scope.filterDirective.getQuery()},$scope.filterDirective.clearFilter=function(){console.log("clear filetrs"),$scope.filterDirective.query.tags=[],$scope.filterDirective.changeFilter()}}}}]),function(){function menuSectionHorizontal(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenu,controllerAs:"$ctrl",templateUrl:"components/menu/menuSectionHorizontel.html"}}function menuSectionHorizontalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenu,controllerAs:"$ctrl"}}function menuBrandsHorizontalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuBrands,controllerAs:"$ctrl"}}function menuSectionVirtical(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuV,controllerAs:"$ctrl",templateUrl:"components/menu/menuSectionVertical.html"}}function menuSectionVirticalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuV,controllerAs:"$ctrl"}}function menuBrandsVirticalPug(){return{scope:{},restrict:"AE",bindToController:!0,controller:directiveMenuVBrands,controllerAs:"$ctrl"}}function dropdownOnHover(){return{scope:{},restrict:"AE",bindToController:!0,link:directiveDropdownOnHover,controllerAs:"$ctrl"}}function directiveMenu(Sections,$state,$q,global,$rootScope,$timeout){function closeRest(){for(var i=0,l=innerDivsBrand.length;i<l;i++)innerDivsBrand[i].hide()}function bindHoverLi(li,ii){self.clickMenu?li.click(function(e){if($(e.target).hasClass("sibsection"))li.find(".section-in-section").each(function(i,li2){$(li2).hover(function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("slow"):2==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("fast"):$(li2).find(".sub-menu").stop(!0,!1,!0).show()},function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).hide():(self.dropDownCatalog,$(li2).find(".sub-menu").stop(!0,!1,!0).hide())})});else{closeRest();for(var i=0,l=sectionElements.length;i<l;i++)sectionElements[i][0].id==li[0].id?1==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideToggle("slow"):2==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideToggle("fast"):li.innerDiv.stop(!0,!1,!0).toggle():1==self.dropDownCatalog?sectionElements[i].innerDiv.slideUp("slow"):2==self.dropDownCatalog?sectionElements[i].innerDiv.slideUp("fast"):sectionElements[i].innerDiv.hide()}}):(li.hover(function(){1==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideDown("slow"):2==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideDown("fast"):li.innerDiv.stop(!0,!1,!0).show()},function(){1==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideUp("slow"):2==self.dropDownCatalog?li.innerDiv.stop(!0,!1,!0).slideUp("fast"):li.innerDiv.stop(!0,!1,!0).hide()}),li.find(".section-in-section").each(function(i,li2){$(li2).hover(function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("slow"):2==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).slideDown("fast"):$(li2).find(".sub-menu").stop(!0,!1,!0).show()},function(){1==self.dropDownCatalog?$(li2).find(".sub-menu").stop(!0,!1,!0).hide():(self.dropDownCatalog,$(li2).find(".sub-menu").stop(!0,!1,!0).hide())})}))}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.dropDownCatalog=global.get("store").val.template.dropDownCatalog,self.global=global;var sectionElements=[],innerDivs=[],innerDivsBrand=[];!function(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){global.get("brands").val.forEach(function(sec,i){var el=$("#s"+sec._id),innerDiv=$(el).find("#innerDivBrand"+sec._id);innerDivsBrand.push(innerDiv)}),self.sections=sections.filter(function(el){return!el.parent&&0===el.level}),setTimeout(function(){var w=$(window).width();self.sections.forEach(function(sec,i){var el=$("#s"+sec._id),elJS=document.getElementById("s"+sec._id);document.getElementById;var sec_element_offset=el.offset();if(sec_element_offset){var offsetLeft;elJS&&elJS.getBoundingClientRect&&(offsetLeft=pageXOffset+elJS.getBoundingClientRect().x),!offsetLeft&&elJS&&elJS.DOMRect&&(offsetLeft=pageXOffset+elJS.DOMRect.left,console.log("offsetLeft DOMRect",offsetLeft,sec_element_offset.left)),offsetLeft||(offsetLeft=sec_element_offset.left);var innerDiv=$("#innerDiv"+sec._id),container=innerDiv.find("div");container.find(".sub-menu"),el.innerDiv=innerDiv,innerDiv.css("left","-"+offsetLeft+"px"),bindHoverLi(el,i),sectionElements.push(el)}}),$(".innerDiv").width(w)},300)}).catch(function(err){console.log(err)})}(),$rootScope.$on("$stateChangeStart",function(ev){for(var i=0,l=innerDivs.length;i<l;i++)if(innerDivs[i][0]&&innerDivs[i].is(":hover")){sectionElements[i].unbind(),innerDivs[i].slideUp(function(){$timeout(function(){bindHoverLi(sectionElements[i],i)},700)});break}})}function directiveMenuV(Sections,$state,$q,global,$rootScope,$element){function bindHoverLi(li,ii){self.sections[ii]&&self.sections[ii].openCatalog||$(innerDivs[ii]).slideToggle(),console.log(li,ii,self.clickMenu),self.clickMenu?li.click(function(e){for(var i=0,l=innerDivs.length;i<l;i++)i==ii&&$(innerDivs[i]).stop(!0,!1,!0).slideToggle(300)}):li.hover(function(){$(innerDivs[ii]).stop(!0,!1,!0).slideToggle(300)})}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.global=global;var sectionElements=[],innerDivs=[];!function(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){self.sections=sections.filter(function(el){return!el.parent&&0===el.level&&!el.hideSection}),setTimeout(function(){self.sections.forEach(function(sec,i){var el=$("#s"+sec._id),innerDiv=el.children("div");innerDivs.push(innerDiv),bindHoverLi(el,i),sectionElements.push(el)});var innerUl=$element.find(".category-in-section");$(innerUl).each(function(i,section){var ul=$(section).find("ul");$(ul).slideToggle(),$(section).click(function(e){console.log("section",section),$(ul).stop(!0,!1,!0).slideToggle(300)})})},100)}).catch(function(err){console.log(err)})}()}function directiveMenuBrands(Sections,$state,$q,global,$rootScope,$timeout,$element){function closeRest(){for(var i=0,l=innerDivsSection.length;i<l;i++)innerDivsSection[i].hide()}function bindHoverLi(li,ii){self.clickMenu?li.click(function(e){closeRest();for(var i=0,l=sectionElements.length;i<l;i++)sectionElements[i][0].id==li[0].id?li.innerDiv.stop(!0,!1,!0).toggle():sectionElements[i].innerDiv.hide()}):li.hover(function(){li.innerDiv.stop(!0,!1,!0).show()},function(){li.innerDiv.stop(!0,!1,!0).hide()})}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.global=global;var sectionElements=[],innerDivs=[],innerDivsSection=[];!function(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){sections.forEach(function(sec,i){var el=$("#s"+sec._id),innerDiv=$(el).find("#innerDiv"+sec._id);innerDivsSection.push(innerDiv)}),self.brands=global.get("brands").val?global.get("brands").val:[],setTimeout(function(){var w=$(window).width(),index=0;self.brands.forEach(function(sec,i){if(sec.display){var el=$("#s"+sec._id),sec_element_offset=el.offset();if(sec_element_offset){var offsetLeft=sec_element_offset.left,innerDiv=$element.find("#innerDivBrand"+sec._id);el.innerDiv=innerDiv,innerDiv.css("left","-"+offsetLeft+"px"),bindHoverLi(el,index),sectionElements.push(el),index++}}}),$(".innerDiv").width(w)},100)}).catch(function(err){console.log(err)})}(),$rootScope.$on("$stateChangeStart",function(ev){for(var i=0,l=innerDivs.length;i<l;i++)if(innerDivs[i][0]&&innerDivs[i].is(":hover")){sectionElements[i].unbind(),innerDivs[i].slideUp(function(){$timeout(function(){bindHoverLi(sectionElements[i],i)},700)});break}})}function directiveMenuVBrands(Sections,$state,$q,global,$rootScope){function bindHoverLi(li,ii){$(innerDivs[ii]).slideToggle(),self.clickMenu?li.click(function(e){for(var i=0,l=innerDivs.length;i<l;i++)i==ii&&innerDivs[i].stop(!0,!1,!0).slideToggle(300)}):li.hover(function(){innerDivs[ii].stop(!0,!1,!0).slideToggle(300)})}var self=this;self.clickMenu=global.get("store").val.template.clickMenu,self.global=global;var sectionElements=[],innerDivs=[];!function(){self.brands=global.get("brands").val?global.get("brands").val:[],setTimeout(function(){var index=0;self.brands.forEach(function(sec,i){if(sec.display){var el=$("#s"+sec._id),innerDiv=el.children("div");innerDivs.push(innerDiv),bindHoverLi(el,index),sectionElements.push(el),index++}})},100)}()}function directiveDropdownOnHover(scope,element,arrts){function bindHover(){$(element).hover(function(){$(this).children("ul").stop(!0,!1,!0).slideToggle(200)})}!function(){$(element).children("ul").hide(),bindHover()}()}function slideMenuAfterScroll(global,$timeout,$rootScope){return{restrict:"A",link:function(scope,element,attrs){function scrollHandlerMenu1(){if(!menuHide||"home"==$rootScope.$state.current.name){var scrolled=window.pageYOffset||document.documentElement.scrollTop;scrolled>offset&&!done?(done=!0,$rootScope.$emit("hideMenu1AfterScroll"),$(element).css("top","-"+h+"px")):scrolled<offset&&done&&(done=!1,$rootScope.$emit("showMenu1AfterScroll"),$(element).css("top",0))}}function scrollHandlerMenu2(){if(!menuHide||"home"==$rootScope.$state.current.name){var scrolled=window.pageYOffset||document.documentElement.scrollTop;scrolled>offset&&!done?(done=!0,$(element).css("top",0)):scrolled<offset&&done&&(done=!1,$(element).css("top",h+"px"))}}function inverseNone(){logoInverse.css("display","none"),logo.css("display","block"),likesInverse.css("display","none"),likes.css("display","block"),cartInverse.css("display","none"),cart.css("display","block"),humbInverse.css("display","none"),humb.css("display","block")}function inverseBlock(){logo.css("display","none"),logoInverse.css("display","block"),likes.css("display","none"),likesInverse.css("display","block"),cart.css("display","none"),cartInverse.css("display","block"),humb.css("display","none"),humbInverse.css("display","block")}function listenScroll(){$(window).scroll(function(){if("home"==$rootScope.$state.current.name&&(!template.inverseColor.homePage||"home"==$rootScope.$state.current.name)){(window.pageYOffset||document.documentElement.scrollTop)>10?(element.addClass("inverseColor"),inverseBlock()):(element.removeClass("inverseColor"),inverseNone())}})}function listenBanner(){var el=document.getElementById("arrowDownDiv");if(el){var elOffsetY=$(el).offset().top;$(window).scroll(function(){if("home"==$rootScope.$state.current.name){var scrolled=window.pageYOffset||document.documentElement.scrollTop;$(el).height()+elOffsetY-10>scrolled?(element.removeClass("inverseColor"),inverseNone()):(element.addClass("inverseColor"),inverseBlock())}})}}var done,firstLook=!0,menu=attrs.slideMenuAfterScroll,menuHide=attrs.hideMenu,template=global.get("store").val.template,offset=199,h=$("#menu1-section").height();"menu2"==menu&&template.menu2.fixed&&template.menu2.is&&template.menu2.position,"menu1"==menu&&template.menu1.fixed&&"top"==template.menu1.position&&template.menu1.scrollSlide?$(window).scroll(scrollHandlerMenu1):"menu2"==menu&&template.menu1.fixed&&"top"==template.menu1.position&&"top"==template.menu2.position&&template.menu1.scrollSlide&&$(window).scroll(scrollHandlerMenu2);var logo,logoInverse,cart,cartInverse,humb,humbInverse,likes,likesInverse;template.inverseColor&&template.inverseColor.use&&(template.inverseColor.homePage&&function(){$rootScope.$on("$stateChangeSuccess",function(event,to,toParams,fromState,fromParams){var delay=0;firstLook&&(delay=500,firstLook=!1),$timeout(function(){"home"==to.name?(element.removeClass("inverseColor"),inverseNone()):(element.addClass("inverseColor"),inverseBlock())},delay)})}(),$timeout(function(){logo=$("#mainLogo"),logoInverse=$("#inverseLogo"),cart=$("#mainCart"),cartInverse=$("#inverseCart"),humb=$("#mainHumb"),humbInverse=$("#inverseHumb"),likes=$("#mainLikes"),likesInverse=$("#inverseLikes"),template.inverseColor.startScroll?listenScroll():template.inverseColor.firstBanner&&listenBanner()},300)),$rootScope.$on("$stateChangeSuccess",function(event,to,toParams,fromState,fromParams){menuHide&&("home"==to.name?($rootScope.$emit("showMenu1AfterScroll"),"menu1"==menu?$(element).css("top",0):$(element).css("top",h+"px")):($rootScope.$emit("hideMenu1AfterScroll"),"menu1"==menu?$(element).css("top","-"+h+"px"):$(element).css("top",0)))})}}}angular.module("gmall.directives").directive("menuSections",menuSectionHorizontal).directive("menuSectionsPug",menuSectionHorizontalPug).directive("menuBrandsPug",menuBrandsHorizontalPug).directive("menuSectionsVirtical",menuSectionVirtical).directive("menuSectionsVirticalPug",menuSectionVirticalPug).directive("menuBrandsVirticalPug",menuBrandsVirticalPug).directive("dropdownOnHover",dropdownOnHover).directive("slideMenuAfterScroll",slideMenuAfterScroll).directive("setFonAfterStartScroll",["$timeout","$state","$rootScope","global",function($timeout,$state,$rootScope,global){return{restrict:"A",link:function(scope,element,attr){var h1,h2,mainContentDiv=$("#mainContentDiv"),templ=global.get("store").val.template;$timeout(function(){h1=$("#menu1-section").outerHeight(),h2=$("#menu2-section").outerHeight(),h2&&(h1+=h2),global.get("store").val.template.menu1.hideMenuIfNotHome&&(h1=h2),h2=h1}),$(element).hover(function(){$rootScope.$emit("menuHoverIn")},function(){$rootScope.$emit("menuHoverOut")}),$rootScope.$on("menuHoverIn",function(){global.get("store").val.template.menu1.BGColorOnHover&&$(element).addClass("menuColor")}),$rootScope.$on("menuHoverOut",function(){global.get("store").val.template.menu1.BGColorOnHover&&!global.get("store").val.template.menu1.background&&window.pageYOffset<5&&"home"==$rootScope.$state.current.name&&$(element).removeClass("menuColor")}),$rootScope.$on("$stateChangeStart",function(event,to){"home"!=to.name?(templ.menu1.marginOther||$(element).addClass("menuColor"),templ.margin||$timeout(function(){"left"!=templ.menu1.position&&"right"!=templ.menu1.position&&!templ.menu1.marginOther&&templ.menu1.fixed&&mainContentDiv.css("margin-top",h1)})):(global.get("store").val.template.menu1.background||(global.get("store").val.template.menu1.BGColorOnHover?window.pageYOffset<5&&$(element).removeClass("menuColor"):$(element).removeClass("menuColor")),templ.margin||"left"!=templ.menu1.position&&"right"!=templ.menu1.position&&mainContentDiv.css("margin-top",0))});var is=!1;attr.setFonAfterStartScroll?$(element).addClass("menuColor"):global.get("store").val.template.menu1.BGColorOnHover&&$(window).scroll(function(){window.pageYOffset>5?is||(is=!0,$(element).addClass("menuColor")):"home"==$rootScope.$state.current.name&&(is=!1,$(element).removeClass("menuColor"))})}}}]).directive("setMenuColorClass",["$rootScope",function($rootScope){return{restrict:"A",link:function(scope,element,attr){console.log(element),$rootScope.$on("$stateChangeStart",function(event,to){"home"!=to.name?$(element).addClass("menuColor"):window.pageYOffset<5&&$(element).removeClass("menuColor")}),$rootScope.$on("menuHoverIn",function(){console.log("menuHoverIn",console.log(element)),$(element).addClass("menuColor")}),$rootScope.$on("menuHoverOut",function(){"home"==$rootScope.$state.current.name&&window.pageYOffset<5&&$(element).removeClass("menuColor")}),$(window).scroll(function(){"home"==$rootScope.$state.current.name&&(window.pageYOffset>5?$(element).addClass("menuColor"):$(element).removeClass("menuColor"))})}}}]).directive("marginMainContent22",function(global,$timeout){return{restrict:"A",link:function(scope,element,attrs){var mainContentDiv=$("#mainContentDiv"),templ=global.get("store").val.template;$timeout(function(){templ.margin&&"left"!=templ.menu1.position&&"right"!=templ.menu1.position&&$timeout(function(){var m1=$("#menu1-section"),h1=m1.height(),m2=$("#menu2-section");if(m2)var h2=m2.height();h2&&(h1+=h2),mainContentDiv.css("margin-top",h1)})},100)}}}).directive("marginMainContent",function($rootScope,$timeout,global){return{restrict:"A",link:function(scope,element,attrs){$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){$timeout(function(){if(global.get("store").val.template.menu1.fixed){var h=$(document.body).find("#firstDiv").height(),vh=Math.max(document.documentElement.clientHeight,window.innerHeight||0),delta=vh-h;if(delta>30){var mt=$(element[0].querySelector("#mainContentDiv")).css("margin-top");mt=mt?parseInt(mt,10):0;var elH=element.height();element.css("min-height",elH+delta)}}},200)})}}}).directive("footer22",function($timeout,$rootScope){return{restrict:"E",link:function(scope,element){$rootScope.$on("$stateChangeStart",function(event,to,toParams,fromState,fromParams){element.css("position","static")}),$rootScope.$on("$stateChangeSuccess",function(ev,to,toParams,from,fromParams){$timeout(function(){})})}}}),directiveMenu.$inject=["Sections","$state","$q","global","$rootScope","$timeout"],directiveMenuV.$inject=["Sections","$state","$q","global","$rootScope","$element"],directiveMenuBrands.$inject=["Sections","$state","$q","global","$rootScope","$timeout","$element"],directiveMenuVBrands.$inject=["Sections","$state","$q","global","$rootScope"]}(),angular.module("gmall.services").service("Filters",function($resource,$q,global,$uibModal){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query}
;return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function returnFilters(resolve){pending?setTimeout(function(){returnFilters(resolve)},300):resolve(filters)}function reloadItems(){pending=!0,Items.query(function(res){res.shift(),filters=res,global.set("filters",filters),pending=!1})}function selectFilter(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/selectFilter.html",controller:selectFilterCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectFilterCtrl(Filters,$uibModalInstance,$q,global){var self=this;self.lang=global.get("lang").val,$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filter){$uibModalInstance.close(filter)}}var Items=$resource("/api/collections/Filter/:_id",{_id:"@_id"}),filters=null,pending=!0;this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.select=selectFilter,this.reloadItems=reloadItems,this.getItem=getItem,this.getList=getList,this.getFilters=function(){return $q(function(resolve,reject){if(global.get("filters")&&global.get("filters").val)return filters||(filters=global.get("filters").val),resolve(global.get("filters").val);pending?setTimeout(function(){returnFilters(resolve)},300):filters?resolve(filters):(pending=!0,Items.query(function(res){res.shift(),filters=res,pending=!1,resolve(filters)},function(err){pending=!1,reject(err)}))})},global.get("filters")&&global.get("filters").val||Items.query(function(res){res.shift(),filters=res,global.get("filters")&&!global.get("filters").val&&global.set("filters",filters),pending=!1}),selectFilterCtrl.$inject=["Filters","$uibModalInstance","$q","global"]});var __filterTagsO=_filterTagsO,__filterTags=_filterTags;angular.module("gmall.services").service("FilterTags",filterTagsService),filterTagsService.$inject=["$resource","$uibModal","$q","global","$timeout","Sections"],angular.module("gmall.services").service("SelectFilterTags",["$q","$uibModal",function($q,$uibModal){function bindFilterTagToModelCtrl(Filters,$uibModalInstance){var self=this;$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(filterTag){$uibModalInstance.close(filterTag)}}this.bindFiterTagToModel=function(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/filters/bindFilterTagToModel.html",controller:bindFilterTagToModelCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}}]),angular.module("gmall.directives").directive("filtersList",[function(){function filterCtrl($anchorScroll,Filters,FilterTags,$q,SelectCategory,$state,$timeout,$scope,global,Confirm,$http,$uibModal,exception,Stuff){function activate(){$q.when().then(function(){return Filters.getList({page:0,rows:200},{})}).then(function(res){self.filters=res}).then(function(){return FilterTags.query().$promise}).then(function(res){res.shift(),self.filterTags=res}).then(function(){self.filters.forEach(function(filter){filter.tags||(filter.tags=[]),filter.tags.length?filter.tags.forEach(function(tag,i){tag.index=i}):self.filterTags.forEach(function(tag){tag.filter==filter._id&&(tag.index=filter.tags.length,filter.tags.push(tag))})})})}function saveTagPromise(tag,field){return $q(function(res,rej){var o={_id:tag._id};o[field]=tag[field],FilterTags.save({update:field},o,function(){res()},function(err){rej(err)})})}function setCountData(filter){$uibModal.open({animation:!0,templateUrl:"components/filters/modal/countData.html",controller:function($uibModalInstance,$q,saveField,filter){var self=this;self.filter=filter,self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()},self.saveField=function(field){saveField(filter,field)}},resolve:{saveField:function(){return self.saveField},filter:function(){return filter}},controllerAs:"$ctrl",size:"lg"})}console.log("lskdjfl");var self=this;self.$state=$state,$scope.$on("changeLang",function(){activate()}),activate(),self.setCountData=setCountData,self.newFilter={name:""},self.addNewFilter=function(filter){if(console.log(filter),filter.name){var newFilter={name:filter.name.substring(0,50),index:0,type:1,tags:[],active:!1,showTags:!0};self.filters&&self.filters.length&&(newFilter.index=self.filters[self.filters.length-1].index),Filters.save(newFilter,function(res){newFilter._id=res.id,self.filters.push(newFilter),filter.name=""})}},self.deleteFilter=function(filter,idx){Confirm("Delete?").then(function(){Filters.delete({_id:filter._id},function(res){self.filters.splice(idx,1)},function(err){console.log(err)})})},self.saveFilter=function(filter,field){if(filter.name){var o={_id:filter._id};o[field]=filter[field],Filters.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}},self.dropFilterCallback=function(filter){return setTimeout(function(){self.filters.forEach(function(filter,idx){filter.index=idx+1,Filters.save({update:"index"},filter)})},200),filter},self.saveField=function(item,field){var o={_id:item._id};o[field]=item[field],Filters.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},self.fixBrands=function(){Confirm("Подтверждаете?").then(function(){$scope.fixBrandsDesable=!0;var data={};return $http({method:"post",url:"/api/fixedDB/filter",data:data})}).then(function(){exception.showToaster("info","fix stucture","Ok")}).catch(function(err){exception.catcher("fix stucture")(err)})},self.addTag=function(filter){if(filter.newTag){var newTag={name:filter.newTag.substring(0,50),index:1,filter:filter._id};filter.tags&&filter.tags.length&&(newTag.index=filter.tags[filter.tags.length-1].index),$q.when().then(function(){return FilterTags.save(newTag).$promise}).then(function(res){newTag._id=res.id,filter.tags.push(newTag),filter.newTag="",Filters.save({update:"tags"},{_id:filter._id,tags:filter.tags.map(function(el){return el._id})},function(res){})}).catch(function(err){console.log(err)})}},self.saveTag=function(tag,field){if(tag.name){var o={_id:tag._id};o[field]=tag[field],FilterTags.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){})}},self.deleteTag=function(filter,idx){Confirm("Delete?").then(function(){return Stuff.getList({page:0,row:100},{tags:filter.tags[idx]._id})}).then(function(stuffs){if(stuffs&&stuffs.length){var s="привязаны товары";throw stuffs.forEach(function(st){s+=" "+st.name+" "+(st.artikul?st.artikul:"")+"|"}),s}}).then(function(){FilterTags.delete({_id:filter.tags[idx]._id},function(res){filter.tags.splice(idx,1);Filters.save({update:"tags"},{_id:filter._id,tags:filter.tags.map(function(el){return el._id})},function(res){})},function(err){console.log(err)})}).catch(function(err){err&&exception.catcher("удаление")(err)})},self.dropTagCallback=function(tag,index,filter){return setTimeout(function(){Filters.save({update:"tags"},{_id:filter._id,tags:filter.tags.map(function(el){return el._id})},function(res){});var acts=[];if(filter.tags.forEach(function(tag,i){tag.index=i,acts.push(saveTagPromise(tag,"index"))}),$q.all(acts),tag.filter!=filter._id&&tag.filter){filter.tags.forEach(function(tag,i){tag.index=i});var oldFilter=self.filters.getObjectFromArray("_id",tag.filter);Filters.save({update:"tags"},{_id:oldFilter._id,tags:oldFilter.tags.map(function(el){return el._id})},function(res){}),tag.filter=filter._id,FilterTags.save({update:"filter"},tag,function(res){})}},200),tag},self.tagMoved=function(filter,tag,idx){idx==tag.index?filter.tags.splice(idx,1):filter.tags.splice(idx+1,1),filter.tags.forEach(function(tag,i){tag.index=i})},self.selectCategory=function(id){SelectCategory.bindCategoryForFilterBrandCol(id,"filters")}}return{scope:{},bindToController:!0,controller:filterCtrl,controllerAs:"$ctrl",restrict:"E",templateUrl:"components/filters/filters.html"}}]).directive("filterTagEdit",[function(){function tagCtrl($stateParams,global,FilterTags,$q,$timeout,$scope){function activate(){$q.when().then(function(){return self.Items.get({_id:$stateParams.id}).$promise}).then(function(res){self.item=res}).catch(function(err){self.edit=!1})}var self=this;self.Items=FilterTags,self.global=global,$scope.$on("changeLang",function(){activate()}),activate(),self.saveField=function(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field],self.Items.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}}return{scope:{},bindToController:!0,controller:tagCtrl,controllerAs:"$ctrl",restrict:"E",templateUrl:"components/filters/tagEdit.html"}}]).directive("filterItemEdit",[function(){function filterItemEditCtrl($stateParams,global,Filters,$q,$timeout,$scope){function activate(){console.log($stateParams.id),$q.when().then(function(){return self.Items.getItem($stateParams.id)}).then(function(res){console.log(res),self.item=res}).catch(function(err){self.edit=!1})}var self=this;self.Items=Filters,self.global=global,$scope.$on("changeLang",function(){activate()}),activate(),self.saveField=function(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field],self.Items.save({update:field},o,function(res){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}}return{scope:{},bindToController:!0,controller:filterItemEditCtrl,controllerAs:"$ctrl",restrict:"E",templateUrl:"components/filters/filterEdit.html"}}]).directive("filterTagComponent",[function(){return{restrict:"E",templateUrl:"components/filters/filterTag.component.html"}}]).directive("filterComponent",[function(){return{restrict:"E",templateUrl:"components/filters/filter.component.html"}}]),angular.module("gmall.services").provider("global",[function(){var _data={},_urls={};this.setUrl=function(urls){_urls=urls};var _set=function(what,val){val=val||null,angular.isDefined(what)&&(_data[what]?_data[what].val=angular.isDefined(val)?val:null:_data[what]={val:val})},_getSticker=function(stuff){stuff._id?stuff._id:stuff.stuff;if(stuff.tags&&stuff.tags.length&&_data.filterTagsSticker.val){for(var i=0,l=_data.filterTagsSticker.val.length;i<l;i++){var tag=_data.filterTagsSticker.val[i]._id;if(stuff.tags.indexOf(tag)>-1)return!!_data.filterTagsSticker.val[i].sticker&&_data.filterTagsSticker.val[i].sticker}return!1}},_getDataForCart=function(stuff){return void console.log("не используется!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")};this.set=_set,this.$get=["$http",function($http){return{request:function(url,vars){return angular.isDefined(vars)?$http.post(url,$.param(vars),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}):$http.get(url)},url:function(which){return _urls[which]},set:_set,get:function(what){return angular.isDefined(what)&&what in _data?_data[what]:void 0},del:function(what){if(angular.isDefined(what)){var i=_data.indexOf(what);if(i>=0)return _data.splice(i,1)}return!1},clear:function(){_data=[]},getAll:function(){return _data},getSticker:_getSticker,getDataForCart:_getDataForCart}}]}]).factory("globalSrv",["global",function(global){var _send=global.request;return{getData:function(name,param,abbr){var url=global.url(name);if(!angular.isDefined(param)||angular.equals(param,null)||angular.equals(param,"")||(url+="/"+param),angular.isDefined(abbr)&&!angular.equals(abbr,null)&&!angular.equals(abbr,"")&&"object"==typeof abbr){url+="?";for(var key in abbr)"?"!=url[url.length-1]&&(url+="&"),url+=key+"="+abbr[key]}return _send(url)}}}]),function(){function helperService($resource,$uibModal,$q,exception){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return _items[id]=response,response}function getItemFailed(error){return _items[id]=null,$q.reject(error)}return _items[id]?$q.when(_items[id]):Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function getHelp(state){$q.when().then(function(){return getItem(state)}).then(function(helper){$uibModal.open({animation:!0,templateUrl:"components/helper/helperModal.html",controller:function($uibModalInstance,$sce,desc){var self=this;self.desc=desc,self.cancel=function(){$uibModalInstance.dismiss("cancel")}},resolve:{desc:function(){return helper.desc}},controllerAs:"$ctrl"})}).catch(function(err){var msg="ошибка";err&&("object"==typeof err?err.data?msg=err.data:err.message&&(msg=err.message):msg=err),err=err.data||err,exception.catcher("получение справки")(msg)})}var Items=$resource("/api/collections/Helper/:_id",{_id:"@_id"}),_items={};return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,getHelp:getHelp}}angular.module("gmall.services").service("Helper",helperService),helperService.$inject=["$resource","$uibModal","$q","exception"]}(),angular.module("gmall.services").factory("$email",function($resource){return $resource("/api/sendEmail")}).factory("Email",function($resource){return $resource("/api/sendEmails")}),angular.module("gmall.services").factory("CreateContent",["global","$timeout",function(global,$timeout){function getHeader(user){var s='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 20px 0 0 0" border="0"><tr width="100%" style="max-width:900px;"><td width="50%" style=" padding:5px 20px"><a href="'+global.get("store").val.link+'">';return global.get("store").val.logo&&(s+='<img  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></br>'),global.get("store").val.name&&(s+='<span  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.name+'"></span>'),s+="</a></td>",s+='<td width="50%"  style="text-align: right; padding:5px 20px">',global.get("store").val.seller.phone&&(s+="<p><span>"+global.get("langOrder").val.phone+'</span>: <a style="color:#666" href="tel:+'+global.get("store").val.seller.phone+'"><span>+'+global.get("store").val.seller.phone+"</span></a></p>"),global.get("store").val.feedbackEmail&&(s+='<p><span>e-mail</span>: <a style="color:#666" href="mailto:'+global.get("store").val.feedbackEmail+'"><span>'+global.get("store").val.feedbackEmail+"</span></a></p>"),s+="</td></tr>",global.get("sections")&&global.get("sections").val&&global.get("sections").val[0]&&(s+='<table width="860px" cellpadding="0" cellspacing="0" style="max-width:900px;background-color: #000;border-collapse:collapse; border:1px solid #000;table-layout: fixed; padding: 0;margin: 0px 20px"><td width="50%" style="background-color: #333;text-align: center; padding: 20px;border:1px solid #fff;"><a style="color: #fff; text-transform: uppercase" href="'+global.get("store").val.link+'/cabinet"><span>'+global.get("langOrder").val.mainCabinet+"</span></a></td>",s+='<td width="50%" style="background-color: #333;text-align: center; padding: 20px;border:1px solid #fff;"><a style="color: #fff; text-transform: uppercase" href="'+global.get("store").val.link+"/"+global.get("sections").val[0].url+'/category"><span>'+global.get("lang").val.catalog+"</span></a></td>",s+="</tr></table>",s+="</table>"),s}function getFooter(){var s='<style>.footer a</style><table class="footer" width="860px" cellpadding="0" cellspacing="0" style="margin: 20px;color: #000;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;" border="0"><tr><td colspan="2" align="center" style="vertical-align: top; padding: 10px 20px;background-color:#333"><span style="font-family:Tahoma; font-size:12px; color:#e8e8e8;">';if(global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&global.get("store").val.template.index&&global.get("store").val.template.index.icons&&global.get("store").val.template.index.icons[key+"white"]&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 0 10px" src="'+global.get("store").val.link+global.get("store").val.template.index.icons[key+"white"].img+'"></a>');return s+='</span></td></tr><tr style="background-color: #fff;color: #000"><td align="left" style="vertical-align: top; padding: 10px 20px"><span style="font-size:14px; ">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),s+="</span></td>",s+='<td align="right" style="vertical-align: top; padding: 10px 20px"><span style="font-size:14px;">',global.get("store").val.footer&&global.get("store").val.footer.text1&&(s+=global.get("store").val.footer.text1),s+="</span></td></tr></table>"}function empty(){return'<!DOCTYPE html><html><head><meta charset=utf-8/><style type="text/css">@media only screen and (max-device-width:660px){.table-mobile{display:none !important;}}</style></head><body onload="window.print()"><div style="max-width: 800px"><h1>информация  отсутствует</h1></div><body></html>'}function getLink(t,u){if(!t||!u)return null;var d=global.get("store").val.domain;switch(console.log("global.get('store').val.domain",global.get("store").val.domain),t){case"stuffs":return d+"/group/category/"+u;case"categories":return d+"/group/"+u;case"brandTags":return d+"/group/category?brandTag="+u;case"brands":return d+"/group/category?brand="+u;case"filterTags":return d+"/group/category?queryTag="+u;case"campaign":return d+"/camapign/"+u}}function emailFromNews(item){var s='<table width="100%" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr width="100%" style="max-width:900px;"><td style="text-align: center; padding: 5px"><a href="'+global.get("store").val.link+'"><img  style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></a></td></tr><tr width="100%" style="max-width:900px;"><td style="text-align: center; padding: 5px; font-size: 20px;"><h3>usernameforreplace</h3></td></tr><tr width="100%"><td><h2 style="font-weight: 500; letter-spacing: 2px; text-transform: uppercase; text-align: center; color: #333333; font-family:  Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.name+"</h2></td></tr>";if(s+="</table>",s+='<table class="table-mobile" width="100%" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333; border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0 " border="0">',item.blocks&&item.blocks.length&&item.blocks.forEach(function(block){if(block.name&&(s+="text2"==block.type?'<tr width="100%" style="max-width:900px;"><td style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+(block.name?block.name:"")+'</h3></td><td style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+(block.name1?block.name1:"")+"</h3></td></tr>":'<tr width="100%" style="max-width:900px;"><td colspan="2" style="padding: 5px"><h3 style="text-align: center; color: :#333333; font: 22px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none; text-transform: uppercase">'+block.name+"</h3></td></tr>"),block.img&&(s+='<tr width="100%" style="max-width:900px;"><td  colspan="2" width="100%" style=" padding: 5px" >',block.link&&(s+='<a href="'+global.get("store").val.link+block.link+'" style="cursor: pointer;">'),s+='<img alt="" style="width: 100%;margin-bottom: 10px; display: block" src="'+photoHostForFactory+"/"+block.img+'">',block.link&&(s+="</a>"),s+="</td></tr>"),block.desc&&(s+="text2"==block.type?'<tr width="100%" style="max-width:900px;"><td style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+(block.desc?block.desc:"")+'</span></td><td style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+(block.desc1?block.desc1:"")+"</span></td></tr>":'<tr width="100%" style="max-width:900px;"><td colspan="2" style="padding: 5px"><span style="text-align: justify;  color: :#333333; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.desc+"</span></td></tr>"),block.imgs&&block.imgs.length)for(var i=0,l=block.imgs.length;i<l;i+=2){s+="<tr>";var link1;if(block.imgs[i].link?link1=block.imgs[i].link.indexOf("http")<0?global.get("store").val.link+block.imgs[i].link:block.imgs[i].link:block.imgs[i].url&&(link1=getLink(block.type,block.imgs[i].url)),s+='<td style="padding: 5px; text-align: center;vertical-align: top">',link1&&(s+='<a href="'+link1+'">'),s+='<img alt="" style="width: 100%; display: block" src="'+photoHostForFactory+"/"+block.imgs[i].img+'">',block.imgs[i].name&&(s+='<span style="font-weight: 700; color: #666666; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.imgs[i].name+"</span>"),link1&&(s+="</a>"),s+="</td>",block.imgs[i+1]){var link2;block.imgs[i+1].link?block.imgs[i].link.indexOf("http")<0?link2=global.get("store").val.link+block.imgs[i+1].link:block.imgs[i+1].link&&(link2=block.imgs[i+1].link):link1=getLink(block.type,block.imgs[i+1].url),s+='<td style="padding: 5px; text-align: center;vertical-align: top">',link2&&(s+='<a href="'+link2+'">'),s+='<img alt="" style="width: 100%; display: block" src="'+photoHostForFactory+"/"+block.imgs[i+1].img+'">',block.imgs[i+1].name&&(s+='<span style="font-weight: 700; color: #666666; font: 18px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+block.imgs[i+1].name+"</span>"),link2&&(s+="</a>"),s+="</td>"}else s+='<td style="padding: 5px; text-align: center;vertical-align: top"></td>';s+="</tr>"}}),s+="</table>",s+='<table width="900px" cellpadding="0" cellspacing="0" style="color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr><td border="0" colspan="2" style="border:none; border-top:#cccccc 5px solid;"></td></tr><tr><td align="right" style="vertical-align: top"><span style="font-family:Tahoma; font-size:12px; color:#404040;">',global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 15px 5px" src="'+global.get("store").val.link+"/views/template/img/icon/sn_grey/"+key+'.png"></a>');return s+='</span><td align="right"><span style="font-family:Tahoma; font-size:14px; color:#404040;">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),s+="</span></td></tr></table>"}function emailBonus(stuffs){var item,s='<table width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr width="100%" style="max-width:600px;"><td style="text-align: center; padding: 5px"><img alt="посмотреть на сайте" style="width: 100px;" src="'+photoHostForFactory+"/"+global.get("store").val.logo+'"></td></tr><tr width="100%"><td><h2 style="font-weight: 500; letter-spacing: 2px; text-transform: uppercase; text-align: center; color: #333333; font-family:  Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">бонусы</h2></td></tr>';if(s+="</table>",stuffs.forEach(function(stuff){if(item=stuff,item.imgs&&item.imgs.length){s+='<table class="table-mobile" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px;color: #333333; border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0">';for(var i=0,l=item.imgs.length;i<l;i++)item.imgs[i].name&&(s+='<tr width="100%" style="max-width:600px;"><td style=" padding: 5px"><p style="color: #333333; font: 16px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.imgs[i].name+"</p></td></tr>"),s+='<tr><td style="padding: 5px;"><img alt="бонусный купон"  style="width: 100%; display: block"   src="'+photoHostForFactory+"/"+item.imgs[i].img+'"></td>',s+="</tr>",item.imgs[i].desc&&(s+='<tr width="100%" style="max-width:600px;"><td style=" padding: 5px"><p style="color: #333333; font: 16px Arial, sans-serif; line-height: 30px; -webkit-text-size-adjust:none;">'+item.imgs[i].desc+"</p></td></tr>");s+="</table>"}}),s+='<table width="600px" cellpadding="0" cellspacing="0" style="color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr><td border="0" colspan="2" style="border:none; border-top:#cccccc 5px solid;"></td></tr><tr><td align="left" style="vertical-align: top"><span style="font-family:Tahoma; font-size:12px; color:#404040;">',global.get("store").val.sn)for(var key in global.get("store").val.sn)global.get("store").val.sn[key].is&&(s+='<a href="'+global.get("store").val.sn[key].link+'"><img style="width: 24px; height: 24px;margin: 15px 5px" src="'+global.get("store").val.link+"/views/template/img/icon/sn_natur/"+key+'.png"></a>');return s+='</span><td align="right"><span style="font-family:Tahoma; font-size:16px; color:#404040;">',global.get("store").val.footer&&global.get("store").val.footer.text&&(s+=global.get("store").val.footer.text),'<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><div>'+(s+="</span></td></tr></table>")+"</div></html>"}function orderNote(order){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.order+" № "+order.num+"</h3> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),s+="<p>"+global.get("langOrder").val.sum+" "+order.paySum.toFixed(2)+" "+order.currency+"</p>"}function dateTimeNote(entry){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.dateTime+"</h3> "+global.get("langOrder").val.onn+" "+entry.dateForNote,s+="<p>"+global.get("store").val.texts.masterName[global.get("store").val.lang]+" - "+entry.masterName+"</p>",s+="<p>"+entry.service.name+"</p>"}function dateTimeCancelNote(entry){var s="";return s+='<h3 class="order-name">'+global.get("langOrder").val.dateTime+'<span style="color:red"> '+global.get("langOrder").val.removed+"</span></h3> "+global.get("langOrder").val.onn+" "+entry.dateForNote,s+="<p>"+global.get("store").val.texts.masterName[global.get("store").val.lang]+" - "+entry.masterName+"</p>",s+="<p>"+entry.service.name+"</p>",s+="<p>"+entry.user.name+"- "+entry.user.phone+"</p>"}function order(order,invoice,commentPrint){var lang=global.get("store").val.lang,texts=global.get("store").val.texts,user=order.profile&&order.profile.admin?order.profile.admin:order.profile.fio;user||(user=order.user.name);var orderMailText=texts.orderMailText&&texts.orderMailText[lang]?texts.orderMailText[lang]:"";order.profile&&order.profile.admin&&(orderMailText="");var name=global.get("langOrder").val.order+" № "+order.num+"<small> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</small>",status=global.get("langOrder").val.entered.toUpperCase();2==order.status?status=global.get("langOrder").val.accepted.toUpperCase():3==order.status?status=global.get("langOrder").val.statuspaid.toUpperCase():4==order.status?status=global.get("langOrder").val.statussent.toUpperCase():5==order.status&&(status=global.get("langOrder").val.statusdelivered.toUpperCase()),user=global.get("langOrder").val.hello+", "+user+"!";var s=getHeader(name);s+='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr  width="100%"><td colspan="2" style="padding: 0 20px;"><h3 style="font-size: 24px">'+user+"</h3></td></tr>",1==order.status&&(s+='<tr  width="100%"><td colspan="2" style="padding: 0 20px"><p>'+orderMailText+"</p></td></tr>"),s+='<tr style="max-width:900px;"><td width="50%" style="max-width:900px;padding: 10px 20px;font-size: 16px;vertical-align: top"><h4 style="font-weight: bold">'+status+'</h4><h4 style="font-weight: bold">'+global.get("langOrder").val.order.toUpperCase()+" № "+order.num+'</h4><p style="margin-bottom: 30px">'+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</p>",commentPrint&&order.comment&&(s+='<div><h4 style="font-weight: bold">'+global.get("langOrder").val.comments+"</h4><p>"+order.comment+"</p></div>"),invoice&&order.payInfo&&(s+='<h4 style="font-weight: bold">'+global.get("langOrder").val.forpayment+"</h4>",s+="<p>"+order.payInfo+"</p>"),invoice&&order.checkOutLiqpayHtmlIs&&(s+="<p>"+order.checkOutLiqpayHtml+"</p>"),s+="</td>",s+='<td style=" padding: 10px 20px; font-size: 16px;vertical-align: top;">',s+='<h4 style="font-weight: bold">'+global.get("langOrder").val.customerdata+"</h4>",s+="<p> e-mail - "+order.user.email+"</p>",order.profile.fio&&(s+="<p> "+global.get("langOrder").val.name+"  - "+order.profile.fio+"</p>"),order.profile.phone&&(s+="<p> "+global.get("langOrder").val.phone+" - "+order.profile.phone+"</p>"),order.profile.city&&(s+="<p> "+global.get("langOrder").val.city+"  - "+order.profile.city+"</p></div>"),s+="</td></tr></table>",s+='<table style="margin: 20px" width="860px" cellspacing="0" cellpadding="5" border="1px">',s+='<thead><tr><th style="padding: 10px">#</th><th style="padding: 10px">'+global.get("langOrder").val.title+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.species+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.price+"</th>",s+='<th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.quantity+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.sum+"</th></tr></thead>",s+="<tbody>";for(var cart=order.cart.stuffs,j=0,lj=cart.length;j<lj;j++){var good=cart[j];s+='<tr><td style="padding: 10px">'+(j+1)+'</td><td style="padding: 10px"> '+good.name+" "+(good.artikul?good.artikul:"")+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(good.sortName?good.sortName:"")+'</td><td class="text-center" style="padding: 10px; text-align: center">'+(order.kurs*good.cena).toFixed(2)+" "+order.currency+'</td><td class="text-center" style="padding: 10px; text-align: center">'+good.quantity+'</td><td class="text-center">'+(order.kurs*good.sum).toFixed(2)+" "+order.currency+"</td></tr>"}s+="</tbody>",s+='<tbody class="cart-item-total">',
s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.sum+'</th><th class="text-center" style="padding: 10px; text-align: center">'+order.getTotalQuantity()+'</th><th style="padding: 10px; text-align: center" class="text-center">'+(order.kurs*(order.sum0?order.sum0:order.sum)).toFixed(2)+" "+order.currency+"</th></tr>",order.discount&&(s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.withdiscount+"</th>",s+=order.sum<order.sum0?'<th class="text-center"  style="padding: 10px; text-align: center">'+Math.round(100*(1-order.sum/order.sum0))+"%</th>":'<th class="text-center" style="padding: 10px; text-align: center"></th>',s+='<th class="text-center"  style="padding: 10px; text-align: center">'+(order.kurs*order.sum).toFixed(2)+" "+order.currency+"</th></tr>"),order.coupon&&order.coupon._id&&(s+='<tr><th colspan="4" style="padding: 10px">'+global.get("langOrder").val.basedcoupon+'</th><th></th><th class="text-center"  style="padding: 10px; text-align: center">'+(order.kurs*order.getCouponSum()).toFixed(2)+" "+order.currency+"</th></tr>");order.getTotalDiscount();return order.shipCost&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.delivery+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.shipCost.toFixed(2)+" "+order.currency+"</th></tr>"),order.totalPay&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.paid+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.totalPay.toFixed(2)+" "+order.currency+"</th></tr>"),order.paySum!=order.getCouponSum()&&(s+='<tr><th colspan="4">'+global.get("langOrder").val.totaltopay+'</th><th></th><th class="text-center" style="padding: 10px; text-align: center">'+order.paySum.toFixed(2)+" "+order.currency+"</th></tr>"),s+="</tbody></table></div></div></div>",'<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://gmall.io/bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+(s+=getFooter())+"</div></html>"}function orderShipInfo(order){var shipDetail=order.shipDetail,name=(global.get("store").val.lang,global.get("store").val.texts,global.get("langOrder").val.order+" № "+order.num+"<small> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</small>"),user=global.get("user").val.profile.fio||global.get("user").val.name,status=global.get("langOrder").val.entered.toUpperCase();2==order.status?status=global.get("langOrder").val.accepted.toUpperCase():3==order.status?status=global.get("langOrder").val.statuspaid.toUpperCase():4==order.status?status=global.get("langOrder").val.statussent.toUpperCase():5==order.status&&(status=global.get("langOrder").val.statusdelivered.toUpperCase()),user=global.get("langOrder").val.hello+", "+user+"!";var s=getHeader(name);return s+='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr  width="100%"><td colspan="2" style="padding: 20px;"><h3 style="font-size: 24px">'+user+"</h3></td></tr></table>",s+='<table width="900px" cellpadding="0" cellspacing="0" style="max-width:900px;color: #333333;border-collapse:collapse; border:none;table-layout: fixed; padding: 0;margin: 0" border="0"><tr style="max-width:900px;"><td width="50%" style="max-width:900px;padding: 10px 20px;font-size: 16px;vertical-align: top"><h4 style="font-weight: bold">'+global.get("langOrder").val.order.toUpperCase()+" № "+order.num+"</h4><p>"+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+'</p><h4 style="font-weight: bold;margin-bottom: 30px">'+status+'</h4><h4 style="font-weight: bold">'+global.get("langOrder").val.aboutdelivery+"</h4></td></tr></table>",shipDetail&&shipDetail.length?(s+='<table style="margin: 20px" width="860px" cellspacing="0" cellpadding="5" border="1px">',s+='<thead><tr><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.title+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.where+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.waybill+'</th><th class="text-center"  style="padding: 10px; text-align: center">'+global.get("langOrder").val.date+'</th><th class="text-center" style="padding: 10px; text-align: center">'+global.get("langOrder").val.sum+"</th>",shipDetail.forEach(function(ship){s+='<tr><td style="padding: 10px">',ship.stuffs.forEach(function(stuff){s+='<div style="width:80%;float:left">'+stuff.name+'</div><div style="float:left">'+stuff.qty+(stuff.unitOfMeasure?" "+stuff.unitOfMeasure:"")+'</div><div style="clear: both"></div><hr/>'}),s+=ship.qty,s+='</td><td style="padding: 10px; vertical-align: top">'+(ship.info||"")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+(ship.ttn||"")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+moment(ship.date).format("LLL")+"</td>",s+='<td style="padding: 10px; vertical-align: top">'+(ship.sum||0).toFixed(2)+"&nbsp;"+order.currency+"</td></tr>"}),s+="</table></br></br>"):s+="<h1>"+global.get("langOrder").val.infisnot+"</h1>",'<!DOCTYPE html><html><head><link rel="stylesheet" type="text/css" href="http://gmall.io/bower_components/bootstrap/dist/css/bootstrap.css" /></head><body onload="window.print()"><div class="reward-body">'+(s+=getFooter())+"</div></html>"}function shipInfoNote(order){var s="";return s+="<h3>"+global.get("langOrder").val.order+" № "+order.num+"</h3><br/> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p>"+global.get("langOrder").val.totaltopay+" <strong>"+order.paySum.toFixed(2)+" </strong>"+order.currency+"</p>",s+="<p>"+global.get("langOrder").val.sentshipinfo+"</p>"}function shipInfo(order,ship){if(ship.ttn&&ship.info){var s="<h3>"+global.get("langOrder").val.aboutdelivery+" </h3>";return global.get("langOrder").val.onawarrant,order.num,global.get("langOrder").val.from,moment(order.date).format("lll"),s+="<strong>"+global.get("langOrder").val.waybill+" - "+ship.ttn||"</strong> "+global.get("langOrder").val.from+" "+moment(ship.date).format("LL")+"</p>",ship.info&&(s+="<p>"+ship.info.substring(0,250)+"</p>"),ship.sum&&(s+="<strong>"+ship.sum.toFixed(2)+" "+order.currency+"</strong>"),ship.stuffs&&ship.stuffs.length&&(s+="<strong>  "+ship.stuffs.length+" ед.</strong>"),s}}function payInfo(order,pay){if(pay.sum){var s="<h3>"+global.get("langOrder").val.makepayment+" </h3>";return s+="<p>"+global.get("langOrder").val.onawarrant+" №"+order.num+"<br> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+"</p>",s+="<p><strong>"+pay.sum.toFixed(2)+" "+order.currency+"</strong></p> "+moment(pay.date).format("LL"),pay.info&&(s+="<p>"+pay.info.substring(0,150)+"</p>"),s}}function acceptedInfo(order){var s="<h3>"+global.get("langOrder").val.byorders+" №"+order.num+"</h3>";return s+=" "+global.get("langOrder").val.from+" "+moment(order.date).format("lll")+".",order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p><strong>"+global.get("langOrder").val.accepted+" </strong></p>"}function invoiceInfo(order){var s="";return s+="<h3>"+global.get("langOrder").val.order+" № "+order.num+"</h3><br/> "+global.get("langOrder").val.from+" "+moment(order.date).format("lll"),order.user.profile&&(s+=order.user.profile.fio?"<p>"+order.user.profile.fio+"</p>":"<p>"+order.user.name+"</p>",order.user.profile.phone&&(s+="<p>"+order.user.profile.phone+"</p>")),s+="<p>"+global.get("langOrder").val.totaltopay+" <strong>"+order.paySum.toFixed(2)+" </strong>"+order.currency+"</p>",s+="<p>"+global.get("langOrder").val.sentthepost+"</p>"}function call(number){var s="";return s+="<h3>"+number+"</h3>",s+="<p>"+global.get("langOrder").val.requestacallback+"</p>",s+="<p>"+moment().format("LLLL")+"</p>"}if(void 0===photoHost)var photoHost;var photoHostForFactory;return $timeout(function(){photoHostForFactory=photoHost?photoHost:global.get("store").val.link},1e3),{empty:empty,order:order,orderNote:orderNote,dateTimeNote:dateTimeNote,shipInfo:shipInfo,payInfo:payInfo,invoiceInfo:invoiceInfo,acceptedInfo:acceptedInfo,orderShipInfo:orderShipInfo,call:call,emailFromNews:emailFromNews,emailBonus:emailBonus,shipInfoNote:shipInfoNote,dateTimeCancelNote:dateTimeCancelNote}}]),angular.module("gmall.services").service("$order",["localStorage","global","Orders","$q","$uibModal","CartInOrder","exception","$email","CreateContent","$notification","$state","$window","Coupon","$user","$rootScope","$timeout","$http",function(localStorage,global,Orders,$q,$uibModal,CartInOrder,exception,$email,CreateContent,$notification,$state,$window,Coupon,$user,$rootScope,$timeout,$http){function shipInfoCtrl($uibModalInstance,$rootScope){var self=this;$rootScope.$on("closeShipModal",function(){$uibModalInstance.close()}),self.ok=function(){$uibModalInstance.close()},self.cancel=function(){$uibModalInstance.dismiss()}}var order,storageName;this.type=null,this.reinitCart=function(){order.comment="",delete order.action,delete order._id,delete order.num,delete order.date,delete order.seller;var seller=global.get("store").val.seller;order.setSellerData(seller._id,seller.cascade,seller.opt)},this.initOrderInList=function(res){var order=myShareData.getOrder(),mainCurrency=(global.get("campaign")&&global.get("campaign").val,global.get("store").val.mainCarrency),currencyStore=global.get("store").val.currency;global.get("currency")&&global.get("currency").val&&global.get("currency").val,global.get("store").val.seller;return order.type="order",order._id=res._id,order.init(res.campaign,mainCurrency,currencyStore),order.setCurrency(res.currency),order.kurs=order.currencyStore[order.currency][0],order.payInfo=res.seller.payInfo,order.setSellerData(res.seller,res.cascade,res.opt),order.unitOfMeasure=order._getUnitOfMeasure(),order.cart._id=res.cart,order.setDiscount(res.discount),order.setCoupon(res.coupon),order.date=res.date,order.date2=res.date2,order.date3=res.date3,order.date4=res.date4,order.date5=res.date5,order.invoice=res.invoice,order.invoiceInfo=res.invoiceInfo,order.pay=res.pay,order.shipCost=res.shipCost,order.num=res.num,order.status=res.status,order.profile=res.profile,order.comment=res.comment,order.note=res.note,order.user=res.user,order.shipDetail=res.shipDetail,order.domain=global.get("store").val.domain||global.get("store").val.subDomain,order.paySum=res.paySum,order},this.init=function(type,id){storageName=global.get("store").val._id;var q=$q.defer();order=myShareData.getOrder();var campaign=global.get("campaign")?global.get("campaign").val:null,mainCurrency=global.get("store").val.mainCarrency,currencyStore=global.get("store").val.currency,currency=global.get("currency")&&global.get("currency").val?global.get("currency").val:"UAH",seller=global.get("store").val.seller;if(this.type=type,order.type=type,"cart"==type){order.init(campaign,mainCurrency,currencyStore),order.setSellerData(seller._id,seller.cascade,seller.opt),order.setCurrency(currency),order.kurs=order.currencyStore[order.currency][0];var o=localStorage.get(storageName);o||(o=[],localStorage.set(storageName,o)),order.setCart(o),order.unitOfMeasure=order._getUnitOfMeasure(),order.totalCount=order._cartCount(),q.resolve(order)}else"order"==type&&(Orders.get({_id:id},function(res){res&&res._id||q.reject("404"),order._id=res._id,order.init(res.campaign,mainCurrency,currencyStore),order.setCurrency(res.currency),order.kurs=order.currencyStore[order.currency][0],order.payInfo=res.seller.payInfo,order.setSellerData(res.seller,res.cascade,res.opt),order.setCart(res.cart.stuffs),order.unitOfMeasure=order._getUnitOfMeasure(),order.cart._id=res.cart._id,order.setDiscount(res.discount),order.setCoupon(res.coupon),order.totalCount=order._cartCount(),order.date=res.date,order.date2=res.date2,order.date3=res.date3,order.date4=res.date4,order.date5=res.date5,order.invoice=res.invoice,order.invoiceInfo=res.invoiceInfo,order.pay=res.pay,order.shipCost=res.shipCost,order.num=res.num,order.status=res.status,order.profile=res.profile,order.comment=res.comment,order.note=res.note,order.user=res.user,order.shipDetail=res.shipDetail,order.domain=global.get("store").val.domain||global.get("store").val.subDomain,q.resolve(order)},function(err){q.reject(order)}),order.totalCount=order._cartCount());return q.promise},this.getOrder=function(){return order},this.addItemToCart=function(itemTo){itemTo.seller=global.get("seller").val,itemTo.img=itemTo.gallery&&itemTo.gallery.length&&itemTo.gallery[0].thumbSmall?itemTo.gallery[0].thumbSmall:"",itemTo.quantity||(itemTo.quantity=1),order.addStuffToOrder(itemTo),this.updateOrder(itemTo)},this.checkInCart=function(item){return order.checkInCart(item)},this.updateOrder=function(itemTo){order.totalCount=order._cartCount(),order.unitOfMeasure=order._getUnitOfMeasure(),itemTo&&$rootScope.$broadcast("$updateOrder",itemTo),"cart"==this.type?(localStorage.set(storageName,order.cart.stuffs),order.totalCount=order._cartCount()):$timeout(function(){},100).then(function(){var o=angular.copy(order.cart);return o.order=order._id,CartInOrder.save(o).$promise}).then(function(){return order.priceSaleHandle=order.cart.stuffs.some(function(s){return s.priceSaleHandle}),order.maxDiscountOver=order.cart.stuffs.some(function(s){return s.maxDiscountOver}),Orders.save({update:"totalCount sum paySum maxDiscountOver priceSaleHandle"},{_id:order._id,totalCount:order.totalCount,sum:order.sum,paySum:order.paySum,priceSaleHandle:order.priceSaleHandle,maxDiscountOver:order.maxDiscountOver}).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)}).catch(function(error){exception.catcher("сохранение изменений")(error)})},this.removeItem=function(i){order.cart.stuffs.splice(i,1),this.updateOrder()},this.decreaseQty=function(i){var stuff=order.cart.stuffs[i];stuff&&stuff.quantity>1&&(stuff.multiple&&stuff.minQty?stuff.quantity-1>=stuff.minQty&&(stuff.quantity--,this.updateOrder()):(stuff.quantity--,this.updateOrder()))},this.increaseQty=function(i){var stuff=order.cart.stuffs[i];stuff&&(stuff.single&&stuff.maxQty?stuff.quantity+1<=stuff.maxQty&&(stuff.quantity++,this.updateOrder()):(stuff.quantity++,this.updateOrder()))},this.clearCart=function(){order.clearOrder(),this.updateOrder()},this.cartCount=function(){return order.totalCount},this.sendOrder=function(user){return $q.when().then(function(){try{if(user){if(!user._id)throw conosole.log(user),"не авторизирован!"}else{if(!global.get("user").val||!global.get("user").val._id)throw"не авторизирован!";order.user=global.get("user").val,order.profile=angular.copy(global.get("user").val.profile)}order.action="order",order.comment?order.comment.clearTag(400):order.comment="",order.coupon&&order.coupon._id?order.paySum=order.kurs*order.getCouponSum():order.paySum=order.kurs*order.getTotalSum()}catch(err){throw err}}).then(function(){return $q(function(resolve,reject){if(order.coupon&&order.coupon._id)if(global.get("user").val.coupons||(global.get("user").val.coupons=[]),global.get("user").val.coupons.indexOf(order.coupon._id)>-1)order.coupon=null,resolve();else{Date.now();Coupon.get({_id:order.coupon._id},function(coupon){coupon?(global.get("user").val.coupons||(global.get("user").val.coupons=[]),global.get("user").val.coupons=global.get("user").val.coupons.filter(function(el){return el}),global.get("user").val.coupons.push(coupon._id),$user.save({update:"coupons"},{_id:global.get("user").val._id,coupons:global.get("user").val.coupons},function(res){resolve()},function(err){if(err)return reject(err)})):(order.coupon=null,resolve())})}else resolve()})}).then(function(){return Orders.save(order).$promise}).then(function(res){if(!res.num||!res._id)throw"заказ не отправлен. произошла ошибка на сервере. не присвоен номер ордеру";try{order._id=res.id,order.num=res.num,order.date=Date.now(),order.seller=global.get("store").val.seller,order.status=1}catch(err){throw err}}).then(function(){if(global.get("store").val.seller.salemail){try{order.profile.admin="Admin";var email=global.get("store").val.seller.salemail,content=CreateContent.order(order,!1,!0);delete order.profile.admin;var domain=global.get("store").val.domain,subj=global.get("langOrder").val.neworder?global.get("langOrder").val.neworder.toUpperCase()+" ✔":"НОВЫЙ ЗАКАЗ ✔",o={email:email,content:content,subject:subj,from:global.get("store").val.name+"<sales@"+domain+">"}}catch(err){throw err}return $q(function(resolve,reject){$email.save(o,function(res){exception.showToaster("note",global.get("langNote").val.emailSent,""),resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}}).then(function(){try{order.user=user?user:global.get("user").val;var email=user?user.email:global.get("user").val.email,content=CreateContent.order(order,!1,!0),domain=global.get("store").val.domain,subj=global.get("langOrder").val.neworder?global.get("langOrder").val.neworder.toUpperCase()+" ✔":"НОВЫЙ ЗАКАЗ ✔",o={email:email,content:content,subject:subj,from:global.get("store").val.name+"<sales@"+domain+">"}}catch(err){throw err}return $q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){exception.showToaster("warning",global.get("langNote").val.error,err.data),resolve()})})}).then(function(){try{var content=CreateContent.orderNote(order),o={addressee:"seller",type:"order",content:content,order:order._id,num:order.num,seller:order.seller._id}}catch(err){throw err}return $q(function(resolve,reject){$notification.save(o,function(res){exception.showToaster("note",global.get("langNote").val.sent,""),resolve()},function(err){exception.catcher("error")(err),resolve()})})}).then(function(){try{var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","order");pap&&pap.url?$state.go("thanksPage",{id:pap.url}):exception.showToaster("note",global.get("langNote").val.orderSuccess,"")}else exception.showToaster("note",global.get("langNote").val.orderSuccess,"")}catch(err){throw err}}).catch(function(err){throw err})},this.changeCurrency=function(lan){order.changeCurrency(lan)},this.checkCampaign=function(stuff){return order&&order.type?order.checkCampaign(stuff):null},this.checkOutFromList=function(user){return order.comment=user.comment?user.comment:"",order.profile=user.profile,order.user=user._id,order.seller=global.get("store").val.seller._id,this.sendOrder(user)},this.getShipInfo=function(){return $q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/order/modal/shipInfo.html",controller:shipInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})},shipInfoCtrl.$inject=["$uibModalInstance","$rootScope"],this.getCheckOutLiqpayHtml=function(order,invoice){return $q.when().then(function(){return invoice?$http.post("/api/orders/checkoutLiqpayInvoice",order):$http.post("/api/orders/checkoutLiqpay",order)}).then(function(res){res&&res.data.html&&(order.checkOutLiqpayHtml=res.data.html,order.checkOutLiqpayHtmlIs=!0)}).then(function(res){}).catch(function(err){exception.catcher("error")(err)})}}]).factory("localStorage",function(){return{getB:function(item){return JSON.parse(localStorage.getItem(item)||"false")},getN:function(item){var i=localStorage.getItem(item);return"undefined"!=i?JSON.parse(i):""},get:function(item){return JSON.parse(localStorage.getItem(item)||"[]")},set:function(item,value){localStorage.setItem(item,JSON.stringify(value))}}}),function(){function orderService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response&&response.length&&response.forEach(function(o){o.totalPay=o.pay&&o.pay.length?o.pay.reduce(function(s,i){return s+=i.sum},0):0}),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(o){return o}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Order/:_id",{_id:"@_id"});return this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,{getList:getList,getItem:getItem,get:Items.get,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("Orders",orderService),orderService.$inject=["$resource","$uibModal","$q"]}(),function(){function cartInOrderService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/CartInOrder/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,get:Items.get,save:Items.save,delete:Items.delete}}angular.module("gmall.services").service("CartInOrder",cartInOrderService),cartInOrderService.$inject=["$resource","$uibModal","$q"]}(),function(){function itemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/cart.html"}}function previewCartDirective(){return{scope:{},restrict:"EA",bindToController:!0,controller:previewCartCtrl,controllerAs:"$ctrl",transclude:!0,templateUrl:"views/template/partials/cart/previewCart.html"}}function addedCartDirective(){return{scope:{},bindToController:!0,controller:function($scope,$element,$timeout,global){$($element).fadeOut();var self=this;self.global=global,self.addItem=null;var timer=null;$scope.$on("$updateOrder",function(event,itemTo){self.addItem=angular.copy(itemTo),timer?$timeout.cancel(timer):$($element).fadeIn(),timer=$timeout(function(){self.addItem=null,timer=null,$($element).fadeOut()},2500)}),$($element).hover(function(){timer&&($timeout.cancel(timer),timer=null)},function(){$($element).fadeOut()}),$($element).click(function(){$($element).fadeOut()})},controllerAs:"$ctrl",templateUrl:"views/template/partials/cart/addedCart.html"}}function itemCtrl($scope,$anchorScroll,$order,global,exception,Confirm,$user,$q,CreateContent,$email,$notification,$state,$rootScope,$timeout){function _setCoupons(){self.coupons=null,global.get("coupons")&&global.get("coupons").val&&global.get("coupons").val.length&&global.get("coupons").val.forEach(function(c){global.get("user").val?global.get("user").val.coupons.indexOf(c._id)<0&&(self.coupons||(self.coupons=[]),self.coupons.push(c)):(self.coupons||(self.coupons=[]),self.coupons.push(c))}),self.coupon=null,global.get("coupons")&&global.get("coupons").val&&global.get("user").val?global.get("coupons").val[0]&&global.get("user").val.coupons.indexOf(global.get("coupons").val[0]._id)<0?self.coupon=global.get("coupons").val[0]:global.get("coupons").val[1]&&global.get("user").val.coupons.indexOf(global.get("coupons").val[1]._id)<0&&(self.coupon=global.get("coupons").val[1]):!global.get("user").val&&global.get("coupons")&&global.get("coupons").val&&(self.coupon=global.get("coupons").val[0])}function clearCart(){Confirm(global.get("langNote").val.clean+"?").then(function(){$order.clearCart()}).catch(function(err){(err=err&&err.data||err)&&exception.catcher(global.get("langNote").val.error)(err)})}function removeItem(i){Confirm(global.get("lang").val.delete+"?").then(function(){$order.removeItem(i)})}function saveCart(stuff){stuff?stuff.quantity&&(stuff.quantity>stuff.maxQty?(stuff.quantity=stuff.maxQty,exception.catcher(global.get("langNote").val.error)("слишком много")):stuff.quantity<stuff.minQty?(stuff.quantity=stuff.minQty,exception.catcher(global.get("langNote").val.error)("слишком мало")):$order.updateOrder()):$order.updateOrder()}function decreaseQty(i){$order.decreaseQty(i)}function increaseQty(i){$order.increaseQty(i)}function checkOut(){$rootScope.$emit("InitiateCheckout"),self.order.cart.stuffs.length&&(global.get("store").val.cartSetting&&global.get("store").val.cartSetting.slide?global.get("user").val&&global.get("user").val._id?forward(2):forward():(self.order=$order.getOrder(),$q.when().then(function(){return global.get("user").val&&global.get("user").val._id?void 0:$user.login()}).then(function(){return $order.getShipInfo()}).then(function(){return sendOrder()})))}function sendOrder(){return $q.when().then(function(){return $rootScope.$emit("$stateChangeStartToStuff"),$order.sendOrder()}).then(function(){}).then(function(){$rootScope.$emit("$stateChangeEndToStuff"),$rootScope.$emit("Purchase",{value:$order.paySum,currency:$order.currency}),$order.reinitCart(),$rootScope.order=$order.getOrder(),self.order.setCoupon(null),_setCoupons(),$order.clearCart(),$rootScope.checkedMenu.cart=!1}).then(function(){return $user.saveProfile(global.get("user").val)}).catch(function(err){if($rootScope.$emit("$stateChangeEndToStuff"),err){if(console.log("errerrerr ",err),err.data)var content=JSON.stringify(err.data);else var content=JSON.stringify(err,["message","arguments","type","name"]);global.get("user").val&&(content+="\r"+global.get("user").val.email),$order.getOrder()&&(content+="\r"+JSON.stringify($order.getOrder(),null,4));var domain=global.get("store").val.domain,o={email:["igorchugurov@gmail.com","vikachugurova@gmail.com"],content:content,subject:"error in order ✔",from:global.get("store").val.name+"<"+global.get("store").val.subDomain+"@"+domain+">"};$q(function(resolve,reject){$email.save(o,function(res){resolve()},function(err){resolve()})}),err&&exception.catcher(global.get("langNote").val.error)(err)}})}function enableCheckOut(){return!(!self.order.totalCount||!self.order.cart.stuffs.length)&&!(self.opt>1&&!retail&&self.order.totalCount<self.opt)}function goToStuff(o){var states=$state.get();states.some(function(state){return"frame.stuffs.stuff"==state.name})?$state.go("frame.stuffs.stuff",o):states.some(function(state){return"stuffs.stuff"==state.name})&&$state.go("stuffs.stuff",o)}function disabledCheckOut(){if(!self.order.cart.stuffs.length)return!0}function back(){2==self.currentBlock&&global.get("user").val&&(self.currentBlock=1),self.currentBlock&&self.currentBlock--}function forward(num){num?self.currentBlock+=num:self.currentBlock++,console.log(self.currentBlock)}function setSlide(s){self.currentBlock=s}function getFilterName(tag){var t=global.get("filterTags").val.getOFA("_id",tag);if(t&&t.filter){var f=global.get("filters").val.getOFA("_id",t.filter);return f?f.name:""}return""}function setCouponForOrder(c,e){e.stopPropagation(),self.order.setCoupon(c)}var self=this;$scope.myInterval=2e3,$scope.noWrapSlides=!0,$scope.active33=2;var slides=$scope.slides=[],currIndex=0;$scope.addSlide=function(){var newWidth=600+slides.length+1;slides.push({image:"//unsplash.it/"+newWidth+"/300",text:["Nice image","Awesome photograph","That is so cool","I love that"][slides.length%4],id:currIndex++})},$scope.randomize=function(){var indexes=generateIndexesArray();assignNewIndexesToSlides(indexes)};for(var i=0;i<4;i++)$scope.addSlide();self.currentBlock=0;self.global=global,self.mobile=global.get("mobile").val,self.opt=global.get("store").val.seller.opt&&global.get("store").val.seller.opt.quantity?global.get("store").val.seller.opt.quantity:0;var retail=global.get("store").val.seller.retail;self.disabledMessage=self.opt>1&&!retail,self.countryCode=global.get("country"),self.clearCart=clearCart,self.removeItem=removeItem,self.saveCart=saveCart,self.checkOut=checkOut,self.enableCheckOut=enableCheckOut,self.goToStuff=goToStuff,self.disabledCheckOut=disabledCheckOut,self.back=back,self.getFilterName=getFilterName,self.decreaseQty=decreaseQty,self.increaseQty=increaseQty,self.setCouponForOrder=setCouponForOrder,function(){$order.type&&"cart"==$order.type?self.order=$order.getOrder():$order.init("cart").then(function(order){self.order=order}),console.log(self.order),$anchorScroll(),_setCoupons(),$scope.$on("logged",function(){_setCoupons()}),global.get("store").val.cartSetting&&global.get("store").val.cartSetting.slide&&setSlide(0)}(),$rootScope.$on("cartslide",function(event,data){console.log(data),data&&("shipInfoDone"==data.event?sendOrder():"shipInfoDone"==data.event?setSlide(0):"signLogin"==data.event?forward():"init"==data.event&&setSlide(0))})}function previewCartCtrl($scope,$anchorScroll,global,exception,$q,$state,$order,$element,$timeout,$rootScope){function activate(){$order.type&&"cart"==$order.type?self.order=$order.getOrder():$order.init("cart").then(function(order){self.order=order}),$anchorScroll(),self.loaded=!0}function removeItem(i){$order.removeItem(i)}function saveCart(){$order.updateOrder()}function goToStuff(o){var states=$state.get();states.some(function(state){return"frame.stuffs.stuff"==state.name})?$state.go("frame.stuffs.stuff",o):states.some(function(state){return"stuffs.stuff"==state.name})&&$state.go("stuffs.stuff",o)}var self=this;self.global=global;var listDiv=$element.find(".cartItems")[0];$(listDiv).fadeOut();var hoverIn;$($element).hover(function(){hoverIn=!0,$timeout(function(){hoverIn&&$(listDiv).fadeIn(150)},50),$(listDiv).fadeIn(100)},function(){hoverIn=!1,$timeout(function(){hoverIn||$(listDiv).fadeOut(100)},100)}),self.global=global,self.mobile=global.get("mobile").val,self.opt=global.get("store").val.seller.opt&&global.get("store").val.seller.opt.quantity?global.get("store").val.seller.opt.quantity:0;var retail=global.get("store").val.seller.retail;self.disabledMessage=self.opt>1&&!retail,self.countryCode=global.get("country"),self.removeItem=removeItem,self.saveCart=saveCart,self.goToStuff=goToStuff,$timeout(function(){activate()},400),$rootScope.$on("Purchase",function(){self.order=$order.getOrder()})}angular.module("gmall.services").directive("cartItem",itemDirective).directive("previewCart",previewCartDirective).directive("addedCart",addedCartDirective),itemCtrl.$inject=["$scope","$anchorScroll","$order","global","exception","Confirm","$user","$q","CreateContent","$email","$notification","$state","$rootScope","$timeout"],previewCartCtrl.$inject=["$scope","$anchorScroll","global","exception","$q","$state","$order","$element","$timeout","$rootScope"]}(),angular.module("gmall.services").factory("$notification",function($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete)}var Items=$resource("/api/collections/Notification/:id",{id:"@_id"},{deleteArray:{method:"DELETE"},updateNote:{method:"POST",params:{update:"note"}}});return{getList:getList,query:Items.query,get:Items.get,
save:Items.save,delete:Items.delete}}),function(){function userService($resource,$uibModal,$q,Session,User,global,exception,$state,$window,$rootScope,$http,$auth,Account){function newUser(name,email,password){return name||(name=email.split("@")[0]),User.save({name:name,email:email,password:password,action:"subscribtion"}).$promise.then(function(user){if($rootScope.emit("CompleteRegistration"),global&&global.get("user")&&global.set("user",user),global.get("local")&&!global.get("local").val&&$window.ga&&$window.ga("send","event","registration","complete"),"cart"!=$state.current.name&&"couponDetail"!=$state.current.name){var states=$state.get();if(global.get("paps")&&states.some(function(state){return"thanksPage"==state.name})){var pap=global.get("paps").val.getOFA("action","subscribtion");pap&&pap.url&&$state.go("thanksPage",{url:pap.url})}}return user})}function newUserByPhone(name,phone){var email=phone+"@gmall.io",user={email:email,name:name,profile:{phone:phone,fio:name}};return $auth.signup(user).then(function(response){if(console.log(response),!(response&&response.data&&response.data.token))throw response;if("update"==response.data.token)throw null}).then(function(response){}).catch(function(err){err&&exception.catcher("new client")(err)})}function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}function selectItem(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/selectUser.html",controller:function($user,$uibModalInstance,query){var self=(angular.copy(query),this);self.items=[],self.name="";var paginate={page:0,rows:30,items:0};self.search=function(name){var q=angular.copy(query);name.length<3||(q?(q.$and||(q={$and:[query]}),q.$and.push({$or:[{name:name},{email:name},{"profile.fio":name}]})):q={$or:[{name:name},{email:name},{"profile.fio":name}]},$user.getList(paginate,q).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(item){resolve(item)},function(){reject()})})}function selectOrCreat(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/selectOrCreate.html",controller:function($user,UserEntry,global,$uibModalInstance){function refreshUsers(str){str.length<3||searchUser(str)}function searchUser(str){if(isNumeric(str)){if(str.length>10)self.oldPhone=str.substring(0,10);else{for(var d=10-str.length,i=0;i<d;i++)str+="0";self.oldPhone=str}self.userName=""}else self.oldPhone=null,self.userName=str;self.users=[];var users=[],q={$or:[{name:str},{email:str},{"profile.fio":str},{"profile.phone":str}]},q1={$or:[{phone:str},{name:str},{email:str}]},acts=[];acts.push(get$user(q)),acts.push(getEntryUser(q1)),$q.all(acts).then(function(res){res[0]&&res[0].length&&res[0].forEach(function(item){item.type="user",users.push(item)}),res[1]&&res[1].length&&res[1].forEach(function(item){item.type="userEntry",users.push(item)}),self.users=users})}function get$user(q){return $user.getList(paginate,q)}function getEntryUser(q){return UserEntry.getList(paginate,q)}function addUser(){var user={name:self.userName,email:self.userEmail,phone:self.phoneCode.substring(1)+self.oldPhone.substring(0,10),type:"userEntry"};return $q.when().then(function(){return UserEntry.save(user).$promise}).then(function(res){user._id=res._id?res._id:res.id,self.addingUser=!1,self.userName="",self.user=user,self.oldPhone=""}).catch(function(err){err&&exception.catcher("новый клиент")(err)})}function clearUser(){self.user=null}function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}var self=this;self.items=[],self.user="",self.oldPhone=null,self.userName="name",self.userEmail="",self.global=global,self.phoneCodes=global.get("store").val.phoneCodes?global.get("store").val.phoneCodes:[{code:"+38",country:"Украина"}],self.phoneCode=global.get("store").val.phoneCode?global.get("store").val.phoneCode.code:"+38";var paginate={page:0,rows:30,items:0};self.refreshUsers=refreshUsers,self.addUser=addUser,self.clearUser=clearUser;new RegExp(/^\d+$/);self.ok=function(){$uibModalInstance.close(self.user)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg"}).result.then(function(item){resolve(item)},function(){reject()})})}function saveProfile(user){return Items.save({update:"profile"},{_id:user._id,profile:user.profile}).$promise}function login(){return $q(function(resolve,reject){if(global.get("user")&&global.get("user").val&&global.get("user").val._id)return resolve();var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/login-sign.html",controller:loginCtrl2,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function loginOnlyPhone(){return $q(function(resolve,reject){if(global.get("user")&&global.get("user").val&&global.get("user").val._id)return resolve();var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/login-sign.onlyPhone.html",controller:loginOnlyPhoneCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfo(service){return service=!1,service=service?"Service":"Good",$q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/getInfo.html",controller:getInfoCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass",resolve:{service:function(){return service}}});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfoCtrl($uibModalInstance,exception,global,User,$q,$http,service,Account){function closeModal(){$q.when().then(function(){return self.user._id?Items.save({update:"profile"},{_id:self.user._id,profile:self.user.profile}).$promise:$http.post("/auth/signupOrder",self.user)}).then(function(response){if(response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();response&&response.data&&response.data._id&&(self.user._id=response.data._id)}).then(function(){global.get("user").val&&(self.user=global.get("user").val),$uibModalInstance.close(self.user)})}var self=this;self.service=service,self.global=global,self.user=global.get("user").val,self.user||(self.user={email:"",profile:{}}),self.ok=closeModal,self.cancel=function(){$uibModalInstance.dismiss()}}function getInfoBonus(){return $q(function(resolve,reject){var modalInstance=$uibModal.open({animation:!0,templateUrl:"components/user/modal/getInfoBonus.html",controller:getInfoBonusCtrl,controllerAs:"$ctrl",windowClass:"modalProject",backdropClass:"modalBackdropClass"});$rootScope.$emit("modalOpened"),modalInstance.result.then(function(item){$rootScope.$emit("modalClosed"),resolve(item)},function(){$rootScope.$emit("modalClosed"),reject()})})}function getInfoBonusCtrl($uibModalInstance,exception,global,User,$q,$http,Account,$auth){function closeModal(){$q.when().then(function(){return self.user._id?Items.save({update:"profile"},{_id:self.user._id,profile:self.user.profile}).$promise:$http.post("/auth/signupOrder",self.user)}).then(function(response){if(response&&response.data&&response.data.token)return $auth.setToken(response),Account.getProfile();response&&response.data&&response.data._id&&(self.user._id=response.data._id)}).then(function(){global.get("user").val&&(self.user=global.get("user").val),$uibModalInstance.close(self.user)})}var self=this;self.global=global,self.user=global.get("user").val,self.formData=global.get("store").val.bonusForm?global.get("store").val.bonusForm:null,self.user||(self.user={email:"",profile:{},addInfo:{}}),self.ok=closeModal,self.cancel=function(){$uibModalInstance.dismiss()}}function createUser(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/createUser.html",controller:function($user,$uibModalInstance,$http,$q,exception){var self=this;self.user={profile:{}},self.ok=function(form){form.$invalid||(self.blockButton=!0,$q.when().then(function(){if(self.user.profile&&self.user.profile.phone){var phone=self.user.profile.phone;return $user.getItem(phone,"profile.phone")}return null}).then(function(res){if(res&&res._id)throw"phone exist"}).then(function(){return $user.checkEmailForExist(self.user.email)}).then(function(res){if(res&&res.exist)throw"email exist"}).then(function(){return $http.post(userHost+"/api/createUser",self.user)}).then(function(res){$uibModalInstance.close(res)}).catch(function(err){err&&exception.catcher("error")(err),self.blockButton=!1}))},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){resolve(item)},function(){reject()})})}function changeEmail(userId){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changeEmail.html",controller:function($user,global,$uibModalInstance,$http,$q,exception){function checkEmail(email,valid){if(!valid)return void(self.cheched=!1);$q.when().then(function(){return $user.checkEmailForExist(email)}).then(function(res){if(!res||res.exist)throw"email exist";self.cheched=!0}).catch(function(err){err&&exception.catcher("change email")(err),self.cheched=!1})}var self=this;self.global=global,self.checkEmail=checkEmail,self.email="",self.ok=function(){if(!self.cheched)return void exception.catcher("change email")("email используется");self.blockButton=!0,$q.when().then(function(){return Items.save({update:"email"},{_id:userId,email:self.email})}).then(function(res){$uibModalInstance.close(self.email)}).catch(function(err){self.blockButton=!1})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",windowClass:"modalProject"}).result.then(function(item){resolve(item)},function(){reject()})})}function checkEmailForExist(email,_id){return $q(function(rs,rj){var o={email:email};_id&&(o._id=_id),User.checkEmail(o,function(res){rs(res)},function(err){rj(err)})})}function checkPhoneForExist(phone,_id){return $q(function(rs,rj){var o={email:phone};_id&&(o._id=_id),User.checkPhone(o,function(res){rs(res)},function(err){rj(err)})})}function changePhone(userId){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changePhone.html",controller:function($user,global,$uibModalInstance,$http,$q,exception){function checkPhone(phone){return $q.when().then(function(){return $user.checkPhoneForExist(phone)}).then(function(res){if(!res||res.exist)throw"phone exist"})}var self=this;self.global=global,self.checkPhone=checkPhone,self.email="",self.ok=function(){if(!self.phone)return void exception.catcher("change phone")("phone???");self.blockButton=!0,$q.when().then(function(){return checkPhone(self.phone)}).then(function(){var o={_id:userId};return o["profile.phone"]=self.phone,Items.save({update:"profile.phone"},o)}).then(function(res){$uibModalInstance.close(self.phone)}).catch(function(err){exception.catcher("change phone")(err),self.blockButton=!1})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(item){resolve(item)},function(){reject()})})}function changePswd(_id){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/user/modal/changePswd.html",controller:function($user,global,$uibModalInstance,$http,$q,_id){var self=this;self.global=global,self.user={_id:_id,password:""},self.ok=function(){$q.when().then(function(){return $http.post(userHost+"/api/changePswd",self.user)}).then(function(res){$uibModalInstance.close(res)}).catch(function(err){$uibModalInstance.dismiss(err)})},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",resolve:{_id:function(){return _id}},windowClass:"modalProject"}).result.then(function(item){resolve(item)},function(){reject()})})}function logout(callback){var cb=callback||angular.noop;return Session.delete(function(){return global.set("user",null),cb()},function(err){return cb(err)}).$promise}function loginCtrl2($scope,$uibModalInstance,exception,global,User,$state){var self=this;self.global=global,$scope.$on("closeWitget",function(){$uibModalInstance.close()}),self.cancel=function(){$uibModalInstance.dismiss()}}function loginOnlyPhoneCtrl($scope,$uibModalInstance,exception,global,User,$state){var self=this;self.global=global,$scope.$on("closeWitget",function(){$uibModalInstance.close()}),self.cancel=function(){$uibModalInstance.dismiss()}}var Items=$resource("/api/collections/User/:_id",{_id:"@_id"});return this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,selectItem:selectItem,selectOrCreat:selectOrCreat,login:login,loginOnlyPhone:loginOnlyPhone,logout:logout,saveProfile:saveProfile,newUser:newUser,newUserByPhone:newUserByPhone,query:Items.query,getInfo:getInfo,createUser:createUser,changePswd:changePswd,getInfoBonus:getInfoBonus,changeEmail:changeEmail,changePhone:changePhone,checkEmailForExist:checkEmailForExist,checkPhoneForExist:checkPhoneForExist}}function accountFactory($http,$state,global){return{getProfile:function(){var store=global.get("store").val._id;return $http.get("/api/me/"+store)},getPermission:function(){var store=global.get("store").val._id;return $http.get("/api/permission/"+store)},getPermissionTranslator:function(){var store=global.get("store").val._id;return $http.get("/api/permissionTranslator/"+store)},getPermissionOrder:function(){var store=global.get("store").val._id;return $http.get("/api/permissionOrder/"+store)},getPermissionMaster:function(master){var store=global.get("store").val._id;return $http.get("/api/permissionMaster/"+store+"/"+master)},getEnterButton:function(user){var store=global.get("store").val._id;return user.frame=$state.get("frame")?$state.get("frame").url:null,user.store=store,$http.post("/api/getEnterButton",user)},updateProfile:function(profileData){var store=global.get("store").val._id;return profileData.store=store,$http.put(userHost+"/api/me",profileData)},unsubscription:function(){global.get("store").val._id;return $http.get("/api/unsubscription/"+global.get("user").val._id)}}}function subscibtionListService($resource){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return error}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/SubscribtionList/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get}}function userEntryService($resource,$q){function getList(paginate,query){function getListComplete(response){return paginate.page||(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return $q.reject(error)}return paginate||(paginate={}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id,param){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id,param:param}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/UserEntry/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query}}function sendPhoneFactory($http,$q,$user){function sendCodeToPhone(phone){if(phone){var o={phone:phone};return $q.when().then(function(){return $http.post("/api/users/sendSMS",o)})}}function verifyCode(code,phone){var o={code:code,phone:phone};return $q.when().then(function(){return $http.post("/api/users/verifySMScode",o)})}function checkPhone(phone){return $q.when().then(function(){return $user.getItem(phone,"profile.phone")}).then(function(res){return res?res:null})}return{sendCodeToPhone:sendCodeToPhone,verifyCode:verifyCode,checkPhone:checkPhone}}angular.module("gmall.services").factory("Session",["$resource",function($resource){return $resource("/api/session/")}]).factory("User",function($resource){return $resource("/api/users/:id/:email",{id:"@id"},{update:{method:"PUT",params:{id:"profile",email:""}},updateCoupon:{method:"PUT",params:{id:"coupon",email:""}},updatePswd:{method:"PUT",params:{id:"changepswd",email:""}},resetPswd:{method:"POST",params:{id:"resetpswd",email:"@email"}},get:{method:"GET",params:{id:"me",email:""}},checkEmail:{method:"GET",params:{id:"checkemail"}},checkPhone:{method:"GET",params:{id:"checkphone"}},useCoupon:{method:"GET",params:{id:"useCoupon"}},cancelCoupon:{method:"GET",params:{id:"cancelCoupon"}},repeatMailForConfirm:{method:"GET",params:{id:"repeatMailForConfirm"}}})}).service("$user",userService).service("UserEntry",userEntryService).factory("Account",accountFactory).factory("sendPhoneFactory",sendPhoneFactory).service("SubscibtionList",subscibtionListService),userService.$inject=["$resource","$uibModal","$q","Session","User","global","exception","$state","$window","$rootScope","$http","$auth","Account"],accountFactory.$inject=["$http","$state","global"],subscibtionListService.$inject=["$resource"],userEntryService.$inject=["$resource","$q"],sendPhoneFactory.$inject=["$http","$q","$user"]}(),angular.module("gmall.directives").directive("focusElement",["$timeout",function($timeout){return{scope:{focusElement:"="},link:function($scope,$element,$attr){$scope.$watch("focusElement",function(value){if(console.log(value),value)return void setTimeout(function(){$element[0].focus(),$scope.focusElemen=!1},200)})}}}]).directive("simpleFocusElement",[function(){return{restrict:"A",link:function(scope,element,attrs){setTimeout(function(){element[0].focus()},300),"false"==attrs.simpleFocusElement&&(console.log("focus",element[0]),setTimeout(function(){element[0].focus()},200))}}}]).directive("focusMe1",function($timeout,$parse){return{link:function(scope,element,attrs){var model=$parse(attrs.focusMe);scope.$watch(model,function(value){console.log("value=",value),value===!0&&$timeout(function(){element[0].focus()},300,!1)}),element.bind("blur",function(){console.log("blur"),scope.$apply(model.assign(scope,!1))})}}}).directive("focusMe",function($timeout){return{link:function(scope,element,attrs){scope.$watch(attrs.focusMe,function(value){value===!0&&$timeout(function(){element[0].focus(),scope[attrs.focusMe]=!1},300,!1)})}}}),angular.module("gmall.directives").directive("selectDropDown",["$window",function($window){return{link:function(scope,element,attrs){var defer=50;"defer"==attrs.selectDropDown&&(defer=200),setTimeout(function(){$(element).dropdown({callback:function($dropdown){$dropdown.fadeIn("slow")}})},defer)}}}]),angular.module("gmall.directives").directive("paginatorMain",function(anchorSmoothScroll,$anchorScroll){return{restrict:"E",scope:{paginate:"=",getlist:"&",scroll:"@"},link:function(scope,element,attrs,controller){function getList(){scope.scroll&&anchorSmoothScroll.scrollTo(scope.scroll,200),scope.getlist()}if(scope.paginate&&"object"==typeof scope.paginate){var l;scope.paginator={},scope.$watch("paginate.items",function(n,o){(n||0===n)&&(scope.paginate.items=Number(n),l=scope.paginator.pageCount(),scope.arrayPage=scope.getListPage())}),scope.paginator.setPage=function(page){((page=Number(page))||0===page)&&(page>scope.paginator.pageCount()||page==scope.paginate.page||(scope.paginate.page=page,0==scope.paginate.page&&(scope.arrayPage=scope.getListPage(2)),scope.paginate.page==l-1&&(scope.arrayPage=scope.getListPage(6)),scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList()))},scope.paginator.nextPage=function(){scope.paginator.isLastPage()||(scope.paginate.page++,scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList())},scope.paginator.perviousPage=function(){scope.paginator.isFirstPage()||(scope.paginate.page--,scope.paginate.page==scope.arrayPage[3]&&6==scope.arrayPage.length&&l-1-scope.paginate.page>2?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[4]&&7==scope.arrayPage.length?scope.arrayPage=scope.getListPage():scope.paginate.page==scope.arrayPage[2]&&scope.paginate.page-scope.arrayPage[0]>=2&&(scope.arrayPage=scope.getListPage()),getList())},scope.paginator.firstPage=function(){scope.paginate.page=0,getList()},scope.paginator.lastPage=function(){scope.paginate.page=scope.paginator.pageCount()-1,getList()},scope.paginator.isFirstPage=function(){return 0==scope.paginate.page},scope.paginator.isLastPage=function(){return scope.paginate.page==scope.paginator.pageCount()-1},scope.paginator.pageCount=function(){var count=Math.ceil(parseInt(scope.paginate.items,10)/parseInt(scope.paginate.rows,10));return 1===count&&(scope.paginate.page=0),count},scope.changeRow=function(rows){for(scope.paginate.rows=rows;scope.paginator.pageCount()<scope.paginate.page-1;)scope.paginate.page--;getList()},scope.arrayPage=[],scope.getListPage=function(num){var page=scope.paginate.page,arrayPage=[];if((0===num||num)&&(page=num),l<=6)for(var i=0;i<l;i++)arrayPage.push(i);else{if(page>=3)arrayPage.push(0),arrayPage.push("..."),arrayPage.push(page-1),arrayPage.push(page),arrayPage.push(page+1);else for(var i=0;i<4;i++)arrayPage.push(i);l-1-page>2&&arrayPage.push("..."),arrayPage.push(l-1)}return arrayPage},scope.getPageStr=function(i){return Number(i)||0===i?i+1:i}}},templateUrl:"components/paginator/paginator.html"}}),angular.module("gmall.directives").directive("lostFocus",["$window",function($window){return{scope:{lostFocus:"&",focusElement:"="},link:function(scope,element){setTimeout(function(){scope.focusElement&&element[0].focus(),element.bind("blur",function(e){setTimeout(function(){scope.lostFocus()})}),element.trigger("change")},500)}}}]).directive("focusMe",[function(){return{scope:{focusMe:"="},link:function(scope,element){scope.$watch("focusMe",function(n){n&&setTimeout(function(){element[0].focus(),scope.focusMe=!1})})}}}]).directive("isScrolledIntoView",[function(){return{scope:{isScrolledIntoView:"="},link:function(scope,elem){function isScrolledIntoViewF(elem){var docViewTop=$(window).scrollTop(),docViewBottom=docViewTop+$(window).height(),elemTop=$(elem).offset().top-150;return elemTop+$(elem).height()<=docViewBottom&&elemTop>=docViewTop}$(window).scroll(function(){scope.isScrolledIntoView=isScrolledIntoViewF(elem),scope.$apply()})}}}]),function(){angular.module("gmall.directives").directive("ngAutocompleteCity",function($parse,$timeout,global){return{scope:{user:"=",change:"&"},link:function(scope,element,attrs,model,contorller){function activate(){scope.user||(scope.user={}),scope.user.profile||(scope.user.profile={}),scope.user.profile.city||(scope.user.profile.city=""),element[0].value=scope.user.profile.city,void 0==scope.gPlace&&(scope.gPlace=new google.maps.places.Autocomplete(element[0],{types:["(cities)"]})),google.maps.event.addListener(scope.gPlace,"place_changed",place_changed),google.maps.event.addDomListener(element[0],"keydown",function(e){13==e.keyCode&&e.preventDefault()})}function place_changed(){placeChosen=!0;var place=scope.gPlace.getPlace();place.place_id?setTimeout(function(){scope.user.profile.city=element.val(),$timeout(function(){scope.user.profile.cityId=place.place_id},200),scope.$apply(),scope.change&&"function"==typeof scope.change&&scope.change()},50):(scope.cityId=null,scope.user.profile.city=element.val(),scope.$apply()),$timeout(function(){placeChosen=!1},1e3)}var placeChosen=!1;setTimeout(function(){activate()},500),scope.$watch(function(){return element.val()},function(o,n){n&&n!=o&&!placeChosen&&(scope.user.profile.cityId=null,scope.user.profile.city=element.val())})}}})}(),angular.module("gmall.services").factory("Collection",function($resource){return $resource("/api/collections/Collection/:id",{id:"@id"},{getCollectionsForBrand:{method:"GET",isArray:!0,params:{id:"",query:"query"}}})}),angular.module("gmall.services").service("anchorSmoothScroll",function(){this.scrollTo=function(eID,diff){var startY=function(){return self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0}(),stopY=function(eID){var elm=document.getElementById(eID);if(!elm)return 0;for(var y=elm.offsetTop,node=elm;node.offsetParent&&node.offsetParent!=document.body;)node=node.offsetParent,y+=node.offsetTop;return y}(eID)+(diff?diff:0),distance=stopY>startY?stopY-startY:startY-stopY;if(distance<100)return void scrollTo(0,stopY);var speed=Math.round(distance/100);speed>=20&&(speed=20);var step=Math.round(distance/25),leapY=stopY>startY?startY+step:startY-step,timer=0;if(stopY>startY)for(var i=startY;i<stopY;i+=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY+=step,leapY>stopY&&(leapY=stopY),timer++;else for(var i=startY;i>stopY;i-=step)setTimeout("window.scrollTo(0, "+leapY+")",timer*speed),leapY-=step,leapY<stopY&&(leapY=stopY),timer++}}),function(){function serviceFunction($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return console.log(id),Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/PROMO/coupon/createCoupon.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Coupon/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Coupon",serviceFunction),serviceFunction.$inject=["$resource","$uibModal","$q"]}(),angular.module("gmall.directives").directive("externalCatalog",externalCatalogComponent).directive("externalCatalogDownload",externalCatalogDownload),externalCatalogDownloadCtrl.$inject=["ExternalCatalog","$q","Confirm","exception","global","$timeout","$http","$resource","Sections","Brands","$uibModal"],externalCatalogCtrl.$inject=["ExternalCatalog","$q","Confirm","exception","global","$timeout"],angular.module("gmall.services").service("ExternalCatalog",function($resource,$q,$uibModal){function getItems(reload){return!items||reload?getList():items}function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),items=response,response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/externalCatalog/createExternalCatalog.html",controllerAs:"$ctrl",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){if(!self.name)return void exception.catcher("создание объекта")("нужено название");$uibModalInstance.close({name:self.name})},self.cancel=function(){$uibModalInstance.dismiss()}}}).result.then(function(item){item.name?(item.name=item.name.substring(0,25),resolve(item)):reject("empty")},function(err){reject(err)})})}var items,Items=$resource("/api/collections/ExternalCatalog/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create,getItems:getItems}}),function(window){function extend(a,b){for(var key in b)b.hasOwnProperty(key)&&(a[key]=b[key]);return a}function Menu(options){this.options=extend({},this.options),extend(this.options,options),this._init()}Menu.prototype.options={type:"c-menu--push-left"},Menu.prototype._init=function(){this.menu=document.querySelector("#c-menu--"+this.options.type),console.log()},Menu.prototype.open=function(){this.menu.classList.add("is-active")},Menu.prototype.close=function(){this.menu.classList.remove("is-active")},window.MenuSlide=Menu}(window),angular.module("gmall.directives").directive("slideMenu",["$rootScope","$q","Sections","$state",function($rootScope,$q,Sections,$states){return{restrict:"E",scope:{displaySlideMenu:"="},templateUrl:"components/slideMenu/slideMenu.html",link:function($scope,element,attrs){function getSection(){$q.when().then(function(){return Sections.getSections()}).then(function(sections){$scope.sections=sections})}var slideLeft,initDone;setTimeout(function(){initDone=!0,slideLeft=new MenuSlide({type:"push-left"}),$("#c-menu--push-left").niceScroll(),$scope.displaySlideMenu&&$scope.openMenu()}),$scope.$watch("displaySlideMenu",function(n,o){n&&initDone?$scope.openMenu():!n&&initDone&&$scope.closeMenu()}),$scope.closeMenu=function(){$("#mainContent").hasClass("pl300")&&(slideLeft.close(),$("#mainContent").removeClass("pl300"),$("#mainContent").addClass("pl150"))},$scope.openMenu=function(){getSection(),slideLeft.open(),$("#mainContent").addClass("pl300"),$("#mainContent").removeClass("pl150")},getSection(),$scope.getSectionUrlParams=function(section){var params={
groupUrl:"group",categoryUrl:"category",categoryList:null,parentGroup:null,brand:null,artikul:null,brandTag:null,queryTag:null,searchStr:null};return 0===section.level?(params.groupUrl=section.url,section.child&&section.child.length?params.categoryList=null:params.categoryList="allCategories"):params.parentUrl=section.url,params},$scope.getSectionUrlParamsAndGo=function(section){var params={groupUrl:"group",categoryUrl:"category",categoryList:null,parentGroup:null,brand:null,artikul:null,brandTag:null,queryTag:null,searchStr:null};0===section.level?(params.groupUrl=section.url,section.child&&section.child.length?params.categoryList=null:params.categoryList="allCategories"):(params.groupUrl=section.section.url,params.parentGroup=section.url,params.categoryList="allCategories"),$state.go("frame.stuffs",params)}}}}]),angular.module("gmall.controllers").controller("selectCategoryModalCtrl",function($scope,$uibModalInstance,$q,Sections,categoryId){$scope.categoryId=categoryId,console.log($scope.categoryId),$q.when().then(function(){return Sections.getSections()}).then(function(sections){$scope.sections=sections}),$scope.selectCategory=function(selectedCategory){$uibModalInstance.close(selectedCategory)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}).controller("bindCategoryToFilterCtrl",function($scope,$uibModalInstance,Category,$resource,$q,sections,field,id,revers){function checkField(section){return section.showCheck=!1,section.categories&&section.categories.length&&(section.checkAll=!0,section.showCheck=!0,section.categories.forEach(function(category){$scope.revers?$scope.item[field].indexOf(category._id)>-1?category.checked=!0:section.checkAll=!1:category[field].indexOf($scope.id)>-1?category.checked=!0:section.checkAll=!1})),section.child&&section.child.length&&(section.checkAll=!1,section.child.forEach(function(s){checkField(s)&&(section.showCheck=!0)})),section.showCheck}function checkCategory(category){if(category.checked)$scope.revers?($scope.item[field].indexOf(category._id)<0&&$scope.item[field].push(category._id),category=$scope.item):category[field]?category[field].indexOf($scope.id)<0&&category[field].push($scope.id):(category[field]=[],category[field].push($scope.id));else if($scope.revers){if($scope.item[field]&&$scope.item[field].length){var i=$scope.item[field].indexOf(category._id);i>-1&&$scope.item[field].splice(i,1)}category=$scope.item}else if(category[field]&&category[field].length){var i=category[field].indexOf($scope.id);i>-1&&category[field].splice(i,1)}({_id:category._id})[field]=category[field].filter(function(el){return el}),Category.save({update:field},category)}function foo(s){if(s.child&&s.child.length){for(var i=0,l=s.child.length;i<l;i++){var section=s.child[i];if(section.showCheck)if(section.child&&section.child.length){if(section.checkAll=foo(section),!section.checkAll)return!1}else if(!section.checkAll)return!1}return!0}}$scope.id=id,$scope.revers=revers,sections.forEach(function(s){s.categories&&s.categories.length&&s.categories.forEach(function(c){c.checked=!1}),s.child&&s.child.length&&s.child.forEach(function(s){s.categories&&s.categories.length&&s.categories.forEach(function(c){c.checked=!1})})}),$scope.bindFilter=function(category,section){checkCategory(category),section.checkAll=!0;for(var i=0,l=section.categories.length;i<l;i++)if($scope.revers){if($scope.item[field].indexOf(section.categories[i]._id)<0){section.checkAll=!1;break}}else if(section.categories[i][field].indexOf($scope.id)<0){section.checkAll=!1;break}},$scope.bindFilterForSection=function(section,checkAll){section.checkAll=checkAll,section.categories&&section.categories.length&&section.categories.forEach(function(category){category.checked=checkAll,checkCategory(category)}),section.child&&section.child.length&&section.child.forEach(function(s){$scope.bindFilterForSection(s,checkAll)})},$q.when().then(function(){var q=$q.defer();if($scope.revers){var Item=$resource("/api/collections/BrandTags/:id",{id:"@_id"});Item.get({id:$scope.id},function(res){res[$scope.field]||(res[$scope.field]=[]),$scope.item=res,q.resolve()}),Category=Item}else q.resolve();return q.promise}).then(function(){$scope.sections=sections.filter(function(el){return 0===el.level}),$scope.sections.forEach(checkField),$scope.sections.forEach(function(s){s.showCheck&&(s.checkAll=foo(s))})}),$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}).controller("selectFilterModalCtrl",function($scope,$uibModalInstance,filter,tags){$scope.filter=filter,$scope.allTags=!1,$scope.changeAllTags=function(criteria){filter.tags.forEach(function(tag){tag.set=criteria})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}).controller("selectBrandModalCtrl",function($scope,$uibModalInstance,$q,Brands,brandItem,brands){$scope.brandItem=brandItem,$scope.brands=brands,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.ok=function(brandItem){$uibModalInstance.close(brandItem)},$q.when().then(function(){var q=$q.defer();return brands&&brands.length?($scope.brands=brands,q.resolve()):Brands.query(function(res){res.shift(),$scope.brands=res,q.resolve()},function(err){q.reject(err)}),q.promise})}).controller("selectBrandTagModalCtrl",function($scope,$uibModalInstance,brandTag,brandTags){setTimeout(function(){$scope.brandTag=brandTag},200),$scope.brandTags=brandTags,console.log(brandTag,brandTags),$scope.ok=function(brandTag){$uibModalInstance.close(brandTag)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("gmall.services").service("SelectCategory",["$q","$uibModal","Sections",function($q,$uibModal,Sections){this.bindCategoryForFilterBrandCol=function(id,field,revers){$q.when().then(function(){return Sections.getSections()}).then(function(sections){return{animation:!0,templateUrl:"components/selectCategoryModal/bindCategoryToFilter.html",controller:"bindCategoryToFilterCtrl",size:"lg",resolve:{sections:function(){return sections},field:function(){return field},id:function(){return id},revers:function(){return revers}}}}).then(function(options){$uibModal.open(options).result.then(function(selectedCategory){console.log(selectedCategory),selectedCategory._id!=$scope.item.category._id&&Category.get({id:selectedCategory._id},function(res){$scope.tagsValue=setTagsValue($scope.item.tags,res.filters),$scope.item.category=res})},function(){console.log("Modal dismissed at: "+new Date)})})}}]),angular.module("gmall.directives").directive("growlNotification",[function(){return{restrict:"AE",scope:{msg:"="},templateUrl:"components/growlNotification/growlNotification.html",link:function(scope,element,arrts){$(element).hide(),scope.$watch("msg",function(n){n&&($(element).fadeIn(500),setTimeout(function(){$(element).fadeOut(500),scope.msg=null},2e3))})}}}]),angular.module("gmall.directives").directive("backToTop",[function(){return{restrict:"AC",link:function(scope,element){$(element).hide(),$(window).scroll(function(){$(this).scrollTop()>200?$(element).fadeIn(400):$(element).fadeOut(400)}),element.bind("click",function(){return $("html, body").animate({scrollTop:0},300),!1})}}}]).directive("bounce",[function(){return{restrict:"C",link:function(scope,iElement,iAttrs){$(window).scroll(function(){$(this).scrollTop()<30?$(iElement).fadeIn(400):$(iElement).fadeOut(400)})}}}]),angular.module("gmall.directives").directive("fileReadSrc",["$parse","$timeout",function($parse,$timeout){return{restrict:"A",scope:{fileSrc:"=fileReadSrc",myFile:"="},link:function(scope,element,attrs){element.bind("change",function(changeEvent){var reader=new FileReader;reader.onload=function(loadEvent){scope.$apply(function(){$timeout(function(){scope.fileSrc=loadEvent.target.result})})},scope.myFile=changeEvent.target.files[0],reader.readAsDataURL(changeEvent.target.files[0])})}}}]).directive("loadImage",["$fileUpload","$timeout","Photo",function($fileUpload,$timeout,Photo){return{restrict:"AE",scope:{uploadUrl:"@",itemId:"@",itemUrl:"@",fileSrc:"=",Item:"=itemResourse",gallery:"=",nameImg:"@",nameImgForSave:"@",deleteFile:"@",replaceIndex:"@"},controller:function($scope){$scope.$ctrl={fileDimension:"Origin"},$scope.dimen=$scope.uploadUrl.split("/"),$scope.$ctrl.fileDimension="",$scope.$ctrl.fileDimension=$scope.dimen[$scope.dimen.length-1].slice(10)},templateUrl:"components/loadImage/loadimage.html",link:function(scope,element,attrs){var oldImg,string="abcdefghijklmnopqrstuvwxyzQAZWSXEDCRFVTGBYHNUJMIKOLP1234567890";scope.noLoad=!0,scope.noChange=!1,scope.now=Date.now()+string.shuffle(5),scope.nameImg||(scope.nameImg="img"),scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,100],scope.$watch("fileSrc",function(n,o){n&&n.indexOf("base64")<0&&(oldImg=n)}),scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.clickFile=function(){var id="#imagefile"+scope.now;angular.element(id).trigger("click")},scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0;var params={index:scope.index,nameImg:scope.nameImg};scope.itemUrl&&"undefined"!=scope.itemUrl&&(params.url=scope.itemUrl),scope.dimen[scope.dimen.length-1]=scope.dimen[scope.dimen.length-1].slice(0,10);var url=scope.dimen.join("/");url+=scope.$ctrl.fileDimension,$fileUpload.uploadFileToUrl(file,url,scope.itemId,params).then(function(res){scope.myFile=null,scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=null;var o={_id:scope.itemId};$timeout(function(){if("imgs"==scope.nameImg)scope.replaceIndex?(scope.gallery[scope.replaceIndex].img=res.data.imgs[0].img,oldImg&&(console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg]))):scope.gallery.push(res.data.imgs[0]),scope.nameImgForSave?o[scope.nameImgForSave]=scope.gallery:o[scope.nameImg]=scope.gallery;else if("gallery"==scope.nameImg)scope.gallery.push(res.data.gallery[0]),o[scope.nameImg]=scope.gallery;else{if(oldImg){var small=oldImg.split("/");small[small.length-1]=small[small.length-1].replace("img","small"),small=small.join("/"),console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg,small])}oldImg=res.data.img?res.data.img:res.data[scope.nameImg],scope.fileSrc=res.data.img?res.data.img:res.data[scope.nameImg],o[scope.nameImg]=res.data.img?res.data.img:res.data[scope.nameImg]}var field=scope.nameImgForSave?scope.nameImgForSave:scope.nameImg;res.data["small"+scope.nameImg]&&(field+=" small"+scope.nameImg,o["small"+scope.nameImg]=res.data["small"+scope.nameImg]),scope.Item.save({update:field},o)},10)}).catch(function(err){err&&exception.catcher("upload video")(err)})}},scope.deleteImg=function(){if(!scope.itemId)return scope.fileSrc=null,void(scope.noLoad=!0);if(oldImg){var o={_id:scope.itemId},field=scope.nameImg;field+=" small"+scope.nameImg,o[scope.nameImg]=null,o["small"+scope.nameImg]=null,scope.Item.save({update:field},o);var small=oldImg.split("/");small[small.length-1]=small[small.length-1].replace("img","small"),small=small.join("/"),Photo.deleteFiles("Stuff",[oldImg,small]),oldImg=null,scope.fileSrc="",scope.noChange=!1,scope.noLoad=!0}}}}}]).directive("uploadVideo",["$fileUpload","$timeout","Photo","exception",function($fileUpload,$timeout,Photo,exception){return{restrict:"AE",scope:{uploadUrl:"@",itemId:"@",fileSrc:"=",Item:"=itemResourse",gallery:"=",nameImg:"@"},templateUrl:"components/loadImage/uploadVideo.html",link:function(scope,element,attrs){var oldImg;scope.noLoad=!0,scope.noChange=!1,scope.now=Date.now()+"abcdefghijklmnopqrstuvwxyzQAZWSXEDCRFVTGBYHNUJMIKOLP1234567890".shuffle(5),scope.nameImg||(scope.nameImg="img"),scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,100],scope.$watch("fileSrc",function(n,o){n&&n.indexOf("base64")<0&&(oldImg=n)}),scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.clickFile=function(){var id="#imagefile"+scope.now;angular.element(id).trigger("click")},scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0;var o={_id:scope.itemId};$fileUpload.uploadFileToUrl(file,scope.uploadUrl,scope.itemId,{index:scope.index,nameImg:scope.nameImg}).then(function(res){scope.myFile=null,scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=null,$timeout(function(){if(o[scope.nameImg]=res.data.img,oldImg){var small=oldImg.split("/");small[small.length-1]=small[small.length-1].replace("img","small"),small=small.join("/"),console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg,small])}oldImg=res.data.img,scope.fileSrc=res.data.img,scope.Item.save({update:scope.nameImg},o)},100)}).catch(function(err){err&&exception.catcher("upload video")(err)})}},scope.deleteImg=function(){if(!scope.itemId)return scope.fileSrc=null,void(scope.noLoad=!0);if(oldImg){var o={_id:scope.itemId};o[scope.nameImg]=null,scope.Item.save({update:scope.nameImg},o),Photo.deleteFiles("Stuff",[oldImg]),oldImg=null,scope.fileSrc="",scope.noChange=!1,scope.noLoad=!0}}}}}]).directive("loadImageWithLink",["$fileUpload","$timeout","$http",function($fileUpload,$timeout,$http){return{restrict:"AE",scope:{noLoad:"=noLoad",noChange:"=noChange",uploadUrl:"@",itemId:"@",fileSrc:"=",additionUrl:"@",Item:"=itemResourse",gallery:"="},templateUrl:"manager/views/templates/loadimagewithlinks.html",link:function(scope,element,attrs){var additionUrl=scope.additionUrl?scope.additionUrl:"Subscribe";scope.photoIndexArray=[1,2,3,4,5,6,7,8,9,10,11,12,100],scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.$watch("fileSrc",function(n,o){n||(scope.fileSrc="/img/upload/no.png")}),scope.link="",scope.index=1,scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0,$fileUpload.uploadFileToUrl(file,scope.uploadUrl,scope.itemId,{index:scope.index,link:scope.link}).then(function(res){scope.myFile=null,scope.link="",scope.index=1,console.log(res),scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=res.data.img,$timeout(function(){scope.gallery=res.data.gallery},10)})}},scope.deleteImg=function(){scope.itemId&&(scope.noChange=!0,scope.fileSrc="",scope.Item.delete({id:scope.itemId,file:"file"},function(res){scope.noChange=!1,scope.noLoad=!0,alert(res.msg)}))},scope.deletePhoto=function(index){confirm("Удалить?")&&$http.get("/api/collections/"+additionUrl+"/fileGalleryDelete/"+scope.itemId+"/"+index).then(function(response){scope.gallery=response.data.gallery})},scope.updateStuffGallery=function(){$http.post("/api/collections/"+additionUrl+"/fileGalleryUpdate/"+scope.itemId,{gallery:scope.gallery}).then(function(response){scope.gallery=response.data.gallery})}}}}]).directive("loadImageBig",["$fileUpload","$timeout",function($fileUpload,$timeout){return{restrict:"AE",scope:{noLoad:"=noLoad",noChange:"=noChange",uploadUrl:"@",itemId:"@",fileSrc:"=",Item:"=itemResourse",nameImage:"@"},templateUrl:"manager/views/templates/loadimagebig.html",link:function(scope,element,attrs){scope.$watch("myFile",function(n,o){scope.noLoad=!n}),scope.$watch("itemId",function(n,o){scope.noChange=!n}),scope.clickOnUpload=function(id){$timeout(function(){angular.element("#"+id).trigger("click")},100)},scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0,$fileUpload.uploadFileToUrl(file,scope.uploadUrl,scope.itemId,{nameImg:scope.nameImage}).then(function(res){scope.myFile=null,scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=res.data.img,$timeout(function(){scope.fileSrc=res.data.img},10)})}},scope.deleteImg=function(){scope.itemId&&(scope.noChange=!0,scope.fileSrc="",scope.Item.delete({id:scope.itemId,file:scope.nameImage},function(res){scope.noChange=!1,scope.noLoad=!0,alert(res.msg)}))}}}}]).directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0])})})}}}]).directive("uploadFiles",function($timeout){return{link:function(scope,element,attrs){console.log(element[0].form);var $form=$(element[0].form);if(function(){var div=document.createElement("div");return("draggable"in div||"ondragstart"in div&&"ondrop"in div)&&"FormData"in window&&"FileReader"in window}()){$form.addClass("has-advanced-upload");var droppedFiles=!1;$form.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}).on("dragover dragenter",function(){$form.addClass("is-dragover")}).on("dragleave dragend drop",function(){$form.removeClass("is-dragover")}).on("drop",function(e){droppedFiles=e.originalEvent.dataTransfer.files,console.log(e.target.files),console.log(droppedFiles)})}var changedHandler=function(event){return void(window.File&&window.FileList&&window.FileReader?(scope.$apply(function(){var files=event.target.files;document.getElementById("result");files.length?scope.hasFiles=!0:scope.hasFiles=!1;for(var i=0;i<files.length;i++){var file=files[i],picReader=new FileReader;picReader.addEventListener("load",function(event){var picFile=event.target;file.imgSrc=picFile.result,scope.files.push(file)}),picReader.readAsDataURL(file)}}),$timeout(function(){},1e3)):console.log("Your browser does not support File API"))},resetHandler=function(){scope.$apply(function(){scope.files.length=0,scope.hasFiles=!1})};element.bind("change",changedHandler),element[0].form&&angular.element(element[0].form).bind("reset",resetHandler),scope.$watchCollection("files",function(){0===scope.files.length&&element.val(null)}),scope.$on("$destroy",function(){element.unbind("change",changedHandler),element[0].form&&angular.element(element[0].form).unbind("reset",resetHandler)})},restrict:"A",scope:{files:"=uploadFiles",hasFiles:"="}}}),angular.module("gmall.services").service("$fileUpload",["$http","$uibModal","$q",function($http,$uibModal,$q){this.uploadFileToUrl=function(file,uploadUrl,id,params,type){var fd=new FormData;if(fd.append("file",file),fd.append("id",id),params&&"object"==typeof params)for(var key in params)fd.append(key,params[key]);var preffix=photoUpload;switch(type){case"user":preffix=userHost}return $http.post(preffix+uploadUrl,fd,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})},this.showFile=function(block,field){return $uibModal.open({animation:!0,templateUrl:"components/loadImage/showImgInModal.html",controllerAs:"$ctrl",controller:function($uibModalInstance,block,field){function ok(item){$uibModalInstance.close()}function cancel(){$uibModalInstance.dismiss()}var self=this;self.item=block,console.log(self.item),self.ok=ok,self.cancel=cancel},resolve:{block:function(){return block},field:function(){return field}}}).result},this.fileUpload=function(uploadUrl,field,itemUrl,itemId,index){return $uibModal.open({animation:!0,templateUrl:function(){return field&&"video"==field?"components/loadImage/loadVideoModal.html":"components/loadImage/loadImageModal.html"},controller:function(uploadUrl,field,itemUrl,itemId,index,$uibModalInstance,$scope,$timeout,exception){function handleImage(files){function closureI(picReader,file){picReader.addEventListener("load",function(event){var picFile=event.target;file.imgSrc=picFile.result;for(var is,j=0;j<self.files.length;j++)if(self.files[j].name==file.name){is=!0;break}is||$timeout(function(){self.files.push(file)},100)})}$scope.$apply(function(){files.length?self.hasFiles=!0:self.hasFiles=!1;for(var i=0;i<files.length;i++){var file=files[i],picReader=new FileReader;closureI(picReader,file),picReader.readAsDataURL(files[i])}})}function uploadFiles(){function handlePhoto(file){console.log(uploadUrl,self.fileDimension);var url=self.urlArr[0]+self.fileDimension,fd=new FormData;fd.append("file",file),itemUrl&&fd.append("url",itemUrl),field&&fd.append("nameImg",field),itemId&&fd.append("id",itemId),index&&fd.append("index",index);var preffix=photoUpload;return console.log(preffix+url+"?"+self.suffix),$http.post(preffix+url+"?"+self.suffix,fd,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}if(!self.isUploading){self.isUploading=!0;var acts=[];return self.files.forEach(function(file,i){"imgs"!=field&&"gallery"!=field&&i||i>20||acts.push(handlePhoto(file))}),$q.all(acts).then(function(res){$uibModalInstance.close(res)}).catch(function(err){exception.catcher("load file")(err),console.log(err)})}}var self=this;self.files=[],self.hasFiles=!1,self.urlArr=uploadUrl.split("?"),self.suffix=self.urlArr[1]?self.urlArr[1]:"",self.dimen=self.urlArr[0].split("/"),self.fileDimension="","video"!=field&&(self.fileDimension=self.dimen[self.dimen.length-1].slice(10)),self.uploadFiles=uploadFiles;var $form,$input;$timeout(function(){($form=$("#uploadImgForm"),$input=$form.find("#inputFilesUpload"),$input.bind("change",changedHandler),$form.bind("reset",resetHandler),function(){var div=document.createElement("div");return("draggable"in div||"ondragstart"in div&&"ondrop"in div)&&"FormData"in window&&"FileReader"in window}())&&($form.addClass("has-advanced-upload"),$form.on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}).on("dragover dragenter",function(){$form.addClass("is-dragover")}).on("dragleave dragend drop",function(){$form.removeClass("is-dragover")}).on("drop",function(e){handleImage(e.originalEvent.dataTransfer.files)}))},300);var changedHandler=function(event){window.File&&window.FileList&&window.FileReader?handleImage(event.target.files):console.log("Your browser does not support File API")},resetHandler=function(){$scope.$apply(function(){self.files.length=0,self.hasFiles=!1,self.isUploading=!1})};$scope.$watchCollection("files",function(){0===self.files.length&&$input&&$input.val(null)}),$scope.$on("$destroy",function(){$input.unbind("change",changedHandler),$form.unbind("reset",resetHandler)}),$scope.$watch("fileSrc",function(n,o){n&&n.indexOf("base64")<0&&(oldImg=n)}),$scope.$watch("myFile",function(n,o){$scope.noLoad=!n}),$scope.clickFile=function(){var id="#imagefile"+$scope.now;angular.element(id).trigger("click")},$scope.uploadImg=function(){if(scope.itemId){var file=scope.myFile;scope.noChange=!0;var params={index:scope.index,nameImg:scope.nameImg};scope.itemUrl&&"undefined"!=scope.itemUrl&&(params.url=scope.itemUrl),scope.dimen[scope.dimen.length-1]=scope.dimen[scope.dimen.length-1].slice(0,10);var url=scope.dimen.join("/");url+=scope.$ctrl.fileDimension,$fileUpload.uploadFileToUrl(file,url,scope.itemId,params).then(function(res){scope.myFile=null,scope.noChange=!1,scope.noLoad=!0,scope.fileSrc=null;var o={_id:scope.itemId};$timeout(function(){if("imgs"==scope.nameImg)scope.replaceIndex?(scope.gallery[scope.replaceIndex].img=res.data.imgs[0].img,oldImg&&(console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg]))):scope.gallery.push(res.data.imgs[0]),scope.nameImgForSave?o[scope.nameImgForSave]=scope.gallery:o[scope.nameImg]=scope.gallery;else if("gallery"==scope.nameImg)scope.gallery.push(res.data.gallery[0]),o[scope.nameImg]=scope.gallery;else{if(oldImg){var small=oldImg.split("/");small[small.length-1]=small[small.length-1].replace("img","small"),small=small.join("/"),console.log("deleting"),Photo.deleteFiles("Stuff",[oldImg,small])}oldImg=res.data.img?res.data.img:res.data[scope.nameImg],scope.fileSrc=res.data.img?res.data.img:res.data[scope.nameImg],o[scope.nameImg]=res.data.img?res.data.img:res.data[scope.nameImg]}var field=scope.nameImgForSave?scope.nameImgForSave:scope.nameImg;res.data["small"+scope.nameImg]&&(field+=" small"+scope.nameImg,o["small"+scope.nameImg]=res.data["small"+scope.nameImg]),scope.Item.save({update:field},o)},10)}).catch(function(err){err&&exception.catcher("upload video")(err)})}},self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl",size:"lg",resolve:{uploadUrl:function(){return uploadUrl},field:function(){return field},itemUrl:function(){return itemUrl},itemId:function(){return itemId},index:function(){return index}}}).result}}]).factory("Photo",photoFactory),photoFactory.$inject=["$http"],angular.module("gmall.directives").directive("checklistModel",["$parse","$compile",function($parse,$compile){function contains(arr,item){if(angular.isArray(arr))for(var i=0;i<arr.length;i++)if(angular.equals(arr[i],item))return!0;return!1}function add(arr,item){arr=angular.isArray(arr)?arr:[];for(var i=0;i<arr.length;i++)if(angular.equals(arr[i],item))return arr;return arr.push(item),arr}function remove(arr,item){if(angular.isArray(arr))for(var i=0;i<arr.length;i++)if(angular.equals(arr[i],item)){arr.splice(i,1);break}return arr}function postLinkFn(scope,elem,attrs){$compile(elem)(scope);var getter=$parse(attrs.checklistModel),setter=getter.assign,value=$parse(attrs.checklistValue)(scope.$parent);scope.$watch("checked",function(newValue,oldValue){if(newValue!==oldValue){var current=getter(scope.$parent);newValue===!0?setter(scope.$parent,add(current,value)):setter(scope.$parent,remove(current,value))}}),scope.$parent.$watch(attrs.checklistModel,function(newArr,oldArr){scope.checked=contains(newArr,value)},!0)}return{restrict:"A",priority:1e3,terminal:!0,scope:!0,compile:function(tElement,tAttrs){if("INPUT"!==tElement[0].tagName||!tElement.attr("type","checkbox"))throw'checklist-model should be applied to `input[type="checkbox"]`.';if(!tAttrs.checklistValue)throw"You should provide `checklist-value`.";return tElement.removeAttr("checklist-model"),tElement.attr("ng-model","checked"),postLinkFn}}}]),angular.module("gmall.directives").directive("bindModelToCategory",["Sections","Category","$q","$resource",function(Sections,Category,$q,$resource){return{restrict:"E",scope:{id:"@",field:"@",backstate:"@",model:"@",revers:"@"},templateUrl:"components/bindModelToCategory/bindModelToCategory.html",link:function($scope,element,attrs){function checkField(section){return section.showCheck=!1,section.categories&&section.categories.length&&(section.checkAll=!0,section.showCheck=!0,section.categories.forEach(function(category){$scope.revers?$scope.item[field].indexOf(category._id)>-1?category.checked=!0:section.checkAll=!1:category[field].indexOf($scope.id)>-1?category.checked=!0:section.checkAll=!1})),section.child&&section.child.length&&(section.checkAll=!1,section.child.forEach(function(s){checkField(s)&&(section.showCheck=!0)})),section.showCheck}function checkCategory(category){if(category.checked)$scope.revers?($scope.item[field].indexOf(category._id)<0&&$scope.item[field].push(category._id),category=$scope.item):category[field]?category[field].indexOf($scope.id)<0&&category[field].push($scope.id):(category[field]=[],category[field].push($scope.id));else if($scope.revers){if($scope.item[field]&&$scope.item[field].length){var i=$scope.item[field].indexOf(category._id);i>-1&&$scope.item[field].splice(i,1)}category=$scope.item}else if(category[field]&&category[field].length){var i=category[field].indexOf($scope.id);i>-1&&category[field].splice(i,1)}Category.save({update:field},category)}function foo(s){if(s.child&&s.child.length){for(var i=0,l=s.child.length;i<l;i++){var section=s.child[i];if(section.showCheck)if(section.child&&section.child.length){if(section.checkAll=foo(section),!section.checkAll)return!1}else if(!section.checkAll)return!1}return!0}}var field=$scope.field;$scope.bindFilter=function(category,section){checkCategory(category),section.checkAll=!0;for(var i=0,l=section.categories.length;i<l;i++)if($scope.revers){if($scope.item[field].indexOf(section.categories[i]._id)<0){section.checkAll=!1;break}}else if(section.categories[i][field].indexOf($scope.id)<0){section.checkAll=!1;break}},$scope.bindFilterForSection=function(section,checkAll){section.checkAll=checkAll,section.categories&&section.categories.length&&section.categories.forEach(function(category){category.checked=checkAll,checkCategory(category)}),section.child&&section.child.length&&section.child.forEach(function(s){$scope.bindFilterForSection(s,checkAll)})},$q.when().then(function(){var q=$q.defer();if($scope.model){var Item=$resource("/api/collections/"+$scope.model+"/:id",{id:"@_id"});Item.get({id:$scope.id},function(res){res[$scope.field]||(res[$scope.field]=[]),$scope.item=res,q.resolve()}),Category=Item}else q.resolve();return q.promise}).then(function(){var q=$q.defer();return Sections.query(function(res){res.shift(),$scope.sections=res.filter(function(el){return 0===el.level}),$scope.sections.forEach(checkField),$scope.sections.forEach(function(s){s.showCheck&&(s.checkAll=foo(s))}),q.resolve()}),q.promise})}}}]),function(){angular.module("gmall.directives").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ngModel){element.on("keydown",function(){return ngModel.$setValidity("mongoose",!0)})}}})}();var directives=angular.module("gmall.directives");directives.directive("choiceUser",["$resource",function($resource){return{restrict:"E",scope:{onSelected:"&"},templateUrl:"components/choiceUser/index.html",link:function(scope,$element){console.log("link"),scope.select={};var User=$resource("/api/collections/User/:id",{id:"@_id"});scope.selectUser=function(user){console.log(user),scope.onSelected({user:user})},scope.refresUsers=function(search){search&&search.length&&search.length>2&&User.query({search:search.substring(0,30).replace(/\\/g,"")},function(res){scope.select.users=res?res:[]})}}}}]),function(){function papsService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getPaps."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}var Items=$resource("/api/collections/Paps/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get}}angular.module("gmall.services").service("Paps",papsService),papsService.$inject=["$resource","$uibModal","$q"]}(),function(){function itemDirectiveTemplate(global){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/paps/paps.html",restrict:"E"}}function itemDirective(){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/paps/papsItem.html"}}function itemCtrl(Paps,$stateParams,$q,$uibModal,exception,global,$timeout,$scope,$anchorScroll){function activate(){return $anchorScroll(),getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение post action page")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){return self.item=data,self.item}).catch(function(err){return $q.reject(err)})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}var self=this;self.Items=Paps,self.mobile=global.get("mobile").val,self.saveField=saveField,activate(),$scope.$on("changeLang",function(){activate()})}angular.module("gmall.services").directive("papsItem",itemDirective).directive("papsItemTemplate",itemDirectiveTemplate),itemCtrl.$inject=["Paps","$stateParams","$q","$uibModal","exception","global","$timeout","$scope","$anchorScroll"]}(),function(){function listDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:"components/paps/papsList.html"}}
function listCtrl(Paps,$state,global,exception,Confirm,$q){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items}).catch(function(err){exception.catcher("получение списка")(err)})}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){},function(err){exception.catcher("получение списка")(err)})},defer)}function createItem(name){return self.Items.save({name:name,action:name,url:name}).$promise}function deleteItem(item){Confirm("удалить?").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return getList()}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление страницы")(err)})}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Paps,self.query={},self.paginate={page:0,rows:10,totalItems:0},self.getList=getList,self.saveField=saveField,self.deleteItem=deleteItem,function(){getList().then(function(){var actions=[];if(self.items&&self.items.some(function(e){return"order"==e.action})||actions.push(createItem("order")),self.items&&self.items.some(function(e){return"feedback"==e.action})||actions.push(createItem("feedback")),self.items&&self.items.some(function(e){return"subscription"==e.action})||actions.push(createItem("subscription")),self.items&&self.items.some(function(e){return"subscriptionAdd"==e.action})||actions.push(createItem("subscriptionAdd")),self.items&&self.items.some(function(e){return"call"==e.action})||actions.push(createItem("call")),self.items&&self.items.some(function(e){return"booking"==e.action})||actions.push(createItem("booking")),self.items&&self.items.some(function(e){return"bonus"==e.action})||actions.push(createItem("bonus")),console.log(actions),actions.length)return $q.all(actions)}).then(function(res){if(res)return getList()}).catch(function(err){exception.catcher("получение списка")(err)})}()}angular.module("gmall.services").directive("papsList",listDirective),listCtrl.$inject=["Paps","$state","global","exception","Confirm","$q"]}(),function(){function infoService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getPaps."+error),$q.reject(error)}return paginate||(paginate={page:0}),Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(header,button){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/info/createItem.html",controller:createCtrl,size:"lg",controllerAs:"$ctrl",resolve:{header:function(){return header},button:function(){return button}}};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject()},function(err){reject(err)})})}function createCtrl($uibModalInstance,header,button){var self=this;self.header=header?header:"создание информационной страницы",self.button=button?button:"создать страницу",self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}}function selectInfo(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/info/selectInfo.html",controller:selectInfoCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedItem){resolve(selectedItem)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectInfoCtrl(Info,$uibModalInstance,$q){var self=this;$q.when().then(function(){return Info.getList()}).then(function(items){self.items=items}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(item){$uibModalInstance.close(item)}}var Items=$resource("/api/collections/Info/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create,selectInfo:selectInfo,select:selectInfo}}angular.module("gmall.services").service("Info",infoService),infoService.$inject=["$resource","$uibModal","$q"]}(),function(){function listDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:"components/info/infoList.html"}}function listTemplateDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:listCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/info/info.html"}}function listCtrl(Items,$q,$state,$stateParams,global,Confirm,exception,$fileUpload,Photo){function activate(page){return(page||0===page)&&(self.paginate.page=0),getList().then(function(){})}function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){if(self.block=0,$stateParams.block)for(var i=0;i<data.length;i++)if($stateParams.block==data[i]._id){self.block=i;break}return self.items=data,self.items})}function searchItems(searchStr){self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,activate()}function saveField(item,field){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise}function createItem(){self.Items.create().then(function(res){return self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){self.newItem._id;delete self.newItem._id}).catch(function(err){err&&(err=err.datsa||err,exception.catcher("создание объекта")(err))})}function deleteItem(item){Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){activate(0)}).catch(function(err){err&&exception.catcher("удаление страницы")(err)})}function dropCallback(item){var actions=[];return setTimeout(function(){self.items.forEach(function(item,idx){item.index=idx+1,actions.push(saveField(item,"index"))}),$q.all(actions)},100),item}function loadPhoto(item){self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Info",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Info",$q.when().then(function(){return $fileUpload.fileUpload(self.uploadUrl,"img")}).then(function(res){var a=[];res&&res.length&&(item.img&&a.push(item.img),item.img=res[0].data.img,saveField(item,"img"),a.length&&Photo.deleteFiles("Info",a))}).catch(function(err){console.log(err)})}function deletePhoto(item){Confirm("удалить?").then(function(){var a=[];item.img&&a.push(item.img),item.img=null,console.log(item),saveField(item,"img"),a.length&&Photo.deleteFiles("Info",a)})}var self=this;self.mobile=global.get("mobile").val,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"Новый информационный раздел",index:1},self.getList=getList,self.saveField=saveField,self.searchItems=searchItems,self.createItem=createItem,self.deleteItem=deleteItem,self.dropCallback=dropCallback,self.loadPhoto=loadPhoto,self.deletePhoto=deletePhoto,activate()}angular.module("gmall.services").directive("infoList",listDirective).directive("infoListTemplate",listTemplateDirective),listCtrl.$inject=["Info","$q","$state","$stateParams","global","Confirm","exception","$fileUpload","Photo"]}(),function(){function itemInfoLinkDirective(){return{scope:{info:"=",do:"&",title:"@"},rescrict:"E",bindToController:!0,controller:itemInfoLinkCtrl,controllerAs:"$ctrl",templateUrl:"components/info/createLink.html"}}function itemInfoLinkCtrl($q,Info,global){function setInfoLink(){$q.when().then(function(){return Info.selectInfo()}).then(function(tag){self.info.link=tag._id,self.info.name=tag.name,self.do()}).catch(function(){console.log("dismiss")})}function deleteLink(){self.info.link=null,self.info.name="",console.log(self.info),self.do()}var self=this;self.info||(self.info={}),self.setInfoLink=setInfoLink,self.deleteLink=deleteLink}function itemDirective(){return{scope:{},bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/info/infoItem.html"}}function itemCtrl(Items,$stateParams,$q,$uibModal,exception,global,$scope,$timeout,Confirm){function createNewRazdel(){self.Items.create("создание раздела","создать раздел").then(function(res){res&&saveEmbeddedField({name:res},"name")})}function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){return self.item=data,self.item}).catch(function(err){return $q.reject(err)})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field];var query={update:field};self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function saveEmbeddedField(item,field){var o={_id:self.item._id};field&&(o[field]=item[field]);var update={update:field,embeddedName:"blocks"};item._id?field?update.embeddedVal=item._id:(update.embeddedPull=!0,update.update="name",o.name=item.name):update.embeddedPush=!0,field?$q.when().then(function(){return self.Items.save(update,o).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),(update.embeddedPush||update.embeddedPull)&&activate($stateParams.id)}).catch(function(err){err&&(exception.catcher("saving")(err),console.log(err),err.data&&err.data.message&&err.data.message.indexOf("cannot use the part")>-1&&(console.log(field),update.update=field+"L",delete o[field],o[update.update]={},$q.when().then(function(){return self.Items.save(update,o).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),(update.embeddedPush||update.embeddedPull)&&activate($stateParams.id)}).catch(function(err){err&&exception.catcher("saving")(err)})))}):Confirm("удалить?").then(function(){return self.Items.save(update,o).$promise}).then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),(update.embeddedPush||update.embeddedPull)&&activate($stateParams.id)})}function dropCallback(item){return setTimeout(function(){saveField("blocks")},100),item}var self=this;self.Items=Items,self.global=global,self.mobile=global.get("mobile").val,self.saveField=saveField,self.saveEmbeddedField=saveEmbeddedField,self.dropCallback=dropCallback,self.createNewRazdel=createNewRazdel,activate(),$scope.$on("changeLang",function(){activate()})}function itemTemplateDirective(global){return{scope:{img:"@",info:"@"},bindings:{img:"@",info:"@"},bindToController:!0,controller:itemTemplateCtrl,controllerAs:"$ctrl",templateUrl:function(element,attrs){return attrs&&attrs.templ&&"0"!=attrs.templ&&console.log(attrs.templ),"views/template/partials/home/info/infoItem"+(attrs&&attrs.templ&&"0"!=attrs.templ?attrs.templ:"")+".html"}}}function itemTemplateCtrl($scope,Items,$stateParams,$q,$uibModal,exception,global,$attrs){function activate(id){return getItem(id)}function getItem(id){return self.Items.getItem(id).then(function(data){return data&&data.blocks&&data.blocks.length&&(data.blocks=data.blocks.filter(function(b){return b.actived})),self.item=data,self.item}).catch(function(err){exception.catcher("получение данных")(err)})}var self=this;self.$onInit=function(){self.info&&activate(self.info)},self.info&&activate(self.info),self.Items=Items,self.global=global,self.mobile=global.get("mobile").val}angular.module("gmall.services").directive("infoItem",itemDirective).directive("infoItemTemplate",itemTemplateDirective).directive("createInfoLink",itemInfoLinkDirective),itemInfoLinkCtrl.$inject=["$q","Info","global"],itemCtrl.$inject=["Info","$stateParams","$q","$uibModal","exception","global","$scope","$timeout","Confirm"],itemTemplateCtrl.$inject=["$scope","Info","$stateParams","$q","$uibModal","exception","global","$attrs"]}(),angular.module("gmall.services").service("createStuffService",function($uibModal,$q,$state,global){this.cloneStuff=function(stuff,clone){if(global.get("seller").val){if(stuff.seller=global.get("seller").val,console.log(global.get("seller")),stuff.brand=stuff.brand&&stuff.brand._id?stuff.brand._id:stuff.brand,stuff.brandTag=stuff.brandTag&&stuff.brandTag._id?stuff.brandTag._id:stuff.brandTag,stuff.category=stuff.category&&stuff.category._id?stuff.category._id:stuff.category,stuff.sortsOfStuff=stuff.sortsOfStuff&&stuff.sortsOfStuff._id?stuff.sortsOfStuff._id:stuff.sortsOfStuff,delete stuff._id,delete stuff.url,delete stuff.gallery,delete stuff.setTagsValue,delete stuff.sortsOfStuff,stuff.stock)for(var key in stuff.stock)stuff.stock[key].quantity=1;return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/createStuff/cloneStuffModal.html",controller:function($scope,stuff,$uibModalInstance,clone){var self=this;self.stuff=stuff,self.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.clone=clone,$scope.$watch("clone",function(n){"ready"==n&&$uibModalInstance.close(self.stuff)})},controllerAs:"$ctrl",size:"lg",resolve:{stuff:function(){return stuff},clone:function(){return clone}}}).result.then(function(stuff){resolve(stuff)},function(){reject("отказ")})})}}}).directive("createNewStuff",function(){function createStuffCtrl($uibModal,$q,Stuff,$state){var self=this;self.categoryDisabled=!0,self.selectCategory=function(){$uibModal.open({animation:!0,templateUrl:"components/selectCategoryModal/selectCategoryModal.html",controller:"selectCategoryModalCtrl",size:"lg",resolve:{categoryId:function(){return null}}}).result.then(function(selectedCategory){self.stuff.category||(self.categoryDisabled=!1,setTimeout(function(){$("#createStuffCategory").trigger("change"),self.categoryDisabled=!0},100)),self.stuff.category=selectedCategory},function(){})},self.createNewStuff=function(){return self.stuff.category?self.stuff.name?(self.stuff.name=self.stuff.name.substring(0,50),self.stuff.artikul&&(self.stuff.artikul=self.stuff.artikul.substring(0,50)),!self.clone&&self.stuff.category&&self.stuff.category._id&&(self.stuff.category=self.stuff.category._id),void $q.when().then(function(){return $q(function(resolve,reject){Stuff.Items.save(self.stuff,function(res){self.stuff._id=res.id,self.stuff.url=res.url,resolve(res.url)},function(err){reject(err)})})}).then(function(url){self.clone="ready"}).then(function(){}).catch(function(err){console.log(err)})):(self.alertMessage2=!0,void setTimeout(function(){self.alertMessage2=!1},3e3)):(self.alertMessage2=!0,void setTimeout(function(){console.log("))))"),self.alertMessage2=!1},3e3))}}return{scope:{stuff:"=",clone:"="},bindToController:!0,controller:createStuffCtrl,controllerAs:"$ctrl",templateUrl:"components/createStuff/createStuff.html"}}),angular.module("gmall.directives").directive("sortsOfStuff",function(){return{scope:{stuff:"="},bindToController:!0,controller:sortsOfStuffctrlCtrl,controllerAs:"$ctrl",templateUrl:"components/sortsOfStuff/sortsOfStuff.html"}}),sortsOfStuffctrlCtrl.$inject=["$uibModal","$resource","Stuff","$q","createStuffService","exception","global","$timeout"];var SortsOfSfuffSchema={store:[{type:"Schema.ObjectId",ref:"Store"}],filterOne:{type:"Schema.ObjectId",ref:"Filter"},filterTwo:{type:"Schema.ObjectId",ref:"Filter"},tagsOne:[{tag:{type:"Schema.ObjectId",ref:"FilterTags"},stuff:{type:"Schema.ObjectId",ref:"Stuff"}}],tagsTwo:{},differentPrice:{type:Boolean,default:!1}};!function(){function categoriesForListTatiana(global){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",templateUrl:"views/"+global.get("store").val.template.folder+"/partials/category/categoriesForList.html"}}function categoriesForListTemplate(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListTemplate1(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListTemplate2(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListTemplate3(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",transclude:!0,link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}function categoriesForListDirective(){return{scope:{padding:"="},restrict:"E",bindToController:!0,controller:categoriesForListCtrl,controllerAs:"$ctrl",templateUrl:"components/categoriesForList/categoriesForList.html"}}function categoriesForListCtrl($stateParams,$state,$q,$location,global){function changeCategory(category,tag){var brand=$stateParams.brand?brand=$stateParams.brand:null,queryTag=null;tag&&("sale"==tag?queryTag=global.get("store").val.saleTag:(tag="new")&&(queryTag=global.get("store").val.newTag));var o={groupUrl:$stateParams.groupUrl,categoryUrl:category,queryTag:queryTag,brand:brand,brandTag:null,searchStr:void 0};$state.go("stuffs",o,{reload:!0,lacation:!0,inherit:!1,notify:!0})}function deleteCrumb(index){!function(type){var query=self.breadcrumbs.reduce(function(q,item){return item.type==type&&(q&&(q+="__"),q+=item.url),q},"");query||(query=null),$location.search(type,query)}(self.breadcrumbs.splice(index,1)[0].type)}function checkInnerData(){return!!$ctrl.parentSection&&($ctrl.parentSection.categories.length&&$ctrl.parentSection.categories.filter(function(c){return!c.notActive}).length>1)}function getFilterTagsPhoto(url){return global.get("filterTags").val.getOFA("url",url)}if(global.get("store").val){var self=this,$ctrl=self;self.getFilterTagsPhoto=getFilterTagsPhoto,self.global=global,self.prop={},self.category=$stateParams.categoryUrl,self.parentSection=global.get("parentSection").val,self.breadcrumbs=global.get("breadcrumbs").val,self.changeCategory=changeCategory,self.deleteCrumb=deleteCrumb,self.checkInnerData=checkInnerData,self.queryTag=null,$stateParams.queryTag&&(global.get("store").val.saleTag&&global.get("store").val.saleTag==$stateParams.queryTag?self.queryTag="sale":global.get("store").val.newTag&&global.get("store").val.newTag==$stateParams.queryTag&&(self.queryTag="new"))}}angular.module("gmall.directives").directive("categoriesForList",categoriesForListDirective).directive("categoriesForListTatiana",categoriesForListTatiana).directive("categoriesForListTemplate",categoriesForListTemplate).directive("categoriesForListTemplate1",categoriesForListTemplate1).directive("categoriesForListTemplate2",categoriesForListTemplate2).directive("categoriesForListTemplate3",categoriesForListTemplate3),categoriesForListCtrl.$inject=["$stateParams","$state","$q","$location","global"]}(),angular.module("gmall.services").service("filterStuffsListService",function($uibModal,$q,Filters){this.setFilters=function(query){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/filterStuffsList/filterStuffsList.html",controller:function($scope,$stateParams,Sections,$uibModalInstance,query,$location){var self=this;self.global=global,self.query=query,console.log(query),$q.when().then(function(){return Filters.getFilters()}).then(function(filters){self.filters=filters}).then(function(){return Sections.getSections()}).then(function(sections){"brand"!=$stateParams.groupUrl&&"group"!=$stateParams.groupUrl&&($stateParams.parentGroup?self.parentSection=Sections.getParentSection($stateParams.parentGroup):self.parentSection=Sections.getParentSection($stateParams.groupUrl),"allCategories"!=$stateParams.categoryList&&"category"==$stateParams.categoryUrl||"category"!=$stateParams.categoryUrl&&self.parentSection&&self.parentSection.categories&&(self.category=self.parentSection.categories.getOFA("url",$stateParams.categoryUrl),self.category&&self.category.filters&&self.category.filters.length&&(self.filters=self.filters.filter(function(filter){return self.category.filters.indexOf(filter._id)>-1})))),self.filters&&self.filters.length||$uibModalInstance.dismiss("cancel"),query&&query.tags&&"object"==typeof query.tags&&self.filters.forEach(function(filter){query.tags[filter._id]&&filter.tags.forEach(function(tag){query.tags[filter._id].indexOf(tag._id)>-1&&(tag.set=!0)})})}),self.changeAllTags=function(filter){filter.tags.forEach(function(tag){tag.set=!1})},self.clearAll=function(){self.filters.forEach(function(filter){filter.tags.forEach(function(tag){tag.set=!1})})},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(){query.tags={};var queryTag="";self.filters.forEach(function(filter){var arr=[];filter.tags.forEach(function(tag){tag.set&&(arr.push(tag._id),queryTag&&(queryTag+="+"),queryTag+=tag.url)}),arr.length&&(query.tags[filter._id]=arr)}),queryTag?$location.search("queryTag",queryTag):$location.search("queryTag",null),$uibModalInstance.close(self.query)}},controllerAs:"$ctrl",size:"lg",resolve:{query:function(){return query}}}).result.then(function(query){resolve(query)},function(){reject("отказ")})})}}),function(){function serviceFunction($uibModal,$q){function doIt(model,_id,Item){var item=angular.copy(Item);return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/editModel/editModel.html",controller:editModelCtrl,size:"lg",controllerAs:"$ctrl",resolve:{model:function(){return model},_id:function(){return _id},item:function(){return item}}}).result.then(function(){var img;item.img&&item.img.indexOf("data:image")<0&&(img=item.img),resolve(img)},function(){var img;item.img&&item.img.indexOf("data:image")<0&&(img=item.img),resolve(img)})})}function editModelCtrl($resource,$uibModalInstance,$q,model,_id,item){function saveField(field,defer){defer=defer||0;var o={_id:self.item._id};setTimeout(function(){o[field]=self.item[field],self.Items.save({update:field},o)},defer)}var self=this,url="/api/collections/"+model+"/:_id";self.urlFile="/api/collections/"+model+"/fileUploadBig",self.Items=$resource(url,{_id:"@_id"}),self.saveField=saveField,self.item=item,function(){$q.when().then(function(){return self.Items.get({_id:_id}).$promise}).then(function(res){res&&(self.item=res)}).catch(function(){self.cancel()})}(),self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(){$uibModalInstance.close(self.item)}}return{doIt:doIt}}angular.module("gmall.services").service("EditModelData",serviceFunction),serviceFunction.$inject=["$uibModal","$q"]}(),angular.module("gmall.services").factory("seoContent",["global","$stateParams","$resource","$state","$q","$sce",function(global,$stateParams,$resource,$state,$q,$sce){function setTitles(titles,res,noFooter){res.seo?(res.seo.title?titles.title=res.seo.title:titles.title=res.name,res.seo.description?titles.description=res.seo.description:titles.description=res.desc.replace(regex,"").substring(0,200),res.seo.keywords&&(titles.keywords=res.seo.keywords)):(titles.title=res.name,res.desc?titles.description=res.desc.replace(regex,"").substring(0,200):titles.description=""),noFooter||(res.desc?titles.pageDescFooter=res.desc.replace(regex,""):titles.pageDescFooter="",titles.namePageFooter=res.name)}function getSeoPageInfo(titles){if(!global.get("seopage")||!global.get("seopage").val||!global.get("seopage").val.length)return!1;titles.pageDescFooter||(titles.pageDescFooter=""),titles.namePageFooter||(titles.namePageFooter="");for(var i=0,l=global.get("seopage").val.length;i<l;i++){var a=global.get("seopage").val[i];console.log(a.url);var href=titles.canonical?titles.canonical:$location.path();if("http://"+global.get("store").val.domain+a.url==href)return a._id}return!1}function setSeopageData(){return $q.when().then(function(){return global.get("currentSeopage")?global.get("currentSeopage").val:null}).then(function(seopage){if(seopage)var sp=global.get("seopages").val.getOFA("link",seopage.link);if(sp&&!sp.data&&(seopage.seo||(seopage.seo={}),seopage.seo.keywords=seopage.keywords.map(function(w){return w.word}).filter(function(w){return w}).join(","),sp.data=seopage),seopage){var titlesTemp=global.get("titles").val,titles=seopage.seo;return titlesTemp&&titlesTemp.image&&!titles.image&&(titles.image=titlesTemp.image),titles.title=seopage.title||titles.title,titles.domain=global.get("store").val.link,titles.author=titles.author||global.get("store").val.name,titles.canonical=$sce.trustAsResourceUrl(global.get("store").val.link+seopage.link),seopage.desc&&(titles.desc=seopage.desc),global.set("titles",titles),!0}})}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}var regex=/<\/?[^>]+(>|$)/g;return{setSeopageData:setSeopageData,setDataCatalog:function(){setSeopageData().then(function(seopageIs){if("stuffs.stuff"!=$state.current.name&&!seopageIs){var s=global.get("store").val,titles={};if(global.get("category")&&global.get("category").val){var c=global.get("category").val;global.get("langForm").val&&(titles.title=c.section.name+" "+c.name+" "+global.get("lang").val.inn+" "+s.name+".",titles.description=capitalizeFirstLetter(global.get("langForm").val.toorder)+" "+global.get("lang").val.onLine+" "+c.section.name+" "+c.name+" "+global.get("lang").val.inn+" "+s.name+","+s.location),titles.keywords=s.name+","+c.name+","+c.section.name+","+s.location,c.section.subSectionName&&(titles.keywords+=","+c.section.subSectionName),titles.canonical=$sce.trustAsResourceUrl(global.get("store").val.link+"/"+c.linkData.groupUrl+"/"+c.linkData.categoryUrl)}else if($stateParams.groupUrl&&"group"!=$stateParams.groupUrl){var sectionUrl=$stateParams.groupUrl,sec=global.get("functions").val.getSection(sectionUrl);if(sec){global.get("langForm").val&&(titles.title=capitalizeFirstLetter(global.get("langForm").val.toorder)+" "+sec.name+" "+global.get("lang").val.inn+" "+s.name+" "+global.get("lang").val.onLine+".");var categories="";sec.categories.length&&sec.categories.forEach(function(c,i){i&&(categories+=","),categories+=c.name}),titles.keywords=s.name+","+sec.name+","+s.location+","+categories,global.get("langForm").val&&(titles.description=capitalizeFirstLetter(global.get("langForm").val.toorder)+" "+global.get("lang").val.onLine+" "+sec.name+categories+" "+global.get("lang").val.inn+" "+s.name+" "+s.name+","+s.location),titles.canonical=global.get("store").val.link+"/"+sec.url+"/category"}else console.log("???"),titles.canonical="",titles.title="Заказать из каталога "+s.name+" онлайн.",titles.keywords=s.name+",каталог,"+s.location,titles.description="Заказ онлайн из каталога в "+s.name+","+s.location;titles.canonical=$sce.trustAsResourceUrl(titles.canonical)}else titles.title="Заказать из каталога "+s.name+" онлайн.",titles.keywords=s.name+",каталог,"+s.location,titles.description="Заказ онлайн из каталога в "+s.name+","+s.location,titles.canonical=global.get("store").val.link+"/group/category",titles.canonical=$sce.trustAsResourceUrl(titles.canonical);titles.domain=s.link,titles.author=s.name,global.set("titles",titles)}})},setDataHomePage:function(){setSeopageData()},setDataItem:function(item,news){var domain=global.get("store").val.link,titles=angular.copy(global.get("store").val.seo);if(titles||(titles={}),news){var img=item.img?item.img:"";titles.url=domain+"/news/"+item.url,titles.type="article"}else{var img=item.gallery&&item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:"";titles.url=domain+"/"+item.link,titles.type="product"}img&&(img=photoHost+"/"+img),titles.image=img;try{titles.canonical=$sce.trustAsResourceUrl(titles.url)}catch(err){console.log(err)}return titles.title=item.name,news||(item.artikul&&(titles.title+=" "+item.artikul),titles.title=item.categoryName+" "+titles.title),global.set("titles",titles),!0},setDataList:function(type,name){setSeopageData().then(function(seopageIs){if(console.log("seopageIs",seopageIs),!seopageIs){var domain=global.get("store").val.link,titles=angular.copy(global.get("store").val.seo);titles||(titles={}),titles.url=domain+"/"+type,titles.type="";try{titles.canonical=$sce.trustAsResourceUrl(titles.url)}catch(err){console.log(err)}return global.set("titles",titles),!0}})},setData404:function(res){var seoPageId,titles={pageTitle:"",pageDescription:"",pageKeyWords:""},titles=angular.copy(global.get("store").val.seo);titles.canonical=$sce.trustAsResourceUrl("http://"+global.get("store").val.domain+"/404"),titles.url=titles.canonical,(seoPageId=getSeoPageInfo(titles))?$resource("/api/collections/Seopage/:id",{id:"@_id"}).get({id:seoPageId},function(res){setTitles(titles,res,!0),global.set("titles",titles)}):global.set("titles",titles)}}}]),angular.module("gmall.directives").directive("additionaInfo",function(){return{scope:{stuff:"="},bindToController:!0,controller:additionaInfoCtrl,controllerAs:"$ctrl",templateUrl:"components/additionaInfo/additionaInfo.html"}}).service("AddInfo",function($resource,$q,$uibModal){function selectItem(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/additionalInfo/selectItem.html",controller:selectItemCtrl,size:"lg",controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selected){resolve(selected)},function(){reject()})})}function selectItemCtrl(Filters,AddInfo,$uibModalInstance,$q,global){var self=this;self.global=global,self.lang=global.get("lang").val,$q.when().then(function(){return Filters.getFilters()}).then(function(filters){return self.filters=filters,AddInfo.query().$promise}).then(function(addInfos){self.filters.forEach(function(f){f.addInfos=[],addInfos.forEach(function(a){a.filter==f._id&&f.addInfos.push(a)})})}),self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(item){$uibModalInstance.close(item)}}function editTable(filter,addInfo){return $uibModal.open({animation:!0,templateUrl:"components/additionalInfo/additionalInfo.html",controller:function(filter,carrentAddInfo,AddInfo,$uibModalInstance,global,exception,Confirm){function activate(){initItem(),AddInfo.query({query:query},function(res){res.shift(),self.items=res},function(err){console.log(err)})}function initItem(){if(self.item={headerTable:{},table:{},name:"",filter:filter._id},filter.tags.forEach(function(tag){self.item.table[tag._id]={}}),langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[lang]=[""];for(var key in self.item.table)self.item.table[key][lang]=[""]});else{self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[self.lang]=[""];for(var key in self.item.table)self.item.table[key][self.lang]=[""]}}var self=this;self.global=global,self.lang=global.get("store").val.lang;var langArr=global.get("store").val.langArr;console.log(langArr),filter?self.filter=filter:$uibModalInstance.dismiss("cancel");var query={filter:filter._id};self.items=[],activate(),self.getTagName=function(id){for(var i=1,l=self.filter.tags.length;i<l;i++)if(self.filter.tags[i]._id==id)return self.filter.tags[i].name;return"noname"},self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.saveTable=function(){self.item.name||(self.item.name=filter.name),self.item._id?AddInfo.save({update:"headerTable table name"
},self.item,function(res){activate()}):AddInfo.save(self.item,function(res){activate()})},self.addRow=function(){if(langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[lang].push("");for(var key in self.item.table)self.item.table[key][lang].push("")});else{self.item.headerTable||(self.item.headerTable={}),self.item.headerTable[self.lang].push("");for(var key in self.item.table)self.item.table[key][self.lang].push("")}console.log(self.item)},self.deleteRow=function(i){if(langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable[lang].splice(i,1);for(var key in self.item.table)self.item.table[key][lang].splice(i,1)});else{self.item.headerTable[self.lang].splice(i,1);for(var key in self.item.table)self.item.table[key][self.lang].splice(i,1)}},self.editTable=function(item){if(console.log(item),self.item=item,langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable[lang].push("");for(var key in self.item.table)self.item.table[key][lang].push("")});else{self.item.headerTable[self.lang].push("");for(var key in self.item.table)self.item.table[key][self.lang].push("")}},self.deleteTable=function(item){Confirm("удалить?").then(function(){return AddInfo.delete({id:item._id}).$promise}).then(function(){return activate()}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление")(err)})},self.setTable=function(item){if(self.item=item,langArr&&langArr.forEach&&langArr.length)langArr.forEach(function(lang){self.item.headerTable||(self.item.headerTable={},self.item.headerTable[lang]=[],self.item.headerTable[lang].push(""));for(var key in self.item.table)self.item.table[key][lang]||(self.item.table[key][lang]=[],self.item.table[key][lang].push(""))});else{self.item.headerTable||(self.item.headerTable={},self.item.headerTable[self.lang]=[],self.item.headerTable[self.lang].push(""));for(var key in self.item.table)self.item.table[key].length&&(self.item.table[key]={},self.item.table[key][self.lang]=[],self.item.table[key][self.lang].push(""))}console.log(self.item)}},controllerAs:"$ctrl",size:"lg",resolve:{filter:function(){return filter},carrentAddInfo:function(){return addInfo}}}).result.then(function(addInfo){console.log(addInfo)},function(){})}var Items=$resource("/api/collections/AddInfo/:id",{id:"@_id"});this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.editTable=editTable,this.select=selectItem,selectItemCtrl.$inject=["Filters","AddInfo","$uibModalInstance","$q","global"]}),function(){function staticPageDirective(){return{scope:{},bindToController:!0,controller:staticPageCtrl,controllerAs:"$ctrl",templateUrl:"components/staticPage/staticPage.html"}}function staticPageTemplateDirective($stateParams){return{bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$scope","$element","$compile","$http","$stateParams","global",function($scope,$element,$compile,$http,$stateParams,global){var self=this;$http.get("views/template/partials/Stat/itemPage/"+$stateParams.id).then(function(response){self.content=response.data.html;var linkFn=$compile(response.data.html),content=linkFn($scope);$element.append(content),global.set("titles",response.data.titles)})}]}}function staticPageCtrl(Stat,$stateParams,global,Photo,$q,$uibModal,Stuff,FilterTags,BrandTags,Brands,Campaign,Category,$timeout,$scope,Confirm,SetCSS){function activate(){Stat.get({_id:$stateParams.id}).$promise.then(function(res){res&&!res.blocks&&(res.blocks=[],saveField("blocks",[]));var bl=res.blocks.filter(function(b){return b});bl.length!=res.blocks.length&&(saveField("blocks",bl),res.blocks=bl),console.log(res.blocks),res.blocks.forEach(function(b,i){b&&(b.i=i)}),res.blocks.sort(function(a,b){return a.index-b.index}),self.item=res})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField("blocks."+block.i,block)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks");setTimeout(function(){var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},100)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}function deleteBlock(block,index){var o={_id:self.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("подтверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.item.blocks.splice(index,1);var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Stat",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/staticPage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function filterBlocks(item){return keyParts.indexOf(item.key)>-1}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){block[block.type]||(block[block.type]=[]);var img,link,url=item.url;switch(block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,url:url}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,url:url})),saveField("blocks."+block.i+".imgs",block.imgs)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs)},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs)}function changeItem(block,$index){addItemInBlock(block,$index)}var self=this;self.Items=Stat,self.type="Stat",self.global=global,self.listOfBlocksForStaticPage=listOfBlocksForAll,self.listOfBlocks=listOfBlocksForAll,self.animationTypes=animationTypes,self.setStyles=setStyles,self.saveField=saveField,self.newBlock=null,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.filterBlocks=filterBlocks,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,activate(),$scope.$on("changeLang",function(){activate()});var keyParts=global.get("store").val.template.stat.parts.filter(function(el){return el.is}).map(function(el){return el.name})}angular.module("gmall.directives").directive("staticPage",staticPageDirective).directive("staticPageTemplate",staticPageTemplateDirective),staticPageCtrl.$inject=["Stat","$stateParams","global","Photo","$q","$uibModal","Stuff","FilterTags","BrandTags","Brands","Campaign","Category","$timeout","$scope","Confirm","SetCSS"]}(),function(){function staticPagesDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:staticPagesCtrl,controllerAs:"$ctrl",templateUrl:"components/staticPage/staticPages.html"}}function staticPagesCtrl(Items,$state,global,Confirm,exception,$q,Photo,$timeout){function activate(page){return(page||0===page)&&(self.paginate.page=0),getList().then(function(){console.log("Activated staticPage list View")})}function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItems(searchStr){self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,activate()}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){console.log("saved"),global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createItem(){self.Items.create().then(function(res){return self.newItem={name:"Новая статическая страница",actived:!1},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){$state.go("frame.stats.stat",{id:self.newItem._id})}).catch(function(err){exception.catcher("создание компании")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Stat/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return activate(0),Photo.deleteFolder("Stat",folder)}).catch(function(err){exception.catcher("удаление компании")(err)})}function movedItem(){var actions=self.items.map(function(e,i){return e.index=i,self.saveField(e,"index")});$q.all(actions)}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:25,totalItems:0},self.newItem={name:"Новая статическая страница",actived:!1},self.getList=getList,self.saveField=saveField,self.searchItems=searchItems,self.createItem=createItem,self.deleteItem=deleteItem,self.movedItem=movedItem,activate()}angular.module("gmall.services").directive("staticPages",staticPagesDirective),staticPagesCtrl.$inject=["Stat","$state","global","Confirm","exception","$q","Photo","$timeout"]}(),function(){function statService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/staticPage/createStaticPage.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}function selectItem(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components/staticPage/selectItem.html",controller:selectItemCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectItemCtrl(Stat,$uibModalInstance,$q){var self=this;$q.when().then(function(){return Stat.getList({rows:100,page:0})}).then(function(stats){self.stats=stats}),self.cancel=function(){$uibModalInstance.dismiss("cancel")},self.ok=function(stat){$uibModalInstance.close(stat)}}var Items=$resource("/api/collections/Stat/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create,selectItem:selectItem}}angular.module("gmall.services").service("Stat",statService),statService.$inject=["$resource","$uibModal","$q"]}(),function(){function additionalDirective(){return{scope:{},bindToController:!0,controller:pageCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/additional/additional.html"}}function pageCtrl(Additional,$stateParams,global,Photo,$q,$uibModal,News,Stuff,FilterTags,BrandTags,Brands,Campaign,Category,$timeout,$scope,Confirm,SetCSS){function activate(){self.Items.get({_id:$stateParams.id}).$promise.then(function(res){res&&!res.blocks&&(res.blocks=[],saveField("blocks",[]));var bl=res.blocks.filter(function(b){return b});bl.length!=res.blocks.length&&(saveField("blocks",bl),res.blocks=bl),res.blocks.forEach(function(b,i){b&&(b.i=i)}),res.blocks.sort(function(a,b){return a.index-b.index}),self.item=res})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField("blocks."+block.i,block)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks");setTimeout(function(){var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},100)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){if(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}}function deleteBlock(block,index){var o={_id:self.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("подтверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.item.blocks.splice(index,1);var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Additional",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Additional",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/additional/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"news":model=News;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){block[block.type]||(block[block.type]=[]);var img,link,url=item.url;switch(block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"news":img=item.img?item.img:null,link="news/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,url:url}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,url:url})),saveField("blocks."+block.i+".imgs",block.imgs)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs)},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs)}function changeItem(block,$index){addItemInBlock(block,$index)}var self=this;self.Items=Additional,self.type="Additional",self.global=global,self.listOfBlocksForStaticPage=listOfBlocksForStaticPage,self.listOfBlocks=listOfBlocksForStaticPage,self.setStyles=setStyles,self.saveField=saveField,self.newBlock=null,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,activate(),$scope.$on("changeLang",function(){activate()});global.get("store").val.template.additional.parts.filter(function(el){return el.is}).map(function(el){return el.name})}angular.module("gmall.directives").directive("additionalPage",additionalDirective),pageCtrl.$inject=["Additional","$stateParams","global","Photo","$q","$uibModal","News","Stuff","FilterTags","BrandTags","Brands","Campaign","Category","$timeout","$scope","Confirm","SetCSS"]}(),function(){function additionalPagesDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:pagesCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/additional/additionals.html"}}function pagesCtrl(Items,$state,global,Confirm,exception,$q,Photo,$timeout){function activate(page){return(page||0===page)&&(self.paginate.page=0),getList().then(function(){console.log("Activated  list View")})}function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItems(searchStr){self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,activate()}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){console.log("saved"),global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createItem(){self.Items.create().then(function(res){return self.newItem={name:"Новая  страница",actived:!1},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){$state.go("frame.additionals.additional",{id:self.newItem._id})}).catch(function(err){exception.catcher("создание страницы")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Additional/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return activate(0),Photo.deleteFolder("Additional",folder)}).catch(function(err){exception.catcher("удаление страницы")(err)})}function movedItem(){var actions=self.items.map(function(e,i){return e.index=i,self.saveField(e,"index")});$q.all(actions)}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:5,totalItems:0},self.newItem={name:"Новая  страница",actived:!1},self.getList=getList,self.saveField=saveField,self.searchItems=searchItems,self.createItem=createItem,self.deleteItem=deleteItem,self.movedItem=movedItem,activate()}angular.module("gmall.services").directive("additionalPages",additionalPagesDirective),pagesCtrl.$inject=["Additional","$state","global","Confirm","exception","$q","Photo","$timeout"]}(),function(){function statService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/CONTENT/additional/createAdditional.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}function selectItem(){return $q(function(resolve,reject){var options={animation:!0,templateUrl:"components//CONTENT/additional/selectItem.html",controller:selectItemCtrl,controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(selectedFilterTag){resolve(selectedFilterTag)},function(){console.log("Modal dismissed at: "+new Date),reject()})})}function selectItemCtrl(Additional,$uibModalInstance,$q){var self=this;$q.when().then(function(){return Additional.getList({rows:100,page:0})}).then(function(items){self.items=items}),self.cancel=function(){$uibModalInstance.dismiss()},self.ok=function(item){$uibModalInstance.close(item)}}var Items=$resource("/api/collections/Additional/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create,selectItem:selectItem}}angular.module("gmall.services").service("Additional",statService),statService.$inject=["$resource","$uibModal","$q"]}(),function(){function labelDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:pagesCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/label/labels.html"}}function pagesCtrl(Items,$state,global,Confirm,exception,$q,$timeout){function activate(page){return(page||0===page)&&(self.paginate.page=0),getList().then(function(){console.log("Activated  list View")})}function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItems(searchStr){self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,activate()}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){console.log("saved"),global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createItem(){self.Items.create().then(function(res){return self.newItem={name:"Новая  страница",actived:!1},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).catch(function(err){exception.catcher("создание страницы")(err)})}function deleteItem(item){Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){activate(0)}).catch(function(err){exception.catcher("удаление страницы")(err)})}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"Новая  метка",actived:!1},self.lists=listOfListName.map(function(n){var o={name:n,type:n};return global.get("store").val.nameLists[n+"List"]&&(o.name=global.get("store").val.nameLists[n+"List"]),o}),self.getList=getList,self.saveField=saveField,self.searchItems=searchItems,self.createItem=createItem,self.deleteItem=deleteItem,activate()}angular.module("gmall.services").directive("labels",labelDirective),pagesCtrl.$inject=["Label","$state","global","Confirm","exception","$q","$timeout"]}(),function(){function labelsService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/CONTENT/label/createItem.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Label/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,query:Items.query,get:Items.get,create:create}}angular.module("gmall.services").service("Label",labelsService),labelsService.$inject=["$resource","$uibModal","$q"]}(),angular.module("gmall.services").service("HomePage",function($resource,$uibModal){function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/homePage/selectItem.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}var Items=$resource("/api/collections/HomePage/:_id",{_id:"@_id"});this.query=Items.query,this.get=Items.get,this.delete=Items.delete,this.save=Items.save,this.selectItemFromList=selectItemFromList}).directive("parallaxBanner",function($timeout){return{scope:{},restrict:"C",link:function(scope,elem,attr){function doIt(){var elementTop=$(elem).offset().top,viewportTop=($(elem).outerHeight(),$(window).scrollTop()),viewportBottom=viewportTop+$(window).height();$(window).height();if(elementTop<viewportBottom){var yPos=(parseInt(elem.css("background-position-y")),(elementTop-viewportBottom+$(elem).height())/4),coords="0% "+yPos+"px";elem.css({backgroundPosition:coords})}}var $window=$(window);$timeout(function(){doIt()},100),$(window).scroll(doIt),elem.on("$destroy",function(){angular.element($window).off("scroll",doIt)})}}}).directive("homePage",function(){function homePageCtrl(HomePage,$stateParams,$state,$q,global,$http,$uibModal,Stuff,Filters,FilterTags,Category,exception,BrandTags,Store,Brands,EditModelData,Photo,News,Campaign,Info,$scope,$timeout,Confirm,SetCSS,$rootScope){function getNameBlock(type){return listOfBlocksForAll[type]?listOfBlocksForAll[type]:type}function activate(){$q.when().then(function(){return self.blockForAdd=null,$q(function(resolve,reject){self.Items.get({_id:self.store.subDomain},function(res){resolve(res)},function(err){console.log(err),err&&err.status&&404==err.status?resolve(404):resolve()})})}).then(function(res){if(res&&404!=res)self.item=res,self.item.blocks||(self.item.blocks=[]),self.item.blocks.forEach(function(el,index){el.i=index});else if(404==res)return self.item={url:self.store.subDomain,header:[],left:[],right:[],blocks:[]},self.Items.save(self.item).$promise}).then(function(res){self.item&&!self.item._id&&res&&res.id&&(self.item._id=res.id)}).catch(function(err){exception.catcher("получение home page")(err)})}function addBlock(type){if(type){return console.log("addNewBlock"),$scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}}function cloneBlock(block){if(!delay){delay=!0,$timeout(function(){delay=!1},2e3);var newBlock=angular.copy(block);delete newBlock._id,delete newBlock.__v,newBlock.index?newBlock.index++:newBlock.index=1,newBlock.img=null,newBlock.imgs=[];["stuffs","filterTags","brandTags","categories","brands","news","campaign","info","filters"].forEach(function(field){newBlock[field]&&newBlock[field].length&&(newBlock[field]=newBlock[field].map(function(item){return item._id}))}),self.item.blocks.forEach(function(block){block.index&&block.index>=newBlock.index&&(newBlock.index=block.index+1)}),self.item.blocks.push(newBlock);var o={_id:self.item._id};o[blocks]=self.item.blocks;var update={update:"blocks"};Confirm("потверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){$timeout(function(){global.set("saving",!1)},1500),activate()}).catch(function(err){err&&exception.catcher("добавление блока")(err)})}}function refreshBlocks(){return self.item.blocks=null,self.Items.get({_id:self.store.subDomain}).$promise.then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function deleteBlock(block){var update,o={_id:self.item._id};Confirm("потверждаете?").then(function(){return self.item.blocks.splice(block.i,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),
block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Homepage",images)}).then(function(){activate()})}function saveInfo(){saveField("info")}function saveField(field,value){console.log(field,value),field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),field.indexOf(".type")>-1&&activate()})},100)}function movedSlide(block,field,item){return setTimeout(function(){block[field].forEach(function(el,i){el.index=i}),self.saveField(block,null,field)},100),item}function deleteSlide(block,index,$index){Confirm("Удалить?").then(function(){return Photo.deleteFiles("Homepage",[block.imgs[index].img])}).then(function(response){block.imgs.splice(index,1),self.saveField(block,$index,"imgs")},function(err){console.log(err)})}function editSlide(block,index,$index){$uibModal.open({animation:!0,templateUrl:"components/homePage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;slide.button||(slide.button={}),self.item=slide,self.animationTypes=animationTypes,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField(block,$index,"imgs",null,index)},function(){})}function movedStuff(block,item){return setTimeout(function(){saveFieldInSide(block)},100),item}function editModelData(block,i){var model=block.type,items=block[block.type];if(items[i]&&items[i]._id){var field;"brands"==model?field="Brand":"categories"==model?field="Category":"filterTags"==model?field="FilterTags":"filters"==model?field="Filters":"brandTags"==model?field="BrandTags":"stuffs"==model?field="Stuff":"news"==model?field="News":"campaign"==model?field="Campaign":"info"==model&&(field="Info"),$q.when().then(function(){return EditModelData.doIt(field,items[i]._id,items[i])}).then(function(img){console.log(img==items[i].img),img&&img!=items[i].img&&(items[i].img=img,console.log(img))})}else setCollection(items,i)}function addItemInBlock(block){var field=block.type;block[block.type]||(block[block.type]=[]);var Items,collections=block[block.type];"brands"==field?Items=Brands:"categories"==field?Items=Category:"filterTags"==field?Items=FilterTags:"filters"==field?Items=Filters:"brandTags"==field?Items=BrandTags:"stuffs"==field?Items=Stuff:"news"==field?Items=News:"campaign"==field?Items=Campaign:"info"==field&&(Items=Info),$q.when().then(function(){return Items.select({actived:!0})}).then(function(item){collections.push(item),self.saveFieldInSide(block)}).catch(function(){console.log("dismiss")})}function setCollection(block,idx){var Items,field=block.type,collections=block[block.type];"brands"==field?Items=Brands:"categories"==field?Items=Category:"filterTags"==field?Items=FilterTags:"filters"==field?Items=Filters:"brandTags"==field?Items=BrandTags:"stuffs"==field?Items=Stuff:"news"==field?Items=News:"campaign"==field?Items=Campaign:"info"==field&&(Items=Info),$q.when().then(function(){return Items.select()}).then(function(item){collections[idx]=item,self.saveFieldInSide(block)}).catch(function(){console.log("dismiss")})}function saveFieldInSide(item){var field=item.type;console.log(item[item.type]);var o={_id:self.item._id};o[field]=item[field].map(function(e){return e._id});var update={update:field,embeddedName:self.activeSide};return update.embeddedVal=item._id,console.log(update,o),self.Items.save(update,o).$promise}function deleteCollection(block,idx){block[block.type].splice(idx,1),saveFieldInSide(block)}function getNameCollection(type){switch(type){case"categories":return"категории";case"brands":return"бренды";case"brandTags":return"коллекции";case"filterTags":return"признаки";case"filters":return"характеристики";default:return"???????"}}function setColor(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField(block,idx,"blockStyle"),console.log(block.elements),saveField(block,idx,"elements")})}function uploadHP(){Confirm("выгрузить?").then(function(){return $http.post("/api/setTemplateHP",{template:{blocks:self.item.blocks},store:global.get("store").val._id})}).then(function(res){exception.showToaster("success","статус","обновлено")}).catch(function(err){exception.catcher("выгрузка шаблона")(err)})}function downloadHP(){Confirm("загрузить?").then(function(){return $http.get("/views/templatesHP/"+global.get("store").val.subDomain+".json")}).then(function(res){if(console.log(res.data),!res.data||!res.data.blocks)throw"не верный формат данных";var o={_id:self.item._id};o.blocks=res.data.blocks,self.Items.save({update:"blocks"},o,function(){self.item.blocks=res.data.blocks,exception.showToaster("success","статус","обновлено")})}).catch(function(err){exception.catcher("загрузка шаблона")(err)})}function deleteIndexPageHtml(){Confirm("перезаписать страницу?").then(function(){return $http.get("/api/deleteIndexPageHtml")}).then(function(res){exception.showToaster("info","все OK")}).catch(function(err){exception.catcher("сброс страницы")(err)})}function getBlockConfig(block){$q.when().then(function(){return $http.get("/api/getBlocksHP/"+block.type)}).then(function(res){if(res.data)return HomePage.selectItemFromList(res.data)}).then(function(b){if(b){if(block.img);else if(block.video)Photo.deleteFiles("Homepage",[block.video]);else if(block.imgs&&"stuffs"!=block.type){var a=[];block.imgs.forEach(function(i){a.push(i.img)}),a.length&&Photo.deleteFiles("Homepage",a)}for(var key in block)"_id"!=key&&"index"!=key&&delete block[key];var photos=[];for(var key in b)if("_id"!=key&&"template"!=key&&"nameTemplate"!=key&&"index"!=key)if("img"==key&&b[key]){var p=b[key].split("/");p[p.length-2]=self.item.url,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),block[key]=p.join("/"),photos.push([b[key],block[key]])}else if("imgs"==key&&b[key]&&b[key].length)b[key].forEach(function(i){if(i.img){var p=i.img.split("/");p[p.length-2]=self.item.url,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),photos.push([i.img,p.join("/")]),i.img=p.join("/")}}),block[key]=b[key];else if("video"==key&&b[key]){var p=b[key].split("/");p[p.length-2]=self.item.url,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),block[key]=p.join("/"),photos.push([b[key],block[key]])}else block[key]=b[key];var folder="/images/"+global.get("store").val.subDomain+"/HomePage/"+self.item.url,o={folder:folder,photos:photos};return $http.post(photoUpload+"/api/copyPhotosFromBrowser",o)}}).then(function(){return saveField(block,block.i)}).then(function(){activate()})}var self=this;self.Items=HomePage,self.global=global,self.$state=$state,self.activeSide="left",self.store=global.get("store").val,self.listOfBlocks=listOfBlocksForAll,self.blockEditPermission={},self.animationTypes=animationTypes,self.addBlock=addBlock,self.deleteBlock=deleteBlock,self.saveInfo=saveInfo,self.saveField=saveField,self.movedSlide=movedSlide,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.movedStuff=movedStuff,self.editModelData=editModelData,self.setCollection=setCollection,self.deleteCollection=deleteCollection,self.saveFieldInSide=saveFieldInSide,self.addItemInBlock=addItemInBlock,self.getNameCollection=getNameCollection,self.setColor=setColor,self.uploadHP=uploadHP,self.downloadHP=downloadHP,self.deleteIndexPageHtml=deleteIndexPageHtml,self.cloneBlock=cloneBlock,self.getBlockConfig=getBlockConfig,self.getNameBlock=getNameBlock,self.refreshBlocks=refreshBlocks,activate(),$scope.$on("changeLang",function(){activate()});var delay=!1}return{scope:{},restrict:"E",bindToController:!0,controller:homePageCtrl,controllerAs:"$ctrl",templateUrl:"components/homePage/homePage.html"}}),angular.module("gmall.directives").directive("directivehp",function($compile,$interpolate){return{template:"",link:function($scope,element,attributes){element.append($compile("<div "+attributes.directivehp.toLowerCase()+"hp-block></div>")($scope))}}}).directive("styleBlock",styleBlock).directive("bannerhpBlock",bannerHPBlock).directive("banneronehpBlock",banneroneHPBlock).directive("infohpBlock",infohpBlock).directive("sliderhpBlock",sliderhpBlock).directive("texthpBlock",texthpBlock).directive("texttwohpBlock",texttwohpBlock).directive("videohpBlock",videohpBlock).directive("missionhpBlock",missionhpBlock).directive("brandshpBlock",brandshpBlock).directive("stuffshpBlock",stuffshpBlock).directive("newshpBlock",newshpBlock).directive("campaignhpBlock",campaignhpBlock).directive("maphpBlock",maphpBlock).directive("reviewhpBlock",reviewhpBlock).directive("subscriptionhpBlock",subscriptionhpBlock).directive("callhpBlock",callhpBlock).directive("feedbackhpBlock",feedbackhpBlock).directive("brandtagshpBlock",brandTagshpBlock).directive("subscriptionaddhpBlock",subscriptionAddhpBlock).directive("filtertagshpBlock",filterTagshpBlock).directive("filtershpBlock",filtershpBlock).directive("categorieshpBlock",categorieshpBlock).directive("calendarhpBlock",calendarhpBlock).directive("videolinkhpBlock",videolinkhpBlock).directive("pricegoodshpBlock",pricegoodshpBlock).directive("priceserviceshpBlock",priceserviceshpBlock).directive("scheduleplacehpBlock",scheduleplacehpBlock).directive("hpBlock",undefinedhpBlock).directive("googlePlaceReviews",googlePlaceReviews),angular.module("gmall.services").service("selectStuffModalService",function($uibModal,$q,$state,global){this.selectStuff=function(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/selectStuffModal/selectStuffModal.html",controller:function(Stuff,$uibModalInstance){var self=this;self.stuffs=[],self.name="";var paginate={page:0,rows:30,items:0};self.search=function(name){name.length<3||Stuff.getList(paginate,query,name).then(function(res){self.stuffs=res})},self.selectStuff=function(stuff){$uibModalInstance.close(stuff)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg"}).result.then(function(stuff){resolve(stuff)},function(){reject("отказ")})})}}),function(){function itemDirective(){return{scope:{link:"=",stuffurl:"=",change:"&",title:"@",seoPage:"=editSeoPage"},rescrict:"E",bindToController:!0,controller:itemCtrl,controllerAs:"$ctrl",templateUrl:"components/createLink/createLink.html"}}function itemCtrl($q,FilterTags,Stuff,Category,BrandTags,Stat,Brands,Sections,global,$uibModal,$timeout){function setFilterTag(){$q.when().then(function(){return FilterTags.selectFilterTag({section:!0})}).then(function(tag){tag.section||(tag.section="group"),self.link="/"+tag.section+"/category?queryTag="+tag.url,$timeout(function(){self.change()},100)}).catch(function(){console.log("dismiss")})}function setBrandTag(){$q.when().then(function(){return BrandTags.selectBrandTag({section:!0})}).then(function(tag){if(console.log(tag),tag.section||(tag.section="group"),!tag.brand||!tag.brand.url)throw"where is the BRAND?";self.link="/"+tag.section+"/category?brand="+tag.brand.url+"&brandTag="+tag.url,$timeout(function(){self.change()},100)}).catch(function(err){err&&exception.caatcher("set data")(err)})}function setBrand(){$q.when().then(function(){return Brands.select({section:!0})}).then(function(tag){tag.section||(tag.section="group"),self.link="/"+tag.section+"/category?brand="+tag.url,$timeout(function(){self.change()},100)}).catch(function(){console.log("dismiss")})}function setCategory(){$q.when().then(function(){return Category.select()}).then(function(category){var category=global.get("categories").val.getOFA("_id",category._id);self.link="/"+category.linkData.groupUrl+"/"+category.url,category.linkData.parentGroup&&(self.link+="?parentGroup="+category.linkData.parentGroup),$timeout(function(){self.change()},100)}).catch(function(){console.log("dismiss")})}function setSection(){$q.when().then(function(){return Sections.select()}).then(function(section){console.log(section),self.link="/"+section.url+"/category",$timeout(function(){self.change()},100)}).catch(function(){console.log("dismiss")})}function setStuff(){$q.when().then(function(){return Stuff.selectItem()}).then(function(stuff){self.link=stuff.link,self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}).catch(function(err){console.log(err)})}function setStuffForOrder(){$q.when().then(function(){return Stuff.selectItem()}).then(function(stuff){self.link="orderStuffFromHP",self.stuffurl=stuff.url,self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}).catch(function(err){console.log(err)})}function setSubscription(){self.link="subscription",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setBonus(){self.link="allBonus",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setSubscriptionAdd(){self.link="subscriptionAdd",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setFeedback(){self.link="feedback",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setCall(){self.link="call",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setStaticPage(){$q.when().then(function(){return Stat.selectItem()}).then(function(stat){self.link="/stat/"+stat.url,self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}).catch(function(err){console.log(err)})}function setDateTime(){self.link="dateTime",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setAnyPage(){$q.when().then(function(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/createLink/createAnyLink.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){console.log(self.name),self.name&&("/"!=self.name[0]&&self.name.indexOf("http")<0&&(self.name="/"+self.name),$uibModalInstance.close(self.name.substring(0,100)))},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}).then(function(link){self.link=link,self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}).catch(function(err){console.log(err)})}function setHomePage(){self.link="/",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function setCatalog(){self.link="/group/category",self.change&&"function"==typeof self.change&&$timeout(function(){self.change()},100)}function deleteLink(){self.link="",$timeout(function(){self.change()},100)}var self=this;self.setFilterTag=setFilterTag,self.setBrandTag=setBrandTag,self.setBrand=setBrand,self.setCategory=setCategory,self.setSection=setSection,self.setStuff=setStuff,self.setStuffForOrder=setStuffForOrder,self.setSubscription=setSubscription,self.setSubscriptionAdd=setSubscriptionAdd,self.setBonus=setBonus,self.setFeedback=setFeedback,self.setStaticPage=setStaticPage,self.deleteLink=deleteLink,self.setCall=setCall,self.setDateTime=setDateTime,self.setAnyPage=setAnyPage,self.setHomePage=setHomePage,self.setCatalog=setCatalog}angular.module("gmall.services").directive("createLink",itemDirective),itemCtrl.$inject=["$q","FilterTags","Stuff","Category","BrandTags","Stat","Brands","Sections","global","$uibModal","$timeout"]}(),function(){function newsCartDirective(){return{templateUrl:"/views/template/partials/news/cart/news-cart.html",restrict:"A"}}function newsCartDirective1(){return{templateUrl:"/views/template/partials/news/cart/news-cart1.html",restrict:"A"}}function newsCartDirective2(){return{templateUrl:"/views/template/partials/news/cart/news-cart2.html",restrict:"A"}}function newsCartDirective3(){return{templateUrl:"/views/template/partials/news/cart/news-cart3.html",restrict:"A"}}function newsCartDirective4(){return{templateUrl:"/views/template/partials/news/cart/news-cart4.html",restrict:"A"}}function newsCartDirective5(){return{templateUrl:"/views/template/partials/news/cart/news-cart5.html",restrict:"A"}}function newsListDirective(){return{scope:{},bindToController:!0,controller:newsListCtrl,controllerAs:"$ctrl",templateUrl:"components/news/newsList.html"}}function newsListTemplateDirective($stateParams){return{template:"<div ui-view></div></div><div ng-bind-html='$ctrl.content|unsafe'></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$http","$stateParams","global",function($http,$stateParams,global){var self=this;$http.get("/views/template/partials/news").then(function(response){console.log(response),self.content=response.data.html,console.log(response.data.titles),global.set("titles",response.data.titles)})}]}}function newsListCtrl(News,$state,global,$timeout,$anchorScroll,Photo,Confirm,Label){function getList(){return!Object.keys(self.query).length&&self.actived&&(self.query={actived:!0}),News.getList(self.paginate,self.query).then(function(data){return self.itemsArr2=data.divideArrayWithChunk(2),self.itemsArr3=data.divideArrayWithChunk(3),self.itemsArr4=data.divideArrayWithChunk(4),self.items=data,$timeout(function(){self.data.rows=setRows(),$anchorScroll()}),self.items})}function setRows(){return global.get("functions").val.setRows?global.get("functions").val.setRows():2}function searchNews(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated news list View")})}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createNews(item){var name=item?item.name:"";self.Items.create(name).then(function(res){return name=res,item?self.Items.get({_id:item._id,clone:"clone"}).$promise:{name:res}}).then(function(res){return res._id?(self.newNews=angular.copy(res),self.newNews.send={date:null,quantity:0},self.newNews.name=name,self.newNews.actived=!1,delete self.newNews.date,delete self.newNews._id,delete self.newNews.url,delete self.newNews.__v,self.newNews.nameL={},self.newNews.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id?s._id:s})),block.imgs=[]})):(self.newNews={actived:!1},self.newNews.name=name),self.Items.save(self.newNews).$promise}).then(function(res){self.newNews._id=res.id,self.newNews.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newNews._id;delete self.newNews._id,setTimeout(function(){$state.go("frame.news.item",{id:id})},100)}).catch(function(err){console.log(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/News/"+item.url;Confirm("удалить?").then(function(){return News.delete({_id:item._id}).$promise}).then(function(){return getList()}).then(function(){return Photo.deleteFolder("News",folder)}).catch(function(err){(err=err&&err.data||err)&&exception.catcher("удаление новости")(err)})}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.$state=$state,self.Items=News,self.moment=moment,self.query={},self.paginate={page:0,rows:20,totalItems:0},self.newNews={name:"Новая иноформация",actived:!1},self.data={rows:2},self.itemsArr2=[[],[]],self.itemsArr3=[[],[],[]],self.itemsArr4=[[],[],[],[]],self.getList=getList,self.saveField=saveField,self.searchNews=searchNews,self.createNews=createNews,self.deleteItem=deleteItem,self.setRows=setRows,function(){getList().then(function(){return Label.getList({page:0,rows:100},{list:"news"})}).then(function(data){console.log(data),self.labels=data})}(),$(window).resize(function(){$timeout(function(){self.data.rows=setRows()})})}angular.module("gmall.services").directive("newsList",newsListDirective).directive("newsListTemplate",newsListTemplateDirective).directive("newsCart",newsCartDirective).directive("newsCart1",newsCartDirective1).directive("newsCart2",newsCartDirective2).directive("newsCart3",newsCartDirective3).directive("newsCart4",newsCartDirective4).directive("newsCart5",newsCartDirective5),newsListTemplateDirective.$inject=["global"],newsListCtrl.$inject=["News","$state","global","$timeout","$anchorScroll","Photo","Confirm","Label"]}(),function(){function itemTemplateDirective($stateParams){return{template:"<div ng-bind-html='$ctrl.content|unsafe'></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$http","$stateParams","global",function($http,$stateParams,global){var self=this;$http.get("views/template/partials/News/itemPage/"+$stateParams.id).then(function(response){console.log(response),self.content=response.data.html,console.log(response.data.titles),global.set("titles",response.data.titles)})}]}}function newsItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:newsItemCtrl,controllerAs:"$ctrl",templateUrl:"components/news/newsItem.html"}}function newsItemCtrl(News,$stateParams,$q,$uibModal,global,exception,Stuff,CreateContent,Email,seoContent,Photo,$resource,$anchorScroll,$timeout,FilterTags,BrandTags,Brands,Campaign,Category,$scope,Confirm,SetCSS){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение новости")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){console.log(data),data&&!data.blocks&&(data.blocks=[],saveField("blocks",[])),data.blocks.forEach(function(b,i){b.i=i});for(var key in data)self.item[key]=data[key];return self.objShare=seoContent.setDataItem(data,!0),$anchorScroll(),self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField("blocks."+block.i,block)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,$timeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}function deleteBlock(block,index){var o={_id:self.item._id};o.id=block.id;var update={update:"id",embeddedName:"blocks"};update.embeddedPull=!0,console.log(update,o),Confirm("Подтверждаете?").then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.item.blocks.splice(index,1);var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)})}function deleteSlide(block,index){Photo.deleteFiles("Stat",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/staticPage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(){})}function filterBlocks(item){return keyParts.indexOf(item.key)>-1}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){block[block.type]||(block[block.type]=[]);var img,link;switch(block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link})),saveField("blocks."+block.i+".imgs",block.imgs)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs)},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs)}function changeItem(block,$index){addItemInBlock(block,$index)}function sendEmail(){var item=angular.copy(self.item);item.blocks&&item.blocks.length&&item.blocks.forEach(function(b){"stuffs"==b.type&&(b.imgs=b.stuffs)});var ownerDomain,content=CreateContent.emailFromNews(item),d=new Date,n=d.getMonth()+1;global.get("store").val.seller.mailgun&&global.get("store").val.seller.mailgun.domain&&(ownerDomain=global.get("store").val.seller.mailgun.domain),$q.when().then(function(){}).then(function(){return self.Items.viewEmail(self.item,content)}).then(function(data){var lists=data.lists,except=data.except;if(!ownerDomain&&global.get("store").val.mailData&&global.get("store").val.mailData.month&&global.get("store").val.mailData.month==n&&global.get("store").val.mailData.quantity>500)throw"Превышен лимит количества писем в месяц";var o={content:content,lists:lists,except:except,subject:self.item.name.substring(0,50)};return Email.save(o).$promise}).then(function(res){if(exception.showToaster("note","Сообщение","Рассылка отправлена"),self.item.send||(self.item.send={}),self.item.send.date=Date.now(),saveField("send",self.item.send),res.quantity&&!ownerDomain){global.get("store").val.mailData&&global.get("store").val.mailData.month?global.get("store").val.mailData.month!=n?global.get("store").val.mailData={month:n,quantity:res.quantity}:(global.get("store").val.mailData.quantity||(global.get("store").val.mailData.quantity=0),global.get("store").val.mailData.quantity+=res.quantity):global.get("store").val.mailData={month:n,quantity:res.quantity};var o={_id:global.get("store").val._id};o.mailData=global.get("store").val.mailData,Store.save({update:"mailData"},o)}}).catch(function(err){err&&exception.catcher("отправка писем")(err)})}function clearDesc(block){console.log("???????????????"),block.desc="",saveField("blocks."+block.i+".index",block.desc)}var self=this;self.Items=News,self.type="News",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForNewsDetailPage=listOfBlocksForAll,self.listOfBlocks=listOfBlocksForAll,self.animationTypes=animationTypes,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.setStyles=setStyles,self.saveField=saveField,self.sendEmail=sendEmail;var Store=$resource("/api/collections/Store/:_id",{_id:"@_id"});self.newBlock=null,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.filterBlocks=filterBlocks,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,self.clearDesc=clearDesc,activate(),$scope.$on("changeLang",function(){activate()});var keyParts=global.get("store").val.template.news.parts.filter(function(el){return el.is}).map(function(el){return el.name})}angular.module("gmall.directives").directive("newsItem",newsItemDirective).directive("newsDetailTemplate",itemTemplateDirective),newsItemCtrl.$inject=["News","$stateParams","$q","$uibModal","global","exception","Stuff","CreateContent","Email","seoContent","Photo","$resource","$anchorScroll","$timeout","FilterTags","BrandTags","Brands","Campaign","Category","$scope","Confirm","SetCSS"]}(),function(){function newsService($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function search(search,setData){function getListComplete(response){return response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}var data={search:search,setData:setData};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(name){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/news/createNews.html",controller:function($uibModalInstance,name){var self=this;self.name=name,self.ok=function(){
$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",resolve:{name:function(){return name}}}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}function viewEmail(item,content){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/news/viewEmail.html",controller:function($q,$uibModalInstance,SubscibtionList,item,content){var self=this;self.item=item,self.except=!1,self.list,self.content=content,self.ok=function(){$uibModalInstance.close({lists:self.lists,except:self.except})},self.cancel=function(){$uibModalInstance.dismiss()},function(){$q.when().then(function(){return SubscibtionList.getList({page:0,rows:1,items:0},{})}).then(function(data){if(data&&data[0]){data[0].list||(data[0].list=[]);for(var key in data[0].list)data[0].list[key]||delete data[0].list[key];self.subscibtionList=data[0]}else self.subscibtionList={list:[]}})}()},size:"lg",controllerAs:"$ctrl",resolve:{item:function(){return item},content:function(){return content}}}).result.then(function(item){resolve(item)},function(err){reject(err)})})}function selectItem(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/news/selectNews.html",controller:function(News,$uibModalInstance,$q){var self=this;self.stuffs=[],self.name="";var query;self.search=function(name){name.length<3||(query={name:name},News.search(name,!0).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg"}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}var Items=$resource("/api/collections/News/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create,viewEmail:viewEmail,select:selectItem,search:search}}angular.module("gmall.services").service("News",newsService),newsService.$inject=["$resource","$uibModal","$q","global"]}(),function(){function lookbookListDirective(){return{scope:{},bindToController:!0,controller:lookbookListCtrl,controllerAs:"$ctrl",templateUrl:"components/lookbook/lookbookList.html"}}function lookbookListTemplateDirective(global){return{scope:{actived:"@"},rescrict:"E",bindToController:!0,controller:lookbookListCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/lookbook/lookbookList"+(global.get("store").val.template.newsList?global.get("store").val.template.newsList:"")+".html"}}function lookbookListCtrl(Lookbook,$state,global,exception,Confirm,Photo,$timeout){function getList(){return!Object.keys(self.query).length&&self.actived&&(self.query={actived:!0}),self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field,defer){defer=defer||0,setTimeout(function(){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)},function(err){console.log(err)})},defer)}function createItem(){self.Items.create().then(function(res){return self.newItem={actived:!1},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){return self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,$state.go("frame.lookbook.item",{id:id})}).catch(function(err){delete self.newItem._id,err=err.data||err,exception.catcher("создание объекта")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Lookbook/"+item.url;console.log(folder),Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Lookbook",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объета")(err)})}var self=this;self.mobile=global.get("mobile").val,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.$state=$state,self.Items=Lookbook,self.moment=moment,self.query={},self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"Новая иноформация",actived:!1},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.createItem=createItem,self.deleteItem=deleteItem,function(){getList().then(function(){})}()}angular.module("gmall.services").directive("lookbookList",lookbookListDirective).directive("lookbookTemplate",lookbookListTemplateDirective),lookbookListTemplateDirective.$inject=["global"],lookbookListCtrl.$inject=["Lookbook","$state","global","exception","Confirm","Photo","$timeout"]}(),function(){function lookbookItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:lookbookItemCtrl,controllerAs:"$ctrl",templateUrl:"components/lookbook/lookbookItem.html"}}function lookbookItemCtrl(Lookbook,$stateParams,$q,global,exception,Photo,$timeout,$scope,$uibModal){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){for(var key in data)self.item[key]=data[key];return self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function saveField(field,defer){defer=defer||0,setTimeout(function(){var o={_id:self.item._id};o[field]=self.item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function editSlide(index){$uibModal.open({animation:!0,templateUrl:"components/staticPage/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return self.item.imgs[index]}}}).result.then(function(slide){self.saveField("imgs")},function(){})}function filterBlocks(item){return keyParts.indexOf(item.key)>-1}function movedSlide(){self.item.imgs.forEach(function(el,i){el.index=i}),self.saveField("imgs")}function deleteSlide(index){Photo.deleteFiles("Lookbook",[self.item.imgs[index].img]).then(function(response){self.item.imgs.splice(index,1),self.saveField("imgs")},function(err){console.log(err)})}var self=this;self.Items=Lookbook,self.item={},self.mobile=global.get("mobile").val,self.global=global,self.datePickerOptions={locale:{applyClass:"btn-green",applyLabel:"Выбрать",fromLabel:"от",toLabel:"до",cancelLabel:"Отменить",customRangeLabel:"Прозвольный диапазон",format:"DD-MMMM-YYYY",daysOfWeek:["Пн","Вт","Ср","Чт","Пн","Сб","Вс"],firstDay:1,monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]},singleDatePicker:!0,date:{startDate:null,endDate:null}},self.saveField=saveField,self.movedSlide=movedSlide,self.deleteSlide=deleteSlide,self.filterBlocks=filterBlocks,self.editSlide=editSlide,activate(),$scope.$on("changeLang",function(){activate()});var keyParts=global.get("store").val.template.stat.parts.filter(function(el){return el.is}).map(function(el){return el.name})}angular.module("gmall.directives").directive("lookbookItem",lookbookItemDirective),lookbookItemCtrl.$inject=["Lookbook","$stateParams","$q","global","exception","Photo","$timeout","$scope","$uibModal"]}(),function(){function lookbookService($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}var data={perPage:paginate.rows,page:paginate.page,query:query};return Items.query(data).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/lookbook/createLookbook.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject(err)})})}var Items=$resource("/api/collections/Lookbook/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Lookbook",lookbookService),lookbookService.$inject=["$resource","$uibModal","$q","global"]}(),function(){function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/createMaster.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/Master/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Master",serviceFoo),serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function mastersStaticPage(){return{scope:{},bindToController:!0,controllerAs:"$ctrl",templateUrl:"views/template/partials/stat/masters/masters.html",controller:function(global){console.log(global.get("masters").val);var self=this;self.global=global,self.mobile=global.get("mobile").val}}}function masterListDirective(){return{scope:{},bindToController:!0,controller:masterListCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/master/masterList.html"}}function masterListTemplateDirective(global){return{scope:{},rescrict:"E",bindToController:!0,controller:masterListCtrl,controllerAs:"$ctrl",templateUrl:"views/template/partials/master/masterList"+(global.get("store").val.template.masterList?global.get("store").val.template.masterList:"")+".html"}}function masterListCtrl(Master,$state,global,Confirm,$q,exception,Photo,$timeout,Label){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){self.Items.create().then(function(res){return self.newItem={},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.master.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function cloneItem(item){var name;self.Items.create().then(function(res){return name=res,self.Items.getItem(item._id)}).then(function(master){return self.newItem=angular.copy(master),self.newItem.name=name,self.newItem.nameL={},delete self.newItem._id,delete self.newItem.__v,delete self.newItem.url,console.log(self.newItem),self.newItem.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id})),block.imgs=[]}),self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.master.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Master/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Master",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объекта")(err)})}function dropCallback(item){var i=0;return setTimeout(function(){self.items.reduce(function(p,item){return p.then(function(){return i++,item.index=i,saveField(item,"index")})},$q.when(!0)).then(function(){console.log(self.items.map(function(el){return el.index}))})},50),item}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Master,self.query={},self.labels=[],self.paginate={page:0,rows:50,totalItems:0},self.newItem={name:"имя мастера"},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.deleteItem=deleteItem,self.createItem=createItem,self.dropCallback=dropCallback,self.cloneItem=cloneItem,function(){getList().then(function(){return Label.getList({page:0,rows:100},{list:"master"})}).then(function(data){self.labels=data})}()}angular.module("gmall.services").directive("masterList",masterListDirective).directive("masterListTemplate",masterListTemplateDirective).directive("mastersStaticPage",mastersStaticPage),masterListCtrl.$inject=["Master","$state","global","Confirm","$q","exception","Photo","$timeout","Label"]}(),function(){function masterItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:masterItemCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/master/masterItem.html"}}function masterItemCtrl(Master,$stateParams,$q,$uibModal,global,exception,Stuff,Photo,$scope,$timeout,Confirm,SetCSS,$user,Workplace,$rootScope){function activate(){return getItem($stateParams.id).then(function(){if(self.item.user)return $user.getItem(self.item.user)}).then(function(user){if(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,self.item.user=user}}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){data&&!data.blocks&&(data.blocks=[],saveField("blocks",[]));var bl=data.blocks.filter(function(b){return b});return bl.length!=data.blocks.length&&(saveField("blocks",bl),data.blocks=bl),data.blocks.forEach(function(b,i){"stuffs"==b.type&&b.stuffs.length&&(b.stuffs=b.stuffs.map(function(s){return s._is||s})),b.i=i}),data.blocks.sort(function(a,b){return a.index-b.index}),void 0==data.notification&&(data.notification=0),self.item=data,self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){block.elements&&saveField("blocks."+block.i+".elements",block.elements),block.blockStyle&&saveField("blocks."+block.i+".blockStyle",block.blockStyle)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function addBlock(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}function deleteBlock(block,index){var o={_id:self.item._id},update={update:"_id_id",embeddedName:"blocks"};o.id=block.id,update.embeddedPull=!0,Confirm("потверждаете?").then(function(){return self.item.blocks.splice(index,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Master",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/master/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function savePhone(phone){saveField("phone",phone)}function clearUser(){console.log(self.user),changeUser(self.user)}function refreshUsers(phone){phone.length<3||(self.cachePhone=phone,searchUser(phone))}function searchUser(phone){var q={$or:[{"profile.phone":phone},{name:phone},{email:phone}]};$user.getList({page:0,rows:20},q).then(function(res){self.users=res.map(function(user){if(user.profile&&user.profile.phone&&"+"==user.profile.phone[0]&&(user.profile.phone=user.profile.phone.substring(1)),user.profile&&user.profile.phone&&user.profile.phone.length<10)for(;user.profile.phone.length<10;)user.profile.phone+="0";return user.profile&&user.profile.phone&&10==user.profile.phone.length&&(user.profile.phone="38"+user.profile.phone),user.phone=user.profile?user.profile.phone:null,user})})}function changeUser(user){if(self.item.user&&self.item.user._id&&(!user||user._id!=self.item.user._id)){var o={_id:self.item.user._id,master:null};$user.save({update:"master"},o,function(){})}var u=null;if(user?(u=user._id,self.item.user=user):self.item.user=null,saveField("user",u),self.user=null,self.item.user&&self.item.user._id){var o={_id:self.item.user._id,master:self.item._id};$user.save({update:"master"},o,function(){})}}function getWorkplaces(){Workplace.getList({page:0,rows:50}).then(function(res){console.log(res,res&&res.length),res&&res.length&&(self.workplaces=res,console.log(self.workplaces))})}function addWorkplace(wp){console.log(wp),self.item.workplaces||(self.item.workplaces=[]),self.item.workplaces=self.item.workplaces.filter(function(wp){return wp});var value=self.item.workplaces.map(function(wp){return wp._id});value.indexOf(wp._id)>-1||(value.push(wp._id),self.item.workplaces.push(wp),console.log(value),saveField("workplaces",value),$timeout(function(){},1e3))}function deleteWorkplace(idx){self.item.workplaces||(self.item.workplaces=[]),self.item.workplaces.splice(idx,1),saveField("workplaces",self.item.workplaces.map(function(wp){return wp._id}))}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){if("stuffs"==block.type&&block.stuffs&&block.stuffs.length&&block.stuffs.some(function(s){return s&&s._id?s._id==item._id:s==item._id}))throw"такой объект уже есть";block[block.type]||(block[block.type]=[]);var img,link;switch(name=item.name,block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,_id:item._id}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,_id:item._id})),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}).catch(function(err){err&&exception.catcher("добавление")(err)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}function changeItem(block,$index){addItemInBlock(block,$index)}function toggleEdit(item){item.editMode=!item.editMode}function toggleAdd(){self.addMode=!self.addMode}function saveReview(item){item.name=item.name.substring(0,20),item.desc=item.desc.substring(0,200),delete item.editMode,saveField("reviews",item.reviews)}function deleteReview(i){self.item.reviews.splice(i,1),saveField("reviews",item.reviews)}function addReview(admin){if(admin)var o=self.newReview;else var o={name:global.get("user").val.profile.fio||global.get("user").val.name,date:Date.now(),desc:self.newReviewText.substring(0,200)};self.newReviewText="",self.unableAddReview=!1,self.item.reviews||(self.item.reviews=[]),self.item.reviews.unshift(o),saveField("reviews",self.item.reviews),admin&&toggleAdd()}var self=this;self.Items=Master,self.type="Master",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForMasterPage=listOfBlocksForAll,self.listOfBlocks=listOfBlocksForAll,self.moment=moment,self.saveField=saveField,self.setStyles=setStyles,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,self.deleteReview=deleteReview,self.toggleEdit=toggleEdit,self.addReview=addReview,self.toggleAdd=toggleAdd,self.saveReview=saveReview,self.newReview={name:"",desc:"",date:Date.now()},self.savePhone=savePhone,self.refreshUsers=refreshUsers,self.changeUser=changeUser,self.clearUser=clearUser,self.workplaces=[],self.deleteWorkplace=deleteWorkplace,self.addWorkplace=addWorkplace,self.getWorkplaces=getWorkplaces,activate(),$scope.$on("changeLang",function(){activate()}),global.get("store").val.template.master||(global.get("store").val.template.master={parts:[]});global.get("store").val.template.master.parts.filter(function(el){return el.is}).map(function(el){return el.name})}function masterTemplateDirective($stateParams){return{template:"<div ng-bind-html='$ctrl.content|unsafe'></div>",bindToController:!0,scope:{},controllerAs:"$ctrl",controller:["$http","$stateParams","global",function($http,$stateParams,global){var self=this;$http.get("views/template/partials/Master/itemPage/"+$stateParams.id).then(function(response){console.log(response),self.content=response.data.html,console.log(response.data.titles),global.set("titles",response.data.titles)})}]}}function masterScheduleDirective($stateParams){return{bindToController:!0,scope:{master:"@"},controllerAs:"$ctrl",controller:masterScheduleCtrl,templateUrl:"components/CONTENT/master/masterSchedule.html"}}function masterScheduleCtrl($http,$stateParams,global){var self=this;console.log("init",self.master)}angular.module("gmall.directives").directive("masterItem",masterItemDirective).directive("masterDetailTemplate",masterTemplateDirective).directive("masterSchedule",masterScheduleDirective),masterItemCtrl.$inject=["Master","$stateParams","$q","$uibModal","global","exception","Stuff","Photo","$scope","$timeout","Confirm","SetCSS","$user","Workplace","$rootScope"],masterScheduleCtrl.$inject=["$http","$stateParams","global"]}(),function(){function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.stuffs&&response.stuffs.length&&response.stuffs.forEach(function(s){s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img)}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/groupStuffs/createItem.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/GroupStuffs/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("GroupStuffs",serviceFoo),serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function groupStuffsListDirective(){return{scope:{},bindToController:!0,controller:groupStuffsListCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/groupStuffs/groupStuffsList.html"}}function groupStuffsListCtrl(GroupStuffs,$state,global,Confirm,$q,exception,Photo,$timeout){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field){var o={_id:item._id};return o[field]=item[field],self.Items.save({update:field},o).$promise.then(function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){self.Items.create().then(function(res){return self.newItem={},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.groupStuffs.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание группы")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/GroupStuffs/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("GroupStuffs",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объекта")(err)})}function dropCallback(item){var i=0;return setTimeout(function(){self.items.reduce(function(p,item){return p.then(function(){return i++,item.index=i,saveField(item,"index")})},$q.when(!0)).then(function(){console.log(self.items.map(function(el){return el.index}))})},50),item}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=GroupStuffs,self.query={},self.paginate={page:0,rows:20,totalItems:0},self.newItem={name:"имя мастера"},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.deleteItem=deleteItem,self.createItem=createItem,self.dropCallback=dropCallback,function(){getList().then(function(){})}()}angular.module("gmall.services").directive("groupStuffsList",groupStuffsListDirective),groupStuffsListCtrl.$inject=["GroupStuffs","$state","global","Confirm","$q","exception","Photo","$timeout"]}(),function(){function groupStuffsItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:groupStuffsItemCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/groupStuffs/groupStuffsItem.html"}}function groupStuffsItemCtrl(GroupStuffs,$stateParams,$q,$uibModal,global,exception,Stuff,Photo,$scope,$timeout,Confirm,Category){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){return data.category&&global.get("categoriesO").val[data.category]&&(data.category=global.get("categoriesO").val[data.category]),self.item=data,self.item
}).catch(function(err){return console.log(err),$q.reject(err)})}function saveField(field,defer){console.log(field),defer=defer?defer:100,setTimeout(function(){var o={_id:self.item._id};if("stuffs"==field)var value=self.item.stuffs.map(function(s){return s._id});else if("category"==field)if(self.item.category&&self.item.category._id)var value=self.item.category._id;else var value=null;else var value=self.item[field];o[field]=value;var query={update:field};self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function addItemInBlock(index){var model=Stuff;$q.when().then(function(){return model.select()}).then(function(item){item.img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,self.item.stuffs||(self.item.stuffs=[]),void 0===index?self.item.stuffs.push(item):self.item.stuffs[index]=item,saveField("stuffs")})}function movedItem(item){return $timeout(function(){saveField("stuffs")},100),item}function deleteItemFromBlock($index){Confirm("удалить?").then(function(){self.item.stuffs.splice($index,1),saveField("stuffs")})}function changeItem($index){addItemInBlock($index)}function changeCategory(){$q.when().then(function(){var categoryId=self.item.category&&self.item.category._id?self.item.category._id:null;return Category.select(categoryId,null,null,"groupStuffs")}).then(function(selectedCategory){self.item.category=selectedCategory,saveField("category")}).catch(function(err){err&&exception.catcher("выбор категории")(err)})}function deleteCategory(){self.item.category=null,saveField("category")}var self=this;self.Items=GroupStuffs,self.type="GroupStuffs",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.moment=moment,self.saveField=saveField,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,self.changeCategory=changeCategory,self.deleteCategory=deleteCategory,activate(),$scope.$on("changeLang",function(){activate()})}angular.module("gmall.directives").directive("groupStuffsItem",groupStuffsItemDirective),groupStuffsItemCtrl.$inject=["GroupStuffs","$stateParams","$q","$uibModal","global","exception","Stuff","Photo","$scope","$timeout","Confirm","Category"]}(),function(){function itemListDirective(){return{scope:{},bindToController:!0,controller:itemListCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/workplace/workplaceList.html"}}function workplaceItemDirective(){return{scope:{},restrict:"E",bindToController:!0,controller:ItemCtrl,controllerAs:"$ctrl",templateUrl:"components/CONTENT/workplace/workplaceItem.html"}}function itemListCtrl(Items,$state,global,Confirm,$q,exception,Photo,$timeout){function getList(){return self.Items.getList(self.paginate,self.query).then(function(data){return self.items=data,self.items})}function searchItem(searchStr){return self.query=searchStr?{name:searchStr.substring(0,10)}:{},self.paginate.page=0,getList().then(function(){console.log("Activated list View")})}function saveField(item,field){var o={_id:item._id};o[field]=item[field],self.Items.save({update:field},o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})}function createItem(){self.Items.create().then(function(res){return self.newItem={},self.newItem.name=res,self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.workplace.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание мастера")(err)})}function cloneItem(item){var name;self.Items.create().then(function(res){return name=res,self.Items.getItem(item._id)}).then(function(master){return self.newItem=angular.copy(master),self.newItem.name=name,self.newItem.nameL={},delete self.newItem._id,delete self.newItem.__v,delete self.newItem.url,console.log(self.newItem),self.newItem.blocks.forEach(function(block){delete block.img,delete block._id,"stuffs"==block.type&&block.stuffs&&block.stuffs.length&&(block.stuffs=block.stuffs.map(function(s){return s._id})),block.imgs=[]}),self.Items.save(self.newItem).$promise}).then(function(res){self.newItem._id=res.id,self.newItem.url=res.url,self.paginate.page=0,getList(self.paginate)}).then(function(){var id=self.newItem._id;delete self.newItem._id,setTimeout(function(){$state.go("frame.workplace.item",{id:id})},100)}).catch(function(err){err&&exception.catcher("создание объекта")(err)})}function deleteItem(item){var folder="images/"+global.get("store").val.subDomain+"/Workplace/"+item.url;Confirm("удалить???").then(function(){return self.Items.delete({_id:item._id}).$promise}).then(function(){return self.getList()}).then(function(){Photo.deleteFolder("Workplace",folder)}).catch(function(err){err&&(err=err&&err.data||err)&&exception.catcher("удаление объекта")(err)})}function dropCallback(item){var i=0;return setTimeout(function(){self.items.reduce(function(p,item){return p.then(function(){return i++,item.index=i,saveField(item,"index")})},$q.when(!0)).then(function(){console.log(self.items.map(function(el){return el.index}))})},50),item}var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.Items=Items,self.query={},self.paginate={page:0,rows:20,totalItems:0},self.newItem={name:"наименование"},self.getList=getList,self.saveField=saveField,self.searchItem=searchItem,self.deleteItem=deleteItem,self.createItem=createItem,self.dropCallback=dropCallback,self.cloneItem=cloneItem,function(){getList().then(function(){})}()}function ItemCtrl(Items,$stateParams,$q,$uibModal,global,exception,Stuff,Photo,$scope,$timeout,Confirm,SetCSS){function activate(){return getItem($stateParams.id).then(function(){}).catch(function(err){err=err.data||err,exception.catcher("получение объекта")(err)})}function getItem(id){return self.Items.getItem(id).then(function(data){data&&!data.blocks&&(data.blocks=[],saveField("blocks",[]));var bl=data.blocks.filter(function(b){return b});return bl.length!=data.blocks.length&&(saveField("blocks",bl),data.blocks=bl),data.blocks.forEach(function(b,i){"stuffs"==b.type&&b.stuffs.length&&(b.stuffs=b.stuffs.map(function(s){return s._is||s})),b.i=i}),data.blocks.sort(function(a,b){return a.index-b.index}),self.item=data,self.item}).catch(function(err){return console.log(err),$q.reject(err)})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){block.elements&&saveField("blocks."+block.i+".elements",block.elements),block.blockStyle&&saveField("blocks."+block.i+".blockStyle",block.blockStyle)})}function saveField(field,value,defer,indexImgs){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=self.item.blocks,field="blocks"),defer=defer?defer:100,setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&void 0!==indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500)})},defer)}function refreshBlocks(){return self.Items.getItem($stateParams.id).then(function(data){data.blocks.forEach(function(b,i){b.i=i,b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.blocks=data.blocks})}function addBlock(type){if(type){return $scope.$broadcast("addNewBlock",{type:type}),void(self.newBlock=null)}}function deleteBlock(block,index){var o={_id:self.item._id},update={update:"_id_id",embeddedName:"blocks"};o.id=block.id,update.embeddedPull=!0,Confirm("потверждаете?").then(function(){return self.item.blocks.splice(index,1),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),self.Items.save(update,o).$promise}).then(function(res){var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).then(function(){activate()})}function deleteSlide(block,index){Photo.deleteFiles("Workplace",[block.imgs[index].img]).then(function(response){block.imgs.splice(index,1),self.saveField("blocks."+block.i+".imgs",block.imgs,null,index)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/workplace/editSlide.html",controller:function(slide,$uibModalInstance){var self=this;self.item=slide,self.ok=function(){console.log(self.item),$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function addItemInBlock(block,$index){var model;switch(block.type){case"stuffs":model=Stuff;break;case"campaign":model=Campaign;break;case"filterTags":model=FilterTags;break;case"brandTags":model=BrandTags;break;case"brands":model=Brans;break;case"categories":model=Category}$q.when().then(function(){return model.select()}).then(function(item){if("stuffs"==block.type&&block.stuffs&&block.stuffs.length&&block.stuffs.some(function(s){return s&&s._id?s._id==item._id:s==item._id}))throw"такой объект уже есть";block[block.type]||(block[block.type]=[]);var img,link;switch(name=item.name,block.type){case"stuffs":img=item.gallery[0]&&item.gallery[0].thumb?item.gallery[0].thumb:null,link=item.link,item.artikul&&(item.name+=" "+item.artikul);break;case"campaign":img=item.img?item.img:null,link="campaign/"+item.url;break;case"filterTags":img=item.img?item.img:null,link="/group/category?queryTag="+item.url;break;case"brandTags":img=item.img?item.img:null,link="/group/category?brandTag="+item.url;break;case"brands":img=item.img?item.img:null,link="/group/category?brand="+item.url;break;case"categories":img=item.img?item.img:null,link="/group/"+item.url}void 0!==$index?block.imgs[$index]={name:item.name,img:img,link:link,_id:item._id}:(block.imgs||(block.imgs=[]),block.imgs.push({name:item.name,img:img,link:link,_id:item._id})),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}).catch(function(err){err&&exception.catcher("добавление")(err)})}function movedItem(block,item){return $timeout(function(){saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))},100),item}function deleteItemFromBlock(block,$index){block.imgs.splice($index,1),saveField("blocks."+block.i+".imgs",block.imgs),"stuffs"==block.type&&(block.stuffs=block.imgs.map(function(img){return img._id}),saveField("blocks."+block.i+".stuffs",block.stuffs))}function changeItem(block,$index){addItemInBlock(block,$index)}var self=this;self.Items=Items,self.type="Workplace",self.item={},self.mobile=global.get("mobile").val,self.global=global,self.listOfBlocksForWorkplacePage=listOfBlocksForWorkplacePage,self.listOfBlocks=listOfBlocksForWorkplacePage,console.log(self.listOfBlocksForWorkplacePage),console.log(self.listOfBlocks),self.moment=moment,self.saveField=saveField,self.setStyles=setStyles,self.addBlock=addBlock,self.refreshBlocks=refreshBlocks,self.deleteBlock=deleteBlock,self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.addItemInBlock=addItemInBlock,self.movedItem=movedItem,self.deleteItemFromBlock=deleteItemFromBlock,self.changeItem=changeItem,activate(),$scope.$on("changeLang",function(){activate()}),global.get("store").val.template.workplace||(global.get("store").val.template.workplace={parts:[]});global.get("store").val.template.workplace.parts.filter(function(el){return el.is}).map(function(el){return el.name})}function serviceFoo($resource,$uibModal,$q,global){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}paginate||(paginate={page:0});var data={perPage:paginate.rows,page:paginate.page,query:query};return global.get("crawler")&&global.get("crawler").val&&(data.subDomain=global.get("store").val.subDomain),Items.query(data).$promise.then(getListComplete)}function getItem(id){function getItemComplete(response){return response&&response.blocks&&response.blocks.length&&response.blocks.forEach(function(b){"stuffs"==b.type&&(b.stuffs&&b.stuffs.length?b.imgs=b.stuffs.map(function(s){return s.gallery&&s.gallery.length&&s.gallery[0].img&&(s.img=s.gallery[0].img),s}):b.imgs=[])}),response}return Items.get({_id:id}).$promise.then(getItemComplete)}function create(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/CONTENT/workplace/createItem.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"}).result.then(function(name){name?resolve(name.substring(0,50)):reject()},function(err){reject(err)})})}var Items=$resource("/api/collections/Workplace/:_id",{_id:"@_id"});return{getList:getList,getItem:getItem,query:Items.query,get:Items.get,save:Items.save,delete:Items.delete,create:create}}angular.module("gmall.services").service("Workplace",serviceFoo),angular.module("gmall.directives").directive("workplaceList",itemListDirective).directive("workplaceItem",workplaceItemDirective),itemListCtrl.$inject=["Workplace","$state","global","Confirm","$q","exception","Photo","$timeout"],ItemCtrl.$inject=["Workplace","$stateParams","$q","$uibModal","global","exception","Stuff","Photo","$scope","$timeout","Confirm","SetCSS"],serviceFoo.$inject=["$resource","$uibModal","$q","global"]}(),function(){function campaignService($resource,$uibModal,$q){function getList(paginate,query){function getListComplete(response){return 0==paginate.page&&(response&&response.length?paginate.items=response.shift().index:paginate.items=0),response}function getListFailed(error){return console.log("XHR Failed for getNews."+error),$q.reject(error)}return Items.query({perPage:paginate.rows,page:paginate.page,query:query}).$promise.then(getListComplete).catch(getListFailed)}function getItem(id){function getItemComplete(response){return response}function getItemFailed(error){return $q.reject(error)}return Items.get({_id:id}).$promise.then(getItemComplete).catch(getItemFailed)}function create(){return $q(function(resolve,reject){var options={animation:!0,restrict:"E",templateUrl:"components/PROMO/campaign/createCampaign.html",controller:function($uibModalInstance){var self=this;self.name="",self.ok=function(){!self.name||self.name.length<3||$uibModalInstance.close(self.name)},self.cancel=function(){$uibModalInstance.dismiss()}},controllerAs:"$ctrl"};$uibModal.open(options).result.then(function(name){name?resolve(name.substring(0,100)):reject("empty")},function(err){reject()})})}function selectItem(){return $q(function(resolve,reject){$uibModal.open({animation:!0,templateUrl:"components/PROMO/campaign/selectItem.html",controller:function(Campaign,$uibModalInstance){var self=this;self.stuffs=[],self.name="";var query,paginate={page:0,rows:30,items:0};self.search=function(name){name.length<3||(query={name:name},Campaign.getList(paginate,query).then(function(res){self.items=res}))},self.selectItem=function(item){$uibModalInstance.close(item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg"}).result.then(function(stuff){resolve(stuff)},function(){reject()})})}var Items=$resource("/api/collections/Campaign/:_id",{_id:"@_id"});return{get:Items.get,getList:getList,getItem:getItem,save:Items.save,delete:Items.delete,create:create,select:selectItem}}angular.module("gmall.services").service("Campaign",campaignService),campaignService.$inject=["$resource","$uibModal","$q"]}(),function(){function reviewBlock(){return{templateUrl:"components/blocks/reviewBlock.html"}}function subscriptionBlock(){return{templateUrl:"components/blocks/subscriptionBlock.html"}}function subscriptionAddBlock(){return{templateUrl:"components/blocks/subscriptionAddBlock.html"}}function undefinedBlock(){return{templateUrl:"components/blocks/undefinedBlock.html"}}function nameBlock(){return{templateUrl:"components/blocks/nameBlock.html"}}function positionBlock(){return{templateUrl:"components/blocks/positionBlock.html"}}function videoLinkBlock(){return{templateUrl:"components/blocks/videoLinkBlock.html"}}function textBlock(){return{templateUrl:"components/blocks/textBlock.html"}}function text2Block(){return{templateUrl:"components/blocks/text2Block.html"}}function bannerBlock(){return{templateUrl:"components/blocks/bannerBlock.html"}}function banner1Block(){return{templateUrl:"components/blocks/banner1Block.html"}}function sliderBlock(){return{templateUrl:"components/blocks/sliderBlock.html"}}function videoBlock(){return{templateUrl:"components/blocks/videoBlock.html"}}function video1Block(){return{templateUrl:"components/blocks/video1Block.html"}}function video2Block(){return{templateUrl:"components/blocks/video2Block.html"}}function mapBlock(){return{templateUrl:"components/blocks/mapBlock.html"}}function map1Block(){return{templateUrl:"components/blocks/map1Block.html"}}function map2Block(){return{templateUrl:"components/blocks/map2Block.html"}}function mastersBlock(){return{templateUrl:"components/blocks/mastersBlock.html"}}function feedbackBlock(){return{templateUrl:"components/blocks/feedbackBlock.html"}}function feedback1Block(){return{templateUrl:"components/blocks/feedback1Block.html"}}function feedback2Block(){return{templateUrl:"components/blocks/feedback2Block.html"}}function itemsBlock(){return{templateUrl:"components/blocks/itemsBlock.html"}}function dateBlock(){return{templateUrl:"components/blocks/dateBlock.html"}}function snBlock(){return{templateUrl:"components/blocks/sn.html"}}function calendarBlock(){return{templateUrl:"components/blocks/calendarBlock.html"}}function scheduleBlock(){return{templateUrl:"components/blocks/sheduleBlock.html"}}function callBlock(){return{templateUrl:"components/blocks/callBlock.html"}}function buttonBlock(){return{templateUrl:"components/blocks/buttonBlock.html"}}function calendarBlock(){return{templateUrl:"components/blocks/calendarBlock.html"}}function videolinkBlock(){return{templateUrl:"components/blocks/videolinkhpBlock.html"}}function pricegoodsBlock(){return{templateUrl:"components/blocks/pricegoodsBlock.html"}}function priceservicesBlock(){return{templateUrl:"components/blocks/priceservicesBlock.html"}}function scheduleplaceBlock(){return{templateUrl:"components/blocks/scheduleplaceBlock.html"}}function blockTextEdit(){return{templateUrl:"components/blocks/blockTextEdit.html"}}function blockText1Edit(){return{templateUrl:"components/blocks/blockText1Edit.html"}}function blockMediaEdit(){return{templateUrl:"components/blocks/blockMediaEdit.html"}}function blockMedia1Edit(){return{templateUrl:"components/blocks/blockMedia1Edit.html"}}function blocksEdit(){return{scope:{item:"=",type:"@",activeSide:"=",refreshBlocks:"&"},restrict:"EA",bindToController:!0,controller:blocksEditCtrl,controllerAs:"$ctrl",templateUrl:"components/blocks/blocksEdit.html"}}function blocksEditCtrl($http,$uibModal,HomePage,$q,global,Photo,$fileUpload,SetCSS,Blocks,Confirm,EditModelData,Filters,Brands,Category,FilterTags,BrandTags,Stuff,News,Campaign,Info,exception,$timeout,Master,Stat,Additional,$scope,$rootScope){function filterBlocks(item){return!self.activeSide||(item.position==self.activeSide||void 0)}function getBlockType(type){return"scheduleplace"==type?"stuffs":type}function getNameBlock(type){return listOfBlocksForMainPage[type]?listOfBlocksForMainPage[type]:type}function saveField(field,value){field.indexOf("index")>-1&&(self.item.blocks.sort(function(a,b){return a.index-b.index}),self.item.blocks.forEach(function(b,i){b.i=i}),value=angular.copy(self.item.blocks),value.forEach(function(b){"object"==typeof b.videoLink&&(b.videoLink=""),delete b.$$hashKey,delete b.__v}),field="blocks");var defer=defer?defer:100;setTimeout(function(){"date"==field&&(value=new Date(self.item[field]));var o={_id:self.item._id};o[field]=value;var query={update:field};field.indexOf(".imgs")>-1&&"undefined"!=typeof indexImgs&&(query.indexImgs=indexImgs),self.Items.save(query,o,function(){global.set("saving",!0),$timeout(function(){global.set("saving",!1)},1500),"blocks"==field&&self.refreshBlocks()},function(err){err&&exception.catcher("save "+field)(err)})},defer)}function loadPhoto(block,field){$q.when().then(function(){return"video"==field?$fileUpload.fileUpload(self.uploadVideoUrl,field,self.item.url):$fileUpload.fileUpload(self.uploadUrl,field,self.item.url)}).then(function(res){if(res&&res.length){var a=[];("img"==field||"videoCover"==field||"video"==field)&&res[0].data&&res[0].data.img?(block[field]&&a.push(block[field]),block[field]=res[0].data.img,saveField("blocks."+block.i+"."+field,block[field])):"imgs"==field&&(block.imgs||(block.imgs=[]),res.forEach(function(r){if(console.log(r.data),r.data.imgs&&r.data.imgs[0]&&r.data.imgs[0].img){var o={img:r.data.imgs[0].img,index:block.imgs.length,active:!0};block.imgs.push(o)}}),saveField("blocks."+block.i+".imgs",block.imgs)),a.length&&Photo.deleteFiles(self.type,a)}}).catch(function(err){console.log(err)})}function setStyles(block,idx){$q.when().then(function(){return SetCSS.setStyles(block)}).then(function(){saveField("blocks."+block.i+".blockStyle",block.blockStyle),block.elements&&saveField("blocks."+block.i+".elements",block.elements),block.mobile&&saveField("blocks."+block.i+".mobile",block.mobile),block.tablet&&saveField("blocks."+block.i+".tablet",block.tablet)})}function getBlockConfig(block){$q.when().then(function(){return Blocks.getBlockConfig(block,self.item.url,self.type)}).then(function(){saveField("blocks."+block.i,block)})}function deleteBlock(block,idx){var o={_id:self.item._id},update={update:"_id_id",embeddedName:"blocks"};o.id=block.id,update.embeddedPull=!0,Confirm("потверждаете?").then(function(){return $rootScope.$emit("$stateChangeStartToStuff"),block._id?(o._id_id=block._id,update={update:"_id_id",embeddedName:"blocks"},update.embeddedPull=!0):(update={update:"blocks"},o.blocks=self.item.blocks),$q(function(res,rej){self.Items.save(update,o,function(){res()},function(err){rej(err)})})}).then(function(){return self.refreshBlocks()}).then(function(res){$rootScope.$emit("$stateChangeEndToStuff");var images=[];if(block.img&&images.push(block.img),block.video&&images.push(block.video),block.videoCover&&images.push(block.videoCover),block.imgs&&block.imgs.length&&block.imgs.forEach(function(im){im.img&&images.push(im.img)}),images.length)return Photo.deleteFiles("Stat",images)}).catch(function(err){$rootScope.$emit("$stateChangeEndToStuff"),console.log(err),exception.catcher("delete block")(err)})}function addNewBlock(type){try{var index=1;self.item.blocks.forEach(function(block){block.index&&block.index>=index&&(index=block.index+1)});var o={_id:self.item._id,type:type,index:index,id:Date.now()},update={update:"type index id",embeddedName:"blocks",embeddedPush:!0};o.imgs=[],update.update+=" imgs",self.activeSide&&(update.update+=" position",o.position=self.activeSide)}catch(err){console.log(err)}$q.when().then(function(){return $rootScope.$emit("$stateChangeStartToStuff"),$q(function(res,rej){self.Items.save(update,o,function(){res()},function(err){rej(err)})})}).then(function(res){return self.refreshBlocks()}).then(function(){$rootScope.$emit("$stateChangeEndToStuff")}).catch(function(err){$rootScope.$emit("$stateChangeEndToStuff"),err&&exception.catcher("добавление блока")(err)})}function cloneBlock(block){var bl=angular.copy(block),index=1;self.item.blocks.forEach(function(block){block.index&&block.index>=index&&(index=block.index+1)});var o={_id:self.item._id,index:index,id:Date.now()},update={update:"index id",embeddedName:"blocks",embeddedPush:!0};for(var key in bl)"type"!=key&&"is"!=key&&"nameAnimate"!=key&&"name1Animate"!=key&&"nameAnimateDelay"!=key&&"audio"!=key&&"templ"!=key&&"style"!=key&&"blockStyle"!=key&&"elements"!=key&&"mobile"!=key&&"tablet"!=key&&"animate"!=key&&"animateRepeat"!=key&&"duration"!=key&&"position"!=key||!bl[key]||(update.update+=" "+key,o[key]=bl[key]);$q.when().then(function(){return self.Items.save(update,o).$promise}).then(function(res){self.refreshBlocks()}).catch(function(err){err&&exception.catcher("добавление блока")(err)})}function deleteSlide(block,index){Confirm("Удалить?").then(function(){return Photo.deleteFiles(self.type,[block.imgs[index].img])}).then(function(response){block.imgs.splice(index,1),block.imgs.forEach(function(slide,i){slide.index=i}),saveField("blocks."+block.i+".imgs",block.imgs)},function(err){console.log(err)})}function editSlide(block,index){$uibModal.open({animation:!0,templateUrl:"components/blocks/editSlide.html",controller:function(slide,$uibModalInstance,global){var self=this;self.item=slide,self.lang=global.get("store").val.lang,self.ok=function(){$uibModalInstance.close(self.item)},self.cancel=function(){$uibModalInstance.dismiss("cancel")}},controllerAs:"$ctrl",size:"lg",resolve:{slide:function(){return block.imgs[index]}}}).result.then(function(slide){self.saveField("blocks."+block.i+".imgs",block.imgs)},function(){})}function deleteImg(block,field){Confirm("Удалить?").then(function(){return Photo.deleteFiles(self.type,[block[field]])}).then(function(response){block[field]=null,saveField("blocks."+block.i+"."+field,block[field])},function(err){console.log(err)})}function changeSlidePhoto(block,idx){console.log(idx),$q.when().then(function(){return $fileUpload.fileUpload(self.uploadUrl,"img",self.item.url)}).then(function(res){if(res&&res.length){var a=[];res[0].data&&res[0].data.img&&(block.imgs[idx].img&&a.push(block.imgs[idx].img),block.imgs[idx].img=res[0].data.img,saveField("blocks."+block.i+".imgs",block.imgs)),a.length&&Photo.deleteFiles(self.type,a)}}).catch(function(err){exception.catcher("load photo")(err),console.log(err)})}function movedItemInSlider(block){$timeout(function(){block.imgs.forEach(function(item,i){item.index=i}),saveField("blocks."+block.i+".imgs",block.imgs)},300)}function movedItemInCollection(block){$timeout(function(){var data=block[block.type].map(function(item){return item._id});saveField("blocks."+block.i+"."+block.type,data)},300)}function deleteCollection(block,idx){var type=block.type;"scheduleplace"==block.type&&(type="stuffs"),Confirm("Удалить?").then(function(){block[type].splice(idx,1);var data=block[type].map(function(item){return item._id});self.saveField("blocks."+block.i+"."+type,data)})}function setCollection(block,idx){var field=block.type;"scheduleplace"==field&&(field="stuffs"),block[field]||(block[field]=[]);var Items,collections=block[field];void 0===idx&&(idx=block[field].length),"brands"==field?Items=Brands:"categories"==field?Items=Category:"filterTags"==field?Items=FilterTags:"filters"==field?Items=Filters:"brandTags"==field?Items=BrandTags:"stuffs"==field?Items=Stuff:"news"==field?Items=News:"campaign"==field?Items=Campaign:"info"==field&&(Items=Info),$q.when().then(function(){return Items.select({actived:!0})}).then(function(item){collections[idx]=item;var data=block[field].map(function(item){return item._id});console.log(field),self.saveField("blocks."+block.i+"."+field,data)}).catch(function(){console.log("dismiss")})}var self=this;self.item.blocks&&self.item.blocks.forEach&&self.item.blocks.forEach(function(b){b.desc||(b.desc=""),b.descL||(b.descL={}),b.desc1||(b.desc1=""),b.desc1L||(b.desc1L={}),b.name||(b.name=""),b.nameL||(b.nameL={}),b.name1||(b.name1=""),b.name1L||(b.name1L={}),b.videoLink||(b.videoLink="")}),self.item.date&&(self.item.date=new Date(self.item.date)),self.item.blocks||(self.item.blocks=[]),"HomePage"==self.type?(self.Items=HomePage,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=HomePage",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=HomePage"):"Stuff"==self.type?(self.Items=Stuff,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Stuff",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Stuff"):"Master"==self.type?(self.Items=Master,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Master",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Master"):"News"==self.type?(self.Items=News,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=News",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=News"):"Stat"==self.type?(self.Items=Stat,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Stat",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Stat"):"Additional"==self.type?(self.Items=Additional,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Additional",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Additional"):"Category"==self.type?(self.Items=Category,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=Category",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=Category"):"BrandTags"==self.type&&(self.Items=BrandTags,self.uploadUrl="/api/collections/Photo/fileUpload?collectionName=BrandTags",self.uploadVideoUrl="/api/collections/Photo/uploadVideoFile?collectionName=BrandTags"),self.global=global,self.listOfBlocks=listOfBlocksForAll,self.animationTypes=animationTypes,self.animationTypesForSlider=["sliceDown","sliceDownLeft","sliceUp","sliceUpLeft","sliceUpDown","sliceUpDownLeft","fold","fade","random","slideInRight","slideInLeft","boxRandom","boxRain","boxRainReverse","boxRainGrow","boxRainGrowReverse"],self.blockEditPermission={},self.blockSettingPermission={},self.blockEditTextPermission={},self.blockEditText1Permission={},self.blockEditMediaPermission={},self.blockEditMedia1Permission={},self.tinymceOptions={plugins:"code print preview fullpage searchreplace autolink directionality  visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists textcolor wordcount  imagetools  contextmenu colorpicker textpattern help",toolbar:"code | formatselect | bold italic strikethrough forecolor backcolor | link | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat | code "},self.filterBlocks=filterBlocks,self.getBlockType=getBlockType,self.getNameBlock=getNameBlock,self.saveField=saveField,self.loadPhoto=loadPhoto,self.setStyles=setStyles,self.getBlockConfig=getBlockConfig,self.deleteBlock=deleteBlock,self.cloneBlock=cloneBlock,$scope.$on("addNewBlock",function(e,data){data&&data.type&&addNewBlock(data.type)}),self.deleteSlide=deleteSlide,self.editSlide=editSlide,self.deleteImg=deleteImg,self.deleteCollection=deleteCollection,self.setCollection=setCollection,self.changeSlidePhoto=changeSlidePhoto,self.movedItemInSlider=movedItemInSlider,self.movedItemInCollection=movedItemInCollection}function blocks($http,$uibModal,HomePage,$q,global,Photo){function getBlockConfig(block,itemUrl,model){return $q.when().then(function(){return $http.get("/api/getBlocksForAll/"+block.type)}).then(function(res){if(res.data)return selectItemFromList(res.data)
}).then(function(b){if(b){if(b.allData){if(block.img)Photo.deleteFiles(model,[block.img]);else if(block.video)Photo.deleteFiles(model,[block.video]);else if(block.imgs&&"stuffs"!=block.type){var a=[];block.imgs.forEach(function(i){a.push(i.img)}),a.length&&Photo.deleteFiles(model,a)}for(var key in block)"_id"!=key&&"index"!=key&&"i"!=key&&"position"!=key&&delete block[key];var photos=[];for(var key in b)if("_id"!=key&&"template"!=key&&"nameTemplate"!=key&&"index"!=key&&"i"!=key)if("img"==key&&b[key]){var p=b[key].split("/");p[p.length-2]=itemUrl,p[p.length-3]=model,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),block[key]=p.join("/"),photos.push([b[key],block[key]])}else if("imgs"==key&&b[key]&&b[key].length)b[key].forEach(function(i){if(i.img){var p=i.img.split("/");p[p.length-2]=itemUrl,p[p.length-3]=model,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),photos.push([i.img,p.join("/")]),i.img=p.join("/")}}),block[key]=b[key];else if("video"==key&&b[key]){var p=b[key].split("/");p[p.length-2]=itemUrl,p[p.length-3]=model,p[p.length-4]=global.get("store").val.subDomain;var img=p[p.length-1].split(".");img[img.length-2]+="copy",p[p.length-1]=img.join("."),block[key]=p.join("/"),photos.push([b[key],block[key]])}else"link"!=key&&(block[key]=b[key],"button"==key&&(block.button.link=null));var folder="/images/"+global.get("store").val.subDomain+"/"+model+"/"+itemUrl,o={folder:folder,photos:photos};return $http.post(photoUpload+"/api/copyPhotosFromBrowser",o)}block.templ=b.templ,block.style=b.style,block.blockStyle=b.blockStyle,block.elements=b.elements,block.mobile=b.mobile,block.tablet=b.tablet,block.animate=b.animate,block.animateRepeat=b.animateRepeat,block.duration=b.duration}})}function selectItemFromList(items,header){return $uibModal.open({animation:!0,templateUrl:"components/blocks/selectItem.html",controllerAs:"$ctrl",controller:function($uibModalInstance,global,items,header){function selectItem(item){$uibModalInstance.close(item)}function cancel(){$uibModalInstance.dismiss()}var self=this;self.items=items,self.header=header||"выберите из предложенного списка",self.selectItem=selectItem,self.cancel=cancel},resolve:{items:function(){return items},header:function(){return header}}}).result}return{getBlockConfig:getBlockConfig}}angular.module("gmall.directives").directive("blocksEdit",blocksEdit).directive("blockTextEdit",blockTextEdit).directive("blockText1Edit",blockText1Edit).directive("blockMediaEdit",blockMediaEdit).directive("blockMedia1Edit",blockMedia1Edit).directive("directive",function($compile,$interpolate){return{template:"",link:function($scope,element,attributes){var s=attributes.directive?attributes.directive.toLowerCase():"undefined";"categories"==s||"campaign"==s||"info"==s||"news"==s||"brands"==s||"brandtags"==s||"filtertags"==s||"filters"==s||"stuffs"==s||"scheduleplace"==s?element.append($compile("<div items-block></div>")($scope)):element.append($compile("<div block-media1-edit></div>")($scope))}}}).directive("itemsBlock",itemsBlock).directive("nameBlock",nameBlock).directive("textBlock",textBlock).directive("text2Block",text2Block).directive("bannerBlock",bannerBlock).directive("banner1Block",banner1Block).directive("bannerOneBlock",banner1Block).directive("sliderBlock",sliderBlock).directive("videoBlock",videoBlock).directive("video1Block",video1Block).directive("video2Block",video2Block).directive("mapBlock",mapBlock).directive("map1Block",map1Block).directive("map2Block",map2Block).directive("mastersBlock",mastersBlock).directive("feedbackBlock",feedbackBlock).directive("feedback1Block",feedback1Block).directive("feedback2Block",feedback2Block).directive("stuffsBlock",itemsBlock).directive("filtertagsBlock",itemsBlock).directive("brandtagsBlock",itemsBlock).directive("brandsBlock",itemsBlock).directive("categoriesBlock",itemsBlock).directive("campaignBlock",itemsBlock).directive("newsBlock",itemsBlock).directive("infoBlock",itemsBlock).directive("dateBlock",dateBlock).directive("positionBlock",positionBlock).directive("videolinkBlock",videoLinkBlock).directive("snBlock",snBlock).directive("calendarBlock",calendarBlock).directive("scheduleBlock",scheduleBlock).directive("callBlock",callBlock).directive("buttonBlock",buttonBlock).directive("undefinedBlock",undefinedBlock).directive("reviewBlock",reviewBlock).directive("subscriptionBlock",subscriptionBlock).directive("subscriptionaddBlock",subscriptionAddBlock).directive("videolinkBlock",videolinkBlock).directive("pricegoodsBlock",pricegoodsBlock).directive("priceservicesBlock",priceservicesBlock).directive("scheduleplaceBlock",scheduleplaceBlock),blocksEditCtrl.$inject=["$http","$uibModal","HomePage","$q","global","Photo","$fileUpload","SetCSS","Blocks","Confirm","EditModelData","Filters","Brands","Category","FilterTags","BrandTags","Stuff","News","Campaign","Info","exception","$timeout","Master","Stat","Additional","$scope","$rootScope"],angular.module("gmall.services").service("Blocks",blocks),blocks.$inject=["$http","$uibModal","HomePage","$q","global","Photo"]}(),function(){function styleBlockPage(){return{templateUrl:"components/setStyles/styleBlockPage.html"}}function setStylesHeader(){return{restrict:"AE",templateUrl:"components/setStyles/setStylesHeader.html"}}function setStylesForBlock(){return{binding:{item:"=",saveFunction:"&",saveField:"@",fontFaces:"=",deleteFunction:"&",element:"@",action:"@"},scope:{item:"=",saveFunction:"&",saveField:"@",fontFaces:"=",deleteFunction:"&",element:"@",action:"@"},restrict:"AE",bindToController:!0,controller:setStylesForBlockCtrl,controllerAs:"$ctrl",templateUrl:"components/setStyles/setStyles.html"}}function setStylesForBlockCtrl(){function activate(){if("index.link"==self.saveField&&(console.log(JSON.stringify(self.item)),console.log(self.item[0])),self.item)for(;self.item.length<lengthStyleBlock;)self.item.push("");else self.item=angular.copy(arrEmptyForProperties);if(self.action){self.action.split(" ").forEach(function(k){self.actions[k]=!0})}}function saveData(){self.saveFunction({field:self.saveField,value:self.item})}function deleteData(){console.log("???????"),self.deleteFunction({element:self.element})}var self=this,actived=!1;self.$oninit=function(){actived||(actived=!0,activate())},self.actions={},self.displayList=["block","inline","inline-block","none","table","inline-table","table-cell","table-column","table-row","table-caption","none !important"],self.saveData=saveData,self.deleteData=deleteData,actived||(actived=!0,activate())}function styleService($uibModal,$q,global){function setStyles(block,short){var options={animation:!0,bindToController:!0,size:"lg",controllerAs:"$ctrl",windowClass:"app-modal-window",templateUrl:"components/setStyles/setCSS.html",controller:function(Confirm,$uibModalInstance,block,fontFaces,short){function addNewElement(type){type?(self.block[type]||(self.block[type]={}),self.block[type].elements||(self.block[type].elements={}),self.block[type].elements[self.element]=angular.copy(arrEmptyForProperties)):(self.block.elements||(self.block.elements={}),self.block.elements[self.element]=angular.copy(arrEmptyForProperties)),self.element=null}function deleteElement(element,type){Confirm("delete?").then(function(){type?delete self.block[type].elements[element]:delete self.block.elements[element]})}function filterListElements(el){return!self.block.elements||Object.keys(self.block.elements).indexOf(el)<0}function filterListElementsMobile(el){return!self.block.mobile.elements||Object.keys(self.block.mobile.elements).indexOf(el)<0}function filterListElementsTablet(el){return!self.block.tablet.elements||Object.keys(self.block.tablet.elements).indexOf(el)<0}function done(){$uibModalInstance.close()}function cancel(){$uibModalInstance.dismiss()}function addSelector(type){if(self.selector){type?(self.block[type]||(self.block[type]={}),self.block[type].elements||(self.block[type].elements={})):self.block.elements||(self.block.elements={});var selector=self.selector.trim().substring("0,25").replace(/([^a-z0-9_&]+)/gi,"-");if("&"==selector[0])var field=selector;else var field="@"+selector;type?self.block[type].elements[field]=angular.copy(arrEmptyForProperties):self.block.elements[field]=angular.copy(arrEmptyForProperties),self.selector=""}}function copyStyle(from,to){Confirm("выполнить?").then(function(){var els,blSt;"desktop"==from?(els=angular.copy(block.elements),blSt=angular.copy(block.blockStyle)):"tablet"==from?(els=angular.copy(block.tablet.elements),blSt=angular.copy(block.tablet.blockStyle)):"mobile"==from&&(els=angular.copy(block.mobile.elements),blSt=angular.copy(block.mobile.blockStyle)),els&&("desktop"==to?block.elements=els:"tablet"==to?block.tablet.elements=els:"mobile"==to&&(block.mobile.elements=els)),blSt&&("desktop"==to?block.blockStyle=blSt:"tablet"==to?block.tablet.blockStyle=blSt:"mobile"==to&&(block.mobile.blockStyle=blSt))})}var self=this;short?(self.block={blockStyle:block},self.selector="",self.short=!0):(self.block=block,self.selector="",block.blockStyle||(block.blockStyle=angular.copy(arrEmptyForProperties)),block.mobile||(block.mobile={blockStyle:angular.copy(arrEmptyForProperties)}),block.tablet||(block.tablet={blockStyle:angular.copy(arrEmptyForProperties)})),self.listElements=elementsList,self.fontFaces=fontFaces,self.displayList=["block","inline","inline-block","inline-table","none"],self.positionList=["relative","absolute","fixed","inherit","static"],self.filterListElements=filterListElements,self.filterListElementsMobile=filterListElementsMobile,self.filterListElementsTablet=filterListElementsTablet,self.addNewElement=addNewElement,self.deleteElement=deleteElement,self.done=done,self.cancel=cancel,self.addSelector=addSelector,self.copyStyle=copyStyle,self.$onInit=function(){}},resolve:{block:function(){return block},short:function(){return short},fontFaces:function(){return global.get("store").val.template.index.fontFaces}}};return $uibModal.open(options).result}return{setStyles:setStyles}}angular.module("gmall.directives").directive("styleBlockPage",styleBlockPage).directive("setStyles",setStylesForBlock).directive("setStylesHeader",setStylesHeader),setStylesForBlockCtrl.$inject=[],angular.module("gmall.services").service("SetCSS",styleService),styleService.$inject=["$uibModal","$q","global"]}(),angular.module("gmall.directives").directive("callFromStore",[function(){return{scope:{modalClose:"&",stuff:"@"},restrict:"E",bindToController:!0,controllerAs:"$ctrl",controller:"callCtrl",templateUrl:"components/call/call.html"}}]).directive("enterPhoneNumder",[function(){return{scope:{enterPhoneNumder:"=",changeFoo:"&",submitted:"="},restrict:"A",bindToController:!0,controllerAs:"$ctrl",controller:enterPhoneNumderCtrl,templateUrl:"components/call/phoneNumber.html"}}]),enterPhoneNumderCtrl.$inject=["$scope","global"],function(){function helpComponent(){return{scope:{},restrict:"E",bindToController:!0,controller:helpComponentCtrl,controllerAs:"$ctrl",templateUrl:"components/help/help.component.html"}}function helpComponentCtrl(Store,$state,global,Confirm,exception,$q,Stuff,Sections){var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.query={},self.paginate={page:0,rows:5,totalItems:0},self.helpStoreId,function(page){$q.when().then(function(){return Store.query({query:{subDomain:"help"}}).$promise}).then(function(stores){if(!stores||!stores[1])throw"error";self.helpStoreId=stores[1]._id,Sections.query({store:self.helpStoreId},function(res){res.shift(),self.sections=res})}).catch(function(err){err&&exception.catcher("get help")(err)})}()}function helpCategory(){return{scope:{},restrict:"E",bindToController:!0,controller:helpCategoryCtrl,controllerAs:"$ctrl",templateUrl:"components/help/help.category.html"}}function helpCategoryCtrl($state,global,Confirm,exception,$q,Stuff,$stateParams,Category){var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.query={},function(){$q.when().then(function(){return Stuff.query({store:$stateParams.store,query:{category:$stateParams.category}}).$promise}).then(function(stuffs){self.stuffs=stuffs}).then(function(){return Category.get({store:$stateParams.store,_id:$stateParams.category}).$promise}).then(function(res){self.category=res}).catch(function(err){err&&exception.catcher("get stuffs")(err)})}()}function helpStuff(){return{scope:{},restrict:"E",bindToController:!0,controller:helpStuffCtrl,controllerAs:"$ctrl",templateUrl:"components/help/help.stuff.html"}}function helpStuffCtrl($state,global,Confirm,exception,$q,Stuff,$stateParams){var self=this;self.mobile=global.get("mobile").val,self.global=global,self.$state=$state,self.query={},function(){console.log($stateParams),$q.when().then(function(){return Stuff.get({_id:$stateParams.stuff,store:$stateParams.store}).$promise}).then(function(stuff){self.stuff=stuff?stuff:null}).catch(function(err){err&&exception.catcher("get stuffs")(err)})}()}angular.module("gmall.services").directive("helpComponent",helpComponent).directive("helpCategory",helpCategory).directive("helpStuff",helpStuff),helpComponentCtrl.$inject=["Store","$state","global","Confirm","exception","$q","Stuff","Sections"],helpCategoryCtrl.$inject=["$state","global","Confirm","exception","$q","Stuff","$stateParams","Category"],helpStuffCtrl.$inject=["$state","global","Confirm","exception","$q","Stuff","$stateParams"]}();for(var minTimePart=15,timeRemindArrLang=[{ru:"за 1 час",uk:"",en:"",de:"",part:4},{ru:"за 2 часа",uk:"",en:"",de:"",part:8},{ru:"за 3 часа",uk:"",en:"",de:"",part:12},{ru:"за 4 часа",uk:"",en:"",de:"",part:16},{ru:"за 5 часов",uk:"",en:"",de:"",part:20},{ru:"за 6 часов",uk:"",en:"",de:"",part:24},{ru:"за 12 часов",uk:"",en:"",de:"",part:48},{ru:"за 1 день",uk:"",en:"",de:"",part:96}],timeDurationArrLang=[{ru:"15 мин",uk:"",en:"",de:"",part:1},{ru:"30 мин",uk:"",en:"",de:"",part:2},{ru:"45 мин",uk:"",en:"",de:"",part:3},{ru:"1 час",uk:"",en:"",de:"",part:4},{ru:"1 час 15 мин",uk:"",en:"",de:"",part:5},{ru:"1 час 30 мин",uk:"",en:"",de:"",part:6},{ru:"1 час 45 мин",uk:"",en:"",de:"",part:7},{ru:"2 часа",uk:"",en:"",de:"",part:8},{ru:"2 часа 15 мин",uk:"",en:"",de:"",part:9},{ru:"2 часа 30 мин",uk:"",en:"",de:"",part:10},{ru:"3 часа",uk:"",en:"",de:"",part:12},{ru:"3 часа 30 мин",uk:"",en:"",de:"",part:14},{ru:"4 часа",uk:"",en:"",de:"",part:16}],weekDays=[{ru:"Воскресенье",uk:"Неділя",en:"Sunday",de:"gdsdfsdf"},{ru:"Понедельник",uk:"Понеділок",en:"Monday",de:"gdsdfsdf"},{ru:"Вторник",uk:"Вівторок",en:"Tuesday",de:"gdsdfsdf"},{ru:"Среда",uk:"Середа",en:"Wednesday",de:"gdsdfsdf"},{ru:"Четверг",uk:"Четвер",en:"Thursday",de:"gdsdfsdf"},{ru:"Пятница",uk:"П*ятниця",en:"Friday",de:"gdsdfsdf"},{ru:"Суббота",uk:"Субота",en:"Saturday",de:"gdsdfsdf"}],reservedFirstParamsForAdmin=["manage","promo","seo","setting","content","translate","admin123","bookkeep"],reservedFirstParams=["manage","promo","seo","setting","content","translate","news","lookbook","stat","master","campaign","info","additional","workplace","cabinet","pricegoods","priceservices","home","search","cart","cabinet","bookkeep","likes"],languagesOfPlatform=["ru","uk","en","de","es"],propertiesOfConfigData=[{key:"unitOfMeasure",name:"единицы измерения"}],phoneCodes=[{code:"+38",country:"Ukraine"},{code:"+7",country:"Russia"},{code:"+501",country:"Moldova"},{code:"+44",country:"United Kingdom"},{code:"+93",country:"Afghanistan"},{code:"+355",country:"Albania"},{code:"+213",country:"Algeria"},{code:"+1-684",country:"American Samoa"},{code:"+376",country:"Andorra"},{code:"+244",country:"Angola"},{code:"+1-264",country:"Anguilla"},{code:"+672",country:"Antarctica"},{code:"+1-268",country:"Antigua and Barbuda"},{code:"+54",country:"Argentina"},{code:"+374",country:"Armenia"},{code:"+297",country:"Aruba"},{code:"+61",country:"Australia"},{code:"+43",country:"Austria"},{code:"+994",country:"Azerbaijan"},{code:"+1-242",country:"Bahamas"},{code:"+973",country:"Bahrain"},{code:"+880",country:"Bangladesh"},{code:"+1-246",country:"Barbados"},{code:"+375",country:"Belarus"},{code:"+32",country:"Belgium"},{code:"+1-246",country:"Belize"},{code:"+229",country:"Benin"},{code:"+1-441",country:"Bermuda"},{code:"+975",country:"Bhutan"},{code:"+591",country:"Bolivia"},{code:"+246",country:"British Indian Ocean Territory"},{code:"+267",country:"Botswana"},{code:"+55",country:"Brazil"},{code:"+387",country:"Bosnia and Herzegovina"},{code:"+1-284",country:"British Virgin Islands"},{code:"+673",country:"Brunei"},{code:"+359",country:"Bulgaria"},{code:"+226",country:"Burkina Faso"},{code:"+257",country:"Burundi"},{code:"+855",country:"Cambodia"},{code:"+237",country:"Cameroon"},{code:"+1",country:"Canada"},{code:"+238",country:"Cape Verde"},{code:"+1-345",country:"Cayman Islands"},{code:"+236",country:"Central African Republic"},{code:"+235",country:"Chad"},{code:"+56",country:"Chile"},{code:"+86",country:"China"},{code:"+57",country:"Colombia"},{code:"+269",country:"Comoros"},{code:"+506",country:"Costa Rica"},{code:"+385",country:"Croatia"},{code:"+53",country:"Cuba"},{code:"+599",country:"Curacao"},{code:"+357",country:"Cyprus"},{code:"+420",country:"Czech Republic"},{code:"+45",country:"Denmark"},{code:"+1-767",country:"Dominica"},{code:"+593",country:"Ecuador"},{code:"+995",country:"Georgia"},{code:"+49",country:"Germany"},{code:"+30",country:"Greece"},{code:"+852",country:"Hong Kong"},{code:"+36",country:"Hungary"},{code:"+354",country:"Iceland"},{code:"+852",country:"Hong Kong"},{code:"+36",country:"Hungary"},{code:"+30",country:"Greece"},{code:"+91",country:"India"},{code:"+62",country:"Indonesia"},{code:"+98",country:"Iran"},{code:"+964",country:"Iraq"},{code:"+353",country:"Ireland"},{code:"+972",country:"Israel"},{code:"+39",country:"Italy"},{code:"+81",country:"Japan"},{code:"+962",country:"Jordan"},{code:"+7",country:"Kazakhstan"},{code:"+383",country:"Kosovo"},{code:"+965",country:"Kuwait"},{code:"+996",country:"Kyrgyzstan"},{code:"+856",country:"Laos"},{code:"+371",country:"Latvia"},{code:"+961",country:"Lebanon"},{code:"+218",country:"Libya"},{code:"+423",country:"Liechtenstein"},{code:"+370",country:"Lithuania"},{code:"+352",country:"Luxembourg"},{code:"+853",country:"Macau"},{code:"+389",country:"Macedonia"},{code:"+261",country:"Madagascar"},{code:"+60",country:"Malaysia"},{code:"+356",country:"Malta"},{code:"+222",country:"Mauritania"},{code:"+230",country:"Mauritius"},{code:"+52",country:"Mexico"},{code:"+373",country:"Moldova"},{code:"+377",country:"Monaco"},{code:"+976",country:"Mongolia"},{code:"+382",country:"Montenegro"},{code:"+212",country:"Morocco"},{code:"+977",country:"Nepal"},{code:"+31",country:"Netherlands"},{code:"+507",country:"Panama"},{code:"+595",country:"Paraguay"},{code:"+382",country:"Montenegro"},{code:"+377",country:"Monaco"},{code:"+51",country:"Peru"},{code:"+63",country:"Philippines"},{code:"+48",country:"Poland"},{code:"+351",country:"Portugal"},{code:"+974",country:"Qatar"},{code:"+40",country:"Romania"},{code:"+378",country:"San Marino"},{code:"+966",country:"Saudi Arabia"},{code:"+381",country:"Serbia"},{code:"+65",country:"Singapore"},{code:"+421",country:"Slovakia"},{code:"+386",country:"Slovenia"},{code:"+27",country:"South Africa"},{code:"+82",country:"South Korea"},{code:"+34",country:"Spain"},{code:"+94",country:"Sri Lanka"},{code:"+46",country:"Sweden"},{code:"+41",country:"Switzerland"},{code:"+886",country:"Taiwan"},{code:"+992",country:"Tajikistan"},{code:"+66",country:"Thailand"},{code:"+216",country:"Tunisia"},{code:"+90",country:"Turkey"},{code:"+993",country:"Turkmenistan"},{code:"+971",country:"United Arab Emirates"},{code:"+44",country:"United Kingdom"},{code:"+1",country:"United States"},{code:"+598",country:"Uruguay"},{code:"+998",country:"Uzbekistan"},{code:"+379",country:"Vatican"},{code:"+58",country:"Venezuela"},{code:"+84",country:"Vietnam"},{code:"+967",country:"Yemen"}],modelsName={stat:{ru:"страницы",uk:"сторінки",en:"pages",de:"pages"},stuff:{ru:"товары и услуги",uk:"товари та послуги",en:"goods and services",de:"goods and services"},news:{ru:"новости",uk:"новини",en:"news",de:"news"},info:{ru:"информация",uk:"інформація",en:"information",de:"information"},workplace:{ru:"локации",uk:"локации",en:"locations",de:"locations"}},lengthStyleBlock=61,arrEmptyForProperties=[],i=0;i<lengthStyleBlock;i++)arrEmptyForProperties.push("");var listOfBlocksForMainPage={slider:"слайдер",video:"видео",videoLink:"внешнее видео",banner:"баннер",bannerOne:"баннер в два потока",mission:"миссия",text:"текстовый блок",textTwo:"текстовый блок 2 потока",campaign:"акции",filterTags:"тематические группы (признаки из хар-тик)",filters:"характеристики",brandTags:"коллекции",brands:"бренды",categories:"категории",stuffs:"товары",news:"новости",info:"информационный раздел",pricegoods:"прайс товаров",priceservices:"прайс услуг",map:"карта",review:"отзывы гугл",subscription:"подписка",subscriptionAdd:"подписка с доп полями",call:"заказ звонка",feedback:"форма обратной связи",calendar:"гугл календарь",scheduleplace:"расписание для рабочего места"},animationTypes=[{type:null,name:"отсутстует"},{type:"animated1",name:"fadeInLeftBig"},{type:"animated2",name:"fadeInLeft"},{type:"animated3",name:"fadeInLeftMiddle"},{type:"animated4",name:"fadeInRight"},{type:"animated5",name:"fadeInRightMiddle"},{type:"animated6",name:"fadeInRightBig"},{type:"animated7",name:"bounce"},{type:"animated8",name:"fadeInDown"},{type:"animated9",name:"fadeOut"},{type:"animated10",name:"bounceIn"},{type:"animated11",name:"при наведении контур1"},{type:"animated12",name:"при наведении контур2"},{type:"animated13",name:"SweepToTop"},{type:"animated14",name:"SweepToBottom"},{type:"animated15",name:"LineCenterBottom"},{type:"animated16",name:"scale-block"},{type:"animated17",name:"SweepToRight"},{type:"animated18",name:"SweepToLeft"},{type:"animated19",name:"underlineLRL"},{type:"animated20",name:"underline RLR"},{type:"animated21",name:"line-through LRL"},{type:"animated22",name:"underline RLR 5px"},{type:"animated23",name:"test"},{type:"animated24",name:"test"},{type:"animated25",name:"test"},{type:"animated26",name:"test"},{type:"animated27",name:"test"},{type:"animated28",name:"test"},{type:"animated29",name:"test"},{type:"animated30",name:"shake"},{type:"animated31",name:"fadeInUpBig"}],listOfListName=["news","master","stat","info","campaign","lookbook","additional","workplace"],listOfStuffDetailKind=["good","service","info","media"],listOfBlocksForAll={banner:"баннер",bannerOne:"баннер в два потока",brands:"бренды",brandTags:"коллекции",button:"кнопка",calendar:"гугл календарь",call:"заказ звонка",campaign:"акции",categories:"категории",date:"дата",feedback:"форма обратной связи",filterTags:"тематические группы (признаки из хар-тик)",filters:"характеристики",info:"информационный раздел",map:"карта",name:"название",news:"новости",position:"должность",pricegoods:"прайс товаров",priceservices:"прайс услуг",review:"отзывы гугл",schedule:"расписание для специалиста",scheduleplace:"расписание для рабочего места",slider:"слайдер",sn:"кнопки социальных сетей",stuffs:"товары",subscription:"подписка",subscriptionAdd:"подписка с доп полями",text:"текстовый блок",textTwo:"текстовый блок 2 потока",video:"видео",videoLink:"внешнее видео",fbpage:"страница фейсбука",comment:"комментарии дискус"},listOfBlocksForStaticPage={name:"название",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",videoLink:"внешнее видео",video:"видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",masters:"сотрудники",feedback:"обратная связь",feedback1:"обратная связь + фото",feedback2:"фото + обратная связь",stuffs:"товары",filterTags:"группы(признаки из хар-тик)",brandTags:"коллекции",brands:"бренды",categories:"категории",campaign:"акции",call:"заказ звонка",button:"кнопка"},listOfBlocksForNewsDetailPage={name:"название",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",videoLink:"внешнее видео",video:"видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",campaign:"акции",filterTags:"группы(признаки из хар-тик)",brandTags:"коллекции",brands:"бренды",categories:"категории",date:"дата",sn:"социальные сети"},listOfBlocksForMasterPage={name:"имя",position:"должность",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",schedule:"расписание"},listOfBlocksForWorkplacePage={name:"имя",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",stuffs:"товары",schedule:"расписание"},listOfBlocksForAddPage={name:"имя",text:"текстовый блок",text2:"текстовый блок в две колонки",banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",slider:"слайдер",video:"видео",videoLink:"внешнее видео",video1:"видео + текстовый блок",video2:"текстовый блок + видео",map:"карта",map1:"карта + текстовый блок",map2:"текстовый блок + карта",news:"новости"},listOfBlocksForHeader={logo:"логотип",name:"название",cart:"корзина",enter:"вход",info:"инфо",currency:"валюта",news:"новости",lookbook:"галлерея",search:"поиск",catalog:"каталог",new:"новинки",additional:"дополнительный список",schedule:"расписание",sale:"распродажа",campaign:"акции",master:"мастера",brands:"бренды",collection:"коллекции",phone:"телефон",sn:"социальные сети",lang:"языки",humburger:"humburger",pricegoods:"pricegoods",priceservices:"priceservices",text:"текст",icon:"иконка",likes:"избранное"},listBlocksForFooter={text:"текст",textOne:"текст 1",sn:"соц.сети",subscription:"подписка",feedback:"обратная связь",stat:"статические страницы",catalog:"каталог",infoline:"ииформационная строка",copyright:"правообладание",news:"новости",campaign:"акции",lang:"языки"},listOfBlocksForStats={name:"название",banner:"баннер",gallery:"галлерея",desc:"описание1",desc1:"описание2",desc2:"описание3",map:"карта",video:"видео",masters:"мастера"},listOfBlocksForStuffDetail={name:"название",gallery:"галлерея",desc:"описание",comments:"комментарии",lastViewed:"последние просмотренные",sort:"разновидности",group:"группа товаров",addInfo:"доп.информация",addToCart:"в корзину(действие)",price:"цены",qty:"количество",sn:"соц.сети",feedback:"обратная связь",params:"параметры",tags:"характеристики",blocks:"медиа блоки",back:"кнопка назад в список"},listOfBlocksForStuffDetailBlocks={banner:"фото + текстовый блок (один поток)",banner1:"фото + текстовый блок (два потока)",calendar:"календарь",date:"дата",feedback:"обратная связь",feedbackOne:"текст + обратная связь",feedbackTwo:"обратная связь + текст",imgs:"фото",map:"карта",mapOne:"карта + текстовый блок",mapTwo:"текстовый блок + карта",masters:"блок мастеров",name:"имя",position:"должность",slider:"слайдер",sn:"соцсети",text:"текстовый блок",text2:"текстовый блок в две колонки",video:"видео",videoOne:"видео + текстовый блок",videoTwo:"текстовый блок + видео",videoLink:"внешнее видео",file:"file"},listOfBlocksForStuffList={list:"список",filters:"фильтры",categories:"категории",paginate:"пагинация",search:"поиск",call:"звонок",subscription:"подписка",desc:"описание",seoDesc:"seo описание",blocks:"медиа блоки"},tableOfColorsForButton={0:"black-white",1:"pink-white",2:"turquoise-white",3:"yellow-white",4:"bordo-white",5:"braun-white",6:"powder-white",7:"pinklight-white",8:"white-black",9:"black-white"},tableOfButtonsFile={0:"standart",1:"border-radius",2:"no border",3:"inverse",4:"border",5:"transparent"},listOfIcons=["addcart","back","cart","cartin","cartplus","cancelmenu","cancel","cancelzoom","call","caret","categories","change","dialog","down","dot","delete","downslide","gif","envelope","envelopewhite","edit","eur","fb","fbwhite","filters","header","google","googlewhite","humbmobile","chat","inst","instwhite","left","likes","menu","messageme","messagehe","next","nextgallery","ok","okwhite","pin","pinwhite","plus","prev","prevgallery","right","rub","search","send","setting","spinner","subscription","time","tw","twwhite","uah","up","upslide","user","userhe","userme","usd","vk","vkwhite","see","enter","zoom","yt","ytwhite"],notificationsTypeLang={invoice:{ru:"счет",ua:"рахунок",en:"invoice",de:""},accepted:{ru:"заказ принят",ua:"замовлення прийнято",en:"accepted",de:""},shipOrder:{ru:"данные о доставке",ua:"дані про доставку",en:"shipOrder",de:""},order:{ru:"поступил заказ",ua:"поступило замовлення",en:"order",de:""},pay:{ru:"оплата",ua:"оплата",en:"pay",de:""},feedBack:{ru:"обратная связь",ua:"зворотній зв*язок",en:"feedback",de:""},comment:{ru:"комментарий",ua:"коментар",en:"comments",de:""},call:{ru:"заказ звонка",ua:"замовлення дзвінка",en:"call",de:""},subscription:{ru:"подписка",ua:"підписка",en:"subscription",de:""}},updateExternalCatalogList={everyMon10:{ru:"каждый понедельник в 10.00",ua:"",en:"",de:""},everyMon12:{ru:"каждый понедельник в 12.00",ua:"",en:"",de:""},everyFri10:{ru:"каждую пятницу в 10.00",ua:"",en:"",de:""},everyFri12:{ru:"каждую пятницу в 12.00",ua:"",en:"",de:""},everyDay10:{ru:"каждый день в 10.00",ua:"",en:"",de:""},everyDay12:{ru:"каждый день в 12.00",ua:"",en:"",de:""},everyDay101418:{ru:"каждый день в 10.00,14.00,18.00",ua:"",en:"",de:""}},ratioClassStuffDetail={0:{left:"left-block col-lg-6 col-md-6 col-sm-12 col-xs-12",right:"right-block col-lg-6 col-md-6 col-sm-12 col-xs-12"},1:{left:"left-block vertical-left3 col-lg-5 col-md-5 col-sm-12 col-xs-12",right:"right-block horizontal-right2 col-lg-7 col-md-7 col-sm-12 col-xs-12"},2:{left:"left-block vertical-left2 col-lg-4 col-md-4 col-sm-12 col-xs-12",right:"right-block horizontal-right1 col-lg-8 col-md-8 col-sm-12 col-xs-12"},3:{left:"left-block horizontal-left1 col-lg-7 col-md-7 col-sm-12 col-xs-12",right:"right-block vertical-right1  col-lg-5 col-md-5 col-sm-12 col-xs-12"},4:{left:"left-block horizontal-left2 col-lg-8 col-md-8 col-sm-12 col-xs-12",right:"right-block vertical-right2 col-lg-4 col-md-4 col-sm-12 col-xs-12"},5:{left:"left-block col-lg-12 col-md-12 col-sm-12 col-xs-12",right:"right-block col-lg-12 col-md-12 col-sm-12 col-xs-12"}},elementsList=["a","p","div","h1","h2","h3","h4","ol","ul","li","span","img","hr","iframe","table","tr","th","td"],getNamePropertyCSS=function(i,item,k){if(item)switch(i){case 0:return["color",item];case 1:return["background-color",item];case 2:return["margin-top",item];case 3:return["margin-right",item];case 4:return["margin-bottom",item];case 5:return["margin-left",item];case 6:return["padding-top",item];case 7:return["padding-right",item];case 8:return["padding-bottom",item];case 9:return["padding-left",item];case 10:return["display",item];case 11:return["font-family",item];case 12:return["font-size",item];case 13:return["font-weight",item];case 14:return["letter-spacing",item];case 15:return["text-transform",item];case 16:return["width",item];case 17:return["height",item];case 18:return["float",item];case 19:return["top",item];case 20:return["left",item];case 21:return["right",item];case 22:return["bottom",item];case 23:return["text-decoration",item];case 24:return["text-align",item];case 25:
return["position",item];case 26:return["border",item];case 27:return["border-left",item];case 28:return["border-right",item];case 29:return["border-top",item];case 30:return["border-bottom",item];case 31:return["border-radius",item];case 32:return["z-index",item];case 33:return["opacity",item];case 34:return["border-width",item];case 35:return["list-style",item];case 36:return["vertical-align",item];case 37:return["background-size",item];case 38:return["background-position",item];case 39:return["text-shadow",item];case 40:return["cursor",item];case 41:return["transition",item];case 42:return["box-shadow",item];case 43:return["transform",item];case 44:return["background",item];case 45:return["clear",item];case 46:return["max-width",item];case 47:return["min-width",item];case 48:return["max-height",item];case 49:return["min-height",item];case 50:return["line-height",item];case 51:return["object-fit",item];case 52:return["object-position",item];case 53:return["overflow",item];case 54:return["background-attachment",item];case 55:return["background-repeat",item];case 56:return["padding",item];case 57:return["margin",item];case 58:return["word-break",item];case 59:return["word-wrap",item];case 60:return["word-spacing",item]}else switch(i){case 0:return"color";case 1:return"background-color";case 2:return"margin-top";case 3:return"margin-right";case 4:return"margin-bottom";case 5:return"margin-left";case 6:return"padding-top";case 7:return"padding-right";case 8:return"padding-bottom";case 9:return"padding-left";case 10:return"display";case 11:return"font-family";case 12:return"font-size";case 13:return"font-weight";case 14:return"letter-spacing";case 15:return"text-transform";case 16:return"width";case 17:return"height";case 18:return"float";case 19:return"top";case 20:return"left";case 21:return"right";case 22:return"bottom";case 23:return"text-decoration";case 24:return"text-align";case 25:return"position";case 26:return"border";case 27:return"border-left";case 28:return"border-right";case 29:return"border-top";case 30:return"border-bottom";case 31:return"border-radius";case 32:return"z-index";case 33:return"opacity";case 34:return"border-width";case 35:return"list-style";case 36:return"vertical-align";case 37:return"background-size";case 38:return"background-position";case 39:return"text-shadow";case 40:return"cursor";case 41:return"transition";case 42:return"box-shadow";case 43:return"transform";case 44:return"background";case 45:return"clear";case 46:return"max-width";case 47:return"min-width";case 48:return"max-height";case 49:return"min-height";case 50:return"line-height";case 51:return"object-fit";case 52:return"object-position";case 53:return"overflow";case 54:return"background-attachment";case 55:return"background-repeat";case 56:return"padding";case 57:return"margin";case 58:return"word-break";case 59:return"word-wrap";case 60:return"word-spacing"}};"undefined"==typeof window&&(exports.listOfBlocksForMainPage=listOfBlocksForMainPage,exports.listOfBlocksForHeader=listOfBlocksForHeader,exports.listBlocksForFooter=listBlocksForFooter,exports.listOfBlocksForStats=listOfBlocksForStats,exports.listOfBlocksForStuffDetail=listOfBlocksForStuffDetail,exports.listOfBlocksForStuffList=listOfBlocksForStuffList,exports.lengthStyleBlock=lengthStyleBlock,exports.arrEmptyForProperties=arrEmptyForProperties,exports.listOfBlocksForNewsDetailPage=listOfBlocksForNewsDetailPage,exports.listOfBlocksForStaticPage=listOfBlocksForStaticPage,exports.modelsName=modelsName,exports.getNamePropertyCSS=getNamePropertyCSS,exports.listOfListName=listOfListName,exports.ratioClassStuffDetail=ratioClassStuffDetail,exports.elementsList=elementsList,exports.reservedFirstParams=reservedFirstParams,exports.reservedFirstParamsForAdmin=reservedFirstParamsForAdmin,exports.minTimePart=minTimePart,exports.listOfBlocksForStuffDetailBlocks=listOfBlocksForStuffDetailBlocks);