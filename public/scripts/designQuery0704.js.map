{"version":3,"sources":["babel/designQuery0704.js"],"names":["designQuery","brands","brandTags","filters","sections","queryCategory","filterTags","reduce","a","item","concat","tags","params","query","group","category","brand","brandTag","queryTag","q","b","getOFA","_id","bt","i","length","split","map","url","filter","t","forEach","push","_prepareQueryForRequest","queryStart","arr_id","key","qu","key2","obj","objT","$or","$and","$in","JSON","stringify"],"mappings":"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","file":"designQuery0704.js","sourcesContent":["'use strict';\r\n(function(){\r\n    class designQuery {\r\n        constructor(brands,brandTags,filters,sections,queryCategory){\r\n            this.brands=brands;\r\n            this.brandTags=brandTags;\r\n            this.filterTags=filters.reduce(function (a,item) {return a.concat(item.tags);},[]);\r\n            this.sections=sections;\r\n            this.queryCategory=queryCategory;\r\n        }\r\n        getQueryString(params,query,queryCategory){\r\n            this.queryCategory=queryCategory;\r\n            let {group,category}=params;\r\n            let {brand,brandTag,queryTag}=query;\r\n            /*console.log(params,query)\r\n            console.log(group,category,brand,brandTag,queryTag);*/\r\n            let q={},b=this.brands.getOFA('url',brand);\r\n            if(brand && b){\r\n                q.brand=b._id\r\n            }\r\n            if(brandTag){\r\n                let bt;\r\n                if(b){\r\n                    let bt=b.tags.getOFA('url',brandTag);\r\n                    if(bt){q.brandTag=bt._id}\r\n                }else{\r\n                    for(let i=0;i<this.brands.length;i++){\r\n                        bt=this.brands[i].tags.getOFA('url',brandTag)\r\n                        if(bt){q.brandTag=bt._id;break}\r\n                    }\r\n                }\r\n            }\r\n            // анализ url на наличие тегов*************\r\n            if(queryTag){\r\n                q.tags={}\r\n                let filterTags=this.filterTags;\r\n                queryTag.split('+').map(function(url){\r\n                    //console.log(url)\r\n                    return filterTags.getOFA('url',url)\r\n                }).filter(function (t) {\r\n                    return t;\r\n                }).forEach(function (t) {\r\n                    //console.log(t)\r\n                    if(!q.tags[t.filter]){q.tags[t.filter]=[]}\r\n                    //console.log(q.tags)\r\n                    q.tags[t.filter].push(t._id);\r\n                })\r\n            }\r\n\r\n\r\n            //console.log(q,this.queryCategory)\r\n            if(this.queryCategory && this.queryCategory.category){\r\n                q.category=this.queryCategory.category;\r\n            }\r\n            //console.log(_prepareQueryForRequest(q))\r\n            return _prepareQueryForRequest(q);\r\n        }\r\n    }\r\n\r\n    function _prepareQueryForRequest(queryStart){\r\n        //console.log(queryStart)\r\n        // формирование строки запроса для выбора  товаров из БД\r\n        var query=[];\r\n        var arr_id;\r\n        for (var key in queryStart){\r\n            if (queryStart[key]){\r\n                //console.log(queryStart[key],key);\r\n                if (key==\"tags\"){\r\n                    var qu=[];\r\n                    for (var key2 in queryStart[key]){\r\n                        var obj=queryStart[key][key2];\r\n                        var q=[];\r\n                        if (obj && obj.length){\r\n                            obj.forEach(function(objT){\r\n                                q.push({tags:objT});\r\n                            })\r\n\r\n                            if (q.length>1){\r\n                                q={$or:q}\r\n                                qu.push(q)\r\n                            } else {\r\n                                q=q[0];\r\n                                qu.push(q)\r\n                            }\r\n                        }\r\n                    }\r\n                    if (qu.length){\r\n                        if(qu.length==1){\r\n                            query.push(qu[0]);\r\n                        } else {\r\n                            query.push({$and:qu});\r\n                        }\r\n                    }\r\n                }else if(key==\"brandTag\"){\r\n                    //console.log(key,queryStart[key])\r\n                    // это если запрос на список со страницы акции.\r\n                    // в акции могут быть товары из нестольких коллекций\r\n                    if(queryStart[key].length){\r\n                        var obj={};\r\n                        obj[key]={$in:queryStart[key]};\r\n                        query.push(obj);\r\n                        //console.log(key,obj)\r\n                    }/*else {\r\n\r\n                     var obj={};\r\n                     obj[key]=queryStart[key];\r\n                     query.push(obj);\r\n\r\n                     }*/\r\n                    //console.log(obj[key])\r\n                }else if(key==\"_id\"){\r\n                    // это если запрос на список со страницы акции.\r\n                    // в акции могут быть просто товары\r\n                    if(queryStart[key].length){\r\n                        arr_id={};\r\n                        arr_id[key]={$in:queryStart[key]};\r\n                    }\r\n                } else {\r\n                    var obj={};\r\n                    obj[key]=queryStart[key];\r\n                    query.push(obj);\r\n                }\r\n            }\r\n        }\r\n        if (query.length==1){\r\n            if(arr_id){\r\n                query =  JSON.stringify({$or:[query[0],arr_id]});\r\n            }else{\r\n                query=JSON.stringify(query[0]);\r\n            }\r\n\r\n        } else if(query.length>1){\r\n            if(arr_id){\r\n                query =  JSON.stringify({$or:[{$and:query},arr_id]});\r\n            }else{\r\n                query =JSON.stringify({$and:query});\r\n            }\r\n\r\n        } else {\r\n            if(arr_id){\r\n                query =  JSON.stringify(arr_id);\r\n            }else{\r\n                query={};\r\n            }\r\n\r\n        }\r\n        return query;\r\n    }\r\n\r\n\r\n\r\n    /*if(typeof window === 'undefined') {\r\n        exports.init=designQuery;\r\n    }*/\r\n})()\r\n\r\n"]}