{"version":3,"sources":["babel/designQuery.js"],"names":["designQuery","brands","brandTags","filters","sectionClass","categories","filterTags","reduce","a","item","concat","tags","sections","getSections","getCategories","stateParams","queryParams","k","groupUrl","group","categoryUrl","category","parentSection","sectionCategories","categoryBrands","categoryFilters","query","breadcrumbs","getSection","categoriesO","_id","sectionCategoriesFull","getEmbededCategories","map","el","length","$in","forEach","c","f","indexOf","push","b","brandSet","brandTagSet","brandsArr","brandTagsArr","brand","split","brandTag","url","t","queryTags","queryTag","filter","pos","filterTag","$gte","Number","$lte","count","minValue","maxValue","min","max","_setQueryForTags","actived","searchStr","search","substring","$or","name","artikul","params","queryCategory","q","getOFA","bt","i","_prepareQueryForRequest","queryStart","arr_id","key","qu","key2","obj","objT","$and","JSON","stringify","keys","Object","price","console","log","o","window","DesignQuery","exports","init"],"mappings":"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","file":"designQuery.js","sourcesContent":["'use strict';\r\n(function(){\r\n    class designQuery {\r\n        constructor(brands,brandTags,filters,sectionClass,categories){\r\n            this.brands=brands;\r\n            this.brandTags=brandTags;\r\n            this.filters=filters;\r\n            this.filterTags=filters.reduce(function (a,item) {return a.concat(item.tags);},[]);\r\n            this.sections=sectionClass.getSections();\r\n            this.categories=sectionClass.getCategories();\r\n            this.sectionClass=sectionClass;\r\n        }\r\n\r\n\r\n\r\n        getQuery(stateParams,queryParams) {\r\n            /*console.log('getQuery')\r\n            console.log(stateParams,queryParams)*/\r\n\r\n\r\n            if(queryParams){\r\n                for(let k in queryParams){\r\n                    stateParams[k]=queryParams[k]\r\n                }\r\n            }\r\n\r\n\r\n            stateParams.groupUrl=stateParams.group;\r\n            stateParams.categoryUrl=stateParams.category;\r\n            //console.log(stateParams)\r\n            var parentSection,sectionCategories,categoryBrands=[],categoryFilters=[],query={},breadcrumbs=[];\r\n            var sections=this.sections,brands=this.brands,filters=this.filters;let categories=this.categories\r\n            parentSection=this.sectionClass.getSection(stateParams.groupUrl);\r\n            //console.log(parentSection)\r\n            //return;\r\n            if(parentSection){\r\n                if(stateParams.categoryUrl!='category'){\r\n                    let category=parentSection.categoriesO[stateParams.categoryUrl];\r\n                    if(category){\r\n                        query.category=category._id;\r\n                        categoryBrands=category.brands;\r\n                        categoryFilters=category.filters\r\n                    }else{\r\n                        throw 404\r\n                    }\r\n                }else{\r\n                    let sectionCategoriesFull=this.sectionClass.getEmbededCategories(parentSection,[])\r\n                    sectionCategories=sectionCategoriesFull.map(function(el){return el._id})\r\n                    //console.log(sectionCategories)\r\n                    if(!sectionCategories.length){\r\n                        query.category=null;\r\n                    }else{\r\n                        query.category={$in:sectionCategories}\r\n                        sectionCategoriesFull.forEach(function (c) {\r\n                            c.filters.forEach(function(f){\r\n                                if(categoryFilters.indexOf(f)<0){\r\n                                    categoryFilters.push(f)\r\n                                }\r\n                            })\r\n                            c.brands.forEach(function(b){\r\n                                if(categoryBrands.indexOf(b)<0){\r\n                                    categoryBrands.push(b)\r\n                                }\r\n                            })\r\n                        })\r\n                    }\r\n                }\r\n            }else{\r\n                //console.log('???????????')\r\n                throw 404\r\n            }\r\n            //console.log(categoryFilters,categoryBrands)\r\n            // бренд и коллекци\r\n            // ************************************************************************\r\n            var brandSet,brandTagSet,brandsArr,brandTagsArr;\r\n            //console.log(categoryBrands)\r\n\r\n            if(stateParams.brand){\r\n                brandsArr=stateParams.brand.split('__');\r\n                stateParams.brand=stateParams.brand.split('__');\r\n            }\r\n            if(stateParams.brandTag){\r\n                brandTagsArr=stateParams.brandTag.split('__');\r\n                stateParams.brandTag=stateParams.brandTag.split('__');\r\n            }\r\n            //console.log(stateParams)\r\n            query.brand=[];\r\n            query.brandTag=[];\r\n            brands.forEach(function (b){\r\n                if(brandsArr && brandsArr.indexOf(b.url)>-1){\r\n                    query.brand.push(b._id)\r\n                }\r\n                b.tags.forEach(function (t) {\r\n                    if(brandTagsArr && brandTagsArr.indexOf(t.url)>-1){\r\n                        query.brandTag.push(t._id)\r\n                    }\r\n                })\r\n\r\n            })\r\n            if(query.brand.length){\r\n                if(query.brand.length==1){\r\n                    query.brand=query.brand[0]\r\n                }else{\r\n                    query.brand={$in:query.brand}\r\n                }\r\n            }else{\r\n                query.brand=null;\r\n            }\r\n            if(query.brandTag.length){\r\n                if(query.brandTag.length==1){\r\n                    query.brandTag=query.brandTag[0]\r\n                }else{\r\n                    query.brandTag={$in:query.brandTag}\r\n                }\r\n            }else{\r\n                query.brandTag=null;\r\n            }\r\n            if(!query.brandTag){\r\n                delete query.brandTag\r\n            }\r\n            if(!query.brand){\r\n                delete query.brand\r\n            }\r\n            //console.log(query)\r\n            // end brand && collections\r\n            var queryTags;\r\n            if(stateParams.queryTag){\r\n                // анализ url на наличие тегов*************\r\n                queryTags=stateParams.queryTag.split('__');\r\n                // удаляем возможные дубли\r\n                queryTags= queryTags.filter(function(item, pos) {\r\n                    return queryTags.indexOf(item) == pos;\r\n                })\r\n            }\r\n            query.filters={} // для количественных признаков\r\n            var filterTags;\r\n            if(stateParams.filterTag){\r\n                // анализ url на наличие тегов*************\r\n                filterTags=stateParams.filterTag.split('__');\r\n                // удаляем возможные дубли\r\n                filterTags= filterTags.filter(function(item, pos) {\r\n                    return filterTags.indexOf(item) == pos;\r\n                })\r\n                filterTags = filterTags.map(function(f){\r\n                    return f.split('_')\r\n                }).filter(function(f){return f.length==3}).forEach(function(f){\r\n                    query.filters[f[0]]={$gte:Number(f[1]),$lte:Number(f[2])}\r\n                })\r\n            }\r\n\r\n\r\n            query.queryTags={}\r\n            filters.forEach(function (f) {\r\n                if(f.count){\r\n                    if(query.filters[f._id]){\r\n                        f.minValue =query.filters[f._id].$gte\r\n                        f.maxValue=query.filters[f._id].$lte\r\n                    }else{\r\n                        f.minValue =f.min\r\n                        f.maxValue=f.max\r\n                    }\r\n                }else{\r\n                    f.tags.forEach(function (t) {\r\n                        if(queryTags && queryTags.indexOf(t.url)>-1){\r\n                            if(!query.queryTags[t.filter]){query.queryTags[t.filter]=[]}\r\n                            query.queryTags[t.filter].push(t._id)\r\n                        }\r\n                    })\r\n                }\r\n            })\r\n            _setQueryForTags(query,filters)\r\n\r\n            // для клиенского запроса только опубликованные товары\r\n            query.actived=true;\r\n            //console.log('query',query)\r\n            //console.log(stateParams)\r\n            if(stateParams.searchStr){\r\n                var search=stateParams.searchStr.substring(0,20);\r\n                query.$or=[{name:search},{artikul:search}]\r\n            }\r\n            return query;\r\n\r\n        }\r\n        getQueryString(params,query,queryCategory){\r\n            this.queryCategory=queryCategory;\r\n            let {group,category}=params;\r\n            let {brand,brandTag,queryTag}=query;\r\n            /*console.log(params,query)\r\n            console.log(group,category,brand,brandTag,queryTag);*/\r\n            let q={},b=this.brands.getOFA('url',brand);\r\n            if(brand && b){\r\n                q.brand=b._id\r\n            }\r\n            if(brandTag){\r\n                let bt;\r\n                if(b){\r\n                    let bt=b.tags.getOFA('url',brandTag);\r\n                    if(bt){q.brandTag=bt._id}\r\n                }else{\r\n                    for(let i=0;i<this.brands.length;i++){\r\n                        bt=this.brands[i].tags.getOFA('url',brandTag)\r\n                        if(bt){q.brandTag=bt._id;break}\r\n                    }\r\n                }\r\n            }\r\n            // анализ url на наличие тегов*************\r\n            if(queryTag){\r\n                q.tags={}\r\n                let filterTags=this.filterTags;\r\n                queryTag.split('+').map(function(url){\r\n                    //console.log(url)\r\n                    return filterTags.getOFA('url',url)\r\n                }).filter(function (t) {\r\n                    return t;\r\n                }).forEach(function (t) {\r\n                    //console.log(t)\r\n                    if(!q.tags[t.filter]){q.tags[t.filter]=[]}\r\n                    //console.log(q.tags)\r\n                    q.tags[t.filter].push(t._id);\r\n                })\r\n            }\r\n\r\n\r\n            //console.log(q,this.queryCategory)\r\n            if(this.queryCategory && this.queryCategory.category){\r\n                q.category=this.queryCategory.category;\r\n            }\r\n            //console.log(_prepareQueryForRequest(q))\r\n            return _prepareQueryForRequest(q);\r\n        }\r\n\r\n    }\r\n\r\n    function _prepareQueryForRequest(queryStart){\r\n        //console.log(queryStart)\r\n        // формирование строки запроса для выбора  товаров из БД\r\n        var query=[];\r\n        var arr_id;\r\n        for (var key in queryStart){\r\n            if (queryStart[key]){\r\n                //console.log(queryStart[key],key);\r\n                if (key==\"tags\"){\r\n                    var qu=[];\r\n                    for (var key2 in queryStart[key]){\r\n                        var obj=queryStart[key][key2];\r\n                        var q=[];\r\n                        if (obj && obj.length){\r\n                            obj.forEach(function(objT){\r\n                                q.push({tags:objT});\r\n                            })\r\n\r\n                            if (q.length>1){\r\n                                q={$or:q}\r\n                                qu.push(q)\r\n                            } else {\r\n                                q=q[0];\r\n                                qu.push(q)\r\n                            }\r\n                        }\r\n                    }\r\n                    if (qu.length){\r\n                        if(qu.length==1){\r\n                            query.push(qu[0]);\r\n                        } else {\r\n                            query.push({$and:qu});\r\n                        }\r\n                    }\r\n                }else if(key==\"brandTag\"){\r\n                    //console.log(key,queryStart[key])\r\n                    // это если запрос на список со страницы акции.\r\n                    // в акции могут быть товары из нестольких коллекций\r\n                    if(queryStart[key].length){\r\n                        var obj={};\r\n                        obj[key]={$in:queryStart[key]};\r\n                        query.push(obj);\r\n                        //console.log(key,obj)\r\n                    }/*else {\r\n\r\n                     var obj={};\r\n                     obj[key]=queryStart[key];\r\n                     query.push(obj);\r\n\r\n                     }*/\r\n                    //console.log(obj[key])\r\n                }else if(key==\"_id\"){\r\n                    // это если запрос на список со страницы акции.\r\n                    // в акции могут быть просто товары\r\n                    if(queryStart[key].length){\r\n                        arr_id={};\r\n                        arr_id[key]={$in:queryStart[key]};\r\n                    }\r\n                } else {\r\n                    var obj={};\r\n                    obj[key]=queryStart[key];\r\n                    query.push(obj);\r\n                }\r\n            }\r\n        }\r\n        if (query.length==1){\r\n            if(arr_id){\r\n                query =  JSON.stringify({$or:[query[0],arr_id]});\r\n            }else{\r\n                query=JSON.stringify(query[0]);\r\n            }\r\n\r\n        } else if(query.length>1){\r\n            if(arr_id){\r\n                query =  JSON.stringify({$or:[{$and:query},arr_id]});\r\n            }else{\r\n                query =JSON.stringify({$and:query});\r\n            }\r\n\r\n        } else {\r\n            if(arr_id){\r\n                query =  JSON.stringify(arr_id);\r\n            }else{\r\n                query={};\r\n            }\r\n\r\n        }\r\n        return query;\r\n    }\r\n    function _setQueryForTags(query,filters) {\r\n        //console.log(query.queryTags,query.queryTags && typeof query.queryTags=='object')\r\n        if(query.queryTags && typeof query.queryTags=='object'){\r\n            var keys = Object.keys(query.queryTags);\r\n            if(keys.length==1){\r\n                query.tags={$in:query.queryTags[keys[0]]}\r\n            }else if(keys.length>1){\r\n                query.$and=[];\r\n                keys.forEach(function(k){\r\n                    query.$and.push({tags:{$in:query.queryTags[k]}})\r\n                })\r\n            }\r\n        }\r\n        delete query.queryTags\r\n        var keys = Object.keys(query.filters);\r\n        //console.log(keys,!keys)\r\n        if(keys.length==1){\r\n            var filter;\r\n            if(filters){\r\n                filter = filters.getOFA('_id',keys[0])\r\n            }\r\n            //console.log(filter)\r\n            if(filter && filter.price){\r\n                query['priceForFilter']=query.filters[keys[0]]\r\n                console.log(query.filters[keys[0]])\r\n            }else{\r\n                query['filters.'+keys[0]]=query.filters[keys[0]]\r\n            }\r\n\r\n            //query['filters.'+keys[0]]=query.filters[keys[0]]\r\n        }else if(keys.length>1){\r\n            if(!query.$and){\r\n                query.$and=[];\r\n            }\r\n            keys.forEach(function(k){\r\n                var filter;\r\n                if(filters){\r\n                    filter = filters.getOFA('_id',k)\r\n                }\r\n                //console.log(filter)\r\n                if(filter && filter.price){\r\n                    query['priceForFilter']=query.filters[k]\r\n                }else{\r\n                    var o ={};\r\n                    o['filters.'+k]=query.filters[k]\r\n                    query.$and.push(o)\r\n                }\r\n            })\r\n            if(query.$and.length==1){\r\n                for(var k in query.$and[0]){\r\n                    query[k] = query.$and[0][k];\r\n                }\r\n                delete query.$and\r\n            }\r\n        }\r\n        delete query.filters\r\n    }\r\n\r\n\r\n\r\n    if(typeof window !== 'undefined'){\r\n        window.DesignQuery = designQuery;\r\n    } else {\r\n        exports.init=designQuery;\r\n       // module.exports = myShareData;\r\n    }\r\n})()\r\n\r\n"]}